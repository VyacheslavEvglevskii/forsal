<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<link rel="manifest" href="manifest.json">
<link rel="icon" href="icon-192.png" type="image/png">
<meta name="theme-color" content="#34d399">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="PackControl">
<link rel="apple-touch-icon" href="icon-512.png">
  <title>üì¶ –£—á—ë—Ç —É–ø–∞–∫–æ–≤–∫–∏</title>
  <style>
.tooltip {
  position: relative;
  cursor: help;
}
@media (min-width: 768px) {
  .mobile-nav {
    display: none;
  }
}
.mobile-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: #ffffff;
  border-top: 1px solid #ccc;
  display: flex;
  justify-content: space-around;
  padding: 6px 0;
  z-index: 1000;
}
button {
  min-height: 48px;
  min-width: 48px;
  touch-action: manipulation;
}
.mobile-nav button {
  background: none;
  border: none;
  font-size: 22px;
  padding: 8px 0;
  flex: 1;
  cursor: pointer;
  color: #333;
}

.button-loading {
  position: relative;
  pointer-events: none;
  opacity: 0.7;
}

.button-loading::after {
  content: "";
  position: absolute;
  right: 16px;
  top: 50%;
  width: 18px;
  height: 18px;
  margin-top: -9px;
  border: 2px solid #fff;
  border-top-color: transparent;
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}
.mobile-nav button:active {
  background: #f0f0f0;
}

button:active {
  transform: scale(0.97);
  background-color: #1d4ed8 !important; /* –Ω–µ–º–Ω–æ–≥–æ —Ç–µ–º–Ω–µ–µ */
  transition: 0.1s ease;
}

.salary-card {
  background: #f9fafb;
  border: 1px solid #ddd;
  border-radius: 10px;
  padding: 12px;
  margin-bottom: 12px;
  font-size: 15px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}
.salary-card p {
  margin: 6px 0;
}

.tooltip:hover::after {
  content: attr(data-tooltip);
  position: absolute;
  left: 0;
  top: 100%;
  background: #111;
  color: #fff;
  padding: 6px 10px;
  border-radius: 6px;
  white-space: nowrap;
  font-size: 13px;
  margin-top: 6px;
  z-index: 100;
  opacity: 0.95;
}

.rate-item {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 8px 16px;
  padding: 10px 12px;
  margin-bottom: 6px;
  border-radius: 10px;
  background-color: #f3f4f6;
  font-size: 15px;
  line-height: 1.4;
}

.rate-item span {
  display: flex;
  align-items: center;
  gap: 4px;
  white-space: nowrap;
  font-size: 14px;
}

.rate-item strong {
  color: #111827;
  font-weight: 600;
}
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0 12px;
      background: #f7f9fc;
    }
    .container {
      max-width: 500px;
      margin: 20px auto;
      padding: 16px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    h2 {
      text-align: center;
      margin-bottom: 24px;
      font-size: 22px;
    }
    label {
      display: block;
      font-weight: bold;
      margin-top: 16px;
      margin-bottom: 6px;
      font-size: 16px;
    }
    input, select, button {
  width: 100%;
  padding: 16px;           /* –ë—ã–ª–æ 14px ‚Äî —Ç–µ–ø–µ—Ä—å –±–æ–ª—å—à–µ */
  font-size: 18px;
  border-radius: 8px;
  border: 1px solid #ccc;
  box-sizing: border-box;
}
    input[readonly] {
      background-color: #f0f0f0;
      color: #555;
    }
    button {
      background: #2563eb;
      color: white;
      border: none;
      cursor: pointer;
      margin-top: 20px;
      font-size: 18px;
      font-weight: bold;
    }
    button:hover {
      background: #1e40af;
    }
    .danger { background: #ef4444; }
    .tabs {
      display: flex;
      margin-top: 20px;
    }
.container {
  overflow-y: auto;
}
form button[type="submit"] {
  position: relative;
  z-index: 2;
}
    .tab-button {
      flex: 1;
      padding: 12px;
      background: #e5e7eb;
      border: none;
      font-weight: bold;
      cursor: pointer;
      border-radius: 8px 8px 0 0;
    }
    .tab-button.active {
      background: white;
      border-bottom: 2px solid white;
    }
    #result { margin-top: 20px; font-weight: bold; text-align: center; }
    .stat-card {
  border: 1px solid #ccc;
  border-radius: 10px;
  padding: 12px;
  margin-bottom: 12px;
  background: #f9fafb;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  font-size: 15px;
} 
  </style>
<link rel="manifest" href="manifest.json">
<link rel="icon" href="icon-192.png" type="image/png">
<meta name="theme-color" content="#34d399">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="PackControl">
<link rel="apple-touch-icon" href="icon-512.png">
</head>
<body>
<div class="container" id="loginContainer">
  <h2>üîê –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h2>
<input type="text" id="login" required autocomplete="off" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞">
<input type="password" id="password" required autocomplete="off" placeholder="–í–≤–µ–¥–∏—Ç–µ PIN-–∫–æ–¥">
  <button onclick="handleLogin()">–í–æ–π—Ç–∏</button>
  <p id="loginError" style="color:red; text-align:center;"></p>
</div>
<div class="container" style="display:none;" id="tabContainer">
</div>
<div class="container" style="display:none;" id="appContainer">
  <h2 id="mainTitle">üì¶ –£—á—ë—Ç —É–ø–∞–∫–æ–≤–∫–∏</h2>
  <form id="dataForm" style="padding-bottom: 100px;">
  <div class="tooltip" data-tooltip="–ü–æ–ª–µ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –≤—Ö–æ–¥–µ">
    <label>–ò–º—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞:
      <input name="employeeName" required readonly />
    </label>
  </div>

  <div class="tooltip" data-tooltip="–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –µ–¥–∏–Ω–∏—Ü">
    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:
      <input name="quantity" type="number" required />
    </label>
  </div>

  <div class="tooltip" data-tooltip="–£–∫–∞–∂–∏—Ç–µ —Ç–æ—á–Ω–æ–µ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞">
    <label>–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞:
      <input name="startTime" type="time" required />
    </label>
  </div>

  <div class="tooltip" data-tooltip="–£–∫–∞–∂–∏—Ç–µ –≤—Ä–µ–º—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã">
    <label>–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è:
      <input name="endTime" type="time" required />
    </label>
  </div>

  <div class="tooltip" data-tooltip="–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏">
    <label>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
      <input name="duration" readonly />
    </label>
  </div>

  <div class="tooltip" data-tooltip="–í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä—ë–º —É–ø–∞–∫–æ–≤–∫–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä 5–ª, 10–ª –∏ —Ç.–¥." id="volumeLabel">
    <label>–û–±—ä—ë–º:
      <select name="volume" required></select>
    </label>
  </div>

  <div class="tooltip" data-tooltip="–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä –£–ø–∞–∫–æ–≤–∫–∞, –°–±–æ—Ä–∫–∞ –∏ —Ç.–ø.">
    <label>–û–ø–µ—Ä–∞—Ü–∏—è:
      <select name="operationType" required></select>
    </label>
  </div>

  <div class="tooltip" data-tooltip="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ –∏–∑ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è">
    <label>–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞:
      <input name="orderNumber" required />
    </label>
  </div>

  <div class="tooltip" data-tooltip="–ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ —Å–±–æ—Ä–∫–∞ ‚Äî —É–∫–∞–∂–∏—Ç–µ –∞—Ä—Ç–∏–∫—É–ª –Ω–∞–±–æ—Ä–∞" id="setNumberField" style="display:none;">
    <label>–ê—Ä—Ç–∏–∫—É–ª –Ω–∞–±–æ—Ä–∞:
      <select name="setNumber"></select>
    </label>
  </div>

  <div id="rateInfo" style="margin-top:16px; background:#f0f0f0; padding:10px; border-radius:8px; display:none;">
    <p><strong>‚è± –ù–æ—Ä–º–∞ –≤ —á–∞—Å:</strong> <span id="normDisplay">-</span></p>
    <p><strong>üí∞ –¢–∞—Ä–∏—Ñ –∑–∞ 1 —à—Ç:</strong> <span id="rateDisplay">-</span></p>
  </div>

  <div id="calcBlock" style="margin-top:16px; background:#e7f5ff; padding:10px; border-radius:8px; display:none;">
    <p><strong>üí∏ –†–∞—Å—á—ë—Ç –æ–ø–ª–∞—Ç—ã:</strong> <span id="wageDisplay">-</span></p>
    <p><strong>‚öôÔ∏è –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:</strong> <span id="efficiencyDisplay">-</span></p>
  </div>

  <button type="submit">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</form>
<p id="result" style="display:none;"></p>
</div>
<div class="container" style="display:none;" id="statsContainer">
  <h2>üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
  <label>–í—ã–±—Ä–∞—Ç—å –¥–∞—Ç—É:<input type="date" id="statsDate"></label>
  <div style="margin-top: 12px;">
  <label>–§–∏–ª—å—Ç—Ä –ø–æ –æ–ø–µ—Ä–∞—Ü–∏–∏:
    <select id="operationFilter">
      <option value="">-- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ --</option>
    </select>
  </label>
  <button id="showStatsBtn" onclick="loadStats()">üìä –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
</div>
  <div id="statsCards"></div>
<div id="statsLogs" style="margin-top: 16px;"></div>
<p id="totalWage" style="text-align:center; font-weight:bold; margin-top:16px;"></p>
</div>
<div class="container" style="display:none;" id="profileContainer">
  <h2>üë§ –õ–∏—á–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å</h2>


  <label>–¢–∏–ø —Å–º–µ–Ω—ã:
    <select id="shiftType">
      <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å–º–µ–Ω—É --</option>
      <option>–î–µ–Ω—å</option>
      <option>–ù–æ—á—å</option>
    </select>
  </label>

  <label>–°—Ç–∞—Ç—É—Å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞:
    <select id="employeeStatus">
      <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å --</option>
      <option>–®—Ç–∞—Ç</option>
      <option>–ê—É—Ç—Å–æ—Ä—Å–∏–Ω–≥</option>
      <option>–°—Ç–∞–∂—ë—Ä</option>
    </select>
  </label>

  <button onclick="saveProfile()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
<p id="profileSaved" style="color:green; text-align:center; display:none;">‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</p>
<p id="profileHint" style="color:#dc2626; font-size:14px; text-align:center; margin-top:12px;">
  ‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ —Ç–∏–ø —Å–º–µ–Ω—ã –∏ —Å—Ç–∞—Ç—É—Å, –∑–∞—Ç–µ–º –Ω–∞–∂–º–∏—Ç–µ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª, —á—Ç–æ–±—ã —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤–∫–ª–∞–¥–∫—É "–£—á—ë—Ç".
</p>
<button id="logoutBtn" onclick="handleLogout()" class="danger">üö™ –í—ã–π—Ç–∏</button>
</div>
<div class="container" style="display:none;" id="ratesContainer">
  <h2>üí∞ –¢–∞—Ä–∏—Ñ—ã –∏ –Ω–æ—Ä–º–∞—Ç–∏–≤—ã</h2>
  <!-- üéØ –§–ò–õ–¨–¢–†–´ -->
  <div id="ratesFilters" style="display: flex; gap: 10px; margin: 16px 0;">
    <select id="filterOperation" style="flex:1; padding: 10px; font-size: 16px;">
      <option value="">-- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ --</option>
    </select>
    <select id="filterKey" style="flex:1; padding: 10px; font-size: 16px;">
      <option value="">-- –í—Å–µ –æ–±—ä—ë–º—ã / –∞—Ä—Ç–∏–∫—É–ª—ã --</option>
    </select>
</div>
  <!-- üìã –°–ü–ò–°–û–ö –¢–ê–†–ò–§–û–í -->
  <div id="ratesTable"></div>
</div>
  <!-- –¢–∞–±–ª–∏—Ü–∞ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ —á–µ—Ä–µ–∑ JS -->
</div>
<!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä: –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å -->
<div class="container" style="display:none;" id="adminContainer">
  <h2>üõ†Ô∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2>

  <!-- üìÖ –í—ã–±–æ—Ä –¥–∞—Ç—ã –¥–ª—è —Å–≤–æ–¥–∫–∏ -->
  <label>üìÖ –í—ã–±—Ä–∞—Ç—å –¥–∞—Ç—É:
    <input type="date" id="adminDate" />
  </label>
  <button onclick="loadShiftStats()">üìä –ü–æ–∫–∞–∑–∞—Ç—å —Å–≤–æ–¥–∫—É –ø–æ —Å–º–µ–Ω–∞–º</button>
  <button id="exportBtn" onclick="manualExport()">üíæ –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</button>

  <!-- üìÜ –ü–µ—Ä–∏–æ–¥ –¥–ª—è –Ω–µ–¥–µ–ª—å–Ω–æ–≥–æ –æ—Ç—á—ë—Ç–∞ -->
  <div style="margin-top:16px;">
    <label>üìÜ –ü–µ—Ä–∏–æ–¥ —Å:
      <input type="date" id="reportStartDate" />
    </label>
    <label style="margin-left:10px;">–ø–æ:
      <input type="date" id="reportEndDate" />
    </label>
    <button id="reportBtn" onclick="runCustomReport()">üìÜ –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç –∑–∞ –ø–µ—Ä–∏–æ–¥</button>
  </div>

  <!-- üìä –í—ã–≤–æ–¥ —Å–≤–æ–¥–∫–∏ –ø–æ —Å–º–µ–Ω–∞–º -->
  <div id="shiftStatsOutput" style="margin-top:20px;"></div>

  <!-- üîç –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ —É–ø–∞–∫–æ–≤—â–∏–∫–∞–º -->
  <div style="margin-top:24px; border-top:1px solid #ccc; padding-top:16px;">
    <h3>üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ —É–ø–∞–∫–æ–≤—â–∏–∫–∞–º</h3>
    <label>–ü–µ—Ä–∏–æ–¥ —Å:
      <input type="date" id="analyzeStart" />
    </label>
    <label style="margin-left:10px;">–ø–æ:
      <input type="date" id="analyzeEnd" />
    </label>
    <button id="analyzeBtn" onclick="analyzePackers()">üîç –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å</button>

    <div id="packerAnalysis" style="margin-top:16px;"></div>
  </div>
</div>

<!-- üíµ –ú–æ—è –∑–∞—Ä–ø–ª–∞—Ç–∞ ‚Äî –ø–µ—Ä–µ–º–µ—â—ë–Ω –í–ù–ï adminContainer -->
<div class="container" style="display:none;" id="mySalaryContainer">
  <h2>üíµ –ú–æ—è –∑–∞—Ä–ø–ª–∞—Ç–∞</h2>
  <label>üìÖ –ü–µ—Ä–∏–æ–¥ —Å:
    <input type="date" id="salaryStart">
  </label>
  <label style="margin-left:10px;">–ø–æ:
    <input type="date" id="salaryEnd">
  </label>
  <button id="mySalaryBtn" onclick="loadMySalary()">üìä –ü–æ–∫–∞–∑–∞—Ç—å</button>
  <div id="mySalaryOutput" style="margin-top:20px;"></div>
<p id="totalQty" style="text-align:center; font-weight:bold; margin-top:16px;"></p>
</div>
<script>
  const scriptURL = "https://script.google.com/macros/s/AKfycbzMZEDeGvhgx0p7CA-1n2rW6Wtxq-s6seYxFubma7zxdjBfAjAVLSPnPGmB0ovmW9s/exec";
  let todayRecords = [];
  let currentUser = "";
let currentShift = "";
let currentStatus = "";
 let allRates = [];
let currentUserRole = "user"; // ‚Üê –¥–æ–±–∞–≤–ª—è–µ–º —Å—é–¥–∞

function saveProfile() {
  const shiftSelect = document.getElementById("shiftType");
  const statusSelect = document.getElementById("employeeStatus");

  const shiftValue = shiftSelect.value;
  const statusValue = statusSelect.value;

  // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
  currentShift = shiftValue;
  currentStatus = statusValue;

  const isFilled = shiftValue && statusValue;

  const hint = document.getElementById("profileHint");
  const msg = document.getElementById("profileSaved");
  const tabApp = document.getElementById("tabApp");

  // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–¥—Å–∫–∞–∑–æ–∫
  hint.style.display = isFilled ? "none" : "block";
  msg.style.display = isFilled ? "block" : "none";
  tabApp.disabled = !isFilled;
  tabApp.innerHTML = isFilled ? "üìã –£—á—ë—Ç" : "üîí –£—á—ë—Ç";

  // –°–∫—Ä—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
  if (isFilled) {
    setTimeout(() => msg.style.display = "none", 2000);
  }
}

function switchTab(tabName) {
  // üîí –ë–ª–æ–∫–∏—Ä—É–µ–º –¥–æ—Å—Ç—É–ø –∫ –∞–¥–º–∏–Ω–∫–µ, –µ—Å–ª–∏ –Ω–µ –∞–¥–º–∏–Ω
  if (tabName === "admin" && currentUserRole !== "admin") return;

  // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –≤–∫–ª–∞–¥–æ–∫
  const containers = {
    app: document.getElementById("appContainer"),
    stats: document.getElementById("statsContainer"),
    profile: document.getElementById("profileContainer"),
    rates: document.getElementById("ratesContainer"),
    admin: document.getElementById("adminContainer"),
    mySalary: document.getElementById("mySalaryContainer")
  };

  // –ö–Ω–æ–ø–∫–∏ –≤–∫–ª–∞–¥–æ–∫ (–∏ –≤–µ—Ä—Ö–Ω–∏–µ, –∏ –Ω–∏–∂–Ω–∏–µ ‚Äî —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏ id)
  const buttons = {
    tabApp: document.getElementById("tabApp"),
    tabStats: document.getElementById("tabStats"),
    tabProfile: document.getElementById("tabProfile"),
    tabRates: document.getElementById("tabRates"),
    tabAdmin: document.getElementById("tabAdmin"),
    tabMySalary: document.getElementById("tabMySalary")
  };

  // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
  Object.values(containers).forEach(container => {
    if (container) container.style.display = "none";
  });

  // –°–Ω–∏–º–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–ª–∞—Å—Å—ã —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
  Object.values(buttons).forEach(btn => {
    if (btn) btn.classList.remove("active");
  });

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –Ω—É–∂–Ω—É—é –∫–Ω–æ–ø–∫—É
  if (containers[tabName]) {
    containers[tabName].style.display = "block";
  }

  const btnId = "tab" + tabName.charAt(0).toUpperCase() + tabName.slice(1);
  const activeBtn = buttons[btnId];
  if (activeBtn) activeBtn.classList.add("active");

  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ ‚Äî –ø–æ–¥–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ç–∞—Ä–∏—Ñ–æ–≤
  if (tabName === "rates") {
    loadRatesTable();
  }
}

async function handleLogin() {
console.log("üîê handleLogin() –≤—ã–∑–≤–∞–Ω");
  const login = document.getElementById("login").value.trim();
  const password = document.getElementById("password").value.trim();
  const errorElem = document.getElementById("loginError");

  try {
    const res = await fetch(`${scriptURL}?type=auth&login=${encodeURIComponent(login)}&password=${encodeURIComponent(password)}`);
    const data = await res.json();

    if (data.status === "ok") {
      currentUser = login;
      currentUserRole = data.role || 'user';

      localStorage.setItem("currentUser", login);
      localStorage.setItem("currentUserRole", currentUserRole);

      if (currentUserRole === "admin") {
        document.getElementById("tabAdmin").style.display = "block";
      }

      document.getElementById("loginContainer").style.display = "none";
      document.getElementById("tabContainer").style.display = "block";
      document.getElementById("profileContainer").style.display = "block";
      document.querySelector('[name="employeeName"]').value = currentUser;

      document.getElementById("bottomNav").style.display = "flex"; // üëà –¥–æ–±–∞–≤–ª–µ–Ω–æ

      await Promise.all([
        loadVolumes(),
        loadOperations(),
        loadSetNumbers(),
        loadTodayRecords(),
        loadOperationFilter(),
        loadRatesTable()
      ]);

      document.getElementById("operationFilter").addEventListener("change", loadStats);
    } else {
      errorElem.textContent = "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ PIN-–∫–æ–¥";
    }
  } catch {
    errorElem.textContent = "‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è";
  }
}


function handleLogout() {
  // üßπ –°–±—Ä–æ—Å –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
  currentUser = "";
  currentUserRole = "user";
  currentShift = "";
  currentStatus = "";

  // üßΩ –û—á–∏—Å—Ç–∫–∞ localStorage
  localStorage.removeItem("currentUser");
  localStorage.removeItem("currentUserRole");

  // üßª –°–±—Ä–æ—Å —Ñ–æ—Ä–º –≤—Ö–æ–¥–∞
  const loginInput = document.getElementById("login");
  const passwordInput = document.getElementById("password");
  loginInput.value = "";
  passwordInput.value = "";
  loginInput.focus(); // üéØ –ê–≤—Ç–æ—Ñ–æ–∫—É—Å

  // üë§ –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª–µ–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
  document.querySelector('[name="employeeName"]').value = "";
  document.getElementById("shiftType").value = "";
  document.getElementById("employeeStatus").value = "";

  // üßº –°–±—Ä–æ—Å –ø–æ–¥—Å–∫–∞–∑–æ–∫ –ø—Ä–æ—Ñ–∏–ª—è
  document.getElementById("profileSaved").style.display = "none";
  document.getElementById("profileHint").style.display = "block";

  // üö´ –°–±—Ä–æ—Å –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–Ω–æ–ø–∫–∏ "–£—á—ë—Ç"
  const tabApp = document.getElementById("tabApp");
  tabApp.disabled = true;
  tabApp.innerHTML = "üîí –£—á—ë—Ç";

  // üß± –°–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö —Å–µ–∫—Ü–∏–π
  const containers = [
    "loginContainer",
    "tabContainer",
    "appContainer",
    "statsContainer",
    "profileContainer",
    "ratesContainer",
    "adminContainer",
    "mySalaryContainer"
  ];
  containers.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = (id === "loginContainer") ? "block" : "none";
  });

  // üëá –°–∫—Ä—ã—Ç–∏–µ –Ω–∏–∂–Ω–µ–π –ø–∞–Ω–µ–ª–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
  const nav = document.getElementById("bottomNav");
  nav.style.opacity = "0";
  setTimeout(() => {
    nav.style.display = "none";
    nav.style.opacity = "1"; // —Å–±—Ä–æ—Å –Ω–∞ –±—É–¥—É—â–µ–µ
  }, 200); // –ø–ª–∞–≤–Ω–æ—Å—Ç—å –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è
}



  async function loadTodayRecords() {
    const res = await fetch(`${scriptURL}?type=records`);
    const data = await res.json();
    todayRecords = data.records || [];
  }

function loadMySalary() {
  withLoading("mySalaryBtn", async () => {
    const employee = localStorage.getItem("currentUser") || "";
    const start = document.getElementById("salaryStart").value;
    const end = document.getElementById("salaryEnd").value;

    if (!employee || !start || !end) {
      alert("‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è");
      return;
    }

    try {
      const res = await fetch(`${scriptURL}?type=mySalary&employee=${encodeURIComponent(employee)}&start=${start}&end=${end}`);
      const data = await res.json();

      const container = document.getElementById("mySalaryOutput");
      const totalQtyBlock = document.getElementById("totalQty");

      if (!data.records || data.records.length === 0) {
        container.innerHTML = "<p style='text-align:center;'>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥.</p>";
        totalQtyBlock.textContent = "";
        return;
      }

      let totalQty = 0;
      let totalWage = 0;
      let html = "";

      data.records.forEach(r => {
        totalQty += r.quantity || 0;
        totalWage += r.wage || 0;

        html += `
          <div class="salary-card">
            <p><strong>üìÖ –î–∞—Ç–∞:</strong> ${formatDate(r.date)}</p>
            <p><strong>üî¢ –ö–æ–ª-–≤–æ:</strong> ${r.quantity}</p>
            <p><strong>‚öôÔ∏è –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:</strong> ${r.efficiency ?? "-"}%</p>
            <p><strong>üí∞ –ó–∞—Ä–ø–ª–∞—Ç–∞:</strong> ${(r.wage ?? 0).toFixed(2)} ‚ÇΩ</p>
          </div>
        `;
      });

      container.innerHTML = html;
      totalQtyBlock.textContent = `üì¶ –í—Å–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${totalQty} —à—Ç. | üíµ –û–±—â–∞—è —Å—É–º–º–∞: ${totalWage.toFixed(2)} ‚ÇΩ`;
    } catch (err) {
      alert("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: " + err.message);
    }
  });
}

// –î–æ–±–∞–≤—å —ç—Ç—É –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é —Ä—è–¥–æ–º:
function formatDate(isoString) {
  const parts = isoString.split("-");
  return `${parts[2]}.${parts[1]}.${parts[0]}`;
}

  async function loadVolumes() {
    const res = await fetch(`${scriptURL}?type=volumes`);
    const data = await res.json();
    const select = document.querySelector('[name="volume"]');
    select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏ –æ–±—ä—ë–º --</option>';
    data.volumes.forEach(val => {
      const opt = document.createElement('option');
      opt.value = val;
      opt.textContent = val;
      select.appendChild(opt);
    });
  }

  async function loadOperations() {
    const res = await fetch(`${scriptURL}?type=operations`);
    const data = await res.json();
    const select = document.querySelector('[name="operationType"]');
    select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏ –æ–ø–µ—Ä–∞—Ü–∏—é --</option>';
    data.operations.forEach(val => {
      const opt = document.createElement('option');
      opt.value = val;
      opt.textContent = val;
      select.appendChild(opt);
    });
    select.addEventListener("change", () => handleOperationChange(select.value));
  }

  async function loadSetNumbers() {
    const res = await fetch(`${scriptURL}?type=sets`);
    const data = await res.json();
    const select = document.querySelector('[name="setNumber"]');
    select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏ –∞—Ä—Ç–∏–∫—É–ª --</option>';
    data.sets.forEach(val => {
      const opt = document.createElement('option');
      opt.value = val;
      opt.textContent = val;
      select.appendChild(opt);
    });
  }

async function deleteRecord(index) {
  if (!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?")) return;

  const res = await fetch(`${scriptURL}?type=deleteRecord&index=${index}`);
  const data = await res.json();

  alert(data.message || "–£–¥–∞–ª–µ–Ω–æ");
  if (data.status === "success") {
    loadStats();
  }
}

  function handleOperationChange(operation) {
    const volumeLabel = document.getElementById("volumeLabel");
    const volumeField = document.querySelector('[name="volume"]');
    const setField = document.getElementById("setNumberField");
    if (operation === '–°–±–æ—Ä–∫–∞ "–ù–∞–±–æ—Ä–∞"') {
      volumeLabel.style.display = "none";
      volumeField.required = false;
      setField.style.display = "block";
    } else {
      volumeLabel.style.display = "block";
      volumeField.required = true;
      setField.style.display = "none";
      document.querySelector('[name="setNumber"]').value = "";
    }
  }
function updateRateDisplay() {
  const operationType = document.querySelector('[name="operationType"]').value;
  const volume = document.querySelector('[name="volume"]').value;
  const setNumber = document.querySelector('[name="setNumber"]').value;
  const quantity = Number(document.querySelector('[name="quantity"]').value) || 0;

  const startTime = document.querySelector('[name="startTime"]').value;
  const endTime = document.querySelector('[name="endTime"]').value;

  const key = (operationType.includes("–°–±–æ—Ä–∫–∞")) ? setNumber : volume;

  const matched = allRates.find(r => r.operation === operationType && r.key === key);

  const block = document.getElementById("rateInfo");
  const norm = document.getElementById("normDisplay");
  const rate = document.getElementById("rateDisplay");

  const calcBlock = document.getElementById("calcBlock");
  const wageDisplay = document.getElementById("wageDisplay");
  const efficiencyDisplay = document.getElementById("efficiencyDisplay");

  if (matched) {
    norm.textContent = matched.normPerHour;
    rate.textContent = matched.ratePerUnit.toFixed(2) + " ‚ÇΩ";

    const totalPay = quantity * matched.ratePerUnit;

    let durationMin = 0;
    if (startTime && endTime) {
      const [sh, sm] = startTime.split(":").map(Number);
      const [eh, em] = endTime.split(":").map(Number);
      durationMin = (eh * 60 + em) - (sh * 60 + sm);
      if (durationMin < 0) durationMin += 1440;
    }

    let efficiency = "-";
    if (durationMin > 0 && matched.normPerHour > 0) {
      const expected = (matched.normPerHour / 60) * durationMin;
      efficiency = ((quantity / expected) * 100).toFixed(0) + " %";
    }

    wageDisplay.textContent = totalPay.toFixed(2) + " ‚ÇΩ";
    efficiencyDisplay.textContent = efficiency;

    block.style.display = "block";
    calcBlock.style.display = "block";
  } else {
    norm.textContent = "-";
    rate.textContent = "-";
    block.style.display = "none";
    calcBlock.style.display = "none";
  }
}
document.querySelector('[name="operationType"]').addEventListener("change", updateRateDisplay);
document.querySelector('[name="volume"]').addEventListener("change", updateRateDisplay);
document.querySelector('[name="setNumber"]').addEventListener("change", updateRateDisplay);
document.querySelector('[name="quantity"]').addEventListener("input", updateRateDisplay);
document.querySelector('[name="startTime"]').addEventListener("change", updateRateDisplay);
document.querySelector('[name="endTime"]').addEventListener("change", updateRateDisplay);

  document.getElementById("dataForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);
    const result = document.getElementById("result");
    await loadTodayRecords();

    const start = formData.get("startTime");
    const end = formData.get("endTime");
    if (start && end) {
      const [sh, sm] = start.split(":" ).map(Number);
      const [eh, em] = end.split(":" ).map(Number);
      let minutes = (eh * 60 + em) - (sh * 60 + sm);
      if (minutes < 0) minutes += 1440;
      const duration = `${Math.floor(minutes / 60)} —á ${minutes % 60} –º–∏–Ω`;
      formData.set("duration", duration);
      document.querySelector('[name="duration"]').value = duration;
}
formData.append("shiftType", currentShift);
formData.append("employeeStatus", currentStatus);
   

    const payload = {
  employeeName: formData.get("employeeName")?.trim(),
  quantity: formData.get("quantity")?.trim(),
  startTime: formData.get("startTime")?.trim(),
  endTime: formData.get("endTime")?.trim(),
  volume: formData.get("volume")?.trim(),
  operationType: formData.get("operationType")?.trim(),
  orderNumber: formData.get("orderNumber")?.trim(),
  setNumber: formData.get("setNumber")?.trim(),
  shiftType: currentShift,
  employeeStatus: currentStatus
};

    const isDuplicate = todayRecords.some(rec => {
  const isSame =
    rec.employeeName === payload.employeeName &&
    rec.quantity === payload.quantity &&
    rec.startTime === payload.startTime &&
    rec.endTime === payload.endTime &&
    rec.operationType === payload.operationType &&
    rec.orderNumber === payload.orderNumber &&
    rec.setNumber === payload.setNumber;

  if (!isSame) return false;

  // –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π –∫—Ä–æ–º–µ "–°–±–æ—Ä–∫–∞ –ù–∞–±–æ—Ä–∞" —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º –æ–±—ä—ë–º
  if (payload.operationType !== '–°–±–æ—Ä–∫–∞ "–ù–∞–±–æ—Ä–∞"') {
    return rec.volume === payload.volume;
  }

  return true;
});

    if (isDuplicate) {
  result.textContent = "‚ö†Ô∏è –¢–∞–∫–∞—è –∑–∞–ø–∏—Å—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (–ª–æ–∫–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)";
  result.style.display = "block";

  // —Å–±—Ä–æ—Å–∏—Ç—å —Ñ–æ—Ä–º—É
  form.reset();
  document.querySelector('[name="employeeName"]').value = currentUser;
  handleOperationChange("");
  updateRateDisplay();
  return;
}

    try {
      const response = await fetch(scriptURL, {
        method: "POST",
        body: formData
      });
      const resultData = await response.json();
      result.textContent = resultData.message;
      result.style.display = "block";

      if (resultData.status === "success") {
  form.reset();
  document.querySelector('[name="employeeName"]').value = currentUser;
  handleOperationChange("");
  updateRateDisplay();
  await loadTodayRecords();
}
    } catch (error) {
      result.textContent = "‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: " + error.message;
      result.style.display = "block";
    }
  });

async function loadRatesTable() {
  const res = await fetch(`${scriptURL}?type=rates`);
  const data = await res.json();
  allRates = data.rates || [];

  const opFilter = document.getElementById("filterOperation");
  const keyFilter = document.getElementById("filterKey");
  const container = document.getElementById("ratesTable");

  // –û—á–∏—Å—Ç–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
  opFilter.innerHTML = '<option value="">-- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ --</option>';
  keyFilter.innerHTML = '<option value="">-- –í—Å–µ –æ–±—ä—ë–º—ã / –∞—Ä—Ç–∏–∫—É–ª—ã --</option>';

  const operations = [...new Set(allRates.map(r => r.operation))];
  const keys = [...new Set(allRates.map(r => r.key))];

  operations.forEach(op => {
    const opt = document.createElement("option");
    opt.value = op;
    opt.textContent = op;
    opFilter.appendChild(opt);
  });

  keys.forEach(k => {
    const opt = document.createElement("option");
    opt.value = k;
    opt.textContent = k;
    keyFilter.appendChild(opt);
  });

  function renderFilteredRates() {
    const selectedOp = opFilter.value;
    const selectedKey = keyFilter.value;

    const filtered = allRates.filter(r =>
      (!selectedOp || r.operation === selectedOp) &&
      (!selectedKey || r.key === selectedKey)
    );

    const grouped = {};
    filtered.forEach(r => {
      if (!grouped[r.operation]) grouped[r.operation] = [];
      grouped[r.operation].push(r);
    });

    container.innerHTML = "";

    if (!Object.keys(grouped).length) {
      container.innerHTML = "<p style='text-align:center;'>–ù–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π</p>";
      return;
    }

    Object.entries(grouped).forEach(([operation, entries]) => {
      const block = document.createElement("div");
      block.style.marginBottom = "20px";
      block.style.padding = "12px";
      block.style.border = "1px solid #ddd";
      block.style.borderRadius = "10px";
      block.style.backgroundColor = "#f9fafb";

      const title = document.createElement("h4");
      title.textContent = operation;
      title.style.color = "#1e40af";

      const list = document.createElement("ul");
      list.style.listStyle = "none";
      list.style.paddingLeft = "0";

      entries.forEach(e => {
        const item = document.createElement("li");
        item.className = "rate-item";
        item.innerHTML = `
          <span>üì¶ <strong>–û–±—ä—ë–º:</strong> ${e.key}</span>
          <span>‚è± <strong>–ù–æ—Ä–º–∞:</strong> ${e.normPerHour} —à—Ç/—á–∞—Å</span>
          <span>üí∞ <strong>–¢–∞—Ä–∏—Ñ:</strong> ${e.ratePerUnit.toFixed(2)} ‚ÇΩ/—à—Ç</span>
        `;
        list.appendChild(item);
      });

      block.appendChild(title);
      block.appendChild(list);
      container.appendChild(block);
    });
  }

  opFilter.onchange = renderFilteredRates;
  keyFilter.onchange = renderFilteredRates;

  renderFilteredRates(); // –Ω–∞—á–∞–ª—å–Ω–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞
}

async function loadOperationFilter() {
  const res = await fetch(`${scriptURL}?type=operations`);
  const data = await res.json();
  const filter = document.getElementById("operationFilter");

  filter.innerHTML = '<option value="">-- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ --</option>';
  data.operations.forEach(op => {
    const option = document.createElement("option");
    option.value = op;
    option.textContent = op;
    filter.appendChild(option);
  });
}

function openEditModal(index, record) {
  const form = document.getElementById("editForm");

  form.rowIndex.value = index;
  form.employeeName.value = currentUser;
  form.orderNumber.value = record.orderNumber || "";
  form.shiftType.value = currentShift;
  form.employeeStatus.value = currentStatus;

  form.quantity.value = record.quantity;
  form.startTime.value = record.startTime;
  form.endTime.value = record.endTime;

  document.getElementById("editOperation").value = record.operationType || "";
  document.getElementById("editVolumeSelect").value = record.volume || "";
  document.getElementById("editSetNumberSelect").value = record.setNumber || "";

  // —Ç—Ä–∏–≥–≥–µ—Ä–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª—è –æ–±—ä—ë–º–∞/–Ω–∞–±–æ—Ä–∞
  document.getElementById("editOperation").dispatchEvent(new Event("change"));

  document.getElementById("editModal").style.display = "block";
}

async function loadEditFormDictionaries() {
  // –û–ø–µ—Ä–∞—Ü–∏–∏
  const resOp = await fetch(`${scriptURL}?type=operations`);
  const operations = (await resOp.json()).operations || [];
  const opSelect = document.getElementById("editOperation");
  opSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏ –æ–ø–µ—Ä–∞—Ü–∏—é --</option>';
  operations.forEach(op => {
    const opt = document.createElement("option");
    opt.value = op;
    opt.textContent = op;
    opSelect.appendChild(opt);
  });

  // –û–±—ä—ë–º—ã
  const resVol = await fetch(`${scriptURL}?type=volumes`);
  const volumes = (await resVol.json()).volumes || [];
  const volSelect = document.getElementById("editVolumeSelect");
  volSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏ –æ–±—ä—ë–º --</option>';
  volumes.forEach(v => {
    const opt = document.createElement("option");
    opt.value = v;
    opt.textContent = v;
    volSelect.appendChild(opt);
  });

  // –ê—Ä—Ç–∏–∫—É–ª—ã –Ω–∞–±–æ—Ä–æ–≤
  const resSet = await fetch(`${scriptURL}?type=sets`);
  const sets = (await resSet.json()).sets || [];
  const setSelect = document.getElementById("editSetNumberSelect");
  setSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏ –∞—Ä—Ç–∏–∫—É–ª --</option>';
  sets.forEach(s => {
    const opt = document.createElement("option");
    opt.value = s;
    opt.textContent = s;
    setSelect.appendChild(opt);
  });

  // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –æ–±—ä—ë–º–∞/–Ω–∞–±–æ—Ä–∞
  opSelect.addEventListener("change", () => {
    const isSet = opSelect.value.includes("–°–±–æ—Ä–∫–∞");
    document.getElementById("editVolumeLabel").style.display = isSet ? "none" : "block";
    volSelect.required = !isSet;
    document.getElementById("editSetNumberField").style.display = isSet ? "block" : "none";
  });
}

async function submitEditForm() {
  const form = document.getElementById("editForm");
  const formData = new FormData(form);
  const params = new URLSearchParams();

  formData.forEach((value, key) => {
    params.append(key, value);
  });

  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  params.set("type", "editRecord");

  // üëá –ü–µ—Ä–µ—Å—á—ë—Ç –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–≤–∞–∂–Ω–æ!)
  const start = formData.get("startTime");
  const end = formData.get("endTime");
  if (start && end) {
    const [sh, sm] = start.split(":").map(Number);
    const [eh, em] = end.split(":").map(Number);
    let minutes = (eh * 60 + em) - (sh * 60 + sm);
    if (minutes < 0) minutes += 1440;
    const duration = `${Math.floor(minutes / 60)} —á ${minutes % 60} –º–∏–Ω`;
    params.set("duration", duration);
  }

  try {
    const res = await fetch(scriptURL, {
      method: "POST",
      body: params,
    });

    const data = await res.json();
    if (data.status === "success") {
      alert(data.message || "–û–±–Ω–æ–≤–ª–µ–Ω–æ");
      closeEditModal();
      await loadStats();
    } else {
      alert(data.message || "–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è");
    }
  } catch (err) {
    console.error("‚ùå –û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:", err);
    alert("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: " + err.message);
  }
}

function closeEditModal() {
  document.getElementById("editModal").style.display = "none";
}

async function loadStats() {
  withLoading("showStatsBtn", async () => {
    const selectedOperation = document.getElementById("operationFilter").value;
    const date = document.getElementById("statsDate").value;
    if (!currentUser) {
      alert("‚ùó–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω.");
      return;
    }

    const res = await fetch(`${scriptURL}?type=stats&date=${encodeURIComponent(date)}&employee=${encodeURIComponent(currentUser)}`);
    const data = await res.json();

    const container = document.getElementById("statsCards");
    const totalElem = document.getElementById("totalWage");
    const logElem = document.getElementById("statsLogs");

    container.innerHTML = "";
    totalElem.textContent = "";
    logElem.innerHTML = "";

    if (!data.records || !data.records.length) {
      container.innerHTML = '<p style="text-align:center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É</p>';
      return;
    }

    let totalWage = 0;
    let totalEfficiency = 0;
    let efficiencyCount = 0;

    const filtered = selectedOperation
      ? data.records.filter(r => r.operationType === selectedOperation)
      : data.records;

    filtered.forEach(rec => {
      const wage = rec.wage || 0;
      totalWage += wage;

      if (rec.efficiency !== null) {
        totalEfficiency += rec.efficiency;
        efficiencyCount++;
      }

      const card = document.createElement("div");
      card.className = "stat-card";
      card.innerHTML = `
        <p><strong>üïí –í—Ä–µ–º—è:</strong> ${rec.startTime} ‚Äì ${rec.endTime}</p>
        <p><strong>üîß –û–ø–µ—Ä–∞—Ü–∏—è:</strong> ${rec.operationType}</p>
        <p><strong>üì¶ –û–±—ä—ë–º:</strong> ${rec.volume || "-"}</p>
        <p><strong>üß© –ù–∞–±–æ—Ä:</strong> ${rec.setNumber || "-"}</p>
        <p><strong>üî¢ –ö–æ–ª-–≤–æ:</strong> ${rec.quantity}</p>
        <p><strong>‚öôÔ∏è –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:</strong> ${rec.efficiency ?? "-"}%</p>
        <p><strong>‚è± –ù–æ—Ä–º–∞ –≤ —á–∞—Å:</strong> ${rec.normPerHour ?? "-"}</p>
        <p><strong>üí∞ –¢–∞—Ä–∏—Ñ –∑–∞ —à—Ç:</strong> ${rec.ratePerUnit?.toFixed(2) ?? "-"} ‚ÇΩ</p>
        <p><strong>üí∏ –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ:</strong> ${wage.toFixed(2)} ‚ÇΩ</p>
      `;

      const today = new Date().toISOString().split("T")[0];
      const selectedDate = document.getElementById("statsDate").value;
      if (rec.rowIndex !== undefined && selectedDate === today) {
        const editBtn = document.createElement("button");
        editBtn.textContent = "‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å";
        editBtn.onclick = () => openEditModal(rec.rowIndex, rec);
        card.appendChild(editBtn);

        const delBtn = document.createElement("button");
        delBtn.textContent = "üóë –£–¥–∞–ª–∏—Ç—å";
        delBtn.className = "danger";
        delBtn.style.marginLeft = "10px";
        delBtn.onclick = () => deleteRecord(rec.rowIndex);
        card.appendChild(delBtn);
      }

      container.appendChild(card);
    });

    const avgEff = efficiencyCount ? Math.round(totalEfficiency / efficiencyCount) : "-";
    totalElem.textContent = `üíµ –í—Å–µ–≥–æ: ${totalWage.toFixed(2)} ‚ÇΩ | ‚öôÔ∏è –°—Ä–µ–¥–Ω—è—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${avgEff}%`;

    if (selectedOperation) {
      totalElem.textContent += ` | –§–∏–ª—å—Ç—Ä: ${selectedOperation}`;
    }

    if (data.logs && data.logs.length) {
      logElem.innerHTML = `
        <h4>üîç –õ–æ–≥–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏:</h4>
        <pre style="font-size:13px; background:#f3f4f6; padding:10px; border-radius:8px; overflow-x:auto;">${data.logs.join('\n')}</pre>
      `;
    }
  }); // üëà –ó–∞–∫—Ä—ã—Ç–∏–µ withLoading
} // üëà –ó–∞–∫—Ä—ã—Ç–∏–µ loadStats


window.addEventListener("DOMContentLoaded", async () => {
  await loadEditFormDictionaries();

  const savedUser = localStorage.getItem("currentUser");
  const savedRole = localStorage.getItem("currentUserRole");

  if (savedUser) {
    currentUser = savedUser;
    currentUserRole = savedRole || "user";

    if (currentUserRole === "admin") {
      document.getElementById("tabAdmin").style.display = "block";
    }

    document.getElementById("loginContainer").style.display = "none";
    document.getElementById("tabContainer").style.display = "block";
    document.getElementById("profileContainer").style.display = "block";
    document.querySelector('[name="employeeName"]').value = currentUser;

    document.getElementById("bottomNav").style.display = "flex"; // üëà –ø–æ–∫–∞–∑–∞—Ç—å –Ω–∏–∂–Ω–µ–µ –º–µ–Ω—é

    await Promise.all([
      loadVolumes(),
      loadOperations(),
      loadSetNumbers(),
      loadTodayRecords(),
      loadOperationFilter(),
      loadRatesTable()
    ]);

    document.getElementById("operationFilter").addEventListener("change", loadStats);

    // üëâ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Å–º–µ–Ω—ã –∏ —Å—Ç–∞—Ç—É—Å–∞
    ["change", "input"].forEach(event =>
      ["shiftType", "employeeStatus"].forEach(id =>
        document.getElementById(id).addEventListener(event, saveProfile)
      )
    );

    // ‚ö° –í–∞–∂–Ω–æ–µ: –≤—ã–∑—ã–≤–∞–µ–º –≤ —Å–∞–º–æ–º –∫–æ–Ω—Ü–µ, —á—Ç–æ–±—ã –ø–æ–¥—Å–∫–∞–∑–∫–∞ —Ç–æ—á–Ω–æ –ø–æ–∫–∞–∑–∞–ª–∞—Å—å
    setTimeout(saveProfile, 0);
  } else {
    // üëá –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –ª–æ–≥–∏–Ω–∞, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
    document.getElementById("login").focus();
  }
});


async function manualExport() {
  withLoading("exportBtn", async () => {
    const date = document.getElementById("adminDate").value;
    if (!date) {
      alert("‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É");
      return;
    }

    try {
      const res = await fetch(`${scriptURL}?type=exportNow&date=${encodeURIComponent(date)}`);
      const result = await res.text();
      alert(result || "‚úÖ –≠–∫—Å–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω");
    } catch (err) {
      alert("‚ùå –û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: " + err.message);
    }
  });
}

async function runCustomReport() {
  withLoading("reportBtn", async () => {
    const start = document.getElementById("reportStartDate").value;
    const end = document.getElementById("reportEndDate").value;

    if (!start || !end) {
      alert("‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ –Ω–∞—á–∞–ª–æ –∏ –∫–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞");
      return;
    }

    try {
      const res = await fetch(`${scriptURL}?type=weeklyReport&start=${start}&end=${end}`);
      const text = await res.text();

      alert(text || "‚úÖ –û—Ç—á—ë—Ç —É—Å–ø–µ—à–Ω–æ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω");
    } catch (err) {
      alert("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –æ—Ç—á—ë—Ç–∞: " + err.message);
    }
  });
}

async function analyzePackers() {
  withLoading("analyzeBtn", async () => {
    const start = document.getElementById("analyzeStart").value;
    const end = document.getElementById("analyzeEnd").value;
    const output = document.getElementById("packerAnalysis");

    if (!start || !end) {
      output.innerHTML = "<p style='color:red;'>‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ –æ–±–µ –¥–∞—Ç—ã</p>";
      return;
    }

    output.innerHTML = "‚åõ –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...";

    try {
      const res = await fetch(`${scriptURL}?type=packerAnalytics&start=${start}&end=${end}`);
      const data = await res.json();

      if (!data.ok || !data.list || !data.list.length) {
        output.innerHTML = "<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</p>";
        return;
      }

      const best = data.best || {};

      let html = "<table style='width:100%; border-collapse:collapse;'>";
      html += `
        <thead><tr style="background:#f3f4f6;">
          <th style="border:1px solid #ccc; padding:6px;">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
          <th style="border:1px solid #ccc; padding:6px;">–ö–æ–ª-–≤–æ</th>
          <th style="border:1px solid #ccc; padding:6px;">–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th>
          <th style="border:1px solid #ccc; padding:6px;">–ó–∞—Ä–ø–ª–∞—Ç–∞</th>
        </tr></thead>
        <tbody>
      `;

      data.list.forEach(row => {
        html += `
          <tr>
            <td style="border:1px solid #ccc; padding:6px;">${row.name}</td>
            <td style="border:1px solid #ccc; padding:6px;">${row.qty}</td>
            <td style="border:1px solid #ccc; padding:6px;">${row.efficiency}%</td>
            <td style="border:1px solid #ccc; padding:6px;">${row.wage.toFixed(2)} ‚ÇΩ</td>
          </tr>
        `;
      });

      html += "</tbody></table>";

      if (best.name) {
        html += `<p style="margin-top:12px;"><strong>üèÜ –õ—É—á—à–∏–π —É–ø–∞–∫–æ–≤—â–∏–∫:</strong> ${best.name} (${best.qty} —à—Ç, ${best.efficiency}% —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å)</p>`;
      }

      output.innerHTML = html;
    } catch (err) {
      output.innerHTML = `<p style="color:red;">–û—à–∏–±–∫–∞: ${err.message}</p>`;
    }
  });
}


async function withLoading(buttonId, asyncCallback) {
  const btn = document.getElementById(buttonId);
  if (!btn) return;

  btn.classList.add("button-loading");
  btn.disabled = true;

  try {
    await asyncCallback();
  } catch (err) {
    console.error("–û—à–∏–±–∫–∞:", err);
    throw err;
  } finally {
    btn.classList.remove("button-loading");
    btn.disabled = false;
  }
}

async function loadShiftStats() {
  const date = document.getElementById("adminDate").value;
  const container = document.getElementById("shiftStatsOutput");
  container.innerHTML = "";

  if (!date) {
    container.innerHTML = "<p style='color:red;'>‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É</p>";
    return;
  }

  try {
    const res = await fetch(`${scriptURL}?type=shiftStats&date=${encodeURIComponent(date)}`);
    const data = await res.json();

    if (!data || !data.data || !data.data.length) {
      container.innerHTML = "<p style='text-align:center;'>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç–µ</p>";
      return;
    }

    data.data.forEach(group => {
      const table = document.createElement("table");
      table.style.width = "100%";
      table.style.marginTop = "16px";
      table.style.borderCollapse = "collapse";

      const caption = document.createElement("caption");
      caption.textContent = `üïê –°–º–µ–Ω–∞: ${group.shift}`;
      caption.style.fontWeight = "bold";
      caption.style.marginBottom = "8px";
      table.appendChild(caption);

      const thead = document.createElement("thead");
      thead.innerHTML = `
        <tr style="background:#f3f4f6;">
          <th style="padding:6px; border:1px solid #ccc;">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
          <th style="padding:6px; border:1px solid #ccc;">–ö–æ–ª-–≤–æ</th>
          <th style="padding:6px; border:1px solid #ccc;">–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th>
          <th style="padding:6px; border:1px solid #ccc;">–ó–∞—Ä–ø–ª–∞—Ç–∞</th>
        </tr>
      `;
      table.appendChild(thead);

      const tbody = document.createElement("tbody");
      group.employees.forEach(e => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td style="padding:6px; border:1px solid #ccc;">${e.name}</td>
          <td style="padding:6px; border:1px solid #ccc;">${e.quantity}</td>
          <td style="padding:6px; border:1px solid #ccc;">${e.efficiency}%</td>
          <td style="padding:6px; border:1px solid #ccc;">${e.wage.toFixed(2)} ‚ÇΩ</td>
        `;
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      container.appendChild(table);

      // üëâ –ò—Ç–æ–≥–∏ –ø–æ —Å–º–µ–Ω–µ
      const totalQty = group.employees.reduce((sum, e) => sum + e.quantity, 0);
      const totalWage = group.employees.reduce((sum, e) => sum + e.wage, 0);
      const avgEff = Math.round(
        group.employees.reduce((sum, e) => sum + e.efficiency, 0) / group.employees.length
      );

      const summary = document.createElement("div");
      summary.style.marginTop = "8px";
      summary.style.padding = "8px";
      summary.style.background = "#fef3c7";
      summary.style.borderRadius = "6px";
      summary.style.fontWeight = "bold";
      summary.textContent = `üìä –ò—Ç–æ–≥–æ: üî¢ ${totalQty} —à—Ç | ‚öôÔ∏è ${avgEff}% | üí∞ ${totalWage.toFixed(2)} ‚ÇΩ`;

      container.appendChild(summary);
    });
  } catch (err) {
    container.innerHTML = "<p style='color:red;'>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: " + err.message + "</p>";
  }
}
// üì± –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ –Ω–∏–∂–Ω–µ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
window.addEventListener("resize", () => {
  const nav = document.getElementById("bottomNav");
  const isKeyboardOpen = window.innerHeight < 500;
  nav.style.display = isKeyboardOpen ? "none" : "flex";
});
// üì° –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É
window.addEventListener('offline', () => {
  alert('üì° –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É');
});
window.addEventListener('online', () => {
  alert('‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
});
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/service-worker.js')
        .then(reg => console.log('‚úÖ Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:', reg.scope))
        .catch(err => console.error('‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ SW:', err));
    });
  }
</script>
<div id="editModal" style="display:none; position:fixed; top:10%; left:0; right:0; margin:auto; max-width:500px; background:white; padding:20px; border-radius:10px; box-shadow:0 2px 12px rgba(0,0,0,0.3); z-index:1000;">
  <h3>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å</h3>
  <form id="editForm">
  <input type="hidden" name="rowIndex" />
  <input type="hidden" name="employeeName" />
  <input type="hidden" name="orderNumber" />
  <input type="hidden" name="shiftType" />
  <input type="hidden" name="employeeStatus" />
  <input type="hidden" name="duration" />

  <label>–û–ø–µ—Ä–∞—Ü–∏—è:
    <select name="operationType" id="editOperation" required></select>
  </label>

  <label id="editVolumeLabel">–û–±—ä—ë–º:
    <select name="volume" id="editVolumeSelect"></select>
  </label>

  <div id="editSetNumberField" style="display:none;">
    <label>–ê—Ä—Ç–∏–∫—É–ª –Ω–∞–±–æ—Ä–∞:
      <select name="setNumber" id="editSetNumberSelect"></select>
    </label>
  </div>

  <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:<input name="quantity" type="number" required /></label>
  <label>–ù–∞—á–∞–ª–æ:<input name="startTime" type="time" required /></label>
  <label>–û–∫–æ–Ω—á–∞–Ω–∏–µ:<input name="endTime" type="time" required /></label>

  <button type="button" onclick="submitEditForm()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  <button type="button" onclick="closeEditModal()" class="danger">‚ùå –û—Ç–º–µ–Ω–∞</button>
</form>
</div>
<nav id="bottomNav" class="mobile-nav" style="display:none;">
  <button onclick="switchTab('profile')" id="tabProfile">üë§</button>
  <button onclick="switchTab('app')" id="tabApp" disabled>üìã</button>
  <button onclick="switchTab('stats')" id="tabStats">üìà</button>
  <button onclick="switchTab('rates')" id="tabRates">üí∞</button>
  <button onclick="switchTab('mySalary')" id="tabMySalary">üíµ</button>
  <button onclick="switchTab('admin')" id="tabAdmin" style="display:none;">üõ†Ô∏è</button>
</nav>
</body>
</html>
