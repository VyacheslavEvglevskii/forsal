<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<link rel="manifest" href="manifest.json">
<link rel="icon" href="icon-192.png" type="image/png">
<meta name="theme-color" content="#34d399">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="PackControl">
<link rel="apple-touch-icon" href="icon-512.png">
  <title>üì¶ –£—á—ë—Ç —É–ø–∞–∫–æ–≤–∫–∏</title>
  <style>
  /* ===== –û—Å–Ω–æ–≤—ã ===== */
body {
  margin: 0;
  padding: 72px 12px 12px;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background-color: #f1f5f9;
}

.table-scroll {
  overflow-x: auto;
  width: 100%;
}
@media (max-width: 600px) {
  #ratesTable table, .table-scroll table {
    font-size: 12px;
    min-width: 600px;
  }
  #ratesTable th, #ratesTable td {
    padding: 6px 8px;
  }
  
  /* === –ú–û–ë–ò–õ–¨–ù–ê–Ø –ê–î–ê–ü–¢–ê–¶–ò–Ø –ê–ù–ê–õ–ò–ó–ê –ù–û–†–ú–ê–¢–ò–í–û–í === */
  #normativesAnalysisContainer {
    margin-top: 10px !important;
  }
  
  /* –§–∏–ª—å—Ç—Ä—ã –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
  #normativesAnalysisContainer .filters-mobile {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  
  #normativesAnalysisContainer .filters-row {
    display: flex;
    gap: 8px;
  }
  
  #normativesAnalysisContainer .filters-row > div {
    flex: 1;
  }
  
  /* –¢–∞–±–ª–∏—Ü–∞ –Ω–æ—Ä–º–∞—Ç–∏–≤–æ–≤ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö - –∫–∞—Ä—Ç–æ—á–∫–∏ */
  .normatives-mobile-cards {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  
  .normative-card {
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    padding: 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  
  .normative-card.overstated {
    border-color: #f97316;
    background: linear-gradient(135deg, #fff7ed 0%, #fed7aa 100%);
  }
  
  .normative-card.understated {
    border-color: #10b981;
    background: linear-gradient(135deg, #ecfdf5 0%, #a7f3d0 100%);
  }
  
  .normative-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 12px;
  }
  
  .normative-card-title {
    font-size: 16px;
    font-weight: 600;
    color: #1f2937;
    line-height: 1.2;
    flex: 1;
  }
  
  .normative-card-status {
    font-size: 20px;
    margin-left: 8px;
  }
  
  .normative-card-details {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-bottom: 16px;
  }
  
  .normative-detail {
    text-align: center;
    padding: 8px;
    background: rgba(255,255,255,0.7);
    border-radius: 8px;
  }
  
  .normative-detail-value {
    font-size: 16px;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 2px;
  }
  
  .normative-detail-label {
    font-size: 11px;
    color: #6b7280;
  }
  
  .normative-card-action {
    width: 100%;
    background: #f59e0b;
    color: white;
    border: none;
    padding: 12px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
  }
  
  /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
  #editNormModal .modal-content {
    margin: 20px !important;
    max-height: calc(100vh - 40px) !important;
    max-width: calc(100vw - 40px) !important;
  }
  
  #editNormModal .info-grid-mobile {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-bottom: 20px;
  }
  
  #editNormModal .info-item-mobile {
    background: #f8fafc;
    padding: 12px;
    border-radius: 8px;
    text-align: center;
  }
  
  #editNormModal .info-value-mobile {
    font-size: 16px;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 4px;
  }
  
  #editNormModal .info-label-mobile {
    font-size: 11px;
    color: #6b7280;
  }
  
  /* –°–∫—Ä—ã–≤–∞–µ–º –æ–±—ã—á–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
  @media (max-width: 768px) {
    .normatives-desktop-table {
      display: none !important;
    }
    
    .normatives-mobile-cards {
      display: flex !important;
    }
  }
  
  /* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ */
  @media (min-width: 769px) {
    .normatives-desktop-table {
      display: block !important;
    }
    
    .normatives-mobile-cards {
      display: none !important;
    }
    
    .filters-mobile {
      display: none !important;
    }
    
    .filters-desktop {
      display: block !important;
    }
  }
  
  /* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–±–∏–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞ –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö */
  @media (max-width: 768px) {
    .filters-mobile {
      display: flex !important;
    }
    
    .filters-desktop {
      display: none !important;
    }
  }
}

h2 {
  font-size: 22px;
  font-weight: 600;
  color: #000000;
  margin-bottom: 20px;
  text-align: center;
}

.container {
  background-color: #ffffff;
  border-radius: 16px;
  padding: 20px;
  margin: 24px auto;
  max-width: 600px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}



label {
  display: block;
  font-weight: 600;
  color: #000000;
  margin-top: 16px;
  margin-bottom: 6px;
  font-size: 15px;
}

p {
  color: #000000;
}

span {
  color: #000000;
}

div {
  color: #000000;
}

input, select, textarea {
  width: 100%;
  padding: 12px;
  font-size: 15px;
  border: 1px solid #d1d5db;
  border-radius: 10px;
  background: #f9fafb;
  color: #000000;
  margin-bottom: 16px;
  box-sizing: border-box;
  transition: border 0.2s ease, box-shadow 0.2s ease;
}

input:focus, select:focus, textarea:focus {
  border-color: #2563eb;
  background-color: #ffffff;
  outline: none;
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
}

button {
  background-color: #2563eb;
  color: white;
  padding: 16px 18px;
  font-size: 15px;
  font-weight: 600;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  width: 100%;
  margin-top: 12px;
  min-height: 48px;
  touch-action: manipulation;
  transition: background 0.2s ease, transform 0.1s ease;
}

/* –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è –∫–Ω–æ–ø–æ–∫ - –æ—Å—Ç–∞–≤–ª—è–µ–º –±–µ–ª—ã–π —Ç–µ–∫—Å—Ç */
button {
  color: white !important;
}

/* –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–º —Ñ–æ–Ω–æ–º */
div[style*="background: linear-gradient"] {
  color: white !important;
}

/* –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å —Ü–≤–µ—Ç–Ω—ã–º —Ñ–æ–Ω–æ–º (—Ç–æ–ª—å–∫–æ –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã—Ö –±–ª–æ–∫–æ–≤) */
div[style*="background: #"] {
  color: white !important;
}

/* –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Å —Ü–≤–µ—Ç–Ω—ã–º —Ñ–æ–Ω–æ–º */
button[style*="background:"] {
  color: white !important;
}

button:hover {
  background-color: #1d4ed8;
}

button:active {
  transform: scale(0.97);
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö */
@keyframes pulseButton {
  0% {
    box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.7);
  }
  70% {
    box-shadow: 0 0 0 8px rgba(37, 99, 235, 0);
  }
  100% {
    box-shadow: 0 0 0 0 rgba(37, 99, 235, 0);
  }
}

.save-button-pulse {
  animation: pulseButton 2s infinite;
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∫–Ω–æ–ø–∫–∏ –≤—Ö–æ–¥–∞ */
#loginBtn {
  transition: all 0.3s ease;
  position: relative;
}

#loginBtn:hover {
  background-color: #1d4ed8;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
}

#loginBtn:active {
  transform: translateY(0);
}

/* –°—Ç–∏–ª—å –¥–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ */
#loginBtn.loading {
  background-color: #6b7280 !important;
  cursor: not-allowed !important;
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –∫—ç—à–µ */
@keyframes slideIn {
  0% {
    transform: translateX(100%);
    opacity: 0;
  }
  100% {
    transform: translateX(0);
    opacity: 1;
  }
}

button.danger {
  background-color: #dc2626;
}

button.danger:hover {
  background-color: #b91c1c;
}

.top-nav {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  display: flex;
  justify-content: space-around;
  background-color: #2563eb;
  padding: 10px 0;
  border-bottom-left-radius: 12px;
  border-bottom-right-radius: 12px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
  z-index: 1000;
}

.top-nav button {
  background: none;
  border: none;
  color: white;
  font-size: 20px;
  cursor: pointer;
  flex: 1;
  text-align: center;
  transition: all 0.3s ease;
  padding: 12px 6px;
  min-height: 48px;
  touch-action: manipulation;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Å–∫—Ä—ã—Ç—ã—Ö –∫–Ω–æ–ø–æ–∫ –≤ –∞–¥–º–∏–Ω-—Ä–µ–∂–∏–º–µ */
.top-nav button.admin-hidden {
  display: none !important;
  visibility: hidden !important;
  width: 0 !important;
  padding: 0 !important;
  margin: 0 !important;
  flex: 0 !important;
}

.top-nav button.admin-visible {
  display: inline-block !important;
  visibility: visible !important;
  flex: 1 !important;
}

.mobile-nav button:active {
  transform: scale(0.94);
}

.mobile-nav button.active {
  background: #1e40af;
  color: white;
}

.stat-card {
  background-color: #ffffff;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  padding: 16px;
  margin-top: 16px;
  font-size: 15px;
  color: #1f2937;
}

.stat-card p {
  margin: 6px 0;
}

.stat-card button {
  margin-top: 12px;
  padding: 12px 16px;
  font-size: 16px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  background-color: #2563eb;
  color: white;
  min-height: 48px;
  touch-action: manipulation;
}

.stat-card button:hover {
  background-color: #1d4ed8;
}

#rateInfo, #calcBlock {
  margin-top: 16px;
  padding: 16px;
  border-radius: 12px;
  background-color: #f3f4f6;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
  font-size: 15px;
  color: #1f2937;
}

#rateInfo p, #calcBlock p {
  margin: 8px 0;
  display: flex;
  justify-content: space-between;
  font-weight: 500;
}

#rateInfo strong, #calcBlock strong {
  color: #111827;
}

#totalWage {
  font-size: 16px;
  margin-top: 16px;
  background: #ecfdf5;
  padding: 12px;
  border-radius: 10px;
  text-align: center;
  color: #065f46;
  font-weight: 600;
  box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04);
}

#editModal {
  max-width: 480px;
  background-color: white;
  border-radius: 16px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
  padding: 24px;
  font-size: 15px;
  color: #1f2937;
}

#editModal label {
  display: block;
  margin-top: 12px;
  font-weight: 500;
}

#editModal select, #editModal input {
  width: 100%;
  padding: 8px;
  margin-top: 4px;
  border-radius: 8px;
  border: 1px solid #d1d5db;
  font-size: 15px;
}

#editModal button {
  margin-top: 16px;
  padding: 10px 16px;
  border: none;
  border-radius: 10px;
  background-color: #2563eb;
  color: white;
  font-weight: 600;
  cursor: pointer;
}

#editModal button:hover {
  background-color: #1d4ed8;
}

#editModal button.danger {
  background-color: #dc2626;
  margin-left: 12px;
}

#editModal button.danger:hover {
  background-color: #b91c1c;
}

.tooltip[data-tooltip]:hover::after {
  content: attr(data-tooltip);
  position: absolute;
  background-color: #1f2937;
  color: white;
  padding: 6px 10px;
  border-radius: 6px;
  font-size: 13px;
  white-space: nowrap;
  top: 100%;
  left: 0;
  margin-top: 6px;
  z-index: 10;
}

#ratesTable {
  width: 100%;
  border-collapse: collapse;
  margin-top: 16px;
  background: white;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
}

#ratesTable th, #ratesTable td {
  padding: 12px 14px;
  text-align: left;
  font-size: 16px; /* –£–≤–µ–ª–∏—á–∏–ª–∏ —Å 14px –¥–æ 16px */
  border-bottom: 1px solid #e5e7eb;
}

#ratesTable th {
  background-color: #f3f4f6;
  color: #374151;
  font-weight: 600;
  position: sticky;
  top: 0;
  z-index: 10;
  cursor: pointer;
  transition: background-color 0.2s;
}

#ratesTable th:hover {
  background-color: #e5e7eb;
}

/* –¶–≤–µ—Ç–æ–≤–æ–µ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–æ–∫ —Ç–∞—Ä–∏—Ñ–æ–≤ */
#ratesTable th:nth-child(4), #ratesTable td:nth-child(4) {
  background-color: rgba(59, 130, 246, 0.05); /* –ì–æ–ª—É–±–æ–π –¥–ª—è —Å–¥–µ–ª—å–Ω–æ–π */
  border-left: 3px solid #3b82f6;
}

#ratesTable th:nth-child(5), #ratesTable td:nth-child(5) {
  background-color: rgba(34, 197, 94, 0.05); /* –ó–µ–ª–µ–Ω—ã–π –¥–ª—è FBS */
  border-left: 3px solid #22c55e;
}

#ratesTable th:nth-child(6), #ratesTable td:nth-child(6) {
  background-color: rgba(147, 51, 234, 0.05); /* –§–∏–æ–ª–µ—Ç–æ–≤—ã–π –¥–ª—è –æ–∫–ª–∞–¥+—Å–¥–µ–ª */
  border-left: 3px solid #9333ea;
}

#ratesTable th:nth-child(7), #ratesTable td:nth-child(7) {
  background-color: rgba(147, 51, 234, 0.08); /* –¢–µ–º–Ω–µ–µ –¥–ª—è FBS –æ–∫–ª–∞–¥+—Å–¥–µ–ª */
  border-left: 3px solid #7c3aed;
}

/* –í—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π */
#ratesTable td:nth-child(4), #ratesTable td:nth-child(5), 
#ratesTable td:nth-child(6), #ratesTable td:nth-child(7) {
  font-weight: 600;
  color: #1f2937;
}

#ratesTable tr:nth-child(even) td {
  background-color: rgba(249, 250, 251, 0.5);
}

#ratesTable tr:hover td {
  background-color: rgba(238, 242, 255, 0.8);
  transform: scale(1.01);
  transition: all 0.2s ease;
  box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
}

/* –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ - –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã */
#ratesTable th.sortable::after {
  content: ' ‚ÜïÔ∏è';
  opacity: 0.5;
  font-size: 12px;
}

#ratesTable th.sorted-asc::after {
  content: ' ‚¨ÜÔ∏è';
  opacity: 1;
}

#ratesTable th.sorted-desc::after {
  content: ' ‚¨áÔ∏è';
  opacity: 1;
}

#adminContainer {
  background: white;
  border-radius: 16px;
  padding: 20px;
  margin-top: 20px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
}

#adminContainer h3 {
  font-size: 18px;
  margin-bottom: 12px;
  color: #000000;
  font-weight: 600;
}

#adminContainer input[type="text"],
#adminContainer select {
  width: 100%;
  padding: 10px;
  margin-top: 6px;
  border-radius: 10px;
  border: 1px solid #d1d5db;
  font-size: 15px;
  background: #f9fafb;
}

#adminContainer button {
  margin-top: 12px;
}

@media (max-width: 500px) {
  .container, #editModal {
    padding: 16px;
    border-radius: 12px;
  }

  #ratesTable th, #ratesTable td {
    padding: 10px 12px;
  }

  button {
    font-size: 14px;
    padding: 12px;
  }

  h2 {
    font-size: 20px;
  }

  #adminContainer label {
    flex: 1 1 100%;
  }

  #adminContainer input[type="date"] {
    font-size: 16px;
  }

  .form-item label,
  input,
  select {
    font-size: 14px;
    padding: 6px;
  }
}

/* ===== –°–¢–ò–õ–ò –î–õ–Ø –°–ò–°–¢–ï–ú–´ –ó–ê–©–ò–¢–´ –û–¢ –î–£–ë–õ–ò–ö–ê–¢–û–í ===== */
.duplicate-warnings {
  margin: 16px 0;
  border-radius: 12px;
  overflow: hidden;
  display: none;
}

.warning-section {
  margin-bottom: 12px;
  border-radius: 8px;
  padding: 12px;
}

.warning-section.critical {
  background: #fef2f2;
  border-left: 4px solid #dc2626;
}

.warning-section.warning {
  background: #fffbeb;
  border-left: 4px solid #f59e0b;
}

.warning-section.info {
  background: #eff6ff;
  border-left: 4px solid #3b82f6;
}

.warning-section h4 {
  margin: 0 0 8px 0;
  font-size: 14px;
  font-weight: 600;
}

.warning-section.critical h4 {
  color: #dc2626;
}

.warning-section.warning h4 {
  color: #d97706;
}

.warning-section.info h4 {
  color: #2563eb;
}

.warning-item {
  padding: 8px;
  margin: 6px 0;
  border-radius: 6px;
  font-size: 13px;
}

.warning-item.critical {
  background: #fecaca;
  color: #7f1d1d;
}

.warning-item.warning {
  background: #fed7aa;
  color: #92400e;
}

.warning-item.info {
  background: #bfdbfe;
  color: #1e40af;
}

.warning-item small {
  color: rgba(0, 0, 0, 0.6);
  font-size: 11px;
  display: block;
  margin-top: 4px;
}

.form-validation-hint {
  position: relative;
}

.form-validation-hint::after {
  content: '';
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  width: 16px;
  height: 16px;
  border-radius: 50%;
  display: none;
}

.form-validation-hint.valid::after {
  background: #10b981;
  display: block;
}

.form-validation-hint.warning::after {
  background: #f59e0b;
  display: block;
}

.form-validation-hint.error::after {
  background: #ef4444;
  display: block;
}

.smart-suggestion {
  background: #f0f9ff;
  border: 1px solid #0ea5e9;
  border-radius: 8px;
  padding: 12px;
  margin: 8px 0;
  font-size: 13px;
}

.smart-suggestion h5 {
  margin: 0 0 6px 0;
  color: #0369a1;
  font-weight: 600;
}

.smart-suggestion button {
  background: #0ea5e9;
  color: white;
  border: none;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 11px;
  cursor: pointer;
  margin-top: 6px;
}

/* ===== –°–¢–ò–õ–ò –î–õ–Ø –°–û–û–ë–©–ï–ù–ò–ô –ò –£–í–ï–î–û–ú–õ–ï–ù–ò–ô ===== */
.success-message {
  background: #d1fae5;
  color: #065f46;
  border: 1px solid #a7f3d0;
  padding: 12px;
  border-radius: 8px;
  margin: 12px 0;
}

.error-message {
  background: #fef2f2;
  color: #991b1b;
  border: 1px solid #fca5a5;
  padding: 12px;
  border-radius: 8px;
  margin: 12px 0;
}

.warning-message {
  background: #fef3c7;
  color: #92400e;
  border: 1px solid #fcd34d;
  padding: 12px;
  border-radius: 8px;
  margin: 12px 0;
}

/* –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ */
#dataForm button[type="submit"] {
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

#dataForm button[type="submit"]:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: scale(0.98);
}

#dataForm button[type="submit"]:not(:disabled):hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ */
#dataForm button[type="submit"].loading::after {
  content: "";
  position: absolute;
  top: 50%;
  left: 50%;
  width: 16px;
  height: 16px;
  margin: -8px 0 0 -8px;
  border: 2px solid transparent;
  border-top: 2px solid #ffffff;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* –ê–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
@keyframes slideInRight {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

@keyframes slideOutRight {
  from {
    transform: translateX(0);
    opacity: 1;
  }
  to {
    transform: translateX(100%);
    opacity: 0;
  }
}

/* –£–ª—É—á—à–µ–Ω–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Ñ–æ—Ä–º—ã */
.form-disabled {
  pointer-events: none;
  opacity: 0.7;
  transition: opacity 0.3s ease;
}

.form-disabled::after {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(255, 255, 255, 0.1);
  z-index: 1000;
}

#appContainer.fullscreen {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: white;
  z-index: 1000;
  overflow-y: auto;
  padding: 20px;
}

#saveBar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: white;
  padding: 12px;
  box-shadow: 0 -2px 6px rgba(0, 0, 0, 0.08);
  z-index: 1100;
}

#saveBar button {
  width: 100%;
  font-size: 16px;
}

.form-row {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 12px;
}

.form-item {
  flex: 1 1 200px;
  min-width: 140px;
}

.form-item label {
  display: block;
  font-size: 16px;
  margin-bottom: 6px;
}

@media (max-width: 600px) {
  body {
    padding: 48px 2px 2px;
    font-size: 15px;
  }
  .container, .block, #editModal, #adminContainer, #mySalaryContainer, #ratesContainer, #profileContainer {
    padding: 6px 2px;
    border-radius: 8px;
    max-width: 100vw;
    box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    margin: 6px 0;
  }
  h2, .block-title {
    font-size: 17px;
    margin-bottom: 10px;
  }
  label, .item-label {
    font-size: 13px;
    margin-bottom: 2px;
  }
  input, select, textarea {
    font-size: 16px;
    min-height: 44px;
    padding: 12px 8px;
    border-radius: 8px;
    -webkit-appearance: none;
    appearance: none;
  }
  button, .button {
    font-size: 14px;
    min-height: 44px;
    border-radius: 8px;
    padding: 12px 8px;
    touch-action: manipulation;
  }
  .form-row, .block, .list {
    margin-bottom: 6px;
  }
  .table-scroll {
    overflow-x: auto;
    max-width: 100vw;
  }
  table {
    min-width: 480px;
    font-size: 12px;
  }
  th, td {
    white-space: nowrap;
    padding: 8px 10px;
    min-height: 44px;
    vertical-align: middle;
  }
  
  /* –£–ª—É—á—à–µ–Ω–Ω–∞—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –±–ª–æ–∫–∞ —Ç–∞—Ä–∏—Ñ–æ–≤ */
  #ratesContainer {
    padding: 8px 4px;
  }
  
  #ratesFilters {
    flex-direction: column !important;
    gap: 8px !important;
  }
  
  #ratesFilters > div {
    min-width: auto !important;
  }
  
  #ratesSearch {
    font-size: 16px !important; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∑—É–º –Ω–∞ iOS */
  }
  
  #ratesTable {
    font-size: 12px;
  }
  
  #ratesTable th, #ratesTable td {
    padding: 12px 8px;
    font-size: 14px;
    min-height: 44px;
    vertical-align: middle;
  }
  
  /* –°–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω–µ–µ –≤–∞–∂–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
  #ratesTable th:nth-child(6), #ratesTable td:nth-child(6),
  #ratesTable th:nth-child(7), #ratesTable td:nth-child(7) {
    display: none;
  }
  
  /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–∫—Ä—ã—Ç—ã—Ö –∫–æ–ª–æ–Ω–æ–∫ */
  #ratesTable::after {
    content: "üí° –ü–æ–≤–µ—Ä–Ω–∏—Ç–µ —ç–∫—Ä–∞–Ω –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤—Å–µ—Ö —Ç–∞—Ä–∏—Ñ–æ–≤";
    display: block;
    text-align: center;
    padding: 12px;
    background: #fef3c7;
    color: #92400e;
    border-radius: 8px;
    margin-top: 8px;
    font-size: 12px;
    }

  /* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –ø–æ–∏—Å–∫ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
  #ratesContainer > div:first-of-type {
    padding: 12px 8px !important;
  }
  
  /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
  .modal-content {
    margin: 10px !important;
    max-width: calc(100vw - 20px) !important;
    max-height: calc(100vh - 20px) !important;
    overflow-y: auto;
  }
  
  /* –£–ª—É—á—à–µ–Ω–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
  .table-scroll {
    -webkit-overflow-scrolling: touch;
  }
  
  /* –ö–Ω–æ–ø–∫–∏ –≤ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–Ω–∞—Ö */
  .modal-content button {
    min-height: 48px !important;
    font-size: 16px !important;
    padding: 12px !important;
    touch-action: manipulation;
  }
  
  /* –ú–æ–±–∏–ª—å–Ω–∞—è —Ñ–æ—Ä–º–∞ —Å—Ç–∞—Ä—à–µ–≥–æ —Å–º–µ–Ω—ã - –ø—Ä–æ—Å—Ç–∞—è –∏ —á–∏—Ç–∞–µ–º–∞—è */
  #reportContainer .senior-shift-form {
    padding: 12px !important;
    margin: 8px !important;
    border-radius: 12px !important;
    background: #ffffff !important;
    border: 1px solid #e5e7eb !important;
  }
  
  #reportContainer .senior-shift-form h3 {
    font-size: 18px !important;
    margin-bottom: 16px !important;
    color: #22c55e !important;
    text-align: center !important;
  }
  
  #reportContainer .senior-shift-form .form-row {
    flex-direction: column !important;
    gap: 8px !important;
    margin-bottom: 16px !important;
  }
  
  #reportContainer .senior-shift-form .form-row > div {
    min-width: auto !important;
    width: 100% !important;
  }
  
  #reportContainer .senior-shift-form select,
  #reportContainer .senior-shift-form input[type="date"] {
    min-height: 50px !important;
    font-size: 16px !important;
    padding: 14px 16px !important;
    border: 2px solid #e5e7eb !important;
    border-radius: 8px !important;
    background: #ffffff !important;
  }
  
  #reportContainer .senior-shift-form label {
    font-size: 14px !important;
    margin-bottom: 6px !important;
    font-weight: 600 !important;
    color: #374151 !important;
  }
  
  /* –ü—Ä–æ—Å—Ç—ã–µ –∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ —Å–º–µ–Ω—ã */
  #reportContainer .senior-shift-form .shift-buttons {
    display: flex !important;
    gap: 8px !important;
    margin-top: 8px !important;
  }
  
  #reportContainer .senior-shift-form .shift-button {
    flex: 1 !important;
    min-height: 50px !important;
    padding: 12px 8px !important;
    font-size: 16px !important;
    font-weight: 600 !important;
    border: 2px solid #e5e7eb !important;
    border-radius: 8px !important;
    background: #ffffff !important;
    color: #6b7280 !important;
    cursor: pointer !important;
    transition: all 0.2s ease !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    text-align: center !important;
  }
  
  #reportContainer .senior-shift-form .shift-button.active {
    border-color: #22c55e !important;
    background: #22c55e !important;
    color: #ffffff !important;
    box-shadow: 0 2px 4px rgba(34, 197, 94, 0.2) !important;
    transform: scale(0.98) !important;
  }
  
  #reportContainer .senior-shift-form .shift-button:active {
    transform: scale(0.95) !important;
  }
  
  #reportContainer .senior-shift-form .button-group {
    gap: 8px !important;
    margin-top: 20px !important;
  }
  
  #reportContainer .senior-shift-form .button-group button {
    padding: 14px 20px !important;
    font-size: 16px !important;
    min-height: 50px !important;
    border-radius: 8px !important;
    font-weight: 600 !important;
  }
  
  #reportContainer .senior-shift-form .info-text {
    font-size: 12px !important;
    margin: 12px 0 !important;
    padding: 8px !important;
    line-height: 1.4 !important;
    color: #6b7280 !important;
    text-align: center !important;
  }
}

  </style>
</head>
<body>
<!-- –ó–∞–≥—Ä—É–∑–æ—á–Ω—ã–π —ç–∫—Ä–∞–Ω Forsal -->
<div id="loadingScreen" style="
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: #f1f5f9;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
">
  <img src="forsal-loading-final.png" alt="–ó–∞–≥—Ä—É–∑–∫–∞ Forsal" style="
    width: 100%;
    max-width: 480px;
    height: auto;
    object-fit: contain;
    padding: 20px;
  ">
</div>
  <nav id="bottomNav" class="top-nav" style="display: none;">
    <button id="tabProfile" onclick="switchTab('profile')">üë§</button>
    <button id="tabApp" onclick="switchTab('app')" disabled>üìã</button>
    <button id="tabStats" onclick="switchTab('stats')">üìà</button>
    <button id="tabCostAnalysis" onclick="switchTab('costAnalysis')" style="display: none;">üìä</button>
    <button id="tabTraineeManagement" onclick="switchTab('traineeManagement')" style="display: none;">üë®‚Äçüéì</button>
    <button id="tabRates" onclick="switchTab('rates')">üí∞</button>
    <button id="tabMySalary" onclick="switchTab('mySalary')">üíµ</button>
    <button id="tabDuplicates" onclick="switchTab('duplicates')" style="display: none;">üîç</button>
    <button id="tabAdmin" onclick="switchTab('admin')" style="display: none;">üõ†Ô∏è</button>
  </nav>
<div class="container" id="loginContainer">
  <h2>üîê –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h2>
  <label for="login">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
  <input type="text" id="login" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è" required>

  <label for="password">–ü–∞—Ä–æ–ª—å</label>
  <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>

  <button id="loginBtn" onclick="handleLogin()">–í–æ–π—Ç–∏</button>
  <div id="loginError"></div>
</div>
<div class="container" style="display:none;" id="tabContainer">
</div>
<div class="container" style="display:none;" id="appContainer">
  <style>
    .form-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .form-item {
      flex: 1 1 200px;
    }
    /* –£–¥–∞–ª–µ–Ω–æ –ø–æ–≤–µ–¥–µ–Ω–∏–µ column –¥–ª—è –º–æ–±–∏–ª–æ–∫ */
  </style>

  <h2 id="mainTitle">üì¶ –£—á—ë—Ç —É–ø–∞–∫–æ–≤–∫–∏</h2>
  <form id="dataForm" style="padding-bottom: 100px;">
    <div class="tooltip" data-tooltip="–ü–æ–ª–µ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –≤—Ö–æ–¥–µ">
      <label>–ò–º—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞:
        <input name="employeeName" required readonly />
      </label>
    </div>

    <div class="form-row">
      <div class="form-item">
        <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:
          <input name="quantity" type="number" required />
        </label>
      </div>
      <div class="form-item">
        <label>–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞:
          <input name="orderNumber" required />
        </label>
      </div>
    </div>

    <div class="form-row">
      <div class="form-item">
        <label>–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞:
          <input name="startTime" type="time" required />
        </label>
      </div>
      <div class="form-item">
        <label>–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è:
          <input name="endTime" type="time" required />
        </label>
      </div>
    </div>

    <label>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
      <input name="duration" readonly />
    </label>

    <div class="form-row" id="operationSetWrapper">
  <div class="form-item">
    <label>–û–ø–µ—Ä–∞—Ü–∏—è:
      <select name="operationType" id="operationSelect" required></select>
    </label>
  </div>
  <div class="form-item" id="setNumberField" style="display:none;">
    <label>–ê—Ä—Ç–∏–∫—É–ª –Ω–∞–±–æ—Ä–∞:
      <select name="setNumber"></select>
    </label>
  </div>
</div>

<div id="volumeLabel">
  <label>–û–±—ä—ë–º:
    <select name="volume" id="volumeSelect" required></select>
  </label>
</div>

    <div id="rateInfo" style="margin-top:16px; background:#f0f0f0; padding:10px; border-radius:8px; display:none;">
      <p><strong>‚è± –ù–æ—Ä–º–∞ –≤ —á–∞—Å:</strong> <span id="normDisplay">-</span></p>
      <p><strong>üí∞ –¢–∞—Ä–∏—Ñ –∑–∞ 1 —à—Ç:</strong> <span id="rateDisplay">-</span></p>
    </div>

    <div id="calcBlock" style="margin-top:16px; background:#e7f5ff; padding:10px; border-radius:8px; display:none;">
      <p><strong>üí∏ –†–∞—Å—á—ë—Ç –æ–ø–ª–∞—Ç—ã:</strong> <span id="wageDisplay">-</span></p>
      <p><strong>‚öôÔ∏è –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:</strong> <span id="efficiencyDisplay">-</span></p>

    </div>

    <button type="submit">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </form>
  <p id="result" style="display:none;"></p>
</div>
<div class="container" style="display:none;" id="statsContainer">
  <h2>üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
<button id="closeStatsBtn" onclick="closeStats()" style="margin-bottom: 10px;">‚ùå –ó–∞–∫—Ä—ã—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
  <label>–í—ã–±—Ä–∞—Ç—å –¥–∞—Ç—É:<input type="date" id="statsDate"></label>
  <div style="margin-top: 12px;">
  <label>–§–∏–ª—å—Ç—Ä –ø–æ –æ–ø–µ—Ä–∞—Ü–∏–∏:
    <select id="operationFilter">
      <option value="">-- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ --</option>
    </select>
  </label>
  <button id="showStatsBtn" onclick="loadStats()">üìä –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
</div>
<div id="totalWage" style="text-align:center; font-weight:bold; margin-top:16px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding:16px; border-radius:12px; border:2px solid #0ea5e9; box-shadow: 0 4px 12px rgba(14, 165, 233, 0.2); font-size: 14px; line-height: 1.6; color: #000000 !important;"></div>
  <div id="statsCards"></div>
<div id="statsLogs" style="margin-top: 16px;"></div>
</div>
<div class="container" style="display:none;" id="profileContainer">
  <h2>üë§ –õ–∏—á–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å</h2>
  <label>–¢–∏–ø —Å–º–µ–Ω—ã:
    <select id="shiftType">
      <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å–º–µ–Ω—É --</option>
      <option>–î–µ–Ω—å</option>
      <option>–ù–æ—á—å</option>
    </select>
  </label>

  <!-- üåô –ë–õ–û–ö –î–õ–Ø –ù–û–ß–ù–´–• –°–ú–ï–ù -->
  <div id="nightShiftDateBlock" style="display:none;">
    <label>üìÖ –î–∞—Ç–∞ —Ç–µ–∫—É—â–µ–π –Ω–æ—á–Ω–æ–π —Å–º–µ–Ω—ã:
      <input type="date" id="nightShiftDate" style="font-size: 16px;" />
    </label>
    <small style="color:#6b7280; font-size:12px; margin-top:4px; display:block;">
      ‚ÑπÔ∏è –£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É, –∫ –∫–æ—Ç–æ—Ä–æ–π –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –≤–∞—à–∞ –Ω–æ—á–Ω–∞—è —Å–º–µ–Ω–∞ (–æ–±—ã—á–Ω–æ –≤—á–µ—Ä–∞—à–Ω–∏–π –¥–µ–Ω—å)
    </small>
    <div style="margin-top: 8px; display: flex; gap: 8px;">
      <button type="button" id="setYesterday" style="padding: 6px 12px; font-size: 12px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">üìÖ –í—á–µ—Ä–∞</button>
      <button type="button" id="setToday" style="padding: 6px 12px; font-size: 12px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer;">üìÖ –°–µ–≥–æ–¥–Ω—è</button>
    </div>
  </div>

  <label>–°—Ç–∞—Ç—É—Å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞:
    <select id="employeeStatus" required onchange="handleStatusChange()">
      <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>
      <option value="–®—Ç–∞—Ç">üë§ –®—Ç–∞—Ç</option>
      <option value="–ê—É—Ç—Å–æ—Ä—Å–∏–Ω–≥">ü§ù –ê—É—Ç—Å–æ—Ä—Å–∏–Ω–≥</option>
      <option value="–°—Ç–∞–∂–µ—Ä">üë®‚Äçüéì –°—Ç–∞–∂–µ—Ä</option>
    </select>
  </label>

  <!-- üë®‚Äçüè´ –ë–õ–û–ö –î–õ–Ø –ù–ê–°–¢–ê–í–ù–ò–ö–û–í (—à—Ç–∞—Ç–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤) -->
  <div id="mentorBlock" style="display:none;">
    <label>üë®‚Äçüéì –ú–æ–π —Å—Ç–∞–∂–µ—Ä:
      <div style="padding: 8px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 4px; margin-top: 4px;">
        <span id="profileTraineeDisplay" style="color: #374151;">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</span>
        <span id="profileTraineeBonusDisplay" style="color: #6b7280; font-size: 12px; margin-left: 8px;"></span>
      </div>
      <small style="color: #6b7280; font-size: 12px; margin-top: 4px; display: block;">
        ‚ÑπÔ∏è –î–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–≤—è–∑–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–ª–æ–∫ "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞–∂–µ—Ä–∞–º–∏"
      </small>
    </label>
  </div>

  <!-- üë®‚Äçüéì –ë–õ–û–ö –î–õ–Ø –°–¢–ê–ñ–ï–†–û–í -->
  <div id="traineeBlock" style="display:none;">
    <label>üë§ –ú–æ–π –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫:
      <div style="padding: 8px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 4px; margin-top: 4px;">
        <span id="profileMentorDisplay" style="color: #374151;">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</span>
      </div>
      <small style="color: #6b7280; font-size: 12px; margin-top: 4px; display: block;">
        ‚ÑπÔ∏è –î–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–≤—è–∑–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–ª–æ–∫ "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞–∂–µ—Ä–∞–º–∏"
      </small>
    </label>
  </div>

<label>–¢–∏–ø –æ–ø–ª–∞—Ç—ã:
  <select id="profilePayType" required>
    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>
    <option value="–°–¥–µ–ª–∫–∞">–°–¥–µ–ª–∫–∞</option>
    <option value="–û–∫–ª–∞–¥ + —Å–¥–µ–ª–∫–∞">–û–∫–ª–∞–¥ + —Å–¥–µ–ª–∫–∞</option>
  </select>
</label>
<div id="salaryBlock" style="display:none;">
  <label>–û–∫–ª–∞–¥ <span style="color:red;">*</span>:
    <input id="profileSalary" type="number" readonly />
  </label>
</div>
  <!-- –í–°–¢–ê–í–¨ –°–Æ–î–ê: -->
  <label>–ú–æ–¥–µ–ª—å —É–ø–∞–∫–æ–≤–∫–∏:
    <select id="profilePackingModel" name="profilePackingModel" required>
      <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>
      <!-- –û–ø—Ü–∏–∏ –±—É–¥—É—Ç –ø–æ–¥–≥—Ä—É–∂–µ–Ω—ã –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ -->
    </select>
  </label>

  <button id="saveProfileBtn" onclick="saveProfile()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  <p id="profileSaved" style="color:green; text-align:center; display:none;">‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</p>
      <p id="profileHint" style="color:#dc2626; font-size:14px; text-align:center; margin-top:12px;">
      ‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –ø—Ä–æ—Ñ–∏–ª—è (–≤–∫–ª—é—á–∞—è –æ–∫–ª–∞–¥ –¥–ª—è —Ç–∏–ø–∞ "–û–∫–ª–∞–¥ + —Å–¥–µ–ª–∫–∞") –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –≤–∫–ª–∞–¥–∫–∞–º —Å–∏—Å—Ç–µ–º—ã.
    </p>
    <p id="profileUnsaved" style="color:#f59e0b; font-size:14px; text-align:center; margin-top:8px; display:none;">
      üíæ –ï—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è! –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª.
    </p>
  <button id="logoutBtn" onclick="handleLogout()" class="danger">üö™ –í—ã–π—Ç–∏</button>
</div>
<div class="container" style="display:none;" id="ratesContainer">
  <h2>üí∞ –¢–∞—Ä–∏—Ñ—ã –∏ –Ω–æ—Ä–º–∞—Ç–∏–≤—ã</h2>
  
  <!-- üîç –ü–û–ò–°–ö –ò –§–ò–õ–¨–¢–†–´ -->
  <div style="background: #f8fafc; padding: 16px; border-radius: 12px; margin: 16px 0; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
    <!-- –ñ–∏–≤–æ–π –ø–æ–∏—Å–∫ -->
    <div style="margin-bottom: 12px;">
      <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #374151;">üîç –ü–æ–∏—Å–∫ –ø–æ –æ–ø–µ—Ä–∞—Ü–∏—è–º</label>
      <input type="text" id="ratesSearch" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏..." 
             style="width: 100%; padding: 10px; font-size: 16px; border: 2px solid #e5e7eb; border-radius: 8px; transition: border-color 0.2s;">
    </div>
    
    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <div id="ratesFilters" style="display: flex; gap: 10px; flex-wrap: wrap;">
      <div style="flex: 1; min-width: 200px;">
        <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #374151;">üè∑Ô∏è –û–ø–µ—Ä–∞—Ü–∏—è</label>
        <select id="filterOperation" style="width: 100%; padding: 10px; font-size: 16px; border: 2px solid #e5e7eb; border-radius: 8px;">
      <option value="">-- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ --</option>
    </select>
      </div>
      <div style="flex: 1; min-width: 200px;">
        <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #374151;">üì¶ –û–±—ä—ë–º/–ê—Ä—Ç–∏–∫—É–ª</label>
        <select id="filterKey" style="width: 100%; padding: 10px; font-size: 16px; border: 2px solid #e5e7eb; border-radius: 8px;">
      <option value="">-- –í—Å–µ –æ–±—ä—ë–º—ã / –∞—Ä—Ç–∏–∫—É–ª—ã --</option>
    </select>
</div>
    </div>
    
    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
    <div id="ratesCounter" style="text-align: center; margin-top: 12px; font-weight: 600; color: #6b7280;"></div>
  </div>

  <!-- üìã –°–ü–ò–°–û–ö –¢–ê–†–ò–§–û–í -->
  <div id="ratesTableContainer" style="position: relative;">
    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div id="ratesLoader" style="display: none; text-align: center; padding: 40px; color: #6b7280;">
      <div style="display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f4f6; border-top: 3px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite;"></div>
      <p style="margin-top: 10px;">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∞—Ä–∏—Ñ–æ–≤...</p>
    </div>
  <div id="ratesTable"></div>
  </div>
</div>
  <!-- –¢–∞–±–ª–∏—Ü–∞ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ —á–µ—Ä–µ–∑ JS -->
</div>
<!-- üì¶ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä: –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å -->
<div class="container" id="adminContainer" style="display:none;">
  <h2>üõ†Ô∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2>

<!-- üìÖ –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥ -->
<div style="margin-bottom: 16px; display: flex; flex-wrap: wrap; gap: 10px;">
  <label style="flex:1 1 200px;">–ü–µ—Ä–∏–æ–¥ —Å:
    <input type="date" id="unifiedStart">
  </label>
  <label style="flex:1 1 200px;">–ø–æ:
    <input type="date" id="unifiedEnd">
  </label>
</div>

  <!-- üîò –î–µ–π—Å—Ç–≤–∏—è -->
<div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 16px;">
  <button onclick="loadShiftStats()">üìä –°–≤–æ–¥–∫–∞ –ø–æ —Å–º–µ–Ω–µ</button>
  <button onclick="analyzePackers()" id="analyzeBtn">üßÆ –ê–Ω–∞–ª–∏–∑ —à—Ç–∞—Ç–Ω—ã—Ö —É–ø–∞–∫–æ–≤—â–∏–∫–æ–≤</button>
  <button onclick="openUpdateAllModal()" id="updateAllBtn" style="background:#8b5cf6;">üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–ª–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π</button>
  <button onclick="runCustomReport()" id="reportBtn">üìÜ –û—Ç—á—ë—Ç –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π –∑–∞ –ø–µ—Ä–∏–æ–¥</button>
  <button onclick="loadSeniorsReport()" id="seniorsReportBtn" style="background:#8b5cf6;">üë®‚Äçüíº –ê–Ω–∞–ª–∏–∑ —Å—Ç–∞—Ä—à–∏—Ö —Å–º–µ–Ω</button>
  <button onclick="showSeniorShiftForm()" id="addSeniorBtn" style="background:#22c55e;">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞—Ä—à–µ–≥–æ —Å–º–µ–Ω—ã</button>
  <button onclick="openSalaryExportModal()" id="salaryExportBtn" style="background:#10b981;">üíµ –í—ã–≥—Ä—É–∑–∫–∞ –∑–∞—Ä–ø–ª–∞—Ç—ã HR</button>
  <button onclick="loadNormativesAnalysis()" id="normativesBtn" style="background:#f59e0b;">üîç –ê–Ω–∞–ª–∏–∑ –Ω–æ—Ä–º–∞—Ç–∏–≤–æ–≤</button>
</div>

<!-- üßæ –ï–¥–∏–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –æ—Ç—á—ë—Ç–æ–≤ -->
<div id="reportContainer" style="margin-top: 20px;"></div>

<!-- üîç –ë–ª–æ–∫ –∞–Ω–∞–ª–∏–∑–∞ –Ω–æ—Ä–º–∞—Ç–∏–≤–æ–≤ -->
<div id="normativesAnalysisContainer" style="margin-top: 20px; display: none;">
  <h3 style="text-align: center; color: #f59e0b; margin-bottom: 20px;">üîç –ê–Ω–∞–ª–∏–∑ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –Ω–æ—Ä–º–∞—Ç–∏–≤–æ–≤</h3>
  
  <!-- –§–∏–ª—å—Ç—Ä—ã -->
  <div style="background: #f8fafc; padding: 16px; border-radius: 12px; margin-bottom: 20px;">
    <!-- –ü–µ—Ä–∏–æ–¥ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö -->
    <div class="filters-mobile" style="display: none;">
      <div class="filters-row">
        <div>
          <label>üìÖ –°:
            <input type="date" id="normativesStartDate" style="font-size: 16px; padding: 12px;">
          </label>
        </div>
        <div>
          <label>–ø–æ:
            <input type="date" id="normativesEndDate" style="font-size: 16px; padding: 12px;">
          </label>
        </div>
      </div>
      
      <div>
        <label>üîç –ü–æ–∏—Å–∫:
          <input type="text" id="normativesSearch" placeholder="–û–ø–µ—Ä–∞—Ü–∏—è –∏–ª–∏ –æ–±—ä–µ–º..." style="font-size: 16px; padding: 12px;">
        </label>
      </div>
      
      <div>
        <label>üìä –§–∏–ª—å—Ç—Ä:
          <select id="normativesFilter" style="font-size: 16px; padding: 12px;">
            <option value="all">–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</option>
            <option value="problematic">–¢–æ–ª—å–∫–æ –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ</option>
            <option value="overstated">–ó–∞–≤—ã—à–µ–Ω–Ω—ã–µ –Ω–æ—Ä–º—ã</option>
            <option value="understated">–ó–∞–Ω–∏–∂–µ–Ω–Ω—ã–µ –Ω–æ—Ä–º—ã</option>
          </select>
        </label>
      </div>
      
      <div style="display: flex; gap: 8px;">
        <button onclick="runNormativesAnalysis()" id="runNormativesBtn" style="background: #f59e0b; flex: 1; padding: 14px; font-size: 16px;">üìä –ê–Ω–∞–ª–∏–∑</button>
        <button onclick="hideNormativesAnalysis()" style="background: #6b7280; flex: 1; padding: 14px; font-size: 16px;">‚ùå –ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
    
    <!-- –ü–µ—Ä–∏–æ–¥ –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ -->
    <div class="filters-desktop">
      <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 16px;">
        <div style="flex: 1; min-width: 200px;">
          <label>üìÖ –ü–µ—Ä–∏–æ–¥ –∞–Ω–∞–ª–∏–∑–∞ —Å:
            <input type="date" id="normativesStartDateDesktop">
          </label>
        </div>
        <div style="flex: 1; min-width: 200px;">
          <label>–ø–æ:
            <input type="date" id="normativesEndDateDesktop">
          </label>
        </div>
      </div>
      
      <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 16px;">
        <div style="flex: 1; min-width: 200px;">
          <label>üîç –ü–æ–∏—Å–∫ –ø–æ –æ–ø–µ—Ä–∞—Ü–∏—è–º:
            <input type="text" id="normativesSearchDesktop" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏...">
          </label>
        </div>
        <div style="flex: 1; min-width: 200px;">
          <label>üìä –¢–∏–ø –ø—Ä–æ–±–ª–µ–º:
            <select id="normativesFilterDesktop">
              <option value="all">–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</option>
              <option value="problematic">–¢–æ–ª—å–∫–æ –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ</option>
              <option value="overstated">–ó–∞–≤—ã—à–µ–Ω–Ω—ã–µ –Ω–æ—Ä–º—ã</option>
              <option value="understated">–ó–∞–Ω–∏–∂–µ–Ω–Ω—ã–µ –Ω–æ—Ä–º—ã</option>
            </select>
          </label>
        </div>
      </div>
      
      <div style="text-align: center;">
        <button onclick="runNormativesAnalysis()" id="runNormativesBtnDesktop" style="background: #f59e0b; margin-right: 10px;">üìä –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑</button>
        <button onclick="hideNormativesAnalysis()" style="background: #6b7280;">‚ùå –ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>
  
  <!-- –°—á–µ—Ç—á–∏–∫–∏ -->
  <div id="normativesSummary" style="display: none; background: #f0f9ff; padding: 16px; border-radius: 12px; margin-bottom: 20px; text-align: center;">
    <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 20px;">
      <div><strong>üìä –í—Å–µ–≥–æ –æ–ø–µ—Ä–∞—Ü–∏–π:</strong> <span id="totalNormatives">0</span></div>
      <div><strong>‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–Ω—ã—Ö:</strong> <span id="problematicNormatives">0</span></div>
      <div><strong>üî¥ –ó–∞–≤—ã—à–µ–Ω–Ω—ã—Ö:</strong> <span id="overstatedNormatives">0</span></div>
      <div><strong>üü¢ –ó–∞–Ω–∏–∂–µ–Ω–Ω—ã—Ö:</strong> <span id="understatedNormatives">0</span></div>
    </div>
  </div>
  
  <!-- –¢–∞–±–ª–∏—Ü–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
  <div id="normativesResults"></div>
  
  <!-- –ó–∞–≥—Ä—É–∑–∫–∞ -->
  <div id="normativesLoader" style="display: none; text-align: center; padding: 40px;">
    <div style="font-size: 24px;">‚è≥</div>
    <div style="margin-top: 10px;">–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–æ—Ä–º–∞—Ç–∏–≤—ã...</div>
  </div>
</div>


<!-- üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ -->
<div id="shiftStatsOutput" style="margin-top:20px;"></div>
<div id="packerAnalysis" style="margin-top:24px;"></div>

  <!-- üö™ –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ -->
  <div style="margin-top: 40px; text-align: center; border-top: 1px solid #e5e7eb; padding-top: 20px;">
    <button onclick="handleLogout()" class="danger" style="background-color: #dc2626; width: auto; padding: 12px 24px;">üö™ –í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã</button>
  </div>
</div>

<!-- üîç –î—É–±–ª–∏–∫–∞—Ç—ã ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π –±–ª–æ–∫ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–∞–º–∏ -->
<div class="container" style="display:none;" id="duplicatesContainer">
  <h2>üîç –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–∞–º–∏</h2>
  <button onclick="switchTab('admin')" style="margin-bottom: 10px; background:#6b7280;">‚Üê –ù–∞–∑–∞–¥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</button>
  
  <!-- –û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞ -->
  <div style="background: #f0f9ff; padding: 16px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #0ea5e9;">
    <h3 style="margin: 0 0 12px 0; color: #0c4a6e;">‚ÑπÔ∏è –û —Å–∏—Å—Ç–µ–º–µ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏</h3>
    <p style="margin: 0; color: #0c4a6e; font-size: 14px;">
      –≠—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª –ø–æ–∑–≤–æ–ª—è–µ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å –∏ —É–¥–∞–ª—è—Ç—å –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è –∑–∞–ø–∏—Å–∏ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö. 
      –î—É–±–ª–∏–∫–∞—Ç—ã –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –ø–æ –∫–ª—é—á–µ–≤—ã–º –ø–æ–ª—è–º: —Å–æ—Ç—Ä—É–¥–Ω–∏–∫, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, –≤—Ä–µ–º—è, –æ–ø–µ—Ä–∞—Ü–∏—è, –∑–∞–∫–∞–∑ –∏ –∞—Ä—Ç–∏–∫—É–ª.
      –£–¥–∞–ª–µ–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –∫–∞—Ä–∞–Ω—Ç–∏–Ω–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.
    </p>
  </div>
  
  <!-- –î–µ–π—Å—Ç–≤–∏—è -->
  <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 24px;">
    <button onclick="analyzeDuplicatesInTab()" id="analyzeDuplicatesTabBtn" style="background:#ff6b35; flex: 1; min-width: 200px;">
      üîç –ê–Ω–∞–ª–∏–∑ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
    </button>
    <button onclick="runDeduplicateInTab()" id="runDeduplicateTabBtn" style="background:#dc2626; flex: 1; min-width: 200px;">
      üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã
    </button>
  </div>
  
  <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ -->
  <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 24px;">
    <button onclick="viewQuarantine()" id="viewQuarantineBtn" style="background:#8b5cf6; flex: 1; min-width: 200px;">
      üì¶ –ü—Ä–æ—Å–º–æ—Ç—Ä –∫–∞—Ä–∞–Ω—Ç–∏–Ω–∞
    </button>
    <button onclick="viewDeduplicationLog()" id="viewLogBtn" style="background:#059669; flex: 1; min-width: 200px;">
      üìã –ñ—É—Ä–Ω–∞–ª –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏
    </button>
  </div>
  
  <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ -->
  <div id="duplicatesAnalysisResults" style="background: #fef2f2; padding: 16px; border-radius: 12px; margin-bottom: 20px; display: none;"></div>
  
  <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —É–¥–∞–ª–µ–Ω–∏—è -->
  <div id="deduplicationResults" style="background: #f0fdf4; padding: 16px; border-radius: 12px; margin-bottom: 20px; display: none;"></div>
  
  <!-- –ü—Ä–æ—Å–º–æ—Ç—Ä –∫–∞—Ä–∞–Ω—Ç–∏–Ω–∞ -->
  <div id="quarantineResults" style="background: #fef3c7; padding: 16px; border-radius: 12px; margin-bottom: 20px; display: none;"></div>
  
  <!-- –ñ—É—Ä–Ω–∞–ª –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ -->
  <div id="logResults" style="background: #f0f9ff; padding: 16px; border-radius: 12px; margin-bottom: 20px; display: none;"></div>
  
  <!-- –ó–∞–≥—Ä—É–∑–∫–∞ -->
  <div id="duplicatesLoader" style="display: none; text-align: center; padding: 40px;">
    <div style="font-size: 24px;">‚è≥</div>
    <div style="margin-top: 10px;">–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∑–∞–ø—Ä–æ—Å...</div>
  </div>
  
  <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
  <div id="duplicatesStats" style="background: #f8fafc; padding: 16px; border-radius: 12px; margin-top: 20px; display: none;">
    <h3 style="margin: 0 0 12px 0; color: #374151;">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
      <div style="text-align: center;">
        <div style="font-size: 24px; font-weight: bold; color: #3b82f6;" id="totalRecords">-</div>
        <div style="font-size: 12px; color: #6b7280;">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</div>
      </div>
      <div style="text-align: center;">
        <div style="font-size: 24px; font-weight: bold; color: #dc2626;" id="duplicatesFound">-</div>
        <div style="font-size: 12px; color: #6b7280;">–ù–∞–π–¥–µ–Ω–æ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤</div>
      </div>
      <div style="text-align: center;">
        <div style="font-size: 24px; font-weight: bold; color: #059669;" id="duplicatesRemoved">-</div>
        <div style="font-size: 12px; color: #6b7280;">–£–¥–∞–ª–µ–Ω–æ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤</div>
      </div>
      <div style="text-align: center;">
        <div style="font-size: 24px; font-weight: bold; color: #7c3aed;" id="quarantineCount">-</div>
        <div style="font-size: 12px; color: #6b7280;">–í –∫–∞—Ä–∞–Ω—Ç–∏–Ω–µ</div>
      </div>
    </div>
  </div>
</div>

<!-- üíµ –ú–æ—è –∑–∞—Ä–ø–ª–∞—Ç–∞ ‚Äî –ø–µ—Ä–µ–º–µ—â—ë–Ω –í–ù–ï adminContainer -->
<div class="container" style="display:none;" id="mySalaryContainer">
  <h2>üíµ –ú–æ—è –∑–∞—Ä–ø–ª–∞—Ç–∞</h2>
  <button id="closeMySalaryBtn" onclick="closeMySalary()" style="margin-bottom: 10px; display: none;">‚ùå –ó–∞–∫—Ä—ã—Ç—å –º–æ–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
  <label>üìÖ –ü–µ—Ä–∏–æ–¥ —Å:
    <input type="date" id="salaryStart">
  </label>
  <label style="margin-left:10px;">–ø–æ:
    <input type="date" id="salaryEnd">
  </label>
  <button id="mySalaryBtn" onclick="loadMySalary()">üìä –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
  <div style="overflow-x: auto;">
  <div id="mySalaryOutput" style="margin-top:20px;"></div>
  </div>
<p id="totalQty" style="text-align:center; font-weight:bold; margin-top:16px;"></p>
</div>
<div class="container" style="display:none;" id="costAnalysisContainer">
  <h2>üìä –ê–Ω–∞–ª–∏–∑ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø–æ –æ–±—ä—ë–º–∞–º</h2>
  <button onclick="switchTab('admin')" style="margin-bottom: 10px; background:#6b7280;">‚Üê –ù–∞–∑–∞–¥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</button>
  
  <div class="form-row">
    <div class="form-item">
      <label>üìÖ –ü–µ—Ä–∏–æ–¥ —Å:
        <input type="date" id="costStartDate">
      </label>
    </div>
    <div class="form-item">
      <label>üìÖ –ø–æ:
        <input type="date" id="costEndDate">
      </label>
    </div>
  </div>

  <div class="form-row">
    <button id="calculateCostBtn" onclick="calculateCostAnalysis()">üßÆ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å - –§–û–¢</button>
    <button id="calculateCostWithMaterialsBtn" onclick="calculateCostAnalysisWithMaterials()">üßÆ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å - –§–û–¢ + –ú–∞—Ç–µ—Ä–∏–∞–ª—ã</button>
  </div>
  
  <div class="form-row" style="margin-top: 12px;">
    <button id="calculateCostForSetsFotBtn" onclick="calculateCostAnalysisForSetsFotOnly()" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); width: 100%;">üì¶ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –Ω–∞–±–æ—Ä–æ–≤ - –§–û–¢</button>
  </div>
  
  <div class="form-row" style="margin-top: 8px;">
    <button id="calculateCostForSetsBtn" onclick="calculateCostAnalysisForSets()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); width: 100%;">üì¶ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –Ω–∞–±–æ—Ä–æ–≤ - –§–û–¢ + –ú–∞—Ç–µ—Ä–∏–∞–ª—ã</button>
  </div>

  <div class="form-row" style="margin-top: 16px;">
    <button onclick="saveReportToServer()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin-bottom: 8px;">üíæ –í—ã–≥—Ä—É–∑–∏—Ç—å –æ—Ç—á–µ—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä</button>
  </div>

  <div id="costResults" style="margin-top: 20px;"></div>
</div>
<script>
  const scriptURL = "https://script.google.com/macros/s/AKfycbwkHl-KhIW-g5llnGjkgG9-uLawsVSsKDC0_1faMwgn8qmrGhLhj8eskmZFqmVMVg/exec";
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º URL –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ

  let todayRecords = [];
  let currentUser = "";
let currentShift = "";
let currentStatus = "";
 let allRates = [];
let allVolumes = []; // ‚Üê –¥–æ–±–∞–≤—å —ç—Ç–æ!
let currentUserRole = "user"; // ‚Üê –¥–æ–±–∞–≤–ª—è–µ–º —Å—é–¥–∞

// –ö—ç—à –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
let dataCache = {
  operations: { data: null, timestamp: 0 },
  volumes: { data: null, timestamp: 0 },
  sets: { data: null, timestamp: 0 },
  setSizes: { data: null, timestamp: 0 }, // ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û: –∫—ç—à –¥–ª—è —Ä–∞–∑–º–µ—Ä–æ–≤ –Ω–∞–±–æ—Ä–æ–≤
  rates: { data: null, timestamp: 0 },
  packingModels: { data: null, timestamp: 0 },
  salaries: {} // –ö—ç—à –æ–∫–ª–∞–¥–æ–≤ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º: { employee: { salary: value, timestamp: timestamp } }
};
const CACHE_DURATION = 5 * 60 * 1000; // 5 –º–∏–Ω—É—Ç

// –§–ª–∞–≥–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
let isLoadingPackingModels = false;

// –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ –∫—ç—à–∞
function clearCache() {
  Object.keys(dataCache).forEach(key => {
    if (key === 'salaries') {
      dataCache[key] = {}; // –î–ª—è salaries –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—É—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç
    } else {
      dataCache[key] = { data: null, timestamp: 0 };
    }
  });
  
  // –û—á–∏—â–∞–µ–º —Ç–∞–∫–∂–µ localStorage –∫—ç—à
  try {
    localStorage.removeItem('packingModelsCache');
    localStorage.removeItem('salariesCache');
  } catch (e) {
    console.warn("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ localStorage –∫—ç—à–∞:", e);
  }
  
  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥–∏ –∑–∞–≥—Ä—É–∑–∫–∏
  isLoadingPackingModels = false;
}

// ===== –£–õ–£–ß–®–ï–ù–ù–ê–Ø –°–ò–°–¢–ï–ú–ê –ó–ê–©–ò–¢–´ –û–¢ –î–£–ë–õ–ò–ö–ê–¢–û–í =====
let duplicateWarnings = {
  exact: [],     // –¢–æ—á–Ω—ã–µ –¥—É–±–ª–∏–∫–∞—Ç—ã
  similar: [],   // –ü–æ—Ö–æ–∂–∏–µ –∑–∞–ø–∏—Å–∏  
  suspicious: [] // –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–ø–∏—Å–∏
};

  // üóëÔ∏è –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è lastFormState —É–¥–∞–ª–µ–Ω–∞ - –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–∞
let formChangeTimeout = null;

// üóëÔ∏è –£–î–ê–õ–ï–ù–ê —Ñ—É–Ω–∫—Ü–∏—è updatePayTypeBasedOnStatus - –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–∞ –ø—Ä–∏ —Ä—É—á–Ω–æ–º –≤–≤–æ–¥–µ

// === –§–£–ù–ö–¶–ò–Ø: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ —Ç–∏–ø–∞–º–∏ –æ–ø–ª–∞—Ç—ã ===
function updatePayTypeOptions(employeeStatus) {
  const payTypeSelect = document.getElementById("profilePayType");
  if (!payTypeSelect) return;
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
  const currentValue = payTypeSelect.value;
  
  // –û—á–∏—â–∞–µ–º –≤—Å–µ –æ–ø—Ü–∏–∏
  payTypeSelect.innerHTML = '';
  
  // –î–æ–±–∞–≤–ª—è–µ–º –±–∞–∑–æ–≤—É—é –æ–ø—Ü–∏—é
  const defaultOption = document.createElement('option');
  defaultOption.value = '';
  defaultOption.textContent = '-- –í—ã–±–µ—Ä–∏—Ç–µ --';
  payTypeSelect.appendChild(defaultOption);
  
  if (employeeStatus === "–ê—É—Ç—Å–æ—Ä—Å–∏–Ω–≥") {
    // –î–ª—è –∞—É—Ç—Å–æ—Ä—Å–∏–Ω–≥–∞ —Ç–æ–ª—å–∫–æ "–°–¥–µ–ª–∫–∞"
    const dealOption = document.createElement('option');
    dealOption.value = '–°–¥–µ–ª–∫–∞';
    dealOption.textContent = '–°–¥–µ–ª–∫–∞';
    payTypeSelect.appendChild(dealOption);
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ–º "–°–¥–µ–ª–∫–∞"
    payTypeSelect.value = '–°–¥–µ–ª–∫–∞';
  } else if (employeeStatus === "–®—Ç–∞—Ç") {
    // –î–ª—è —à—Ç–∞—Ç–∞ –¥–æ—Å—Ç—É–ø–Ω—ã –æ–±–µ –æ–ø—Ü–∏–∏
    const dealOption = document.createElement('option');
    dealOption.value = '–°–¥–µ–ª–∫–∞';
    dealOption.textContent = '–°–¥–µ–ª–∫–∞';
    payTypeSelect.appendChild(dealOption);
    
    const salaryOption = document.createElement('option');
    salaryOption.value = '–û–∫–ª–∞–¥ + —Å–¥–µ–ª–∫–∞';
    salaryOption.textContent = '–û–∫–ª–∞–¥ + —Å–¥–µ–ª–∫–∞';
    payTypeSelect.appendChild(salaryOption);
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ–º "–û–∫–ª–∞–¥ + —Å–¥–µ–ª–∫–∞"
    payTypeSelect.value = '–û–∫–ª–∞–¥ + —Å–¥–µ–ª–∫–∞';
  } else {
    // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –Ω–µ –≤—ã–±—Ä–∞–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –æ–ø—Ü–∏–∏
    const dealOption = document.createElement('option');
    dealOption.value = '–°–¥–µ–ª–∫–∞';
    dealOption.textContent = '–°–¥–µ–ª–∫–∞';
    payTypeSelect.appendChild(dealOption);
    
    const salaryOption = document.createElement('option');
    salaryOption.value = '–û–∫–ª–∞–¥ + —Å–¥–µ–ª–∫–∞';
    salaryOption.textContent = '–û–∫–ª–∞–¥ + —Å–¥–µ–ª–∫–∞';
    payTypeSelect.appendChild(salaryOption);
  }
}

// === –§–£–ù–ö–¶–ò–Ø: –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö ===
function activateSaveButton() {
  
  const saveBtn = document.getElementById("saveProfileBtn");
  if (saveBtn && saveBtn.disabled) {
    saveBtn.disabled = false;
    saveBtn.textContent = "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å";
    saveBtn.style.opacity = "1";
    saveBtn.style.cursor = "pointer";
    saveBtn.classList.add("save-button-pulse"); // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
    
    // –°–∫—Ä—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
    const msg = document.getElementById("profileSaved");
    if (msg) msg.style.display = "none";
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
    const unsavedMsg = document.getElementById("profileUnsaved");
    if (unsavedMsg) unsavedMsg.style.display = "block";
    

    
  } else {

  }
}

// === –§–£–ù–ö–¶–ò–Ø: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª—è –¥–ª—è profilePayType ===
function setupPayTypeListener() {
  const payTypeSelect = document.getElementById("profilePayType");
  if (!payTypeSelect) return;
  
  payTypeSelect.addEventListener("change", async function() {
    
    const salaryBlock = document.getElementById("salaryBlock");
    const salaryInput = document.getElementById("profileSalary");
    
    activateSaveButton();
    
    if (this.value === "–û–∫–ª–∞–¥ + —Å–¥–µ–ª–∫–∞") {
      salaryBlock.style.display = "block";
      
      // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ –∑–∞–ø–æ–ª–Ω—è–µ–º –∏–∑ –∫—ç—à–∞ –µ—Å–ª–∏ –µ—Å—Ç—å
      smartFillSalaryField();
      
      // –ü–æ–¥–≥—Ä—É–∂–∞–µ–º –æ–∫–ª–∞–¥ —Å —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏
      const currentUser = localStorage.getItem("currentUser") || "";
      
      if (!currentUser) {
        salaryInput.value = "";
        return;
      }
      
      try {        
        // üåô –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é —Å —É—á–µ—Ç–æ–º —Ç–∏–ø–∞ —Å–º–µ–Ω—ã
        const shiftType = document.getElementById("shiftType").value;
        if (shiftType) {
          const salary = await fetchSalaryByShift(currentUser, shiftType);
          salaryInput.value = salary || "";
        } else {
          // Fallback –∫ —Å—Ç–∞—Ä–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –µ—Å–ª–∏ —Å–º–µ–Ω–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞
          const salary = await getSalaryWithCache(currentUser);
          salaryInput.value = salary || "";
        }
      } catch (err) {
        salaryInput.value = "";
      }
          } else {
        salaryBlock.style.display = "none";
        salaryInput.value = "";
      }
  });
}

// === –õ–û–ì–ò–ö–ê: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–ª—É—à–∞—Ç–µ–ª—è –¥–ª—è profilePayType ===
setupPayTypeListener();

// === –õ–û–ì–ò–ö–ê: –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –º–æ–¥–µ–ª–∏ —É–ø–∞–∫–æ–≤–∫–∏ ===
document.getElementById("profilePackingModel").addEventListener("change", function() {
  activateSaveButton();
  
  // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞ (—Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞)
  updateRateDisplay();
});

// === –õ–û–ì–ò–ö–ê: –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–º–µ–Ω—ã ===
document.getElementById("shiftType").addEventListener("change", function() {
  const nightShiftBlock = document.getElementById("nightShiftDateBlock");
  const nightShiftInput = document.getElementById("nightShiftDate");
  
  if (this.value === "–ù–æ—á—å") {
    nightShiftBlock.style.display = "block";
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –≤—á–µ—Ä–∞—à–Ω–∏–π –¥–µ–Ω—å –µ—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ
    if (!nightShiftInput.value) {
      const yesterday = new Date();
      yesterday.setDate(yesterday.getDate() - 1);
      nightShiftInput.value = yesterday.toISOString().split('T')[0];
    }
  } else {
    nightShiftBlock.style.display = "none";
    nightShiftInput.value = "";
  }
  
  // üåô –û–±–Ω–æ–≤–ª—è–µ–º –æ–∫–ª–∞–¥ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–∏–ø–∞ —Å–º–µ–Ω—ã
  updateSalaryForShift(this.value);
  
  activateSaveButton();
});

// === –õ–û–ì–ò–ö–ê: –ö–Ω–æ–ø–∫–∏ –±—ã—Å—Ç—Ä–æ–≥–æ –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã ===
document.getElementById("setYesterday").addEventListener("click", function() {
  const yesterday = new Date();
  yesterday.setDate(yesterday.getDate() - 1);
  document.getElementById("nightShiftDate").value = yesterday.toISOString().split('T')[0];
  activateSaveButton();
});

document.getElementById("setToday").addEventListener("click", function() {
  const today = new Date();
  document.getElementById("nightShiftDate").value = today.toISOString().split('T')[0];
  activateSaveButton();
});

// === –õ–û–ì–ò–ö–ê: –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞—Ç—ã –Ω–æ—á–Ω–æ–π —Å–º–µ–Ω—ã ===
document.getElementById("nightShiftDate").addEventListener("change", function() {
  activateSaveButton();
});

// === –õ–û–ì–ò–ö–ê: –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ ===
document.getElementById("employeeStatus").addEventListener("change", function() {
  activateSaveButton();
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –æ–ø—Ü–∏–∏ —Ç–∏–ø–∞ –æ–ø–ª–∞—Ç—ã
  updatePayTypeOptions(this.value);
  
  // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –±–ª–æ–∫ –æ–∫–ª–∞–¥–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ –æ–ø–ª–∞—Ç—ã
  if (this.value === "–ê—É—Ç—Å–æ—Ä—Å–∏–Ω–≥") {
    // –°–∫—Ä—ã–≤–∞–µ–º –±–ª–æ–∫ –æ–∫–ª–∞–¥–∞ –¥–ª—è –∞—É—Ç—Å–æ—Ä—Å–∏–Ω–≥–∞
    document.getElementById("salaryBlock").style.display = "none";
    document.getElementById("profileSalary").value = "";
  } else if (this.value === "–®—Ç–∞—Ç") {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫ –æ–∫–ª–∞–¥–∞ –¥–ª—è —à—Ç–∞—Ç–Ω—ã—Ö –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –æ–∫–ª–∞–¥
    document.getElementById("salaryBlock").style.display = "block";
    
    // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ –∑–∞–ø–æ–ª–Ω—è–µ–º –∏–∑ –∫—ç—à–∞ –µ—Å–ª–∏ –µ—Å—Ç—å
    smartFillSalaryField();
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –æ–∫–ª–∞–¥ —Å —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ —Å —É—á–µ—Ç–æ–º —Å–º–µ–Ω—ã
    const currentUser = localStorage.getItem("currentUser") || "";
    if (currentUser) {
      // üåô –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é —Å —É—á–µ—Ç–æ–º —Ç–∏–ø–∞ —Å–º–µ–Ω—ã
      const shiftType = document.getElementById("shiftType").value;
      if (shiftType) {
        fetchSalaryByShift(currentUser, shiftType)
          .then(salary => {
            document.getElementById("profileSalary").value = salary || "";
          })
          .catch(() => {
            document.getElementById("profileSalary").value = "";
          });
      } else {
        // Fallback –∫ —Å—Ç–∞—Ä–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –µ—Å–ª–∏ —Å–º–µ–Ω–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞
        getSalaryWithCache(currentUser)
          .then(salary => {
            document.getElementById("profileSalary").value = salary || "";
          })
          .catch(() => {
            document.getElementById("profileSalary").value = "";
          });
      }
    }
  }
  
  // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –µ—â–µ —Ä–∞–∑, —Ç–∞–∫ –∫–∞–∫ –∏–∑–º–µ–Ω–∏–ª—Å—è —Ç–∏–ø –æ–ø–ª–∞—Ç—ã
  activateSaveButton();
  
  // –£–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –≤–∫–ª–∞–¥–∫–∏ "–ú–æ—è –∑–∞—Ä–ø–ª–∞—Ç–∞"
  const tabMySalary = document.getElementById("tabMySalary");
  if (tabMySalary) {
    tabMySalary.style.display = (this.value === "–ê—É—Ç—Å–æ—Ä—Å–∏–Ω–≥") ? "none" : "inline-block";
  }
});



function isProfileComplete() {
  const packingModel = document.getElementById("profilePackingModel").value;
  const payType = document.getElementById("profilePayType").value;
  
  // ‚úÖ –ü–û–õ–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê: –≤–∫–ª—é—á–∞—è –æ–∫–ª–∞–¥ –¥–ª—è —Ç–∏–ø–∞ "–û–∫–ª–∞–¥ + —Å–¥–µ–ª–∫–∞"
  let isComplete = currentShift && currentStatus && packingModel && payType;
  
  if (payType === "–û–∫–ª–∞–¥ + —Å–¥–µ–ª–∫–∞") {
    const salary = document.getElementById("profileSalary").value;
    isComplete = isComplete && salary && salary.trim() !== "";
  }
  
  return isComplete;
}

// üóëÔ∏è –£–î–ê–õ–ï–ù–ê —Ñ—É–Ω–∫—Ü–∏—è restoreProfile - –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–∞ –ø—Ä–∏ —Ä—É—á–Ω–æ–º –≤–≤–æ–¥–µ

function requireProfile() {
  if (!isProfileComplete()) {
    alert("‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª");
    switchTab("profile");
    return false;
  }
  return true;
}

// === üë®‚Äçüè´ –§–£–ù–ö–¶–ò–ò –ù–ê–°–¢–ê–í–ù–ò–ß–ï–°–¢–í–ê ===

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞  
function handleStatusChange() {
  const status = document.getElementById("employeeStatus").value;
  const mentorBlock = document.getElementById("mentorBlock");
  const traineeBlock = document.getElementById("traineeBlock");
  
  // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –±–ª–æ–∫–∏
  mentorBlock.style.display = "none";
  traineeBlock.style.display = "none";
  
  if (status === "–®—Ç–∞—Ç") {
    mentorBlock.style.display = "block";
    loadCurrentTraineeInfo(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º —Å—Ç–∞–∂–µ—Ä–µ
  } else if (status === "–°—Ç–∞–∂–µ—Ä") {
    traineeBlock.style.display = "block";
    loadCurrentMentorInfo(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–µ
  } else if (status === "–ê—É—Ç—Å–æ—Ä—Å–∏–Ω–≥") {
    // üåô –î–ª—è –∞—É—Ç—Å–æ—Ä—Å–µ—Ä–æ–≤ –∑–∞–ø—É—Å–∫–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É –ø—Ä–æ—Ñ–∏–ª—è
    // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ —Ä—É—á–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ, –∞ –Ω–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏ –≤—Ö–æ–¥–µ
    if (currentStatus !== "–ê—É—Ç—Å–æ—Ä—Å–∏–Ω–≥") {
      setupOutsourcingProfile();
    }
  } else {
    // üåô –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –¥—Ä—É–≥–æ–π —Å—Ç–∞—Ç—É—Å, –æ—á–∏—â–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞—É—Ç—Å–æ—Ä—Å–µ—Ä–∞
    clearOutsourcingSettings();
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–µ–∫—É—â–µ–º —Å—Ç–∞–∂–µ—Ä–µ –¥–ª—è –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–æ–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è)
async function loadCurrentTraineeInfo() {
  try {
    const currentUser = localStorage.getItem("currentUser");
    if (!currentUser) return;
    
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const userData = await getUserDataFromServer(currentUser);
    
    const traineeDisplay = document.getElementById("profileTraineeDisplay");
    const traineeBonusDisplay = document.getElementById("profileTraineeBonusDisplay");
    
    if (!traineeDisplay || !traineeBonusDisplay) return;
    
    if (userData && userData.mentor) {
      // –ï—Å–ª–∏ —É –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–∞ –µ—Å—Ç—å —Å—Ç–∞–∂–µ—Ä, –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
      traineeDisplay.textContent = userData.mentor;
      if (userData.bonusPercent) {
        traineeBonusDisplay.textContent = `(${userData.bonusPercent}% –±–æ–Ω—É—Å)`;
      } else {
        traineeBonusDisplay.textContent = "";
      }
    } else {
      // –ï—Å–ª–∏ —Å—Ç–∞–∂–µ—Ä–∞ –Ω–µ—Ç
      traineeDisplay.textContent = "–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω";
      traineeBonusDisplay.textContent = "";
    }
    
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å—Ç–∞–∂–µ—Ä–µ:", error);
    const traineeDisplay = document.getElementById("profileTraineeDisplay");
    if (traineeDisplay) {
      traineeDisplay.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏";
    }
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–µ–∫—É—â–µ–º –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–µ –¥–ª—è —Å—Ç–∞–∂–µ—Ä–æ–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è)
async function loadCurrentMentorInfo() {
  try {
    const currentUser = localStorage.getItem("currentUser");
    if (!currentUser) return;
    
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const userData = await getUserDataFromServer(currentUser);
    
    const mentorDisplay = document.getElementById("profileMentorDisplay");
    
    if (!mentorDisplay) return;
    
    if (userData && userData.mentor) {
      // –ï—Å–ª–∏ —É —Å—Ç–∞–∂–µ—Ä–∞ –µ—Å—Ç—å –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫, –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
      mentorDisplay.textContent = userData.mentor;
    } else {
      // –ï—Å–ª–∏ –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–∞ –Ω–µ—Ç
      mentorDisplay.textContent = "–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω";
    }
    
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–µ:", error);
    const mentorDisplay = document.getElementById("profileMentorDisplay");
    if (mentorDisplay) {
      mentorDisplay.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏";
    }
  }
}

// –§—É–Ω–∫—Ü–∏—è savePairToServer —É–¥–∞–ª–µ–Ω–∞ - —Å–≤—è–∑–∏ –±–æ–ª—å—à–µ –Ω–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ –ø—Ä–æ—Ñ–∏–ª—å
// –í—Å–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–≤—è–∑—è–º–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ –±–ª–æ–∫ "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞–∂–µ—Ä–∞–º–∏"

// –ö—ç—à –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
let userDataCache = null;
let userDataCacheTimestamp = 0;
const USER_DATA_CACHE_DURATION = 30 * 1000; // 30 —Å–µ–∫—É–Ω–¥

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è —Å —Å–µ—Ä–≤–µ—Ä–∞ (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
async function updateProfileFromServer() {
  const currentUser = localStorage.getItem("currentUser");
  if (!currentUser) return;
  
  try {
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º)
    const userData = await getUserDataFromServer(currentUser);
    
    if (userData) {
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
      const statusSelect = document.getElementById("employeeStatus");
      if (statusSelect && userData.status) {
        statusSelect.value = userData.status;
        
        // –í—ã–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–ª–æ–∫–æ–≤
        handleStatusChange();
        
        // üåô –ü—Ä–æ–≤–µ—Ä—è–µ–º —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞—É—Ç—Å–æ—Ä—Å–µ—Ä–æ–º
        if (userData.status === "–ê—É—Ç—Å–æ—Ä—Å–∏–Ω–≥") {
          setupOutsourcingProfile();
        } else {
          clearOutsourcingSettings(); // –û—á–∏—â–∞–µ–º –µ—Å–ª–∏ –±–æ–ª—å—à–µ –Ω–µ –∞—É—Ç—Å–æ—Ä—Å–µ—Ä
        }
        
        // –ë—ã—Å—Ç—Ä–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–≤—è–∑–µ–π –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
        await updateProfileConnectionsDisplay(userData);
      }
      
      console.log("‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω —Å —Å–µ—Ä–≤–µ—Ä–∞");
    } else {
      // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω, –æ—á–∏—â–∞–µ–º –≤—Å–µ —Å–≤—è–∑–∏
      clearProfileConnections();
    }
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è —Å —Å–µ—Ä–≤–µ—Ä–∞:", error);
  }
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
async function getUserDataFromServer(currentUser) {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
  if (userDataCache && (Date.now() - userDataCacheTimestamp) < USER_DATA_CACHE_DURATION) {
    return userDataCache.find(emp => emp.name === currentUser);
  }
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ
  const response = await fetch(`${scriptURL}?type=employees`);
  const data = await response.json();
  
  if (data.employees) {
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à
    userDataCache = data.employees;
    userDataCacheTimestamp = Date.now();
    
    return data.employees.find(emp => emp.name === currentUser);
  }
  
  return null;
}

// –ë—ã—Å—Ç—Ä–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–≤—è–∑–µ–π —Å –Ω–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
async function updateProfileConnectionsDisplay(userData) {
  if (!userData) return;
  
  if (userData.status === "–®—Ç–∞—Ç") {
    updateTraineeDisplay(userData.mentor, userData.bonusPercent);
  } else if (userData.status === "–°—Ç–∞–∂–µ—Ä") {
            updateMentorDisplay(userData.mentor);
  }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞–∂–µ—Ä–∞
function updateTraineeDisplay(traineeName, bonusPercent) {
  const traineeDisplay = document.getElementById("profileTraineeDisplay");
  const traineeBonusDisplay = document.getElementById("profileTraineeBonusDisplay");
  
  if (!traineeDisplay || !traineeBonusDisplay) return;
  
  if (traineeName) {
    traineeDisplay.textContent = traineeName;
    if (bonusPercent) {
      traineeBonusDisplay.textContent = `(${bonusPercent}% –±–æ–Ω—É—Å)`;
    } else {
      traineeBonusDisplay.textContent = "";
    }
  } else {
    traineeDisplay.textContent = "–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω";
    traineeBonusDisplay.textContent = "";
  }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–∞
function updateMentorDisplay(mentorName) {
  const mentorDisplay = document.getElementById("profileMentorDisplay");
  
  if (!mentorDisplay) return;
  
  if (mentorName) {
    mentorDisplay.textContent = mentorName;
  } else {
    mentorDisplay.textContent = "–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω";
  }
}

// –ö—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∏
let traineesCache = null;
let mentorsCache = null;
let traineesCacheTimestamp = 0;
let mentorsCacheTimestamp = 0;
const LIST_CACHE_DURATION = 60 * 1000; // 1 –º–∏–Ω—É—Ç–∞

// üåô –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è
function loadSavedProfile() {
  const savedShift = localStorage.getItem("profileShiftType");
  const savedNightDate = localStorage.getItem("profileNightShiftDate");
  
  if (savedShift) {
    document.getElementById("shiftType").value = savedShift;
    
    if (savedShift === "–ù–æ—á—å") {
      document.getElementById("nightShiftDateBlock").style.display = "block";
      if (savedNightDate) {
        document.getElementById("nightShiftDate").value = savedNightDate;
      } else {
        // –ï—Å–ª–∏ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π –¥–∞—Ç—ã, –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –≤—á–µ—Ä–∞—à–Ω–∏–π –¥–µ–Ω—å
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        document.getElementById("nightShiftDate").value = yesterday.toISOString().split('T')[0];
      }
    }
  }
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Å—Ç–∞–∂–µ—Ä–æ–≤ —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
async function getTraineesListCached() {
  if (traineesCache && (Date.now() - traineesCacheTimestamp) < LIST_CACHE_DURATION) {
    return traineesCache;
  }
  
  try {
    const response = await fetch(`${scriptURL}?type=getTrainees`);
    const data = await response.json();
    
    traineesCache = data.trainees || [];
    traineesCacheTimestamp = Date.now();
    
    return traineesCache;
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞–∂–µ—Ä–æ–≤:", error);
    return [];
  }
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–æ–≤ —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
async function getMentorsListCached() {
  if (mentorsCache && (Date.now() - mentorsCacheTimestamp) < LIST_CACHE_DURATION) {
    return mentorsCache;
  }
  
  try {
    const response = await fetch(`${scriptURL}?type=getMentors`);
    const data = await response.json();
    
    mentorsCache = data.mentors || [];
    mentorsCacheTimestamp = Date.now();
    
    return mentorsCache;
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–æ–≤:", error);
    return [];
  }
}

// –û—á–∏—Å—Ç–∫–∞ —Å–≤—è–∑–µ–π –ø—Ä–æ—Ñ–∏–ª—è
function clearProfileConnections() {
  // –û—á–∏—â–∞–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–≤—è–∑–µ–π
  const traineeDisplay = document.getElementById("profileTraineeDisplay");
  const traineeBonusDisplay = document.getElementById("profileTraineeBonusDisplay");
  const mentorDisplay = document.getElementById("profileMentorDisplay");
  
  if (traineeDisplay) traineeDisplay.textContent = "–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω";
  if (traineeBonusDisplay) traineeBonusDisplay.textContent = "";
  if (mentorDisplay) mentorDisplay.textContent = "–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω";
}


async function saveProfile() {
  const shiftSelect = document.getElementById("shiftType");
  const statusSelect = document.getElementById("employeeStatus");
  const packingModelSelect = document.getElementById("profilePackingModel");
  const payTypeSelect = document.getElementById("profilePayType");
  const salaryInput = document.getElementById("profileSalary");

  const shiftValue = shiftSelect.value;
  const statusValue = statusSelect.value;
  const packingModel = packingModelSelect.value;
  const payType = payTypeSelect.value;

  // ‚úÖ –í–ê–õ–ò–î–ê–¶–ò–Ø: –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã
  const missingFields = [];
  if (!shiftValue) missingFields.push("–¢–∏–ø —Å–º–µ–Ω—ã");
  if (!statusValue) missingFields.push("–°—Ç–∞—Ç—É—Å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞");
  if (!packingModel) missingFields.push("–ú–æ–¥–µ–ª—å —É–ø–∞–∫–æ–≤–∫–∏");
  if (!payType) missingFields.push("–¢–∏–ø –æ–ø–ª–∞—Ç—ã");

  if (missingFields.length > 0) {
    const fieldsList = missingFields.join(", ");
    alert(`‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è:\n\n${fieldsList}`);
    return;
  }

  localStorage.setItem("profileShiftType", shiftValue);
  localStorage.setItem("profileStatus", statusValue);
  localStorage.setItem("profilePackingModel", packingModel);
  localStorage.setItem("profilePayType", payType);

  // üåô –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞—Ç—ã –Ω–æ—á–Ω–æ–π —Å–º–µ–Ω—ã
  const nightShiftDate = document.getElementById("nightShiftDate").value;
  if (shiftValue === "–ù–æ—á—å") {
    if (!nightShiftDate) {
      alert("‚ùå –î–ª—è –Ω–æ—á–Ω–æ–π —Å–º–µ–Ω—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –¥–∞—Ç—É —Å–º–µ–Ω—ã!");
      return;
    }
    localStorage.setItem("profileNightShiftDate", nightShiftDate);
  } else {
    localStorage.removeItem("profileNightShiftDate");
  }

  // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω "–û–∫–ª–∞–¥ + —Å–¥–µ–ª–∫–∞", –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –æ–∫–ª–∞–¥ —Å —Å–µ—Ä–≤–µ—Ä–∞ —Å —É—á–µ—Ç–æ–º —Å–º–µ–Ω—ã
  let salary = "";
  if (payType === "–û–∫–ª–∞–¥ + —Å–¥–µ–ª–∫–∞") {
    try {
      const currentUser = localStorage.getItem("currentUser") || "";
      // üåô –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é —Å —É—á–µ—Ç–æ–º —Ç–∏–ø–∞ —Å–º–µ–Ω—ã
      salary = await fetchSalaryByShift(currentUser, shiftValue) || "";
    } catch (err) {
      salary = "";
    }
    salaryInput.value = salary;
    
    if (!salary || salary.trim() === "") {
      alert(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–∫–ª–∞–¥ —Å —Å–µ—Ä–≤–µ—Ä–∞!\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:\n‚Ä¢ –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n‚Ä¢ –ù–∞–ª–∏—á–∏–µ –æ–∫–ª–∞–¥–∞ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å–º–µ–Ω—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö\n‚Ä¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É`);
      return;
    }
    
    localStorage.setItem("profileSalary", salary);
    document.getElementById("salaryBlock").style.display = "block";
  } else {
    salaryInput.value = "";
    localStorage.removeItem("profileSalary");
    document.getElementById("salaryBlock").style.display = "none";
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç–∏ –ø—Ä–æ—Ñ–∏–ª—è (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
  if (currentUserRole !== "admin") {
    let isFilled = shiftValue && statusValue && packingModel && payType;
    if (payType === "–û–∫–ª–∞–¥ + —Å–¥–µ–ª–∫–∞") {
      const currentSalary = salaryInput.value;
      isFilled = isFilled && currentSalary && currentSalary.trim() !== "";
    }
    const hint = document.getElementById("profileHint");
    const msg = document.getElementById("profileSaved");
    const tabApp = document.getElementById("tabApp");
    const tabMySalary = document.getElementById("tabMySalary");
    const saveBtn = document.getElementById("saveProfileBtn");

    hint.style.display = isFilled ? "none" : "block";
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å –∑–∞–ø–æ–ª–Ω–µ–Ω
    if (isFilled) {
      msg.style.display = "block";
      msg.textContent = "‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω! –î–æ—Å—Ç—É–ø –∫ –≤–∫–ª–∞–¥–∫–∞–º –æ—Ç–∫—Ä—ã—Ç.";
      // –ê–≤—Ç–æ—Å–∫—Ä—ã—Ç–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
      setTimeout(() => msg.style.display = "none", 3000);

      // –°–≤—è–∑–∏ –Ω–∞—Å—Ç–∞–≤–Ω–∏—á–µ—Å—Ç–≤–∞ –±–æ–ª—å—à–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è —á–µ—Ä–µ–∑ –ø—Ä–æ—Ñ–∏–ª—å
      // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–≤—è–∑—è–º–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ –±–ª–æ–∫ "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞–∂–µ—Ä–∞–º–∏"
      
      // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
      const unsavedMsg = document.getElementById("profileUnsaved");
      if (unsavedMsg) unsavedMsg.style.display = "none";
      
      if (saveBtn) {
        saveBtn.disabled = true;
        saveBtn.textContent = "‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω";
        saveBtn.style.opacity = "0.6";
        saveBtn.style.cursor = "not-allowed";
        saveBtn.classList.remove("save-button-pulse");
      }
        } else {
      msg.style.display = "none";
      
      if (saveBtn) {
        saveBtn.disabled = false;
        saveBtn.textContent = "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å";
        saveBtn.style.opacity = "1";
        saveBtn.style.cursor = "pointer";
      }
    }
    
    tabApp.disabled = !isFilled;
    tabApp.innerHTML = isFilled ? "üìã" : "üîí";

    // –°–∫—Ä—ã–≤–∞–µ–º –≤–∫–ª–∞–¥–∫—É "–ú–æ—è –∑–∞—Ä–ø–ª–∞—Ç–∞", –µ—Å–ª–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –∞—É—Ç—Å–æ—Ä—Å
    if (tabMySalary) {
      tabMySalary.style.display = (statusValue === "–ê—É—Ç—Å–æ—Ä—Å–∏–Ω–≥") ? "none" : "inline-block";
    }
  }

  // –û–±–Ω–æ–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è
  currentShift = shiftValue;
  currentStatus = statusValue;
}



function switchTab(tabName) {
  // –î–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: —Ä–∞–∑—Ä–µ—à–∞–µ–º –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å, –∞–Ω–∞–ª–∏–∑ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞–∂–µ—Ä–∞–º–∏ –∏ –¥—É–±–ª–∏–∫–∞—Ç—ã
  if (currentUserRole === "admin" && tabName !== "admin" && tabName !== "costAnalysis" && tabName !== "traineeManagement" && tabName !== "duplicates") {
    return; // –ù–µ –ø–æ–∑–≤–æ–ª—è–µ–º –∞–¥–º–∏–Ω—É –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –Ω–∞ –¥—Ä—É–≥–∏–µ –≤–∫–ª–∞–¥–∫–∏
  }
  
  // üîê –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω-—Ñ—É–Ω–∫—Ü–∏—è–º –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  if (currentUserRole !== "admin" && (tabName === "admin" || tabName === "costAnalysis" || tabName === "traineeManagement" || tabName === "duplicates")) {
    console.log("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω: —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞");
    return;
  }
  
  // üîê –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞, –µ—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
  if (currentUserRole !== "admin" && tabName !== "profile" && !requireProfile()) return;

  // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
  document.getElementById("profileContainer").style.display = "none";
  document.getElementById("appContainer").style.display = "none";
  document.getElementById("statsContainer").style.display = "none";
  document.getElementById("adminContainer").style.display = "none";
  document.getElementById("mySalaryContainer").style.display = "none";
  document.getElementById("ratesContainer").style.display = "none";
  document.getElementById("costAnalysisContainer").style.display = "none";
  document.getElementById("traineeManagementContainer").style.display = "none";
  document.getElementById("duplicatesContainer").style.display = "none";

  // –£–¥–∞–ª—è–µ–º fullscreen –æ—Ç appContainer, –µ—Å–ª–∏ –±—ã–ª —Ä–∞–Ω–µ–µ
  document.getElementById("appContainer").classList.remove("fullscreen");

  // –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
  const tabButtons = ["tabProfile", "tabApp", "tabStats", "tabCostAnalysis", "tabTraineeManagement", "tabRates", "tabMySalary", "tabDuplicates", "tabAdmin"];
  tabButtons.forEach(id => {
    const btn = document.getElementById(id);
    if (btn) btn.disabled = false;
  });

  // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –Ω—É–∂–Ω—É—é –≤–∫–ª–∞–¥–∫—É
  switch (tabName) {
    case "profile":
      document.getElementById("profileContainer").style.display = "block";
      document.getElementById("tabProfile").disabled = true;
      break;

    case "app":
      document.getElementById("appContainer").style.display = "block";
      document.getElementById("tabApp").disabled = true;
      break;

    case "stats":
      document.getElementById("statsContainer").style.display = "block";
      document.getElementById("tabStats").disabled = true;
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–±–µ–∑ –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∏)
      const statsDate = document.getElementById("statsDate");
      if (!statsDate.value) {
        const today = new Date().toISOString().split('T')[0];
        statsDate.value = today;
      }
      break;

    case "costAnalysis":
      document.getElementById("costAnalysisContainer").style.display = "block";
      document.getElementById("tabCostAnalysis").disabled = true;
      initializeCostAnalysis();
      break;

    case "traineeManagement":
      showTraineeManagement();
      document.getElementById("tabTraineeManagement").disabled = true;
      break;

    case "rates":
      document.getElementById("ratesContainer").style.display = "block";
      document.getElementById("tabRates").disabled = true;
      break;

    case "mySalary":
      document.getElementById("mySalaryContainer").style.display = "block";
      document.getElementById("tabMySalary").disabled = true;
      break;

    case "admin":
      document.getElementById("adminContainer").style.display = "block";
      document.getElementById("tabAdmin").disabled = true;
      break;

    case "duplicates":
      document.getElementById("duplicatesContainer").style.display = "block";
      document.getElementById("tabDuplicates").disabled = true;
      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏
      loadDuplicatesStats();
      break;
  }
}





async function handleLogin() {


  const login = document.getElementById("login").value.trim();
  const password = document.getElementById("password").value.trim();
  const errorElem = document.getElementById("loginError");
  const loginBtn = document.getElementById("loginBtn");
  
  // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
  loginBtn.disabled = true;
  loginBtn.classList.add("loading");
  loginBtn.textContent = "‚è≥ –í—Ö–æ–∂—É...";
  errorElem.textContent = "";

  try {
    const res = await fetch(`${scriptURL}?type=auth&login=${encodeURIComponent(login)}&password=${encodeURIComponent(password)}`);
    const data = await res.json();

    if (data.status === "ok") {
      currentUser = login;
      currentUserRole = data.role || 'user';
      currentStatus = data.employeeStatus || '–®—Ç–∞—Ç'; // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—É—Å —Å —Å–µ—Ä–≤–µ—Ä–∞

      localStorage.setItem("currentUser", login);
      localStorage.setItem("currentUserRole", currentUserRole);
      
      // üåô –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è –¥–ª—è –∞—É—Ç—Å–æ—Ä—Å–µ—Ä–æ–≤
      if (currentStatus === "–ê—É—Ç—Å–æ—Ä—Å–∏–Ω–≥") {
        setupOutsourcingProfile();
      }
      
              // üóëÔ∏è –£–î–ê–õ–ï–ù–û —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞ - —Ç–æ–ª—å–∫–æ —Ä—É—á–Ω–æ–π –≤–≤–æ–¥

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–¥–º–∏–Ω-–≤–∫–ª–∞–¥–∫—É –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ (–±—É–¥–µ—Ç —Ç–æ—á–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –Ω–∏–∂–µ)
      const tabAdmin = document.getElementById("tabAdmin");
      // –í—Ä–µ–º–µ–Ω–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ä—É—é –ª–æ–≥–∏–∫—É, –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç –Ω–∏–∂–µ

      // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: –ü–ï–†–ï–î –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–æ–π
      document.getElementById("loginContainer").style.display = "none";
      document.getElementById("tabContainer").style.display = "block";
      document.querySelector('[name="employeeName"]').value = currentUser;
      
      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å —Å —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ
      setTimeout(() => {
        updateProfileFromServer();
      }, 1000); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
      
      // –î–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: —Å–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏ –∫—Ä–æ–º–µ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ –∏ –∞–Ω–∞–ª–∏–∑–∞ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏
      if (currentUserRole === "admin") {
        // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –∫—Ä–æ–º–µ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ –∏ –∞–Ω–∞–ª–∏–∑–∞ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏
        const tabButtons = ["tabProfile", "tabApp", "tabStats", "tabRates", "tabMySalary"];
        tabButtons.forEach(id => {
          const btn = document.getElementById(id);
          if (btn) {
            btn.classList.add("admin-hidden");
            btn.classList.remove("admin-visible");
          }
        });
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∞–Ω–∞–ª–∏–∑–∞ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
        const tabCostAnalysis = document.getElementById("tabCostAnalysis");
        if (tabCostAnalysis) {
          tabCostAnalysis.classList.add("admin-visible");
          tabCostAnalysis.classList.remove("admin-hidden");
          // üõ°Ô∏è –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –ó–ê–©–ò–¢–ê: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º style.display
          tabCostAnalysis.style.display = "";
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç–∞–∂–µ—Ä–∞–º–∏ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
        const tabTraineeManagement = document.getElementById("tabTraineeManagement");
        if (tabTraineeManagement) {
          tabTraineeManagement.classList.add("admin-visible");
          tabTraineeManagement.classList.remove("admin-hidden");
          // üõ°Ô∏è –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –ó–ê–©–ò–¢–ê: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º style.display
          tabTraineeManagement.style.display = "";
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
        const tabDuplicates = document.getElementById("tabDuplicates");
        if (tabDuplicates) {
          tabDuplicates.classList.add("admin-visible");
          tabDuplicates.classList.remove("admin-hidden");
          // üõ°Ô∏è –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –ó–ê–©–ò–¢–ê: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º style.display
          tabDuplicates.style.display = "";
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–¥–º–∏–Ω-–∫–Ω–æ–ø–∫—É
        const tabAdmin = document.getElementById("tabAdmin");
        if (tabAdmin) {
          tabAdmin.classList.add("admin-visible");
          tabAdmin.classList.remove("admin-hidden");
          // üõ°Ô∏è –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –ó–ê–©–ò–¢–ê: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º style.display
          tabAdmin.style.display = "";
        }
        
        document.getElementById("bottomNav").style.display = "flex";
        switchTab("admin"); // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Ä–∞–∑—É –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
      } else {
        // –î–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π - –æ–±—ã—á–Ω–∞—è –ª–æ–≥–∏–∫–∞
        document.getElementById("bottomNav").style.display = "flex";
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –æ–±—ã—á–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫
        const normalTabButtons = ["tabProfile", "tabApp", "tabStats", "tabRates", "tabMySalary"];
        normalTabButtons.forEach(id => {
          const btn = document.getElementById(id);
          if (btn) {
            btn.classList.remove("admin-hidden");
            btn.classList.remove("admin-visible");
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Å—Ç–∏–ª–∏
            btn.style.display = "";
            btn.style.visibility = "";
            btn.style.width = "";
            btn.style.padding = "";
            btn.style.margin = "";
          }
        });
        
        // üîê –°–∫—Ä—ã–≤–∞–µ–º –∞–¥–º–∏–Ω-–≤–∫–ª–∞–¥–∫–∏ –æ—Ç –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        const adminTabButtons = ["tabCostAnalysis", "tabTraineeManagement", "tabDuplicates", "tabAdmin"];
        adminTabButtons.forEach(id => {
          const btn = document.getElementById(id);
          if (btn) {
            btn.classList.add("admin-hidden");
            btn.classList.remove("admin-visible");
            // üõ°Ô∏è –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –ó–ê–©–ò–¢–ê: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ style
            btn.style.display = "none";
          }
        });
        
        // üõ†Ô∏è –û–ß–ò–°–¢–ö–ê –≤—Å–µ—Ö –ø–æ–ª–µ–π –ø—Ä–æ—Ñ–∏–ª—è –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞
        document.getElementById("shiftType").value = "";
        document.getElementById("employeeStatus").value = "";
        document.getElementById("profilePackingModel").value = "";
        document.getElementById("profilePayType").value = "";
        document.getElementById("profileSalary").value = "";
        document.getElementById("nightShiftDate").value = "";
        document.getElementById("nightShiftDateBlock").style.display = "none";
        document.getElementById("salaryBlock").style.display = "none";
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –æ–ø—Ü–∏–∏ —Ç–∏–ø–∞ –æ–ø–ª–∞—Ç—ã
        updatePayTypeOptions("");
        
        // üöÄ –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∂–∞–µ–º –æ–∫–ª–∞–¥ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        preloadCurrentUserSalary();
        
        // üõ†Ô∏è –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
        const saveBtn = document.getElementById("saveProfileBtn");
        const hint = document.getElementById("profileHint");
        const msg = document.getElementById("profileSaved");
        const unsavedMsg = document.getElementById("profileUnsaved");
        
        if (saveBtn) {
          saveBtn.disabled = false;
          saveBtn.textContent = "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å";
          saveBtn.style.opacity = "1";
          saveBtn.style.cursor = "pointer";
          saveBtn.classList.remove("save-button-pulse");
        }
        if (hint) hint.style.display = "block";
        if (msg) msg.style.display = "none";
        if (unsavedMsg) unsavedMsg.style.display = "none";
        
        switchTab("profile"); // ‚úÖ –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
        
        // üë®‚Äçüè´ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–ª–æ–∫–∏ –Ω–∞—Å—Ç–∞–≤–Ω–∏—á–µ—Å—Ç–≤–∞ (–ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ –ø–æ–ª–µ–π)
        setTimeout(() => {
          // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –∏–∑ –¥–∞–Ω–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–∞ –µ—Å–ª–∏ –µ—Å—Ç—å
          if (currentStatus) {
            document.getElementById("employeeStatus").value = currentStatus;
            handleStatusChange(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –±–ª–æ–∫
          }
          
          // üåô –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è
          loadSavedProfile();
        }, 100);
        
        // üîÑ –ë—ã—Å—Ç—Ä–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤ (—Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º)
        await Promise.all([
          loadOperations(),
          loadSetNumbers(),
          loadTodayRecords()
        ]);
        
        // üõ°Ô∏è –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
        setupRealTimeValidation();
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ–Ω–µ
        loadRatesTable();
        loadOperationFilter();
        // loadPackingModels(); // –£–ë–†–ê–ù–û: —É–∂–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ preloadPackingModels –≤ DOMContentLoaded
        

      }

      // –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ–æ–Ω–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ (—É—Å–∫–æ—Ä–µ–Ω–∏–µ) - —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
      if (currentUserRole === "admin") {
        loadAllDictionariesInBackground();
      }

      // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—Ö–æ–¥–∞ (—Ö–æ—Ç—è —Ñ–æ—Ä–º–∞ —Å–∫—Ä—ã—Ç–∞)
      loginBtn.disabled = false;
      loginBtn.classList.remove("loading");
      loginBtn.textContent = "–í–æ–π—Ç–∏";

    } else {
      errorElem.textContent = "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ PIN-–∫–æ–¥";
      // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–∏ –æ—à–∏–±–∫–µ
      loginBtn.disabled = false;
      loginBtn.classList.remove("loading");
      loginBtn.textContent = "–í–æ–π—Ç–∏";
    }
  } catch (err) {
    errorElem.textContent = "‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è";
    // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–∏ –æ—à–∏–±–∫–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    loginBtn.disabled = false;
    loginBtn.classList.remove("loading");
    loginBtn.textContent = "–í–æ–π—Ç–∏";
  }
}


function handleLogout() {
  // üîÑ –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è
  currentUser = "";
  currentUserRole = "user";
  currentShift = "";
  currentStatus = "";

  // –û—á–∏—â–∞–µ–º –≤—Å–µ CSS –∫–ª–∞—Å—Å—ã –¥–ª—è –∫–Ω–æ–ø–æ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
  const allTabButtons = ["tabProfile", "tabApp", "tabStats", "tabRates", "tabMySalary", "tabCostAnalysis", "tabTraineeManagement", "tabDuplicates", "tabAdmin"];
  allTabButtons.forEach(id => {
    const btn = document.getElementById(id);
    if (btn) {
      btn.classList.remove("admin-hidden", "admin-visible");
      btn.style.display = "";
      btn.style.visibility = "";
      btn.style.width = "";
      btn.style.padding = "";
      btn.style.margin = "";
    }
  });

  localStorage.removeItem("currentUser");
  localStorage.removeItem("currentUserRole");

  // üîê –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã –≤—Ö–æ–¥–∞
  const loginInput = document.getElementById("login");
  const passwordInput = document.getElementById("password");
  const loginBtn = document.getElementById("loginBtn");
  
  loginInput.value = "";
  passwordInput.value = "";
  loginInput.focus();
  
  // üîÑ –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–∫–∏ –≤—Ö–æ–¥–∞
  if (loginBtn) {
    loginBtn.disabled = false;
    loginBtn.classList.remove("loading");
    loginBtn.textContent = "–í–æ–π—Ç–∏";
  }

  // üë§ –û—á–∏—Å—Ç–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è
  document.querySelector('[name="employeeName"]').value = "";
  document.getElementById("shiftType").value = "";
  document.getElementById("employeeStatus").value = "";
  document.getElementById("nightShiftDate").value = "";
  document.getElementById("nightShiftDateBlock").style.display = "none";
  document.getElementById("profileSaved").style.display = "none";
  document.getElementById("profileHint").style.display = "block";
  
  // üåô –û—á–∏—Å—Ç–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∞—É—Ç—Å–æ—Ä—Å–µ—Ä–∞
  clearOutsourcingSettings();
  
  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –æ–ø—Ü–∏–∏ —Ç–∏–ø–∞ –æ–ø–ª–∞—Ç—ã
  updatePayTypeOptions("");

          // üîí –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ —É—á—ë—Ç–∞
        const tabApp = document.getElementById("tabApp");
        const tabMySalary = document.getElementById("tabMySalary");
        tabApp.disabled = true;
        tabApp.innerHTML = "üîí";
        
        // üõ†Ô∏è –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏ (—Ç–∞–∫ –∫–∞–∫ –ø—Ä–æ—Ñ–∏–ª—å –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω)
        if (tabMySalary) tabMySalary.style.display = "inline-block";

  // ‚ùå –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
  closeStats(); // –æ—á–∏—â–∞–µ—Ç statsCards, totalWage –∏ statsLogs

  // üìâ –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª–µ–π —Ñ–∏–ª—å—Ç—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
  document.getElementById("operationFilter").value = "";
  document.getElementById("statsDate").value = "";

  // üíµ –û—á–∏—Å—Ç–∫–∞ –∑–∞—Ä–ø–ª–∞—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
  document.getElementById("mySalaryOutput").innerHTML = "";
  document.getElementById("totalQty").textContent = "";
  document.getElementById("salaryStart").value = "";
  document.getElementById("salaryEnd").value = "";

  // üßº –°–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
  const containers = [
    "loginContainer",
    "tabContainer",
    "appContainer",
    "statsContainer",
    "profileContainer",
    "ratesContainer",
    "adminContainer",
    "mySalaryContainer",
    "costAnalysisContainer",
    "traineeManagementContainer",
    "duplicatesContainer"
  ];
  containers.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = (id === "loginContainer") ? "block" : "none";
  });

  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å —Ç–æ–ª—å–∫–æ –æ–±—ã—á–Ω—ã—Ö –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ (–∞–¥–º–∏–Ω-–≤–∫–ª–∞–¥–∫–∏ –æ—Å—Ç–∞—é—Ç—Å—è —Å–∫—Ä—ã—Ç—ã–º–∏)
  const tabButtons = ["tabProfile", "tabApp", "tabStats", "tabRates", "tabMySalary"];
  tabButtons.forEach(id => {
    const btn = document.getElementById(id);
    if (btn) btn.style.display = "inline-block";
  });
  
  // üîê –ê–¥–º–∏–Ω-–≤–∫–ª–∞–¥–∫–∏ –æ—Å—Ç–∞—é—Ç—Å—è —Å–∫—Ä—ã—Ç—ã–º–∏
  const adminTabs = ["tabCostAnalysis", "tabTraineeManagement", "tabDuplicates", "tabAdmin"];
  adminTabs.forEach(id => {
    const btn = document.getElementById(id);
    if (btn) btn.style.display = "none";
  });

  // üßΩ –°–±—Ä–æ—Å –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
  const modal = document.getElementById("editModal");
  if (modal) modal.style.display = "none";

  // üëá –°–∫—Ä—ã—Ç–∏–µ –Ω–∏–∂–Ω–µ–≥–æ –º–µ–Ω—é
  const nav = document.getElementById("bottomNav");
  nav.style.opacity = "0";
  setTimeout(() => {
    nav.style.display = "none";
    nav.style.opacity = "1";
  }, 200);
}

  async function loadTodayRecords() {
    try {
      // === –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –±—ã—Å—Ç—Ä—ã–π –∑–∞–ø—Ä–æ—Å —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ ===
      const res = await fetch(`${scriptURL}?type=records`, {
        method: 'GET',
        cache: 'no-cache' // –ò—Å–∫–ª—é—á–∞–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
      });
      
      if (!res.ok) {
        throw new Error(`HTTP ${res.status}: ${res.statusText}`);
      }
      
      const data = await res.json();
      todayRecords = data.records || [];
      
  
      
    } catch (error) {
      console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–ø–∏—Å–µ–π –∑–∞ —Å–µ–≥–æ–¥–Ω—è:", error);
      todayRecords = [];
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–µ
      if (error.name !== 'AbortError') {
        showTemporaryNotification("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å–∏", "warning", 2000);
      }
    }
  }

let isMySalaryLoading = false;

async function loadMySalary() {
  if (isMySalaryLoading) return;
  isMySalaryLoading = true;

  const showBtn = document.getElementById("mySalaryBtn");
  const closeBtn = document.getElementById("closeMySalaryBtn");
  const container = document.getElementById("mySalaryOutput");
  const totalQtyBlock = document.getElementById("totalQty");
  
  // –ë–ª–æ–∫–∏—Ä—É–µ–º –æ–±–µ –∫–Ω–æ–ø–∫–∏ –≤–æ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏
  if (showBtn) {
    showBtn.disabled = true;
    showBtn.textContent = "‚è≥ –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã...";
    showBtn.style.opacity = "0.6";
  }
  
  if (closeBtn) {
    closeBtn.disabled = true;
    closeBtn.style.opacity = "0.6";
    closeBtn.style.cursor = "not-allowed";
  }

  // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ —Å—Ä–∞–∑—É
  container.innerHTML = "";
  totalQtyBlock.innerHTML = "";

  try {
    const employee = localStorage.getItem("currentUser") || "";
    const start = document.getElementById("salaryStart").value;
    const end = document.getElementById("salaryEnd").value;

    if (!employee || !start || !end) {
      container.innerHTML = "<p style='text-align:center; color:#f59e0b;'>‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è: –ø–µ—Ä–∏–æ–¥ –∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫</p>";
      return;
    }

    const res = await fetch(`${scriptURL}?type=mySalary&employee=${encodeURIComponent(employee)}&start=${start}&end=${end}`);
    
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    }
    
    const data = await res.json();

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–∫–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞
    if (data.error) {
      container.innerHTML = `<p style='text-align:center; color:#dc2626;'>${data.error}</p>`;
      return;
    }

    if (!data.records || data.records.length === 0) {
      container.innerHTML = "<p style='text-align:center; color:#6b7280;'>üì≠ –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</p>";
      return;
    }

      // üì¶ –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ –∏ —Å–º–µ–Ω–µ
      const grouped = {};

      data.records.forEach(r => {
        const date = formatDate(r.date);
        const shift = r.shift || "–î–µ–Ω—å"; // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π
        const key = `${date}-${shift}`;
        
        if (!grouped[key]) {
          grouped[key] = { 
            date: date,
            shift: shift,
            qty: 0, 
            wage: 0,
            mentorBonus: 0,
            effs: [],
            repackaged: 0,
            stickered: 0,
            operations: []
          };
        }
      
        grouped[key].qty += r.quantity || 0;
        grouped[key].wage += r.wage || 0;
        grouped[key].mentorBonus += r.mentorBonus || 0;
      
        if (r.efficiency !== undefined && r.efficiency !== null) {
          grouped[key].effs.push(r.efficiency);
        }

        // –†–∞–∑–¥–µ–ª—è–µ–º –ø–æ —Ç–∏–ø–∞–º –æ–ø–µ—Ä–∞—Ü–∏–π
        if (r.operation === "–ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ –ø—Ä–æ–¥—É–∫—Ü–∏–∏ —à/–∫") {
          grouped[key].stickered += r.quantity || 0;
        } else {
          grouped[key].repackaged += r.quantity || 0;
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–µ—Ç–∞–ª–∏ –æ–ø–µ—Ä–∞—Ü–∏–π
        grouped[key].operations.push({
          operation: r.operation,
          quantity: r.quantity,
          efficiency: r.efficiency,
          wage: r.wage,
          mentorBonus: r.mentorBonus,
          bonusPercent: r.bonusPercent,
          normStatus: r.normStatus
        });
      });

      let html = `
      <table style="width:100%; border-collapse: collapse; font-size:14px; min-width: 800px;">
          <thead style="background:#f3f4f6;">
            <tr>
              <th style="padding:8px; border:1px solid #ccc;">üìÖ –î–∞—Ç–∞</th>
              <th style="padding:8px; border:1px solid #ccc;">üåÖ –°–º–µ–Ω–∞</th>
              <th style="padding:8px; border:1px solid #ccc;">üì¶ –ü–µ—Ä–µ—É–ø–∞–∫.</th>
              <th style="padding:8px; border:1px solid #ccc;">üè∑Ô∏è –ú–∞—Ä–∫–∏—Ä.</th>
              <th style="padding:8px; border:1px solid #ccc;">‚öôÔ∏è –≠—Ñ—Ñ–µ–∫—Ç.</th>
              <th style="padding:8px; border:1px solid #ccc;">üí∞ –û—Å–Ω–æ–≤–Ω–∞—è</th>
              <th style="padding:8px; border:1px solid #ccc;">üë®‚Äçüè´ –ë–æ–Ω—É—Å –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–∞</th>
              <th style="padding:8px; border:1px solid #ccc;">üíµ –ò—Ç–æ–≥–æ</th>
            </tr>
          </thead>
          <tbody>
      `;

      // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ –∏ —Å–º–µ–Ω–µ
      const sortedEntries = Object.entries(grouped).sort(([a], [b]) => {
        const [dateA, shiftA] = a.split('-');
        const [dateB, shiftB] = b.split('-');
        if (dateA !== dateB) return dateA.localeCompare(dateB);
        // –î–µ–Ω—å –∏–¥–µ—Ç –ø–µ—Ä–µ–¥ –ù–æ—á—å—é
        if (shiftA === '–î–µ–Ω—å' && shiftB === '–ù–æ—á—å') return -1;
        if (shiftA === '–ù–æ—á—å' && shiftB === '–î–µ–Ω—å') return 1;
        return 0;
      });

      sortedEntries.forEach(([key, stats]) => {
        const avgEff = stats.effs.length
          ? Math.round(stats.effs.reduce((a, b) => a + b, 0) / stats.effs.length)
          : "-";
        
        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –∑–∞—Ä–ø–ª–∞—Ç—É (–æ–±—â–∞—è - –±–æ–Ω—É—Å –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–∞)
        const basicWage = stats.wage - stats.mentorBonus;
        
        // –ò–∫–æ–Ω–∫–∞ –∏ —Ü–≤–µ—Ç –¥–ª—è —Å–º–µ–Ω—ã
        const shiftIcon = stats.shift === '–î–µ–Ω—å' ? '‚òÄÔ∏è' : 'üåô';
        const shiftBg = stats.shift === '–î–µ–Ω—å' ? '#fef3c7' : '#ddd6fe';
        
        html += `
          <tr>
            <td style="padding:6px; border:1px solid #ccc;">${stats.date}</td>
            <td style="padding:6px; border:1px solid #ccc; background:${shiftBg}; font-weight:bold;">${shiftIcon} ${stats.shift}</td>
            <td style="padding:6px; border:1px solid #ccc;">${stats.repackaged}</td>
            <td style="padding:6px; border:1px solid #ccc;">${stats.stickered}</td>
            <td style="padding:6px; border:1px solid #ccc;">${avgEff}%</td>
            <td style="padding:6px; border:1px solid #ccc;">${basicWage.toFixed(2)} ‚ÇΩ</td>
            <td style="padding:6px; border:1px solid #ccc; ${stats.mentorBonus > 0 ? 'background:#f0f9ff; font-weight:bold;' : ''}">${stats.mentorBonus.toFixed(2)} ‚ÇΩ</td>
            <td style="padding:6px; border:1px solid #ccc; font-weight:bold;">${stats.wage.toFixed(2)} ‚ÇΩ</td>
          </tr>
        `;
      });

      html += `</tbody></table>`;
      container.innerHTML = html;
    
    // === –ò–¢–û–ì–û–í–´–ï –ü–û–ö–ê–ó–ê–¢–ï–õ–ò –° –†–ê–ó–î–ï–õ–ï–ù–ò–ï–ú –ü–û –°–ú–ï–ù–ê–ú ===
    const totals = data.totals || {};
    const dayTotals = data.dayTotals || {};
    const nightTotals = data.nightTotals || {};
    
    const totalBasicWage = (totals.totalWage || 0) - (totals.totalMentorBonus || 0);
    const dayBasicWage = (dayTotals.totalWage || 0) - (dayTotals.totalMentorBonus || 0);
    const nightBasicWage = (nightTotals.totalWage || 0) - (nightTotals.totalMentorBonus || 0);
    
    // –°–æ–∑–¥–∞–µ–º –±–ª–æ–∫–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π —Å–º–µ–Ω—ã
    let shiftsHTML = '';
    
    if (dayTotals.totalQuantity > 0) {
      shiftsHTML += `
        <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde047 20%); padding:12px; border-radius:8px; border:1px solid #eab308; margin-bottom: 8px;">
          <div style="text-align: center; font-weight: bold; margin-bottom: 8px; color: #000000;">‚òÄÔ∏è –î–Ω–µ–≤–Ω—ã–µ —Å–º–µ–Ω—ã</div>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 6px; text-align: center; font-size: 12px; color: #000000;">
            <div><strong>üí∞ –û—Å–Ω–æ–≤–Ω–∞—è:</strong><br>${dayBasicWage.toFixed(2)} ‚ÇΩ</div>
            <div><strong>üë®‚Äçüè´ –ë–æ–Ω—É—Å –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–∞:</strong><br>${(dayTotals.totalMentorBonus || 0).toFixed(2)} ‚ÇΩ</div>
            <div><strong>üíµ –ò—Ç–æ–≥–æ:</strong><br>${(dayTotals.totalWage || 0).toFixed(2)} ‚ÇΩ</div>
            <div><strong>üì¶ –ü–µ—Ä–µ—É–ø–∞–∫.:</strong><br>${dayTotals.totalRepackaged || 0} —à—Ç</div>
            <div><strong>üè∑Ô∏è –ú–∞—Ä–∫–∏—Ä.:</strong><br>${dayTotals.totalStickered || 0} —à—Ç</div>
            <div><strong>‚öôÔ∏è –≠—Ñ—Ñ–µ–∫—Ç.:</strong><br>${dayTotals.avgEfficiency || 0}%</div>
            <div><strong>üìä –ù–æ—Ä–º—ã:</strong><br>${dayTotals.normsCompleted || 0}/${dayTotals.totalNorms || 0} (${dayTotals.normPercentage || 0}%)</div>
          </div>
        </div>
      `;
    }
    
    if (nightTotals.totalQuantity > 0) {
      shiftsHTML += `
        <div style="background: linear-gradient(135deg, #ddd6fe 0%, #c084fc 20%); padding:12px; border-radius:8px; border:1px solid #8b5cf6; margin-bottom: 8px;">
          <div style="text-align: center; font-weight: bold; margin-bottom: 8px; color: #000000;">üåô –ù–æ—á–Ω—ã–µ —Å–º–µ–Ω—ã</div>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 6px; text-align: center; font-size: 12px; color: #000000;">
            <div><strong>üí∞ –û—Å–Ω–æ–≤–Ω–∞—è:</strong><br>${nightBasicWage.toFixed(2)} ‚ÇΩ</div>
            <div><strong>üë®‚Äçüè´ –ë–æ–Ω—É—Å –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–∞:</strong><br>${(nightTotals.totalMentorBonus || 0).toFixed(2)} ‚ÇΩ</div>
            <div><strong>üíµ –ò—Ç–æ–≥–æ:</strong><br>${(nightTotals.totalWage || 0).toFixed(2)} ‚ÇΩ</div>
            <div><strong>üì¶ –ü–µ—Ä–µ—É–ø–∞–∫.:</strong><br>${nightTotals.totalRepackaged || 0} —à—Ç</div>
            <div><strong>üè∑Ô∏è –ú–∞—Ä–∫–∏—Ä.:</strong><br>${nightTotals.totalStickered || 0} —à—Ç</div>
            <div><strong>‚öôÔ∏è –≠—Ñ—Ñ–µ–∫—Ç.:</strong><br>${nightTotals.avgEfficiency || 0}%</div>
            <div><strong>üìä –ù–æ—Ä–º—ã:</strong><br>${nightTotals.normsCompleted || 0}/${nightTotals.totalNorms || 0} (${nightTotals.normPercentage || 0}%)</div>
          </div>
        </div>
      `;
    }
    
    totalQtyBlock.innerHTML = `
      ${shiftsHTML}
      <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding:16px; border-radius:12px; border:2px solid #10b981; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2); color: #000000 !important;">
        <div style="text-align: center; font-weight: bold; margin-bottom: 12px; font-size: 16px;">üíµ –ò—Ç–æ–≥–æ</div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px; text-align: center; font-size: 13px; line-height: 1.4;">
          <div><strong>üí∞ –û—Å–Ω–æ–≤–Ω–∞—è:</strong><br>${totalBasicWage.toFixed(2)} ‚ÇΩ</div>
          <div><strong>üë®‚Äçüè´ –ë–æ–Ω—É—Å –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–∞:</strong><br>${(totals.totalMentorBonus || 0).toFixed(2)} ‚ÇΩ</div>
          <div><strong>üíµ –ò—Ç–æ–≥–æ:</strong><br>${(totals.totalWage || 0).toFixed(2)} ‚ÇΩ</div>
          <div><strong>üì¶ –ü–µ—Ä–µ—É–ø–∞–∫.:</strong><br>${totals.totalRepackaged || 0} —à—Ç</div>
          <div><strong>üè∑Ô∏è –ú–∞—Ä–∫–∏—Ä.:</strong><br>${totals.totalStickered || 0} —à—Ç</div>
          <div><strong>‚öôÔ∏è –≠—Ñ—Ñ–µ–∫—Ç.:</strong><br>${totals.avgEfficiency || 0}%</div>
          <div><strong>üìä –ù–æ—Ä–º—ã:</strong><br>${totals.normsCompleted || 0}/${totals.totalNorms || 0} (${totals.normPercentage || 0}%)</div>
        </div>
      </div>
    `;

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–∫—Ä—ã—Ç–∏—è
    if (closeBtn) closeBtn.style.display = "inline-block";

    } catch (err) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—Ä–ø–ª–∞—Ç—ã:", err);
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
      let userMessage = "‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö";
      if (err.message.includes("fetch")) {
        userMessage = "üåê –ü—Ä–æ–±–ª–µ–º—ã —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ —Å–µ—Ä–≤–µ—Ä—É";
      } else if (err.message.includes("JSON")) {
        userMessage = "üìÑ –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞";
      } else if (err.message.includes("HTTP 403")) {
        userMessage = "üîí –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞";
      } else if (err.message.includes("HTTP 500")) {
        userMessage = "‚öôÔ∏è –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ";
      }
      
      container.innerHTML = `<p style="text-align:center; color:#dc2626;">${userMessage}</p>`;
      totalQtyBlock.innerHTML = "";
    
  } finally {
    isMySalaryLoading = false;
    
    // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É "–ü–æ–∫–∞–∑–∞—Ç—å –º–æ–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã"
    if (showBtn) {
      showBtn.disabled = false;
      showBtn.textContent = "üìä –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã";
      showBtn.style.opacity = "1";
    }
    
    // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É "–ó–∞–∫—Ä—ã—Ç—å –º–æ–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã"
    if (closeBtn) {
      closeBtn.disabled = false;
      closeBtn.style.opacity = "1";
      closeBtn.style.cursor = "pointer";
    }
  }
}

function closeMySalary() {
  document.getElementById("mySalaryOutput").innerHTML = "";
  document.getElementById("totalQty").innerHTML = "";

  const closeBtn = document.getElementById("closeMySalaryBtn");
  if (closeBtn) closeBtn.style.display = "none";
}

function formatDate(iso) {
  const [y, m, d] = iso.split("-");
  return `${d}.${m}.${y}`;
}




  async function loadVolumes() {
    try {
      const volumes = await loadVolumesFast();
      allVolumes = volumes.map(v => ["", v]); // ‚Üê —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ [–æ–ø–µ—Ä–∞—Ü–∏—è, –æ–±—ä—ë–º] (–∑–∞–≥–ª—É—à–∫–∞)

      const select = document.querySelector('[name="volume"]');
      select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏ –æ–±—ä—ë–º --</option>';
      volumes.forEach(val => {
        const opt = document.createElement('option');
        opt.value = val;
        opt.textContent = val;
        select.appendChild(opt);
      });
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—ä–µ–º–æ–≤:", error);
    }
  }

  async function loadOperations() {
    try {
      const operations = await loadOperationsFast();
      const select = document.querySelector('[name="operationType"]');
      select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏ –æ–ø–µ—Ä–∞—Ü–∏—é --</option>';
      operations.forEach(val => {
        const opt = document.createElement('option');
        opt.value = val;
        opt.textContent = val;
        select.appendChild(opt);
      });
      select.addEventListener("change", () => handleOperationChange(select.value));
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–ø–µ—Ä–∞—Ü–∏–π:", error);
    }
  }

  async function loadSetNumbers() {
    try {
      const sets = await loadSetsFast();
      const select = document.querySelector('[name="setNumber"]');
      select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏ –∞—Ä—Ç–∏–∫—É–ª --</option>';
      sets.forEach(val => {
        const opt = document.createElement('option');
        opt.value = val;
        opt.textContent = val;
        select.appendChild(opt);
      });
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—Ä—Ç–∏–∫—É–ª–æ–≤:", error);
    }
  }

async function deleteRecord(index) {
  if (!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?")) return;

  // –õ–æ–∫–∞–ª—å–Ω–æ —É–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å—å –∏–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –æ—Ç–∫–ª–∏–∫–∞
  const recordElement = document.querySelector(`[data-record-index="${index}"]`);
  if (recordElement) {
    recordElement.style.opacity = "0.5";
    recordElement.style.pointerEvents = "none";
  }

  // === –ë–õ–û–ö–ò–†–£–ï–ú –ö–ù–û–ü–ö–ò –°–¢–ê–¢–ò–°–¢–ò–ö–ò –í–û –í–†–ï–ú–Ø –£–î–ê–õ–ï–ù–ò–Ø ===
  const showStatsBtn = document.getElementById("showStatsBtn");
  const closeStatsBtn = document.getElementById("closeStatsBtn");
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
  const originalShowState = {
    disabled: showStatsBtn?.disabled || false,
    text: showStatsBtn?.textContent || "",
    opacity: showStatsBtn?.style.opacity || "1"
  };
  
  const originalCloseState = {
    disabled: closeStatsBtn?.disabled || false,
    opacity: closeStatsBtn?.style.opacity || "1",
    cursor: closeStatsBtn?.style.cursor || "pointer"
  };

  // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏
  if (showStatsBtn) {
    showStatsBtn.disabled = true;
    showStatsBtn.textContent = "‚è≥ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...";
    showStatsBtn.style.opacity = "0.6";
  }
  
  if (closeStatsBtn) {
    closeStatsBtn.disabled = true;
    closeStatsBtn.style.opacity = "0.6";
    closeStatsBtn.style.cursor = "not-allowed";
  }

  try {
    const res = await fetch(`${scriptURL}?type=deleteRecord&index=${index}`);
    const data = await res.json();

    if (data.status === "success") {
      showTemporaryNotification("‚úÖ –ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞", "success", 2000); // –ë—ã—Å—Ç—Ä–µ–µ —Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è
      
      // === –ú–ì–ù–û–í–ï–ù–ù–û–ï –£–î–ê–õ–ï–ù–ò–ï –ò–ó –ò–ù–¢–ï–†–§–ï–ô–°–ê ===
      if (recordElement) {
        recordElement.remove(); // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç —Å—Ä–∞–∑—É
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Å—Ç–∞–ª–∏—Å—å –ª–∏ –µ—â–µ –∑–∞–ø–∏—Å–∏ –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ
        const statsCards = document.getElementById("statsCards");
        const remainingCards = statsCards?.querySelectorAll('.stat-card');
        if (statsCards && (!remainingCards || remainingCards.length === 0)) {
          // –ï—Å–ª–∏ –∑–∞–ø–∏—Å–µ–π –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å, –æ—á–∏—â–∞–µ–º –∏—Ç–æ–≥ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
          const totalElem = document.getElementById("totalWage");
          if (totalElem) totalElem.textContent = "";
          statsCards.innerHTML = '<p style="text-align:center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É</p>';
        }
      }
      
      // –û—Ç–º–µ—á–∞–µ–º —á—Ç–æ –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–æ—Å–ª–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
      window.needsInterfaceUpdate = true;
      
    } else {
      // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–∞–ø–∏—Å—å –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      if (recordElement) {
        recordElement.style.opacity = "1";
        recordElement.style.pointerEvents = "auto";
      }
      showTemporaryNotification(data.message || "‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è", "error");
    }
    
  } catch (error) {
    // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–∞–ø–∏—Å—å –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    if (recordElement) {
      recordElement.style.opacity = "1";
      recordElement.style.pointerEvents = "auto";
    }
    console.error("‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:", error);
    showTemporaryNotification("‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏", "error");
  } finally {
    // === –†–ê–ó–ë–õ–û–ö–ò–†–£–ï–ú –ö–ù–û–ü–ö–ò –°–¢–ê–¢–ò–°–¢–ò–ö–ò –° –ù–ï–ë–û–õ–¨–®–û–ô –ó–ê–î–ï–†–ñ–ö–û–ô ===
    setTimeout(() => {
      if (showStatsBtn) {
        showStatsBtn.disabled = originalShowState.disabled;
        showStatsBtn.textContent = originalShowState.text;
        showStatsBtn.style.opacity = originalShowState.opacity;
      }
      
      if (closeStatsBtn) {
        closeStatsBtn.disabled = originalCloseState.disabled;
        closeStatsBtn.style.opacity = originalCloseState.opacity;
        closeStatsBtn.style.cursor = originalCloseState.cursor;
      }
      
      // === –ó–ê–ü–£–°–ö–ê–ï–ú –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–ê –ü–û–°–õ–ï –†–ê–ó–ë–õ–û–ö–ò–†–û–í–ö–ò ===
      if (window.needsInterfaceUpdate) {
        window.needsInterfaceUpdate = false;
        fastUpdateAfterChange();
      }
    }, 500); // –î–∞–µ–º –≤—Ä–µ–º—è —Ñ–æ–Ω–æ–≤—ã–º –æ–ø–µ—Ä–∞—Ü–∏—è–º
  }
}

  function handleOperationChange(operation) {
  const setField = document.getElementById("setNumberField");
  const volumeLabel = document.getElementById("volumeLabel");
  const volumeSelect = document.querySelector('[name="volume"]');
  const setSelect = document.querySelector('[name="setNumber"]');

  // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–æ–ª–µ –ê—Ä—Ç–∏–∫—É–ª –Ω–∞–±–æ—Ä–∞
  if (operation === '–°–±–æ—Ä–∫–∞ "–ù–∞–±–æ—Ä–∞"') {
    setField.style.display = "block";
    setSelect.required = true;
    volumeLabel.style.display = "none";
    volumeSelect.required = false;
    volumeSelect.value = "";
  } else {
    setField.style.display = "none";
    setSelect.required = false;
    setSelect.value = "";
    volumeLabel.style.display = "block";
    volumeSelect.required = true;
  }

  // === üîí –ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ –ø—Ä–æ–¥—É–∫—Ü–∏–∏ ‚Äî –æ–±—ä—ë–º –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è ===
 if (operation === "–ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ –ø—Ä–æ–¥—É–∫—Ü–∏–∏ —à/–∫") {
  volumeLabel.style.display = "none";
  volumeSelect.required = false;
  volumeSelect.value = "";
  return;
}

  // === üìÇ –ü–æ–¥–≥—Ä—É–∑–∫–∞ –æ–±—ä—ë–º–æ–≤ –ø–æ –æ–ø–µ—Ä–∞—Ü–∏–∏ ===
  volumeSelect.disabled = false;
  volumeSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏ –æ–±—ä—ë–º --</option>';

  // –§–∏–ª—å—Ç—Ä—É–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –æ–±—ä—ë–º—ã –ø–æ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ (allRates –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω –∑–∞—Ä–∞–Ω–µ–µ)
  const relatedKeys = Array.from(
    new Set(
      allRates
        .filter(rate => rate.operation === operation)
        .map(rate => rate.key)
    )
  );

  // –î–æ–±–∞–≤–ª—è–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã
  relatedKeys.forEach(key => {
    const opt = document.createElement("option");
    opt.value = key;
    opt.textContent = key;
    volumeSelect.appendChild(opt);
  });
}


async function updateRateDisplay() {
  // üåô –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - –¥–ª—è –∞—É—Ç—Å–æ—Ä—Å–µ—Ä–æ–≤ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–∞—Ä–∏—Ñ—ã
  const employeeStatus = document.getElementById("employeeStatus")?.value;
  if (employeeStatus === "–ê—É—Ç—Å–æ—Ä—Å–∏–Ω–≥") {
    // –°–∫—Ä—ã–≤–∞–µ–º –±–ª–æ–∫–∏ –¥–ª—è –∞—É—Ç—Å–æ—Ä—Å–µ—Ä–æ–≤
    const block = document.getElementById("rateInfo");
    const calcBlock = document.getElementById("calcBlock");
    if (block) block.style.display = "none";
    if (calcBlock) calcBlock.style.display = "none";
    return; // –í—ã—Ö–æ–¥–∏–º –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏
  }

  const operationType = document.querySelector('[name="operationType"]').value;
  const volume = document.querySelector('[name="volume"]').value;
  const setNumber = document.querySelector('[name="setNumber"]').value;
  const quantity = Number(document.querySelector('[name="quantity"]').value) || 0;

  const startTime = document.querySelector('[name="startTime"]').value;
  const endTime = document.querySelector('[name="endTime"]').value;

  const key = (operationType.includes("–°–±–æ—Ä–∫–∞")) ? setNumber : volume;

  // –ù–∞–π—Ç–∏ –Ω—É–∂–Ω—ã–π —Ç–∞—Ä–∏—Ñ
  const matched = allRates.find(r => r.operation === operationType && r.key === key);

  const block = document.getElementById("rateInfo");
  const norm = document.getElementById("normDisplay");
  const rate = document.getElementById("rateDisplay");

  const calcBlock = document.getElementById("calcBlock");
  const wageDisplay = document.getElementById("wageDisplay");
  const efficiencyDisplay = document.getElementById("efficiencyDisplay");

  if (matched) {
    norm.textContent = matched.normPerHour;

    // --- –í—ã–±–æ—Ä —Ç–∞—Ä–∏—Ñ–∞ —Å —É—á—ë—Ç–æ–º —Ç–∏–ø–∞ –æ–ø–ª–∞—Ç—ã –∏ FBS ---
    const packingModel = (document.getElementById("profilePackingModel")?.value || "").toLowerCase();
    const payType = localStorage.getItem("profilePayType") || "–°–¥–µ–ª–∫–∞";
    let ratePerUnit = 0;

    if (payType === "–û–∫–ª–∞–¥ + —Å–¥–µ–ª–∫–∞") {
      // –û–∫–ª–∞–¥+—Å–¥–µ–ª–∫–∞: –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã
      if (packingModel.includes("fbs") && matched.rateFBSDeal !== undefined) {
        ratePerUnit = Number(matched.rateFBSDeal);
      } else if (matched.rateDeal !== undefined) {
        ratePerUnit = Number(matched.rateDeal);
      }
    } else {
      // –û–±—ã—á–Ω–∞—è —Å–¥–µ–ª–∫–∞
      if (packingModel.includes("fbs") && matched.rateFBS !== undefined) {
        ratePerUnit = Number(matched.rateFBS);
      } else if (matched.ratePerUnit !== undefined) {
        ratePerUnit = Number(matched.ratePerUnit);
      }
    }

    rate.textContent = ratePerUnit ? ratePerUnit.toFixed(2) + " ‚ÇΩ" : "-";

    const totalPay = quantity * ratePerUnit;

    let durationMin = 0;
    if (startTime && endTime) {
      const [sh, sm] = startTime.split(":").map(Number);
      const [eh, em] = endTime.split(":").map(Number);
      durationMin = (eh * 60 + em) - (sh * 60 + sm);
      if (durationMin < 0) durationMin += 1440;
    }

    let efficiency = "-";
    if (durationMin > 0 && matched.normPerHour > 0) {
      const expected = (matched.normPerHour / 60) * durationMin;
      efficiency = ((quantity / expected) * 100).toFixed(0) + " %";
    }

    wageDisplay.textContent = totalPay.toFixed(2) + " ‚ÇΩ";
    efficiencyDisplay.textContent = efficiency;

    // –ë–æ–Ω—É—Å –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–∞ —Ç–µ–ø–µ—Ä—å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π (1750‚ÇΩ –∑–∞ —Å–º–µ–Ω—É) –∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

    block.style.display = "block";
    calcBlock.style.display = "block";
  } else {
    norm.textContent = "-";
    rate.textContent = "-";
    block.style.display = "none";
    calcBlock.style.display = "none";
  }
}

document.querySelector('[name="operationType"]').addEventListener("change", () => updateRateDisplay());
document.querySelector('[name="volume"]').addEventListener("change", () => updateRateDisplay());
document.querySelector('[name="setNumber"]').addEventListener("change", () => updateRateDisplay());
document.querySelector('[name="quantity"]').addEventListener("input", () => updateRateDisplay());
document.querySelector('[name="startTime"]').addEventListener("change", () => updateRateDisplay());
document.querySelector('[name="endTime"]').addEventListener("change", () => updateRateDisplay());

document.getElementById("dataForm").addEventListener("submit", async function(e) {
  e.preventDefault();
  const form = e.target;
  const result = document.getElementById("result");
  const submitBtn = form.querySelector('button[type="submit"]');
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ –ª–∏ —É–∂–µ –∫–Ω–æ–ø–∫–∞ (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –¥–≤–æ–π–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É)
  if (submitBtn.disabled) {
    return;
  }

  // üöÄ –ë–´–°–¢–†–ê–Ø –û–¢–ü–†–ê–í–ö–ê –¥–ª—è –∞—É—Ç—Å–æ—Ä—Å–µ—Ä–æ–≤
  const isOutsourcing = currentStatus === "–ê—É—Ç—Å–æ—Ä—Å–∏–Ω–≥";
  
  if (isOutsourcing) {
    await handleOutsourcingSubmit(form, submitBtn, result);
  } else {
    await handleRegularSubmit(form, submitBtn, result);
  }
});

// üöÄ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –¥–ª—è –∞—É—Ç—Å–æ—Ä—Å–µ—Ä–æ–≤  
async function handleOutsourcingSubmit(form, submitBtn, result) {
  // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ UI
  submitBtn.disabled = true;
  submitBtn.textContent = "‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...";
  result.style.display = "none";

  // –ë—ã—Å—Ç—Ä–æ–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
  const formData = new FormData(form);
  
  // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∞–Ω–Ω—ã–µ
  formData.append("packingModel", document.getElementById("profilePackingModel").value);
  formData.append("shiftType", currentShift);
  formData.append("employeeStatus", currentStatus);
  formData.append("payType", "–°–¥–µ–ª–∫–∞"); // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –¥–ª—è –∞—É—Ç—Å–æ—Ä—Å–µ—Ä–æ–≤
  
  // üåô –î–∞—Ç–∞ –Ω–æ—á–Ω–æ–π —Å–º–µ–Ω—ã –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
  if (currentShift === "–ù–æ—á—å") {
    const nightShiftDate = localStorage.getItem("profileNightShiftDate");
    if (nightShiftDate) {
      formData.append("nightShiftDate", nightShiftDate);
    }
  }

  // –ë—ã—Å—Ç—Ä–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –±–µ–∑ –ª–∏—à–Ω–∏—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫
  try {
    const response = await fetch(scriptURL, {
      method: "POST",
      body: formData // –ò—Å–ø–æ–ª—å–∑—É–µ–º FormData –Ω–∞–ø—Ä—è–º—É—é –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const resultData = await response.json();
    
    if (resultData.status === "success") {
      // üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å–±—Ä–æ—Å –¥–ª—è –∞—É—Ç—Å–æ—Ä—Å–µ—Ä–æ–≤
      form.reset();
      document.querySelector('[name="employeeName"]').value = currentUser;
      showTemporaryNotification("‚úÖ –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã!", "success");
      
      // –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
      setTimeout(() => loadTodayRecords(), 100);
    } else {
      result.textContent = resultData.message;
      result.style.display = "block";
      result.className = "error-message";
    }
    
  } catch (error) {
    console.error("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:", error);
    result.textContent = "‚ùå –û—à–∏–±–∫–∞: " + error.message;
    result.style.display = "block";
    result.className = "error-message";
  } finally {
    // –ë—ã—Å—Ç—Ä–∞—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞
    submitBtn.disabled = false;
    submitBtn.textContent = "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å";
  }
}

// –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –¥–ª—è —à—Ç–∞—Ç–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
async function handleRegularSubmit(form, submitBtn, result) {
  const formData = new FormData(form);

  // –î–æ–±–∞–≤–ª—è–µ–º –º–æ–¥–µ–ª—å —É–ø–∞–∫–æ–≤–∫–∏ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è
  const packingModel = document.getElementById("profilePackingModel").value;
  formData.append("packingModel", packingModel);

  // –ü–µ—Ä–µ—Å—á—ë—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
  const start = formData.get("startTime");
  const end = formData.get("endTime");
  if (start && end) {
    const [sh, sm] = start.split(":").map(Number);
    const [eh, em] = end.split(":").map(Number);
    let minutes = (eh * 60 + em) - (sh * 60 + sm);
    if (minutes < 0) minutes += 1440;
    const duration = `${Math.floor(minutes / 60)} —á ${minutes % 60} –º–∏–Ω`;
    formData.set("duration", duration);
    document.querySelector('[name="duration"]').value = duration;
  }

  // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è
  formData.append("shiftType", currentShift);
  formData.append("employeeStatus", currentStatus);
  formData.append("payType", localStorage.getItem("profilePayType") || "");
  formData.append("salary", localStorage.getItem("profileSalary") || "");
  
  // üåô –î–æ–±–∞–≤–ª—è–µ–º –¥–∞—Ç—É –Ω–æ—á–Ω–æ–π —Å–º–µ–Ω—ã –µ—Å–ª–∏ —ç—Ç–æ –Ω–æ—á–Ω–∞—è —Å–º–µ–Ω–∞
  if (currentShift === "–ù–æ—á—å") {
    const nightShiftDate = localStorage.getItem("profileNightShiftDate");
    if (nightShiftDate) {
      formData.append("nightShiftDate", nightShiftDate);
    }
  }

  // === –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–Ω–æ–ø–∫–∏ –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ ===
  submitBtn.disabled = true;
  submitBtn.textContent = "‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...";
  submitBtn.style.opacity = "0.6";
  submitBtn.style.cursor = "not-allowed";
  submitBtn.classList.add("loading");
  result.style.display = "none";
  
  // –ë–ª–æ–∫–∏—Ä—É–µ–º –≤—Å—é —Ñ–æ—Ä–º—É
  form.classList.add("form-disabled");
  
  // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –¥—É–±–ª–∏–∫–∞—Ç–∞—Ö –≤–æ –≤—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏
  hideAllWarnings();

  // === –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ URLSearchParams ===
  const params = new URLSearchParams();
  formData.forEach((value, key) => {
    params.append(key, value);
  });

  try {
    const response = await fetch(scriptURL, {
      method: "POST",
      body: params,
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
      }
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const resultData = await response.json();
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    result.textContent = resultData.message;
    result.style.display = "block";
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
    result.className = resultData.status === "success" ? "success-message" : "error-message";

    if (resultData.status === "success") {
      // ‚úÖ –ü–û–õ–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–ê
      await performFullInterfaceRefresh();
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ –Ω–µ–º–Ω–æ–≥–æ –¥–æ–ª—å—à–µ
      setTimeout(() => {
        result.style.display = "none";
        result.className = "";
      }, 3000);
      
    } else {
      // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –ø—Ä–æ—Å—Ç–æ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
      enableSubmitButton();
    }
    
  } catch (error) {
    console.error("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö:", error);
    result.textContent = "‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: " + error.message;
    result.style.display = "block";
    result.className = "error-message";
    enableSubmitButton();
  }
}


async function loadRatesTable() {
  const loader = document.getElementById("ratesLoader");
  const container = document.getElementById("ratesTable");
  const opFilter = document.getElementById("filterOperation");
  const keyFilter = document.getElementById("filterKey");
  const searchInput = document.getElementById("ratesSearch");
  const counter = document.getElementById("ratesCounter");

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
  loader.style.display = "block";
  container.innerHTML = "";

  try {
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à –¥–ª—è —Ç–∞—Ä–∏—Ñ–æ–≤
  if (isCacheValid(dataCache.rates)) {
    allRates = dataCache.rates.data;
  } else {
    const res = await fetch(`${scriptURL}?type=rates`);
    const data = await res.json();
    allRates = data.rates || [];
    
    dataCache.rates = {
      data: allRates,
      timestamp: Date.now()
    };
  }

  // –§–∏–ª—å—Ç—Ä—É–µ–º –ª–∏—à–Ω–∏–µ —Å—Ç–∞–≤–∫–∏
  const filteredRates = allRates.filter(r =>
    r.operation !== "–°—Ç–∞–≤–∫–∞_–ê—É—Ç—Å–æ—Ä—Å–∏–Ω–≥" && r.operation !== "–°—Ç–∞–≤–∫–∞_—à—Ç–∞—Ç"
  );

    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
    populateFilters(filteredRates, opFilter, keyFilter);

    // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
    let sortColumn = null;
    let sortDirection = "asc";

    // –§—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —Å –ø–æ–∏—Å–∫–æ–º, —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π
  function renderFilteredRates() {
      const searchText = searchInput.value.toLowerCase().trim();
    const selectedOp = opFilter.value;
    const selectedKey = keyFilter.value;

      let filtered = filteredRates.filter(r => {
        const matchesSearch = !searchText || r.operation.toLowerCase().includes(searchText);
        const matchesOp = !selectedOp || r.operation === selectedOp;
        const matchesKey = !selectedKey || r.key === selectedKey;
        return matchesSearch && matchesOp && matchesKey;
      });

      // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É
      if (sortColumn !== null) {
        filtered.sort((a, b) => {
          let aVal = getColumnValue(a, sortColumn);
          let bVal = getColumnValue(b, sortColumn);
          
          // –ß–∏—Å–ª–æ–≤–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –¥–ª—è —Ç–∞—Ä–∏—Ñ–æ–≤ –∏ –Ω–æ—Ä–º
          if (sortColumn >= 2) {
            aVal = parseFloat(aVal) || 0;
            bVal = parseFloat(bVal) || 0;
          }
          
          let result = aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
          return sortDirection === "desc" ? -result : result;
        });
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
      updateCounter(filtered.length, filteredRates.length);

    if (!filtered.length) {
        container.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #6b7280;">
            <div style="font-size: 48px; margin-bottom: 16px;">üîç</div>
            <h3 style="margin: 0 0 8px 0; color: #374151;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h3>
            <p style="margin: 0;">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ø–æ–∏—Å–∫–∞</p>
          </div>
        `;
      return;
    }

      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–∞–±–ª–∏—Ü—É
    let html = `
      <div class="table-scroll">
        <table style="width:100%; border-collapse:collapse; min-width:700px;">
        <thead>
            <tr>
              ${generateTableHeaders()}
          </tr>
        </thead>
        <tbody>
    `;

    filtered.forEach(r => {
      html += `
        <tr>
          <td>${r.operation}</td>
          <td>${r.key}</td>
          <td>${r.normPerHour}</td>
            <td><strong>${r.ratePerUnit.toFixed(2)} ‚ÇΩ</strong></td>
            <td><strong>${r.rateFBS.toFixed(2)} ‚ÇΩ</strong></td>
            <td><strong>${r.rateDeal.toFixed(2)} ‚ÇΩ</strong></td>
            <td><strong>${r.rateFBSDeal.toFixed(2)} ‚ÇΩ</strong></td>
        </tr>
      `;
    });

    html += '</tbody></table></div>';
    container.innerHTML = html;

      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
      addSortHandlers();
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    function populateFilters(rates, opFilter, keyFilter) {
      // –û—á–∏—Å—Ç–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
      opFilter.innerHTML = '<option value="">-- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ --</option>';
      keyFilter.innerHTML = '<option value="">-- –í—Å–µ –æ–±—ä—ë–º—ã / –∞—Ä—Ç–∏–∫—É–ª—ã --</option>';

      const operations = [...new Set(rates.map(r => r.operation))].sort();
      const keys = [...new Set(rates.map(r => r.key))].sort();

      operations.forEach(op => {
        const opt = document.createElement("option");
        opt.value = op;
        opt.textContent = op;
        opFilter.appendChild(opt);
      });

      keys.forEach(k => {
        const opt = document.createElement("option");
        opt.value = k;
        opt.textContent = k;
        keyFilter.appendChild(opt);
      });
    }

    function generateTableHeaders() {
      const headers = [
        'üè∑Ô∏è –û–ø–µ—Ä–∞—Ü–∏—è',
        'üì¶ –û–±—ä—ë–º / –ê—Ä—Ç–∏–∫—É–ª', 
        '‚è±Ô∏è –ù–æ—Ä–º–∞ –≤ —á–∞—Å',
        'üí∞ –¢–∞—Ä–∏—Ñ/—à—Ç<br><small>(—Å–¥–µ–ª—å–Ω–∞—è)</small>',
        'üöö –¢–∞—Ä–∏—Ñ FBS/—à—Ç<br><small>(—Å–¥–µ–ª—å–Ω–∞—è)</small>',
        'üìä –¢–∞—Ä–∏—Ñ/—à—Ç<br><small>(–æ–∫–ª–∞–¥+—Å–¥–µ–ª)</small>',
        'üööüìä –¢–∞—Ä–∏—Ñ FBS/—à—Ç<br><small>(–æ–∫–ª–∞–¥+—Å–¥–µ–ª)</small>'
      ];

      return headers.map((header, index) => {
        const sortClass = getSortClass(index);
        return `<th class="sortable ${sortClass}" onclick="handleSort(${index})">${header}</th>`;
      }).join('');
    }

    function getSortClass(columnIndex) {
      if (sortColumn === columnIndex) {
        return sortDirection === "asc" ? "sorted-asc" : "sorted-desc";
      }
      return "";
    }

    function getColumnValue(row, columnIndex) {
      switch(columnIndex) {
        case 0: return row.operation;
        case 1: return row.key;
        case 2: return row.normPerHour;
        case 3: return row.ratePerUnit;
        case 4: return row.rateFBS;
        case 5: return row.rateDeal;
        case 6: return row.rateFBSDeal;
        default: return "";
      }
    }

    function updateCounter(shown, total) {
      if (shown === total) {
        counter.textContent = `–ü–æ–∫–∞–∑–∞–Ω–æ: ${total} —Ç–∞—Ä–∏—Ñ–æ–≤`;
      } else {
        counter.textContent = `–ü–æ–∫–∞–∑–∞–Ω–æ: ${shown} –∏–∑ ${total} —Ç–∞—Ä–∏—Ñ–æ–≤`;
      }
    }

    function addSortHandlers() {
      // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
      window.handleSort = function(columnIndex) {
        if (sortColumn === columnIndex) {
          sortDirection = sortDirection === "asc" ? "desc" : "asc";
        } else {
          sortColumn = columnIndex;
          sortDirection = "asc";
        }
        renderFilteredRates();
      };
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
  opFilter.onchange = renderFilteredRates;
  keyFilter.onchange = renderFilteredRates;

    // –ñ–∏–≤–æ–π –ø–æ–∏—Å–∫ —Å –¥–µ–±–∞—É–Ω—Å–æ–º
    let searchTimeout;
    searchInput.oninput = function() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(renderFilteredRates, 300);
    };

    // –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Ñ–æ–∫—É—Å–∞ –ø–æ–∏—Å–∫–∞
    searchInput.onfocus = function() {
      this.style.borderColor = "#3b82f6";
      this.style.boxShadow = "0 0 0 3px rgba(59, 130, 246, 0.1)";
    };

    searchInput.onblur = function() {
      this.style.borderColor = "#e5e7eb";
      this.style.boxShadow = "none";
    };

    // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä
    renderFilteredRates();

  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∞—Ä–∏—Ñ–æ–≤:", error);
    container.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #ef4444;">
        <div style="font-size: 48px; margin-bottom: 16px;">‚ö†Ô∏è</div>
        <h3 style="margin: 0 0 8px 0;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h3>
        <p style="margin: 0;">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–∞—Ä–∏—Ñ—ã</p>
      </div>
    `;
  } finally {
    // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    loader.style.display = "none";
  }
}

// –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –∫—ç—à–∞
function isCacheValid(cacheEntry) {
  return cacheEntry.data && (Date.now() - cacheEntry.timestamp) < CACHE_DURATION;
}

// –ë—ã—Å—Ç—Ä–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–π —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
async function loadOperationsFast() {
  if (isCacheValid(dataCache.operations)) {
    return dataCache.operations.data;
  }
  
  const res = await fetch(`${scriptURL}?type=operations`);
  const data = await res.json();
  
  dataCache.operations = {
    data: data.operations,
    timestamp: Date.now()
  };
  
  return data.operations;
}

// –ë—ã—Å—Ç—Ä–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –æ–±—ä–µ–º–æ–≤ —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
async function loadVolumesFast() {
  if (isCacheValid(dataCache.volumes)) {
    return dataCache.volumes.data;
  }
  
  const res = await fetch(`${scriptURL}?type=volumes`);
  const data = await res.json();
  
  dataCache.volumes = {
    data: data.volumes,
    timestamp: Date.now()
  };
  
  return data.volumes;
}

// –ë—ã—Å—Ç—Ä–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–∞–±–æ—Ä–æ–≤ —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
async function loadSetsFast() {
  if (isCacheValid(dataCache.sets)) {
    return dataCache.sets.data;
  }
  
  const res = await fetch(`${scriptURL}?type=sets`);
  const data = await res.json();
  
  dataCache.sets = {
    data: data.sets,
    timestamp: Date.now()
  };
  
  return data.sets;
}

// ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û: –ë—ã—Å—Ç—Ä–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ä–∞–∑–º–µ—Ä–æ–≤ –Ω–∞–±–æ—Ä–æ–≤ —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
async function loadSetSizesFast() {
  if (isCacheValid(dataCache.setSizes)) {
    return dataCache.setSizes.data;
  }
  
  const res = await fetch(`${scriptURL}?type=setSizes`);
  const data = await res.json();
  
  dataCache.setSizes = {
    data: data.setSizes,
    timestamp: Date.now()
  };
  
  return data.setSizes;
}

async function loadOperationFilter() {
  try {
    const operations = await loadOperationsFast();
    const filter = document.getElementById("operationFilter");

    filter.innerHTML = '<option value="">-- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ --</option>';
    operations.forEach(op => {
      const option = document.createElement("option");
      option.value = op;
      option.textContent = op;
      filter.appendChild(option);
    });
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–ø–µ—Ä–∞—Ü–∏–π:", error);
  }
}

function openEditModal(index, record) {
  const form = document.getElementById("editForm");

  form.rowIndex.value = index;
  form.employeeName.value = currentUser;
  form.orderNumber.value = record.orderNumber || "";
  form.shiftType.value = currentShift;
  form.employeeStatus.value = currentStatus;

  form.quantity.value = record.quantity;
  form.startTime.value = record.startTime;
  form.endTime.value = record.endTime;

  document.getElementById("editOperation").value = record.operationType || "";
  document.getElementById("editVolumeSelect").value = record.volume || "";
  document.getElementById("editSetNumberSelect").value = record.setNumber || "";

  // —Ç—Ä–∏–≥–≥–µ—Ä–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª—è –æ–±—ä—ë–º–∞/–Ω–∞–±–æ—Ä–∞
  document.getElementById("editOperation").dispatchEvent(new Event("change"));

  document.getElementById("editModal").style.display = "block";
}

async function loadEditFormDictionaries() {
  try {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
    const [operations, volumes, sets] = await Promise.all([
      loadOperationsFast(),
      loadVolumesFast(),
      loadSetsFast()
    ]);

    // –û–ø–µ—Ä–∞—Ü–∏–∏
    const opSelect = document.getElementById("editOperation");
    opSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏ –æ–ø–µ—Ä–∞—Ü–∏—é --</option>';
    operations.forEach(op => {
      const opt = document.createElement("option");
      opt.value = op;
      opt.textContent = op;
      opSelect.appendChild(opt);
    });

    // –û–±—ä—ë–º—ã
    const volSelect = document.getElementById("editVolumeSelect");
    volSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏ –æ–±—ä—ë–º --</option>';
    volumes.forEach(v => {
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = v;
      volSelect.appendChild(opt);
    });

    // –ê—Ä—Ç–∏–∫—É–ª—ã –Ω–∞–±–æ—Ä–æ–≤
    const setSelect = document.getElementById("editSetNumberSelect");
    setSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏ –∞—Ä—Ç–∏–∫—É–ª --</option>';
    sets.forEach(s => {
      const opt = document.createElement("option");
      opt.value = s;
      opt.textContent = s;
      setSelect.appendChild(opt);
    });

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –æ–±—ä—ë–º–∞/–Ω–∞–±–æ—Ä–∞
    opSelect.addEventListener("change", () => {
      const isSet = opSelect.value.includes("–°–±–æ—Ä–∫–∞");
      document.getElementById("editVolumeLabel").style.display = isSet ? "none" : "block";
      volSelect.required = !isSet;
      document.getElementById("editSetNumberField").style.display = isSet ? "block" : "none";
    });
    
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ–≤–∞—Ä–µ–π –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:", error);
  }
}

async function submitEditForm() {
  const form = document.getElementById("editForm");
  const submitBtn = form.querySelector('button[type="button"], .submit-btn');
  
  // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É
  if (submitBtn && submitBtn.disabled) {
    return;
  }
  
  const formData = new FormData(form);
  const params = new URLSearchParams();

  formData.forEach((value, key) => {
    params.append(key, value);
  });

  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  params.set("type", "editRecord");

  // üëá –ü–µ—Ä–µ—Å—á—ë—Ç –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–≤–∞–∂–Ω–æ!)
  const start = formData.get("startTime");
  const end = formData.get("endTime");
  if (start && end) {
    const [sh, sm] = start.split(":").map(Number);
    const [eh, em] = end.split(":").map(Number);
    let minutes = (eh * 60 + em) - (sh * 60 + sm);
    if (minutes < 0) minutes += 1440;
    const duration = `${Math.floor(minutes / 60)} —á ${minutes % 60} –º–∏–Ω`;
    params.set("duration", duration);
  }

  // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
  if (submitBtn) {
    submitBtn.disabled = true;
    submitBtn.textContent = "‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...";
    submitBtn.style.opacity = "0.6";
  }

  // === –ë–õ–û–ö–ò–†–£–ï–ú –ö–ù–û–ü–ö–ò –°–¢–ê–¢–ò–°–¢–ò–ö–ò –í–û –í–†–ï–ú–Ø –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø ===
  const showStatsBtn = document.getElementById("showStatsBtn");
  const closeStatsBtn = document.getElementById("closeStatsBtn");
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
  const originalShowState = {
    disabled: showStatsBtn?.disabled || false,
    text: showStatsBtn?.textContent || "",
    opacity: showStatsBtn?.style.opacity || "1"
  };
  
  const originalCloseState = {
    disabled: closeStatsBtn?.disabled || false,
    opacity: closeStatsBtn?.style.opacity || "1",
    cursor: closeStatsBtn?.style.cursor || "pointer"
  };

  // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
  if (showStatsBtn) {
    showStatsBtn.disabled = true;
    showStatsBtn.textContent = "‚è≥ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...";
    showStatsBtn.style.opacity = "0.6";
  }
  
  if (closeStatsBtn) {
    closeStatsBtn.disabled = true;
    closeStatsBtn.style.opacity = "0.6";
    closeStatsBtn.style.cursor = "not-allowed";
  }

  try {
    const res = await fetch(scriptURL, {
      method: "POST",
      body: params,
    });

    const data = await res.json();
    
    if (data.status === "success") {
      showTemporaryNotification("‚úÖ –ó–∞–ø–∏—Å—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞!", "success", 2000); // –ë—ã—Å—Ç—Ä–µ–µ —Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è
      closeEditModal();
      
      // –û—Ç–º–µ—á–∞–µ–º —á—Ç–æ –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–æ—Å–ª–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
      window.needsInterfaceUpdate = true;
      
    } else {
      showTemporaryNotification(data.message || "‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è", "error");
    }
    
  } catch (err) {
    console.error("‚ùå –û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:", err);
    showTemporaryNotification("‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: " + err.message, "error");
  } finally {
    // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    if (submitBtn) {
      submitBtn.disabled = false;
      submitBtn.textContent = "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å";
      submitBtn.style.opacity = "1";
    }
    
    // === –†–ê–ó–ë–õ–û–ö–ò–†–£–ï–ú –ö–ù–û–ü–ö–ò –°–¢–ê–¢–ò–°–¢–ò–ö–ò –° –ù–ï–ë–û–õ–¨–®–û–ô –ó–ê–î–ï–†–ñ–ö–û–ô ===
    setTimeout(() => {
      if (showStatsBtn) {
        showStatsBtn.disabled = originalShowState.disabled;
        showStatsBtn.textContent = originalShowState.text;
        showStatsBtn.style.opacity = originalShowState.opacity;
      }
      
      if (closeStatsBtn) {
        closeStatsBtn.disabled = originalCloseState.disabled;
        closeStatsBtn.style.opacity = originalCloseState.opacity;
        closeStatsBtn.style.cursor = originalCloseState.cursor;
      }
      
      // === –ó–ê–ü–£–°–ö–ê–ï–ú –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–ê –ü–û–°–õ–ï –†–ê–ó–ë–õ–û–ö–ò–†–û–í–ö–ò ===
      if (window.needsInterfaceUpdate) {
        window.needsInterfaceUpdate = false;
        fastUpdateAfterChange();
      }
    }, 500); // –î–∞–µ–º –≤—Ä–µ–º—è —Ñ–æ–Ω–æ–≤—ã–º –æ–ø–µ—Ä–∞—Ü–∏—è–º
  }
}

function closeEditModal() {
  document.getElementById("editModal").style.display = "none";
}

function getVolumesForOperation(operation) {
  if (!Array.isArray(allVolumes)) return [];

  return allVolumes
    .filter(item => item[0] === operation)
    .map(item => item[1])
    .filter((value, index, self) => self.indexOf(value) === index);
}


function closeStats() {
  document.getElementById("statsCards").innerHTML = "";
  document.getElementById("totalWage").textContent = "";
  document.getElementById("statsLogs").innerHTML = "";

  const closeBtn = document.getElementById("closeStatsBtn");
  if (closeBtn) closeBtn.style.display = "none";
}

let isStatsLoading = false;



async function loadStats() {
  if (isStatsLoading) return;
  isStatsLoading = true;

  const showBtn = document.getElementById("showStatsBtn");
  const closeBtn = document.getElementById("closeStatsBtn");
  
  // –ë–ª–æ–∫–∏—Ä—É–µ–º –æ–±–µ –∫–Ω–æ–ø–∫–∏ –≤–æ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏
  if (showBtn) {
    showBtn.disabled = true;
    showBtn.textContent = "‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...";
    showBtn.style.opacity = "0.6";
  }
  
  if (closeBtn) {
    closeBtn.disabled = true;
    closeBtn.style.opacity = "0.6";
    closeBtn.style.cursor = "not-allowed";
  }

  try {
    const selectedOperation = document.getElementById("operationFilter").value;
    const date = document.getElementById("statsDate").value;

    if (!currentUser) {
      showTemporaryNotification("‚ùó–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω", "error");
      return;
    }

    if (!date) {
      showTemporaryNotification("‚ùó–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏", "warning");
      return;
    }

    // –ë—ã—Å—Ç—Ä–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    const container = document.getElementById("statsCards");
    const totalElem = document.getElementById("totalWage");
    const logElem = document.getElementById("statsLogs");
    
    container.innerHTML = "";
    totalElem.textContent = "";
    logElem.innerHTML = "";

    const res = await fetch(`${scriptURL}?type=stats&date=${encodeURIComponent(date)}&employee=${encodeURIComponent(currentUser)}`);
    
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    }
    
    const data = await res.json();

    if (!data.records || !data.records.length) {
      container.innerHTML = '<p style="text-align:center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É</p>';
      totalElem.textContent = ""; // –û—á–∏—â–∞–µ–º –∏—Ç–æ–≥ –∫–æ–≥–¥–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
      return;
    }

    // üåô –†–ê–ó–î–ï–õ–ï–ù–ò–ï –ü–û –°–ú–ï–ù–ê–ú
    const dayRecords = (data.dayRecords || []).filter(r => 
      selectedOperation ? r.operationType === selectedOperation : true
    );
    const nightRecords = (data.nightRecords || []).filter(r => 
      selectedOperation ? r.operationType === selectedOperation : true
    );

    // üë• –†–ê–ó–î–ï–õ–ï–ù–ò–ï –ü–û –°–¢–ê–¢–£–°–£ –°–û–¢–†–£–î–ù–ò–ö–û–í
    const staffRecords = (data.staffRecords || []).filter(r => 
      selectedOperation ? r.operationType === selectedOperation : true
    );
    const traineeRecords = (data.traineeRecords || []).filter(r => 
      selectedOperation ? r.operationType === selectedOperation : true
    );

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –∑–∞–ø–∏—Å–∏ –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
    if (!dayRecords.length && !nightRecords.length && !staffRecords.length && !traineeRecords.length) {
      container.innerHTML = selectedOperation 
        ? '<p style="text-align:center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏</p>'
        : '<p style="text-align:center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É</p>';
      totalElem.textContent = ""; // –û—á–∏—â–∞–µ–º –∏—Ç–æ–≥ –∫–æ–≥–¥–∞ –Ω–µ—Ç –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
      return;
    }

    // üåô –°–û–ó–î–ê–ù–ò–ï –†–ê–ó–î–ï–õ–¨–ù–´–• –ë–õ–û–ö–û–í –ü–û –°–ú–ï–ù–ê–ú
    const today = new Date().toISOString().split("T")[0];
    let cardsHTML = "";
    
    // üè¢ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –¥–ª—è –∞—É—Ç—Å–æ—Ä—Å–∏–Ω–≥–∞ (–µ–¥–∏–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –≤—Å–µ–≥–æ –±–ª–æ–∫–∞)
    const isOutsourcing = currentStatus === "–ê—É—Ç—Å–æ—Ä—Å–∏–Ω–≥";
    
    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 —Å—É—Ç–æ–∫)
    function isWithinEditPeriod(dateStr) {
      const recordDate = new Date(dateStr + "T00:00:00");
      const currentDate = new Date();
      const diffDays = Math.floor((currentDate - recordDate) / (1000 * 60 * 60 * 24));
      return diffDays <= 2;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π —Å–º–µ–Ω—ã
    function createShiftCards(records, shiftName, shiftIcon) {
      if (!records.length) return "";
      
      let shiftWage = 0;
      let shiftEfficiency = 0;
      let shiftEfficiencyCount = 0;
      let shiftRepackaged = 0;
      let shiftStickered = 0;
      
      let shiftCardsHTML = `
        <div style="margin: 20px 0; padding: 15px; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border-radius: 12px; border: 2px solid #64748b;">
          <h3 style="margin: 0 0 15px 0; text-align: center; color: #334155;">${shiftIcon} ${shiftName}</h3>
      `;
      
      records.forEach(rec => {
        const wage = rec.wage || 0;
        shiftWage += wage;
        const quantity = rec.quantity || 0;
        
        // –†–∞–∑–¥–µ–ª—è–µ–º –ø–æ —Ç–∏–ø–∞–º –æ–ø–µ—Ä–∞—Ü–∏–π
        if (rec.operationType === "–ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ –ø—Ä–æ–¥—É–∫—Ü–∏–∏ —à/–∫") {
          shiftStickered += quantity;
        } else {
          shiftRepackaged += quantity;
        }

        // –°—á–∏—Ç–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
        const efficiency = rec.efficiency !== null && rec.efficiency !== undefined ? rec.efficiency : 0;
        shiftEfficiency += efficiency;
        shiftEfficiencyCount++;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å (–∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 —Å—É—Ç–æ–∫)
        const canEdit = rec.rowIndex !== undefined && isWithinEditPeriod(date);
        const buttonsHTML = canEdit
          ? `<div style="margin-top:10px;">
               <button onclick="openEditModal(${rec.rowIndex}, ${JSON.stringify(rec).replace(/"/g, '&quot;')})">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
               <button onclick="deleteRecord(${rec.rowIndex})" class="danger" style="margin-left:10px;">üóë –£–¥–∞–ª–∏—Ç—å</button>
             </div>`
          : "";

        
        shiftCardsHTML += `
          <div class="stat-card" ${rec.rowIndex !== undefined ? `data-record-index="${rec.rowIndex}"` : ""}>
            <p><strong>üïí –í—Ä–µ–º—è:</strong> ${rec.startTime} ‚Äì ${rec.endTime}</p>
            <p><strong>üîß –û–ø–µ—Ä–∞—Ü–∏—è:</strong> ${rec.operationType}</p>
            <p><strong>üì¶ –û–±—ä—ë–º:</strong> ${rec.volume || "-"}</p>
            <p><strong>üß© –ù–∞–±–æ—Ä:</strong> ${rec.setNumber || "-"}</p>
            ${rec.mentor ? `<p><strong>üë®‚Äçüè´ –ù–∞—Å—Ç–∞–≤–Ω–∏–∫/–°—Ç–∞–∂–µ—Ä:</strong> ${rec.mentor}</p>` : ""}
            <p><strong>üî¢ –ö–æ–ª-–≤–æ:</strong> ${rec.quantity}</p>
            <p><strong>‚öôÔ∏è –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:</strong> ${rec.efficiency ?? "-"}%</p>
            ${!isOutsourcing ? `<p><strong>‚è± –ù–æ—Ä–º–∞ –≤ —á–∞—Å:</strong> ${rec.normPerHour ?? "-"}</p>` : ""}
            ${!isOutsourcing ? `<p><strong>üí∞ –¢–∞—Ä–∏—Ñ –∑–∞ —à—Ç:</strong> ${rec.ratePerUnit?.toFixed(2) ?? "-"} ‚ÇΩ</p>` : ""}
            ${!isOutsourcing && rec.bonusPercent ? `<p><strong>üéÅ –ë–æ–Ω—É—Å:</strong> ${rec.bonusIcon || "üéÅ"} ${rec.bonusPercent}</p>` : ""}
            ${!isOutsourcing ? `<p><strong>üí∏ –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ:</strong> ${wage.toFixed(2)} ‚ÇΩ</p>` : ""}
            ${buttonsHTML}
          </div>
        `;
      });
      
      // –ò—Ç–æ–≥–∏ –ø–æ —Å–º–µ–Ω–µ
      const avgEfficiency = shiftEfficiencyCount ? Math.round(shiftEfficiency / shiftEfficiencyCount) : "-";
      
      if (isOutsourcing) {
        // –î–ª—è –∞—É—Ç—Å–æ—Ä—Å–∏–Ω–≥–∞ - –±–µ–∑ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞—Ä–∞–±–æ—Ç–∫–µ
        shiftCardsHTML += `
          <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.7); border-radius: 8px; text-align: center; font-weight: bold;">
            üì¶ –ü–µ—Ä–µ—É–ø–∞–∫.: ${shiftRepackaged} —à—Ç | 
            üè∑Ô∏è –ú–∞—Ä–∫–∏—Ä.: ${shiftStickered} —à—Ç | 
            ‚öôÔ∏è –≠—Ñ—Ñ–µ–∫—Ç.: ${avgEfficiency}%
          </div>
        </div>`;
      } else {
        // –î–ª—è —à—Ç–∞—Ç–Ω—ã—Ö - —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∑–∞—Ä–∞–±–æ—Ç–∫–µ
        shiftCardsHTML += `
          <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.7); border-radius: 8px; text-align: center; font-weight: bold;">
            üíµ –ò—Ç–æ–≥–æ –∑–∞ ${shiftName.toLowerCase()}: ${shiftWage.toFixed(2)} ‚ÇΩ | 
            üì¶ –ü–µ—Ä–µ—É–ø–∞–∫.: ${shiftRepackaged} —à—Ç | 
            üè∑Ô∏è –ú–∞—Ä–∫–∏—Ä.: ${shiftStickered} —à—Ç | 
            ‚öôÔ∏è –≠—Ñ—Ñ–µ–∫—Ç.: ${avgEfficiency}%
          </div>
        </div>`;
      }
      
      return shiftCardsHTML;
    }
    
    // –°–æ–∑–¥–∞–µ–º –±–ª–æ–∫–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è –∫–∞–∂–¥–æ–π —Å–º–µ–Ω—ã (—É–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ —Å—Ç–∞—Ç—É—Å—É)
    if (dayRecords.length > 0) {
      cardsHTML += createShiftCards(dayRecords, "–î–Ω–µ–≤–Ω–∞—è —Å–º–µ–Ω–∞", "‚òÄÔ∏è");
    }
    
    if (nightRecords.length > 0) {
      cardsHTML += createShiftCards(nightRecords, "–ù–æ—á–Ω–∞—è —Å–º–µ–Ω–∞", "üåô");
    }
    
    // –ü–æ–ª—É—á–∞–µ–º –±–æ–Ω—É—Å –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–∞ –∏ –¥–µ—Ç–∞–ª–∏ –∏–∑ –¥–∞–Ω–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–∞
    const mentorBonus = data.totals ? data.totals.totalMentorBonus || 0 : 0;
    const mentorBonusDetails = data.mentorBonusDetails || { trainees: [], isTrainee: false, mentor: null };
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—É—é –∫–∞—Ä—Ç–æ—á–∫—É –æ –±–æ–Ω—É—Å–µ –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–∞ –µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ (—Ç–æ–ª—å–∫–æ –¥–ª—è —à—Ç–∞—Ç–Ω—ã—Ö)
    let mentorBonusInfoHTML = "";
    
    if (!isOutsourcing && mentorBonus > 0) {
      if (mentorBonusDetails.isTrainee && mentorBonusDetails.mentor) {
        mentorBonusInfoHTML = `
          <div class="stat-card" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 2px solid #0ea5e9; margin-bottom: 16px;">
            <p style="text-align: center; font-weight: bold; color: #0369a1; margin: 0;"><strong>üë®‚Äçüéì –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–∞—Å—Ç–∞–≤–Ω–∏—á–µ—Å—Ç–≤–µ</strong></p>
            <p style="margin: 8px 0 0 0;"><strong>üë®‚Äçüè´ –í–∞—à –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫:</strong> ${mentorBonusDetails.mentor}</p>
            <p style="margin: 8px 0 0 0;"><strong>üí∞ –ë–æ–Ω—É—Å –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–∞ –∑–∞ –≤–∞—à—É —Ä–∞–±–æ—Ç—É:</strong> ${mentorBonus.toFixed(2)} ‚ÇΩ</p>
            <p style="margin: 8px 0 0 0; font-size: 13px; color: #6b7280;">
              ‚ÑπÔ∏è –ó–∞ –∫–∞–∂–¥—É—é –≤–∞—à—É —Å–º–µ–Ω—É –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫ –ø–æ–ª—É—á–∞–µ—Ç —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –±–æ–Ω—É—Å 1750‚ÇΩ. –≠—Ç–æ –º–æ—Ç–∏–≤–∏—Ä—É–µ—Ç –µ–≥–æ –ø–æ–º–æ–≥–∞—Ç—å –≤–∞–º —Ä–∞–∑–≤–∏–≤–∞—Ç—å—Å—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ.
            </p>
          </div>
        `;
      } else if (mentorBonusDetails.trainees && mentorBonusDetails.trainees.length > 0) {
        const traineesText = mentorBonusDetails.trainees.join(', ');
        mentorBonusInfoHTML = `
          <div class="stat-card" style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border: 2px solid #10b981; margin-bottom: 16px;">
            <p style="text-align: center; font-weight: bold; color: #065f46; margin: 0;"><strong>üë®‚Äçüè´ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–∞—Å—Ç–∞–≤–Ω–∏—á–µ—Å—Ç–≤–µ</strong></p>
            <p style="margin: 8px 0 0 0;"><strong>üë®‚Äçüéì –í–∞—à–∏ —Å—Ç–∞–∂–µ—Ä—ã:</strong> ${traineesText}</p>
            <p style="margin: 8px 0 0 0;"><strong>üí∞ –û–±—â–∏–π –±–æ–Ω—É—Å –∑–∞ –Ω–∞—Å—Ç–∞–≤–Ω–∏—á–µ—Å—Ç–≤–æ:</strong> ${mentorBonus.toFixed(2)} ‚ÇΩ</p>
            <p style="margin: 8px 0 0 0; font-size: 13px; color: #6b7280;">
              ‚ÑπÔ∏è –ó–∞ –∫–∞–∂–¥–æ–≥–æ —Ä–∞–±–æ—Ç–∞—é—â–µ–≥–æ —Å—Ç–∞–∂–µ—Ä–∞ –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ 1750‚ÇΩ –∑–∞ —Å–º–µ–Ω—É. –í—Å–µ–≥–æ —Å—Ç–∞–∂–µ—Ä–æ–≤ —Ä–∞–±–æ—Ç–∞–ª–æ: ${mentorBonusDetails.trainees.length}
            </p>
          </div>
        `;
      }
    }
    
    container.innerHTML = mentorBonusInfoHTML + cardsHTML;
    
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ä–µ–¥–Ω—è—é —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å

    
    
    // üåô –ò–°–ü–û–õ–¨–ó–£–ï–ú –ò–¢–û–ì–ò –û–¢ BACKEND'–ê
    const dayTotals = data.dayTotals || { totalWage: 0, totalRepackaged: 0, totalStickered: 0 };
    const nightTotals = data.nightTotals || { totalWage: 0, totalRepackaged: 0, totalStickered: 0 };
    const staffTotals = data.staffTotals || { totalWage: 0, totalRepackaged: 0, totalStickered: 0 };
    const traineeTotals = data.traineeTotals || { totalWage: 0, totalRepackaged: 0, totalStickered: 0 };
    const totalTotals = data.totals || { totalWage: 0, totalRepackaged: 0, totalStickered: 0, totalMentorBonus: 0 };
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Å—Ç—Ä–æ–∫—É —Å —Ä–∞–∑–±–∏–≤–∫–æ–π
    let totalText;
    
    if (isOutsourcing) {
      // –î–ª—è –∞—É—Ç—Å–æ—Ä—Å–∏–Ω–≥–∞ - –±–µ–∑ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞—Ä–∞–±–æ—Ç–∫–µ
      totalText = `üìä –í—Å–µ–≥–æ –∑–∞ –¥–µ–Ω—å: üì¶ –ü–µ—Ä–µ—É–ø–∞–∫.: ${totalTotals.totalRepackaged} —à—Ç | üè∑Ô∏è –ú–∞—Ä–∫–∏—Ä.: ${totalTotals.totalStickered} —à—Ç`;
    } else {
      // –î–ª—è —à—Ç–∞—Ç–Ω—ã—Ö - —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∑–∞—Ä–∞–±–æ—Ç–∫–µ
      totalText = `üíµ –í—Å–µ–≥–æ –∑–∞ –¥–µ–Ω—å: ${totalTotals.totalWage.toFixed(2)} ‚ÇΩ`;
      
      // –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑–±–∏–≤–∫—É –ø–æ —Å–º–µ–Ω–∞–º –µ—Å–ª–∏ –µ—Å—Ç—å –æ–±–µ
      if (dayRecords.length > 0 && nightRecords.length > 0) {
        totalText += ` (‚òÄÔ∏è –î–µ–Ω—å: ${dayTotals.totalWage.toFixed(2)} ‚ÇΩ | üåô –ù–æ—á—å: ${nightTotals.totalWage.toFixed(2)} ‚ÇΩ)`;
      }
      
      // –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑–±–∏–≤–∫—É –ø–æ —Å—Ç–∞—Ç—É—Å—É –µ—Å–ª–∏ –µ—Å—Ç—å –∏ —à—Ç–∞—Ç–Ω—ã–µ –∏ —Å—Ç–∞–∂–µ—Ä—ã
      if (staffRecords.length > 0 && traineeRecords.length > 0) {
        totalText += ` (üë• –®—Ç–∞—Ç: ${staffTotals.totalWage.toFixed(2)} ‚ÇΩ | üë®‚Äçüéì –°—Ç–∞–∂–µ—Ä—ã: ${traineeTotals.totalWage.toFixed(2)} ‚ÇΩ)`;
      }
      
      totalText += ` | üì¶ –ü–µ—Ä–µ—É–ø–∞–∫.: ${totalTotals.totalRepackaged} —à—Ç | üè∑Ô∏è –ú–∞—Ä–∫–∏—Ä.: ${totalTotals.totalStickered} —à—Ç`;
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—é –æ –±–æ–Ω—É—Å–µ –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è —à—Ç–∞—Ç–Ω—ã—Ö)
    if (!isOutsourcing && mentorBonus > 0) {
      if (mentorBonusDetails.isTrainee && mentorBonusDetails.mentor) {
        totalText += ` | üë®‚Äçüè´ –ë–æ–Ω—É—Å –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–∞ ${mentorBonusDetails.mentor}: ${mentorBonus.toFixed(2)} ‚ÇΩ`;
      } else if (mentorBonusDetails.trainees && mentorBonusDetails.trainees.length > 0) {
        const traineesText = mentorBonusDetails.trainees.join(', ');
        totalText += ` | üë®‚Äçüè´ –ë–æ–Ω—É—Å –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–∞: ${mentorBonus.toFixed(2)} ‚ÇΩ (–∑–∞ —Å—Ç–∞–∂–µ—Ä–æ–≤: ${traineesText})`;
      }
    }
    
    totalElem.textContent = totalText;

    if (selectedOperation) {
      totalElem.textContent += ` | üîç –§–∏–ª—å—Ç—Ä: ${selectedOperation}`;
    }

    if (data.logs && data.logs.length) {
      logElem.innerHTML = `
        <h4>üîç –õ–æ–≥–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏:</h4>
        <pre style="font-size:13px; background:#f3f4f6; padding:10px; border-radius:8px; overflow-x:auto;">${data.logs.join('\n')}</pre>
      `;
    }

    // –ö–Ω–æ–ø–∫–∞ closeBtn —É–∂–µ –æ–±—ä—è–≤–ª–µ–Ω–∞ –≤ –Ω–∞—á–∞–ª–µ —Ñ—É–Ω–∫—Ü–∏–∏
    if (closeBtn) closeBtn.style.display = "inline-block";

  } catch (error) {
    showTemporaryNotification("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: " + error.message, "error");
    
    // –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
    const container = document.getElementById("statsCards");
    const totalElem = document.getElementById("totalWage");
    if (container) container.innerHTML = '<p style="text-align:center; color:red;">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>';
    if (totalElem) totalElem.textContent = ""; // –û—á–∏—â–∞–µ–º –∏—Ç–æ–≥ –ø—Ä–∏ –æ—à–∏–±–∫–µ
    
  } finally {
    isStatsLoading = false;
    
    // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É "–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É"
    if (showBtn) {
      showBtn.disabled = false;
      showBtn.textContent = "üìä –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É";
      showBtn.style.opacity = "1";
    }
    
    // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É "–ó–∞–∫—Ä—ã—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É"
    if (closeBtn) {
      closeBtn.disabled = false;
      closeBtn.style.opacity = "1";
      closeBtn.style.cursor = "pointer";
    }
  }
}



window.addEventListener("DOMContentLoaded", async () => {
  // üîí –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û–ï –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ —Ñ–æ—Ä–º—ã –≤—Ö–æ–¥–∞
  document.getElementById("loginContainer").style.display = "block";
  document.getElementById("tabContainer").style.display = "none";
  document.getElementById("appContainer").style.display = "none";
  document.getElementById("statsContainer").style.display = "none";
  document.getElementById("profileContainer").style.display = "none";
  document.getElementById("ratesContainer").style.display = "none";
  document.getElementById("adminContainer").style.display = "none";
  document.getElementById("mySalaryContainer").style.display = "none";
  document.getElementById("costAnalysisContainer").style.display = "none";
  document.getElementById("traineeManagementContainer").style.display = "none";
  document.getElementById("duplicatesContainer").style.display = "none";
  document.getElementById("bottomNav").style.display = "none";

  // üéØ –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –≤ –ø–æ–ª—è—Ö –≤—Ö–æ–¥–∞
  const loginField = document.getElementById("login");
  const passwordField = document.getElementById("password");
  
  if (loginField) {
    loginField.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        passwordField.focus();
      }
    });
  }
  
  if (passwordField) {
    passwordField.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        const loginBtn = document.getElementById("loginBtn");
        if (loginBtn && !loginBtn.disabled) {
          handleLogin();
        }
      }
    });
  }

  // üöÄ –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–µ–π —É–ø–∞–∫–æ–≤–∫–∏ –∏–∑ –∫—ç—à–∞ –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
  preloadPackingModels();
  
  await loadEditFormDictionaries();
  await loadPackingModels();

  const savedUser = localStorage.getItem("currentUser");
  const savedRole = localStorage.getItem("currentUserRole");

  // ‚õî –°–±—Ä–æ—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤—Ö–æ–¥–∞
  if (savedUser || savedRole) {
    localStorage.removeItem("currentUser");
    localStorage.removeItem("currentUserRole");
  }
  
  // üîÑ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π —Å–±—Ä–æ—Å –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
  currentUser = "";
  currentUserRole = "user";
  
  // üîÑ –û—á–∏—Å—Ç–∫–∞ CSS –∫–ª–∞—Å—Å–æ–≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
  const allTabButtons = ["tabProfile", "tabApp", "tabStats", "tabRates", "tabMySalary", "tabCostAnalysis", "tabTraineeManagement", "tabDuplicates", "tabAdmin"];
  allTabButtons.forEach(id => {
    const btn = document.getElementById(id);
    if (btn) {
      btn.classList.remove("admin-hidden", "admin-visible");
      btn.style.display = "";
      btn.style.visibility = "";
      btn.style.width = "";
      btn.style.padding = "";
      btn.style.margin = "";
    }
  });

  if (!currentUser) {
    document.getElementById("login").focus();
    document.getElementById("loginContainer").style.display = "block";
    document.getElementById("tabContainer").style.display = "none";
    document.getElementById("profileContainer").style.display = "none";
    document.getElementById("bottomNav").style.display = "none";
    return;
  }

  // ‚ùå –£–î–ê–õ–ï–ù –∫–æ–¥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ - —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ handleLogin()

  // ‚ùå –£–î–ê–õ–ï–ù –≤–µ—Å—å –∫–æ–¥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π - —Ç–µ–ø–µ—Ä—å —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ handleLogin()

  // üóëÔ∏è –ü–æ–¥—Å–∫–∞–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è —É–±—Ä–∞–Ω–∞ - —Ç–µ–ø–µ—Ä—å —Ç–æ–ª—å–∫–æ —Ä—É—á–Ω–æ–π –≤–≤–æ–¥
});

async function loadPackingModels() {
  const select = document.getElementById("profilePackingModel");
  if (!select) return;
  
  // üõ°Ô∏è –ó–∞—â–∏—Ç–∞ –æ—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
  if (isLoadingPackingModels) {
    
    return;
  }
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
  if (isCacheValid(dataCache.packingModels)) {
    
    populatePackingModelsSelect(dataCache.packingModels.data);
    return;
  }
  
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –∑–∞–≥—Ä—É–∑–∫–∏
  isLoadingPackingModels = true;
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ select –ø—É—Å—Ç–æ–π
  if (select.options.length <= 1) {
  select.innerHTML = '<option value="">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</option>';
  }
  
  try {
    const res = await fetch(`${scriptURL}?type=packingModels`);
    const data = await res.json();
    const models = data.models || [];
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
    dataCache.packingModels = {
      data: models,
      timestamp: Date.now()
    };
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –¥–ª—è –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–≥–æ –∫—ç—à–∞
    try {
      localStorage.setItem('packingModelsCache', JSON.stringify({
        data: models,
        timestamp: Date.now()
      }));
    } catch (e) {
      console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–æ–¥–µ–ª–∏ —É–ø–∞–∫–æ–≤–∫–∏ –≤ localStorage");
    }
    
    populatePackingModelsSelect(models);
    
    
  } catch (err) {
    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–µ–π —É–ø–∞–∫–æ–≤–∫–∏:", err);
    // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ localStorage –∫–∞–∫ fallback
    const fallbackData = tryLoadPackingModelsFromStorage();
    if (fallbackData) {
      populatePackingModelsSelect(fallbackData);
      
    } else {
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ select –±—ã–ª –ø—É—Å—Ç–æ–π
      if (select.options.length <= 1) {
      select.innerHTML = '<option value="">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
    }
    }
  } finally {
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –∑–∞–≥—Ä—É–∑–∫–∏
    isLoadingPackingModels = false;
  }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è select'–∞
function populatePackingModelsSelect(models) {
  const select = document.getElementById("profilePackingModel");
  if (!select) return;
  
  // üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
  const currentValue = select.value;
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –ª–∏ –¥–∞–Ω–Ω—ã–µ (–∏–∑–±–µ–≥–∞–µ–º –Ω–µ–Ω—É–∂–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π)
  const currentOptions = Array.from(select.options).slice(1).map(opt => opt.value);
  const newModels = models || [];
  const hasChanges = JSON.stringify(currentOptions.sort()) !== JSON.stringify(newModels.sort());
  
  // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –∏ select —É–∂–µ –∑–∞–ø–æ–ª–Ω–µ–Ω, –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ–º
  if (!hasChanges && select.options.length > 1) {
    
    return;
  }
  
  // –û—á–∏—â–∞–µ–º –∏ –∑–∞–ø–æ–ª–Ω—è–µ–º –∑–∞–Ω–æ–≤–æ
  select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>';
  newModels.forEach(model => {
    const opt = document.createElement("option");
    opt.value = model;
    opt.textContent = model;
    select.appendChild(opt);
  });
  
  // üîÑ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –Ω–æ–≤–æ–º —Å–ø–∏—Å–∫–µ
  if (currentValue && newModels.includes(currentValue)) {
    select.value = currentValue;
    
  } else if (currentValue && !newModels.includes(currentValue)) {
    console.warn(`‚ö†Ô∏è –†–∞–Ω–µ–µ –≤—ã–±—Ä–∞–Ω–Ω–∞—è –º–æ–¥–µ–ª—å "${currentValue}" –±–æ–ª—å—à–µ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞`);
  }
}

// –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ localStorage –∫–∞–∫ fallback
function tryLoadPackingModelsFromStorage() {
  try {
    const cached = localStorage.getItem('packingModelsCache');
    if (cached) {
      const data = JSON.parse(cached);
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –Ω–µ —Å—Ç–∞—Ä—à–µ 24 —á–∞—Å–æ–≤
      const maxAge = 24 * 60 * 60 * 1000; // 24 —á–∞—Å–∞
      if (Date.now() - data.timestamp < maxAge) {
    
        return data.data;
      }
    }
  } catch (e) {
    console.warn("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑ localStorage:", e);
  }
  return null;
}

// –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–µ–π —É–ø–∞–∫–æ–≤–∫–∏ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
function preloadPackingModels() {
  // üõ°Ô∏è –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤
  if (isLoadingPackingModels) {
    
    return;
  }
  
  // –°–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ localStorage
  const cachedData = tryLoadPackingModelsFromStorage();
  if (cachedData) {
    dataCache.packingModels = {
      data: cachedData,
      timestamp: Date.now() - 1000 // –°—Ç–∞–≤–∏–º —á—É—Ç—å —Å—Ç–∞—Ä—à–µ, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏–ª–æ—Å—å –≤ —Ñ–æ–Ω–µ
    };
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º select –µ—Å–ª–∏ –æ–Ω —É–∂–µ –µ—Å—Ç—å
    setTimeout(() => {
      const select = document.getElementById("profilePackingModel");
      if (select && select.options.length <= 1) { // –ï—Å–ª–∏ –µ—â–µ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω
        populatePackingModelsSelect(cachedData);
  
      }
    }, 100);
  }
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –≤ —Ñ–æ–Ω–µ –¥–ª—è —Å–≤–µ–∂–µ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö (—Å –∑–∞–¥–µ—Ä–∂–∫–æ–π)
  setTimeout(() => {
    if (!isCacheValid(dataCache.packingModels) && !isLoadingPackingModels) {

      loadPackingModels().catch(err => {
        console.warn("–§–æ–Ω–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π —É–ø–∞–∫–æ–≤–∫–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å:", err);
      });
    }
  }, 2000); // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
}

// === –§–£–ù–ö–¶–ò–Ø: –ó–∞–≥—Ä—É–∑–∫–∞ –æ–∫–ª–∞–¥–∞ —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º ===
async function getSalaryWithCache(employee) {
  if (!employee) {
    console.warn("getSalaryWithCache: employee –ø—É—Å—Ç–æ–π");
    return null;
  }

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
  const cached = dataCache.salaries[employee];
  if (cached && (Date.now() - cached.timestamp) < CACHE_DURATION) {

    return cached.salary;
  }

  // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ localStorage
  const localData = tryLoadSalaryFromStorage(employee);
  if (localData !== null) {
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω—ã–π –∫—ç—à
    dataCache.salaries[employee] = {
      salary: localData,
      timestamp: Date.now() - 1000 // –ß—É—Ç—å —Å—Ç–∞—Ä—à–µ, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏–ª–æ—Å—å –≤ —Ñ–æ–Ω–µ
    };
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –≤ —Ñ–æ–Ω–µ
    setTimeout(() => {
      fetchSalaryFromServer(employee);
    }, 500);
    

    return localData;
  }

  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å —Å–µ—Ä–≤–µ—Ä–∞
  return await fetchSalaryFromServer(employee);
}

// –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –æ–∫–ª–∞–¥–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞
async function fetchSalaryFromServer(employee) {
  try {

    
    const res = await fetch(`${scriptURL}?type=getSalary&employee=${encodeURIComponent(employee)}`);
    
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    }
    
    const data = await res.json();
    const salary = String(data.salary || "");
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
    dataCache.salaries[employee] = {
      salary: salary,
      timestamp: Date.now()
    };
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
    saveSalaryToStorage(employee, salary);
    

    return salary;
    
  } catch (err) {
    console.error(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–∫–ª–∞–¥–∞ –¥–ª—è "${employee}":`, err);
    
    // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ localStorage –∫–∞–∫ fallback
    const fallback = tryLoadSalaryFromStorage(employee);
    if (fallback !== null) {
  
      return fallback;
    }
    
    return null;
  }
}

// üåô –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –æ–∫–ª–∞–¥–∞ —Å —É—á–µ—Ç–æ–º —Å–º–µ–Ω—ã
async function fetchSalaryByShift(employee, shiftType) {
  try {
    const res = await fetch(`${scriptURL}?type=getSalaryByShift&employee=${encodeURIComponent(employee)}&shift=${encodeURIComponent(shiftType)}`);
    
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    }
    
    const data = await res.json();
    const salary = String(data.salary || "");
    
    console.log(`üåô –ó–∞–≥—Ä—É–∂–µ–Ω –æ–∫–ª–∞–¥ –¥–ª—è ${employee} (${shiftType}): ${salary}`);
    
    return salary;
    
  } catch (err) {
    console.error(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–∫–ª–∞–¥–∞ –¥–ª—è "${employee}" (${shiftType}):`, err);
    return null;
  }
}

// üåô –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–∫–ª–∞–¥–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–º–µ–Ω—ã
async function updateSalaryForShift(shiftType) {
  const currentUser = localStorage.getItem("currentUser");
  const payType = document.getElementById("profilePayType").value;
  const salaryInput = document.getElementById("profileSalary");
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –æ–∫–ª–∞–¥ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω "–û–∫–ª–∞–¥ + —Å–¥–µ–ª–∫–∞"
  if (payType !== "–û–∫–ª–∞–¥ + —Å–¥–µ–ª–∫–∞" || !currentUser || !shiftType) {
    return;
  }
  
  try {
    const salary = await fetchSalaryByShift(currentUser, shiftType);
    if (salary !== null) {
      salaryInput.value = salary;
      console.log(`‚úÖ –û–∫–ª–∞–¥ –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è —Å–º–µ–Ω—ã "${shiftType}": ${salary}`);
    }
  } catch (err) {
    console.error("‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–∫–ª–∞–¥–∞:", err);
  }
}

// üåô –§—É–Ω–∫—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è –¥–ª—è –∞—É—Ç—Å–æ—Ä—Å–µ—Ä–æ–≤
function setupOutsourcingProfile() {
  console.log("üöö –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è –∞—É—Ç—Å–æ—Ä—Å–µ—Ä–∞");
  
  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å "–ê—É—Ç—Å–æ—Ä—Å–∏–Ω–≥"
  const statusSelect = document.getElementById("employeeStatus");
  if (statusSelect) {
    statusSelect.value = "–ê—É—Ç—Å–æ—Ä—Å–∏–Ω–≥";
    statusSelect.disabled = true; // –ë–ª–æ–∫–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ
    statusSelect.style.backgroundColor = "#f3f4f6";
    statusSelect.style.cursor = "not-allowed";
  }
  
  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∏–ø –æ–ø–ª–∞—Ç—ã "–°–¥–µ–ª–∫–∞"
  const payTypeSelect = document.getElementById("profilePayType");
  if (payTypeSelect) {
    // –°–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–ª—è–µ–º –æ–ø—Ü–∏–∏ –¥–ª—è –∞—É—Ç—Å–æ—Ä—Å–∏–Ω–≥–∞
    updatePayTypeOptions("–ê—É—Ç—Å–æ—Ä—Å–∏–Ω–≥");
    
    // –ó–∞—Ç–µ–º —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º "–°–¥–µ–ª–∫–∞"
    payTypeSelect.value = "–°–¥–µ–ª–∫–∞";
    payTypeSelect.disabled = true; // –ë–ª–æ–∫–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ
    payTypeSelect.style.backgroundColor = "#f3f4f6";
    payTypeSelect.style.cursor = "not-allowed";
  }
  
  // –°–∫—Ä—ã–≤–∞–µ–º –±–ª–æ–∫ –æ–∫–ª–∞–¥–∞ –¥–ª—è –∞—É—Ç—Å–æ—Ä—Å–µ—Ä–æ–≤
  const salaryBlock = document.getElementById("salaryBlock");
  if (salaryBlock) {
    salaryBlock.style.display = "none";
  }
  
  // –°–∫—Ä—ã–≤–∞–µ–º –Ω–µ–Ω—É–∂–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏ –¥–ª—è –∞—É—Ç—Å–æ—Ä—Å–µ—Ä–æ–≤ (–æ—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø–∏—Å–µ–π)
  const tabMySalary = document.getElementById("tabMySalary");
  const tabRates = document.getElementById("tabRates");
  
  if (tabMySalary) tabMySalary.style.display = "none";
  if (tabRates) tabRates.style.display = "none";
  
  // üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –û–°–¢–ê–ï–¢–°–Ø –î–û–°–¢–£–ü–ù–û–ô –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–µ–π
  
  // –°–∫—Ä—ã–≤–∞–µ–º –±–ª–æ–∫–∏ —Ç–∞—Ä–∏—Ñ–æ–≤ –∏ —Ä–∞—Å—á–µ—Ç–∞ –æ–ø–ª–∞—Ç—ã –¥–ª—è –∞—É—Ç—Å–æ—Ä—Å–µ—Ä–æ–≤
  const rateInfo = document.getElementById("rateInfo");
  const calcBlock = document.getElementById("calcBlock");
  
  if (rateInfo) rateInfo.style.display = "none";
  if (calcBlock) calcBlock.style.display = "none";
  
  // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∞—É—Ç—Å–æ—Ä—Å–µ—Ä–∞
  addOutsourcingIndicator();
  
  console.log("‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –∞—É—Ç—Å–æ—Ä—Å–µ—Ä–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω");
}

// üåô –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∞—É—Ç—Å–æ—Ä—Å–µ—Ä–∞
function addOutsourcingIndicator() {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —É–∂–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
  if (document.getElementById("outsourcingIndicator")) return;
  
  // –°–æ–∑–¥–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
  const indicator = document.createElement("div");
  indicator.id = "outsourcingIndicator";
  indicator.innerHTML = "üöö –ê—É—Ç—Å–æ—Ä—Å–∏–Ω–≥";
  indicator.style.cssText = `
    background: linear-gradient(135deg, #f59e0b, #d97706);
    color: white;
    padding: 8px 16px;
    border-radius: 12px;
    font-weight: bold;
    text-align: center;
    margin-bottom: 16px;
    box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
    border: 2px solid #fbbf24;
  `;
  
  // –í—Å—Ç–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ –ø—Ä–æ—Ñ–∏–ª—è
  const profileContainer = document.getElementById("profileContainer");
  const firstChild = profileContainer.querySelector("h2");
  if (firstChild) {
    firstChild.insertAdjacentElement("afterend", indicator);
  }
}

// üåô –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∞—É—Ç—Å–æ—Ä—Å–µ—Ä–∞
function clearOutsourcingSettings() {
  // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–ª—è
  const statusSelect = document.getElementById("employeeStatus");
  if (statusSelect) {
    statusSelect.disabled = false;
    statusSelect.style.backgroundColor = "";
    statusSelect.style.cursor = "";
  }
  
  const payTypeSelect = document.getElementById("profilePayType");
  if (payTypeSelect) {
    payTypeSelect.disabled = false;
    payTypeSelect.style.backgroundColor = "";
    payTypeSelect.style.cursor = "";
  }
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫ –æ–∫–ª–∞–¥–∞
  const salaryBlock = document.getElementById("salaryBlock");
  if (salaryBlock) {
    salaryBlock.style.display = "none"; // –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  }
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∫–ª–∞–¥–∫–∏ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  const tabMySalary = document.getElementById("tabMySalary");
  const tabStats = document.getElementById("tabStats");
  const tabRates = document.getElementById("tabRates");
  
  if (tabMySalary) tabMySalary.style.display = "inline-block";
  if (tabStats) tabStats.style.display = "inline-block"; 
  if (tabRates) tabRates.style.display = "inline-block";
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫–∏ —Ç–∞—Ä–∏—Ñ–æ–≤ –∏ —Ä–∞—Å—á–µ—Ç–∞ –æ–ø–ª–∞—Ç—ã –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  const rateInfo = document.getElementById("rateInfo");
  const calcBlock = document.getElementById("calcBlock");
  
  // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ö –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ, –ø—É—Å—Ç—å updateRateDisplay() —Ä–µ—à–∞–µ—Ç
  if (rateInfo) rateInfo.style.display = "";
  if (calcBlock) calcBlock.style.display = "";
  
  // –£–¥–∞–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∞—É—Ç—Å–æ—Ä—Å–µ—Ä–∞
  const indicator = document.getElementById("outsourcingIndicator");
  if (indicator) {
    indicator.remove();
  }
}

// –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–∫–ª–∞–¥–∞ –≤ localStorage
function saveSalaryToStorage(employee, salary) {
  try {
    const salariesCache = JSON.parse(localStorage.getItem('salariesCache') || '{}');
    salariesCache[employee] = {
      salary: salary,
      timestamp: Date.now()
    };
    localStorage.setItem('salariesCache', JSON.stringify(salariesCache));
  } catch (e) {
    console.warn(`–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–∫–ª–∞–¥ –¥–ª—è "${employee}" –≤ localStorage:`, e);
  }
}

// –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –æ–∫–ª–∞–¥–∞ –∏–∑ localStorage
function tryLoadSalaryFromStorage(employee) {
  try {
    const salariesCache = JSON.parse(localStorage.getItem('salariesCache') || '{}');
    const cached = salariesCache[employee];
    
    if (cached) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –Ω–µ —Å—Ç–∞—Ä—à–µ 24 —á–∞—Å–æ–≤
      const maxAge = 24 * 60 * 60 * 1000; // 24 —á–∞—Å–∞
      if (Date.now() - cached.timestamp < maxAge) {
        return cached.salary;
      }
    }
  } catch (e) {
    console.warn(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ–∫–ª–∞–¥–∞ "${employee}" –∏–∑ localStorage:`, e);
  }
  return null;
}

// –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –æ–∫–ª–∞–¥–∞ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function preloadCurrentUserSalary() {
  const currentUser = localStorage.getItem("currentUser");
  if (currentUser) {
    // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∂–∞–µ–º –æ–∫–ª–∞–¥ –∏–∑ localStorage
    const cachedSalary = tryLoadSalaryFromStorage(currentUser);
    if (cachedSalary !== null) {
      dataCache.salaries[currentUser] = {
        salary: cachedSalary,
        timestamp: Date.now() - 1000 // –ß—É—Ç—å —Å—Ç–∞—Ä—à–µ –¥–ª—è —Ñ–æ–Ω–æ–≤–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
      };
  
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –≤ —Ñ–æ–Ω–µ
      setTimeout(() => {
        fetchSalaryFromServer(currentUser);
      }, 2000);
    }
  }
}

// –§—É–Ω–∫—Ü–∏—è "—É–º–Ω–æ–≥–æ" –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–ª—è –æ–∫–ª–∞–¥–∞
function smartFillSalaryField() {
  const currentUser = localStorage.getItem("currentUser");
  const salaryInput = document.getElementById("profileSalary");
  
  if (!currentUser || !salaryInput) return;
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –æ–∫–ª–∞–¥ –≤ –∫—ç—à–µ
  const cached = dataCache.salaries[currentUser];
  if (cached && (Date.now() - cached.timestamp) < CACHE_DURATION) {
    salaryInput.value = cached.salary;

    return;
  }
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º localStorage
  const localSalary = tryLoadSalaryFromStorage(currentUser);
  if (localSalary !== null) {
    salaryInput.value = localSalary;

    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –≤ —Ñ–æ–Ω–µ
    dataCache.salaries[currentUser] = {
      salary: localSalary,
      timestamp: Date.now() - 1000
    };
    
    setTimeout(() => {
      fetchSalaryFromServer(currentUser).then(newSalary => {
        if (newSalary && newSalary !== localSalary) {
          salaryInput.value = newSalary;
      
        }
      });
    }, 1000);
  }
}

// üöÄ –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ —É–±—Ä–∞–Ω–∞ - –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –≤ DOMContentLoaded
// preloadPackingModels(); // –£–ë–†–ê–ù–û: –¥—É–±–ª–∏—Ä–æ–≤–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫—É

function openUpdateAllModal() {
  // –û—á–∏—Å—Ç–∫–∞
  document.getElementById("updateAllResult").textContent = "";
  document.getElementById("updateAllModal").style.display = "flex";
  // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–∞—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π)
  const today = new Date();
  const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
  document.getElementById("updateAllStart").value = weekAgo.toISOString().split("T")[0];
  document.getElementById("updateAllEnd").value = today.toISOString().split("T")[0];
}

function closeUpdateAllModal() {
  document.getElementById("updateAllModal").style.display = "none";
}

// –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —á–µ–∫–±–æ–∫—Å–∞–º–∏ –≤—ã–±–æ—Ä–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
function selectAllUpdates() {
  document.getElementById("updateSeniorsSalary").checked = true;
  document.getElementById("updateStaffIndicators").checked = true;
  document.getElementById("updateOutsourcingIndicators").checked = true;
}

function selectNoneUpdates() {
  document.getElementById("updateSeniorsSalary").checked = false;
  document.getElementById("updateStaffIndicators").checked = false;
  document.getElementById("updateOutsourcingIndicators").checked = false;
}

function selectOnlySeniors() {
  document.getElementById("updateSeniorsSalary").checked = true;
  document.getElementById("updateStaffIndicators").checked = false;
  document.getElementById("updateOutsourcingIndicators").checked = false;
}

// –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–±–æ—Ä–æ—á–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
async function submitSelectiveUpdate() {
  const btn = document.getElementById("submitUpdateAllBtn");
  const resultBox = document.getElementById("updateAllResult");

  // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–Ω–æ–ø–∫–∏ –∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
  btn.disabled = true;
  const originalText = btn.textContent;
  btn.textContent = "‚è≥ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...";
  resultBox.textContent = "";

  const start = document.getElementById("updateAllStart").value;
  const end = document.getElementById("updateAllEnd").value;

  if (!start || !end) {
    resultBox.textContent = "‚ùó –£–∫–∞–∂–∏—Ç–µ –æ–±–µ –¥–∞—Ç—ã!";
    btn.disabled = false;
    btn.textContent = originalText;
    return;
  }

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤—ã–±—Ä–∞–Ω–æ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  const updateSeniors = document.getElementById("updateSeniorsSalary").checked;
  const updateStaff = document.getElementById("updateStaffIndicators").checked;
  const updateOutsourcing = document.getElementById("updateOutsourcingIndicators").checked;

  if (!updateSeniors && !updateStaff && !updateOutsourcing) {
    resultBox.textContent = "‚ùó –í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è!";
    btn.disabled = false;
    btn.textContent = originalText;
    return;
  }

  try {
    let resultMessage = "üöÄ –ù–∞—á–∏–Ω–∞—é –≤—ã–±–æ—Ä–æ—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ...\n\n";
    resultBox.textContent = resultMessage;
    
    // 1. –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞—Ä–ø–ª–∞—Ç—É —Å—Ç–∞—Ä—à–∏—Ö —Å–º–µ–Ω (–µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ)
    if (updateSeniors) {
      resultBox.textContent = resultMessage + "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞—Ä–ø–ª–∞—Ç—ã —Å—Ç–∞—Ä—à–∏—Ö —Å–º–µ–Ω...";
      
      const seniorsResponse = await fetch(`${scriptURL}`, {
        method: 'POST',
        body: new URLSearchParams({
          type: 'processAllSeniorsForPeriod',
          start: start,
          end: end
        })
      });
      const seniorsData = await seniorsResponse.json();
      
      if (seniorsData.status === 'success') {
        resultMessage += `‚úÖ –°—Ç–∞—Ä—à–∏–µ —Å–º–µ–Ω—ã: –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${seniorsData.processedCount || 0} –∑–∞–ø–∏—Å–µ–π\n`;
      } else {
        resultMessage += `‚ö†Ô∏è –°—Ç–∞—Ä—à–∏–µ —Å–º–µ–Ω—ã: ${seniorsData.message || '–æ—à–∏–±–∫–∞'}\n`;
      }
    } else {
      resultMessage += "‚è≠Ô∏è –ó–∞—Ä–ø–ª–∞—Ç—ã —Å—Ç–∞—Ä—à–∏—Ö —Å–º–µ–Ω: –ø—Ä–æ–ø—É—â–µ–Ω–æ\n";
    }
    
    // 2. –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ (–µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ —á—Ç–æ-—Ç–æ –∏–∑ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π)
    if (updateStaff || updateOutsourcing) {
      resultBox.textContent = resultMessage + "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π...";
      
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —á–µ–∫–±–æ–∫—Å–æ–≤
      let updateType = "";
      if (updateStaff && updateOutsourcing) {
        updateType = "both"; // –æ–±–Ω–æ–≤–ª—è–µ–º –∏ —à—Ç–∞—Ç –∏ –∞—É—Ç—Å–æ—Ä—Å–∏–Ω–≥
      } else if (updateStaff) {
        updateType = "staff"; // —Ç–æ–ª—å–∫–æ —à—Ç–∞—Ç
      } else if (updateOutsourcing) {
        updateType = "outsourcing"; // —Ç–æ–ª—å–∫–æ –∞—É—Ç—Å–æ—Ä—Å–∏–Ω–≥
      }
      
      const exportResponse = await fetch(`${scriptURL}?type=exportNow&date=${encodeURIComponent(start)}&endDate=${encodeURIComponent(end)}&components=${updateType}`);
      const exportResult = await exportResponse.text();
      
      if (exportResult.includes("‚úÖ")) {
        if (updateStaff && updateOutsourcing) {
          resultMessage += "‚úÖ –ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —à—Ç–∞—Ç–∞ –∏ –∞—É—Ç—Å–æ—Ä—Å–∏–Ω–≥–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã\n";
        } else if (updateStaff) {
          resultMessage += "‚úÖ –ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —à—Ç–∞—Ç–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω—ã\n";
        } else if (updateOutsourcing) {
          resultMessage += "‚úÖ –ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –∞—É—Ç—Å–æ—Ä—Å–∏–Ω–≥–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã\n";
        }
      } else {
        resultMessage += `‚ö†Ô∏è –ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏: ${exportResult}\n`;
      }
    } else {
      resultMessage += "‚è≠Ô∏è –ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏: –ø—Ä–æ–ø—É—â–µ–Ω–æ\n";
    }
    
    resultBox.style.color = '#059669';
    resultBox.textContent = resultMessage + "\nüéâ –í—ã–±–æ—Ä–æ—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!";
    
    setTimeout(closeUpdateAllModal, 5000);
    
  } catch (err) {
    console.error(err);
    resultBox.style.color = '#dc2626';
    resultBox.textContent = "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: " + err.message;
  } finally {
    btn.disabled = false;
    btn.textContent = originalText;
  }
}

// –°—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
async function submitUpdateAll() {
  // –í—ã–±–∏—Ä–∞–µ–º –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –≤—ã–±–æ—Ä–æ—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
  selectAllUpdates();
  await submitSelectiveUpdate();
}

// ========== üë®‚Äçüéì –§–£–ù–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø –°–¢–ê–ñ–ï–†–ê–ú–ò ==========

function showTraineeManagement() {
  // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –¥—Ä—É–≥–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
  document.getElementById("profileContainer").style.display = "none";
  document.getElementById("appContainer").style.display = "none";
  document.getElementById("statsContainer").style.display = "none";
  document.getElementById("adminContainer").style.display = "none";
  document.getElementById("mySalaryContainer").style.display = "none";
  document.getElementById("ratesContainer").style.display = "none";
  document.getElementById("costAnalysisContainer").style.display = "none";
  document.getElementById("duplicatesContainer").style.display = "none";
  document.getElementById("loginContainer").style.display = "none";
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç–∞–∂–µ—Ä–∞–º–∏
  document.getElementById("traineeManagementContainer").style.display = "block";
  
  // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–∫–∏ –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–æ–≤ –∏ —Å—Ç–∞–∂–µ—Ä–æ–≤ –∏ —Ç–µ–∫—É—â–∏–µ —Å–≤—è–∑–∏
  setTimeout(() => {
    loadMentorsAndTrainees();
    loadMentorshipPairs();
  }, 500);
}

function hideTraineeManagement() {
  document.getElementById("traineeManagementContainer").style.display = "none";
  
  // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
  if (currentUser && currentUserRole === "admin") {
    switchTab("admin");
  } else {
    switchTab("profile");
  }
}



async function loadMentorshipPairs() {
  const btn = document.getElementById("refreshPairsBtn");
  const container = document.getElementById("mentorshipPairsList");
  
  try {
    btn.disabled = true;
    btn.textContent = "‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...";
    
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    const response = await fetch(`${scriptURL}?type=employees`);
    const data = await response.json();
    

    
    if (!data.employees) {
      container.innerHTML = '<p style="color: #dc2626;">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>';
      return;
    }
    
    // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–æ —Å–≤—è–∑—è–º–∏ –Ω–∞—Å—Ç–∞–≤–Ω–∏—á–µ—Å—Ç–≤–∞
    const pairs = [];
    const mentorTraineePairs = new Map();
    
    data.employees.forEach(employee => {
      if (employee.mentor && employee.mentor.trim()) {
        const mentor = employee.mentor.trim();
        const trainee = employee.name.trim();
        const status = employee.status || "";
        
        // –°–æ–∑–¥–∞–µ–º –ø–∞—Ä—É –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫ -> —Å—Ç–∞–∂–µ—Ä
        if (status === "–°—Ç–∞–∂–µ—Ä") {
          const pairKey = `${mentor} ‚Üí ${trainee}`;
          mentorTraineePairs.set(pairKey, {
            mentor: mentor,
            trainee: trainee,
            status: status,
            bonusPercent: employee.bonusPercent || 0 // –ü—Ä–æ—Ü–µ–Ω—Ç –∏–∑ –∫–æ–ª–æ–Ω–∫–∏ G
          });
        }
      }
    });
    
    if (mentorTraineePairs.size === 0) {
      container.innerHTML = `
        <div style="text-align: center; padding: 40px; color: #000000;">
          <div style="font-size: 48px; margin-bottom: 16px;">üë®‚Äçüéì</div>
          <h3 style="margin: 0 0 8px 0;">–°–≤—è–∑–∏ –Ω–∞—Å—Ç–∞–≤–Ω–∏—á–µ—Å—Ç–≤–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
          <p style="margin: 0;">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é —Å–≤—è–∑—å –≤–æ –≤–∫–ª–∞–¥–∫–µ "–°–æ–∑–¥–∞—Ç—å —Å–≤—è–∑—å"</p>
        </div>
      `;
      return;
    }
    
    let html = '';
    mentorTraineePairs.forEach((pair, pairKey) => {
      html += `
        <div class="mentor-pair-card">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-weight: 600; color: #000000;">üë®‚Äçüíº ${pair.mentor} ‚Üí üë®‚Äçüéì ${pair.trainee}</div>
              <div style="font-size: 14px; color: #000000; margin-top: 4px;">
                –°—Ç–∞—Ç—É—Å: ${pair.status}
              </div>
            </div>
            <button onclick="deleteMentorshipPair('${pair.mentor}', '${pair.trainee}')" 
                    style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
              üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
            </button>
          </div>
        </div>
      `;
    });
    
    container.innerHTML = html;
    
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–≤—è–∑–µ–π:", error);
    container.innerHTML = '<p style="color: #dc2626;">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–≤—è–∑–µ–π</p>';
  } finally {
    btn.disabled = false;
    btn.textContent = "üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫";
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–≤—è–∑–∏
async function loadMentorsAndTrainees() {
  try {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–æ–≤
    const mentorsResponse = await fetch(`${scriptURL}?type=getMentors`);
      const mentorsData = await mentorsResponse.json();
    const mentors = mentorsData.mentors || [];
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞–∂–µ—Ä–æ–≤
    const traineesResponse = await fetch(`${scriptURL}?type=getTrainees`);
    const traineesData = await traineesResponse.json();
    const trainees = traineesData.trainees || [];
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ–ª–µ–∫—Ç—ã
    updateSelect('mentorSelect', mentors, '-- –í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–∞ --');
    updateSelect('traineeSelect', trainees, '-- –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞–∂–µ—Ä–∞ --');
    
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:", error);
    alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö");
  }
}



// –ö—ç—à –Ω–∞—Å—Ç—Ä–æ–µ–∫
let settingsCache = null;
let settingsCacheTimestamp = 0;
const SETTINGS_CACHE_DURATION = 5 * 60 * 1000; // 5 –º–∏–Ω—É—Ç

// –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å —Å–µ—Ä–≤–µ—Ä–∞ (—Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º)
async function getSettings() {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
  if (settingsCache && (Date.now() - settingsCacheTimestamp) < SETTINGS_CACHE_DURATION) {
    return settingsCache;
  }
  
  try {
    const response = await fetch(`${scriptURL}?type=getSettings`);
    const data = await response.json();
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
    settingsCache = data;
    settingsCacheTimestamp = Date.now();
    
    return data;
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫:", error);
    return {}; // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  }
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–µ —Å—Ç–∞–∂–µ—Ä–∞
async function getMentorInfo(traineeName) {
  try {
    const response = await fetch(`${scriptURL}?type=employees`);
    const data = await response.json();
    

    
    if (data.employees) {
      const trainee = data.employees.find(emp => emp.name === traineeName);


      
      if (trainee && trainee.mentor && trainee.status === "–°—Ç–∞–∂–µ—Ä") {
        const result = {
          mentor: trainee.mentor,
          status: trainee.status,
          bonusPercent: trainee.bonusPercent || 0 // –ü—Ä–æ—Ü–µ–Ω—Ç –±–æ–Ω—É—Å–∞ –∏–∑ –∫–æ–ª–æ–Ω–∫–∏ G
        };


        return result;
      }
    }
    return null;
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–µ:", error);
    return null;
  }
}

// –†–∞—Å—á–µ—Ç –∑–∞—Ä–ø–ª–∞—Ç—ã –∑–∞ –æ–ø–µ—Ä–∞—Ü–∏—é
function calculateOperationWage(formData) {
  const quantity = parseFloat(formData.get("quantity")) || 0;
  const operationType = formData.get("operationType");
  const volume = formData.get("volume");
  const setNumber = formData.get("setNumber");
  
  const key = (operationType && operationType.includes("–°–±–æ—Ä–∫–∞")) ? setNumber : volume;
  
  // –ù–∞—Ö–æ–¥–∏–º —Ç–∞—Ä–∏—Ñ –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ
  const matched = allRates.find(r => r.operation === operationType && r.key === key);
  
  if (matched) {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ –ª–æ–≥–∏–∫—É, —á—Ç–æ –∏ –≤ updateRateDisplay
    const packingModel = (document.getElementById("profilePackingModel")?.value || "").toLowerCase();
    const payType = localStorage.getItem("profilePayType") || "–°–¥–µ–ª–∫–∞";
    let ratePerUnit = 0;

    if (payType === "–û–∫–ª–∞–¥ + —Å–¥–µ–ª–∫–∞") {
      if (packingModel.includes("fbs") && matched.rateFBSDeal !== undefined) {
        ratePerUnit = Number(matched.rateFBSDeal);
      } else if (matched.rateDeal !== undefined) {
        ratePerUnit = Number(matched.rateDeal);
      }
    } else {
      if (packingModel.includes("fbs") && matched.rateFBS !== undefined) {
        ratePerUnit = Number(matched.rateFBS);
      } else if (matched.ratePerUnit !== undefined) {
        ratePerUnit = Number(matched.ratePerUnit);
      }
    }
    
    return quantity * ratePerUnit;
  }
  
  return 0;
}



// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ–ª–µ–∫—Ç–∞
function updateSelect(selectId, dataArray, placeholder) {
  const select = document.getElementById(selectId);
  if (!select) return;
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
  const currentValue = select.value;
  
  // –û—á–∏—â–∞–µ–º —Å–µ–ª–µ–∫—Ç
  select.innerHTML = '';
  
  // –î–æ–±–∞–≤–ª—è–µ–º placeholder
  const placeholderOption = document.createElement('option');
  placeholderOption.value = '';
  placeholderOption.textContent = placeholder;
  select.appendChild(placeholderOption);
  
  // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
  dataArray.forEach(item => {
    const option = document.createElement('option');
    option.value = item;
    option.textContent = item;
    select.appendChild(option);
  });
  
  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –≤—Å–µ –µ—â–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –Ω–æ–≤–æ–º —Å–ø–∏—Å–∫–µ
  if (currentValue && dataArray.includes(currentValue)) {
    select.value = currentValue;
  }
}



// –ü–†–û–°–¢–ê–Ø –§–£–ù–ö–¶–ò–Ø –°–û–ó–î–ê–ù–ò–Ø –°–í–Ø–ó–ò
async function createMentorshipPair() {
  const mentor = document.getElementById("mentorSelect").value;
  const trainee = document.getElementById("traineeSelect").value;
  
  if (!mentor || !trainee) {
    alert("–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–∞ –∏ —Å—Ç–∞–∂–µ—Ä–∞");
    return;
  }
  
  if (mentor === trainee) {
    alert("–ù–∞—Å—Ç–∞–≤–Ω–∏–∫ –∏ —Å—Ç–∞–∂–µ—Ä –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å –æ–¥–Ω–∏–º —á–µ–ª–æ–≤–µ–∫–æ–º");
    return;
  }
  
  try {
    const formData = new FormData();
    formData.append('currentUser', mentor);
    formData.append('partner', trainee);
    formData.append('status', '–®—Ç–∞—Ç');
    formData.append('bonusPercent', '0'); // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –±–æ–Ω—É—Å 1750‚ÇΩ –∑–∞ —Å–º–µ–Ω—É
    

    
    const response = await fetch(`${scriptURL}?type=savePair`, {
      method: 'POST',
      body: formData
    });
    
    const data = await response.json();
    

    
    if (data.success) {
      alert(`‚úÖ –°–≤—è–∑—å —Å–æ–∑–¥–∞–Ω–∞: ${mentor} ‚Üî ${trainee}\nüí∞ –ù–∞—Å—Ç–∞–≤–Ω–∏–∫ –±—É–¥–µ—Ç –ø–æ–ª—É—á–∞—Ç—å 1750‚ÇΩ –∑–∞ —Å–º–µ–Ω—É`);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Å–≤—è–∑–µ–π –∏ –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏
      await loadMentorshipPairs();
      await loadMentorsAndTrainees();
      
      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª–∏ –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
      await updateAffectedProfiles(mentor, trainee);
      
    } else {
      alert(`‚ùå –û—à–∏–±–∫–∞: ${data.message}`);
    }
    
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞:", error);
    alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
  }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª–µ–π –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
async function updateAffectedProfiles(mentor, trainee) {
  const currentUser = localStorage.getItem("currentUser");
  
  // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –æ–¥–∏–Ω –∏–∑ –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã—Ö, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—å
  if (currentUser === mentor || currentUser === trainee) {
    await updateProfileFromServer();
  }
}

async function deleteMentorshipPair(mentor, trainee) {
  if (!confirm(`‚ùì –£–¥–∞–ª–∏—Ç—å —Å–≤—è–∑—å –º–µ–∂–¥—É ${mentor} –∏ ${trainee}?`)) {
    return;
  }
  
  try {
    const formData = new FormData();
    formData.append('currentUser', mentor);
    formData.append('partner', ''); // –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Å–≤—è–∑–∏
    formData.append('status', '–®—Ç–∞—Ç');
    

    
    const response = await fetch(`${scriptURL}?type=savePair`, {
      method: 'POST', 
      body: formData
    });
    
    const data = await response.json();
    

    
    if (data.success) {
      alert(`‚úÖ –°–≤—è–∑—å —É–¥–∞–ª–µ–Ω–∞: ${mentor} ‚Üî ${trainee}`);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Å–≤—è–∑–µ–π –∏ –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏
      await loadMentorshipPairs();
      await loadMentorsAndTrainees();
      
      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª–∏ –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
      await updateAffectedProfiles(mentor, trainee);
      
    } else {
      alert(`‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ${data.message}`);
    }
    
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–≤—è–∑–∏:", error);
    alert("‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–≤—è–∑–∏");
  }
}

async function loadTraineeAnalytics() {
  const startDate = document.getElementById("analyticsStartDate").value;
  const endDate = document.getElementById("analyticsEndDate").value;
  const container = document.getElementById("traineeAnalyticsResults");
  const btn = document.getElementById("loadAnalyticsBtn");
  
  if (!startDate || !endDate) {
    container.innerHTML = '<p style="color: #dc2626;">‚ùó –í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</p>';
    return;
  }
  
  try {
    btn.disabled = true;
    btn.textContent = "‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...";
    
    const response = await fetch(`${scriptURL}?type=mentorshipAnalytics&startDate=${startDate}&endDate=${endDate}`);
    const data = await response.json();
    
    if (data.error) {
      container.innerHTML = `<p style="color: #dc2626;">‚ùå ${data.error}</p>`;
      return;
    }
    
    if (!data.analytics || data.analytics.length === 0) {
              container.innerHTML = '<p style="color: #000000;">üìä –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</p>';
      return;
    }
    
    let html = '<div style="display: grid; gap: 16px;">';
    
    data.analytics.forEach(pair => {
      html += `
        <div class="analytics-card">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
            <div style="font-weight: 600; color: #374151;">
              üë®‚Äçüíº ${pair.mentor} ‚Üí üë®‚Äçüéì ${pair.trainee}
            </div>
            <div style="text-align: right;">
              <div style="font-size: 14px; color: #000000;">–†–∞–±–æ—á–∏—Ö –¥–Ω–µ–π: ${pair.workingDays}</div>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
            <div style="text-align: center; padding: 8px; background: #f3f4f6; border-radius: 6px;">
              <div style="font-size: 18px; font-weight: 600; color: #3b82f6;">${pair.totalQuantity}</div>
              <div style="font-size: 12px; color: #000000;">–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</div>
            </div>
            <div style="text-align: center; padding: 8px; background: #f3f4f6; border-radius: 6px;">
              <div style="font-size: 18px; font-weight: 600; color: #10b981;">${pair.totalOperations}</div>
              <div style="font-size: 12px; color: #000000;">–û–ø–µ—Ä–∞—Ü–∏–π</div>
            </div>
            <div style="text-align: center; padding: 8px; background: #f3f4f6; border-radius: 6px;">
              <div style="font-size: 18px; font-weight: 600; color: #f59e0b;">${pair.avgQuantityPerDay}</div>
              <div style="font-size: 12px; color: #000000;">–í –¥–µ–Ω—å (—Å—Ä–µ–¥–Ω–µ–µ)</div>
            </div>
          </div>
        </div>
      `;
    });
    
    html += '</div>';
    container.innerHTML = html;
    
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏:", error);
    container.innerHTML = '<p style="color: #dc2626;">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏</p>';
  } finally {
    btn.disabled = false;
    btn.textContent = "üìä –ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É";
  }
}



async function cleanupAllMentorshipPairs(execute = false) {
  const container = document.getElementById("cleanupResults");
  const previewBtn = document.getElementById("previewCleanupBtn");
  const executeBtn = document.getElementById("executeCleanupBtn");
  
  if (execute && !confirm("‚ùì –í—ã –£–í–ï–†–ï–ù–´, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –í–°–ï —Å–≤—è–∑–∏ –Ω–∞—Å—Ç–∞–≤–Ω–∏—á–µ—Å—Ç–≤–∞?\n\n–≠—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏—è –Ω–µ–æ–±—Ä–∞—Ç–∏–º–∞!")) {
    return;
  }
  
  try {
    const btn = execute ? executeBtn : previewBtn;
    btn.disabled = true;
    btn.textContent = execute ? "‚è≥ –û—á–∏—Å—Ç–∫–∞..." : "‚è≥ –ê–Ω–∞–ª–∏–∑...";
    
    container.style.display = "block";
    container.innerHTML = execute ? 
              '<p style="color: #000000;">üßπ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö —Å–≤—è–∑–µ–π...</p>' :
        '<p style="color: #000000;">üîç –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é—Ç—Å—è —Å–≤—è–∑–∏ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏...</p>';
    
    if (execute) {
      // –í—ã–ø–æ–ª–Ω—è–µ–º —Ä–µ–∞–ª—å–Ω—É—é –æ—á–∏—Å—Ç–∫—É —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä
      const response = await fetch(`${scriptURL}?type=cleanupAllMentorships`);
      const data = await response.json();
      
      if (data.success) {
        container.innerHTML = `
          <div style="color: #059669; background: #d1fae5; padding: 12px; border-radius: 6px;">
            <h4 style="margin: 0 0 8px 0;">‚úÖ –û—á–∏—Å—Ç–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞</h4>
            <p style="margin: 0;">–£–¥–∞–ª–µ–Ω–æ —Å–≤—è–∑–µ–π: ${data.clearedCount}</p>
          </div>
        `;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Å–≤—è–∑–µ–π –µ—Å–ª–∏ –æ–Ω –æ—Ç–∫—Ä—ã—Ç
        if (document.getElementById("traineeSection-pairs").style.display !== "none") {
          setTimeout(() => loadMentorshipPairs(), 1000);
        }
      } else {
        container.innerHTML = `
          <div style="color: #dc2626; background: #fee2e2; padding: 12px; border-radius: 6px;">
            <h4 style="margin: 0 0 8px 0;">‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏</h4>
            <p style="margin: 0;">${data.error}</p>
          </div>
        `;
      }
    } else {
      // –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä - –ø–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ —Å–≤—è–∑–∏
      const response = await fetch(`${scriptURL}?type=employees`);
      const data = await response.json();
      
      let pairsCount = 0;
      if (data.employees) {
        // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–≤—è–∑–µ–π (—É–ø—Ä–æ—â–µ–Ω–Ω–æ)
        data.employees.forEach(emp => {
          if (emp.mentor && emp.mentor.trim()) {
            pairsCount++;
          }
        });
      }
      
      container.innerHTML = `
        <div style="color: #3b82f6; background: #dbeafe; padding: 12px; border-radius: 6px;">
          <h4 style="margin: 0 0 8px 0;">üîç –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä</h4>
          <p style="margin: 0;">–ù–∞–π–¥–µ–Ω–æ —Å–≤—è–∑–µ–π –¥–ª—è –æ—á–∏—Å—Ç–∫–∏: ${pairsCount}</p>
          <p style="margin: 8px 0 0 0; font-size: 14px; opacity: 0.8;">
            ${pairsCount > 0 ? '–ë—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –í–°–ï —Å–≤—è–∑–∏ –Ω–∞—Å—Ç–∞–≤–Ω–∏—á–µ—Å—Ç–≤–∞.' : '–°–≤—è–∑–∏ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.'}
          </p>
        </div>
      `;
    }
    
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏:", error);
    container.innerHTML = '<p style="color: #dc2626;">‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ —Å–≤—è–∑–µ–π</p>';
  } finally {
    const btn = execute ? executeBtn : previewBtn;
    btn.disabled = false;
    btn.textContent = execute ? "üßπ –í—ã–ø–æ–ª–Ω–∏—Ç—å –æ—á–∏—Å—Ç–∫—É" : "üîç –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä";
  }
}

function showResult(container, message, type) {
  container.style.display = "block";
  container.textContent = message;
  
  if (type === "success") {
    container.style.background = "#d1fae5";
    container.style.color = "#065f46";
    container.style.borderColor = "#10b981";
  } else if (type === "error") {
    container.style.background = "#fee2e2";
    container.style.color = "#991b1b";
    container.style.borderColor = "#ef4444";
  }
  
  container.style.border = "1px solid";
  
  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥ –¥–ª—è —É—Å–ø–µ—à–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
  if (type === "success") {
    setTimeout(() => {
      container.style.display = "none";
    }, 5000);
  }
}





// ========== üìä –§–£–ù–ö–¶–ò–ò –†–ê–ë–û–¢–´ –° –ë–û–ù–£–°–û–ú –ù–ê–°–¢–ê–í–ù–ò–ö–ê ==========

    // –ë–æ–Ω—É—Å –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–∞ —Ç–µ–ø–µ—Ä—å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π (1750‚ÇΩ –∑–∞ —Å–º–µ–Ω—É)
// –§—É–Ω–∫—Ü–∏—è parseMentorInfo –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–∞

async function runCustomReport() {
  withLoading("reportBtn", async () => {
    const start = document.getElementById("unifiedStart").value;
const end = document.getElementById("unifiedEnd").value;

    if (!start || !end) {
      alert("‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ –Ω–∞—á–∞–ª–æ –∏ –∫–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞");
      return;
    }

    try {
      const res = await fetch(`${scriptURL}?type=weeklyReport&start=${start}&end=${end}`);
      const text = await res.text();

      alert(text || "‚úÖ –û—Ç—á—ë—Ç —É—Å–ø–µ—à–Ω–æ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω");
    } catch (err) {
      alert("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –æ—Ç—á—ë—Ç–∞: " + err.message);
    }
  });
}

async function analyzePackers() {
  const start = document.getElementById("unifiedStart").value;
  const end = document.getElementById("unifiedEnd").value;
  const container = document.getElementById("reportContainer");

  if (!start || !end) {
    container.innerHTML = "<p style='color:red;'>‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</p>";
    return;
  }

  container.innerHTML = "<p>‚åõ –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á—ë—Ç–∞ –ø–æ —É–ø–∞–∫–æ–≤—â–∏–∫–∞–º...</p>";

  try {
    const res = await fetch(`${scriptURL}?type=packerAnalytics&start=${start}&end=${end}`);
    const json = await res.json();

    if (!json.ok) {
      container.innerHTML = "<p style='color:red;'>‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö</p>";
      return;
    }

    const { list, best, totalNormsMet, totalNormsTotal, totalNormsPercent } = json;

    const rows = list.map(row => {
      let style = "";
      if (row.name === best.name) style = "background:#fef9c3;";          // üü® –ª—É—á—à–∏–π –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É
      if (row.name === best.bestEffName) style = "background:#d1fae5;";   // üü© –ª—É—á—à–∏–π –ø–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
      if (row.name === best.worstEffName) style = "background:#fee2e2;"; // üü• —Ö—É–¥—à–∏–π –ø–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

      // –î–ª—è –Ω–æ—Ä–º—ã
      const met = Number(row.normsMet);
      const total = Number(row.normsTotal);
      const percent = total > 0 ? Math.round((met / total) * 100) : 0;
      let normIcon = "‚ö†Ô∏è";
      if (total === 0) normIcon = "‚Äî";
      else if (percent >= 85) normIcon = "‚úÖ";
      else if (percent > 0) normIcon = "‚ö†Ô∏è";

      return `
        <tr style="${style}">
          <td>${row.name}</td>
          <td>${row.qty}</td>
          <td>${row.efficiency}%</td>
          <td>${row.wage.toLocaleString("ru-RU")} ‚ÇΩ</td>
          <td>${met}/${total} (${percent}%) ${normIcon}</td>
        </tr>
      `;
    }).join("");

    const table = `
      <h3>üìä –ê–Ω–∞–ª–∏–∑ —É–ø–∞–∫–æ–≤—â–∏–∫–æ–≤</h3>
      <button class="danger" onclick="clearReports()" style="margin-bottom: 12px;">‚ùå –ó–∞–∫—Ä—ã—Ç—å –æ—Ç—á—ë—Ç</button>
      <div class="table-scroll">
    <table border="1" cellpadding="6" style="border-collapse: collapse; width: 100%;">
        <thead style="background:#f3f4f6;">
          <tr>
            <th>–£–ø–∞–∫–æ–≤—â–∏–∫</th>
            <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
            <th>–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th>
            <th>–ó–∞—Ä–ø–ª–∞—Ç–∞</th>
            <th>–ù–æ—Ä–º—ã</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
      <br/>
      <p>
        ü•á <strong>–õ—É—á—à–∏–π –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É:</strong> ${best.name} ‚Äî ${best.qty} —à—Ç.<br/>
        üíØ <strong>–õ—É—á—à–∏–π –ø–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:</strong> ${best.bestEffName} ‚Äî ${best.bestEffValue}%<br/>
        üîª <strong>–•—É–¥—à–∏–π –ø–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:</strong> ${best.worstEffName} ‚Äî ${best.worstEffValue}%
      </p>
      <div style="margin-top:16px; padding:10px; background:#f3f4f6; border-radius:8px; font-weight:500;">
        üìä <b>–ò—Ç–æ–≥–æ –ø–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é –Ω–æ—Ä–º –∑–∞ —Å–º–µ–Ω—É:</b>
        <br>
        ${totalNormsMet}/${totalNormsTotal} (${totalNormsPercent}%)
      </div>
    `;

    container.innerHTML = table;

  } catch (err) {
    container.innerHTML = `<p style='color:red;'>–û—à–∏–±–∫–∞: ${err.message}</p>`;
  }
}


// üëá –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ –æ—Ç—á—ë—Ç–æ–≤
function clearReports() {
  const container = document.getElementById("reportContainer");
  container.innerHTML = "";
  isShiftStatsLoaded = false;
}



async function withLoading(buttonId, asyncCallback) {
  const btn = document.getElementById(buttonId);
  if (!btn) return;

  btn.classList.add("button-loading");
  btn.disabled = true;

  try {
    await asyncCallback();
  } catch (err) {
    console.error("–û—à–∏–±–∫–∞:", err);
    throw err;
  } finally {
    btn.classList.remove("button-loading");
    btn.disabled = false;
  }
}

async function loadAllDictionariesInBackground() {
      try {
        await Promise.all([
          loadVolumes(),
          loadOperations(),
          loadSetNumbers(),
          loadTodayRecords(),
          loadOperationFilter(),
          loadRatesTable()
          // loadPackingModels() —É–±—Ä–∞–Ω - –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ –ø—Ä–∏ –≤—Ö–æ–¥–µ
        ]);


        document.getElementById("operationFilter").addEventListener("change", loadStats);
      } catch (err) {
        console.warn("‚ö†Ô∏è –û—à–∏–±–∫–∞ —Ñ–æ–Ω–æ–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏:", err.message);
      }
    }

function toggleReport(id, contentHtml) {
  const container = document.getElementById("reportContainer");
  const existing = container.querySelector(`.report[data-id='${id}']`);

  if (existing) {
    existing.remove(); // üíØ –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –Ω–∞–∂–∞—Ç–∏–µ ‚Äî –æ—Ç—á—ë—Ç –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è
  } else {
    const wrapper = document.createElement("div");
    wrapper.classList.add("report");
    wrapper.dataset.id = id;
    wrapper.innerHTML = contentHtml;
    container.appendChild(wrapper);
  }
}

function clearReports() {
  const container = document.getElementById("reportContainer");
  container.innerHTML = "";
  isShiftStatsLoaded = false;
}

async function loadShiftStats() {
  const start = document.getElementById("unifiedStart").value;
  const end = document.getElementById("unifiedEnd").value;
  const container = document.getElementById("reportContainer");

  if (!start || !end) {
    container.innerHTML = "<p style='color:red;'>‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ –æ–±–µ –¥–∞—Ç—ã</p>";
    return;
  }

  container.innerHTML = "<p>‚åõ –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á—ë—Ç–∞ –ø–æ —Å–º–µ–Ω–∞–º...</p>";

  try {
    const res = await fetch(`${scriptURL}?type=shiftStats&start=${start}&end=${end}`);
    const data = await res.json();

    if (!data || !data.data || !Array.isArray(data.data) || !data.data.length) {
      container.innerHTML = "<p style='text-align:center;'>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –ø–µ—Ä–∏–æ–¥—É</p>";
      return;
    }

    container.innerHTML = "";

    const closeBtn = document.createElement("button");
    closeBtn.textContent = "‚ùå –ó–∞–∫—Ä—ã—Ç—å –æ—Ç—á—ë—Ç";
    closeBtn.className = "danger";
    closeBtn.style.marginBottom = "12px";
    closeBtn.onclick = () => (container.innerHTML = "");
    container.appendChild(closeBtn);

    data.data.forEach(shiftBlock => {
  const shiftTitle = document.createElement("div");
  shiftTitle.innerHTML = `
    üïê <strong>–°–º–µ–Ω–∞:</strong> ${shiftBlock.shift}
    <br>üì¶ <strong>–ü–µ—Ä–µ—É–ø–∞–∫–æ–≤–∞–Ω–æ –∑–∞ —Å–º–µ–Ω—É:</strong> ${shiftBlock.total?.totalQty ?? 0} —à—Ç.
    <br>üë®‚Äçüîß <strong>–®—Ç–∞—Ç:</strong> ${shiftBlock.staff?.totalQty ?? 0} —à—Ç. (${shiftBlock.staff?.employees?.length ?? 0} —á–µ–ª.)
    <br>üë®‚Äçüéì <strong>–°—Ç–∞–∂–µ—Ä—ã:</strong> ${shiftBlock.trainee?.totalQty ?? 0} —à—Ç. (${shiftBlock.trainee?.employees?.length ?? 0} —á–µ–ª.)
    <br>üìÑ <strong>–ê—É—Ç—Å–æ—Ä—Å–∏–Ω–≥:</strong> ${shiftBlock.outsource?.totalQty ?? 0} —à—Ç. (${shiftBlock.outsource?.employees?.length ?? 0} —á–µ–ª.)
  `;
  shiftTitle.style.marginTop = "16px";
  container.appendChild(shiftTitle);

      // === –í–ê–ñ–ù–û: —Å–æ–∑–¥–∞—ë–º table ===
      const table = document.createElement("table");
      table.style.width = "100%";
      table.style.borderCollapse = "collapse";
      table.style.marginTop = "10px";

      const thead = document.createElement("thead");
      thead.innerHTML = `
        <tr style="background:#f3f4f6;">
          <th style="padding:6px; border:1px solid #ccc;">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
          <th style="padding:6px; border:1px solid #ccc;">–ö–æ–ª-–≤–æ</th>
          <th style="padding:6px; border:1px solid #ccc;">–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th>
          <th style="padding:6px; border:1px solid #ccc;">–ù–æ—Ä–º—ã</th>
        </tr>
      `;
      table.appendChild(thead);

      const tbody = document.createElement("tbody");

      const staff = shiftBlock?.staff?.employees || [];
      const outsource = shiftBlock?.outsource?.employees || [];
      const trainee = shiftBlock?.trainee?.employees || [];

      if (staff.length) {
        const staffTitleRow = document.createElement("tr");
        staffTitleRow.innerHTML = `
          <td colspan="4" style="padding:6px; font-weight:bold; color:#1f2937;">
            üë®‚Äçüîß –®—Ç–∞—Ç (${staff.length} —á–µ–ª., —Å—Ä–µ–¥–Ω—è—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${shiftBlock.staff.averageEfficiency}%)
          </td>
        `;
        tbody.appendChild(staffTitleRow);

        staff.forEach(emp => {
          const tr = document.createElement("tr");
          
          // –†–∞—Å—á–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –Ω–æ—Ä–º–∞—Ö
          const normsMet = emp.opsMet || 0;
          const normsTotal = emp.opsTotal || 0;
          const normsPercent = normsTotal > 0 ? Math.round((normsMet / normsTotal) * 100) : 0;
          
          // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ –¥–ª—è –Ω–æ—Ä–º
          let normIcon = "‚Äî";
          if (normsTotal === 0) normIcon = "‚Äî";
          else if (normsPercent >= 90) normIcon = "‚úÖ";
          else if (normsPercent >= 60) normIcon = "‚ö†Ô∏è";
          else if (normsPercent > 0) normIcon = "‚ùå";
          
          tr.innerHTML = `
            <td style="padding:6px; border:1px solid #ccc;">${emp.name}</td>
            <td style="padding:6px; border:1px solid #ccc;">${emp.quantity}</td>
            <td style="padding:6px; border:1px solid #ccc;">${emp.efficiency}%</td>
            <td style="padding:6px; border:1px solid #ccc;">${normsMet}/${normsTotal} (${normsPercent}%) ${normIcon}</td>
          `;
          tbody.appendChild(tr);
        });
      }

      if (trainee.length) {
        const traineeTitleRow = document.createElement("tr");
        traineeTitleRow.innerHTML = `
          <td colspan="4" style="padding:6px; font-weight:bold; color:#059669;">
            üë®‚Äçüéì –°—Ç–∞–∂–µ—Ä—ã (${trainee.length} —á–µ–ª., —Å—Ä–µ–¥–Ω—è—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${shiftBlock.trainee.averageEfficiency}%)
          </td>
        `;
        tbody.appendChild(traineeTitleRow);

        trainee.forEach(emp => {
          const tr = document.createElement("tr");
          
          // –†–∞—Å—á–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –Ω–æ—Ä–º–∞—Ö
          const normsMet = emp.opsMet || 0;
          const normsTotal = emp.opsTotal || 0;
          const normsPercent = normsTotal > 0 ? Math.round((normsMet / normsTotal) * 100) : 0;
          
          // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ –¥–ª—è –Ω–æ—Ä–º
          let normIcon = "‚Äî";
          if (normsTotal === 0) normIcon = "‚Äî";
          else if (normsPercent >= 90) normIcon = "‚úÖ";
          else if (normsPercent >= 60) normIcon = "‚ö†Ô∏è";
          else if (normsPercent > 0) normIcon = "‚ùå";
          
          tr.innerHTML = `
            <td style="padding:6px; border:1px solid #ccc;">${emp.name}</td>
            <td style="padding:6px; border:1px solid #ccc;">${emp.quantity}</td>
            <td style="padding:6px; border:1px solid #ccc;">${emp.efficiency}%</td>
            <td style="padding:6px; border:1px solid #ccc;">${normsMet}/${normsTotal} (${normsPercent}%) ${normIcon}</td>
          `;
          tbody.appendChild(tr);
        });
      }

      if (outsource.length) {
        const outTitleRow = document.createElement("tr");
        outTitleRow.innerHTML = `
          <td colspan="4" style="padding:6px; font-weight:bold; color:#6b21a8;">
            üìÑ –ê—É—Ç—Å–æ—Ä—Å–∏–Ω–≥ (${outsource.length} —á–µ–ª., —Å—Ä–µ–¥–Ω—è—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${shiftBlock.outsource.averageEfficiency}%)
          </td>
        `;
        tbody.appendChild(outTitleRow);

        outsource.forEach(emp => {
          const tr = document.createElement("tr");
          
          // –†–∞—Å—á–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –Ω–æ—Ä–º–∞—Ö
          const normsMet = emp.opsMet || 0;
          const normsTotal = emp.opsTotal || 0;
          const normsPercent = normsTotal > 0 ? Math.round((normsMet / normsTotal) * 100) : 0;
          
          // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ –¥–ª—è –Ω–æ—Ä–º
          let normIcon = "‚Äî";
          if (normsTotal === 0) normIcon = "‚Äî";
          else if (normsPercent >= 90) normIcon = "‚úÖ";
          else if (normsPercent >= 60) normIcon = "‚ö†Ô∏è";
          else if (normsPercent > 0) normIcon = "‚ùå";
          
          tr.innerHTML = `
            <td style="padding:6px; border:1px solid #ccc;">${emp.name}</td>
            <td style="padding:6px; border:1px solid #ccc;">${emp.quantity}</td>
            <td style="padding:6px; border:1px solid #ccc;">${emp.efficiency}%</td>
            <td style="padding:6px; border:1px solid #ccc;">${normsMet}/${normsTotal} (${normsPercent}%) ${normIcon}</td>
          `;
          tbody.appendChild(tr);
        });
      }

      table.appendChild(tbody);

      // === –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –≤ scrollDiv ===
      const scrollDiv = document.createElement("div");
      scrollDiv.className = "table-scroll";
      scrollDiv.appendChild(table);
      container.appendChild(scrollDiv);

      // === –ë–ª–æ–∫ –æ–±—â–µ–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ –Ω–æ—Ä–º (–ø–æ —Ç–µ–∫—É—â–µ–π —Å–º–µ–Ω–µ)
      const staffEff = shiftBlock?.staff?.averageEfficiency;
      const outsourceEff = shiftBlock?.outsource?.averageEfficiency;
      const overallEff = shiftBlock?.total?.overall;
      
      // –ü–æ–¥—Å—á–µ—Ç –æ–±—â–∏—Ö –Ω–æ—Ä–º –ø–æ —Å–º–µ–Ω–µ
              const allEmployees = [...(shiftBlock?.staff?.employees || []), ...(shiftBlock?.outsource?.employees || []), ...(shiftBlock?.trainee?.employees || [])];
      const totalNormsMet = allEmployees.reduce((sum, emp) => sum + (emp.opsMet || 0), 0);
      const totalNormsTotal = allEmployees.reduce((sum, emp) => sum + (emp.opsTotal || 0), 0);
      const totalNormsPercent = totalNormsTotal > 0 ? Math.round((totalNormsMet / totalNormsTotal) * 100) : 0;
      
      // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ –¥–ª—è –æ–±—â–∏—Ö –Ω–æ—Ä–º
      let totalNormIcon = "‚Äî";
      if (totalNormsTotal === 0) totalNormIcon = "‚Äî";
      else if (totalNormsPercent >= 85) totalNormIcon = "‚úÖ";
      else if (totalNormsPercent >= 60) totalNormIcon = "‚ö†Ô∏è";
      else if (totalNormsPercent > 0) totalNormIcon = "‚ùå";
      
      // –î–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è "‚Äî" –µ—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
      function effVal(val) {
        return (val === undefined || val === null) ? "‚Äî" : val + "%";
      }
      const footer = document.createElement("div");
      footer.style.marginTop = "12px";
      footer.style.padding = "12px";
      footer.style.background = "#ecfdf5";
      footer.style.borderRadius = "8px";
      footer.style.fontWeight = "500";
      footer.innerHTML = `
        üìä <b>–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞ —Å–º–µ–Ω—É:</b><br>
        üë®‚Äçüîß –®—Ç–∞—Ç ‚Äî ${effVal(staffEff)} |
        ü§ù –ê—É—Ç—Å–æ—Ä—Å–∏–Ω–≥ ‚Äî ${effVal(outsourceEff)} |
        üì¶ –û–±—â–∞—è ‚Äî ${effVal(overallEff)}<br><br>
        üìã <b>–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–æ—Ä–º –∑–∞ —Å–º–µ–Ω—É:</b><br>
        ${totalNormsMet}/${totalNormsTotal} (${totalNormsPercent}%) ${totalNormIcon}
      `;
      container.appendChild(footer);
    });

  } catch (err) {
    container.innerHTML = `<p style='color:red;'>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${err.message}</p>`;
  }
}

async function loadSeniorsReport() {
  clearReports(); // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ—Ç—á–µ—Ç—ã
  
  const start = document.getElementById("unifiedStart").value;
  const end = document.getElementById("unifiedEnd").value;
  const container = document.getElementById("reportContainer");

  if (!start || !end) {
    container.innerHTML = "<p style='color:red;'>‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ –æ–±–µ –¥–∞—Ç—ã</p>";
    return;
  }

  container.innerHTML = "<p>‚åõ –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á—ë—Ç–∞ –ø–æ —Å—Ç–∞—Ä—à–∏–º —Å–º–µ–Ω–∞–º...</p>";

  try {

    
    const res = await fetch(`${scriptURL}?type=seniorsReport&start=${start}&end=${end}`);
    
    
    if (!res.ok) {
      container.innerHTML = `<p style='color:red;'>‚ùå –û—à–∏–±–∫–∞ HTTP: ${res.status} ${res.statusText}</p>`;
      return;
    }
    
    const data = await res.json();
    

    if (!data) {
      container.innerHTML = "<p style='color:red;'>‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ –≤–µ—Ä–Ω—É–ª –¥–∞–Ω–Ω—ã–µ</p>";
      return;
    }

    if (data.status !== 'success') {
      container.innerHTML = `<p style='color:red;'>‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</p>`;
      return;
    }

    if (!data.data || !Array.isArray(data.data)) {
      container.innerHTML = "<p style='color:red;'>‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞</p>";
      return;
    }

    if (!data.data.length) {
      container.innerHTML = "<p style='text-align:center;'>üì≠ –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ —Å—Ç–∞—Ä—à–∏–º —Å–º–µ–Ω–∞–º –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</p>";
      return;
    }

    container.innerHTML = "";

    const closeBtn = document.createElement("button");
    closeBtn.textContent = "‚ùå –ó–∞–∫—Ä—ã—Ç—å –æ—Ç—á—ë—Ç";
    closeBtn.className = "danger";
    closeBtn.style.marginBottom = "12px";
    closeBtn.onclick = () => (container.innerHTML = "");
    container.appendChild(closeBtn);

    // –°–æ–∑–¥–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –æ—Ç—á–µ—Ç–∞
    const reportTitle = document.createElement("div");
    reportTitle.innerHTML = `
      <h3 style="margin-top: 0; color: #8b5cf6;">üë®‚Äçüíº –ê–Ω–∞–ª–∏–∑ —Å—Ç–∞—Ä—à–∏—Ö —Å–º–µ–Ω</h3>
              <p style="color: #000000; margin-bottom: 16px;">–ü–µ—Ä–∏–æ–¥: ${start} ‚Äî ${end}</p>
    `;
    container.appendChild(reportTitle);

    // –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
    const table = document.createElement("table");
    table.style.width = "100%";
    table.style.borderCollapse = "collapse";
    table.style.marginTop = "10px";

    const thead = document.createElement("thead");
    thead.innerHTML = `
      <tr style="background:#f3f4f6;">
        <th style="padding:8px; border:1px solid #d1d5db; text-align:left;">–î–∞—Ç–∞</th>
        <th style="padding:8px; border:1px solid #d1d5db; text-align:left;">–°–º–µ–Ω–∞</th>
        <th style="padding:8px; border:1px solid #d1d5db; text-align:left;">–°—Ç–∞—Ä—à–∏–π —Å–º–µ–Ω—ã</th>
        <th style="padding:8px; border:1px solid #d1d5db; text-align:center;">–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th>
        <th style="padding:8px; border:1px solid #d1d5db; text-align:center;">–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–æ—Ä–º—ã</th>
        <th style="padding:8px; border:1px solid #d1d5db; text-align:right;">–ó–∞—Ä–ø–ª–∞—Ç–∞</th>
      </tr>
    `;
    table.appendChild(thead);

    const tbody = document.createElement("tbody");

    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ —Å–º–µ–Ω–∞–º
    const shiftsData = {};
    data.data.forEach(item => {
      const shiftKey = item.shift;
      if (!shiftsData[shiftKey]) {
        shiftsData[shiftKey] = [];
      }
      shiftsData[shiftKey].push(item);
    });

    // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Å–º–µ–Ω—ã
    const sortedShifts = Object.keys(shiftsData).sort();

    sortedShifts.forEach(shift => {
      const shiftItems = shiftsData[shift];
      
      // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–º–µ–Ω—ã
      const shiftHeader = document.createElement("tr");
      shiftHeader.innerHTML = `
        <td colspan="6" style="padding:8px; font-weight:bold; color:#8b5cf6; background:#f8f7ff; border:1px solid #d1d5db;">
          üïê ${shift}
        </td>
      `;
      tbody.appendChild(shiftHeader);

      // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∑–∞–ø–∏—Å–∏ –ø–æ –¥–∞—Ç–µ
      shiftItems.sort((a, b) => new Date(a.date.split('.').reverse().join('-')) - new Date(b.date.split('.').reverse().join('-')));

      shiftItems.forEach(item => {
        const tr = document.createElement("tr");
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç —Å—Ç—Ä–æ–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        let rowStyle = "";
        if (item.efficiency >= 100) {
          rowStyle = "background:#ecfdf5;"; // –ó–µ–ª–µ–Ω—ã–π –¥–ª—è –≤—ã—Å–æ–∫–æ–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        } else if (item.efficiency >= 90) {
          rowStyle = "background:#fef3c7;"; // –ñ–µ–ª—Ç—ã–π –¥–ª—è —Å—Ä–µ–¥–Ω–µ–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        } else {
          rowStyle = "background:#fef2f2;"; // –ö—Ä–∞—Å–Ω—ã–π –¥–ª—è –Ω–∏–∑–∫–æ–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        }

        tr.innerHTML = `
          <td style="padding:8px; border:1px solid #d1d5db; ${rowStyle}">${item.date}</td>
          <td style="padding:8px; border:1px solid #d1d5db; ${rowStyle}">${item.shift}</td>
          <td style="padding:8px; border:1px solid #d1d5db; ${rowStyle}">${item.name}</td>
          <td style="padding:8px; border:1px solid #d1d5db; text-align:center; ${rowStyle}">
            <span style="font-weight:bold; color:${item.efficiency >= 100 ? '#059669' : item.efficiency >= 90 ? '#d97706' : '#dc2626'}">
              ${item.efficiency}%
            </span>
          </td>
          <td style="padding:8px; border:1px solid #d1d5db; text-align:center; ${rowStyle}">
            <span style="font-weight:bold; color:${item.norm >= 90 ? '#059669' : '#dc2626'}">
              ${item.norm}%
            </span>
          </td>
          <td style="padding:8px; border:1px solid #d1d5db; text-align:right; ${rowStyle}">
            <strong>${item.salary.toLocaleString('ru-RU')} ‚ÇΩ</strong>
          </td>
        `;
        tbody.appendChild(tr);
      });
    });

    table.appendChild(tbody);

    // –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –≤ scrollDiv
    const scrollDiv = document.createElement("div");
    scrollDiv.className = "table-scroll";
    scrollDiv.appendChild(table);
    container.appendChild(scrollDiv);

    // –î–æ–±–∞–≤–ª—è–µ–º —Å–≤–æ–¥–∫—É
    const totalSalary = data.data.reduce((sum, item) => sum + (item.salary || 0), 0);
    const avgEfficiency = data.data.reduce((sum, item) => sum + (item.efficiency || 0), 0) / data.data.length;
    const avgNorm = data.data.reduce((sum, item) => sum + (item.norm || 0), 0) / data.data.length;

    const summary = document.createElement("div");
    summary.style.marginTop = "16px";
    summary.style.padding = "16px";
    summary.style.background = "#f8f7ff";
    summary.style.borderRadius = "8px";
    summary.style.fontWeight = "500";
    summary.innerHTML = `
      üìä <b>–°–≤–æ–¥–∫–∞ –ø–æ –ø–µ—Ä–∏–æ–¥—É:</b><br>
      üë®‚Äçüíº <strong>–í—Å–µ–≥–æ —Å–º–µ–Ω:</strong> ${data.data.length} |
      üí∞ <strong>–û–±—â–∞—è –∑–∞—Ä–ø–ª–∞—Ç–∞:</strong> ${totalSalary.toLocaleString('ru-RU')} ‚ÇΩ |
      üìà <strong>–°—Ä–µ–¥–Ω—è—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:</strong> ${Math.round(avgEfficiency)}% |
      ‚úÖ <strong>–°—Ä–µ–¥–Ω–µ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–æ—Ä–º—ã:</strong> ${Math.round(avgNorm)}%
    `;
    container.appendChild(summary);

  } catch (err) {
    container.innerHTML = `<p style='color:red;'>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${err.message}</p>`;
  }
}

// üì° –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É
window.addEventListener('offline', () => {
  alert('üì° –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É');
});
window.addEventListener('online', () => {
  alert('‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
});
if ('serviceWorker' in navigator && window.location.protocol !== 'file:') {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/service-worker.js')
        .then(reg => {})
        .catch(err => console.error('‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ SW:', err));
    });
  }

// ‚è± –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
window.addEventListener("DOMContentLoaded", () => {
  const loginInput = document.getElementById("login");
  if (loginInput) loginInput.focus();
});

// üßº –°–±—Ä–æ—Å –æ—à–∏–±–∫–∏ –ø—Ä–∏ –≤–≤–æ–¥–µ
["login", "password"].forEach(id => {
  const input = document.getElementById(id);
  if (input) {
    input.addEventListener("input", () => {
      const error = document.getElementById("loginError");
      if (error) error.textContent = "";
    });
  }
});

// ‚èé –í—Ö–æ–¥ –ø–æ –Ω–∞–∂–∞—Ç–∏—é Enter
document.getElementById("password").addEventListener("keydown", e => {
  if (e.key === "Enter") {
    handleLogin();
  }
});

// üîÑ –ì–æ—Ä—è—á–∞—è –∫–ª–∞–≤–∏—à–∞ –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫—ç—à–∞ (Ctrl+Shift+R)
document.addEventListener("keydown", e => {
  if (e.ctrlKey && e.shiftKey && e.key === 'R') {
    e.preventDefault();
    clearCache();
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    const notification = document.createElement('div');
    notification.style.cssText = `
      position: fixed; top: 20px; right: 20px; z-index: 10000;
      background: #059669; color: white; padding: 12px 20px; border-radius: 8px;
      font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      animation: slideIn 0.3s ease-out;
    `;
    notification.textContent = 'üîÑ –ö—ç—à –æ—á–∏—â–µ–Ω! –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω—ã.';
    
    document.body.appendChild(notification);
    
    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–µ–ª–∏ —É–ø–∞–∫–æ–≤–∫–∏ –∏ –æ–∫–ª–∞–¥
    setTimeout(() => {
      isLoadingPackingModels = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ø–µ—Ä–µ–¥ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–æ–π
      loadPackingModels();
      preloadCurrentUserSalary();
    }, 500);
    
    // –£–±–∏—Ä–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(() => {
      notification.remove();
    }, 3000);
  }
});

function openSalaryExportModal() {
  // –û—á–∏—Å—Ç–∫–∞
  document.getElementById("salaryExportResult").textContent = "";
  document.getElementById("salaryExportModal").style.display = "flex";
  // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–∞—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (—Å–µ–≥–æ–¥–Ω—è)
  const today = new Date().toISOString().split("T")[0];
  document.getElementById("salaryExportStart").value = today;
  document.getElementById("salaryExportEnd").value = today;
  // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏ —Å—Ç–∞—Ä—à–∏—Ö —Å–º–µ–Ω
  loadSalaryExportEmployees();
  loadSalaryExportSeniors();
}

function closeSalaryExportModal() {
  document.getElementById("salaryExportModal").style.display = "none";
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤
function toggleEmployeeExportSelector() {
    const type = document.querySelector('input[name="exportType"]:checked').value;
    const packersSelector = document.getElementById("packersExportSelector");
    const seniorsSelector = document.getElementById("seniorsExportSelector");
    
    if (type === 'seniors') {
        packersSelector.style.display = 'none';
        seniorsSelector.style.display = 'block';
    } else {
        packersSelector.style.display = 'block';
        seniorsSelector.style.display = 'none';
    }
}

async function loadSalaryExportEmployees() {
  try {
    const res = await fetch(`${scriptURL}?type=employees`);
    const data = await res.json();

    const names = Array.from(new Set((data.employees || []))).sort();
    const select = document.getElementById("salaryExportEmployee");

    select.innerHTML = `<option value="">-- –í—Å–µ --</option>`;
    names.forEach(name => {
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      select.appendChild(opt);
    });
  } catch (err) {
    document.getElementById("salaryExportResult").textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤!";
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:", err);
  }
}

// ========== ‚ûï –§–£–ù–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø –°–¢–ê–†–®–ò–ú–ò –°–ú–ï–ù–ê–ú–ò ==========

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ —Å–º–µ–Ω—ã (–ø—Ä–æ—Å—Ç–∞—è –º–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è)
function selectMobileShift(shiftType, clickedButton) {
  // –£–±–∏—Ä–∞–µ–º active –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
  const allButtons = document.querySelectorAll('.shift-button');
  allButtons.forEach(btn => btn.classList.remove('active'));
  
  // –î–æ–±–∞–≤–ª—è–µ–º active –∫–ª–∞—Å—Å –∫ –Ω–∞–∂–∞—Ç–æ–π –∫–Ω–æ–ø–∫–µ
  clickedButton.classList.add('active');
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–∏–ø —Å–º–µ–Ω—ã
  const hiddenInput = document.getElementById('selectedShiftType');
  if (hiddenInput) {
    hiddenInput.value = shiftType;
  }
  
  // –¢–∞–∫—Ç–∏–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
  if ('vibrate' in navigator) {
    navigator.vibrate(50); // –õ–µ–≥–∫–∞—è –≤–∏–±—Ä–∞—Ü–∏—è 50ms
  }
  
  console.log('–í—ã–±—Ä–∞–Ω —Ç–∏–ø —Å–º–µ–Ω—ã:', shiftType);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ —Å–º–µ–Ω—ã
function getSelectedShiftType() {
  const hiddenInput = document.getElementById('selectedShiftType');
  return hiddenInput ? hiddenInput.value : '–î–µ–Ω—å';
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫ —Å–º–µ–Ω—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ä–º—ã
function initMobileShiftButtons() {
  const dayButton = document.querySelector('.shift-button:first-child');
  const hiddenInput = document.getElementById('selectedShiftType');
  
  if (dayButton && hiddenInput) {
    // –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ –∫–Ω–æ–ø–∫–∞ "–î–µ–Ω—å" –∞–∫—Ç–∏–≤–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    dayButton.classList.add('active');
    hiddenInput.value = '–î–µ–Ω—å';
    console.log('–§–æ—Ä–º–∞ —Å—Ç–∞—Ä—à–µ–≥–æ —Å–º–µ–Ω—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞: –î–µ–Ω—å –≤—ã–±—Ä–∞–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é');
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—ã–±–æ—Ä–æ–º —Ä–∞–¥–∏–æ–∫–Ω–æ–ø–æ–∫ –≤ –∫–æ–º–ø–∞–∫—Ç–Ω–æ–π —Ñ–æ—Ä–º–µ (—Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
function updateRadioSelection(selectedLabel) {
  // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å selected —É –≤—Å–µ—Ö —Ä–∞–¥–∏–æ–∫–Ω–æ–ø–æ–∫ –≤ –≥—Ä—É–ø–ø–µ
  const radioGroup = selectedLabel.closest('.radio-group');
  const allLabels = radioGroup.querySelectorAll('label');
  allLabels.forEach(label => label.classList.remove('selected'));
  
  // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å selected –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ä–∞–¥–∏–æ–∫–Ω–æ–ø–∫–µ
  selectedLabel.classList.add('selected');
  
  // –û—Ç–º–µ—á–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π input –∫–∞–∫ checked
  const radioInput = selectedLabel.querySelector('input[type="radio"]');
  if (radioInput) {
    radioInput.checked = true;
  }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ä–∞–¥–∏–æ–∫–Ω–æ–ø–æ–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–æ—Ä–º—ã
function initRadioButtons() {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
  const dayInput = document.getElementById('dayShift');
  const nightInput = document.getElementById('nightShift');
  
  if (dayInput && nightInput) {
    // –ù–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ–º selectShiftType
    if (dayInput.checked) {
      selectShiftType('–¥–µ–Ω—å');
    } else if (nightInput.checked) {
      selectShiftType('–Ω–æ—á—å');
    }
  } else {
    // –°—Ç–∞—Ä–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥
    const radioGroups = document.querySelectorAll('.radio-group');
    radioGroups.forEach(group => {
      const checkedInput = group.querySelector('input[type="radio"]:checked');
      if (checkedInput) {
        const parentLabel = checkedInput.closest('label');
        if (parentLabel) parentLabel.classList.add('selected');
      }
    });
  }
}

// –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—à–µ–≥–æ —Å–º–µ–Ω—ã
async function showSeniorShiftForm() {
  clearReports(); // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ—Ç—á–µ—Ç—ã
  
  const container = document.getElementById("reportContainer");
  
  container.innerHTML = `
    <div class="senior-shift-form">
      <h3>üë• –î–æ–±–∞–≤–∏—Ç—å —Å–º–µ–Ω—É</h3>
      
      <div>
        <!-- –°—Ç–∞—Ä—à–∏–π —Å–º–µ–Ω—ã -->
        <div class="form-row">
          <div>
            <label for="seniorSelect">üë®‚Äçüíº –°—Ç–∞—Ä—à–∏–π —Å–º–µ–Ω—ã:</label>
            <select id="seniorSelect" required>
              <option value="">‚åõ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞...</option>
            </select>
          </div>
        </div>
        
        <!-- –ü–æ–º–æ—â–Ω–∏–∫ -->
        <div class="form-row">
          <div>
            <label for="helperSelect">üë§ –ü–æ–º–æ—â–Ω–∏–∫ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
            <select id="helperSelect">
              <option value="">‚åõ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞...</option>
            </select>
          </div>
        </div>
        
        <!-- –¢–∏–ø —Å–º–µ–Ω—ã -->
        <div class="form-row">
          <div>
            <label>üåÖüåô –¢–∏–ø —Å–º–µ–Ω—ã:</label>
            <div class="shift-buttons">
              <button type="button" class="shift-button active" onclick="selectMobileShift('–î–µ–Ω—å', this)">
                üåÖ –î–µ–Ω—å
              </button>
              <button type="button" class="shift-button" onclick="selectMobileShift('–ù–æ—á—å', this)">
                üåô –ù–æ—á—å
              </button>
            </div>
            <input type="hidden" id="selectedShiftType" value="–î–µ–Ω—å">
          </div>
        </div>
        
        <!-- –î–∞—Ç–∞ -->
        <div class="form-row">
          <div>
            <label for="customDate">üìÖ –î–∞—Ç–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
            <input type="date" id="customDate">
          </div>
        </div>
        
        <div class="info-text">
          üí° –î–∞—Ç–∞ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ —Ç–∏–ø—É —Å–º–µ–Ω—ã
        </div>
        
        <!-- –ö–Ω–æ–ø–∫–∏ -->
        <div class="button-group">
          <button onclick="addSeniorShiftRecord()" id="addSeniorRecordBtn" 
                  style="background: #22c55e; color: white; border: none; cursor: pointer; touch-action: manipulation;">
            ‚ûï –î–æ–±–∞–≤–∏—Ç—å
          </button>
          <button onclick="clearReports()" 
                  style="background: #6b7280; color: white; border: none; cursor: pointer; touch-action: manipulation;">
            ‚ùå –û—Ç–º–µ–Ω–∏—Ç—å
          </button>
        </div>
        
        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç -->
        <div id="seniorShiftResult"></div>
      </div>
    </div>
  `;
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å—Ç–∞—Ä—à–∏—Ö —Å–º–µ–Ω
  await loadSeniorsListForForm();
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ —Å–º–µ–Ω—ã
  initMobileShiftButtons();
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Å—Ç–∞—Ä—à–∏—Ö —Å–º–µ–Ω –¥–ª—è —Ñ–æ—Ä–º—ã –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞
async function loadSeniorsListForForm() {
  try {
    const res = await fetch(`${scriptURL}?type=getSeniorsAndHelpers`);
    const data = await res.json();

    const seniorSelect = document.getElementById("seniorSelect");
    const helperSelect = document.getElementById("helperSelect");

    if (data.error) {
      console.error("–û—à–∏–±–∫–∞ API:", data.error);
      seniorSelect.innerHTML = `<option value="">‚ùå ${data.error}</option>`;
      helperSelect.innerHTML = `<option value="">-- –ë–µ–∑ –ø–æ–º–æ—â–Ω–∏–∫–∞ --</option>`;
      return;
    }

    const seniors = data.seniors || [];
    const helpers = data.helpers || [];
    const pairs = data.pairs || [];

    if (seniors.length === 0) {
      seniorSelect.innerHTML = `<option value="">‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ</option>`;
      helperSelect.innerHTML = `<option value="">-- –ë–µ–∑ –ø–æ–º–æ—â–Ω–∏–∫–∞ --</option>`;
      return;
    }

    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ —Å—Ç–∞—Ä—à–∏—Ö —Å–º–µ–Ω
    seniorSelect.innerHTML = `<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ä—à–µ–≥–æ —Å–º–µ–Ω—ã --</option>`;
    seniors.forEach(senior => {
      const opt = document.createElement("option");
      opt.value = senior;
      opt.textContent = senior;
      seniorSelect.appendChild(opt);
    });

    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–º–æ—â–Ω–∏–∫–æ–≤ (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø–æ–º–æ—â–Ω–∏–∫–æ–≤ + –æ–ø—Ü–∏—è –±–µ–∑ –ø–æ–º–æ—â–Ω–∏–∫–∞)
    helperSelect.innerHTML = `<option value="">-- –ë–µ–∑ –ø–æ–º–æ—â–Ω–∏–∫–∞ --</option>`;
    helpers.forEach(helper => {
      const opt = document.createElement("option");
      opt.value = helper;
      opt.textContent = helper;
      helperSelect.appendChild(opt);
    });

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ –ø–∞—Ä–∞—Ö –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤—ã–±–æ—Ä–∞
    window.seniorHelperPairs = pairs;

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤—ã–±–æ—Ä–∞ –ø–æ–º–æ—â–Ω–∏–∫–∞
    seniorSelect.addEventListener('change', function() {
      const selectedSenior = this.value;
      if (selectedSenior && window.seniorHelperPairs) {
        const pair = window.seniorHelperPairs.find(p => p.senior === selectedSenior);
        if (pair && pair.helper) {
          helperSelect.value = pair.helper;
          console.log(`ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±—Ä–∞–Ω –ø–æ–º–æ—â–Ω–∏–∫: ${pair.helper} –¥–ª—è ${selectedSenior}`);
        } else {
          helperSelect.value = "";
        }
      }
    });

    console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${seniors.length} —Å—Ç–∞—Ä—à–∏—Ö, ${helpers.length} –ø–æ–º–æ—â–Ω–∏–∫–æ–≤, ${pairs.length} –ø–∞—Ä`);
  } catch (err) {
    const seniorSelect = document.getElementById("seniorSelect");
    const helperSelect = document.getElementById("helperSelect");
    seniorSelect.innerHTML = `<option value="">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞</option>`;
    helperSelect.innerHTML = `<option value="">-- –ë–µ–∑ –ø–æ–º–æ—â–Ω–∏–∫–∞ --</option>`;
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ —Å—Ç–∞—Ä—à–∏—Ö —Å–º–µ–Ω:", err);
  }
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ —Å—Ç–∞—Ä—à–µ–≥–æ —Å–º–µ–Ω—ã
async function addSeniorShiftRecord() {
  const btn = document.getElementById("addSeniorRecordBtn");
  const resultBox = document.getElementById("seniorShiftResult");
  
  // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–æ—Ä–º—ã
  const seniorName = document.getElementById("seniorSelect").value.trim();
  const helperName = document.getElementById("helperSelect").value.trim();
  const shiftType = getSelectedShiftType(); // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏
  const customDate = document.getElementById("customDate").value;
  
  // –í–∞–ª–∏–¥–∞—Ü–∏—è
  if (!seniorName) {
    resultBox.style.color = '#dc2626';
    resultBox.textContent = "‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ä—à–µ–≥–æ —Å–º–µ–Ω—ã";
    return;
  }
  
  if (helperName && seniorName === helperName) {
    resultBox.style.color = '#dc2626';
    resultBox.textContent = "‚ùå –°—Ç–∞—Ä—à–∏–π —Å–º–µ–Ω—ã –∏ –ø–æ–º–æ—â–Ω–∏–∫ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–∞–∑–Ω—ã–º–∏ –ª—é–¥—å–º–∏";
    return;
  }
  
  // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–Ω–æ–ø–∫–∏
  btn.disabled = true;
  const originalText = btn.textContent;
  btn.textContent = "‚è≥ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ...";
  resultBox.textContent = "";
  
  try {
    // –°–æ–∑–¥–∞–µ–º –∑–∞–ø—Ä–æ—Å –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—à–µ–≥–æ —Å–º–µ–Ω—ã —á–µ—Ä–µ–∑ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π endpoint
    const params = new URLSearchParams({
      type: 'addSeniorShift',
      seniorName: seniorName,
      helperName: helperName || '',
      shiftType: shiftType
    });
    
    if (customDate) {
      params.append('shiftDate', customDate);
    }
    
    const response = await fetch(`${scriptURL}?${params}`, {
      method: 'GET'
    });
    
    const result = await response.json();
    
    if (result.status === 'success') {
      resultBox.style.color = '#22c55e';
      resultBox.textContent = result.message;
      
      // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
      document.getElementById("customDate").value = '';
      document.getElementById("seniorSelect").selectedIndex = 0;
      document.getElementById("helperSelect").selectedIndex = 0;
      document.querySelector('input[name="shiftType"][value="–î–µ–Ω—å"]').checked = true;
      
      console.log('‚úÖ –ó–∞–ø–∏—Å–∏ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω—ã:', result.data);
    } else {
      resultBox.style.color = '#dc2626';
      resultBox.textContent = result.message || '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–µ–π';
    }
    
  } catch (err) {
    resultBox.style.color = '#dc2626';
    resultBox.textContent = `‚ùå –û—à–∏–±–∫–∞: ${err.message}`;
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–µ–π —Å–º–µ–Ω—ã:", err);
  } finally {
    btn.disabled = false;
    btn.textContent = originalText;
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Å—Ç–∞—Ä—à–∏—Ö —Å–º–µ–Ω –¥–ª—è —Å–µ–ª–µ–∫—Ç–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –∑–∞—Ä–ø–ª–∞—Ç—ã
async function loadSalaryExportSeniors() {
  try {
    const res = await fetch(`${scriptURL}?type=getSeniorsAndHelpers`);
    const data = await res.json();

    const select = document.getElementById("salaryExportSenior");

    if (data.error) {
      select.innerHTML = `<option value="">‚ùå ${data.error}</option>`;
      return;
    }

    const seniors = data.seniors || [];

    select.innerHTML = `<option value="">-- –í—Å–µ --</option>`;
    seniors.forEach(senior => {
      const opt = document.createElement("option");
      opt.value = senior;
      opt.textContent = senior;
      select.appendChild(opt);
    });
    
    console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞: ${seniors.length} —Å—Ç–∞—Ä—à–∏—Ö —Å–º–µ–Ω`);
  } catch (err) {
    document.getElementById("salaryExportResult").textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ —Å—Ç–∞—Ä—à–∏—Ö —Å–º–µ–Ω!";
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ —Å—Ç–∞—Ä—à–∏—Ö —Å–º–µ–Ω:", err);
  }
}

async function submitSalaryExport() {
  const btn = document.getElementById("submitSalaryExportBtn");
  const resultBox = document.getElementById("salaryExportResult");

  // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–Ω–æ–ø–∫–∏ –∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
  btn.disabled = true;
  const originalText = btn.textContent;
  btn.textContent = "‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...";
  resultBox.textContent = "";

  const start = document.getElementById("salaryExportStart").value;
  const end = document.getElementById("salaryExportEnd").value;
  const exportType = document.querySelector('input[name="exportType"]:checked').value;

  if (!start || !end) {
    resultBox.textContent = "‚ùó –£–∫–∞–∂–∏—Ç–µ –æ–±–µ –¥–∞—Ç—ã!";
    btn.disabled = false;
    btn.textContent = originalText;
    return;
  }

  let scriptUrl = scriptURL;
  let fetchOptions = {};

  if (exportType === 'seniors') {
    // –î–ª—è —Å—Ç–∞—Ä—à–∏—Ö —Å–º–µ–Ω –∏—Å–ø–æ–ª—å–∑—É–µ–º GET-–∑–∞–ø—Ä–æ—Å –∫ exportSeniorsForAccounting
    const senior = document.getElementById("salaryExportSenior").value;
    const params = new URLSearchParams({
        type: "exportSeniorsForAccounting",
        start,
        end
    });
    if (senior) {
        params.append("seniors", senior);
    }
    scriptUrl = `${scriptURL}?${params.toString()}`;
  } else { 
    // –î–ª—è —É–ø–∞–∫–æ–≤—â–∏–∫–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º GET-–∑–∞–ø—Ä–æ—Å –∫ exportForAccounting
    const employee = document.getElementById("salaryExportEmployee").value;
    const params = new URLSearchParams({
        type: "exportForAccounting",
        start,
        end
    });
    if (employee) {
        params.append("employees", employee);
    }
    scriptUrl = `${scriptURL}?${params.toString()}`;
  }
  
  try {
    const res = await fetch(scriptUrl);
    const text = await res.text();
    
    resultBox.style.color = text.includes("‚úÖ") ? '#059669' : '#dc2626';
    resultBox.textContent = text;
    
    if (text.includes("‚úÖ")) {
        setTimeout(closeSalaryExportModal, 3000);
    }
  } catch (err) {
    console.error(err);
    resultBox.style.color = '#dc2626';
    resultBox.textContent = "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞";
  } finally {
    btn.disabled = false;
    btn.textContent = originalText;
  }
}

async function checkUserStructure() {
  const btn = document.getElementById("checkStructureBtn");
  const container = document.getElementById("reportContainer");
  
  btn.disabled = true;
  const originalText = btn.textContent;
  btn.textContent = "‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...";
  
  try {
    const res = await fetch(`${scriptURL}?type=checkUserStructure`);
    const data = await res.json();
    
    if (data.error) {
      container.innerHTML = `<div style="color: red; padding: 16px; background: #fef2f2; border-radius: 8px;">
        <h3>‚ùå –û—à–∏–±–∫–∞</h3>
        <p>${data.error}</p>
      </div>`;
      return;
    }
    
    const structure = data.structure;
    let html = `
      <div style="padding: 16px; background: #f0f9ff; border-radius: 8px; margin-top: 16px;">
        <h3>üîç –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
        <p><strong>–í—Å–µ–≥–æ —Å—Ç—Ä–æ–∫:</strong> ${structure.totalRows}</p>
        <p><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–ª–æ–Ω–æ–∫:</strong> ${structure.columnCount}</p>
        
        <h4>üìã –ó–∞–≥–æ–ª–æ–≤–∫–∏:</h4>
        <div style="background: white; padding: 8px; border-radius: 4px; margin: 8px 0;">
          ${structure.headers.map((header, index) => `<span style="display: inline-block; margin-right: 16px;"><strong>${index}:</strong> ${header || '(–ø—É—Å—Ç–æ)'}</span>`).join('')}
        </div>
        
        <h4>üìä –ü—Ä–∏–º–µ—Ä—ã –¥–∞–Ω–Ω—ã—Ö (–ø–µ—Ä–≤—ã–µ 3 —Å—Ç—Ä–æ–∫–∏):</h4>
        ${structure.sampleData.map((row, index) => `
          <div style="background: white; padding: 8px; border-radius: 4px; margin: 8px 0; font-family: monospace;">
            <strong>–°—Ç—Ä–æ–∫–∞ ${index + 1}:</strong> ${row.map((cell, cellIndex) => `<span style="margin-right: 16px;"><strong>${cellIndex}:</strong> ${cell || '(–ø—É—Å—Ç–æ)'}</span>`).join('')}
          </div>
        `).join('')}
        
        <div style="margin-top: 16px; padding: 12px; background: #fef3c7; border-radius: 4px;">
          <h4>üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞:</h4>
          <p>–û–∫–ª–∞–¥ –¥–æ–ª–∂–µ–Ω –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤ –∫–æ–ª–æ–Ω–∫–µ —Å –∏–Ω–¥–µ–∫—Å–æ–º <strong>4</strong> (5-—è –∫–æ–ª–æ–Ω–∫–∞).</p>
          <p>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–ª–∂–Ω–æ –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤ –∫–æ–ª–æ–Ω–∫–µ —Å –∏–Ω–¥–µ–∫—Å–æ–º <strong>0</strong> (1-—è –∫–æ–ª–æ–Ω–∫–∞).</p>
        </div>
      </div>
    `;
    
    container.innerHTML = html;
    
  } catch (error) {
    console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã:", error);
    container.innerHTML = `<div style="color: red; padding: 16px; background: #fef2f2; border-radius: 8px;">
      <h3>‚ùå –û—à–∏–±–∫–∞</h3>
      <p>–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞: ${error.message}</p>
    </div>`;
  } finally {
    btn.disabled = false;
    btn.textContent = originalText;
  }
}

// ===== –§–£–ù–ö–¶–ò–ò –£–õ–£–ß–®–ï–ù–ù–û–ô –ó–ê–©–ò–¢–´ –û–¢ –î–£–ë–õ–ò–ö–ê–¢–û–í =====

/**
 * –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤—Å–µ —Ç–∏–ø—ã –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
 */
function analyzeAllDuplicates(payload) {
  duplicateWarnings = { exact: [], similar: [], suspicious: [] };
  
  todayRecords.forEach((rec, index) => {
    // 1. –¢–æ—á–Ω—ã–µ –¥—É–±–ª–∏–∫–∞—Ç—ã (—Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞)
    if (isExactDuplicate(rec, payload)) {
      duplicateWarnings.exact.push({ record: rec, index, reason: "–ü–æ–ª–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ" });
    }
    
    // 2. –ü–æ—Ö–æ–∂–∏–µ –∑–∞–ø–∏—Å–∏ (–Ω–æ–≤–∞—è –ª–æ–≥–∏–∫–∞)
    else if (isSimilarRecord(rec, payload)) {
      const similarities = findSimilarities(rec, payload);
      duplicateWarnings.similar.push({ 
        record: rec, 
        index, 
        reason: `–ü–æ—Ö–æ–∂–µ –Ω–∞: ${similarities.join(", ")}`,
        similarities 
      });
    }
    
    // 3. –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–ø–∏—Å–∏
    else if (isSuspiciousRecord(rec, payload)) {
      const suspicions = findSuspicions(rec, payload);
      duplicateWarnings.suspicious.push({ 
        record: rec, 
        index, 
        reason: `–ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ: ${suspicions.join(", ")}`,
        suspicions 
      });
    }
  });
}

/**
 * –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ—á–Ω–æ–≥–æ –¥—É–±–ª–∏–∫–∞—Ç–∞ (—Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞)
 */
function isExactDuplicate(rec, payload) {
  const isSame =
    rec.employeeName === payload.employeeName &&
    rec.quantity === payload.quantity &&
    rec.startTime === payload.startTime &&
    rec.endTime === payload.endTime &&
    rec.operationType === payload.operationType &&
    rec.orderNumber === payload.orderNumber &&
    rec.setNumber === payload.setNumber;

  if (!isSame) return false;
  if (payload.operationType !== '–°–±–æ—Ä–∫–∞ "–ù–∞–±–æ—Ä–∞"') {
    return rec.volume === payload.volume;
  }
  return true;
}

/**
 * –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ö–æ–∂–µ–π –∑–∞–ø–∏—Å–∏
 */
function isSimilarRecord(rec, payload) {
  if (rec.employeeName !== payload.employeeName) return false;
  
  let similarities = 0;
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (¬±10%)
  if (payload.quantity && rec.quantity) {
    const diff = Math.abs(Number(payload.quantity) - Number(rec.quantity));
    const threshold = Number(rec.quantity) * 0.1;
    if (diff <= threshold) similarities++;
  }
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ä–µ–º—è (¬±15 –º–∏–Ω—É—Ç)
  if (isTimeClose(rec.startTime, payload.startTime, 15) || 
      isTimeClose(rec.endTime, payload.endTime, 15)) {
    similarities++;
  }
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–ø–µ—Ä–∞—Ü–∏—é
  if (rec.operationType === payload.operationType) similarities++;
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—ä—ë–º/–∞—Ä—Ç–∏–∫—É–ª
  if (rec.volume === payload.volume || rec.setNumber === payload.setNumber) {
    similarities++;
  }
  
  // –ï—Å–ª–∏ 3+ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –∏–∑ 4 - —ç—Ç–æ –ø–æ—Ö–æ–∂–∞—è –∑–∞–ø–∏—Å—å
  return similarities >= 3;
}

/**
 * –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∑–∞–ø–∏—Å–∏
 */
function isSuspiciousRecord(rec, payload) {
  if (rec.employeeName !== payload.employeeName) return false;
  
  // –ü–µ—Ä–µ—Å–µ–∫–∞—é—â–µ–µ—Å—è –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã
  if (isTimeOverlapping(rec, payload)) return true;
  
  // –û—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –∑–∞–ø–∏—Å—è–º–∏
  if (isTimeGapTooShort(rec, payload)) return true;
  
  // –û–¥–∏–Ω–∞–∫–æ–≤–æ–µ –≤—Ä–µ–º—è, –Ω–æ —Ä–∞–∑–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
  if (rec.startTime === payload.startTime && rec.endTime === payload.endTime && 
      rec.operationType !== payload.operationType) return true;
      
  // –ù–µ–æ–±—ã—á–Ω–æ –≤—ã—Å–æ–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
  if (isUnusuallyHighQuantity(payload)) return true;
  
  return false;
}

/**
 * –ù–∞—Ö–æ–¥–∏—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å—Ö–æ–¥—Å—Ç–≤–∞ –º–µ–∂–¥—É –∑–∞–ø–∏—Å—è–º–∏
 */
function findSimilarities(rec, payload) {
  const similarities = [];
  
  if (Math.abs(Number(payload.quantity) - Number(rec.quantity)) <= Number(rec.quantity) * 0.1) {
    similarities.push("–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ");
  }
  
  if (isTimeClose(rec.startTime, payload.startTime, 15)) {
    similarities.push("–≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞");
  }
  
  if (isTimeClose(rec.endTime, payload.endTime, 15)) {
    similarities.push("–≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è");
  }
  
  if (rec.operationType === payload.operationType) {
    similarities.push("–æ–ø–µ—Ä–∞—Ü–∏—è");
  }
  
  if (rec.volume === payload.volume) {
    similarities.push("–æ–±—ä—ë–º");
  }
  
  if (rec.setNumber === payload.setNumber) {
    similarities.push("–∞—Ä—Ç–∏–∫—É–ª");
  }
  
  return similarities;
}

/**
 * –ù–∞—Ö–æ–¥–∏—Ç –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã
 */
function findSuspicions(rec, payload) {
  const suspicions = [];
  
  if (isTimeOverlapping(rec, payload)) {
    suspicions.push("–ø–µ—Ä–µ—Å–µ–∫–∞—é—â–µ–µ—Å—è –≤—Ä–µ–º—è");
  }
  
  if (isTimeGapTooShort(rec, payload)) {
    suspicions.push("—Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –ø–µ—Ä–µ—Ä—ã–≤");
  }
  
  if (rec.startTime === payload.startTime && rec.endTime === payload.endTime) {
    suspicions.push("–æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ –≤—Ä–µ–º—è");
  }
  
  if (isUnusuallyHighQuantity(payload)) {
    suspicions.push("–Ω–µ–æ–±—ã—á–Ω–æ –≤—ã—Å–æ–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å");
  }
  
  return suspicions;
}

/**
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –±–ª–∏–∑–∫–æ –ª–∏ –≤—Ä–µ–º—è (–≤ –º–∏–Ω—É—Ç–∞—Ö)
 */
function isTimeClose(time1, time2, minutesThreshold) {
  if (!time1 || !time2) return false;
  
  const [h1, m1] = time1.split(":").map(Number);
  const [h2, m2] = time2.split(":").map(Number);
  
  const minutes1 = h1 * 60 + m1;
  const minutes2 = h2 * 60 + m2;
  
  return Math.abs(minutes1 - minutes2) <= minutesThreshold;
}

/**
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ —Ä–∞–±–æ—Ç—ã
 */
function isTimeOverlapping(rec, payload) {
  if (!rec.startTime || !rec.endTime || !payload.startTime || !payload.endTime) return false;
  
  const recStart = timeToMinutes(rec.startTime);
  const recEnd = timeToMinutes(rec.endTime);
  const payloadStart = timeToMinutes(payload.startTime);
  const payloadEnd = timeToMinutes(payload.endTime);
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤
  return (payloadStart < recEnd) && (payloadEnd > recStart);
}

/**
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–ª–∏—à–∫–æ–º –ª–∏ –∫–æ—Ä–æ—Ç–∫–∏–π –ø—Ä–æ–º–µ–∂—É—Ç–æ–∫ –º–µ–∂–¥—É –∑–∞–ø–∏—Å—è–º–∏
 */
function isTimeGapTooShort(rec, payload) {
  if (!rec.endTime || !payload.startTime) return false;
  
  const recEnd = timeToMinutes(rec.endTime);
  const payloadStart = timeToMinutes(payload.startTime);
  
  // –ï—Å–ª–∏ –º–µ–∂–¥—É –æ–∫–æ–Ω—á–∞–Ω–∏–µ–º –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏ –∏ –Ω–∞—á–∞–ª–æ–º –¥—Ä—É–≥–æ–π –º–µ–Ω—å—à–µ 5 –º–∏–Ω—É—Ç
  const gap = Math.abs(payloadStart - recEnd);
  return gap < 5 && gap > 0;
}

/**
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–µ–æ–±—ã—á–Ω–æ –≤—ã—Å–æ–∫—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
 */
function isUnusuallyHighQuantity(payload) {
  if (!payload.quantity || !payload.startTime || !payload.endTime) return false;
  
  const duration = timeToMinutes(payload.endTime) - timeToMinutes(payload.startTime);
  if (duration <= 0) return false;
  
  const rate = Number(payload.quantity) / (duration / 60); // —à—Ç—É–∫ –≤ —á–∞—Å
  
  // –ù–∞—Ö–æ–¥–∏–º –Ω–æ—Ä–º—É –¥–ª—è —ç—Ç–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏
  const matchingRate = allRates.find(r => 
    r.operation === payload.operationType && 
    (r.key === payload.volume || r.key === payload.setNumber)
  );
  
  if (matchingRate && matchingRate.normPerHour > 0) {
    // –ï—Å–ª–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–µ–≤—ã—à–∞–µ—Ç –Ω–æ—Ä–º—É –≤ 2+ —Ä–∞–∑–∞
    return rate > matchingRate.normPerHour * 2;
  }
  
  return false;
}

/**
 * –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –≤—Ä–µ–º—è –≤ –º–∏–Ω—É—Ç—ã
 */
function timeToMinutes(timeStr) {
  const [hours, minutes] = timeStr.split(":").map(Number);
  return hours * 60 + minutes;
}

/**
 * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –¥—É–±–ª–∏–∫–∞—Ç–∞—Ö
 */
function showDuplicateWarnings() {
  const container = document.getElementById("duplicateWarnings") || createWarningsContainer();
  
  let html = "";
  
  // –¢–æ—á–Ω—ã–µ –¥—É–±–ª–∏–∫–∞—Ç—ã (–∫—Ä–∏—Ç–∏—á–Ω–æ)
  if (duplicateWarnings.exact.length > 0) {
    html += `
      <div class="warning-section critical">
        <h4>üö´ –¢–æ—á–Ω—ã–µ –¥—É–±–ª–∏–∫–∞—Ç—ã (${duplicateWarnings.exact.length})</h4>
        ${duplicateWarnings.exact.map(w => 
          `<div class="warning-item critical">
            <strong>–ó–∞–ø–∏—Å—å #${w.index + 1}:</strong> ${w.reason}<br>
            <small>${formatRecordSummary(w.record)}</small>
          </div>`
        ).join('')}
      </div>
    `;
  }
  
  // –ü–æ—Ö–æ–∂–∏–µ –∑–∞–ø–∏—Å–∏ (–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ)
  if (duplicateWarnings.similar.length > 0) {
    html += `
      <div class="warning-section warning">
        <h4>‚ö†Ô∏è –ü–æ—Ö–æ–∂–∏–µ –∑–∞–ø–∏—Å–∏ (${duplicateWarnings.similar.length})</h4>
        ${duplicateWarnings.similar.map(w => 
          `<div class="warning-item warning">
            <strong>–ó–∞–ø–∏—Å—å #${w.index + 1}:</strong> ${w.reason}<br>
            <small>${formatRecordSummary(w.record)}</small>
          </div>`
        ).join('')}
      </div>
    `;
  }
  
  // –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–ø–∏—Å–∏ (—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ)
  if (duplicateWarnings.suspicious.length > 0) {
    html += `
      <div class="warning-section info">
        <h4>üîç –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–ø–∏—Å–∏ (${duplicateWarnings.suspicious.length})</h4>
        ${duplicateWarnings.suspicious.map(w => 
          `<div class="warning-item info">
            <strong>–ó–∞–ø–∏—Å—å #${w.index + 1}:</strong> ${w.reason}<br>
            <small>${formatRecordSummary(w.record)}</small>
          </div>`
        ).join('')}
      </div>
    `;
  }
  
  if (html) {
    container.innerHTML = html;
    container.style.display = "block";
  } else {
    container.style.display = "none";
  }
}

/**
 * –°–æ–∑–¥–∞–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
 */
function createWarningsContainer() {
  const existing = document.getElementById("duplicateWarnings");
  if (existing) return existing;
  
  const container = document.createElement("div");
  container.id = "duplicateWarnings";
  container.className = "duplicate-warnings";
  
  // –í—Å—Ç–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–¥ —Ñ–æ—Ä–º–æ–π
  const form = document.getElementById("dataForm");
  form.parentNode.insertBefore(container, form);
  
  return container;
}

/**
 * –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –∫—Ä–∞—Ç–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–ø–∏—Å–∏
 */
function formatRecordSummary(record) {
  return `${record.operationType} ‚Ä¢ ${record.quantity}—à—Ç ‚Ä¢ ${record.startTime}-${record.endTime} ‚Ä¢ ${record.volume || record.setNumber || 'N/A'}`;
}

/**
 * –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∞ —Ñ–æ—Ä–º—ã
 */
function saveDraft() {
  const formData = new FormData(document.getElementById("dataForm"));
  const draft = {};
  formData.forEach((value, key) => {
    draft[key] = value;
  });
  
  draft.timestamp = Date.now();
  localStorage.setItem("formDraft", JSON.stringify(draft));
}

/**
 * –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∞ —Ñ–æ—Ä–º—ã
 */
function restoreDraft() {
  const draftStr = localStorage.getItem("formDraft");
  if (!draftStr) return false;
  
  try {
    const draft = JSON.parse(draftStr);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å–ª–∏—à–∫–æ–º –ª–∏ —Å—Ç–∞—Ä—ã–π —á–µ—Ä–Ω–æ–≤–∏–∫ (–±–æ–ª—å—à–µ 1 —á–∞—Å–∞)
    if (Date.now() - draft.timestamp > 60 * 60 * 1000) {
      localStorage.removeItem("formDraft");
      return false;
    }
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–ª—è
    Object.entries(draft).forEach(([key, value]) => {
      if (key !== 'timestamp') {
        const field = document.querySelector(`[name="${key}"]`);
        if (field) field.value = value;
      }
    });
    
    return true;
  } catch (error) {
    localStorage.removeItem("formDraft");
    return false;
  }
}

/**
 * –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
 */
function setupRealTimeValidation() {
  const form = document.getElementById("dataForm");
  const fields = ['quantity', 'startTime', 'endTime', 'operationType', 'volume', 'setNumber', 'orderNumber'];
  
  fields.forEach(fieldName => {
    const field = form.querySelector(`[name="${fieldName}"]`);
    if (field) {
      field.addEventListener('input', debounce(validateFormRealTime, 500));
      field.addEventListener('change', validateFormRealTime);
    }
  });
}

/**
 * –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
 */
function validateFormRealTime() {
  const form = document.getElementById("dataForm");
  if (!form) return;
  
  const formData = new FormData(form);
  
  const payload = {
    employeeName: currentUser,
    quantity: formData.get("quantity")?.trim(),
    startTime: formData.get("startTime")?.trim(),
    endTime: formData.get("endTime")?.trim(),
    volume: formData.get("volume")?.trim(),
    operationType: formData.get("operationType")?.trim(),
    orderNumber: formData.get("orderNumber")?.trim(),
    setNumber: formData.get("setNumber")?.trim(),
    shiftType: currentShift,
    employeeStatus: currentStatus
  };
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –∫–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è
  if (payload.employeeName && payload.quantity && payload.startTime && 
      payload.endTime && payload.operationType) {
    
    // üö´ –û–¢–ö–õ–Æ–ß–ï–ù–û: analyzeAllDuplicates(payload);
    // üö´ –û–¢–ö–õ–Æ–ß–ï–ù–û: showDuplicateWarnings();
    saveDraft(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–µ—Ä–Ω–æ–≤–∏–∫
  }
}

/**
 * –î–µ–±–∞—É–Ω—Å —Ñ—É–Ω–∫—Ü–∏—è
 */
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// ===== –§–£–ù–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ò–ù–¢–ï–†–§–ï–ô–°–û–ú =====

/**
 * –ü–æ–ª–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
 */
async function performFullInterfaceRefresh() {
  try {
  
    
    // 1. –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã –∫ –Ω–∞—á–∞–ª—å–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é (–±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏)
    resetFormToInitialState();
    
    // 2. –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (—Ç–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–∏ –∑–∞ —Å–µ–≥–æ–¥–Ω—è)
    loadTodayRecords(); // –ó–∞–ø—É—Å–∫–∞–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, –Ω–µ –∂–¥–µ–º
    
    // 3. –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –∏ —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤
    hideAllWarnings();
    clearDraft();
    
    // 4. –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏
    enableSubmitButton();
    

    
    // 5. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
    showTemporaryNotification("‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã!", "success");
    
  } catch (error) {
    console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞:", error);
    enableSubmitButton();
    showTemporaryNotification("‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã, –Ω–æ –≤–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞", "warning");
  }
}

/**
 * –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã –∫ –Ω–∞—á–∞–ª—å–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é
 */
function resetFormToInitialState() {
  const form = document.getElementById("dataForm");
  
  // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
  form.reset();
  
  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è
  document.querySelector('[name="employeeName"]').value = currentUser;
  
  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –æ–ø–µ—Ä–∞—Ü–∏—é –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –ø–æ–ª—è
  handleOperationChange("");
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞—Å—á–µ—Ç —Ç–∞—Ä–∏—Ñ–æ–≤
  updateRateDisplay();
  
  // –û—á–∏—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö
  const result = document.getElementById("result");
  if (result) {
    result.style.display = "none";
    result.className = "";
    result.textContent = "";
  }
  
  
}

/**
 * –í–∫–ª—é—á–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏
 */
function enableSubmitButton() {
  const form = document.getElementById("dataForm");
  const submitBtn = document.querySelector('#dataForm button[type="submit"]');
  
  if (submitBtn) {
    submitBtn.disabled = false;
    submitBtn.textContent = "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å";
    submitBtn.style.opacity = "1";
    submitBtn.style.cursor = "pointer";
    submitBtn.classList.remove("loading");
  }
  
  if (form) {
    form.classList.remove("form-disabled");
  }
}

/**
 * –°–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
 */
function hideAllWarnings() {
  const warningsContainer = document.getElementById("duplicateWarnings");
  if (warningsContainer) {
    warningsContainer.style.display = "none";
    warningsContainer.innerHTML = "";
  }
  
  // –°–±—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è—Ö
  duplicateWarnings = { exact: [], similar: [], suspicious: [] };
}

/**
 * –û—á–∏—Å—Ç–∫–∞ —á–µ—Ä–Ω–æ–≤–∏–∫–∞
 */
function clearDraft() {
  localStorage.removeItem("formDraft");
  
}

// ===== –§–£–ù–ö–¶–ò–ò –î–ï–î–£–ü–õ–ò–ö–ê–¶–ò–ò =====

/**
 * üîç –ê–Ω–∞–ª–∏–∑ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è (–¥–ª—è –æ—Ç–¥–µ–ª—å–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏)
 */
async function analyzeDuplicatesInTab() {
  const loader = document.getElementById("duplicatesLoader");
  const resultsDiv = document.getElementById("duplicatesAnalysisResults");
  
  // –°–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
  hideAllResults();
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
  loader.style.display = "block";
  
  try {
    const response = await fetch(scriptURL, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams({ type: "analyzeDuplicates" })
    });
    
    if (!response.ok) throw new Error("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
    
    const result = await response.json();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    updateDuplicatesStats(result.analyzed, result.total, 0, 0);
    
    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    if (result.total > 0) {
      resultsDiv.innerHTML = `
        <h4>üîç –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤</h4>
        <div style="margin-bottom: 16px;">
          <strong>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</strong><br>
          ‚Ä¢ –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${result.analyzed}<br>
          ‚Ä¢ –ù–∞–π–¥–µ–Ω–æ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤: ${result.total}
        </div>
        <div style="margin-bottom: 16px;">
          <strong>üìã –î–µ—Ç–∞–ª–∏:</strong><br>
          ${result.details.map(detail => `‚Ä¢ ${detail}`).join('<br>')}
        </div>
        <div style="background: #fff3cd; padding: 12px; border-radius: 8px; border: 1px solid #ffeaa7;">
          <strong>‚ö†Ô∏è –ù–∞–π–¥–µ–Ω—ã –¥—É–±–ª–∏–∫–∞—Ç—ã!</strong><br>
          –î–ª—è –∏—Ö —É–¥–∞–ª–µ–Ω–∏—è –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã"
        </div>
      `;
    } else {
      resultsDiv.innerHTML = `
        <div style="text-align: center; color: #059669;">
          <h4>‚úÖ –î—É–±–ª–∏–∫–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h4>
          <p>–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${result.analyzed}</p>
          <p>–í—Å–µ –¥–∞–Ω–Ω—ã–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã!</p>
        </div>
      `;
    }
    
    resultsDiv.style.display = "block";
    
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤:", error);
    resultsDiv.innerHTML = `
      <div style="color: #dc2626; text-align: center;">
        <h4>‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞</h4>
        <p>${error.message}</p>
      </div>
    `;
    resultsDiv.style.display = "block";
  } finally {
    loader.style.display = "none";
  }
}

/**
 * üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ (–¥–ª—è –æ—Ç–¥–µ–ª—å–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏)
 */
async function runDeduplicateInTab() {
  // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
  if (!confirm("‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï!\n\n–í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å —É–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã.\n–î—É–±–ª–∏–∫–∞—Ç—ã –±—É–¥—É—Ç –ø–µ—Ä–µ–º–µ—â–µ–Ω—ã –≤ –∫–∞—Ä–∞–Ω—Ç–∏–Ω.\n\n–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?")) {
    return;
  }
  
  const loader = document.getElementById("duplicatesLoader");
  const resultsDiv = document.getElementById("deduplicationResults");
  
  // –°–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
  hideAllResults();
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
  loader.style.display = "block";
  
  try {
    const response = await fetch(scriptURL, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams({ type: "runSafeDeduplicate" })
    });
    
    if (!response.ok) throw new Error("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
    
    const result = await response.json();
    
    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    if (result.success) {
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
      updateDuplicatesStats(result.analyzed, result.found, result.deleted, result.quarantined);
      
      resultsDiv.innerHTML = `
        <h4>‚úÖ –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞</h4>
        <div style="margin-bottom: 16px;">
          <strong>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</strong><br>
          ‚Ä¢ –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${result.analyzed}<br>
          ‚Ä¢ –ù–∞–π–¥–µ–Ω–æ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤: ${result.found}<br>
          ‚Ä¢ –£–¥–∞–ª–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${result.deleted}<br>
          ‚Ä¢ –ü–æ–º–µ—â–µ–Ω–æ –≤ –∫–∞—Ä–∞–Ω—Ç–∏–Ω: ${result.quarantined}
        </div>
        ${result.message ? `<div style="margin-bottom: 16px;"><strong>üìù –î–µ—Ç–∞–ª–∏:</strong><br>${result.message}</div>` : ''}
        <div style="background: #d1fae5; padding: 12px; border-radius: 8px; border: 1px solid #a7f3d0;">
          <strong>üéâ –û–ø–µ—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!</strong><br>
          –î—É–±–ª–∏–∫–∞—Ç—ã —É–¥–∞–ª–µ–Ω—ã –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –∫–∞—Ä–∞–Ω—Ç–∏–Ω–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.
        </div>
      `;
    } else {
      resultsDiv.innerHTML = `
        <div style="color: #dc2626; text-align: center;">
          <h4>‚ùå –û—à–∏–±–∫–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏</h4>
          <p>${result.message || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"}</p>
        </div>
      `;
    }
    
    resultsDiv.style.display = "block";
    
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏:", error);
    resultsDiv.innerHTML = `
      <div style="color: #dc2626; text-align: center;">
        <h4>‚ùå –û—à–∏–±–∫–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏</h4>
        <p>${error.message}</p>
      </div>
    `;
    resultsDiv.style.display = "block";
  } finally {
    loader.style.display = "none";
  }
}

// ===== –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –í–ö–õ–ê–î–ö–ò –î–£–ë–õ–ò–ö–ê–¢–û–í =====

/**
 * –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏
 */
async function loadDuplicatesStats() {
  const statsDiv = document.getElementById("duplicatesStats");
  statsDiv.style.display = "block";
  
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
  updateDuplicatesStats(0, 0, 0, 0);
}

/**
 * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
 */
function updateDuplicatesStats(total, found, removed, quarantine) {
  document.getElementById("totalRecords").textContent = total;
  document.getElementById("duplicatesFound").textContent = found;
  document.getElementById("duplicatesRemoved").textContent = removed;
  document.getElementById("quarantineCount").textContent = quarantine;
  
  document.getElementById("duplicatesStats").style.display = "block";
}

/**
 * –°–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
 */
function hideAllResults() {
  const resultDivs = [
    "duplicatesAnalysisResults",
    "deduplicationResults", 
    "quarantineResults",
    "logResults"
  ];
  
  resultDivs.forEach(id => {
    const div = document.getElementById(id);
    if (div) div.style.display = "none";
  });
}

/**
 * üì¶ –ü—Ä–æ—Å–º–æ—Ç—Ä –∫–∞—Ä–∞–Ω—Ç–∏–Ω–∞
 */
async function viewQuarantine() {
  const loader = document.getElementById("duplicatesLoader");
  const resultsDiv = document.getElementById("quarantineResults");
  
  hideAllResults();
  loader.style.display = "block";
  
  try {
    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–µ—Ä—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∫–∞—Ä–∞–Ω—Ç–∏–Ω–∞
    // –ü–æ–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–ª—É—à–∫—É
    resultsDiv.innerHTML = `
      <h4>üì¶ –ö–∞—Ä–∞–Ω—Ç–∏–Ω –¥—É–±–ª–∏–∫–∞—Ç–æ–≤</h4>
      <div style="text-align: center; color: #6b7280; padding: 20px;">
        <p>–§—É–Ω–∫—Ü–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫–∞—Ä–∞–Ω—Ç–∏–Ω–∞ –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–∏—Ö –≤–µ—Ä—Å–∏—è—Ö.</p>
        <p>–ö–∞—Ä–∞–Ω—Ç–∏–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ª–∏—Å—Ç–µ "–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫_–ö–∞—Ä–∞–Ω—Ç–∏–Ω"</p>
      </div>
    `;
    
    resultsDiv.style.display = "block";
    
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä–∞–Ω—Ç–∏–Ω–∞:", error);
    resultsDiv.innerHTML = `
      <div style="color: #dc2626; text-align: center;">
        <h4>‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h4>
        <p>${error.message}</p>
      </div>
    `;
    resultsDiv.style.display = "block";
  } finally {
    loader.style.display = "none";
  }
}

/**
 * üìã –ü—Ä–æ—Å–º–æ—Ç—Ä –∂—É—Ä–Ω–∞–ª–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏
 */
async function viewDeduplicationLog() {
  const loader = document.getElementById("duplicatesLoader");
  const resultsDiv = document.getElementById("logResults");
  
  hideAllResults();
  loader.style.display = "block";
  
  try {
    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–µ—Ä—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∂—É—Ä–Ω–∞–ª–∞
    // –ü–æ–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–ª—É—à–∫—É
    resultsDiv.innerHTML = `
      <h4>üìã –ñ—É—Ä–Ω–∞–ª –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏</h4>
      <div style="text-align: center; color: #6b7280; padding: 20px;">
        <p>–§—É–Ω–∫—Ü–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∂—É—Ä–Ω–∞–ª–∞ –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–∏—Ö –≤–µ—Ä—Å–∏—è—Ö.</p>
        <p>–ñ—É—Ä–Ω–∞–ª –æ–ø–µ—Ä–∞—Ü–∏–π —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ª–∏—Å—Ç–µ "–ñ—É—Ä–Ω–∞–ª_–¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏"</p>
      </div>
    `;
    
    resultsDiv.style.display = "block";
    
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∂—É—Ä–Ω–∞–ª–∞:", error);
    resultsDiv.innerHTML = `
      <div style="color: #dc2626; text-align: center;">
        <h4>‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h4>
        <p>${error.message}</p>
      </div>
    `;
    resultsDiv.style.display = "block";
  } finally {
    loader.style.display = "none";
  }
}

// ===== –î–ò–ê–ì–ù–û–°–¢–ò–ß–ï–°–ö–ò–ï –§–£–ù–ö–¶–ò–ò =====

/**
 * üîß –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤–∫–ª–∞–¥–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
 * –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ –∫–æ–Ω—Å–æ–ª–∏: diagnoseDuplicatesTab()
 */
function diagnoseDuplicatesTab() {
  const tab = document.getElementById("tabDuplicates");
  
  console.log("üîß –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –í–ö–õ–ê–î–ö–ò –î–£–ë–õ–ò–ö–ê–¢–û–í:");
  console.log("üìä –†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", currentUserRole);
  console.log("üë§ –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:", currentUser);
  
  if (!tab) {
    console.log("‚ùå –≠–ª–µ–º–µ–Ω—Ç tabDuplicates –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ DOM!");
    return;
  }
  
  console.log("üéØ –°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ tabDuplicates:");
  console.log("  ‚Ä¢ style.display:", tab.style.display);
  console.log("  ‚Ä¢ style.visibility:", tab.style.visibility);
  console.log("  ‚Ä¢ disabled:", tab.disabled);
  console.log("  ‚Ä¢ CSS –∫–ª–∞—Å—Å—ã:", tab.className);
  console.log("  ‚Ä¢ offsetWidth:", tab.offsetWidth);
  console.log("  ‚Ä¢ offsetHeight:", tab.offsetHeight);
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º CSS –ø—Ä–∞–≤–∏–ª–∞
  const computedStyle = window.getComputedStyle(tab);
  console.log("  ‚Ä¢ computed display:", computedStyle.display);
  console.log("  ‚Ä¢ computed visibility:", computedStyle.visibility);
  
  // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
  if (currentUserRole === "admin") {
    console.log("üîß –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞...");
    tab.classList.remove("admin-hidden");
    tab.classList.add("admin-visible");
    tab.style.display = "";
    tab.style.visibility = "";
    tab.disabled = false;
    console.log("‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ!");
  }
}

/**
 * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞)
 */
async function updateBasicData() {
  if (typeof loadTodayRecords === 'function') {
    try {
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–µ–π –∑–∞ —Å–µ–≥–æ–¥–Ω—è
      await loadTodayRecords();
      
  
    } catch (error) {
      console.error("‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–∑–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö:", error);
    }
  }
}

/**
 * –°–£–ü–ï–†-–ë–´–°–¢–†–û–ï –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –æ–ø–µ—Ä–∞—Ü–∏–π —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è
 * –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Å–µ—Ç–µ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã, —Ç–æ–ª—å–∫–æ —Å–∞–º–æ–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ
 */
async function fastUpdateAfterChange() {
  try {
    // === 1. –ë–´–°–¢–†–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –ó–ê–ü–ò–°–ï–ô –ó–ê –°–ï–ì–û–î–ù–Ø (–Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–µ–µ) ===
    loadTodayRecords().catch(error => {
      console.warn("‚ö†Ô∏è –§–æ–Ω–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π –Ω–µ —É–¥–∞–ª–æ—Å—å:", error);
    });
    
    // === 2. –û–¢–õ–û–ñ–ï–ù–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–¢–ê–¢–ò–°–¢–ò–ö–ò (–µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞) ===
    const statsContainer = document.getElementById("statsContainer");
    
    if (statsContainer && statsContainer.style.display !== "none") {
      // –ñ–¥–µ–º, —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏—Å—å, –∑–∞—Ç–µ–º –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
      setTimeout(() => {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤—Å—ë –µ—â—ë –æ—Ç–∫—Ä—ã—Ç–∞ –∏ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è
        if (statsContainer.style.display !== "none" && !isStatsLoading) {
      
          loadStats().catch(error => {
            console.warn("‚ö†Ô∏è –û—Ç–ª–æ–∂–µ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å:", error);
          });
        } else {
      
        }
      }, 800); // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
    }
    

    
  } catch (error) {
    console.error("‚ùå –û—à–∏–±–∫–∞ –±—ã—Å—Ç—Ä–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:", error);
    // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é - —Ä–∞–±–æ—Ç–∞–µ–º –≤ —Ñ–æ–Ω–µ
  }
}

/**
 * –ü–æ–∫–∞–∑ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
 */
function showTemporaryNotification(message, type = "info", duration = 3000) {
  // –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –Ω–∞—Ö–æ–¥–∏–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
  let container = document.getElementById("notificationContainer");
  if (!container) {
    container = document.createElement("div");
    container.id = "notificationContainer";
    container.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      max-width: 400px;
    `;
    document.body.appendChild(container);
  }
  
  // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
  const notification = document.createElement("div");
  notification.className = `notification notification-${type}`;
  notification.style.cssText = `
    padding: 12px 16px;
    margin-bottom: 8px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    font-size: 14px;
    animation: slideInRight 0.3s ease-out;
    cursor: pointer;
  `;
  
  // –°—Ç–∏–ª–∏ –ø–æ —Ç–∏–ø—É
  switch (type) {
    case "success":
      notification.style.background = "#d1fae5";
      notification.style.color = "#065f46";
      notification.style.border = "1px solid #a7f3d0";
      break;
    case "warning":
      notification.style.background = "#fef3c7";
      notification.style.color = "#92400e";
      notification.style.border = "1px solid #fcd34d";
      break;
    case "error":
      notification.style.background = "#fef2f2";
      notification.style.color = "#991b1b";
      notification.style.border = "1px solid #fca5a5";
      break;
    default:
      notification.style.background = "#eff6ff";
      notification.style.color = "#1e40af";
      notification.style.border = "1px solid #93c5fd";
  }
  
  notification.textContent = message;
  
  // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è
  notification.addEventListener("click", () => {
    notification.remove();
  });
  
  container.appendChild(notification);
  
  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ
  setTimeout(() => {
    if (notification.parentNode) {
      notification.style.animation = "slideOutRight 0.3s ease-in";
      setTimeout(() => notification.remove(), 300);
    }
  }, duration);
}

// === –ê–ù–ê–õ–ò–ó –°–ï–ë–ï–°–¢–û–ò–ú–û–°–¢–ò ===

function initializeCostAnalysis() {
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  const today = new Date();
  const weekAgo = new Date(today);
  weekAgo.setDate(today.getDate() - 7);
  
  document.getElementById("costStartDate").value = weekAgo.toISOString().split('T')[0];
  document.getElementById("costEndDate").value = today.toISOString().split('T')[0];
}



async function calculateCostAnalysis() {
  const startDate = document.getElementById("costStartDate").value;
  const endDate = document.getElementById("costEndDate").value;
  const resultDiv = document.getElementById("costResults");
  
  if (!startDate || !endDate) {
    resultDiv.innerHTML = '<p style="color: red;">‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</p>';
    return;
  }
  
  resultDiv.innerHTML = '<p>üîÑ –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å...</p>';
  
  try {
    const response = await fetch(`${scriptURL}?type=costAnalysis&start=${startDate}&end=${endDate}`);
    const data = await response.json();
    
    if (data.status === "success") {
      displayCostResults(data);
    } else {
      resultDiv.innerHTML = `<p style="color: red;">‚ùå –û—à–∏–±–∫–∞: ${data.message}</p>`;
    }
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ —Ä–∞—Å—á—ë—Ç–∞ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏:", error);
    resultDiv.innerHTML = '<p style="color: red;">‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á—ë—Ç–µ</p>';
  }
}

function displayCostResults(data) {
  const resultDiv = document.getElementById("costResults");
  
  let html = `
    <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 20px; border-radius: 16px; color: white; margin-bottom: 24px; box-shadow: 0 8px 32px rgba(0,0,0,0.1);">
      <h3 style="margin: 0 0 16px 0; font-size: 24px; font-weight: 700;">üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –§–û–¢</h3>
      <p style="margin: 0; font-size: 16px; opacity: 0.9;">–ü–µ—Ä–∏–æ–¥: ${data.period}</p>
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 24px;">
      <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 12px; color: white; text-align: center; box-shadow: 0 4px 20px rgba(240,147,251,0.3);">
        <div style="font-size: 28px; font-weight: 700; margin-bottom: 8px;">${data.totalAllQuantity.toLocaleString()}</div>
        <div style="font-size: 14px; opacity: 0.9;">üì¶ –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (—à—Ç)</div>
      </div>
      
      <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 20px; border-radius: 12px; color: white; text-align: center; box-shadow: 0 4px 20px rgba(250,112,154,0.3);">
        <div style="font-size: 28px; font-weight: 700; margin-bottom: 8px;">${data.totalAllCosts.toLocaleString()} ‚ÇΩ</div>
        <div style="font-size: 14px; opacity: 0.9;">üí∞ –û–±—â–∏–µ —Ä–∞—Å—Ö–æ–¥—ã –§–û–¢</div>
      </div>
    </div>
  `;
  
  if (Object.keys(data.volumes).length === 0) {
    html += '<div style="background: #fee2e2; color: #dc2626; padding: 16px; border-radius: 8px; text-align: center;">‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</div>';
  } else {
    html += `
      <div style="background: white; border-radius: 16px; box-shadow: 0 4px 24px rgba(0,0,0,0.1); overflow: hidden;">
        <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 16px;">
          <h4 style="margin: 0; font-size: 18px; font-weight: 600;">üìà –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –§–û–¢ –ø–æ –æ–±—ä–µ–º–∞–º</h4>
        </div>
        <div class="table-scroll">
          <table style="width:100%; border-collapse:collapse;">
            <thead>
              <tr style="background: #f8fafc;">
                <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">–û–±—ä—ë–º</th>
                <th style="padding: 12px 16px; text-align: right; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">–ö–æ–ª-–≤–æ</th>
                <th style="padding: 12px 16px; text-align: right; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">–§–û–¢ –°–µ–±–µ—Å—Ç. ‚ÇΩ/—à—Ç</th>
                <th style="padding: 12px 16px; text-align: right; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">–û–±—â–∏–µ –∑–∞—Ç—Ä–∞—Ç—ã</th>
              </tr>
            </thead>
            <tbody>
    `;
    
    Object.keys(data.volumes).sort().forEach((volume, index) => {
      const vol = data.volumes[volume];
      const rowBg = index % 2 === 0 ? '#ffffff' : '#f8fafc';
      html += `
        <tr style="background: ${rowBg}; transition: background-color 0.2s;" onmouseover="this.style.background='#e2e8f0'" onmouseout="this.style.background='${rowBg}'">
          <td style="padding: 12px 16px; font-weight: 600; color: #1e293b;">${volume}</td>
          <td style="padding: 12px 16px; text-align: right; color: #475569;">${vol.quantity.toLocaleString()}</td>
          <td style="padding: 12px 16px; text-align: right; font-weight: 700; color: #2563eb; font-size: 16px;">${vol.unitCost}</td>
          <td style="padding: 12px 16px; text-align: right; color: #475569;">${vol.totalCost.toLocaleString()} ‚ÇΩ</td>
        </tr>
      `;
    });
    
    html += `
            </tbody>
          </table>
        </div>
      </div>
    `;
  }
  
  resultDiv.innerHTML = html;
}

async function calculateCostAnalysisWithMaterials() {
  const startDate = document.getElementById("costStartDate").value;
  const endDate = document.getElementById("costEndDate").value;
  const resultDiv = document.getElementById("costResults");
  
  if (!startDate || !endDate) {
    resultDiv.innerHTML = '<p style="color: red;">‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</p>';
    return;
  }
  
  resultDiv.innerHTML = '<p>üîÑ –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –§–û–¢ + –ú–∞—Ç–µ—Ä–∏–∞–ª—ã...</p>';
  
  try {
    const response = await fetch(`${scriptURL}?type=costAnalysisWithMaterials&start=${startDate}&end=${endDate}`);
    const data = await response.json();
    
    if (data.status === "success") {
      displayCostResultsWithMaterials(data);
    } else {
      resultDiv.innerHTML = `<p style="color: red;">‚ùå –û—à–∏–±–∫–∞: ${data.message}</p>`;
    }
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ —Ä–∞—Å—á—ë—Ç–∞ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Å –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º–∏:", error);
    resultDiv.innerHTML = '<p style="color: red;">‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á—ë—Ç–µ</p>';
  }
}

async function calculateCostAnalysisForSetsFotOnly() {
  const startDate = document.getElementById("costStartDate").value;
  const endDate = document.getElementById("costEndDate").value;
  const resultDiv = document.getElementById("costResults");
  
  if (!startDate || !endDate) {
    resultDiv.innerHTML = '<p style="color: red;">‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</p>';
    return;
  }
  
  resultDiv.innerHTML = '<p>üîÑ –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –Ω–∞–±–æ—Ä–æ–≤ (—Ç–æ–ª—å–∫–æ –§–û–¢)...</p>';
  
  try {
    const response = await fetch(`${scriptURL}?type=costAnalysisForSetsFotOnly&start=${startDate}&end=${endDate}`);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();
    
    if (data.status === "success") {
      displayCostResultsForSetsFotOnly(data);
    } else if (data.status === "fail" && data.message) {
      resultDiv.innerHTML = `
        <div style="background: #fee2e2; color: #dc2626; padding: 16px; border-radius: 8px; margin: 10px 0;">
          <h4 style="margin-top: 0;">‚ùå –û—à–∏–±–∫–∞ —Ä–∞—Å—á—ë—Ç–∞ –§–û–¢ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ –Ω–∞–±–æ—Ä–æ–≤</h4>
          <p style="margin-bottom: 0;"><strong>–î–µ—Ç–∞–ª–∏:</strong> ${data.message}</p>
          <details style="margin-top: 10px;">
            <summary style="cursor: pointer;">üîç –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—é</summary>
            <ul style="margin-top: 10px;">
              <li>–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ª–∏—Å—Ç—ã –¥–∞–Ω–Ω—ã—Ö —Å—É—â–µ—Å—Ç–≤—É—é—Ç</li>
              <li>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ Google Sheets</li>
              <li>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π –ø–µ—Ä–∏–æ–¥</li>
              <li>–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ –æ–ø–µ—Ä–∞—Ü–∏—è–º —Å–±–æ—Ä–∫–∏ –Ω–∞–±–æ—Ä–æ–≤</li>
            </ul>
          </details>
        </div>
      `;
    } else {
      resultDiv.innerHTML = `<p style="color: red;">‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞: ${JSON.stringify(data)}</p>`;
    }
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ —Ä–∞—Å—á—ë—Ç–∞ –§–û–¢ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ –Ω–∞–±–æ—Ä–æ–≤:", error);
    resultDiv.innerHTML = `
      <div style="background: #fee2e2; color: #dc2626; padding: 16px; border-radius: 8px; margin: 10px 0;">
        <h4 style="margin-top: 0;">‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</h4>
        <p><strong>–ü—Ä–∏—á–∏–Ω–∞:</strong> ${error.message}</p>
        <p style="margin-bottom: 0;"><strong>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</strong></p>
        <ul>
          <li>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</li>
          <li>–û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞</li>
          <li>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å URL —Å–∫—Ä–∏–ø—Ç–∞</li>
        </ul>
      </div>
    `;
  }
}

async function calculateCostAnalysisForSets() {
  const startDate = document.getElementById("costStartDate").value;
  const endDate = document.getElementById("costEndDate").value;
  const resultDiv = document.getElementById("costResults");
  
  if (!startDate || !endDate) {
    resultDiv.innerHTML = '<p style="color: red;">‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</p>';
    return;
  }
  
  resultDiv.innerHTML = '<p>üîÑ –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –Ω–∞–±–æ—Ä–æ–≤ (–§–û–¢ + –ú–∞—Ç–µ—Ä–∏–∞–ª—ã)...</p>';
  
  try {
    const response = await fetch(`${scriptURL}?type=costAnalysisForSets&start=${startDate}&end=${endDate}`);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();
    
    if (data.status === "success") {
      displayCostResultsForSets(data);
    } else if (data.status === "fail" && data.message) {
      resultDiv.innerHTML = `
        <div style="background: #fee2e2; color: #dc2626; padding: 16px; border-radius: 8px; margin: 10px 0;">
          <h4 style="margin-top: 0;">‚ùå –û—à–∏–±–∫–∞ —Ä–∞—Å—á—ë—Ç–∞ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ –Ω–∞–±–æ—Ä–æ–≤</h4>
          <p style="margin-bottom: 0;"><strong>–î–µ—Ç–∞–ª–∏:</strong> ${data.message}</p>
          <details style="margin-top: 10px;">
            <summary style="cursor: pointer;">üîç –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—é</summary>
            <ul style="margin-top: 10px;">
              <li>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ "–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫_—Ä–∞—Å—á–µ—Ç–æ–≤_—Å—Ç–æ–∏–º–æ—Å—Ç–∏_—É–ø–∞–∫–æ–≤–∫–∏_–Ω–∞–±–æ—Ä–æ–≤"</li>
              <li>–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ª–∏—Å—Ç—ã –¥–∞–Ω–Ω—ã—Ö —Å—É—â–µ—Å—Ç–≤—É—é—Ç</li>
              <li>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ Google Sheets</li>
              <li>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π –ø–µ—Ä–∏–æ–¥</li>
            </ul>
          </details>
        </div>
      `;
    } else {
      resultDiv.innerHTML = `<p style="color: red;">‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞: ${JSON.stringify(data)}</p>`;
    }
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ —Ä–∞—Å—á—ë—Ç–∞ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ –Ω–∞–±–æ—Ä–æ–≤:", error);
    resultDiv.innerHTML = `
      <div style="background: #fee2e2; color: #dc2626; padding: 16px; border-radius: 8px; margin: 10px 0;">
        <h4 style="margin-top: 0;">‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</h4>
        <p><strong>–ü—Ä–∏—á–∏–Ω–∞:</strong> ${error.message}</p>
        <p style="margin-bottom: 0;"><strong>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</strong></p>
        <ul>
          <li>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</li>
          <li>–û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞</li>
          <li>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å URL —Å–∫—Ä–∏–ø—Ç–∞</li>
        </ul>
      </div>
    `;
  }
}

function displayCostResultsWithMaterials(data) {
  const resultDiv = document.getElementById("costResults");
  
  let html = `
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 16px; color: white; margin-bottom: 24px; box-shadow: 0 8px 32px rgba(0,0,0,0.1);">
      <h3 style="margin: 0 0 16px 0; font-size: 24px; font-weight: 700;">üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –§–û–¢ + –ú–∞—Ç–µ—Ä–∏–∞–ª—ã</h3>
      <p style="margin: 0; font-size: 16px; opacity: 0.9;">–ü–µ—Ä–∏–æ–¥: ${data.period}</p>
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
      <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 12px; color: white; text-align: center; box-shadow: 0 4px 20px rgba(240,147,251,0.3);">
        <div style="font-size: 28px; font-weight: 700; margin-bottom: 8px;">${data.totalAllQuantity.toLocaleString()}</div>
        <div style="font-size: 14px; opacity: 0.9;">üì¶ –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (—à—Ç)</div>
      </div>
      
      <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 20px; border-radius: 12px; color: white; text-align: center; box-shadow: 0 4px 20px rgba(79,172,254,0.3);">
        <div style="font-size: 28px; font-weight: 700; margin-bottom: 8px;">${data.totalAllFotCosts.toLocaleString()} ‚ÇΩ</div>
        <div style="font-size: 14px; opacity: 0.9;">üí∞ –†–∞—Å—Ö–æ–¥—ã –§–û–¢</div>
      </div>
      
      <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); padding: 20px; border-radius: 12px; color: white; text-align: center; box-shadow: 0 4px 20px rgba(67,233,123,0.3);">
        <div style="font-size: 28px; font-weight: 700; margin-bottom: 8px;">${data.totalAllMaterialsCosts.toLocaleString()} ‚ÇΩ</div>
        <div style="font-size: 14px; opacity: 0.9;">üß™ –†–∞—Å—Ö–æ–¥—ã –ú–∞—Ç–µ—Ä–∏–∞–ª—ã</div>
      </div>
      
      <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 20px; border-radius: 12px; color: white; text-align: center; box-shadow: 0 4px 20px rgba(250,112,154,0.3);">
        <div style="font-size: 28px; font-weight: 700; margin-bottom: 8px;">${data.totalAllCosts.toLocaleString()} ‚ÇΩ</div>
        <div style="font-size: 14px; opacity: 0.9;">üí∞ –ò–¢–û–ì–û —Ä–∞—Å—Ö–æ–¥—ã</div>
      </div>
    </div>
  `;
  
  if (Object.keys(data.volumes).length === 0) {
    html += '<div style="background: #fee2e2; color: #dc2626; padding: 16px; border-radius: 8px; text-align: center;">‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</div>';
  } else {
    html += `
      <div style="background: white; border-radius: 16px; box-shadow: 0 4px 24px rgba(0,0,0,0.1); overflow: hidden; margin-bottom: 24px;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 16px;">
          <h4 style="margin: 0; font-size: 18px; font-weight: 600;">üìà –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ –æ–±—ä–µ–º–∞–º</h4>
        </div>
        <div class="table-scroll">
          <table style="width:100%; border-collapse:collapse;">
            <thead>
              <tr style="background: #f8fafc;">
                <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">–û–±—ä—ë–º</th>
                <th style="padding: 12px 16px; text-align: right; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">–ö–æ–ª-–≤–æ</th>
                <th style="padding: 12px 16px; text-align: right; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">–§–û–¢ ‚ÇΩ/—à—Ç</th>
                <th style="padding: 12px 16px; text-align: right; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">–ú–∞—Ç–µ—Ä–∏–∞–ª—ã ‚ÇΩ/—à—Ç</th>
                <th style="padding: 12px 16px; text-align: right; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">–ò–¢–û–ì–û ‚ÇΩ/—à—Ç</th>
                <th style="padding: 12px 16px; text-align: right; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">–û–±—â–∏–µ –∑–∞—Ç—Ä–∞—Ç—ã</th>
              </tr>
            </thead>
            <tbody>
    `;
    
    Object.keys(data.volumes).sort().forEach((volume, index) => {
      const vol = data.volumes[volume];
      const rowBg = index % 2 === 0 ? '#ffffff' : '#f8fafc';
      html += `
        <tr style="background: ${rowBg}; transition: background-color 0.2s;" onmouseover="this.style.background='#e2e8f0'" onmouseout="this.style.background='${rowBg}'">
          <td style="padding: 12px 16px; font-weight: 600; color: #1e293b;">${volume}</td>
          <td style="padding: 12px 16px; text-align: right; color: #475569;">${vol.quantity.toLocaleString()}</td>
          <td style="padding: 12px 16px; text-align: right; color: #2563eb; font-weight: 500;">${vol.fotUnitCost}</td>
          <td style="padding: 12px 16px; text-align: right; color: #059669; font-weight: 500;">${vol.materialsUnitCost}</td>
          <td style="padding: 12px 16px; text-align: right; font-weight: 700; color: #dc2626; font-size: 16px;">${vol.unitCost}</td>
          <td style="padding: 12px 16px; text-align: right; color: #475569;">${vol.totalCost.toLocaleString()} ‚ÇΩ</td>
        </tr>
      `;
    });
    
    html += `
            </tbody>
          </table>
        </div>
      </div>
      
      <div style="background: white; border-radius: 16px; box-shadow: 0 4px 24px rgba(0,0,0,0.1); overflow: hidden;">
        <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 16px;">
          <h4 style="margin: 0; font-size: 18px; font-weight: 600;">üß™ –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –ø–æ –æ–±—ä–µ–º–∞–º</h4>
        </div>
        <div class="table-scroll">
          <table style="width:100%; border-collapse:collapse;">
            <thead>
              <tr style="background: #f8fafc;">
                <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">–û–±—ä—ë–º</th>
                <th style="padding: 12px 16px; text-align: right; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">–ü–û–§ ‚ÇΩ/—à—Ç</th>
                <th style="padding: 12px 16px; text-align: right; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">–í–ü–ü ‚ÇΩ/—à—Ç</th>
                <th style="padding: 12px 16px; text-align: right; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">–°–∫–æ—Ç—á ‚ÇΩ/—à—Ç</th>
                <th style="padding: 12px 16px; text-align: right; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">–°—Ç–∏–∫–µ—Ä ‚ÇΩ/—à—Ç</th>
                <th style="padding: 12px 16px; text-align: right; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">–ò—Ç–æ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª—ã ‚ÇΩ/—à—Ç</th>
              </tr>
            </thead>
            <tbody>
    `;
    
    Object.keys(data.volumes).sort().forEach((volume, index) => {
      const vol = data.volumes[volume];
      const materials = vol.materialBreakdown;
      const rowBg = index % 2 === 0 ? '#ffffff' : '#f8fafc';
      html += `
        <tr style="background: ${rowBg}; transition: background-color 0.2s;" onmouseover="this.style.background='#e2e8f0'" onmouseout="this.style.background='${rowBg}'">
          <td style="padding: 12px 16px; font-weight: 600; color: #1e293b;">${volume}</td>
          <td style="padding: 12px 16px; text-align: right; color: #7c3aed; font-weight: 500;">${materials.pofUnitCost}</td>
          <td style="padding: 12px 16px; text-align: right; color: #2563eb; font-weight: 500;">${materials.vppUnitCost}</td>
          <td style="padding: 12px 16px; text-align: right; color: #059669; font-weight: 500;">${materials.scotchUnitCost}</td>
          <td style="padding: 12px 16px; text-align: right; color: #dc2626; font-weight: 500;">${materials.stickerUnitCost}</td>
          <td style="padding: 12px 16px; text-align: right; font-weight: 700; color: #1e293b; font-size: 16px; background: linear-gradient(135deg, #fef3c7, #fbbf24); border-radius: 6px;">${vol.materialsUnitCost}</td>
        </tr>
      `;
    });
    
    html += `
            </tbody>
          </table>
        </div>
      </div>
    `;
  }
  
  resultDiv.innerHTML = html;
}

function displayCostResultsForSetsFotOnly(data) {
  const resultDiv = document.getElementById("costResults");
  
  let html = `
    <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 20px; border-radius: 16px; color: white; margin-bottom: 24px; box-shadow: 0 8px 32px rgba(0,0,0,0.1);">
      <h3 style="margin: 0 0 16px 0; font-size: 24px; font-weight: 700;">üì¶ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –§–û–¢ –Ω–∞–±–æ—Ä–æ–≤</h3>
      <p style="margin: 0; font-size: 16px; opacity: 0.9;">–ü–µ—Ä–∏–æ–¥: ${data.period}</p>
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 24px;">
      <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 12px; color: white; text-align: center; box-shadow: 0 4px 20px rgba(240,147,251,0.3);">
        <div style="font-size: 28px; font-weight: 700; margin-bottom: 8px;">${data.totalSetsQuantity.toLocaleString()}</div>
        <div style="font-size: 14px; opacity: 0.9;">üì¶ –°–æ–±—Ä–∞–Ω–æ –Ω–∞–±–æ—Ä–æ–≤ (—à—Ç)</div>
      </div>
      
      <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 20px; border-radius: 12px; color: white; text-align: center; box-shadow: 0 4px 20px rgba(250,112,154,0.3);">
        <div style="font-size: 28px; font-weight: 700; margin-bottom: 8px;">${data.totalFotCosts.toLocaleString()} ‚ÇΩ</div>
        <div style="font-size: 14px; opacity: 0.9;">üí∞ –û–±—â–∏–µ –§–û–¢ –∑–∞—Ç—Ä–∞—Ç—ã</div>
      </div>
    </div>
  `;
  
  if (Object.keys(data.sets).length === 0) {
    html += '<div style="background: #fee2e2; color: #dc2626; padding: 16px; border-radius: 8px; text-align: center;">‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –Ω–∞–±–æ—Ä–∞—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</div>';
  } else {
    html += `
      <div style="background: white; border-radius: 16px; box-shadow: 0 4px 24px rgba(0,0,0,0.1); overflow: hidden;">
        <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 16px;">
          <h4 style="margin: 0; font-size: 18px; font-weight: 600;">üìà –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –§–û–¢ –ø–æ –Ω–∞–±–æ—Ä–∞–º</h4>
        </div>
        <div class="table-scroll">
          <table style="width:100%; border-collapse:collapse;">
            <thead>
              <tr style="background: #f8fafc;">
                <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">–ê—Ä—Ç–∏–∫—É–ª –Ω–∞–±–æ—Ä–∞</th>
                <th style="padding: 12px 16px; text-align: right; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">–ö–æ–ª-–≤–æ</th>
                <th style="padding: 12px 16px; text-align: right; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">–§–û–¢ –°–µ–±–µ—Å—Ç. ‚ÇΩ/—à—Ç</th>
                <th style="padding: 12px 16px; text-align: right; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">–û–±—â–∏–µ –∑–∞—Ç—Ä–∞—Ç—ã</th>
              </tr>
            </thead>
            <tbody>
    `;
    
    Object.keys(data.sets).sort().forEach((setCode, index) => {
      const set = data.sets[setCode];
      const rowBg = index % 2 === 0 ? '#ffffff' : '#f8fafc';
      html += `
        <tr style="background: ${rowBg}; transition: background-color 0.2s;" onmouseover="this.style.background='#e2e8f0'" onmouseout="this.style.background='${rowBg}'">
          <td style="padding: 12px 16px; font-weight: 600; color: #1e293b;">${setCode}</td>
          <td style="padding: 12px 16px; text-align: right; color: #475569;">${set.quantity.toLocaleString()}</td>
          <td style="padding: 12px 16px; text-align: right; font-weight: 700; color: #2563eb; font-size: 16px;">${set.unitCost}</td>
          <td style="padding: 12px 16px; text-align: right; color: #475569;">${set.totalCost.toLocaleString()} ‚ÇΩ</td>
        </tr>
      `;
    });
    
    html += `
            </tbody>
          </table>
        </div>
      </div>
    `;
  }
  
  resultDiv.innerHTML = html;
}

function displayCostResultsForSets(data) {
  const resultDiv = document.getElementById("costResults");
  
  let html = `
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 16px; color: white; margin-bottom: 24px; box-shadow: 0 8px 32px rgba(0,0,0,0.1);">
      <h3 style="margin: 0 0 16px 0; font-size: 24px; font-weight: 700;">üì¶ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ –Ω–∞–±–æ—Ä–æ–≤</h3>
      <p style="margin: 0; font-size: 16px; opacity: 0.9;">–ü–µ—Ä–∏–æ–¥: ${data.period}</p>
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
      <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 12px; color: white; text-align: center; box-shadow: 0 4px 20px rgba(240,147,251,0.3);">
        <div style="font-size: 28px; font-weight: 700; margin-bottom: 8px;">${data.totalSetsQuantity.toLocaleString()}</div>
        <div style="font-size: 14px; opacity: 0.9;">üì¶ –°–æ–±—Ä–∞–Ω–æ –Ω–∞–±–æ—Ä–æ–≤ (—à—Ç)</div>
      </div>
      
      <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 20px; border-radius: 12px; color: white; text-align: center; box-shadow: 0 4px 20px rgba(79,172,254,0.3);">
        <div style="font-size: 28px; font-weight: 700; margin-bottom: 8px;">${data.totalFotCosts.toLocaleString()} ‚ÇΩ</div>
        <div style="font-size: 14px; opacity: 0.9;">üí∞ –†–∞—Å—Ö–æ–¥—ã –§–û–¢</div>
      </div>
      
      <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); padding: 20px; border-radius: 12px; color: white; text-align: center; box-shadow: 0 4px 20px rgba(67,233,123,0.3);">
        <div style="font-size: 28px; font-weight: 700; margin-bottom: 8px;">${data.totalMaterialsCosts.toLocaleString()} ‚ÇΩ</div>
        <div style="font-size: 14px; opacity: 0.9;">üß™ –†–∞—Å—Ö–æ–¥—ã –ú–∞—Ç–µ—Ä–∏–∞–ª—ã</div>
      </div>
      
      <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 20px; border-radius: 12px; color: white; text-align: center; box-shadow: 0 4px 20px rgba(250,112,154,0.3);">
        <div style="font-size: 28px; font-weight: 700; margin-bottom: 8px;">${data.totalCosts.toLocaleString()} ‚ÇΩ</div>
        <div style="font-size: 14px; opacity: 0.9;">üí∞ –ò–¢–û–ì–û —Ä–∞—Å—Ö–æ–¥—ã</div>
      </div>
    </div>
  `;
  
  if (Object.keys(data.sets).length === 0) {
    html += '<div style="background: #fee2e2; color: #dc2626; padding: 16px; border-radius: 8px; text-align: center;">‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –Ω–∞–±–æ—Ä–∞—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</div>';
  } else {
    html += `
      <div style="background: white; border-radius: 16px; box-shadow: 0 4px 24px rgba(0,0,0,0.1); overflow: hidden; margin-bottom: 24px;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 16px;">
          <h4 style="margin: 0; font-size: 18px; font-weight: 600;">üì¶ –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –Ω–∞–±–æ—Ä–æ–≤</h4>
        </div>
        <div class="table-scroll">
          <table style="width:100%; border-collapse:collapse;">
            <thead>
              <tr style="background: #f8fafc;">
                <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">–ê—Ä—Ç–∏–∫—É–ª –Ω–∞–±–æ—Ä–∞</th>
                <th style="padding: 12px 16px; text-align: right; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">–ö–æ–ª-–≤–æ</th>
                <th style="padding: 12px 16px; text-align: right; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">–§–û–¢ ‚ÇΩ/—à—Ç</th>
                <th style="padding: 12px 16px; text-align: right; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">–ú–∞—Ç–µ—Ä–∏–∞–ª—ã ‚ÇΩ/—à—Ç</th>
                <th style="padding: 12px 16px; text-align: right; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">–ò–¢–û–ì–û ‚ÇΩ/—à—Ç</th>
                <th style="padding: 12px 16px; text-align: right; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">–û–±—â–∏–µ –∑–∞—Ç—Ä–∞—Ç—ã</th>
              </tr>
            </thead>
            <tbody>
    `;
    
    Object.keys(data.sets).sort().forEach((setCode, index) => {
      const set = data.sets[setCode];
      const rowBg = index % 2 === 0 ? '#ffffff' : '#f8fafc';
      html += `
        <tr style="background: ${rowBg}; transition: background-color 0.2s;" onmouseover="this.style.background='#e2e8f0'" onmouseout="this.style.background='${rowBg}'">
          <td style="padding: 12px 16px; font-weight: 600; color: #1e293b;">${setCode}</td>
          <td style="padding: 12px 16px; text-align: right; color: #475569;">${set.quantity.toLocaleString()}</td>
          <td style="padding: 12px 16px; text-align: right; color: #2563eb; font-weight: 500;">${set.fotUnitCost}</td>
          <td style="padding: 12px 16px; text-align: right; color: #059669; font-weight: 500;">${set.materialUnitCost}</td>
          <td style="padding: 12px 16px; text-align: right; font-weight: 700; color: #dc2626; font-size: 16px;">${set.totalUnitCost}</td>
          <td style="padding: 12px 16px; text-align: right; color: #475569;">${set.totalCost.toLocaleString()} ‚ÇΩ</td>
        </tr>
      `;
    });
    
    html += `
            </tbody>
          </table>
        </div>
      </div>
    `;
  }
  
  resultDiv.innerHTML = html;
}

// === –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –í–´–ì–†–£–ó–ö–ò –û–¢–ß–ï–¢–ê –ù–ê –°–ï–†–í–ï–† ===

async function saveReportToServer() {
  const startDate = document.getElementById("costStartDate").value;
  const endDate = document.getElementById("costEndDate").value;
  
  if (!startDate || !endDate) {
    alert('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç—á–µ—Ç–∞');
    return;
  }

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –≤ –∫–Ω–æ–ø–∫–µ
  const button = document.querySelector('button[onclick="saveReportToServer()"]');
  if (button) {
    button.disabled = true;
    button.innerHTML = 'üîÑ –°–æ—Ö—Ä–∞–Ω—è–µ–º...';
  }

  try {
    const response = await fetch(`${scriptURL}?type=saveReport&reportType=fot&start=${startDate}&end=${endDate}`);
    const data = await response.json();
    
    if (data.status === "success") {
      alert(`‚úÖ ${data.message}`);
    } else {
      alert(`‚ùå –û—à–∏–±–∫–∞: ${data.message}`);
    }
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç—á–µ—Ç–∞:", error);
    alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –æ—Ç—á–µ—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä');
  } finally {
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
    if (button) {
      button.disabled = false;
      button.innerHTML = 'üíæ –í—ã–≥—Ä—É–∑–∏—Ç—å –æ—Ç—á–µ—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä';
    }
  }
}





// ============================
// üîç –§–£–ù–ö–¶–ò–ò –ê–ù–ê–õ–ò–ó–ê –ù–û–†–ú–ê–¢–ò–í–û–í
// ============================

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let currentNormativesData = [];
let currentEditingNorm = null;

// –ü–æ–∫–∞–∑–∞—Ç—å –±–ª–æ–∫ –∞–Ω–∞–ª–∏–∑–∞ –Ω–æ—Ä–º–∞—Ç–∏–≤–æ–≤ —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π
function loadNormativesAnalysis() {
  // –í—Å–µ–≥–¥–∞ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–∞—Ä–æ–ª—å (–±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è)
  promptNormativesAuth();
}

// –ó–∞–ø—Ä–æ—Å –ø–∞—Ä–æ–ª—è –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–Ω–∞–ª–∏–∑—É –Ω–æ—Ä–º–∞—Ç–∏–≤–æ–≤
function promptNormativesAuth() {
  const password = prompt('üîê –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–Ω–∞–ª–∏–∑—É –Ω–æ—Ä–º–∞—Ç–∏–≤–æ–≤:');
  if (password === 'Forsal2025') {
    showNormativesAnalysis();
  } else if (password !== null) {
    alert('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
  }
}

// –ü–æ–∫–∞–∑–∞—Ç—å –±–ª–æ–∫ –∞–Ω–∞–ª–∏–∑–∞ –Ω–æ—Ä–º–∞—Ç–∏–≤–æ–≤ (–ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)
function showNormativesAnalysis() {
  const container = document.getElementById("normativesAnalysisContainer");
  
  // –°–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ –æ—Ç—á–µ—Ç—ã
  document.getElementById("reportContainer").innerHTML = "";
  document.getElementById("shiftStatsOutput").innerHTML = "";
  document.getElementById("packerAnalysis").innerHTML = "";
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
  container.style.display = "block";
  
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–∏–æ–¥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π)
  const endDate = new Date();
  const startDate = new Date();
  startDate.setDate(endDate.getDate() - 7);
  
  const startDateString = startDate.toISOString().split('T')[0];
  const endDateString = endDate.toISOString().split('T')[0];
  
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏
  document.getElementById("normativesStartDate").value = startDateString;
  document.getElementById("normativesEndDate").value = endDateString;
  
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–Ω–æ–π –≤–µ—Ä—Å–∏–∏
  document.getElementById("normativesStartDateDesktop").value = startDateString;
  document.getElementById("normativesEndDateDesktop").value = endDateString;
  
  // –°–±—Ä–æ—Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
  document.getElementById("normativesSummary").style.display = "none";
  document.getElementById("normativesResults").innerHTML = "";
}

// –°–∫—Ä—ã—Ç—å –±–ª–æ–∫ –∞–Ω–∞–ª–∏–∑–∞ –Ω–æ—Ä–º–∞—Ç–∏–≤–æ–≤
function hideNormativesAnalysis() {
  document.getElementById("normativesAnalysisContainer").style.display = "none";
}

// –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑ –Ω–æ—Ä–º–∞—Ç–∏–≤–æ–≤
async function runNormativesAnalysis() {
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫—É—é –≤–µ—Ä—Å–∏—é –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
  const isMobile = window.innerWidth <= 768;
  
  const startDate = isMobile ? 
    document.getElementById("normativesStartDate").value :
    document.getElementById("normativesStartDateDesktop").value;
  const endDate = isMobile ? 
    document.getElementById("normativesEndDate").value :
    document.getElementById("normativesEndDateDesktop").value;
  const filter = isMobile ? 
    document.getElementById("normativesFilter").value :
    document.getElementById("normativesFilterDesktop").value;
  const search = isMobile ? 
    document.getElementById("normativesSearch").value.toLowerCase() :
    document.getElementById("normativesSearchDesktop").value.toLowerCase();
  
  if (!startDate || !endDate) {
    alert("‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –∞–Ω–∞–ª–∏–∑–∞");
    return;
  }
  
  const btn = isMobile ? 
    document.getElementById("runNormativesBtn") :
    document.getElementById("runNormativesBtnDesktop");
  const loader = document.getElementById("normativesLoader");
  const resultsContainer = document.getElementById("normativesResults");
  const summaryContainer = document.getElementById("normativesSummary");
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
  btn.disabled = true;
  btn.textContent = isMobile ? "‚è≥ –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º..." : "‚è≥ –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º...";
  loader.style.display = "block";
  resultsContainer.innerHTML = "";
  summaryContainer.style.display = "none";
  
  try {
    const response = await fetch(`${scriptURL}?type=normativesAnalysis&startDate=${startDate}&endDate=${endDate}&filter=${filter}`);
    const data = await response.json();
    
    if (!data.ok) {
      throw new Error(data.message || "–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞");
    }
    
    currentNormativesData = data.results;
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–∏—Å–∫ –µ—Å–ª–∏ –µ—Å—Ç—å
    let filteredResults = currentNormativesData;
    if (search) {
      filteredResults = currentNormativesData.filter(item => 
        item.operation.toLowerCase().includes(search) || 
        item.key.toLowerCase().includes(search)
      );
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    showNormativesSummary(data.summary, filteredResults.length);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    displayNormativesResults(filteredResults);
    
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –Ω–æ—Ä–º–∞—Ç–∏–≤–æ–≤:", error);
    resultsContainer.innerHTML = `<div style="text-align:center; color:red; padding:20px;">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
  } finally {
    // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
    btn.disabled = false;
    btn.textContent = isMobile ? "üìä –ê–Ω–∞–ª–∏–∑" : "üìä –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑";
    loader.style.display = "none";
  }
}

// –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
function showNormativesSummary(summary, filteredCount) {
  const container = document.getElementById("normativesSummary");
  
  document.getElementById("totalNormatives").textContent = filteredCount || summary.totalOperations;
  document.getElementById("problematicNormatives").textContent = summary.problematicOperations;
  document.getElementById("overstatedNormatives").textContent = summary.overstatedCount;
  document.getElementById("understatedNormatives").textContent = summary.understatedCount;
  
  container.style.display = "block";
}

// –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞
function displayNormativesResults(results) {
  const container = document.getElementById("normativesResults");
  
  if (!results || results.length === 0) {
    container.innerHTML = `<div style="text-align:center; padding:40px; color:#6b7280;">
      <div style="font-size:48px; margin-bottom:16px;">üîç</div>
      <div>–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ –∑–∞–¥–∞–Ω–Ω—ã–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º</div>
    </div>`;
    return;
  }
  
  let html = `
    <div style="overflow-x: auto;">
      <table style="width:100%; border-collapse:collapse; font-size:14px;">
        <thead>
          <tr style="background:#f8fafc; border-bottom:2px solid #e5e7eb;">
            <th style="padding:12px 8px; text-align:left; font-weight:600;">–û–ø–µ—Ä–∞—Ü–∏—è</th>
            <th style="padding:12px 8px; text-align:left; font-weight:600;">–û–±—ä–µ–º/–ö–ª—é—á</th>
            <th style="padding:12px 8px; text-align:center; font-weight:600;">–¢–µ–∫—É—â–∞—è –Ω–æ—Ä–º–∞</th>
            <th style="padding:12px 8px; text-align:center; font-weight:600;">–°—Ä. —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th>
            <th style="padding:12px 8px; text-align:center; font-weight:600;">–°—Ä. —Å–∫–æ—Ä–æ—Å—Ç—å</th>
            <th style="padding:12px 8px; text-align:center; font-weight:600;">–°—Ç–∞—Ç—É—Å</th>
            <th style="padding:12px 8px; text-align:center; font-weight:600;">–û–ø–µ—Ä–∞—Ü–∏–π</th>
            <th style="padding:12px 8px; text-align:center; font-weight:600;">–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  results.forEach((item, index) => {
    const statusColor = item.status === "overstated" ? "#fee2e2" : 
                       item.status === "understated" ? "#dcfce7" : "#f9fafb";
    const textColor = item.status === "overstated" ? "#dc2626" : 
                     item.status === "understated" ? "#16a34a" : "#6b7280";
    
    html += `
      <tr style="border-bottom:1px solid #e5e7eb; background:${statusColor};">
        <td style="padding:12px 8px; font-weight:500;">${item.operation}</td>
        <td style="padding:12px 8px;">${item.key}</td>
        <td style="padding:12px 8px; text-align:center; font-weight:600;">${item.normPerHour} —à—Ç/—á</td>
        <td style="padding:12px 8px; text-align:center; color:${textColor}; font-weight:600;">${item.avgEfficiency}%</td>
        <td style="padding:12px 8px; text-align:center;">${item.avgSpeed} —à—Ç/—á</td>
        <td style="padding:12px 8px; text-align:center; font-weight:600; color:${textColor};">${item.statusText}</td>
        <td style="padding:12px 8px; text-align:center;">${item.totalOperations}</td>
        <td style="padding:12px 8px; text-align:center;">
          <button class="edit-norm-btn" data-index="${index}" data-rate-key="${item.rateKey}"
                  style="background:#f59e0b; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:12px;">
            ‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å
          </button>
        </td>
      </tr>
    `;
  });
  
  html += `
        </tbody>
      </table>
    </div>
    
    <div style="margin-top:16px; padding:12px; background:#f0f9ff; border-radius:8px; font-size:12px; color:#1e40af;">
      <strong>üí° –ü–æ—è—Å–Ω–µ–Ω–∏—è:</strong><br>
      üî¥ <strong>–ó–∞–≤—ã—à–µ–Ω–Ω–∞—è –Ω–æ—Ä–º–∞</strong> - —Å—Ä–µ–¥–Ω—è—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å < 80%<br>
      üü¢ <strong>–ó–∞–Ω–∏–∂–µ–Ω–Ω–∞—è –Ω–æ—Ä–º–∞</strong> - —Å—Ä–µ–¥–Ω—è—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å > 100%<br>
      ‚ö™ <strong>–ù–æ—Ä–º–∞ –≤ –ø–æ—Ä—è–¥–∫–µ</strong> - —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ 80-100%
    </div>
  `;
  
  // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –æ–±–µ–∏–º–∏ –≤–µ—Ä—Å–∏—è–º–∏
  const fullHtml = `
    <!-- –î–µ—Å–∫—Ç–æ–ø–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ -->
    <div class="normatives-desktop-table">
      ${html}
    </div>
    
    <!-- –ú–æ–±–∏–ª—å–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ -->
    <div class="normatives-mobile-cards" style="display: none;">
      ${createMobileCards(results)}
    </div>
  `;
  
  container.innerHTML = fullHtml;
  
  // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–¥–µ—Å–∫—Ç–æ–ø)
  const desktopTable = container.querySelector('.normatives-desktop-table');
  if (desktopTable) {
    desktopTable.addEventListener('click', function(e) {
      if (e.target.classList.contains('edit-norm-btn')) {
        const index = parseInt(e.target.dataset.index);
        const rateKey = e.target.dataset.rateKey;
  
        openEditNormModal(rateKey, index);
      }
    });
  }
  
  // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–º–æ–±–∏–ª—å–Ω—ã–µ)
  const mobileCards = container.querySelector('.normatives-mobile-cards');
  if (mobileCards) {
    mobileCards.addEventListener('click', function(e) {
      if (e.target.classList.contains('normative-card-action')) {
        const index = parseInt(e.target.dataset.index);
        const rateKey = e.target.dataset.rateKey;
  
        openEditNormModal(rateKey, index);
      }
    });
  }
}

// –°–æ–∑–¥–∞–Ω–∏–µ –º–æ–±–∏–ª—å–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
function createMobileCards(results) {
  return results.map((item, index) => {
    const statusClass = item.status;
    const statusIcon = item.status === 'overstated' ? 'üî¥' : 
                      item.status === 'understated' ? 'üü¢' : '‚ö™';
    
    const efficiencyColor = item.avgEfficiency < 70 ? '#ef4444' : 
                           item.avgEfficiency > 120 ? '#10b981' : '#6b7280';
    
    return `
      <div class="normative-card ${statusClass}">
        <div class="normative-card-header">
          <div class="normative-card-title">
            ${item.operation}<br>
            <small style="color: #6b7280; font-weight: normal;">${item.key}</small>
          </div>
          <div class="normative-card-status">${statusIcon}</div>
        </div>
        
        <div class="normative-card-details">
          <div class="normative-detail">
            <div class="normative-detail-value">${item.normPerHour}</div>
            <div class="normative-detail-label">–ù–æ—Ä–º–∞ —à—Ç/—á</div>
          </div>
          <div class="normative-detail">
            <div class="normative-detail-value" style="color: ${efficiencyColor};">${item.avgEfficiency}%</div>
            <div class="normative-detail-label">–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
          </div>
          <div class="normative-detail">
            <div class="normative-detail-value">${item.avgSpeed}</div>
            <div class="normative-detail-label">–°—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å</div>
          </div>
          <div class="normative-detail">
            <div class="normative-detail-value">${item.totalOperations}</div>
            <div class="normative-detail-label">–û–ø–µ—Ä–∞—Ü–∏–π</div>
          </div>
        </div>
        
        <button class="normative-card-action" data-index="${index}" data-rate-key="${item.rateKey}">
          ‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –Ω–æ—Ä–º—É
        </button>
      </div>
    `;
  }).join('');
}

// –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–æ—Ä–º—ã
function openEditNormModal(rateKey, index) {

  
  const item = currentNormativesData[index];
  if (!item) {

    alert("–û—à–∏–±–∫–∞: –¥–∞–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã");
    return;
  }
  

  
  currentEditingNorm = item;
  
  // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
  document.getElementById("editNormOperation").textContent = item.operation;
  document.getElementById("editNormKey").textContent = item.key;
  document.getElementById("editNormCurrent").textContent = item.normPerHour;
  document.getElementById("editNormEfficiency").textContent = item.avgEfficiency;
  document.getElementById("editNormSpeed").textContent = item.avgSpeed;
  document.getElementById("editNormRecommended").value = item.recommendedNorm;
  document.getElementById("editNormNew").value = item.recommendedNorm;
  
  // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è
  let recommendation = "";
  if (item.status === "overstated") {
    recommendation = `üî¥ –ù–æ—Ä–º–∞ –∑–∞–≤—ã—à–µ–Ω–∞! –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å ${item.avgEfficiency}%, —á—Ç–æ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –Ω–∏–∂–µ —Ü–µ–ª–µ–≤—ã—Ö 100%. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–Ω–∏–∑–∏—Ç—å –Ω–æ—Ä–º—É –¥–æ ${item.recommendedNorm} —à—Ç/—á–∞—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω–æ–π —Å—Ä–µ–¥–Ω–µ–π —Å–∫–æ—Ä–æ—Å—Ç–∏ ${item.avgSpeed} —à—Ç/—á–∞—Å.`;
  } else if (item.status === "understated") {
    recommendation = `üü¢ –ù–æ—Ä–º–∞ –∑–∞–Ω–∏–∂–µ–Ω–∞! –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –ª–µ–≥–∫–æ –ø—Ä–µ–≤—ã—à–∞—é—Ç –Ω–æ—Ä–º—É —Å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é ${item.avgEfficiency}%. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–æ–≤—ã—Å–∏—Ç—å –Ω–æ—Ä–º—É –¥–æ ${item.recommendedNorm} —à—Ç/—á–∞—Å –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.`;
  } else {
    recommendation = `‚ö™ –ù–æ—Ä–º–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏. –°—Ä–µ–¥–Ω—è—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å ${item.avgEfficiency}% –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ 80-100%.`;
  }
  
  document.getElementById("editNormRecommendation").textContent = recommendation;
  
  // –û—á–∏—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
  document.getElementById("editNormResult").innerHTML = "";
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
  const modal = document.getElementById("editNormModal");
  if (modal) {
    modal.style.display = "flex";
  
  } else {
    console.error("–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ!");
    alert("–û—à–∏–±–∫–∞: –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ DOM");
  }
}

// –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
function closeEditNormModal() {
  document.getElementById("editNormModal").style.display = "none";
  currentEditingNorm = null;
}

// –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–æ—Ä–º—ã
async function saveNormChange() {
  if (!currentEditingNorm) return;
  
  const newNorm = parseFloat(document.getElementById("editNormNew").value);
  const reason = "–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ —á–µ—Ä–µ–∑ –∞–Ω–∞–ª–∏–∑ –Ω–æ—Ä–º–∞—Ç–∏–≤–æ–≤";
  const resultDiv = document.getElementById("editNormResult");
  const btn = document.getElementById("saveNormBtn");
  
  // –í–∞–ª–∏–¥–∞—Ü–∏—è
  if (!newNorm || newNorm <= 0) {
    resultDiv.innerHTML = '<div style="color:red;">‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –Ω–æ—Ä–º—É (–±–æ–ª—å—à–µ 0)</div>';
    return;
  }
  
  // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
  btn.disabled = true;
  btn.textContent = "‚è≥ –°–æ—Ö—Ä–∞–Ω—è–µ–º...";
  resultDiv.innerHTML = '<div style="color:#2563eb;">üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π...</div>';
  
  try {
    const response = await fetch(`${scriptURL}?type=updateRate&operation=${encodeURIComponent(currentEditingNorm.operation)}&key=${encodeURIComponent(currentEditingNorm.key)}&newNorm=${newNorm}&reason=${encodeURIComponent(reason)}`);
    const data = await response.json();
    
    if (!data.ok) {
      throw new Error(data.message || "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
    }
    
    resultDiv.innerHTML = '<div style="color:green;">‚úÖ –ù–æ—Ä–º–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!</div>';
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü–µ
    currentEditingNorm.normPerHour = newNorm;
    
    // –ß–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã –∑–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É
    setTimeout(() => {
      closeEditNormModal();
      runNormativesAnalysis(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    }, 2000);
    
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–æ—Ä–º—ã:", error);
    resultDiv.innerHTML = `<div style="color:red;">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
  } finally {
    btn.disabled = false;
    btn.textContent = "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è";
  }
}

// –ü–æ–∏—Å–∫ –ø–æ –æ–ø–µ—Ä–∞—Ü–∏—è–º (—Å –∑–∞–¥–µ—Ä–∂–∫–æ–π)
let searchTimeout;

// –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏–π –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
document.addEventListener('DOMContentLoaded', function() {
  const searchInput = document.getElementById("normativesSearch");
  if (searchInput) {
    searchInput.addEventListener("input", function() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        if (currentNormativesData.length > 0) {
          const search = this.value.toLowerCase();
          const filteredResults = currentNormativesData.filter(item => 
            item.operation.toLowerCase().includes(search) || 
            item.key.toLowerCase().includes(search)
          );
          displayNormativesResults(filteredResults);
          
          // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
          const summary = {
            totalOperations: currentNormativesData.length,
            problematicOperations: currentNormativesData.filter(r => r.status !== "normal").length,
            overstatedCount: currentNormativesData.filter(r => r.status === "overstated").length,
            understatedCount: currentNormativesData.filter(r => r.status === "understated").length
          };
          showNormativesSummary(summary, filteredResults.length);
        }
      }, 300);
    });
  }
});

</script>
<div id="editModal" style="display:none; position:fixed; top:10%; left:0; right:0; margin:auto; max-width:500px; background:white; padding:20px; border-radius:10px; box-shadow:0 2px 12px rgba(0,0,0,0.3); z-index:1000;">
  <h3>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å</h3>
  <form id="editForm">
  <input type="hidden" name="rowIndex" />
  <input type="hidden" name="employeeName" />
  <input type="hidden" name="orderNumber" />
  <input type="hidden" name="shiftType" />
  <input type="hidden" name="employeeStatus" />
  <input type="hidden" name="duration" />

  <label>–û–ø–µ—Ä–∞—Ü–∏—è:
    <select name="operationType" id="editOperation" required></select>
  </label>

  <label id="editVolumeLabel">–û–±—ä—ë–º:
    <select name="volume" id="editVolumeSelect"></select>
  </label>

  <div id="editSetNumberField" style="display:none;">
    <label>–ê—Ä—Ç–∏–∫—É–ª –Ω–∞–±–æ—Ä–∞:
      <select name="setNumber" id="editSetNumberSelect"></select>
    </label>
  </div>

  <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:<input name="quantity" type="number" required /></label>
  <label>–ù–∞—á–∞–ª–æ:<input name="startTime" type="time" required /></label>
  <label>–û–∫–æ–Ω—á–∞–Ω–∏–µ:<input name="endTime" type="time" required /></label>

  <button type="button" onclick="submitEditForm()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  <button type="button" onclick="closeEditModal()" class="danger">‚ùå –û—Ç–º–µ–Ω–∞</button>
</form>
</div>
<div id="salaryExportModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.18); z-index:2000; align-items:center; justify-content:center;">
  <div style="background:white; max-width:420px; margin:60px auto; border-radius:14px; box-shadow:0 4px 24px rgba(0,0,0,.15); padding:28px; position:relative;">
    <h3 style="margin-top:0;">üíµ –í—ã–≥—Ä—É–∑–∫–∞ –∑–∞—Ä–ø–ª–∞—Ç—ã</h3>
    <label>–ü–µ—Ä–∏–æ–¥ —Å: <input type="date" id="salaryExportStart" /></label><br>
    <label>–ø–æ: <input type="date" id="salaryExportEnd" /></label><br>
    
    <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–∏–ø–∞ –≤—ã–≥—Ä—É–∑–∫–∏ -->
    <label style="margin-top:16px; display:block;">–¢–∏–ø –≤—ã–≥—Ä—É–∑–∫–∏:</label>
    <div id="exportTypeSelector" style="display: flex; gap: 10px; margin-top: 8px;">
        <style>
            #exportTypeSelector label { display: block; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; cursor: pointer; flex-grow: 1; text-align: center; transition: all 0.2s ease-in-out; }
            #exportTypeSelector input[type="radio"] { display: none; }
            #exportTypeSelector input[type="radio"]:checked + label { background-color: #e0e7ff; border-color: #4f46e5; color: #4f46e5; font-weight: 600; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        </style>
        <input type="radio" id="exportTypePackers" name="exportType" value="packers" checked onchange="toggleEmployeeExportSelector()">
        <label for="exportTypePackers">üì¶ –£–ø–∞–∫–æ–≤—â–∏–∫–∏</label>
        <input type="radio" id="exportTypeSeniors" name="exportType" value="seniors" onchange="toggleEmployeeExportSelector()">
        <label for="exportTypeSeniors">üë®‚Äçüíº –°—Ç–∞—Ä—à–∏–µ —Å–º–µ–Ω</label>
    </div>

    <!-- –°–µ–ª–µ–∫—Ç–æ—Ä —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –¥–ª—è —É–ø–∞–∫–æ–≤—â–∏–∫–æ–≤ -->
    <div id="packersExportSelector" style="margin-top:16px;">
        <label>–°–æ—Ç—Ä—É–¥–Ω–∏–∫:
          <select id="salaryExportEmployee" style="width:100%;margin-top:7px;">
            <option value="">-- –í—Å–µ --</option>
          </select>
        </label>
    </div>

    <!-- –°–µ–ª–µ–∫—Ç–æ—Ä —Å—Ç–∞—Ä—à–∏—Ö —Å–º–µ–Ω -->
    <div id="seniorsExportSelector" style="margin-top:16px; display:none;">
        <label>–°—Ç–∞—Ä—à–∏–π —Å–º–µ–Ω—ã:
          <select id="salaryExportSenior" style="width:100%;margin-top:7px;">
            <option value="">-- –í—Å–µ --</option>
          </select>
        </label>
    </div>

    <div style="margin-top:18px;display:flex;gap:10px;">
      <button onclick="submitSalaryExport()" id="submitSalaryExportBtn" style="flex:1;">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      <button onclick="closeSalaryExportModal()" style="flex:1;background:#ef4444;">‚ùå –û—Ç–º–µ–Ω–∞</button>
    </div>
    <div id="salaryExportResult" style="margin-top:16px; font-weight:500; text-align:center;"></div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö -->
<div id="updateAllModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.18); z-index:2000; align-items:center; justify-content:center;">
  <div style="background:white; max-width:500px; margin:60px auto; border-radius:14px; box-shadow:0 4px 24px rgba(0,0,0,.15); padding:28px; position:relative;">
    <h3 style="margin-top:0;">üîÑ –í—ã–±–æ—Ä–æ—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö</h3>
    <p style="color:#000000; font-size:14px; margin-bottom:20px;">
      –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–∏—Ç—å –∑–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥. –°—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ —É–¥–∞–ª—è—é—Ç—Å—è, —Ç–æ–ª—å–∫–æ –∑–∞–º–µ–Ω—è—é—Ç—Å—è/–¥–æ–ø–æ–ª–Ω—è—é—Ç—Å—è.
    </p>
    
    <label>–ü–µ—Ä–∏–æ–¥ —Å: <input type="date" id="updateAllStart" /></label><br>
    <label>–ø–æ: <input type="date" id="updateAllEnd" /></label><br>
    
    <!-- –ë–ª–æ–∫ –≤—ã–±–æ—Ä–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è -->
    <div style="margin-top:20px; border:1px solid #e5e7eb; border-radius:8px; padding:16px; background:#f9fafb;">
              <h4 style="margin:0 0 12px 0; font-size:16px; color:#000000;">–ß—Ç–æ –æ–±–Ω–æ–≤–ª—è—Ç—å:</h4>
      
      <div style="display:flex; flex-direction:column; gap:12px;">
        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:8px; border-radius:6px; transition:background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='transparent'">
          <input type="checkbox" id="updateSeniorsSalary" checked style="width:16px; height:16px;">
          <div>
            <strong>üë®‚Äçüíº –ó–∞—Ä–ø–ª–∞—Ç—ã —Å—Ç–∞—Ä—à–∏—Ö —Å–º–µ–Ω</strong>
            <div style="font-size:12px; color:#000000;">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—á–µ—Ç–∞ –∑–∞—Ä–ø–ª–∞—Ç —Å—Ç–∞—Ä—à–∏—Ö —Å–º–µ–Ω –∑–∞ –ø–µ—Ä–∏–æ–¥</div>
          </div>
        </label>
        
        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:8px; border-radius:6px; transition:background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='transparent'">
          <input type="checkbox" id="updateStaffIndicators" checked style="width:16px; height:16px;">
          <div>
            <strong>üìä –ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —à—Ç–∞—Ç–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</strong>
            <div style="font-size:12px; color:#000000;">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ –Ω–æ—Ä–º —à—Ç–∞—Ç–∞</div>
          </div>
        </label>
        
        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:8px; border-radius:6px; transition:background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='transparent'">
          <input type="checkbox" id="updateOutsourcingIndicators" checked style="width:16px; height:16px;">
          <div>
            <strong>üè¢ –ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –∞—É—Ç—Å–æ—Ä—Å–∏–Ω–≥–∞</strong>
            <div style="font-size:12px; color:#000000;">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤–Ω–µ—à–Ω–∏—Ö –ø–æ–¥—Ä—è–¥—á–∏–∫–æ–≤</div>
          </div>
        </label>
      </div>
      
      <!-- –ö–Ω–æ–ø–∫–∏ –±—ã—Å—Ç—Ä–æ–≥–æ –≤—ã–±–æ—Ä–∞ -->
      <div style="margin-top:16px; display:flex; gap:8px; border-top:1px solid #e5e7eb; padding-top:12px;">
        <button type="button" onclick="selectAllUpdates()" style="flex:1; background:#e5e7eb; color:#000000; border:none; padding:6px 12px; border-radius:4px; font-size:12px; cursor:pointer;">‚úÖ –í—Å–µ</button>
        <button type="button" onclick="selectNoneUpdates()" style="flex:1; background:#e5e7eb; color:#000000; border:none; padding:6px 12px; border-radius:4px; font-size:12px; cursor:pointer;">‚ùå –ù–∏—á–µ–≥–æ</button>
        <button type="button" onclick="selectOnlySeniors()" style="flex:1; background:#e5e7eb; color:#000000; border:none; padding:6px 12px; border-radius:4px; font-size:12px; cursor:pointer;">üë®‚Äçüíº –¢–æ–ª—å–∫–æ —Å—Ç–∞—Ä—à–∏–µ</button>
      </div>
    </div>
    
    <div style="margin-top:18px;display:flex;gap:10px;">
      <button onclick="submitSelectiveUpdate()" id="submitUpdateAllBtn" style="flex:1; background:#8b5cf6;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ</button>
      <button onclick="closeUpdateAllModal()" style="flex:1;background:#ef4444;">‚ùå –û—Ç–º–µ–Ω–∞</button>
    </div>
    <div id="updateAllResult" style="margin-top:16px; font-weight:500; text-align:center; white-space:pre-line;"></div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–æ—Ä–º—ã -->
<div id="editNormModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.18); z-index:2000; align-items:center; justify-content:center;">
  <div style="background:white; max-width:600px; margin:60px auto; border-radius:14px; box-shadow:0 4px 24px rgba(0,0,0,.15); padding:28px; position:relative;">
    <h3 style="margin-top:0; text-align:center; color:#f59e0b;">üîç –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ—Ä–º—ã</h3>
    
    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–ø–µ—Ä–∞—Ü–∏–∏ -->
    <div style="background:#f8fafc; padding:16px; border-radius:12px; margin-bottom:20px;">
      <div style="margin-bottom:12px;"><strong>üìã –û–ø–µ—Ä–∞—Ü–∏—è:</strong> <span id="editNormOperation">-</span></div>
      <div style="margin-bottom:12px;"><strong>üì¶ –û–±—ä–µ–º/–ö–ª—é—á:</strong> <span id="editNormKey">-</span></div>
      <div style="margin-bottom:12px;"><strong>‚è±Ô∏è –¢–µ–∫—É—â–∞—è –Ω–æ—Ä–º–∞:</strong> <span id="editNormCurrent">-</span> —à—Ç/—á–∞—Å</div>
      <div style="margin-bottom:12px;"><strong>üìä –°—Ä–µ–¥–Ω—è—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:</strong> <span id="editNormEfficiency">-</span>%</div>
      <div><strong>üéØ –°—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å:</strong> <span id="editNormSpeed">-</span> —à—Ç/—á–∞—Å</div>
    </div>
    
    <!-- –ê–Ω–∞–ª–∏–∑ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è -->
    <div id="editNormAnalysis" style="background:#fef3c7; padding:16px; border-radius:12px; margin-bottom:20px; border-left:4px solid #f59e0b;">
      <h4 style="margin:0 0 8px 0; color:#92400e;">üí° –ê–Ω–∞–ª–∏–∑ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:</h4>
      <div id="editNormRecommendation" style="color:#451a03;">-</div>
    </div>
    
    <!-- –ü–æ–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <div style="margin-bottom:20px;">
      <label style="display:block; margin-bottom:8px; font-weight:600;">üéØ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –Ω–æ—Ä–º–∞:</label>
      <input type="number" id="editNormRecommended" readonly style="background:#f3f4f6; margin-bottom:16px;" placeholder="0">
      
      <label style="display:block; margin-bottom:8px; font-weight:600;">‚úèÔ∏è –ù–æ–≤–∞—è –Ω–æ—Ä–º–∞ (—à—Ç/—á–∞—Å):</label>
      <input type="number" id="editNormNew" min="1" step="1" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é –Ω–æ—Ä–º—É...">
    </div>
    
    <!-- –ö–Ω–æ–ø–∫–∏ -->
    <div style="display:flex; gap:12px;">
      <button onclick="saveNormChange()" id="saveNormBtn" style="flex:1; background:#10b981;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
      <button onclick="closeEditNormModal()" style="flex:1; background:#ef4444;">‚ùå –û—Ç–º–µ–Ω–∞</button>
    </div>
    
    <div id="editNormResult" style="margin-top:16px; font-weight:500; text-align:center;"></div>
  </div>
</div>

<!-- üë®‚Äçüéì –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞–∂–µ—Ä–∞–º–∏ -->
<div class="container" style="display:none;" id="traineeManagementContainer">
  <h2>üë®‚Äçüéì –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞–∂–µ—Ä–∞–º–∏</h2>
  <button onclick="hideTraineeManagement()" style="margin-bottom: 10px; background:#6b7280;">‚Üê –ù–∞–∑–∞–¥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</button>
  
  <!-- üìã –¢–µ–∫—É—â–∏–µ —Å–≤—è–∑–∏ -->
  <h3>üìã –¢–µ–∫—É—â–∏–µ —Å–≤—è–∑–∏ –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫ ‚Üî —Å—Ç–∞–∂–µ—Ä</h3>
  <button onclick="loadMentorshipPairs()" id="refreshPairsBtn" style="background:#3b82f6; margin-bottom: 10px;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–≤—è–∑–µ–π</button>
  <div style="overflow-x: auto;">
    <div id="mentorshipPairsList" style="margin-top: 16px;">
      <p style="color: #6b7280; text-align: center;">–ù–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–≤—è–∑–µ–π" –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏</p>
    </div>
  </div>
  
  <!-- ‚ûï –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Å–≤—è–∑–∏ -->
  <h3 style="margin-top: 30px;">‚ûï –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Å–≤—è–∑–∏</h3>
  <label>üë®‚Äçüíº –í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–∞:
    <select id="mentorSelect" required>
      <option value="">-- –ó–∞–≥—Ä—É–∑–∫–∞... --</option>
    </select>
  </label>
  <label>üë®‚Äçüéì –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞–∂–µ—Ä–∞:
    <select id="traineeSelect" required>
      <option value="">-- –ó–∞–≥—Ä—É–∑–∫–∞... --</option>
    </select>
  </label>
  
  <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–æ–Ω—É—Å–µ -->
  <div style="background: #f0f9ff; border: 1px solid #3b82f6; border-radius: 8px; padding: 12px; margin: 16px 0;">
    <strong style="color: #1e40af;">üí∞ –ë–æ–Ω—É—Å –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–∞:</strong>
    <span style="color: #1f2937;">–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –±–æ–Ω—É—Å 1750 ‚ÇΩ –∑–∞ —Å–º–µ–Ω—É –∑–∞ –∫–∞–∂–¥–æ–≥–æ —Å—Ç–∞–∂–µ—Ä–∞</span>
  </div>
  
  <button onclick="createMentorshipPair()" id="createPairBtn" style="background:#10b981;">‚úÖ –°–æ–∑–¥–∞—Ç—å —Å–≤—è–∑—å</button>
  <button onclick="loadMentorsAndTrainees()" style="background:#6b7280; margin-left: 10px;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–∫–∏</button>
  
  <!-- üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ä–∞–±–æ—Ç—ã –ø–∞—Ä -->
  <h3 style="margin-top: 30px;">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ä–∞–±–æ—Ç—ã –ø–∞—Ä</h3>
  <label>üìÖ –ü–µ—Ä–∏–æ–¥ —Å:
    <input type="date" id="analyticsStartDate">
  </label>
  <label style="margin-left:10px;">–ø–æ:
    <input type="date" id="analyticsEndDate">
  </label>
  <button onclick="loadTraineeAnalytics()" id="loadAnalyticsBtn" style="background:#8b5cf6;">üìä –ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É</button>
  <div style="overflow-x: auto;">
    <div id="traineeAnalyticsResults" style="margin-top: 20px;">
      <p style="color: #6b7280; text-align: center;">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –∏ –Ω–∞–∂–º–∏—Ç–µ "–ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É"</p>
    </div>
  </div>
  
  <!-- üßπ –û—á–∏—Å—Ç–∫–∞ —Å–≤—è–∑–µ–π -->
  <h3 style="margin-top: 30px;">üßπ –û—á–∏—Å—Ç–∫–∞ —Å–≤—è–∑–µ–π –Ω–∞—Å—Ç–∞–≤–Ω–∏—á–µ—Å—Ç–≤–∞</h3>
  <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
    <strong style="color: #92400e;">‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ!</strong>
    <span style="color: #92400e; font-size: 14px;">
      –†—É—á–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —É–¥–∞–ª–∏—Ç –í–°–ï —Å–≤—è–∑–∏ –Ω–∞—Å—Ç–∞–≤–Ω–∏—á–µ—Å—Ç–≤–∞. –≠—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏—è –Ω–µ–æ–±—Ä–∞—Ç–∏–º–∞.
      –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é: –¥–Ω–µ–≤–Ω–∞—è —Å–º–µ–Ω–∞ –≤ 23:00, –Ω–æ—á–Ω–∞—è –≤ 11:00.
    </span>
  </div>
  <button onclick="cleanupAllMentorshipPairs(false)" id="previewCleanupBtn" style="background:#3b82f6;">üîç –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä</button>
  <button onclick="cleanupAllMentorshipPairs(true)" id="executeCleanupBtn" style="background:#ef4444; margin-left: 10px;">üßπ –í—ã–ø–æ–ª–Ω–∏—Ç—å –æ—á–∏—Å—Ç–∫—É</button>
  <div style="overflow-x: auto;">
    <div id="cleanupResults" style="margin-top: 16px; display: none;"></div>
  </div>
</div>



<script>
  window.addEventListener("load", () => {
    setTimeout(() => {
      const screen = document.getElementById("loadingScreen");
      if (screen) {
        screen.style.opacity = "0";
        screen.style.transition = "opacity 0.5s ease";
        setTimeout(() => screen.remove(), 500); // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
      }
    }, 5000); // –ó–ê–î–ï–†–ñ–ö–ê 3 —Å–µ–∫—É–Ω–¥—ã
  });
</script>
</body>
</html>