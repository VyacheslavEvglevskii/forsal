<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<link rel="manifest" href="manifest.json">
<link rel="icon" href="icon-192.png" type="image/png">
<meta name="theme-color" content="#34d399">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="PackControl">
<link rel="apple-touch-icon" href="icon-512.png">
  <title>📦 Учёт упаковки</title>
  <style>
  /* ===== Основы ===== */
body {
  margin: 0;
  padding: 72px 12px 12px;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background-color: #f1f5f9;
}

.table-scroll {
  overflow-x: auto;
  width: 100%;
}
@media (max-width: 600px) {
  #ratesTable table, .table-scroll table {
    font-size: 12px;
    min-width: 600px;
  }
  #ratesTable th, #ratesTable td {
    padding: 6px 8px;
  }
  
  /* === МОБИЛЬНАЯ АДАПТАЦИЯ АНАЛИЗА НОРМАТИВОВ === */
  #normativesAnalysisContainer {
    margin-top: 10px !important;
  }
  
  /* Фильтры на мобильных */
  #normativesAnalysisContainer .filters-mobile {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  
  #normativesAnalysisContainer .filters-row {
    display: flex;
    gap: 8px;
  }
  
  #normativesAnalysisContainer .filters-row > div {
    flex: 1;
  }
  
  /* Таблица нормативов на мобильных - карточки */
  .normatives-mobile-cards {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  
  .normative-card {
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    padding: 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  
  .normative-card.overstated {
    border-color: #f97316;
    background: linear-gradient(135deg, #fff7ed 0%, #fed7aa 100%);
  }
  
  .normative-card.understated {
    border-color: #10b981;
    background: linear-gradient(135deg, #ecfdf5 0%, #a7f3d0 100%);
  }
  
  .normative-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 12px;
  }
  
  .normative-card-title {
    font-size: 16px;
    font-weight: 600;
    color: #1f2937;
    line-height: 1.2;
    flex: 1;
  }
  
  .normative-card-status {
    font-size: 20px;
    margin-left: 8px;
  }
  
  .normative-card-details {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-bottom: 16px;
  }
  
  .normative-detail {
    text-align: center;
    padding: 8px;
    background: rgba(255,255,255,0.7);
    border-radius: 8px;
  }
  
  .normative-detail-value {
    font-size: 16px;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 2px;
  }
  
  .normative-detail-label {
    font-size: 11px;
    color: #6b7280;
  }
  
  .normative-card-action {
    width: 100%;
    background: #f59e0b;
    color: white;
    border: none;
    padding: 12px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
  }
  
  /* Модальное окно на мобильных */
  #editNormModal .modal-content {
    margin: 20px !important;
    max-height: calc(100vh - 40px) !important;
    max-width: calc(100vw - 40px) !important;
  }
  
  #editNormModal .info-grid-mobile {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-bottom: 20px;
  }
  
  #editNormModal .info-item-mobile {
    background: #f8fafc;
    padding: 12px;
    border-radius: 8px;
    text-align: center;
  }
  
  #editNormModal .info-value-mobile {
    font-size: 16px;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 4px;
  }
  
  #editNormModal .info-label-mobile {
    font-size: 11px;
    color: #6b7280;
  }
  
  /* Скрываем обычную таблицу на мобильных */
  @media (max-width: 768px) {
    .normatives-desktop-table {
      display: none !important;
    }
    
    .normatives-mobile-cards {
      display: flex !important;
    }
  }
  
  /* Показываем таблицу на десктопе */
  @media (min-width: 769px) {
    .normatives-desktop-table {
      display: block !important;
    }
    
    .normatives-mobile-cards {
      display: none !important;
    }
    
    .filters-mobile {
      display: none !important;
    }
    
    .filters-desktop {
      display: block !important;
    }
  }
  
  /* Показываем мобильные элементы на маленьких экранах */
  @media (max-width: 768px) {
    .filters-mobile {
      display: flex !important;
    }
    
    .filters-desktop {
      display: none !important;
    }
  }
}

h2 {
  font-size: 22px;
  font-weight: 600;
  color: #000000;
  margin-bottom: 20px;
  text-align: center;
}

.container {
  background-color: #ffffff;
  border-radius: 16px;
  padding: 20px;
  margin: 24px auto;
  max-width: 600px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}



label {
  display: block;
  font-weight: 600;
  color: #000000;
  margin-top: 16px;
  margin-bottom: 6px;
  font-size: 15px;
}

p {
  color: #000000;
}

span {
  color: #000000;
}

div {
  color: #000000;
}

input, select, textarea {
  width: 100%;
  padding: 12px;
  font-size: 15px;
  border: 1px solid #d1d5db;
  border-radius: 10px;
  background: #f9fafb;
  color: #000000;
  margin-bottom: 16px;
  box-sizing: border-box;
  transition: border 0.2s ease, box-shadow 0.2s ease;
}

input:focus, select:focus, textarea:focus {
  border-color: #2563eb;
  background-color: #ffffff;
  outline: none;
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
}

button {
  background-color: #2563eb;
  color: white;
  padding: 16px 18px;
  font-size: 15px;
  font-weight: 600;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  width: 100%;
  margin-top: 12px;
  min-height: 48px;
  touch-action: manipulation;
  transition: background 0.2s ease, transform 0.1s ease;
}

/* Исключение для кнопок - оставляем белый текст */
button {
  color: white !important;
}

/* Исключение для элементов с градиентным фоном */
div[style*="background: linear-gradient"] {
  color: white !important;
}

/* Исключение для элементов с цветным фоном (только для информационных блоков) */
div[style*="background: #"] {
  color: white !important;
}

/* Исключение для кнопок с цветным фоном */
button[style*="background:"] {
  color: white !important;
}

button:hover {
  background-color: #1d4ed8;
}

button:active {
  transform: scale(0.97);
}

/* Анимация для кнопки сохранения при изменениях */
@keyframes pulseButton {
  0% {
    box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.7);
  }
  70% {
    box-shadow: 0 0 0 8px rgba(37, 99, 235, 0);
  }
  100% {
    box-shadow: 0 0 0 0 rgba(37, 99, 235, 0);
  }
}

.save-button-pulse {
  animation: pulseButton 2s infinite;
}

/* Анимация для кнопки входа */
#loginBtn {
  transition: all 0.3s ease;
  position: relative;
}

#loginBtn:hover {
  background-color: #1d4ed8;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
}

#loginBtn:active {
  transform: translateY(0);
}

/* Стиль для состояния загрузки */
#loginBtn.loading {
  background-color: #6b7280 !important;
  cursor: not-allowed !important;
}

/* Анимация для уведомлений о кэше */
@keyframes slideIn {
  0% {
    transform: translateX(100%);
    opacity: 0;
  }
  100% {
    transform: translateX(0);
    opacity: 1;
  }
}

button.danger {
  background-color: #dc2626;
}

button.danger:hover {
  background-color: #b91c1c;
}

.top-nav {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  display: flex;
  justify-content: space-around;
  background-color: #2563eb;
  padding: 10px 0;
  border-bottom-left-radius: 12px;
  border-bottom-right-radius: 12px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
  z-index: 1000;
}

.top-nav button {
  background: none;
  border: none;
  color: white;
  font-size: 20px;
  cursor: pointer;
  flex: 1;
  text-align: center;
  transition: all 0.3s ease;
  padding: 12px 6px;
  min-height: 48px;
  touch-action: manipulation;
}

/* Стили для скрытых кнопок в админ-режиме */
.top-nav button.admin-hidden {
  display: none !important;
  visibility: hidden !important;
  width: 0 !important;
  padding: 0 !important;
  margin: 0 !important;
  flex: 0 !important;
}

.top-nav button.admin-visible {
  display: inline-block !important;
  visibility: visible !important;
  flex: 1 !important;
}

.mobile-nav button:active {
  transform: scale(0.94);
}

.mobile-nav button.active {
  background: #1e40af;
  color: white;
}

.stat-card {
  background-color: #ffffff;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  padding: 16px;
  margin-top: 16px;
  font-size: 15px;
  color: #1f2937;
}

.stat-card p {
  margin: 6px 0;
}

.stat-card button {
  margin-top: 12px;
  padding: 12px 16px;
  font-size: 16px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  background-color: #2563eb;
  color: white;
  min-height: 48px;
  touch-action: manipulation;
}

.stat-card button:hover {
  background-color: #1d4ed8;
}

#rateInfo, #calcBlock {
  margin-top: 16px;
  padding: 16px;
  border-radius: 12px;
  background-color: #f3f4f6;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
  font-size: 15px;
  color: #1f2937;
}

#rateInfo p, #calcBlock p {
  margin: 8px 0;
  display: flex;
  justify-content: space-between;
  font-weight: 500;
}

#rateInfo strong, #calcBlock strong {
  color: #111827;
}

#totalWage {
  font-size: 16px;
  margin-top: 16px;
  background: #ecfdf5;
  padding: 12px;
  border-radius: 10px;
  text-align: center;
  color: #065f46;
  font-weight: 600;
  box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04);
}

#editModal {
  max-width: 480px;
  background-color: white;
  border-radius: 16px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
  padding: 24px;
  font-size: 15px;
  color: #1f2937;
}

#editModal label {
  display: block;
  margin-top: 12px;
  font-weight: 500;
}

#editModal select, #editModal input {
  width: 100%;
  padding: 8px;
  margin-top: 4px;
  border-radius: 8px;
  border: 1px solid #d1d5db;
  font-size: 15px;
}

#editModal button {
  margin-top: 16px;
  padding: 10px 16px;
  border: none;
  border-radius: 10px;
  background-color: #2563eb;
  color: white;
  font-weight: 600;
  cursor: pointer;
}

#editModal button:hover {
  background-color: #1d4ed8;
}

#editModal button.danger {
  background-color: #dc2626;
  margin-left: 12px;
}

#editModal button.danger:hover {
  background-color: #b91c1c;
}

.tooltip[data-tooltip]:hover::after {
  content: attr(data-tooltip);
  position: absolute;
  background-color: #1f2937;
  color: white;
  padding: 6px 10px;
  border-radius: 6px;
  font-size: 13px;
  white-space: nowrap;
  top: 100%;
  left: 0;
  margin-top: 6px;
  z-index: 10;
}

#ratesTable {
  width: 100%;
  border-collapse: collapse;
  margin-top: 16px;
  background: white;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
}

#ratesTable th, #ratesTable td {
  padding: 12px 14px;
  text-align: left;
  font-size: 16px; /* Увеличили с 14px до 16px */
  border-bottom: 1px solid #e5e7eb;
}

#ratesTable th {
  background-color: #f3f4f6;
  color: #374151;
  font-weight: 600;
  position: sticky;
  top: 0;
  z-index: 10;
  cursor: pointer;
  transition: background-color 0.2s;
}

#ratesTable th:hover {
  background-color: #e5e7eb;
}

/* Цветовое кодирование колонок тарифов */
#ratesTable th:nth-child(4), #ratesTable td:nth-child(4) {
  background-color: rgba(59, 130, 246, 0.05); /* Голубой для сдельной */
  border-left: 3px solid #3b82f6;
}

#ratesTable th:nth-child(5), #ratesTable td:nth-child(5) {
  background-color: rgba(34, 197, 94, 0.05); /* Зеленый для FBS */
  border-left: 3px solid #22c55e;
}

#ratesTable th:nth-child(6), #ratesTable td:nth-child(6) {
  background-color: rgba(147, 51, 234, 0.05); /* Фиолетовый для оклад+сдел */
  border-left: 3px solid #9333ea;
}

#ratesTable th:nth-child(7), #ratesTable td:nth-child(7) {
  background-color: rgba(147, 51, 234, 0.08); /* Темнее для FBS оклад+сдел */
  border-left: 3px solid #7c3aed;
}

/* Выделение тарифных значений */
#ratesTable td:nth-child(4), #ratesTable td:nth-child(5), 
#ratesTable td:nth-child(6), #ratesTable td:nth-child(7) {
  font-weight: 600;
  color: #1f2937;
}

#ratesTable tr:nth-child(even) td {
  background-color: rgba(249, 250, 251, 0.5);
}

#ratesTable tr:hover td {
  background-color: rgba(238, 242, 255, 0.8);
  transform: scale(1.01);
  transition: all 0.2s ease;
  box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
}

/* Сортировка - индикаторы */
#ratesTable th.sortable::after {
  content: ' ↕️';
  opacity: 0.5;
  font-size: 12px;
}

#ratesTable th.sorted-asc::after {
  content: ' ⬆️';
  opacity: 1;
}

#ratesTable th.sorted-desc::after {
  content: ' ⬇️';
  opacity: 1;
}

#adminContainer {
  background: white;
  border-radius: 16px;
  padding: 20px;
  margin-top: 20px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
}

#adminContainer h3 {
  font-size: 18px;
  margin-bottom: 12px;
  color: #000000;
  font-weight: 600;
}

#adminContainer input[type="text"],
#adminContainer select {
  width: 100%;
  padding: 10px;
  margin-top: 6px;
  border-radius: 10px;
  border: 1px solid #d1d5db;
  font-size: 15px;
  background: #f9fafb;
}

#adminContainer button {
  margin-top: 12px;
}

@media (max-width: 500px) {
  .container, #editModal {
    padding: 16px;
    border-radius: 12px;
  }

  #ratesTable th, #ratesTable td {
    padding: 10px 12px;
  }

  button {
    font-size: 14px;
    padding: 12px;
  }

  h2 {
    font-size: 20px;
  }

  #adminContainer label {
    flex: 1 1 100%;
  }

  #adminContainer input[type="date"] {
    font-size: 16px;
  }

  .form-item label,
  input,
  select {
    font-size: 14px;
    padding: 6px;
  }
}

/* ===== СТИЛИ ДЛЯ СИСТЕМЫ ЗАЩИТЫ ОТ ДУБЛИКАТОВ ===== */
.duplicate-warnings {
  margin: 16px 0;
  border-radius: 12px;
  overflow: hidden;
  display: none;
}

.warning-section {
  margin-bottom: 12px;
  border-radius: 8px;
  padding: 12px;
}

.warning-section.critical {
  background: #fef2f2;
  border-left: 4px solid #dc2626;
}

.warning-section.warning {
  background: #fffbeb;
  border-left: 4px solid #f59e0b;
}

.warning-section.info {
  background: #eff6ff;
  border-left: 4px solid #3b82f6;
}

.warning-section h4 {
  margin: 0 0 8px 0;
  font-size: 14px;
  font-weight: 600;
}

.warning-section.critical h4 {
  color: #dc2626;
}

.warning-section.warning h4 {
  color: #d97706;
}

.warning-section.info h4 {
  color: #2563eb;
}

.warning-item {
  padding: 8px;
  margin: 6px 0;
  border-radius: 6px;
  font-size: 13px;
}

.warning-item.critical {
  background: #fecaca;
  color: #7f1d1d;
}

.warning-item.warning {
  background: #fed7aa;
  color: #92400e;
}

.warning-item.info {
  background: #bfdbfe;
  color: #1e40af;
}

.warning-item small {
  color: rgba(0, 0, 0, 0.6);
  font-size: 11px;
  display: block;
  margin-top: 4px;
}

.form-validation-hint {
  position: relative;
}

.form-validation-hint::after {
  content: '';
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  width: 16px;
  height: 16px;
  border-radius: 50%;
  display: none;
}

.form-validation-hint.valid::after {
  background: #10b981;
  display: block;
}

.form-validation-hint.warning::after {
  background: #f59e0b;
  display: block;
}

.form-validation-hint.error::after {
  background: #ef4444;
  display: block;
}

.smart-suggestion {
  background: #f0f9ff;
  border: 1px solid #0ea5e9;
  border-radius: 8px;
  padding: 12px;
  margin: 8px 0;
  font-size: 13px;
}

.smart-suggestion h5 {
  margin: 0 0 6px 0;
  color: #0369a1;
  font-weight: 600;
}

.smart-suggestion button {
  background: #0ea5e9;
  color: white;
  border: none;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 11px;
  cursor: pointer;
  margin-top: 6px;
}

/* ===== СТИЛИ ДЛЯ СООБЩЕНИЙ И УВЕДОМЛЕНИЙ ===== */
.success-message {
  background: #d1fae5;
  color: #065f46;
  border: 1px solid #a7f3d0;
  padding: 12px;
  border-radius: 8px;
  margin: 12px 0;
}

.error-message {
  background: #fef2f2;
  color: #991b1b;
  border: 1px solid #fca5a5;
  padding: 12px;
  border-radius: 8px;
  margin: 12px 0;
}

.warning-message {
  background: #fef3c7;
  color: #92400e;
  border: 1px solid #fcd34d;
  padding: 12px;
  border-radius: 8px;
  margin: 12px 0;
}

/* Улучшенные стили для кнопки отправки */
#dataForm button[type="submit"] {
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

#dataForm button[type="submit"]:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: scale(0.98);
}

#dataForm button[type="submit"]:not(:disabled):hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

/* Индикатор загрузки для кнопки */
#dataForm button[type="submit"].loading::after {
  content: "";
  position: absolute;
  top: 50%;
  left: 50%;
  width: 16px;
  height: 16px;
  margin: -8px 0 0 -8px;
  border: 2px solid transparent;
  border-top: 2px solid #ffffff;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Анимации для уведомлений */
@keyframes slideInRight {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

@keyframes slideOutRight {
  from {
    transform: translateX(0);
    opacity: 1;
  }
  to {
    transform: translateX(100%);
    opacity: 0;
  }
}

/* Улучшенная блокировка формы */
.form-disabled {
  pointer-events: none;
  opacity: 0.7;
  transition: opacity 0.3s ease;
}

.form-disabled::after {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(255, 255, 255, 0.1);
  z-index: 1000;
}

#appContainer.fullscreen {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: white;
  z-index: 1000;
  overflow-y: auto;
  padding: 20px;
}

#saveBar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: white;
  padding: 12px;
  box-shadow: 0 -2px 6px rgba(0, 0, 0, 0.08);
  z-index: 1100;
}

#saveBar button {
  width: 100%;
  font-size: 16px;
}

.form-row {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 12px;
}

.form-item {
  flex: 1 1 200px;
  min-width: 140px;
}

.form-item label {
  display: block;
  font-size: 16px;
  margin-bottom: 6px;
}

@media (max-width: 600px) {
  body {
    padding: 48px 2px 2px;
    font-size: 15px;
  }
  .container, .block, #editModal, #adminContainer, #mySalaryContainer, #ratesContainer, #profileContainer {
    padding: 6px 2px;
    border-radius: 8px;
    max-width: 100vw;
    box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    margin: 6px 0;
  }
  h2, .block-title {
    font-size: 17px;
    margin-bottom: 10px;
  }
  label, .item-label {
    font-size: 13px;
    margin-bottom: 2px;
  }
  input, select, textarea {
    font-size: 16px;
    min-height: 44px;
    padding: 12px 8px;
    border-radius: 8px;
    -webkit-appearance: none;
    appearance: none;
  }
  button, .button {
    font-size: 14px;
    min-height: 44px;
    border-radius: 8px;
    padding: 12px 8px;
    touch-action: manipulation;
  }
  .form-row, .block, .list {
    margin-bottom: 6px;
  }
  .table-scroll {
    overflow-x: auto;
    max-width: 100vw;
  }
  table {
    min-width: 480px;
    font-size: 12px;
  }
  th, td {
    white-space: nowrap;
    padding: 8px 10px;
    min-height: 44px;
    vertical-align: middle;
  }
  
  /* Улучшенная адаптивность для блока тарифов */
  #ratesContainer {
    padding: 8px 4px;
  }
  
  #ratesFilters {
    flex-direction: column !important;
    gap: 8px !important;
  }
  
  #ratesFilters > div {
    min-width: auto !important;
  }
  
  #ratesSearch {
    font-size: 16px !important; /* Предотвращает зум на iOS */
  }
  
  #ratesTable {
    font-size: 12px;
  }
  
  #ratesTable th, #ratesTable td {
    padding: 12px 8px;
    font-size: 14px;
    min-height: 44px;
    vertical-align: middle;
  }
  
  /* Скрываем менее важные колонки на мобильных */
  #ratesTable th:nth-child(6), #ratesTable td:nth-child(6),
  #ratesTable th:nth-child(7), #ratesTable td:nth-child(7) {
    display: none;
  }
  
  /* Индикатор скрытых колонок */
  #ratesTable::after {
    content: "💡 Поверните экран для просмотра всех тарифов";
    display: block;
    text-align: center;
    padding: 12px;
    background: #fef3c7;
    color: #92400e;
    border-radius: 8px;
    margin-top: 8px;
    font-size: 12px;
    }

  /* Компактный поиск на мобильных */
  #ratesContainer > div:first-of-type {
    padding: 12px 8px !important;
  }
  
  /* Модальные окна на мобильных */
  .modal-content {
    margin: 10px !important;
    max-width: calc(100vw - 20px) !important;
    max-height: calc(100vh - 20px) !important;
    overflow-y: auto;
  }
  
  /* Улучшенная прокрутка для мобильных */
  .table-scroll {
    -webkit-overflow-scrolling: touch;
  }
  
  /* Кнопки в модальных окнах */
  .modal-content button {
    min-height: 48px !important;
    font-size: 16px !important;
    padding: 12px !important;
    touch-action: manipulation;
  }
  
  /* Мобильная форма старшего смены - простая и читаемая */
  #reportContainer .senior-shift-form {
    padding: 12px !important;
    margin: 8px !important;
    border-radius: 12px !important;
    background: #ffffff !important;
    border: 1px solid #e5e7eb !important;
  }
  
  #reportContainer .senior-shift-form h3 {
    font-size: 18px !important;
    margin-bottom: 16px !important;
    color: #22c55e !important;
    text-align: center !important;
  }
  
  #reportContainer .senior-shift-form .form-row {
    flex-direction: column !important;
    gap: 8px !important;
    margin-bottom: 16px !important;
  }
  
  #reportContainer .senior-shift-form .form-row > div {
    min-width: auto !important;
    width: 100% !important;
  }
  
  #reportContainer .senior-shift-form select,
  #reportContainer .senior-shift-form input[type="date"] {
    min-height: 50px !important;
    font-size: 16px !important;
    padding: 14px 16px !important;
    border: 2px solid #e5e7eb !important;
    border-radius: 8px !important;
    background: #ffffff !important;
  }
  
  #reportContainer .senior-shift-form label {
    font-size: 14px !important;
    margin-bottom: 6px !important;
    font-weight: 600 !important;
    color: #374151 !important;
  }
  
  /* Простые кнопки выбора смены */
  #reportContainer .senior-shift-form .shift-buttons {
    display: flex !important;
    gap: 8px !important;
    margin-top: 8px !important;
  }
  
  #reportContainer .senior-shift-form .shift-button {
    flex: 1 !important;
    min-height: 50px !important;
    padding: 12px 8px !important;
    font-size: 16px !important;
    font-weight: 600 !important;
    border: 2px solid #e5e7eb !important;
    border-radius: 8px !important;
    background: #ffffff !important;
    color: #6b7280 !important;
    cursor: pointer !important;
    transition: all 0.2s ease !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    text-align: center !important;
  }
  
  #reportContainer .senior-shift-form .shift-button.active {
    border-color: #22c55e !important;
    background: #22c55e !important;
    color: #ffffff !important;
    box-shadow: 0 2px 4px rgba(34, 197, 94, 0.2) !important;
    transform: scale(0.98) !important;
  }
  
  #reportContainer .senior-shift-form .shift-button:active {
    transform: scale(0.95) !important;
  }
  
  #reportContainer .senior-shift-form .button-group {
    gap: 8px !important;
    margin-top: 20px !important;
  }
  
  #reportContainer .senior-shift-form .button-group button {
    padding: 14px 20px !important;
    font-size: 16px !important;
    min-height: 50px !important;
    border-radius: 8px !important;
    font-weight: 600 !important;
  }
  
  #reportContainer .senior-shift-form .info-text {
    font-size: 12px !important;
    margin: 12px 0 !important;
    padding: 8px !important;
    line-height: 1.4 !important;
    color: #6b7280 !important;
    text-align: center !important;
  }
}

  </style>
</head>
<body>
<!-- Загрузочный экран Forsal -->
<div id="loadingScreen" style="
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: #f1f5f9;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
">
  <img src="forsal-loading-final.png" alt="Загрузка Forsal" style="
    width: 100%;
    max-width: 480px;
    height: auto;
    object-fit: contain;
    padding: 20px;
  ">
</div>
  <nav id="bottomNav" class="top-nav" style="display: none;">
    <button id="tabProfile" onclick="switchTab('profile')">👤</button>
    <button id="tabApp" onclick="switchTab('app')" disabled>📋</button>
    <button id="tabStats" onclick="switchTab('stats')">📈</button>
    <button id="tabCostAnalysis" onclick="switchTab('costAnalysis')" style="display: none;">📊</button>
    <button id="tabTraineeManagement" onclick="switchTab('traineeManagement')" style="display: none;">👨‍🎓</button>
    <button id="tabRates" onclick="switchTab('rates')">💰</button>
    <button id="tabMySalary" onclick="switchTab('mySalary')">💵</button>
    <button id="tabDuplicates" onclick="switchTab('duplicates')" style="display: none;">🔍</button>
    <button id="tabAdmin" onclick="switchTab('admin')" style="display: none;">🛠️</button>
  </nav>
<div class="container" id="loginContainer">
  <h2>🔐 Вход в систему</h2>
  <label for="login">Имя пользователя</label>
  <input type="text" id="login" placeholder="Введите имя" required>

  <label for="password">Пароль</label>
  <input type="password" id="password" placeholder="•••••••" required>

  <button id="loginBtn" onclick="handleLogin()">Войти</button>
  <div id="loginError"></div>
</div>
<div class="container" style="display:none;" id="tabContainer">
</div>
<div class="container" style="display:none;" id="appContainer">
  <style>
    .form-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .form-item {
      flex: 1 1 200px;
    }
    /* Удалено поведение column для мобилок */
  </style>

  <h2 id="mainTitle">📦 Учёт упаковки</h2>
  <form id="dataForm" style="padding-bottom: 100px;">
    <div class="tooltip" data-tooltip="Поле заполняется автоматически при входе">
      <label>Имя сотрудника:
        <input name="employeeName" required readonly />
      </label>
    </div>

    <div class="form-row">
      <div class="form-item">
        <label>Количество:
          <input name="quantity" type="number" required />
        </label>
      </div>
      <div class="form-item">
        <label>Номер заказа:
          <input name="orderNumber" required />
        </label>
      </div>
    </div>

    <div class="form-row">
      <div class="form-item">
        <label>Время начала:
          <input name="startTime" type="time" required />
        </label>
      </div>
      <div class="form-item">
        <label>Время окончания:
          <input name="endTime" type="time" required />
        </label>
      </div>
    </div>

    <label>Продолжительность:
      <input name="duration" readonly />
    </label>

    <div class="form-row" id="operationSetWrapper">
  <div class="form-item">
    <label>Операция:
      <select name="operationType" id="operationSelect" required></select>
    </label>
  </div>
  <div class="form-item" id="setNumberField" style="display:none;">
    <label>Артикул набора:
      <select name="setNumber"></select>
    </label>
  </div>
</div>

<div id="volumeLabel">
  <label>Объём:
    <select name="volume" id="volumeSelect" required></select>
  </label>
</div>

    <div id="rateInfo" style="margin-top:16px; background:#f0f0f0; padding:10px; border-radius:8px; display:none;">
      <p><strong>⏱ Норма в час:</strong> <span id="normDisplay">-</span></p>
      <p><strong>💰 Тариф за 1 шт:</strong> <span id="rateDisplay">-</span></p>
    </div>

    <div id="calcBlock" style="margin-top:16px; background:#e7f5ff; padding:10px; border-radius:8px; display:none;">
      <p><strong>💸 Расчёт оплаты:</strong> <span id="wageDisplay">-</span></p>
      <p><strong>⚙️ Эффективность:</strong> <span id="efficiencyDisplay">-</span></p>

    </div>

    <button type="submit">💾 Сохранить</button>
  </form>
  <p id="result" style="display:none;"></p>
</div>
<div class="container" style="display:none;" id="statsContainer">
  <h2>📈 Статистика</h2>
<button id="closeStatsBtn" onclick="closeStats()" style="margin-bottom: 10px;">❌ Закрыть статистику</button>
  <label>Выбрать дату:<input type="date" id="statsDate"></label>
  <div style="margin-top: 12px;">
  <label>Фильтр по операции:
    <select id="operationFilter">
      <option value="">-- Все операции --</option>
    </select>
  </label>
  <button id="showStatsBtn" onclick="loadStats()">📊 Показать статистику</button>
</div>
<div id="totalWage" style="text-align:center; font-weight:bold; margin-top:16px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding:16px; border-radius:12px; border:2px solid #0ea5e9; box-shadow: 0 4px 12px rgba(14, 165, 233, 0.2); font-size: 14px; line-height: 1.6; color: #000000 !important;"></div>
  <div id="statsCards"></div>
<div id="statsLogs" style="margin-top: 16px;"></div>
</div>
<div class="container" style="display:none;" id="profileContainer">
  <h2>👤 Личный профиль</h2>
  <label>Тип смены:
    <select id="shiftType">
      <option value="">-- Выберите смену --</option>
      <option>День</option>
      <option>Ночь</option>
    </select>
  </label>

  <!-- 🌙 БЛОК ДЛЯ НОЧНЫХ СМЕН -->
  <div id="nightShiftDateBlock" style="display:none;">
    <label>📅 Дата текущей ночной смены:
      <input type="date" id="nightShiftDate" style="font-size: 16px;" />
    </label>
    <small style="color:#6b7280; font-size:12px; margin-top:4px; display:block;">
      ℹ️ Укажите дату, к которой относится ваша ночная смена (обычно вчерашний день)
    </small>
    <div style="margin-top: 8px; display: flex; gap: 8px;">
      <button type="button" id="setYesterday" style="padding: 6px 12px; font-size: 12px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">📅 Вчера</button>
      <button type="button" id="setToday" style="padding: 6px 12px; font-size: 12px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer;">📅 Сегодня</button>
    </div>
  </div>

  <label>Статус сотрудника:
    <select id="employeeStatus" required onchange="handleStatusChange()">
      <option value="">-- Выберите --</option>
      <option value="Штат">👤 Штат</option>
      <option value="Аутсорсинг">🤝 Аутсорсинг</option>
      <option value="Стажер">👨‍🎓 Стажер</option>
    </select>
  </label>

  <!-- 👨‍🏫 БЛОК ДЛЯ НАСТАВНИКОВ (штатных сотрудников) -->
  <div id="mentorBlock" style="display:none;">
    <label>👨‍🎓 Мой стажер:
      <div style="padding: 8px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 4px; margin-top: 4px;">
        <span id="profileTraineeDisplay" style="color: #374151;">Не назначен</span>
        <span id="profileTraineeBonusDisplay" style="color: #6b7280; font-size: 12px; margin-left: 8px;"></span>
      </div>
      <small style="color: #6b7280; font-size: 12px; margin-top: 4px; display: block;">
        ℹ️ Для изменения связи обратитесь к администратору или используйте блок "Управление стажерами"
      </small>
    </label>
  </div>

  <!-- 👨‍🎓 БЛОК ДЛЯ СТАЖЕРОВ -->
  <div id="traineeBlock" style="display:none;">
    <label>👤 Мой наставник:
      <div style="padding: 8px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 4px; margin-top: 4px;">
        <span id="profileMentorDisplay" style="color: #374151;">Не назначен</span>
      </div>
      <small style="color: #6b7280; font-size: 12px; margin-top: 4px; display: block;">
        ℹ️ Для изменения связи обратитесь к администратору или используйте блок "Управление стажерами"
      </small>
    </label>
  </div>

<label>Тип оплаты:
  <select id="profilePayType" required>
    <option value="">-- Выберите --</option>
    <option value="Сделка">Сделка</option>
    <option value="Оклад + сделка">Оклад + сделка</option>
  </select>
</label>
<div id="salaryBlock" style="display:none;">
  <label>Оклад <span style="color:red;">*</span>:
    <input id="profileSalary" type="number" readonly />
  </label>
</div>
  <!-- ВСТАВЬ СЮДА: -->
  <label>Модель упаковки:
    <select id="profilePackingModel" name="profilePackingModel" required>
      <option value="">-- Выберите --</option>
      <!-- Опции будут подгружены из справочника -->
    </select>
  </label>

  <button id="saveProfileBtn" onclick="saveProfile()">💾 Сохранить</button>
  <p id="profileSaved" style="color:green; text-align:center; display:none;">✅ Сохранено</p>
      <p id="profileHint" style="color:#dc2626; font-size:14px; text-align:center; margin-top:12px;">
      ⚠️ Заполните все поля профиля (включая оклад для типа "Оклад + сделка") и нажмите кнопку «Сохранить», чтобы получить доступ к вкладкам системы.
    </p>
    <p id="profileUnsaved" style="color:#f59e0b; font-size:14px; text-align:center; margin-top:8px; display:none;">
      💾 Есть несохраненные изменения! Нажмите кнопку «Сохранить».
    </p>
  <button id="logoutBtn" onclick="handleLogout()" class="danger">🚪 Выйти</button>
</div>
<div class="container" style="display:none;" id="ratesContainer">
  <h2>💰 Тарифы и нормативы</h2>
  
  <!-- 🔍 ПОИСК И ФИЛЬТРЫ -->
  <div style="background: #f8fafc; padding: 16px; border-radius: 12px; margin: 16px 0; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
    <!-- Живой поиск -->
    <div style="margin-bottom: 12px;">
      <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #374151;">🔍 Поиск по операциям</label>
      <input type="text" id="ratesSearch" placeholder="Введите название операции..." 
             style="width: 100%; padding: 10px; font-size: 16px; border: 2px solid #e5e7eb; border-radius: 8px; transition: border-color 0.2s;">
    </div>
    
    <!-- Фильтры -->
    <div id="ratesFilters" style="display: flex; gap: 10px; flex-wrap: wrap;">
      <div style="flex: 1; min-width: 200px;">
        <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #374151;">🏷️ Операция</label>
        <select id="filterOperation" style="width: 100%; padding: 10px; font-size: 16px; border: 2px solid #e5e7eb; border-radius: 8px;">
      <option value="">-- Все операции --</option>
    </select>
      </div>
      <div style="flex: 1; min-width: 200px;">
        <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #374151;">📦 Объём/Артикул</label>
        <select id="filterKey" style="width: 100%; padding: 10px; font-size: 16px; border: 2px solid #e5e7eb; border-radius: 8px;">
      <option value="">-- Все объёмы / артикулы --</option>
    </select>
</div>
    </div>
    
    <!-- Индикатор найденных результатов -->
    <div id="ratesCounter" style="text-align: center; margin-top: 12px; font-weight: 600; color: #6b7280;"></div>
  </div>

  <!-- 📋 СПИСОК ТАРИФОВ -->
  <div id="ratesTableContainer" style="position: relative;">
    <!-- Индикатор загрузки -->
    <div id="ratesLoader" style="display: none; text-align: center; padding: 40px; color: #6b7280;">
      <div style="display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f4f6; border-top: 3px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite;"></div>
      <p style="margin-top: 10px;">Загрузка тарифов...</p>
    </div>
  <div id="ratesTable"></div>
  </div>
</div>
  <!-- Таблица будет добавлена через JS -->
</div>
<!-- 📦 Контейнер: Админ-панель -->
<div class="container" id="adminContainer" style="display:none;">
  <h2>🛠️ Админ-панель</h2>

<!-- 📅 Универсальный период -->
<div style="margin-bottom: 16px; display: flex; flex-wrap: wrap; gap: 10px;">
  <label style="flex:1 1 200px;">Период с:
    <input type="date" id="unifiedStart">
  </label>
  <label style="flex:1 1 200px;">по:
    <input type="date" id="unifiedEnd">
  </label>
</div>

  <!-- 🔘 Действия -->
<div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 16px;">
  <button onclick="loadShiftStats()">📊 Сводка по смене</button>
  <button onclick="analyzePackers()" id="analyzeBtn">🧮 Анализ штатных упаковщиков</button>
  <button onclick="openUpdateAllModal()" id="updateAllBtn" style="background:#8b5cf6;">🔄 Обновление блока данных показателей</button>
  <button onclick="runCustomReport()" id="reportBtn">📆 Отчёт показателей за период</button>
  <button onclick="loadSeniorsReport()" id="seniorsReportBtn" style="background:#8b5cf6;">👨‍💼 Анализ старших смен</button>
  <button onclick="showSeniorShiftForm()" id="addSeniorBtn" style="background:#22c55e;">➕ Добавить старшего смены</button>
  <button onclick="openSalaryExportModal()" id="salaryExportBtn" style="background:#10b981;">💵 Выгрузка зарплаты HR</button>
  <button onclick="loadNormativesAnalysis()" id="normativesBtn" style="background:#f59e0b;">🔍 Анализ нормативов</button>
</div>

<!-- 🧾 Единый контейнер для отчётов -->
<div id="reportContainer" style="margin-top: 20px;"></div>

<!-- 🔍 Блок анализа нормативов -->
<div id="normativesAnalysisContainer" style="margin-top: 20px; display: none;">
  <h3 style="text-align: center; color: #f59e0b; margin-bottom: 20px;">🔍 Анализ и корректировка нормативов</h3>
  
  <!-- Фильтры -->
  <div style="background: #f8fafc; padding: 16px; border-radius: 12px; margin-bottom: 20px;">
    <!-- Период на мобильных -->
    <div class="filters-mobile" style="display: none;">
      <div class="filters-row">
        <div>
          <label>📅 С:
            <input type="date" id="normativesStartDate" style="font-size: 16px; padding: 12px;">
          </label>
        </div>
        <div>
          <label>по:
            <input type="date" id="normativesEndDate" style="font-size: 16px; padding: 12px;">
          </label>
        </div>
      </div>
      
      <div>
        <label>🔍 Поиск:
          <input type="text" id="normativesSearch" placeholder="Операция или объем..." style="font-size: 16px; padding: 12px;">
        </label>
      </div>
      
      <div>
        <label>📊 Фильтр:
          <select id="normativesFilter" style="font-size: 16px; padding: 12px;">
            <option value="all">Все операции</option>
            <option value="problematic">Только проблемные</option>
            <option value="overstated">Завышенные нормы</option>
            <option value="understated">Заниженные нормы</option>
          </select>
        </label>
      </div>
      
      <div style="display: flex; gap: 8px;">
        <button onclick="runNormativesAnalysis()" id="runNormativesBtn" style="background: #f59e0b; flex: 1; padding: 14px; font-size: 16px;">📊 Анализ</button>
        <button onclick="hideNormativesAnalysis()" style="background: #6b7280; flex: 1; padding: 14px; font-size: 16px;">❌ Закрыть</button>
      </div>
    </div>
    
    <!-- Период на десктопе -->
    <div class="filters-desktop">
      <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 16px;">
        <div style="flex: 1; min-width: 200px;">
          <label>📅 Период анализа с:
            <input type="date" id="normativesStartDateDesktop">
          </label>
        </div>
        <div style="flex: 1; min-width: 200px;">
          <label>по:
            <input type="date" id="normativesEndDateDesktop">
          </label>
        </div>
      </div>
      
      <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 16px;">
        <div style="flex: 1; min-width: 200px;">
          <label>🔍 Поиск по операциям:
            <input type="text" id="normativesSearchDesktop" placeholder="Введите название операции...">
          </label>
        </div>
        <div style="flex: 1; min-width: 200px;">
          <label>📊 Тип проблем:
            <select id="normativesFilterDesktop">
              <option value="all">Все операции</option>
              <option value="problematic">Только проблемные</option>
              <option value="overstated">Завышенные нормы</option>
              <option value="understated">Заниженные нормы</option>
            </select>
          </label>
        </div>
      </div>
      
      <div style="text-align: center;">
        <button onclick="runNormativesAnalysis()" id="runNormativesBtnDesktop" style="background: #f59e0b; margin-right: 10px;">📊 Запустить анализ</button>
        <button onclick="hideNormativesAnalysis()" style="background: #6b7280;">❌ Закрыть</button>
      </div>
    </div>
  </div>
  
  <!-- Счетчики -->
  <div id="normativesSummary" style="display: none; background: #f0f9ff; padding: 16px; border-radius: 12px; margin-bottom: 20px; text-align: center;">
    <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 20px;">
      <div><strong>📊 Всего операций:</strong> <span id="totalNormatives">0</span></div>
      <div><strong>⚠️ Проблемных:</strong> <span id="problematicNormatives">0</span></div>
      <div><strong>🔴 Завышенных:</strong> <span id="overstatedNormatives">0</span></div>
      <div><strong>🟢 Заниженных:</strong> <span id="understatedNormatives">0</span></div>
    </div>
  </div>
  
  <!-- Таблица результатов -->
  <div id="normativesResults"></div>
  
  <!-- Загрузка -->
  <div id="normativesLoader" style="display: none; text-align: center; padding: 40px;">
    <div style="font-size: 24px;">⏳</div>
    <div style="margin-top: 10px;">Анализируем нормативы...</div>
  </div>
</div>


<!-- 📊 Результаты анализа -->
<div id="shiftStatsOutput" style="margin-top:20px;"></div>
<div id="packerAnalysis" style="margin-top:24px;"></div>

  <!-- 🚪 Кнопка выхода для администратора -->
  <div style="margin-top: 40px; text-align: center; border-top: 1px solid #e5e7eb; padding-top: 20px;">
    <button onclick="handleLogout()" class="danger" style="background-color: #dc2626; width: auto; padding: 12px 24px;">🚪 Выйти из системы</button>
  </div>
</div>

<!-- 🔍 Дубликаты — отдельный блок для управления дубликатами -->
<div class="container" style="display:none;" id="duplicatesContainer">
  <h2>🔍 Управление дубликатами</h2>
  <button onclick="switchTab('admin')" style="margin-bottom: 10px; background:#6b7280;">← Назад в админ-панель</button>
  
  <!-- Описание раздела -->
  <div style="background: #f0f9ff; padding: 16px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #0ea5e9;">
    <h3 style="margin: 0 0 12px 0; color: #0c4a6e;">ℹ️ О системе дедупликации</h3>
    <p style="margin: 0; color: #0c4a6e; font-size: 14px;">
      Этот раздел позволяет находить и удалять дублирующиеся записи в базе данных. 
      Дубликаты определяются по ключевым полям: сотрудник, количество, время, операция, заказ и артикул.
      Удаленные записи сохраняются в карантине для проверки.
    </p>
  </div>
  
  <!-- Действия -->
  <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 24px;">
    <button onclick="analyzeDuplicatesInTab()" id="analyzeDuplicatesTabBtn" style="background:#ff6b35; flex: 1; min-width: 200px;">
      🔍 Анализ дубликатов
    </button>
    <button onclick="runDeduplicateInTab()" id="runDeduplicateTabBtn" style="background:#dc2626; flex: 1; min-width: 200px;">
      🗑️ Удалить дубликаты
    </button>
  </div>
  
  <!-- Дополнительные функции -->
  <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 24px;">
    <button onclick="viewQuarantine()" id="viewQuarantineBtn" style="background:#8b5cf6; flex: 1; min-width: 200px;">
      📦 Просмотр карантина
    </button>
    <button onclick="viewDeduplicationLog()" id="viewLogBtn" style="background:#059669; flex: 1; min-width: 200px;">
      📋 Журнал дедупликации
    </button>
  </div>
  
  <!-- Результаты анализа -->
  <div id="duplicatesAnalysisResults" style="background: #fef2f2; padding: 16px; border-radius: 12px; margin-bottom: 20px; display: none;"></div>
  
  <!-- Результаты удаления -->
  <div id="deduplicationResults" style="background: #f0fdf4; padding: 16px; border-radius: 12px; margin-bottom: 20px; display: none;"></div>
  
  <!-- Просмотр карантина -->
  <div id="quarantineResults" style="background: #fef3c7; padding: 16px; border-radius: 12px; margin-bottom: 20px; display: none;"></div>
  
  <!-- Журнал дедупликации -->
  <div id="logResults" style="background: #f0f9ff; padding: 16px; border-radius: 12px; margin-bottom: 20px; display: none;"></div>
  
  <!-- Загрузка -->
  <div id="duplicatesLoader" style="display: none; text-align: center; padding: 40px;">
    <div style="font-size: 24px;">⏳</div>
    <div style="margin-top: 10px;">Обрабатываем запрос...</div>
  </div>
  
  <!-- Статистика -->
  <div id="duplicatesStats" style="background: #f8fafc; padding: 16px; border-radius: 12px; margin-top: 20px; display: none;">
    <h3 style="margin: 0 0 12px 0; color: #374151;">📊 Статистика системы</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
      <div style="text-align: center;">
        <div style="font-size: 24px; font-weight: bold; color: #3b82f6;" id="totalRecords">-</div>
        <div style="font-size: 12px; color: #6b7280;">Всего записей</div>
      </div>
      <div style="text-align: center;">
        <div style="font-size: 24px; font-weight: bold; color: #dc2626;" id="duplicatesFound">-</div>
        <div style="font-size: 12px; color: #6b7280;">Найдено дубликатов</div>
      </div>
      <div style="text-align: center;">
        <div style="font-size: 24px; font-weight: bold; color: #059669;" id="duplicatesRemoved">-</div>
        <div style="font-size: 12px; color: #6b7280;">Удалено дубликатов</div>
      </div>
      <div style="text-align: center;">
        <div style="font-size: 24px; font-weight: bold; color: #7c3aed;" id="quarantineCount">-</div>
        <div style="font-size: 12px; color: #6b7280;">В карантине</div>
      </div>
    </div>
  </div>
</div>

<!-- 💵 Моя зарплата — перемещён ВНЕ adminContainer -->
<div class="container" style="display:none;" id="mySalaryContainer">
  <h2>💵 Моя зарплата</h2>
  <button id="closeMySalaryBtn" onclick="closeMySalary()" style="margin-bottom: 10px; display: none;">❌ Закрыть мои результаты</button>
  <label>📅 Период с:
    <input type="date" id="salaryStart">
  </label>
  <label style="margin-left:10px;">по:
    <input type="date" id="salaryEnd">
  </label>
  <button id="mySalaryBtn" onclick="loadMySalary()">📊 Показать мои результаты</button>
  <div style="overflow-x: auto;">
  <div id="mySalaryOutput" style="margin-top:20px;"></div>
  </div>
<p id="totalQty" style="text-align:center; font-weight:bold; margin-top:16px;"></p>
</div>
<div class="container" style="display:none;" id="costAnalysisContainer">
  <h2>📊 Анализ себестоимости по объёмам</h2>
  <button onclick="switchTab('admin')" style="margin-bottom: 10px; background:#6b7280;">← Назад в админ-панель</button>
  
  <div class="form-row">
    <div class="form-item">
      <label>📅 Период с:
        <input type="date" id="costStartDate">
      </label>
    </div>
    <div class="form-item">
      <label>📅 по:
        <input type="date" id="costEndDate">
      </label>
    </div>
  </div>

  <div class="form-row">
    <button id="calculateCostBtn" onclick="calculateCostAnalysis()">🧮 Рассчитать себестоимость - ФОТ</button>
    <button id="calculateCostWithMaterialsBtn" onclick="calculateCostAnalysisWithMaterials()">🧮 Рассчитать себестоимость - ФОТ + Материалы</button>
  </div>
  
  <div class="form-row" style="margin-top: 12px;">
    <button id="calculateCostForSetsFotBtn" onclick="calculateCostAnalysisForSetsFotOnly()" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); width: 100%;">📦 Рассчитать себестоимость наборов - ФОТ</button>
  </div>
  
  <div class="form-row" style="margin-top: 8px;">
    <button id="calculateCostForSetsBtn" onclick="calculateCostAnalysisForSets()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); width: 100%;">📦 Рассчитать себестоимость наборов - ФОТ + Материалы</button>
  </div>

  <div class="form-row" style="margin-top: 16px;">
    <button onclick="saveReportToServer()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin-bottom: 8px;">💾 Выгрузить отчет себестоимости на сервер</button>
  </div>

  <div id="costResults" style="margin-top: 20px;"></div>
</div>
<script>
  const scriptURL = "https://script.google.com/macros/s/AKfycbwQY3igQM3uhSnXA8uKloUgcVY8IwZ6A7_L63HzaAKS093w1wZ2lBIV9AB_d8b_j_g/exec";
  
  // Проверяем URL при загрузке

  let todayRecords = [];
  let currentUser = "";
let currentShift = "";
let currentStatus = "";
 let allRates = [];
let allVolumes = []; // ← добавь это!
let currentUserRole = "user"; // ← добавляем сюда

// Кэш для ускорения загрузки данных
let dataCache = {
  operations: { data: null, timestamp: 0 },
  volumes: { data: null, timestamp: 0 },
  sets: { data: null, timestamp: 0 },
  setSizes: { data: null, timestamp: 0 }, // ✅ ДОБАВЛЕНО: кэш для размеров наборов
  rates: { data: null, timestamp: 0 },
  packingModels: { data: null, timestamp: 0 },
  salaries: {} // Кэш окладов по сотрудникам: { employee: { salary: value, timestamp: timestamp } }
};
const CACHE_DURATION = 5 * 60 * 1000; // 5 минут

// Флаги состояния загрузки для предотвращения дублирования
let isLoadingPackingModels = false;

// Функция очистки кэша
function clearCache() {
  Object.keys(dataCache).forEach(key => {
    if (key === 'salaries') {
      dataCache[key] = {}; // Для salaries используем пустой объект
    } else {
      dataCache[key] = { data: null, timestamp: 0 };
    }
  });
  
  // Очищаем также localStorage кэш
  try {
    localStorage.removeItem('packingModelsCache');
    localStorage.removeItem('salariesCache');
  } catch (e) {
    console.warn("Ошибка при очистке localStorage кэша:", e);
  }
  
  // Сбрасываем флаги загрузки
  isLoadingPackingModels = false;
}

// ===== УЛУЧШЕННАЯ СИСТЕМА ЗАЩИТЫ ОТ ДУБЛИКАТОВ =====
let duplicateWarnings = {
  exact: [],     // Точные дубликаты
  similar: [],   // Похожие записи  
  suspicious: [] // Подозрительные записи
};

  // 🗑️ Переменная lastFormState удалена - больше не нужна
let formChangeTimeout = null;

// 🗑️ УДАЛЕНА функция updatePayTypeBasedOnStatus - больше не нужна при ручном вводе

// === ФУНКЦИЯ: Управление доступными типами оплаты ===
function updatePayTypeOptions(employeeStatus) {
  const payTypeSelect = document.getElementById("profilePayType");
  if (!payTypeSelect) return;
  
  // Сохраняем текущее значение
  const currentValue = payTypeSelect.value;
  
  // Очищаем все опции
  payTypeSelect.innerHTML = '';
  
  // Добавляем базовую опцию
  const defaultOption = document.createElement('option');
  defaultOption.value = '';
  defaultOption.textContent = '-- Выберите --';
  payTypeSelect.appendChild(defaultOption);
  
  if (employeeStatus === "Аутсорсинг") {
    // Для аутсорсинга только "Сделка"
    const dealOption = document.createElement('option');
    dealOption.value = 'Сделка';
    dealOption.textContent = 'Сделка';
    payTypeSelect.appendChild(dealOption);
    
    // Автоматически выбираем "Сделка"
    payTypeSelect.value = 'Сделка';
  } else if (employeeStatus === "Штат") {
    // Для штата доступны обе опции
    const dealOption = document.createElement('option');
    dealOption.value = 'Сделка';
    dealOption.textContent = 'Сделка';
    payTypeSelect.appendChild(dealOption);
    
    const salaryOption = document.createElement('option');
    salaryOption.value = 'Оклад + сделка';
    salaryOption.textContent = 'Оклад + сделка';
    payTypeSelect.appendChild(salaryOption);
    
    // Автоматически выбираем "Оклад + сделка"
    payTypeSelect.value = 'Оклад + сделка';
  } else {
    // Если статус не выбран, показываем все опции
    const dealOption = document.createElement('option');
    dealOption.value = 'Сделка';
    dealOption.textContent = 'Сделка';
    payTypeSelect.appendChild(dealOption);
    
    const salaryOption = document.createElement('option');
    salaryOption.value = 'Оклад + сделка';
    salaryOption.textContent = 'Оклад + сделка';
    payTypeSelect.appendChild(salaryOption);
  }
}

// === ФУНКЦИЯ: Активация кнопки сохранения при изменениях ===
function activateSaveButton() {
  
  const saveBtn = document.getElementById("saveProfileBtn");
  if (saveBtn && saveBtn.disabled) {
    saveBtn.disabled = false;
    saveBtn.textContent = "💾 Сохранить";
    saveBtn.style.opacity = "1";
    saveBtn.style.cursor = "pointer";
    saveBtn.classList.add("save-button-pulse"); // Добавляем анимацию
    
    // Скрываем сообщение о сохранении
    const msg = document.getElementById("profileSaved");
    if (msg) msg.style.display = "none";
    
    // Показываем предупреждение о несохраненных изменениях
    const unsavedMsg = document.getElementById("profileUnsaved");
    if (unsavedMsg) unsavedMsg.style.display = "block";
    

    
  } else {

  }
}

// === ФУНКЦИЯ: Установка слушателя для profilePayType ===
function setupPayTypeListener() {
  const payTypeSelect = document.getElementById("profilePayType");
  if (!payTypeSelect) return;
  
  payTypeSelect.addEventListener("change", async function() {
    
    const salaryBlock = document.getElementById("salaryBlock");
    const salaryInput = document.getElementById("profileSalary");
    
    activateSaveButton();
    
    if (this.value === "Оклад + сделка") {
      salaryBlock.style.display = "block";
      
      // Мгновенно заполняем из кэша если есть
      smartFillSalaryField();
      
      // Подгружаем оклад с сервера для актуальности
      const currentUser = localStorage.getItem("currentUser") || "";
      
      if (!currentUser) {
        salaryInput.value = "";
        return;
      }
      
      try {        
        // 🌙 Используем новую функцию с учетом типа смены
        const shiftType = document.getElementById("shiftType").value;
        if (shiftType) {
          const salary = await fetchSalaryByShift(currentUser, shiftType);
          salaryInput.value = salary || "";
        } else {
          // Fallback к старой функции если смена не выбрана
          const salary = await getSalaryWithCache(currentUser);
          salaryInput.value = salary || "";
        }
      } catch (err) {
        salaryInput.value = "";
      }
          } else {
        salaryBlock.style.display = "none";
        salaryInput.value = "";
      }
  });
}

// === ЛОГИКА: Инициализация слушателя для profilePayType ===
setupPayTypeListener();

// === ЛОГИКА: Активация кнопки сохранения при изменении модели упаковки ===
document.getElementById("profilePackingModel").addEventListener("change", function() {
  activateSaveButton();
  
  // Также обновляем отображение тарифа (существующая логика)
  updateRateDisplay();
});

// === ЛОГИКА: Активация кнопки сохранения при изменении смены ===
document.getElementById("shiftType").addEventListener("change", function() {
  const nightShiftBlock = document.getElementById("nightShiftDateBlock");
  const nightShiftInput = document.getElementById("nightShiftDate");
  
  if (this.value === "Ночь") {
    nightShiftBlock.style.display = "block";
    
    // Автоматически предлагаем вчерашний день если поле пустое
    if (!nightShiftInput.value) {
      const yesterday = new Date();
      yesterday.setDate(yesterday.getDate() - 1);
      nightShiftInput.value = yesterday.toISOString().split('T')[0];
    }
  } else {
    nightShiftBlock.style.display = "none";
    nightShiftInput.value = "";
  }
  
  // 🌙 Обновляем оклад при изменении типа смены
  updateSalaryForShift(this.value);
  
  activateSaveButton();
});

// === ЛОГИКА: Кнопки быстрого выбора даты ===
document.getElementById("setYesterday").addEventListener("click", function() {
  const yesterday = new Date();
  yesterday.setDate(yesterday.getDate() - 1);
  document.getElementById("nightShiftDate").value = yesterday.toISOString().split('T')[0];
  activateSaveButton();
});

document.getElementById("setToday").addEventListener("click", function() {
  const today = new Date();
  document.getElementById("nightShiftDate").value = today.toISOString().split('T')[0];
  activateSaveButton();
});

// === ЛОГИКА: Активация кнопки сохранения при изменении даты ночной смены ===
document.getElementById("nightShiftDate").addEventListener("change", function() {
  activateSaveButton();
});

// === ЛОГИКА: Активация кнопки сохранения при изменении статуса ===
document.getElementById("employeeStatus").addEventListener("change", function() {
  activateSaveButton();
  
  // Обновляем доступные опции типа оплаты
  updatePayTypeOptions(this.value);
  
  // Обрабатываем блок оклада в зависимости от выбранного типа оплаты
  if (this.value === "Аутсорсинг") {
    // Скрываем блок оклада для аутсорсинга
    document.getElementById("salaryBlock").style.display = "none";
    document.getElementById("profileSalary").value = "";
  } else if (this.value === "Штат") {
    // Показываем блок оклада для штатных и загружаем оклад
    document.getElementById("salaryBlock").style.display = "block";
    
    // Мгновенно заполняем из кэша если есть
    smartFillSalaryField();
    
    // Автоматически загружаем оклад с сервера для актуальности с учетом смены
    const currentUser = localStorage.getItem("currentUser") || "";
    if (currentUser) {
      // 🌙 Используем новую функцию с учетом типа смены
      const shiftType = document.getElementById("shiftType").value;
      if (shiftType) {
        fetchSalaryByShift(currentUser, shiftType)
          .then(salary => {
            document.getElementById("profileSalary").value = salary || "";
          })
          .catch(() => {
            document.getElementById("profileSalary").value = "";
          });
      } else {
        // Fallback к старой функции если смена не выбрана
        getSalaryWithCache(currentUser)
          .then(salary => {
            document.getElementById("profileSalary").value = salary || "";
          })
          .catch(() => {
            document.getElementById("profileSalary").value = "";
          });
      }
    }
  }
  
  // Активируем кнопку сохранения еще раз, так как изменился тип оплаты
  activateSaveButton();
  
  // Управляем отображением вкладки "Моя зарплата"
  const tabMySalary = document.getElementById("tabMySalary");
  if (tabMySalary) {
    tabMySalary.style.display = (this.value === "Аутсорсинг") ? "none" : "inline-block";
  }
});



function isProfileComplete() {
  const packingModel = document.getElementById("profilePackingModel").value;
  const payType = document.getElementById("profilePayType").value;
  
  // ✅ ПОЛНАЯ ПРОВЕРКА: включая оклад для типа "Оклад + сделка"
  let isComplete = currentShift && currentStatus && packingModel && payType;
  
  if (payType === "Оклад + сделка") {
    const salary = document.getElementById("profileSalary").value;
    isComplete = isComplete && salary && salary.trim() !== "";
  }
  
  return isComplete;
}

// 🗑️ УДАЛЕНА функция restoreProfile - больше не нужна при ручном вводе

function requireProfile() {
  if (!isProfileComplete()) {
    alert("⚠️ Сначала заполните профиль и нажмите «Сохранить»");
    switchTab("profile");
    return false;
  }
  return true;
}

// === 👨‍🏫 ФУНКЦИИ НАСТАВНИЧЕСТВА ===

// Обработчик изменения статуса сотрудника  
function handleStatusChange() {
  const status = document.getElementById("employeeStatus").value;
  const mentorBlock = document.getElementById("mentorBlock");
  const traineeBlock = document.getElementById("traineeBlock");
  
  // Скрываем все блоки
  mentorBlock.style.display = "none";
  traineeBlock.style.display = "none";
  
  if (status === "Штат") {
    mentorBlock.style.display = "block";
    loadCurrentTraineeInfo(); // Загружаем информацию о текущем стажере
  } else if (status === "Стажер") {
    traineeBlock.style.display = "block";
    loadCurrentMentorInfo(); // Загружаем информацию о текущем наставнике
  } else if (status === "Аутсорсинг") {
    // 🌙 Для аутсорсеров запускаем специальную настройку профиля
    // Только если это ручное изменение, а не автоматическое при входе
    if (currentStatus !== "Аутсорсинг") {
      setupOutsourcingProfile();
    }
  } else {
    // 🌙 Если выбран другой статус, очищаем настройки аутсорсера
    clearOutsourcingSettings();
  }
}

// Загрузка информации о текущем стажере для наставников (только для отображения)
async function loadCurrentTraineeInfo() {
  try {
    const currentUser = localStorage.getItem("currentUser");
    if (!currentUser) return;
    
    // Получаем данные пользователя
    const userData = await getUserDataFromServer(currentUser);
    
    const traineeDisplay = document.getElementById("profileTraineeDisplay");
    const traineeBonusDisplay = document.getElementById("profileTraineeBonusDisplay");
    
    if (!traineeDisplay || !traineeBonusDisplay) return;
    
    if (userData && userData.mentor) {
      // Если у наставника есть стажер, отображаем информацию
      traineeDisplay.textContent = userData.mentor;
      if (userData.bonusPercent) {
        traineeBonusDisplay.textContent = `(${userData.bonusPercent}% бонус)`;
      } else {
        traineeBonusDisplay.textContent = "";
      }
    } else {
      // Если стажера нет
      traineeDisplay.textContent = "Не назначен";
      traineeBonusDisplay.textContent = "";
    }
    
  } catch (error) {
    console.error("Ошибка загрузки информации о стажере:", error);
    const traineeDisplay = document.getElementById("profileTraineeDisplay");
    if (traineeDisplay) {
      traineeDisplay.textContent = "Ошибка загрузки";
    }
  }
}

// Загрузка информации о текущем наставнике для стажеров (только для отображения)
async function loadCurrentMentorInfo() {
  try {
    const currentUser = localStorage.getItem("currentUser");
    if (!currentUser) return;
    
    // Получаем данные пользователя
    const userData = await getUserDataFromServer(currentUser);
    
    const mentorDisplay = document.getElementById("profileMentorDisplay");
    
    if (!mentorDisplay) return;
    
    if (userData && userData.mentor) {
      // Если у стажера есть наставник, отображаем информацию
      mentorDisplay.textContent = userData.mentor;
    } else {
      // Если наставника нет
      mentorDisplay.textContent = "Не назначен";
    }
    
  } catch (error) {
    console.error("Ошибка загрузки информации о наставнике:", error);
    const mentorDisplay = document.getElementById("profileMentorDisplay");
    if (mentorDisplay) {
      mentorDisplay.textContent = "Ошибка загрузки";
    }
  }
}

// Функция savePairToServer удалена - связи больше не редактируются через профиль
// Все управление связями происходит через блок "Управление стажерами"

// Кэш для данных пользователей
let userDataCache = null;
let userDataCacheTimestamp = 0;
const USER_DATA_CACHE_DURATION = 30 * 1000; // 30 секунд

// Автоматическое обновление данных профиля с сервера (оптимизированная версия)
async function updateProfileFromServer() {
  const currentUser = localStorage.getItem("currentUser");
  if (!currentUser) return;
  
  try {
    // Получаем данные пользователя (с кэшированием)
    const userData = await getUserDataFromServer(currentUser);
    
    if (userData) {
      // Обновляем статус сотрудника
      const statusSelect = document.getElementById("employeeStatus");
      if (statusSelect && userData.status) {
        statusSelect.value = userData.status;
        
        // Вызываем обработчик изменения статуса для обновления блоков
        handleStatusChange();
        
        // 🌙 Проверяем является ли пользователь аутсорсером
        if (userData.status === "Аутсорсинг") {
          setupOutsourcingProfile();
        } else {
          clearOutsourcingSettings(); // Очищаем если больше не аутсорсер
        }
        
        // Быстрое обновление отображения связей без дополнительных запросов
        await updateProfileConnectionsDisplay(userData);
      }
      
      console.log("✅ Профиль автоматически обновлен с сервера");
    } else {
      // Если пользователь не найден, очищаем все связи
      clearProfileConnections();
    }
  } catch (error) {
    console.error("Ошибка обновления профиля с сервера:", error);
  }
}

// Получение данных пользователя с кэшированием
async function getUserDataFromServer(currentUser) {
  // Проверяем кэш
  if (userDataCache && (Date.now() - userDataCacheTimestamp) < USER_DATA_CACHE_DURATION) {
    return userDataCache.find(emp => emp.name === currentUser);
  }
  
  // Загружаем свежие данные
  const response = await fetch(`${scriptURL}?type=employees`);
  const data = await response.json();
  
  if (data.employees) {
    // Обновляем кэш
    userDataCache = data.employees;
    userDataCacheTimestamp = Date.now();
    
    return data.employees.find(emp => emp.name === currentUser);
  }
  
  return null;
}

// Быстрое обновление отображения связей с новыми данными
async function updateProfileConnectionsDisplay(userData) {
  if (!userData) return;
  
  if (userData.status === "Штат") {
    updateTraineeDisplay(userData.mentor, userData.bonusPercent);
  } else if (userData.status === "Стажер") {
            updateMentorDisplay(userData.mentor);
  }
}

// Обновление отображения стажера
function updateTraineeDisplay(traineeName, bonusPercent) {
  const traineeDisplay = document.getElementById("profileTraineeDisplay");
  const traineeBonusDisplay = document.getElementById("profileTraineeBonusDisplay");
  
  if (!traineeDisplay || !traineeBonusDisplay) return;
  
  if (traineeName) {
    traineeDisplay.textContent = traineeName;
    if (bonusPercent) {
      traineeBonusDisplay.textContent = `(${bonusPercent}% бонус)`;
    } else {
      traineeBonusDisplay.textContent = "";
    }
  } else {
    traineeDisplay.textContent = "Не назначен";
    traineeBonusDisplay.textContent = "";
  }
}

// Обновление отображения наставника
function updateMentorDisplay(mentorName) {
  const mentorDisplay = document.getElementById("profileMentorDisplay");
  
  if (!mentorDisplay) return;
  
  if (mentorName) {
    mentorDisplay.textContent = mentorName;
  } else {
    mentorDisplay.textContent = "Не назначен";
  }
}

// Кэшированные списки
let traineesCache = null;
let mentorsCache = null;
let traineesCacheTimestamp = 0;
let mentorsCacheTimestamp = 0;
const LIST_CACHE_DURATION = 60 * 1000; // 1 минута

// 🌙 Функция загрузки сохраненного профиля
function loadSavedProfile() {
  const savedShift = localStorage.getItem("profileShiftType");
  const savedNightDate = localStorage.getItem("profileNightShiftDate");
  
  if (savedShift) {
    document.getElementById("shiftType").value = savedShift;
    
    if (savedShift === "Ночь") {
      document.getElementById("nightShiftDateBlock").style.display = "block";
      if (savedNightDate) {
        document.getElementById("nightShiftDate").value = savedNightDate;
      } else {
        // Если нет сохраненной даты, предлагаем вчерашний день
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        document.getElementById("nightShiftDate").value = yesterday.toISOString().split('T')[0];
      }
    }
  }
}

// Получение списка стажеров с кэшированием
async function getTraineesListCached() {
  if (traineesCache && (Date.now() - traineesCacheTimestamp) < LIST_CACHE_DURATION) {
    return traineesCache;
  }
  
  try {
    const response = await fetch(`${scriptURL}?type=getTrainees`);
    const data = await response.json();
    
    traineesCache = data.trainees || [];
    traineesCacheTimestamp = Date.now();
    
    return traineesCache;
  } catch (error) {
    console.error("Ошибка загрузки стажеров:", error);
    return [];
  }
}

// Получение списка наставников с кэшированием
async function getMentorsListCached() {
  if (mentorsCache && (Date.now() - mentorsCacheTimestamp) < LIST_CACHE_DURATION) {
    return mentorsCache;
  }
  
  try {
    const response = await fetch(`${scriptURL}?type=getMentors`);
    const data = await response.json();
    
    mentorsCache = data.mentors || [];
    mentorsCacheTimestamp = Date.now();
    
    return mentorsCache;
  } catch (error) {
    console.error("Ошибка загрузки наставников:", error);
    return [];
  }
}

// Очистка связей профиля
function clearProfileConnections() {
  // Очищаем отображение связей
  const traineeDisplay = document.getElementById("profileTraineeDisplay");
  const traineeBonusDisplay = document.getElementById("profileTraineeBonusDisplay");
  const mentorDisplay = document.getElementById("profileMentorDisplay");
  
  if (traineeDisplay) traineeDisplay.textContent = "Не назначен";
  if (traineeBonusDisplay) traineeBonusDisplay.textContent = "";
  if (mentorDisplay) mentorDisplay.textContent = "Не назначен";
}


async function saveProfile() {
  const shiftSelect = document.getElementById("shiftType");
  const statusSelect = document.getElementById("employeeStatus");
  const packingModelSelect = document.getElementById("profilePackingModel");
  const payTypeSelect = document.getElementById("profilePayType");
  const salaryInput = document.getElementById("profileSalary");

  const shiftValue = shiftSelect.value;
  const statusValue = statusSelect.value;
  const packingModel = packingModelSelect.value;
  const payType = payTypeSelect.value;

  // ✅ ВАЛИДАЦИЯ: Проверяем что все основные поля заполнены
  const missingFields = [];
  if (!shiftValue) missingFields.push("Тип смены");
  if (!statusValue) missingFields.push("Статус сотрудника");
  if (!packingModel) missingFields.push("Модель упаковки");
  if (!payType) missingFields.push("Тип оплаты");

  if (missingFields.length > 0) {
    const fieldsList = missingFields.join(", ");
    alert(`❌ Заполните обязательные поля:\n\n${fieldsList}`);
    return;
  }

  localStorage.setItem("profileShiftType", shiftValue);
  localStorage.setItem("profileStatus", statusValue);
  localStorage.setItem("profilePackingModel", packingModel);
  localStorage.setItem("profilePayType", payType);

  // 🌙 Сохранение даты ночной смены
  const nightShiftDate = document.getElementById("nightShiftDate").value;
  if (shiftValue === "Ночь") {
    if (!nightShiftDate) {
      alert("❌ Для ночной смены необходимо указать дату смены!");
      return;
    }
    localStorage.setItem("profileNightShiftDate", nightShiftDate);
  } else {
    localStorage.removeItem("profileNightShiftDate");
  }

  // Если выбран "Оклад + сделка", подтягиваем оклад с сервера с учетом смены
  let salary = "";
  if (payType === "Оклад + сделка") {
    try {
      const currentUser = localStorage.getItem("currentUser") || "";
      // 🌙 Используем новую функцию с учетом типа смены
      salary = await fetchSalaryByShift(currentUser, shiftValue) || "";
    } catch (err) {
      salary = "";
    }
    salaryInput.value = salary;
    
    if (!salary || salary.trim() === "") {
      alert(`❌ Не удалось загрузить оклад с сервера!\n\nПроверьте:\n• Правильность имени пользователя\n• Наличие оклада для выбранной смены в базе данных\n• Подключение к интернету`);
      return;
    }
    
    localStorage.setItem("profileSalary", salary);
    document.getElementById("salaryBlock").style.display = "block";
  } else {
    salaryInput.value = "";
    localStorage.removeItem("profileSalary");
    document.getElementById("salaryBlock").style.display = "none";
  }

  // Проверка заполненности профиля (только для обычных пользователей)
  if (currentUserRole !== "admin") {
    let isFilled = shiftValue && statusValue && packingModel && payType;
    if (payType === "Оклад + сделка") {
      const currentSalary = salaryInput.value;
      isFilled = isFilled && currentSalary && currentSalary.trim() !== "";
    }
    const hint = document.getElementById("profileHint");
    const msg = document.getElementById("profileSaved");
    const tabApp = document.getElementById("tabApp");
    const tabMySalary = document.getElementById("tabMySalary");
    const saveBtn = document.getElementById("saveProfileBtn");

    hint.style.display = isFilled ? "none" : "block";
    
    // Показываем сообщение о сохранении только если профиль заполнен
    if (isFilled) {
      msg.style.display = "block";
      msg.textContent = "✅ Профиль сохранен! Доступ к вкладкам открыт.";
      // Автоскрытие уведомления через 3 секунды
      setTimeout(() => msg.style.display = "none", 3000);

      // Связи наставничества больше не сохраняются через профиль
      // Управление связями происходит через блок "Управление стажерами"
      
      // Скрываем предупреждение о несохраненных изменениях
      const unsavedMsg = document.getElementById("profileUnsaved");
      if (unsavedMsg) unsavedMsg.style.display = "none";
      
      if (saveBtn) {
        saveBtn.disabled = true;
        saveBtn.textContent = "✅ Профиль сохранен";
        saveBtn.style.opacity = "0.6";
        saveBtn.style.cursor = "not-allowed";
        saveBtn.classList.remove("save-button-pulse");
      }
        } else {
      msg.style.display = "none";
      
      if (saveBtn) {
        saveBtn.disabled = false;
        saveBtn.textContent = "💾 Сохранить";
        saveBtn.style.opacity = "1";
        saveBtn.style.cursor = "pointer";
      }
    }
    
    tabApp.disabled = !isFilled;
    tabApp.innerHTML = isFilled ? "📋" : "🔒";

    // Скрываем вкладку "Моя зарплата", если сотрудник аутсорс
    if (tabMySalary) {
      tabMySalary.style.display = (statusValue === "Аутсорсинг") ? "none" : "inline-block";
    }
  }

  // Обновляем переменные для проверки профиля
  currentShift = shiftValue;
  currentStatus = statusValue;
}



function switchTab(tabName) {
  // Для администратора: разрешаем админ-панель, анализ себестоимости, управление стажерами и дубликаты
  if (currentUserRole === "admin" && tabName !== "admin" && tabName !== "costAnalysis" && tabName !== "traineeManagement" && tabName !== "duplicates") {
    return; // Не позволяем админу переключаться на другие вкладки
  }
  
  // 🔐 Блокировка доступа к админ-функциям для обычных пользователей
  if (currentUserRole !== "admin" && (tabName === "admin" || tabName === "costAnalysis" || tabName === "traineeManagement" || tabName === "duplicates")) {
    console.log("❌ Доступ запрещен: требуется роль администратора");
    return;
  }
  
  // 🔐 Блокировка, если профиль не заполнен (только для обычных пользователей)
  if (currentUserRole !== "admin" && tabName !== "profile" && !requireProfile()) return;

  // Скрываем все контейнеры
  document.getElementById("profileContainer").style.display = "none";
  document.getElementById("appContainer").style.display = "none";
  document.getElementById("statsContainer").style.display = "none";
  document.getElementById("adminContainer").style.display = "none";
  document.getElementById("mySalaryContainer").style.display = "none";
  document.getElementById("ratesContainer").style.display = "none";
  document.getElementById("costAnalysisContainer").style.display = "none";
  document.getElementById("traineeManagementContainer").style.display = "none";
  document.getElementById("duplicatesContainer").style.display = "none";

  // Удаляем fullscreen от appContainer, если был ранее
  document.getElementById("appContainer").classList.remove("fullscreen");

  // Деактивируем все вкладки
  const tabButtons = ["tabProfile", "tabApp", "tabStats", "tabCostAnalysis", "tabTraineeManagement", "tabRates", "tabMySalary", "tabDuplicates", "tabAdmin"];
  tabButtons.forEach(id => {
    const btn = document.getElementById(id);
    if (btn) btn.disabled = false;
  });

  // Активируем нужную вкладку
  switch (tabName) {
    case "profile":
      document.getElementById("profileContainer").style.display = "block";
      document.getElementById("tabProfile").disabled = true;
      break;

    case "app":
      document.getElementById("appContainer").style.display = "block";
      document.getElementById("tabApp").disabled = true;
      break;

    case "stats":
      document.getElementById("statsContainer").style.display = "block";
      document.getElementById("tabStats").disabled = true;
      
      // Устанавливаем сегодняшнюю дату по умолчанию (без автозагрузки)
      const statsDate = document.getElementById("statsDate");
      if (!statsDate.value) {
        const today = new Date().toISOString().split('T')[0];
        statsDate.value = today;
      }
      break;

    case "costAnalysis":
      document.getElementById("costAnalysisContainer").style.display = "block";
      document.getElementById("tabCostAnalysis").disabled = true;
      initializeCostAnalysis();
      break;

    case "traineeManagement":
      showTraineeManagement();
      document.getElementById("tabTraineeManagement").disabled = true;
      break;

    case "rates":
      document.getElementById("ratesContainer").style.display = "block";
      document.getElementById("tabRates").disabled = true;
      break;

    case "mySalary":
      document.getElementById("mySalaryContainer").style.display = "block";
      document.getElementById("tabMySalary").disabled = true;
      break;

    case "admin":
      document.getElementById("adminContainer").style.display = "block";
      document.getElementById("tabAdmin").disabled = true;
      break;

    case "duplicates":
      document.getElementById("duplicatesContainer").style.display = "block";
      document.getElementById("tabDuplicates").disabled = true;
      // Загружаем статистику при открытии вкладки
      loadDuplicatesStats();
      break;
  }
}





async function handleLogin() {


  const login = document.getElementById("login").value.trim();
  const password = document.getElementById("password").value.trim();
  const errorElem = document.getElementById("loginError");
  const loginBtn = document.getElementById("loginBtn");
  
  // Блокируем кнопку и показываем загрузку
  loginBtn.disabled = true;
  loginBtn.classList.add("loading");
  loginBtn.textContent = "⏳ Вхожу...";
  errorElem.textContent = "";

  try {
    const res = await fetch(`${scriptURL}?type=auth&login=${encodeURIComponent(login)}&password=${encodeURIComponent(password)}`);
    const data = await res.json();

    if (data.status === "ok") {
      currentUser = login;
      currentUserRole = data.role || 'user';
      currentStatus = data.employeeStatus || 'Штат'; // Получаем статус с сервера

      localStorage.setItem("currentUser", login);
      localStorage.setItem("currentUserRole", currentUserRole);
      
      // 🌙 Автоматическая настройка профиля для аутсорсеров
      if (currentStatus === "Аутсорсинг") {
        setupOutsourcingProfile();
      }
      
              // 🗑️ УДАЛЕНО сохранение данных с сервера - только ручной ввод

      // Показываем админ-вкладку при необходимости (будет точно настроено ниже)
      const tabAdmin = document.getElementById("tabAdmin");
      // Временно используем старую логику, окончательная настройка произойдет ниже

      // Обновляем интерфейс: ПЕРЕД асинхронной загрузкой
      document.getElementById("loginContainer").style.display = "none";
      document.getElementById("tabContainer").style.display = "block";
      document.querySelector('[name="employeeName"]').value = currentUser;
      
      // Автоматически обновляем профиль с сервера при входе
      setTimeout(() => {
        updateProfileFromServer();
      }, 1000); // Небольшая задержка для стабилизации интерфейса
      
      // Для администратора: скрываем все вкладки кроме админ-панели и анализа себестоимости
      if (currentUserRole === "admin") {
        // Скрываем все навигационные кнопки кроме админ-панели и анализа себестоимости
        const tabButtons = ["tabProfile", "tabApp", "tabStats", "tabRates", "tabMySalary"];
        tabButtons.forEach(id => {
          const btn = document.getElementById(id);
          if (btn) {
            btn.classList.add("admin-hidden");
            btn.classList.remove("admin-visible");
          }
        });
        
        // Показываем кнопку анализа себестоимости для администраторов
        const tabCostAnalysis = document.getElementById("tabCostAnalysis");
        if (tabCostAnalysis) {
          tabCostAnalysis.classList.add("admin-visible");
          tabCostAnalysis.classList.remove("admin-hidden");
          // 🛡️ ДОПОЛНИТЕЛЬНАЯ ЗАЩИТА: Принудительно сбрасываем style.display
          tabCostAnalysis.style.display = "";
        }
        
        // Показываем кнопку управления стажерами для администраторов
        const tabTraineeManagement = document.getElementById("tabTraineeManagement");
        if (tabTraineeManagement) {
          tabTraineeManagement.classList.add("admin-visible");
          tabTraineeManagement.classList.remove("admin-hidden");
          // 🛡️ ДОПОЛНИТЕЛЬНАЯ ЗАЩИТА: Принудительно сбрасываем style.display
          tabTraineeManagement.style.display = "";
        }
        
        // Показываем кнопку дубликатов для администраторов
        const tabDuplicates = document.getElementById("tabDuplicates");
        if (tabDuplicates) {
          tabDuplicates.classList.add("admin-visible");
          tabDuplicates.classList.remove("admin-hidden");
          // 🛡️ ДОПОЛНИТЕЛЬНАЯ ЗАЩИТА: Принудительно сбрасываем style.display
          tabDuplicates.style.display = "";
        }
        
        // Показываем админ-кнопку
        const tabAdmin = document.getElementById("tabAdmin");
        if (tabAdmin) {
          tabAdmin.classList.add("admin-visible");
          tabAdmin.classList.remove("admin-hidden");
          // 🛡️ ДОПОЛНИТЕЛЬНАЯ ЗАЩИТА: Принудительно сбрасываем style.display
          tabAdmin.style.display = "";
        }
        
        document.getElementById("bottomNav").style.display = "flex";
        switchTab("admin"); // Открываем сразу админ-панель
      } else {
        // Для обычных пользователей - обычная логика
        document.getElementById("bottomNav").style.display = "flex";
        
        // Восстанавливаем видимость обычных кнопок
        const normalTabButtons = ["tabProfile", "tabApp", "tabStats", "tabRates", "tabMySalary"];
        normalTabButtons.forEach(id => {
          const btn = document.getElementById(id);
          if (btn) {
            btn.classList.remove("admin-hidden");
            btn.classList.remove("admin-visible");
            // Возвращаем стандартные стили
            btn.style.display = "";
            btn.style.visibility = "";
            btn.style.width = "";
            btn.style.padding = "";
            btn.style.margin = "";
          }
        });
        
        // 🔐 Скрываем админ-вкладки от обычных пользователей
        const adminTabButtons = ["tabCostAnalysis", "tabTraineeManagement", "tabDuplicates", "tabAdmin"];
        adminTabButtons.forEach(id => {
          const btn = document.getElementById(id);
          if (btn) {
            btn.classList.add("admin-hidden");
            btn.classList.remove("admin-visible");
            // 🛡️ ДОПОЛНИТЕЛЬНАЯ ЗАЩИТА: Принудительно скрываем через style
            btn.style.display = "none";
          }
        });
        
        // 🛠️ ОЧИСТКА всех полей профиля для обеспечения ручного ввода
        document.getElementById("shiftType").value = "";
        document.getElementById("employeeStatus").value = "";
        document.getElementById("profilePackingModel").value = "";
        document.getElementById("profilePayType").value = "";
        document.getElementById("profileSalary").value = "";
        document.getElementById("nightShiftDate").value = "";
        document.getElementById("nightShiftDateBlock").style.display = "none";
        document.getElementById("salaryBlock").style.display = "none";
        
        // Восстанавливаем все опции типа оплаты
        updatePayTypeOptions("");
        
        // 🚀 Предзагружаем оклад для текущего пользователя
        preloadCurrentUserSalary();
        
        // 🛠️ Активируем кнопку сохранения и показываем подсказку
        const saveBtn = document.getElementById("saveProfileBtn");
        const hint = document.getElementById("profileHint");
        const msg = document.getElementById("profileSaved");
        const unsavedMsg = document.getElementById("profileUnsaved");
        
        if (saveBtn) {
          saveBtn.disabled = false;
          saveBtn.textContent = "💾 Сохранить";
          saveBtn.style.opacity = "1";
          saveBtn.style.cursor = "pointer";
          saveBtn.classList.remove("save-button-pulse");
        }
        if (hint) hint.style.display = "block";
        if (msg) msg.style.display = "none";
        if (unsavedMsg) unsavedMsg.style.display = "none";
        
        switchTab("profile"); // ✅ Мгновенно открываем профиль
        
        // 👨‍🏫 Инициализируем блоки наставничества (после очистки полей)
        setTimeout(() => {
          // Устанавливаем статус из данных сервера если есть
          if (currentStatus) {
            document.getElementById("employeeStatus").value = currentStatus;
            handleStatusChange(); // Показываем соответствующий блок
          }
          
          // 🌙 Загружаем сохраненные данные профиля
          loadSavedProfile();
        }, 100);
        
        // 🔄 Быстрая загрузка справочников (с кэшированием)
        await Promise.all([
          loadOperations(),
          loadSetNumbers(),
          loadTodayRecords()
        ]);
        
        // 🛡️ Настраиваем валидацию в реальном времени для проверки дубликатов
        setupRealTimeValidation();
        
        // Загружаем остальные данные в фоне
        loadRatesTable();
        loadOperationFilter();
        // loadPackingModels(); // УБРАНО: уже загружается через preloadPackingModels в DOMContentLoaded
        

      }

      // Асинхронная фоновая загрузка (ускорение) - только для админов
      if (currentUserRole === "admin") {
        loadAllDictionariesInBackground();
      }

      // Разблокируем кнопку после успешного входа (хотя форма скрыта)
      loginBtn.disabled = false;
      loginBtn.classList.remove("loading");
      loginBtn.textContent = "Войти";

    } else {
      errorElem.textContent = "❌ Неверный логин или PIN-код";
      // Разблокируем кнопку при ошибке
      loginBtn.disabled = false;
      loginBtn.classList.remove("loading");
      loginBtn.textContent = "Войти";
    }
  } catch (err) {
    errorElem.textContent = "❌ Ошибка подключения";
    // Разблокируем кнопку при ошибке подключения
    loginBtn.disabled = false;
    loginBtn.classList.remove("loading");
    loginBtn.textContent = "Войти";
  }
}


function handleLogout() {
  // 🔄 Сброс состояния
  currentUser = "";
  currentUserRole = "user";
  currentShift = "";
  currentStatus = "";

  // Очищаем все CSS классы для кнопок навигации
  const allTabButtons = ["tabProfile", "tabApp", "tabStats", "tabRates", "tabMySalary", "tabCostAnalysis", "tabTraineeManagement", "tabDuplicates", "tabAdmin"];
  allTabButtons.forEach(id => {
    const btn = document.getElementById(id);
    if (btn) {
      btn.classList.remove("admin-hidden", "admin-visible");
      btn.style.display = "";
      btn.style.visibility = "";
      btn.style.width = "";
      btn.style.padding = "";
      btn.style.margin = "";
    }
  });

  localStorage.removeItem("currentUser");
  localStorage.removeItem("currentUserRole");

  // 🔐 Очистка формы входа
  const loginInput = document.getElementById("login");
  const passwordInput = document.getElementById("password");
  const loginBtn = document.getElementById("loginBtn");
  
  loginInput.value = "";
  passwordInput.value = "";
  loginInput.focus();
  
  // 🔄 Сброс состояния кнопки входа
  if (loginBtn) {
    loginBtn.disabled = false;
    loginBtn.classList.remove("loading");
    loginBtn.textContent = "Войти";
  }

  // 👤 Очистка профиля
  document.querySelector('[name="employeeName"]').value = "";
  document.getElementById("shiftType").value = "";
  document.getElementById("employeeStatus").value = "";
  document.getElementById("nightShiftDate").value = "";
  document.getElementById("nightShiftDateBlock").style.display = "none";
  document.getElementById("profileSaved").style.display = "none";
  document.getElementById("profileHint").style.display = "block";
  
  // 🌙 Очистка настроек аутсорсера
  clearOutsourcingSettings();
  
  // Восстанавливаем все опции типа оплаты
  updatePayTypeOptions("");

          // 🔒 Отключение кнопки учёта
        const tabApp = document.getElementById("tabApp");
        const tabMySalary = document.getElementById("tabMySalary");
        tabApp.disabled = true;
        tabApp.innerHTML = "🔒";
        
        // 🛠️ Показываем все вкладки (так как профиль не заполнен)
        if (tabMySalary) tabMySalary.style.display = "inline-block";

  // ❌ Очистка статистики
  closeStats(); // очищает statsCards, totalWage и statsLogs

  // 📉 Очистка полей фильтра статистики
  document.getElementById("operationFilter").value = "";
  document.getElementById("statsDate").value = "";

  // 💵 Очистка зарплатных данных
  document.getElementById("mySalaryOutput").innerHTML = "";
  document.getElementById("totalQty").textContent = "";
  document.getElementById("salaryStart").value = "";
  document.getElementById("salaryEnd").value = "";

  // 🧼 Скрытие всех контейнеров
  const containers = [
    "loginContainer",
    "tabContainer",
    "appContainer",
    "statsContainer",
    "profileContainer",
    "ratesContainer",
    "adminContainer",
    "mySalaryContainer",
    "costAnalysisContainer",
    "traineeManagementContainer",
    "duplicatesContainer"
  ];
  containers.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = (id === "loginContainer") ? "block" : "none";
  });

  // Восстанавливаем видимость только обычных навигационных кнопок (админ-вкладки остаются скрытыми)
  const tabButtons = ["tabProfile", "tabApp", "tabStats", "tabRates", "tabMySalary"];
  tabButtons.forEach(id => {
    const btn = document.getElementById(id);
    if (btn) btn.style.display = "inline-block";
  });
  
  // 🔐 Админ-вкладки остаются скрытыми
  const adminTabs = ["tabCostAnalysis", "tabTraineeManagement", "tabDuplicates", "tabAdmin"];
  adminTabs.forEach(id => {
    const btn = document.getElementById(id);
    if (btn) btn.style.display = "none";
  });

  // 🧽 Сброс модальных окон
  const modal = document.getElementById("editModal");
  if (modal) modal.style.display = "none";

  // 👇 Скрытие нижнего меню
  const nav = document.getElementById("bottomNav");
  nav.style.opacity = "0";
  setTimeout(() => {
    nav.style.display = "none";
    nav.style.opacity = "1";
  }, 200);
}

  async function loadTodayRecords() {
    try {
      // === ОПТИМИЗАЦИЯ: быстрый запрос с минимальными данными ===
      const res = await fetch(`${scriptURL}?type=records`, {
        method: 'GET',
        cache: 'no-cache' // Исключаем кэширование для актуальности данных
      });
      
      if (!res.ok) {
        throw new Error(`HTTP ${res.status}: ${res.statusText}`);
      }
      
      const data = await res.json();
      todayRecords = data.records || [];
      
  
      
    } catch (error) {
      console.error("❌ Ошибка загрузки записей за сегодня:", error);
      todayRecords = [];
      
      // Показываем уведомление только при критической ошибке
      if (error.name !== 'AbortError') {
        showTemporaryNotification("⚠️ Не удалось обновить записи", "warning", 2000);
      }
    }
  }

let isMySalaryLoading = false;

async function loadMySalary() {
  if (isMySalaryLoading) return;
  isMySalaryLoading = true;

  const showBtn = document.getElementById("mySalaryBtn");
  const closeBtn = document.getElementById("closeMySalaryBtn");
  const container = document.getElementById("mySalaryOutput");
  const totalQtyBlock = document.getElementById("totalQty");
  
  // Блокируем обе кнопки во время загрузки
  if (showBtn) {
    showBtn.disabled = true;
    showBtn.textContent = "⏳ Загружаем результаты...";
    showBtn.style.opacity = "0.6";
  }
  
  if (closeBtn) {
    closeBtn.disabled = true;
    closeBtn.style.opacity = "0.6";
    closeBtn.style.cursor = "not-allowed";
  }

  // Очищаем старые данные сразу
  container.innerHTML = "";
  totalQtyBlock.innerHTML = "";

  try {
    const employee = localStorage.getItem("currentUser") || "";
    const start = document.getElementById("salaryStart").value;
    const end = document.getElementById("salaryEnd").value;

    if (!employee || !start || !end) {
      container.innerHTML = "<p style='text-align:center; color:#f59e0b;'>⚠️ Укажите все поля: период и сотрудник</p>";
      return;
    }

    const res = await fetch(`${scriptURL}?type=mySalary&employee=${encodeURIComponent(employee)}&start=${start}&end=${end}`);
    
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    }
    
    const data = await res.json();

    // Проверяем наличие ошибки с сервера
    if (data.error) {
      container.innerHTML = `<p style='text-align:center; color:#dc2626;'>${data.error}</p>`;
      return;
    }

    if (!data.records || data.records.length === 0) {
      container.innerHTML = "<p style='text-align:center; color:#6b7280;'>📭 Нет данных за выбранный период</p>";
      return;
    }

      // 📦 Группировка по дате и смене
      const grouped = {};

      data.records.forEach(r => {
        const date = formatDate(r.date);
        const shift = r.shift || "День"; // Fallback для старых записей
        const key = `${date}-${shift}`;
        
        if (!grouped[key]) {
          grouped[key] = { 
            date: date,
            shift: shift,
            qty: 0, 
            wage: 0,
            mentorBonus: 0,
            effs: [],
            repackaged: 0,
            stickered: 0,
            operations: []
          };
        }
      
        grouped[key].qty += r.quantity || 0;
        grouped[key].wage += r.wage || 0;
        grouped[key].mentorBonus += r.mentorBonus || 0;
      
        if (r.efficiency !== undefined && r.efficiency !== null) {
          grouped[key].effs.push(r.efficiency);
        }

        // Разделяем по типам операций
        if (r.operation === "Маркировка продукции ш/к") {
          grouped[key].stickered += r.quantity || 0;
        } else {
          grouped[key].repackaged += r.quantity || 0;
        }
        
        // Сохраняем детали операций
        grouped[key].operations.push({
          operation: r.operation,
          quantity: r.quantity,
          efficiency: r.efficiency,
          wage: r.wage,
          mentorBonus: r.mentorBonus,
          bonusPercent: r.bonusPercent,
          normStatus: r.normStatus
        });
      });

      let html = `
      <table style="width:100%; border-collapse: collapse; font-size:14px; min-width: 800px;">
          <thead style="background:#f3f4f6;">
            <tr>
              <th style="padding:8px; border:1px solid #ccc;">📅 Дата</th>
              <th style="padding:8px; border:1px solid #ccc;">🌅 Смена</th>
              <th style="padding:8px; border:1px solid #ccc;">📦 Переупак.</th>
              <th style="padding:8px; border:1px solid #ccc;">🏷️ Маркир.</th>
              <th style="padding:8px; border:1px solid #ccc;">⚙️ Эффект.</th>
              <th style="padding:8px; border:1px solid #ccc;">💰 Основная</th>
              <th style="padding:8px; border:1px solid #ccc;">👨‍🏫 Бонус наставника</th>
              <th style="padding:8px; border:1px solid #ccc;">💵 Итого</th>
            </tr>
          </thead>
          <tbody>
      `;

      // Сортируем по дате и смене
      const sortedEntries = Object.entries(grouped).sort(([a], [b]) => {
        const [dateA, shiftA] = a.split('-');
        const [dateB, shiftB] = b.split('-');
        if (dateA !== dateB) return dateA.localeCompare(dateB);
        // День идет перед Ночью
        if (shiftA === 'День' && shiftB === 'Ночь') return -1;
        if (shiftA === 'Ночь' && shiftB === 'День') return 1;
        return 0;
      });

      sortedEntries.forEach(([key, stats]) => {
        const avgEff = stats.effs.length
          ? Math.round(stats.effs.reduce((a, b) => a + b, 0) / stats.effs.length)
          : "-";
        
        // Рассчитываем основную зарплату (общая - бонус наставника)
        const basicWage = stats.wage - stats.mentorBonus;
        
        // Иконка и цвет для смены
        const shiftIcon = stats.shift === 'День' ? '☀️' : '🌙';
        const shiftBg = stats.shift === 'День' ? '#fef3c7' : '#ddd6fe';
        
        html += `
          <tr>
            <td style="padding:6px; border:1px solid #ccc;">${stats.date}</td>
            <td style="padding:6px; border:1px solid #ccc; background:${shiftBg}; font-weight:bold;">${shiftIcon} ${stats.shift}</td>
            <td style="padding:6px; border:1px solid #ccc;">${stats.repackaged}</td>
            <td style="padding:6px; border:1px solid #ccc;">${stats.stickered}</td>
            <td style="padding:6px; border:1px solid #ccc;">${avgEff}%</td>
            <td style="padding:6px; border:1px solid #ccc;">${basicWage.toFixed(2)} ₽</td>
            <td style="padding:6px; border:1px solid #ccc; ${stats.mentorBonus > 0 ? 'background:#f0f9ff; font-weight:bold;' : ''}">${stats.mentorBonus.toFixed(2)} ₽</td>
            <td style="padding:6px; border:1px solid #ccc; font-weight:bold;">${stats.wage.toFixed(2)} ₽</td>
          </tr>
        `;
      });

      html += `</tbody></table>`;
      container.innerHTML = html;
    
    // === ИТОГОВЫЕ ПОКАЗАТЕЛИ С РАЗДЕЛЕНИЕМ ПО СМЕНАМ ===
    const totals = data.totals || {};
    const dayTotals = data.dayTotals || {};
    const nightTotals = data.nightTotals || {};
    
    const totalBasicWage = (totals.totalWage || 0) - (totals.totalMentorBonus || 0);
    const dayBasicWage = (dayTotals.totalWage || 0) - (dayTotals.totalMentorBonus || 0);
    const nightBasicWage = (nightTotals.totalWage || 0) - (nightTotals.totalMentorBonus || 0);
    
    // Создаем блоки только если есть данные для соответствующей смены
    let shiftsHTML = '';
    
    if (dayTotals.totalQuantity > 0) {
      shiftsHTML += `
        <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde047 20%); padding:12px; border-radius:8px; border:1px solid #eab308; margin-bottom: 8px;">
          <div style="text-align: center; font-weight: bold; margin-bottom: 8px; color: #000000;">☀️ Дневные смены</div>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 6px; text-align: center; font-size: 12px; color: #000000;">
            <div><strong>💰 Основная:</strong><br>${dayBasicWage.toFixed(2)} ₽</div>
            <div><strong>👨‍🏫 Бонус наставника:</strong><br>${(dayTotals.totalMentorBonus || 0).toFixed(2)} ₽</div>
            <div><strong>💵 Итого:</strong><br>${(dayTotals.totalWage || 0).toFixed(2)} ₽</div>
            <div><strong>📦 Переупак.:</strong><br>${dayTotals.totalRepackaged || 0} шт</div>
            <div><strong>🏷️ Маркир.:</strong><br>${dayTotals.totalStickered || 0} шт</div>
            <div><strong>⚙️ Эффект.:</strong><br>${dayTotals.avgEfficiency || 0}%</div>
            <div><strong>📊 Нормы:</strong><br>${dayTotals.normsCompleted || 0}/${dayTotals.totalNorms || 0} (${dayTotals.normPercentage || 0}%)</div>
          </div>
        </div>
      `;
    }
    
    if (nightTotals.totalQuantity > 0) {
      shiftsHTML += `
        <div style="background: linear-gradient(135deg, #ddd6fe 0%, #c084fc 20%); padding:12px; border-radius:8px; border:1px solid #8b5cf6; margin-bottom: 8px;">
          <div style="text-align: center; font-weight: bold; margin-bottom: 8px; color: #000000;">🌙 Ночные смены</div>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 6px; text-align: center; font-size: 12px; color: #000000;">
            <div><strong>💰 Основная:</strong><br>${nightBasicWage.toFixed(2)} ₽</div>
            <div><strong>👨‍🏫 Бонус наставника:</strong><br>${(nightTotals.totalMentorBonus || 0).toFixed(2)} ₽</div>
            <div><strong>💵 Итого:</strong><br>${(nightTotals.totalWage || 0).toFixed(2)} ₽</div>
            <div><strong>📦 Переупак.:</strong><br>${nightTotals.totalRepackaged || 0} шт</div>
            <div><strong>🏷️ Маркир.:</strong><br>${nightTotals.totalStickered || 0} шт</div>
            <div><strong>⚙️ Эффект.:</strong><br>${nightTotals.avgEfficiency || 0}%</div>
            <div><strong>📊 Нормы:</strong><br>${nightTotals.normsCompleted || 0}/${nightTotals.totalNorms || 0} (${nightTotals.normPercentage || 0}%)</div>
          </div>
        </div>
      `;
    }
    
    totalQtyBlock.innerHTML = `
      ${shiftsHTML}
      <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding:16px; border-radius:12px; border:2px solid #10b981; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2); color: #000000 !important;">
        <div style="text-align: center; font-weight: bold; margin-bottom: 12px; font-size: 16px;">💵 Итого</div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px; text-align: center; font-size: 13px; line-height: 1.4;">
          <div><strong>💰 Основная:</strong><br>${totalBasicWage.toFixed(2)} ₽</div>
          <div><strong>👨‍🏫 Бонус наставника:</strong><br>${(totals.totalMentorBonus || 0).toFixed(2)} ₽</div>
          <div><strong>💵 Итого:</strong><br>${(totals.totalWage || 0).toFixed(2)} ₽</div>
          <div><strong>📦 Переупак.:</strong><br>${totals.totalRepackaged || 0} шт</div>
          <div><strong>🏷️ Маркир.:</strong><br>${totals.totalStickered || 0} шт</div>
          <div><strong>⚙️ Эффект.:</strong><br>${totals.avgEfficiency || 0}%</div>
          <div><strong>📊 Нормы:</strong><br>${totals.normsCompleted || 0}/${totals.totalNorms || 0} (${totals.normPercentage || 0}%)</div>
        </div>
      </div>
    `;

    // Показываем кнопку закрытия
    if (closeBtn) closeBtn.style.display = "inline-block";

    } catch (err) {
      console.error("Ошибка загрузки зарплаты:", err);
      
      // Показываем пользователю понятное сообщение об ошибке
      let userMessage = "❌ Ошибка загрузки данных";
      if (err.message.includes("fetch")) {
        userMessage = "🌐 Проблемы с подключением к серверу";
      } else if (err.message.includes("JSON")) {
        userMessage = "📄 Ошибка обработки данных с сервера";
      } else if (err.message.includes("HTTP 403")) {
        userMessage = "🔒 Недостаточно прав доступа";
      } else if (err.message.includes("HTTP 500")) {
        userMessage = "⚙️ Ошибка сервера, попробуйте позже";
      }
      
      container.innerHTML = `<p style="text-align:center; color:#dc2626;">${userMessage}</p>`;
      totalQtyBlock.innerHTML = "";
    
  } finally {
    isMySalaryLoading = false;
    
    // Разблокируем кнопку "Показать мои результаты"
    if (showBtn) {
      showBtn.disabled = false;
      showBtn.textContent = "📊 Показать мои результаты";
      showBtn.style.opacity = "1";
    }
    
    // Разблокируем кнопку "Закрыть мои результаты"
    if (closeBtn) {
      closeBtn.disabled = false;
      closeBtn.style.opacity = "1";
      closeBtn.style.cursor = "pointer";
    }
  }
}

function closeMySalary() {
  document.getElementById("mySalaryOutput").innerHTML = "";
  document.getElementById("totalQty").innerHTML = "";

  const closeBtn = document.getElementById("closeMySalaryBtn");
  if (closeBtn) closeBtn.style.display = "none";
}

function formatDate(iso) {
  const [y, m, d] = iso.split("-");
  return `${d}.${m}.${y}`;
}




  async function loadVolumes() {
    try {
      const volumes = await loadVolumesFast();
      allVolumes = volumes.map(v => ["", v]); // ← сохраняем как [операция, объём] (заглушка)

      const select = document.querySelector('[name="volume"]');
      select.innerHTML = '<option value="">-- Выбери объём --</option>';
      volumes.forEach(val => {
        const opt = document.createElement('option');
        opt.value = val;
        opt.textContent = val;
        select.appendChild(opt);
      });
    } catch (error) {
      console.error("Ошибка загрузки объемов:", error);
    }
  }

  async function loadOperations() {
    try {
      const operations = await loadOperationsFast();
      const select = document.querySelector('[name="operationType"]');
      select.innerHTML = '<option value="">-- Выбери операцию --</option>';
      operations.forEach(val => {
        const opt = document.createElement('option');
        opt.value = val;
        opt.textContent = val;
        select.appendChild(opt);
      });
      select.addEventListener("change", () => handleOperationChange(select.value));
    } catch (error) {
      console.error("Ошибка загрузки операций:", error);
    }
  }

  async function loadSetNumbers() {
    try {
      const sets = await loadSetsFast();
      const select = document.querySelector('[name="setNumber"]');
      select.innerHTML = '<option value="">-- Выбери артикул --</option>';
      sets.forEach(val => {
        const opt = document.createElement('option');
        opt.value = val;
        opt.textContent = val;
        select.appendChild(opt);
      });
    } catch (error) {
      console.error("Ошибка загрузки артикулов:", error);
    }
  }

async function deleteRecord(index) {
  if (!confirm("Удалить эту запись?")) return;

  // Локально удаляем запись из интерфейса для мгновенного отклика
  const recordElement = document.querySelector(`[data-record-index="${index}"]`);
  if (recordElement) {
    recordElement.style.opacity = "0.5";
    recordElement.style.pointerEvents = "none";
  }

  // === БЛОКИРУЕМ КНОПКИ СТАТИСТИКИ ВО ВРЕМЯ УДАЛЕНИЯ ===
  const showStatsBtn = document.getElementById("showStatsBtn");
  const closeStatsBtn = document.getElementById("closeStatsBtn");
  
  // Сохраняем исходное состояние кнопок
  const originalShowState = {
    disabled: showStatsBtn?.disabled || false,
    text: showStatsBtn?.textContent || "",
    opacity: showStatsBtn?.style.opacity || "1"
  };
  
  const originalCloseState = {
    disabled: closeStatsBtn?.disabled || false,
    opacity: closeStatsBtn?.style.opacity || "1",
    cursor: closeStatsBtn?.style.cursor || "pointer"
  };

  // Блокируем кнопки
  if (showStatsBtn) {
    showStatsBtn.disabled = true;
    showStatsBtn.textContent = "⏳ Обновление...";
    showStatsBtn.style.opacity = "0.6";
  }
  
  if (closeStatsBtn) {
    closeStatsBtn.disabled = true;
    closeStatsBtn.style.opacity = "0.6";
    closeStatsBtn.style.cursor = "not-allowed";
  }

  try {
    const res = await fetch(`${scriptURL}?type=deleteRecord&index=${index}`);
    const data = await res.json();

    if (data.status === "success") {
      showTemporaryNotification("✅ Запись удалена", "success", 2000); // Быстрее скрывается
      
      // === МГНОВЕННОЕ УДАЛЕНИЕ ИЗ ИНТЕРФЕЙСА ===
      if (recordElement) {
        recordElement.remove(); // Удаляем элемент сразу
        
        // Проверяем, остались ли еще записи в статистике
        const statsCards = document.getElementById("statsCards");
        const remainingCards = statsCards?.querySelectorAll('.stat-card');
        if (statsCards && (!remainingCards || remainingCards.length === 0)) {
          // Если записей не осталось, очищаем итог и показываем сообщение
          const totalElem = document.getElementById("totalWage");
          if (totalElem) totalElem.textContent = "";
          statsCards.innerHTML = '<p style="text-align:center;">Нет данных за выбранную дату</p>';
        }
      }
      
      // Отмечаем что нужно обновить интерфейс после разблокировки
      window.needsInterfaceUpdate = true;
      
    } else {
      // В случае ошибки возвращаем запись в исходное состояние
      if (recordElement) {
        recordElement.style.opacity = "1";
        recordElement.style.pointerEvents = "auto";
      }
      showTemporaryNotification(data.message || "❌ Ошибка удаления", "error");
    }
    
  } catch (error) {
    // В случае ошибки возвращаем запись в исходное состояние
    if (recordElement) {
      recordElement.style.opacity = "1";
      recordElement.style.pointerEvents = "auto";
    }
    console.error("❌ Ошибка удаления:", error);
    showTemporaryNotification("❌ Ошибка соединения при удалении", "error");
  } finally {
    // === РАЗБЛОКИРУЕМ КНОПКИ СТАТИСТИКИ С НЕБОЛЬШОЙ ЗАДЕРЖКОЙ ===
    setTimeout(() => {
      if (showStatsBtn) {
        showStatsBtn.disabled = originalShowState.disabled;
        showStatsBtn.textContent = originalShowState.text;
        showStatsBtn.style.opacity = originalShowState.opacity;
      }
      
      if (closeStatsBtn) {
        closeStatsBtn.disabled = originalCloseState.disabled;
        closeStatsBtn.style.opacity = originalCloseState.opacity;
        closeStatsBtn.style.cursor = originalCloseState.cursor;
      }
      
      // === ЗАПУСКАЕМ ОБНОВЛЕНИЕ ИНТЕРФЕЙСА ПОСЛЕ РАЗБЛОКИРОВКИ ===
      if (window.needsInterfaceUpdate) {
        window.needsInterfaceUpdate = false;
        fastUpdateAfterChange();
      }
    }, 500); // Даем время фоновым операциям
  }
}

  function handleOperationChange(operation) {
  const setField = document.getElementById("setNumberField");
  const volumeLabel = document.getElementById("volumeLabel");
  const volumeSelect = document.querySelector('[name="volume"]');
  const setSelect = document.querySelector('[name="setNumber"]');

  // Показать/скрыть поле Артикул набора
  if (operation === 'Сборка "Набора"') {
    setField.style.display = "block";
    setSelect.required = true;
    volumeLabel.style.display = "none";
    volumeSelect.required = false;
    volumeSelect.value = "";
  } else {
    setField.style.display = "none";
    setSelect.required = false;
    setSelect.value = "";
    volumeLabel.style.display = "block";
    volumeSelect.required = true;
  }

  // === 🔒 Маркировка продукции — объём не требуется ===
 if (operation === "Маркировка продукции ш/к") {
  volumeLabel.style.display = "none";
  volumeSelect.required = false;
  volumeSelect.value = "";
  return;
}

  // === 📂 Подгрузка объёмов по операции ===
  volumeSelect.disabled = false;
  volumeSelect.innerHTML = '<option value="">-- Выбери объём --</option>';

  // Фильтруем доступные объёмы по операции из справочника (allRates должен быть загружен заранее)
  const relatedKeys = Array.from(
    new Set(
      allRates
        .filter(rate => rate.operation === operation)
        .map(rate => rate.key)
    )
  );

  // Добавляем варианты
  relatedKeys.forEach(key => {
    const opt = document.createElement("option");
    opt.value = key;
    opt.textContent = key;
    volumeSelect.appendChild(opt);
  });
}


async function updateRateDisplay() {
  // 🌙 Проверяем статус пользователя - для аутсорсеров не показываем тарифы
  const employeeStatus = document.getElementById("employeeStatus")?.value;
  if (employeeStatus === "Аутсорсинг") {
    // Скрываем блоки для аутсорсеров
    const block = document.getElementById("rateInfo");
    const calcBlock = document.getElementById("calcBlock");
    if (block) block.style.display = "none";
    if (calcBlock) calcBlock.style.display = "none";
    return; // Выходим из функции
  }

  const operationType = document.querySelector('[name="operationType"]').value;
  const volume = document.querySelector('[name="volume"]').value;
  const setNumber = document.querySelector('[name="setNumber"]').value;
  const quantity = Number(document.querySelector('[name="quantity"]').value) || 0;

  const startTime = document.querySelector('[name="startTime"]').value;
  const endTime = document.querySelector('[name="endTime"]').value;

  const key = (operationType.includes("Сборка")) ? setNumber : volume;

  // Найти нужный тариф
  const matched = allRates.find(r => r.operation === operationType && r.key === key);

  const block = document.getElementById("rateInfo");
  const norm = document.getElementById("normDisplay");
  const rate = document.getElementById("rateDisplay");

  const calcBlock = document.getElementById("calcBlock");
  const wageDisplay = document.getElementById("wageDisplay");
  const efficiencyDisplay = document.getElementById("efficiencyDisplay");

  if (matched) {
    norm.textContent = matched.normPerHour;

    // --- Выбор тарифа с учётом типа оплаты и FBS ---
    const packingModel = (document.getElementById("profilePackingModel")?.value || "").toLowerCase();
    const payType = localStorage.getItem("profilePayType") || "Сделка";
    let ratePerUnit = 0;

    if (payType === "Оклад + сделка") {
      // Оклад+сделка: отдельные тарифы
      if (packingModel.includes("fbs") && matched.rateFBSDeal !== undefined) {
        ratePerUnit = Number(matched.rateFBSDeal);
      } else if (matched.rateDeal !== undefined) {
        ratePerUnit = Number(matched.rateDeal);
      }
    } else {
      // Обычная сделка
      if (packingModel.includes("fbs") && matched.rateFBS !== undefined) {
        ratePerUnit = Number(matched.rateFBS);
      } else if (matched.ratePerUnit !== undefined) {
        ratePerUnit = Number(matched.ratePerUnit);
      }
    }

    rate.textContent = ratePerUnit ? ratePerUnit.toFixed(2) + " ₽" : "-";

    const totalPay = quantity * ratePerUnit;

    let durationMin = 0;
    if (startTime && endTime) {
      const [sh, sm] = startTime.split(":").map(Number);
      const [eh, em] = endTime.split(":").map(Number);
      durationMin = (eh * 60 + em) - (sh * 60 + sm);
      if (durationMin < 0) durationMin += 1440;
    }

    let efficiency = "-";
    if (durationMin > 0 && matched.normPerHour > 0) {
      const expected = (matched.normPerHour / 60) * durationMin;
      efficiency = ((quantity / expected) * 100).toFixed(0) + " %";
    }

    wageDisplay.textContent = totalPay.toFixed(2) + " ₽";
    efficiencyDisplay.textContent = efficiency;

    // Бонус наставника теперь фиксированный (1750₽ за смену) и рассчитывается автоматически

    block.style.display = "block";
    calcBlock.style.display = "block";
  } else {
    norm.textContent = "-";
    rate.textContent = "-";
    block.style.display = "none";
    calcBlock.style.display = "none";
  }
}

document.querySelector('[name="operationType"]').addEventListener("change", () => updateRateDisplay());
document.querySelector('[name="volume"]').addEventListener("change", () => updateRateDisplay());
document.querySelector('[name="setNumber"]').addEventListener("change", () => updateRateDisplay());
document.querySelector('[name="quantity"]').addEventListener("input", () => updateRateDisplay());
document.querySelector('[name="startTime"]').addEventListener("change", () => updateRateDisplay());
document.querySelector('[name="endTime"]').addEventListener("change", () => updateRateDisplay());

document.getElementById("dataForm").addEventListener("submit", async function(e) {
  e.preventDefault();
  const form = e.target;
  const result = document.getElementById("result");
  const submitBtn = form.querySelector('button[type="submit"]');
  
  // Проверяем, не заблокирована ли уже кнопка (предотвращаем двойную отправку)
  if (submitBtn.disabled) {
    return;
  }

  // 🚀 БЫСТРАЯ ОТПРАВКА для аутсорсеров
  const isOutsourcing = currentStatus === "Аутсорсинг";
  
  if (isOutsourcing) {
    await handleOutsourcingSubmit(form, submitBtn, result);
  } else {
    await handleRegularSubmit(form, submitBtn, result);
  }
});

// 🚀 Оптимизированная отправка для аутсорсеров  
async function handleOutsourcingSubmit(form, submitBtn, result) {
  // Минимальная блокировка UI
  submitBtn.disabled = true;
  submitBtn.textContent = "⏳ Отправка...";
  result.style.display = "none";

  // Быстрое формирование данных
  const formData = new FormData(form);
  
  // Добавляем только необходимые данные
  formData.append("packingModel", document.getElementById("profilePackingModel").value);
  formData.append("shiftType", currentShift);
  formData.append("employeeStatus", currentStatus);
  formData.append("payType", "Сделка"); // Фиксированное для аутсорсеров
  
  // 🌙 Дата ночной смены если нужно
  if (currentShift === "Ночь") {
    const nightShiftDate = localStorage.getItem("profileNightShiftDate");
    if (nightShiftDate) {
      formData.append("nightShiftDate", nightShiftDate);
    }
  }

  // Быстрая отправка без лишних проверок
  try {
    const response = await fetch(scriptURL, {
      method: "POST",
      body: formData // Используем FormData напрямую для скорости
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const resultData = await response.json();
    
    if (resultData.status === "success") {
      // 🚀 Быстрый сброс для аутсорсеров
      form.reset();
      document.querySelector('[name="employeeName"]').value = currentUser;
      showTemporaryNotification("✅ Данные отправлены!", "success");
      
      // Асинхронное обновление без блокировки
      setTimeout(() => loadTodayRecords(), 100);
    } else {
      result.textContent = resultData.message;
      result.style.display = "block";
      result.className = "error-message";
    }
    
  } catch (error) {
    console.error("❌ Ошибка отправки:", error);
    result.textContent = "❌ Ошибка: " + error.message;
    result.style.display = "block";
    result.className = "error-message";
  } finally {
    // Быстрая разблокировка
    submitBtn.disabled = false;
    submitBtn.textContent = "💾 Сохранить";
  }
}

// Стандартная отправка для штатных сотрудников
async function handleRegularSubmit(form, submitBtn, result) {
  const formData = new FormData(form);

  // Добавляем модель упаковки из профиля
  const packingModel = document.getElementById("profilePackingModel").value;
  formData.append("packingModel", packingModel);

  // Пересчёт продолжительности (если нужно)
  const start = formData.get("startTime");
  const end = formData.get("endTime");
  if (start && end) {
    const [sh, sm] = start.split(":").map(Number);
    const [eh, em] = end.split(":").map(Number);
    let minutes = (eh * 60 + em) - (sh * 60 + sm);
    if (minutes < 0) minutes += 1440;
    const duration = `${Math.floor(minutes / 60)} ч ${minutes % 60} мин`;
    formData.set("duration", duration);
    document.querySelector('[name="duration"]').value = duration;
  }

  // Добавляем данные профиля
  formData.append("shiftType", currentShift);
  formData.append("employeeStatus", currentStatus);
  formData.append("payType", localStorage.getItem("profilePayType") || "");
  formData.append("salary", localStorage.getItem("profileSalary") || "");
  
  // 🌙 Добавляем дату ночной смены если это ночная смена
  if (currentShift === "Ночь") {
    const nightShiftDate = localStorage.getItem("profileNightShiftDate");
    if (nightShiftDate) {
      formData.append("nightShiftDate", nightShiftDate);
    }
  }

  // === Блокировка кнопки и изменение интерфейса ===
  submitBtn.disabled = true;
  submitBtn.textContent = "⏳ Отправка...";
  submitBtn.style.opacity = "0.6";
  submitBtn.style.cursor = "not-allowed";
  submitBtn.classList.add("loading");
  result.style.display = "none";
  
  // Блокируем всю форму
  form.classList.add("form-disabled");
  
  // Скрываем предупреждения о дубликатах во время отправки
  hideAllWarnings();

  // === ОПТИМИЗАЦИЯ: отправляем через URLSearchParams ===
  const params = new URLSearchParams();
  formData.forEach((value, key) => {
    params.append(key, value);
  });

  try {
    const response = await fetch(scriptURL, {
      method: "POST",
      body: params,
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
      }
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const resultData = await response.json();
    
    // Показываем результат
    result.textContent = resultData.message;
    result.style.display = "block";
    
    // Добавляем класс для стилизации сообщения
    result.className = resultData.status === "success" ? "success-message" : "error-message";

    if (resultData.status === "success") {
      // ✅ ПОЛНОЕ ОБНОВЛЕНИЕ ИНТЕРФЕЙСА
      await performFullInterfaceRefresh();
      
      // Показываем сообщение об успехе немного дольше
      setTimeout(() => {
        result.style.display = "none";
        result.className = "";
      }, 3000);
      
    } else {
      // В случае ошибки просто разблокируем кнопку
      enableSubmitButton();
    }
    
  } catch (error) {
    console.error("❌ Ошибка отправки данных:", error);
    result.textContent = "❌ Ошибка отправки: " + error.message;
    result.style.display = "block";
    result.className = "error-message";
    enableSubmitButton();
  }
}


async function loadRatesTable() {
  const loader = document.getElementById("ratesLoader");
  const container = document.getElementById("ratesTable");
  const opFilter = document.getElementById("filterOperation");
  const keyFilter = document.getElementById("filterKey");
  const searchInput = document.getElementById("ratesSearch");
  const counter = document.getElementById("ratesCounter");

  // Показываем индикатор загрузки
  loader.style.display = "block";
  container.innerHTML = "";

  try {
  // Используем кэш для тарифов
  if (isCacheValid(dataCache.rates)) {
    allRates = dataCache.rates.data;
  } else {
    const res = await fetch(`${scriptURL}?type=rates`);
    const data = await res.json();
    allRates = data.rates || [];
    
    dataCache.rates = {
      data: allRates,
      timestamp: Date.now()
    };
  }

  // Фильтруем лишние ставки
  const filteredRates = allRates.filter(r =>
    r.operation !== "Ставка_Аутсорсинг" && r.operation !== "Ставка_штат"
  );

    // Заполняем фильтры
    populateFilters(filteredRates, opFilter, keyFilter);

    // Состояние сортировки
    let sortColumn = null;
    let sortDirection = "asc";

    // Функция рендеринга с поиском, фильтрацией и сортировкой
  function renderFilteredRates() {
      const searchText = searchInput.value.toLowerCase().trim();
    const selectedOp = opFilter.value;
    const selectedKey = keyFilter.value;

      let filtered = filteredRates.filter(r => {
        const matchesSearch = !searchText || r.operation.toLowerCase().includes(searchText);
        const matchesOp = !selectedOp || r.operation === selectedOp;
        const matchesKey = !selectedKey || r.key === selectedKey;
        return matchesSearch && matchesOp && matchesKey;
      });

      // Применяем сортировку
      if (sortColumn !== null) {
        filtered.sort((a, b) => {
          let aVal = getColumnValue(a, sortColumn);
          let bVal = getColumnValue(b, sortColumn);
          
          // Числовая сортировка для тарифов и норм
          if (sortColumn >= 2) {
            aVal = parseFloat(aVal) || 0;
            bVal = parseFloat(bVal) || 0;
          }
          
          let result = aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
          return sortDirection === "desc" ? -result : result;
        });
      }

      // Обновляем счетчик
      updateCounter(filtered.length, filteredRates.length);

    if (!filtered.length) {
        container.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #6b7280;">
            <div style="font-size: 48px; margin-bottom: 16px;">🔍</div>
            <h3 style="margin: 0 0 8px 0; color: #374151;">Ничего не найдено</h3>
            <p style="margin: 0;">Попробуйте изменить критерии поиска</p>
          </div>
        `;
      return;
    }

      // Генерируем таблицу
    let html = `
      <div class="table-scroll">
        <table style="width:100%; border-collapse:collapse; min-width:700px;">
        <thead>
            <tr>
              ${generateTableHeaders()}
          </tr>
        </thead>
        <tbody>
    `;

    filtered.forEach(r => {
      html += `
        <tr>
          <td>${r.operation}</td>
          <td>${r.key}</td>
          <td>${r.normPerHour}</td>
            <td><strong>${r.ratePerUnit.toFixed(2)} ₽</strong></td>
            <td><strong>${r.rateFBS.toFixed(2)} ₽</strong></td>
            <td><strong>${r.rateDeal.toFixed(2)} ₽</strong></td>
            <td><strong>${r.rateFBSDeal.toFixed(2)} ₽</strong></td>
        </tr>
      `;
    });

    html += '</tbody></table></div>';
    container.innerHTML = html;

      // Добавляем обработчики сортировки
      addSortHandlers();
    }

    // Вспомогательные функции
    function populateFilters(rates, opFilter, keyFilter) {
      // Очистка фильтров
      opFilter.innerHTML = '<option value="">-- Все операции --</option>';
      keyFilter.innerHTML = '<option value="">-- Все объёмы / артикулы --</option>';

      const operations = [...new Set(rates.map(r => r.operation))].sort();
      const keys = [...new Set(rates.map(r => r.key))].sort();

      operations.forEach(op => {
        const opt = document.createElement("option");
        opt.value = op;
        opt.textContent = op;
        opFilter.appendChild(opt);
      });

      keys.forEach(k => {
        const opt = document.createElement("option");
        opt.value = k;
        opt.textContent = k;
        keyFilter.appendChild(opt);
      });
    }

    function generateTableHeaders() {
      const headers = [
        '🏷️ Операция',
        '📦 Объём / Артикул', 
        '⏱️ Норма в час',
        '💰 Тариф/шт<br><small>(сдельная)</small>',
        '🚚 Тариф FBS/шт<br><small>(сдельная)</small>',
        '📊 Тариф/шт<br><small>(оклад+сдел)</small>',
        '🚚📊 Тариф FBS/шт<br><small>(оклад+сдел)</small>'
      ];

      return headers.map((header, index) => {
        const sortClass = getSortClass(index);
        return `<th class="sortable ${sortClass}" onclick="handleSort(${index})">${header}</th>`;
      }).join('');
    }

    function getSortClass(columnIndex) {
      if (sortColumn === columnIndex) {
        return sortDirection === "asc" ? "sorted-asc" : "sorted-desc";
      }
      return "";
    }

    function getColumnValue(row, columnIndex) {
      switch(columnIndex) {
        case 0: return row.operation;
        case 1: return row.key;
        case 2: return row.normPerHour;
        case 3: return row.ratePerUnit;
        case 4: return row.rateFBS;
        case 5: return row.rateDeal;
        case 6: return row.rateFBSDeal;
        default: return "";
      }
    }

    function updateCounter(shown, total) {
      if (shown === total) {
        counter.textContent = `Показано: ${total} тарифов`;
      } else {
        counter.textContent = `Показано: ${shown} из ${total} тарифов`;
      }
    }

    function addSortHandlers() {
      // Глобальная функция для сортировки
      window.handleSort = function(columnIndex) {
        if (sortColumn === columnIndex) {
          sortDirection = sortDirection === "asc" ? "desc" : "asc";
        } else {
          sortColumn = columnIndex;
          sortDirection = "asc";
        }
        renderFilteredRates();
      };
    }

    // Обработчики событий
  opFilter.onchange = renderFilteredRates;
  keyFilter.onchange = renderFilteredRates;

    // Живой поиск с дебаунсом
    let searchTimeout;
    searchInput.oninput = function() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(renderFilteredRates, 300);
    };

    // Улучшенные стили для фокуса поиска
    searchInput.onfocus = function() {
      this.style.borderColor = "#3b82f6";
      this.style.boxShadow = "0 0 0 3px rgba(59, 130, 246, 0.1)";
    };

    searchInput.onblur = function() {
      this.style.borderColor = "#e5e7eb";
      this.style.boxShadow = "none";
    };

    // Первоначальный рендер
    renderFilteredRates();

  } catch (error) {
    console.error("Ошибка загрузки тарифов:", error);
    container.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #ef4444;">
        <div style="font-size: 48px; margin-bottom: 16px;">⚠️</div>
        <h3 style="margin: 0 0 8px 0;">Ошибка загрузки</h3>
        <p style="margin: 0;">Не удалось загрузить тарифы</p>
      </div>
    `;
  } finally {
    // Скрываем индикатор загрузки
    loader.style.display = "none";
  }
}

// Функция проверки актуальности кэша
function isCacheValid(cacheEntry) {
  return cacheEntry.data && (Date.now() - cacheEntry.timestamp) < CACHE_DURATION;
}

// Быстрая загрузка операций с кэшированием
async function loadOperationsFast() {
  if (isCacheValid(dataCache.operations)) {
    return dataCache.operations.data;
  }
  
  const res = await fetch(`${scriptURL}?type=operations`);
  const data = await res.json();
  
  dataCache.operations = {
    data: data.operations,
    timestamp: Date.now()
  };
  
  return data.operations;
}

// Быстрая загрузка объемов с кэшированием
async function loadVolumesFast() {
  if (isCacheValid(dataCache.volumes)) {
    return dataCache.volumes.data;
  }
  
  const res = await fetch(`${scriptURL}?type=volumes`);
  const data = await res.json();
  
  dataCache.volumes = {
    data: data.volumes,
    timestamp: Date.now()
  };
  
  return data.volumes;
}

// Быстрая загрузка наборов с кэшированием
async function loadSetsFast() {
  if (isCacheValid(dataCache.sets)) {
    return dataCache.sets.data;
  }
  
  const res = await fetch(`${scriptURL}?type=sets`);
  const data = await res.json();
  
  dataCache.sets = {
    data: data.sets,
    timestamp: Date.now()
  };
  
  return data.sets;
}

// ✅ ДОБАВЛЕНО: Быстрая загрузка размеров наборов с кэшированием
async function loadSetSizesFast() {
  if (isCacheValid(dataCache.setSizes)) {
    return dataCache.setSizes.data;
  }
  
  const res = await fetch(`${scriptURL}?type=setSizes`);
  const data = await res.json();
  
  dataCache.setSizes = {
    data: data.setSizes,
    timestamp: Date.now()
  };
  
  return data.setSizes;
}

async function loadOperationFilter() {
  try {
    const operations = await loadOperationsFast();
    const filter = document.getElementById("operationFilter");

    filter.innerHTML = '<option value="">-- Все операции --</option>';
    operations.forEach(op => {
      const option = document.createElement("option");
      option.value = op;
      option.textContent = op;
      filter.appendChild(option);
    });
  } catch (error) {
    console.error("Ошибка загрузки операций:", error);
  }
}

function openEditModal(index, record) {
  const form = document.getElementById("editForm");

  form.rowIndex.value = index;
  form.employeeName.value = currentUser;
  form.orderNumber.value = record.orderNumber || "";
  form.shiftType.value = currentShift;
  form.employeeStatus.value = currentStatus;

  form.quantity.value = record.quantity;
  form.startTime.value = record.startTime;
  form.endTime.value = record.endTime;

  document.getElementById("editOperation").value = record.operationType || "";
  document.getElementById("editVolumeSelect").value = record.volume || "";
  document.getElementById("editSetNumberSelect").value = record.setNumber || "";

  // триггерим отображение поля объёма/набора
  document.getElementById("editOperation").dispatchEvent(new Event("change"));

  document.getElementById("editModal").style.display = "block";
}

async function loadEditFormDictionaries() {
  try {
    // Используем кэшированные функции для быстрой загрузки
    const [operations, volumes, sets] = await Promise.all([
      loadOperationsFast(),
      loadVolumesFast(),
      loadSetsFast()
    ]);

    // Операции
    const opSelect = document.getElementById("editOperation");
    opSelect.innerHTML = '<option value="">-- Выбери операцию --</option>';
    operations.forEach(op => {
      const opt = document.createElement("option");
      opt.value = op;
      opt.textContent = op;
      opSelect.appendChild(opt);
    });

    // Объёмы
    const volSelect = document.getElementById("editVolumeSelect");
    volSelect.innerHTML = '<option value="">-- Выбери объём --</option>';
    volumes.forEach(v => {
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = v;
      volSelect.appendChild(opt);
    });

    // Артикулы наборов
    const setSelect = document.getElementById("editSetNumberSelect");
    setSelect.innerHTML = '<option value="">-- Выбери артикул --</option>';
    sets.forEach(s => {
      const opt = document.createElement("option");
      opt.value = s;
      opt.textContent = s;
      setSelect.appendChild(opt);
    });

    // Переключение объёма/набора
    opSelect.addEventListener("change", () => {
      const isSet = opSelect.value.includes("Сборка");
      document.getElementById("editVolumeLabel").style.display = isSet ? "none" : "block";
      volSelect.required = !isSet;
      document.getElementById("editSetNumberField").style.display = isSet ? "block" : "none";
    });
    
  } catch (error) {
    console.error("Ошибка загрузки словарей для редактирования:", error);
  }
}

async function submitEditForm() {
  const form = document.getElementById("editForm");
  const submitBtn = form.querySelector('button[type="button"], .submit-btn');
  
  // Предотвращаем повторную отправку
  if (submitBtn && submitBtn.disabled) {
    return;
  }
  
  const formData = new FormData(form);
  const params = new URLSearchParams();

  formData.forEach((value, key) => {
    params.append(key, value);
  });

  // Устанавливаем флаг редактирования
  params.set("type", "editRecord");

  // 👇 Пересчёт длительности (важно!)
  const start = formData.get("startTime");
  const end = formData.get("endTime");
  if (start && end) {
    const [sh, sm] = start.split(":").map(Number);
    const [eh, em] = end.split(":").map(Number);
    let minutes = (eh * 60 + em) - (sh * 60 + sm);
    if (minutes < 0) minutes += 1440;
    const duration = `${Math.floor(minutes / 60)} ч ${minutes % 60} мин`;
    params.set("duration", duration);
  }

  // Блокируем кнопку и показываем состояние загрузки
  if (submitBtn) {
    submitBtn.disabled = true;
    submitBtn.textContent = "⏳ Сохранение...";
    submitBtn.style.opacity = "0.6";
  }

  // === БЛОКИРУЕМ КНОПКИ СТАТИСТИКИ ВО ВРЕМЯ РЕДАКТИРОВАНИЯ ===
  const showStatsBtn = document.getElementById("showStatsBtn");
  const closeStatsBtn = document.getElementById("closeStatsBtn");
  
  // Сохраняем исходное состояние кнопок
  const originalShowState = {
    disabled: showStatsBtn?.disabled || false,
    text: showStatsBtn?.textContent || "",
    opacity: showStatsBtn?.style.opacity || "1"
  };
  
  const originalCloseState = {
    disabled: closeStatsBtn?.disabled || false,
    opacity: closeStatsBtn?.style.opacity || "1",
    cursor: closeStatsBtn?.style.cursor || "pointer"
  };

  // Блокируем кнопки статистики
  if (showStatsBtn) {
    showStatsBtn.disabled = true;
    showStatsBtn.textContent = "⏳ Обновление...";
    showStatsBtn.style.opacity = "0.6";
  }
  
  if (closeStatsBtn) {
    closeStatsBtn.disabled = true;
    closeStatsBtn.style.opacity = "0.6";
    closeStatsBtn.style.cursor = "not-allowed";
  }

  try {
    const res = await fetch(scriptURL, {
      method: "POST",
      body: params,
    });

    const data = await res.json();
    
    if (data.status === "success") {
      showTemporaryNotification("✅ Запись обновлена!", "success", 2000); // Быстрее скрывается
      closeEditModal();
      
      // Отмечаем что нужно обновить интерфейс после разблокировки
      window.needsInterfaceUpdate = true;
      
    } else {
      showTemporaryNotification(data.message || "❌ Ошибка обновления", "error");
    }
    
  } catch (err) {
    console.error("❌ Ошибка редактирования:", err);
    showTemporaryNotification("❌ Ошибка соединения: " + err.message, "error");
  } finally {
    // Разблокируем кнопку редактирования
    if (submitBtn) {
      submitBtn.disabled = false;
      submitBtn.textContent = "💾 Сохранить";
      submitBtn.style.opacity = "1";
    }
    
    // === РАЗБЛОКИРУЕМ КНОПКИ СТАТИСТИКИ С НЕБОЛЬШОЙ ЗАДЕРЖКОЙ ===
    setTimeout(() => {
      if (showStatsBtn) {
        showStatsBtn.disabled = originalShowState.disabled;
        showStatsBtn.textContent = originalShowState.text;
        showStatsBtn.style.opacity = originalShowState.opacity;
      }
      
      if (closeStatsBtn) {
        closeStatsBtn.disabled = originalCloseState.disabled;
        closeStatsBtn.style.opacity = originalCloseState.opacity;
        closeStatsBtn.style.cursor = originalCloseState.cursor;
      }
      
      // === ЗАПУСКАЕМ ОБНОВЛЕНИЕ ИНТЕРФЕЙСА ПОСЛЕ РАЗБЛОКИРОВКИ ===
      if (window.needsInterfaceUpdate) {
        window.needsInterfaceUpdate = false;
        fastUpdateAfterChange();
      }
    }, 500); // Даем время фоновым операциям
  }
}

function closeEditModal() {
  document.getElementById("editModal").style.display = "none";
}

function getVolumesForOperation(operation) {
  if (!Array.isArray(allVolumes)) return [];

  return allVolumes
    .filter(item => item[0] === operation)
    .map(item => item[1])
    .filter((value, index, self) => self.indexOf(value) === index);
}


function closeStats() {
  document.getElementById("statsCards").innerHTML = "";
  document.getElementById("totalWage").textContent = "";
  document.getElementById("statsLogs").innerHTML = "";

  const closeBtn = document.getElementById("closeStatsBtn");
  if (closeBtn) closeBtn.style.display = "none";
}

let isStatsLoading = false;



async function loadStats() {
  if (isStatsLoading) return;
  isStatsLoading = true;

  const showBtn = document.getElementById("showStatsBtn");
  const closeBtn = document.getElementById("closeStatsBtn");
  
  // Блокируем обе кнопки во время загрузки
  if (showBtn) {
    showBtn.disabled = true;
    showBtn.textContent = "⏳ Загрузка...";
    showBtn.style.opacity = "0.6";
  }
  
  if (closeBtn) {
    closeBtn.disabled = true;
    closeBtn.style.opacity = "0.6";
    closeBtn.style.cursor = "not-allowed";
  }

  try {
    const selectedOperation = document.getElementById("operationFilter").value;
    const date = document.getElementById("statsDate").value;

    if (!currentUser) {
      showTemporaryNotification("❗Ошибка: пользователь не авторизован", "error");
      return;
    }

    if (!date) {
      showTemporaryNotification("❗Выберите дату для статистики", "warning");
      return;
    }

    // Быстрая очистка старого состояния и получение элементов
    const container = document.getElementById("statsCards");
    const totalElem = document.getElementById("totalWage");
    const logElem = document.getElementById("statsLogs");
    
    container.innerHTML = "";
    totalElem.textContent = "";
    logElem.innerHTML = "";

    const res = await fetch(`${scriptURL}?type=stats&date=${encodeURIComponent(date)}&employee=${encodeURIComponent(currentUser)}`);
    
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    }
    
    const data = await res.json();

    if (!data.records || !data.records.length) {
      container.innerHTML = '<p style="text-align:center;">Нет данных за выбранную дату</p>';
      totalElem.textContent = ""; // Очищаем итог когда нет данных
      return;
    }

    // 🌙 РАЗДЕЛЕНИЕ ПО СМЕНАМ
    const dayRecords = (data.dayRecords || []).filter(r => 
      selectedOperation ? r.operationType === selectedOperation : true
    );
    const nightRecords = (data.nightRecords || []).filter(r => 
      selectedOperation ? r.operationType === selectedOperation : true
    );

    // 👥 РАЗДЕЛЕНИЕ ПО СТАТУСУ СОТРУДНИКОВ
    const staffRecords = (data.staffRecords || []).filter(r => 
      selectedOperation ? r.operationType === selectedOperation : true
    );
    const traineeRecords = (data.traineeRecords || []).filter(r => 
      selectedOperation ? r.operationType === selectedOperation : true
    );

    // Проверяем есть ли записи после фильтрации
    if (!dayRecords.length && !nightRecords.length && !staffRecords.length && !traineeRecords.length) {
      container.innerHTML = selectedOperation 
        ? '<p style="text-align:center;">Нет данных для выбранной операции</p>'
        : '<p style="text-align:center;">Нет данных за выбранную дату</p>';
      totalElem.textContent = ""; // Очищаем итог когда нет отфильтрованных данных
      return;
    }

    // 🌙 СОЗДАНИЕ РАЗДЕЛЬНЫХ БЛОКОВ ПО СМЕНАМ
    const today = new Date().toISOString().split("T")[0];
    let cardsHTML = "";
    
    // 🏢 Проверяем статус для аутсорсинга (единая переменная для всего блока)
    const isOutsourcing = currentStatus === "Аутсорсинг";
    
    // Функция проверки возможности редактирования (последние 2 суток)
    function isWithinEditPeriod(dateStr) {
      const recordDate = new Date(dateStr + "T00:00:00");
      const currentDate = new Date();
      const diffDays = Math.floor((currentDate - recordDate) / (1000 * 60 * 60 * 24));
      return diffDays <= 2;
    }
    
    // Функция для создания карточек определенной смены
    function createShiftCards(records, shiftName, shiftIcon) {
      if (!records.length) return "";
      
      let shiftWage = 0;
      let shiftEfficiency = 0;
      let shiftEfficiencyCount = 0;
      let shiftRepackaged = 0;
      let shiftStickered = 0;
      
      let shiftCardsHTML = `
        <div style="margin: 20px 0; padding: 15px; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border-radius: 12px; border: 2px solid #64748b;">
          <h3 style="margin: 0 0 15px 0; text-align: center; color: #334155;">${shiftIcon} ${shiftName}</h3>
      `;
      
      records.forEach(rec => {
        const wage = rec.wage || 0;
        shiftWage += wage;
        const quantity = rec.quantity || 0;
        
        // Разделяем по типам операций
        if (rec.operationType === "Маркировка продукции ш/к") {
          shiftStickered += quantity;
        } else {
          shiftRepackaged += quantity;
        }

        // Считаем эффективность
        const efficiency = rec.efficiency !== null && rec.efficiency !== undefined ? rec.efficiency : 0;
        shiftEfficiency += efficiency;
        shiftEfficiencyCount++;

        // Проверяем, можно ли редактировать (за последние 2 суток)
        const canEdit = rec.rowIndex !== undefined && isWithinEditPeriod(date);
        const buttonsHTML = canEdit
          ? `<div style="margin-top:10px;">
               <button onclick="openEditModal(${rec.rowIndex}, ${JSON.stringify(rec).replace(/"/g, '&quot;')})">✏️ Редактировать</button>
               <button onclick="deleteRecord(${rec.rowIndex})" class="danger" style="margin-left:10px;">🗑 Удалить</button>
             </div>`
          : "";

        
        shiftCardsHTML += `
          <div class="stat-card" ${rec.rowIndex !== undefined ? `data-record-index="${rec.rowIndex}"` : ""}>
            <p><strong>🕒 Время:</strong> ${rec.startTime} – ${rec.endTime}</p>
            <p><strong>🔧 Операция:</strong> ${rec.operationType}</p>
            <p><strong>📦 Объём:</strong> ${rec.volume || "-"}</p>
            <p><strong>🧩 Набор:</strong> ${rec.setNumber || "-"}</p>
            ${rec.mentor ? `<p><strong>👨‍🏫 Наставник/Стажер:</strong> ${rec.mentor}</p>` : ""}
            <p><strong>🔢 Кол-во:</strong> ${rec.quantity}</p>
            <p><strong>⚙️ Эффективность:</strong> ${rec.efficiency ?? "-"}%</p>
            ${!isOutsourcing ? `<p><strong>⏱ Норма в час:</strong> ${rec.normPerHour ?? "-"}</p>` : ""}
            ${!isOutsourcing ? `<p><strong>💰 Тариф за шт:</strong> ${rec.ratePerUnit?.toFixed(2) ?? "-"} ₽</p>` : ""}
            ${!isOutsourcing && rec.bonusPercent ? `<p><strong>🎁 Бонус:</strong> ${rec.bonusIcon || "🎁"} ${rec.bonusPercent}</p>` : ""}
            ${!isOutsourcing ? `<p><strong>💸 Заработано:</strong> ${wage.toFixed(2)} ₽</p>` : ""}
            ${buttonsHTML}
          </div>
        `;
      });
      
      // Итоги по смене
      const avgEfficiency = shiftEfficiencyCount ? Math.round(shiftEfficiency / shiftEfficiencyCount) : "-";
      
      if (isOutsourcing) {
        // Для аутсорсинга - без информации о заработке
        shiftCardsHTML += `
          <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.7); border-radius: 8px; text-align: center; font-weight: bold;">
            📦 Переупак.: ${shiftRepackaged} шт | 
            🏷️ Маркир.: ${shiftStickered} шт | 
            ⚙️ Эффект.: ${avgEfficiency}%
          </div>
        </div>`;
      } else {
        // Для штатных - с информацией о заработке
        shiftCardsHTML += `
          <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.7); border-radius: 8px; text-align: center; font-weight: bold;">
            💵 Итого за ${shiftName.toLowerCase()}: ${shiftWage.toFixed(2)} ₽ | 
            📦 Переупак.: ${shiftRepackaged} шт | 
            🏷️ Маркир.: ${shiftStickered} шт | 
            ⚙️ Эффект.: ${avgEfficiency}%
          </div>
        </div>`;
      }
      
      return shiftCardsHTML;
    }
    
    // Создаем блоки только для каждой смены (убираем дублирование по статусу)
    if (dayRecords.length > 0) {
      cardsHTML += createShiftCards(dayRecords, "Дневная смена", "☀️");
    }
    
    if (nightRecords.length > 0) {
      cardsHTML += createShiftCards(nightRecords, "Ночная смена", "🌙");
    }
    
    // Получаем бонус наставника и детали из данных сервера
    const mentorBonus = data.totals ? data.totals.totalMentorBonus || 0 : 0;
    const mentorBonusDetails = data.mentorBonusDetails || { trainees: [], isTrainee: false, mentor: null };
    
    // Добавляем информационную карточку о бонусе наставника если применимо (только для штатных)
    let mentorBonusInfoHTML = "";
    
    if (!isOutsourcing && mentorBonus > 0) {
      if (mentorBonusDetails.isTrainee && mentorBonusDetails.mentor) {
        mentorBonusInfoHTML = `
          <div class="stat-card" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 2px solid #0ea5e9; margin-bottom: 16px;">
            <p style="text-align: center; font-weight: bold; color: #0369a1; margin: 0;"><strong>👨‍🎓 Информация о наставничестве</strong></p>
            <p style="margin: 8px 0 0 0;"><strong>👨‍🏫 Ваш наставник:</strong> ${mentorBonusDetails.mentor}</p>
            <p style="margin: 8px 0 0 0;"><strong>💰 Бонус наставника за вашу работу:</strong> ${mentorBonus.toFixed(2)} ₽</p>
            <p style="margin: 8px 0 0 0; font-size: 13px; color: #6b7280;">
              ℹ️ За каждую вашу смену наставник получает фиксированный бонус 1750₽. Это мотивирует его помогать вам развиваться профессионально.
            </p>
          </div>
        `;
      } else if (mentorBonusDetails.trainees && mentorBonusDetails.trainees.length > 0) {
        const traineesText = mentorBonusDetails.trainees.join(', ');
        mentorBonusInfoHTML = `
          <div class="stat-card" style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border: 2px solid #10b981; margin-bottom: 16px;">
            <p style="text-align: center; font-weight: bold; color: #065f46; margin: 0;"><strong>👨‍🏫 Информация о наставничестве</strong></p>
            <p style="margin: 8px 0 0 0;"><strong>👨‍🎓 Ваши стажеры:</strong> ${traineesText}</p>
            <p style="margin: 8px 0 0 0;"><strong>💰 Общий бонус за наставничество:</strong> ${mentorBonus.toFixed(2)} ₽</p>
            <p style="margin: 8px 0 0 0; font-size: 13px; color: #6b7280;">
              ℹ️ За каждого работающего стажера вы получаете 1750₽ за смену. Всего стажеров работало: ${mentorBonusDetails.trainees.length}
            </p>
          </div>
        `;
      }
    }
    
    container.innerHTML = mentorBonusInfoHTML + cardsHTML;
    
    // Рассчитываем средняю эффективность

    
    
    // 🌙 ИСПОЛЬЗУЕМ ИТОГИ ОТ BACKEND'А
    const dayTotals = data.dayTotals || { totalWage: 0, totalRepackaged: 0, totalStickered: 0 };
    const nightTotals = data.nightTotals || { totalWage: 0, totalRepackaged: 0, totalStickered: 0 };
    const staffTotals = data.staffTotals || { totalWage: 0, totalRepackaged: 0, totalStickered: 0 };
    const traineeTotals = data.traineeTotals || { totalWage: 0, totalRepackaged: 0, totalStickered: 0 };
    const totalTotals = data.totals || { totalWage: 0, totalRepackaged: 0, totalStickered: 0, totalMentorBonus: 0 };
    
    // Формируем итоговую строку с разбивкой
    let totalText;
    
    if (isOutsourcing) {
      // Для аутсорсинга - без информации о заработке
      totalText = `📊 Всего за день: 📦 Переупак.: ${totalTotals.totalRepackaged} шт | 🏷️ Маркир.: ${totalTotals.totalStickered} шт`;
    } else {
      // Для штатных - с информацией о заработке
      totalText = `💵 Всего за день: ${totalTotals.totalWage.toFixed(2)} ₽`;
      
      // Добавляем разбивку по сменам если есть обе
      if (dayRecords.length > 0 && nightRecords.length > 0) {
        totalText += ` (☀️ День: ${dayTotals.totalWage.toFixed(2)} ₽ | 🌙 Ночь: ${nightTotals.totalWage.toFixed(2)} ₽)`;
      }
      
      // Добавляем разбивку по статусу если есть и штатные и стажеры
      if (staffRecords.length > 0 && traineeRecords.length > 0) {
        totalText += ` (👥 Штат: ${staffTotals.totalWage.toFixed(2)} ₽ | 👨‍🎓 Стажеры: ${traineeTotals.totalWage.toFixed(2)} ₽)`;
      }
      
      totalText += ` | 📦 Переупак.: ${totalTotals.totalRepackaged} шт | 🏷️ Маркир.: ${totalTotals.totalStickered} шт`;
    }
    
    // Добавляем детализацию о бонусе наставника (только для штатных)
    if (!isOutsourcing && mentorBonus > 0) {
      if (mentorBonusDetails.isTrainee && mentorBonusDetails.mentor) {
        totalText += ` | 👨‍🏫 Бонус наставника ${mentorBonusDetails.mentor}: ${mentorBonus.toFixed(2)} ₽`;
      } else if (mentorBonusDetails.trainees && mentorBonusDetails.trainees.length > 0) {
        const traineesText = mentorBonusDetails.trainees.join(', ');
        totalText += ` | 👨‍🏫 Бонус наставника: ${mentorBonus.toFixed(2)} ₽ (за стажеров: ${traineesText})`;
      }
    }
    
    totalElem.textContent = totalText;

    if (selectedOperation) {
      totalElem.textContent += ` | 🔍 Фильтр: ${selectedOperation}`;
    }

    if (data.logs && data.logs.length) {
      logElem.innerHTML = `
        <h4>🔍 Логи обработки:</h4>
        <pre style="font-size:13px; background:#f3f4f6; padding:10px; border-radius:8px; overflow-x:auto;">${data.logs.join('\n')}</pre>
      `;
    }

    // Кнопка closeBtn уже объявлена в начале функции
    if (closeBtn) closeBtn.style.display = "inline-block";

  } catch (error) {
    showTemporaryNotification("❌ Ошибка загрузки статистики: " + error.message, "error");
    
    // Очищаем состояние при ошибке
    const container = document.getElementById("statsCards");
    const totalElem = document.getElementById("totalWage");
    if (container) container.innerHTML = '<p style="text-align:center; color:red;">❌ Ошибка загрузки</p>';
    if (totalElem) totalElem.textContent = ""; // Очищаем итог при ошибке
    
  } finally {
    isStatsLoading = false;
    
    // Разблокируем кнопку "Показать статистику"
    if (showBtn) {
      showBtn.disabled = false;
      showBtn.textContent = "📊 Показать статистику";
      showBtn.style.opacity = "1";
    }
    
    // Разблокируем кнопку "Закрыть статистику"
    if (closeBtn) {
      closeBtn.disabled = false;
      closeBtn.style.opacity = "1";
      closeBtn.style.cursor = "pointer";
    }
  }
}



window.addEventListener("DOMContentLoaded", async () => {
  // 🔒 ПРИНУДИТЕЛЬНОЕ отображение только формы входа
  document.getElementById("loginContainer").style.display = "block";
  document.getElementById("tabContainer").style.display = "none";
  document.getElementById("appContainer").style.display = "none";
  document.getElementById("statsContainer").style.display = "none";
  document.getElementById("profileContainer").style.display = "none";
  document.getElementById("ratesContainer").style.display = "none";
  document.getElementById("adminContainer").style.display = "none";
  document.getElementById("mySalaryContainer").style.display = "none";
  document.getElementById("costAnalysisContainer").style.display = "none";
  document.getElementById("traineeManagementContainer").style.display = "none";
  document.getElementById("duplicatesContainer").style.display = "none";
  document.getElementById("bottomNav").style.display = "none";

  // 🎯 Обработка Enter в полях входа
  const loginField = document.getElementById("login");
  const passwordField = document.getElementById("password");
  
  if (loginField) {
    loginField.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        passwordField.focus();
      }
    });
  }
  
  if (passwordField) {
    passwordField.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        const loginBtn = document.getElementById("loginBtn");
        if (loginBtn && !loginBtn.disabled) {
          handleLogin();
        }
      }
    });
  }

  // 🚀 Предзагрузка моделей упаковки из кэша для мгновенного отображения
  preloadPackingModels();
  
  await loadEditFormDictionaries();
  await loadPackingModels();

  const savedUser = localStorage.getItem("currentUser");
  const savedRole = localStorage.getItem("currentUserRole");

  // ⛔ Сброс автоматического входа
  if (savedUser || savedRole) {
    localStorage.removeItem("currentUser");
    localStorage.removeItem("currentUserRole");
  }
  
  // 🔄 Принудительный сброс глобальных переменных
  currentUser = "";
  currentUserRole = "user";
  
  // 🔄 Очистка CSS классов навигации при инициализации
  const allTabButtons = ["tabProfile", "tabApp", "tabStats", "tabRates", "tabMySalary", "tabCostAnalysis", "tabTraineeManagement", "tabDuplicates", "tabAdmin"];
  allTabButtons.forEach(id => {
    const btn = document.getElementById(id);
    if (btn) {
      btn.classList.remove("admin-hidden", "admin-visible");
      btn.style.display = "";
      btn.style.visibility = "";
      btn.style.width = "";
      btn.style.padding = "";
      btn.style.margin = "";
    }
  });

  if (!currentUser) {
    document.getElementById("login").focus();
    document.getElementById("loginContainer").style.display = "block";
    document.getElementById("tabContainer").style.display = "none";
    document.getElementById("profileContainer").style.display = "none";
    document.getElementById("bottomNav").style.display = "none";
    return;
  }

  // ❌ УДАЛЕН код автоматического отображения интерфейса - только после входа через handleLogin()

  // ❌ УДАЛЕН весь код инициализации для авторизованных пользователей - теперь только через handleLogin()

  // 🗑️ Подсказка сохранения профиля убрана - теперь только ручной ввод
});

async function loadPackingModels() {
  const select = document.getElementById("profilePackingModel");
  if (!select) return;
  
  // 🛡️ Защита от одновременной загрузки
  if (isLoadingPackingModels) {
    
    return;
  }
  
  // Проверяем кэш
  if (isCacheValid(dataCache.packingModels)) {
    
    populatePackingModelsSelect(dataCache.packingModels.data);
    return;
  }
  
  // Устанавливаем флаг загрузки
  isLoadingPackingModels = true;
  
  // Показываем индикатор загрузки только если select пустой
  if (select.options.length <= 1) {
  select.innerHTML = '<option value="">⏳ Загрузка...</option>';
  }
  
  try {
    const res = await fetch(`${scriptURL}?type=packingModels`);
    const data = await res.json();
    const models = data.models || [];
    
    // Сохраняем в кэш
    dataCache.packingModels = {
      data: models,
      timestamp: Date.now()
    };
    
    // Сохраняем в localStorage для долгосрочного кэша
    try {
      localStorage.setItem('packingModelsCache', JSON.stringify({
        data: models,
        timestamp: Date.now()
      }));
    } catch (e) {
      console.warn("Не удалось сохранить модели упаковки в localStorage");
    }
    
    populatePackingModelsSelect(models);
    
    
  } catch (err) {
    console.error("Ошибка загрузки моделей упаковки:", err);
    // Пытаемся загрузить из localStorage как fallback
    const fallbackData = tryLoadPackingModelsFromStorage();
    if (fallbackData) {
      populatePackingModelsSelect(fallbackData);
      
    } else {
      // Показываем ошибку только если select был пустой
      if (select.options.length <= 1) {
      select.innerHTML = '<option value="">❌ Ошибка загрузки</option>';
    }
    }
  } finally {
    // Сбрасываем флаг загрузки
    isLoadingPackingModels = false;
  }
}

// Вспомогательная функция для заполнения select'а
function populatePackingModelsSelect(models) {
  const select = document.getElementById("profilePackingModel");
  if (!select) return;
  
  // 💾 Сохраняем текущее выбранное значение
  const currentValue = select.value;
  
  // Проверяем, изменились ли данные (избегаем ненужных обновлений)
  const currentOptions = Array.from(select.options).slice(1).map(opt => opt.value);
  const newModels = models || [];
  const hasChanges = JSON.stringify(currentOptions.sort()) !== JSON.stringify(newModels.sort());
  
  // Если данные не изменились и select уже заполнен, не обновляем
  if (!hasChanges && select.options.length > 1) {
    
    return;
  }
  
  // Очищаем и заполняем заново
  select.innerHTML = '<option value="">-- Выберите --</option>';
  newModels.forEach(model => {
    const opt = document.createElement("option");
    opt.value = model;
    opt.textContent = model;
    select.appendChild(opt);
  });
  
  // 🔄 Восстанавливаем выбранное значение, если оно существует в новом списке
  if (currentValue && newModels.includes(currentValue)) {
    select.value = currentValue;
    
  } else if (currentValue && !newModels.includes(currentValue)) {
    console.warn(`⚠️ Ранее выбранная модель "${currentValue}" больше не доступна`);
  }
}

// Функция загрузки из localStorage как fallback
function tryLoadPackingModelsFromStorage() {
  try {
    const cached = localStorage.getItem('packingModelsCache');
    if (cached) {
      const data = JSON.parse(cached);
      // Проверяем что данные не старше 24 часов
      const maxAge = 24 * 60 * 60 * 1000; // 24 часа
      if (Date.now() - data.timestamp < maxAge) {
    
        return data.data;
      }
    }
  } catch (e) {
    console.warn("Ошибка при загрузке из localStorage:", e);
  }
  return null;
}

// Предзагрузка моделей упаковки при инициализации страницы
function preloadPackingModels() {
  // 🛡️ Защита от повторных вызовов
  if (isLoadingPackingModels) {
    
    return;
  }
  
  // Сначала пытаемся загрузить из localStorage
  const cachedData = tryLoadPackingModelsFromStorage();
  if (cachedData) {
    dataCache.packingModels = {
      data: cachedData,
      timestamp: Date.now() - 1000 // Ставим чуть старше, чтобы обновилось в фоне
    };
    
    // Заполняем select если он уже есть
    setTimeout(() => {
      const select = document.getElementById("profilePackingModel");
      if (select && select.options.length <= 1) { // Если еще не заполнен
        populatePackingModelsSelect(cachedData);
  
      }
    }, 100);
  }
  
  // Обновляем в фоне для свежести данных (с задержкой)
  setTimeout(() => {
    if (!isCacheValid(dataCache.packingModels) && !isLoadingPackingModels) {

      loadPackingModels().catch(err => {
        console.warn("Фоновое обновление моделей упаковки не удалось:", err);
      });
    }
  }, 2000); // Увеличиваем задержку для избежания конфликтов
}

// === ФУНКЦИЯ: Загрузка оклада с кэшированием ===
async function getSalaryWithCache(employee) {
  if (!employee) {
    console.warn("getSalaryWithCache: employee пустой");
    return null;
  }

  // Проверяем кэш
  const cached = dataCache.salaries[employee];
  if (cached && (Date.now() - cached.timestamp) < CACHE_DURATION) {

    return cached.salary;
  }

  // Пытаемся загрузить из localStorage
  const localData = tryLoadSalaryFromStorage(employee);
  if (localData !== null) {
    // Сохраняем в оперативный кэш
    dataCache.salaries[employee] = {
      salary: localData,
      timestamp: Date.now() - 1000 // Чуть старше, чтобы обновилось в фоне
    };
    
    // Обновляем в фоне
    setTimeout(() => {
      fetchSalaryFromServer(employee);
    }, 500);
    

    return localData;
  }

  // Загружаем с сервера
  return await fetchSalaryFromServer(employee);
}

// Функция загрузки оклада с сервера
async function fetchSalaryFromServer(employee) {
  try {

    
    const res = await fetch(`${scriptURL}?type=getSalary&employee=${encodeURIComponent(employee)}`);
    
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    }
    
    const data = await res.json();
    const salary = String(data.salary || "");
    
    // Сохраняем в кэш
    dataCache.salaries[employee] = {
      salary: salary,
      timestamp: Date.now()
    };
    
    // Сохраняем в localStorage
    saveSalaryToStorage(employee, salary);
    

    return salary;
    
  } catch (err) {
    console.error(`❌ Ошибка загрузки оклада для "${employee}":`, err);
    
    // Пытаемся загрузить из localStorage как fallback
    const fallback = tryLoadSalaryFromStorage(employee);
    if (fallback !== null) {
  
      return fallback;
    }
    
    return null;
  }
}

// 🌙 Новая функция для загрузки оклада с учетом смены
async function fetchSalaryByShift(employee, shiftType) {
  try {
    const res = await fetch(`${scriptURL}?type=getSalaryByShift&employee=${encodeURIComponent(employee)}&shift=${encodeURIComponent(shiftType)}`);
    
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    }
    
    const data = await res.json();
    const salary = String(data.salary || "");
    
    console.log(`🌙 Загружен оклад для ${employee} (${shiftType}): ${salary}`);
    
    return salary;
    
  } catch (err) {
    console.error(`❌ Ошибка загрузки оклада для "${employee}" (${shiftType}):`, err);
    return null;
  }
}

// 🌙 Функция обновления оклада при изменении смены
async function updateSalaryForShift(shiftType) {
  const currentUser = localStorage.getItem("currentUser");
  const payType = document.getElementById("profilePayType").value;
  const salaryInput = document.getElementById("profileSalary");
  
  // Обновляем оклад только если выбран "Оклад + сделка"
  if (payType !== "Оклад + сделка" || !currentUser || !shiftType) {
    return;
  }
  
  try {
    const salary = await fetchSalaryByShift(currentUser, shiftType);
    if (salary !== null) {
      salaryInput.value = salary;
      console.log(`✅ Оклад обновлен для смены "${shiftType}": ${salary}`);
    }
  } catch (err) {
    console.error("❌ Ошибка обновления оклада:", err);
  }
}

// 🌙 Функция автоматической настройки профиля для аутсорсеров
function setupOutsourcingProfile() {
  console.log("🚚 Настройка профиля аутсорсера");
  
  // Автоматически устанавливаем статус "Аутсорсинг"
  const statusSelect = document.getElementById("employeeStatus");
  if (statusSelect) {
    statusSelect.value = "Аутсорсинг";
    statusSelect.disabled = true; // Блокируем изменение
    statusSelect.style.backgroundColor = "#f3f4f6";
    statusSelect.style.cursor = "not-allowed";
  }
  
  // Автоматически устанавливаем тип оплаты "Сделка"
  const payTypeSelect = document.getElementById("profilePayType");
  if (payTypeSelect) {
    // Сначала обновляем опции для аутсорсинга
    updatePayTypeOptions("Аутсорсинг");
    
    // Затем устанавливаем "Сделка"
    payTypeSelect.value = "Сделка";
    payTypeSelect.disabled = true; // Блокируем изменение
    payTypeSelect.style.backgroundColor = "#f3f4f6";
    payTypeSelect.style.cursor = "not-allowed";
  }
  
  // Скрываем блок оклада для аутсорсеров
  const salaryBlock = document.getElementById("salaryBlock");
  if (salaryBlock) {
    salaryBlock.style.display = "none";
  }
  
  // Скрываем ненужные вкладки для аутсорсеров (оставляем статистику для редактирования записей)
  const tabMySalary = document.getElementById("tabMySalary");
  const tabRates = document.getElementById("tabRates");
  
  if (tabMySalary) tabMySalary.style.display = "none";
  if (tabRates) tabRates.style.display = "none";
  
  // 📊 СТАТИСТИКА ОСТАЕТСЯ ДОСТУПНОЙ для редактирования и удаления записей
  
  // Скрываем блоки тарифов и расчета оплаты для аутсорсеров
  const rateInfo = document.getElementById("rateInfo");
  const calcBlock = document.getElementById("calcBlock");
  
  if (rateInfo) rateInfo.style.display = "none";
  if (calcBlock) calcBlock.style.display = "none";
  
  // Добавляем индикатор аутсорсера
  addOutsourcingIndicator();
  
  console.log("✅ Профиль аутсорсера настроен");
}

// 🌙 Функция добавления индикатора аутсорсера
function addOutsourcingIndicator() {
  // Проверяем есть ли уже индикатор
  if (document.getElementById("outsourcingIndicator")) return;
  
  // Создаем индикатор
  const indicator = document.createElement("div");
  indicator.id = "outsourcingIndicator";
  indicator.innerHTML = "🚚 Аутсорсинг";
  indicator.style.cssText = `
    background: linear-gradient(135deg, #f59e0b, #d97706);
    color: white;
    padding: 8px 16px;
    border-radius: 12px;
    font-weight: bold;
    text-align: center;
    margin-bottom: 16px;
    box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
    border: 2px solid #fbbf24;
  `;
  
  // Вставляем в начало профиля
  const profileContainer = document.getElementById("profileContainer");
  const firstChild = profileContainer.querySelector("h2");
  if (firstChild) {
    firstChild.insertAdjacentElement("afterend", indicator);
  }
}

// 🌙 Функция очистки настроек аутсорсера
function clearOutsourcingSettings() {
  // Разблокируем поля
  const statusSelect = document.getElementById("employeeStatus");
  if (statusSelect) {
    statusSelect.disabled = false;
    statusSelect.style.backgroundColor = "";
    statusSelect.style.cursor = "";
  }
  
  const payTypeSelect = document.getElementById("profilePayType");
  if (payTypeSelect) {
    payTypeSelect.disabled = false;
    payTypeSelect.style.backgroundColor = "";
    payTypeSelect.style.cursor = "";
  }
  
  // Показываем блок оклада
  const salaryBlock = document.getElementById("salaryBlock");
  if (salaryBlock) {
    salaryBlock.style.display = "none"; // Скрыто по умолчанию
  }
  
  // Показываем вкладки для обычных пользователей
  const tabMySalary = document.getElementById("tabMySalary");
  const tabStats = document.getElementById("tabStats");
  const tabRates = document.getElementById("tabRates");
  
  if (tabMySalary) tabMySalary.style.display = "inline-block";
  if (tabStats) tabStats.style.display = "inline-block"; 
  if (tabRates) tabRates.style.display = "inline-block";
  
  // Показываем блоки тарифов и расчета оплаты для обычных пользователей
  const rateInfo = document.getElementById("rateInfo");
  const calcBlock = document.getElementById("calcBlock");
  
  // Не показываем их принудительно, пусть updateRateDisplay() решает
  if (rateInfo) rateInfo.style.display = "";
  if (calcBlock) calcBlock.style.display = "";
  
  // Удаляем индикатор аутсорсера
  const indicator = document.getElementById("outsourcingIndicator");
  if (indicator) {
    indicator.remove();
  }
}

// Функция сохранения оклада в localStorage
function saveSalaryToStorage(employee, salary) {
  try {
    const salariesCache = JSON.parse(localStorage.getItem('salariesCache') || '{}');
    salariesCache[employee] = {
      salary: salary,
      timestamp: Date.now()
    };
    localStorage.setItem('salariesCache', JSON.stringify(salariesCache));
  } catch (e) {
    console.warn(`Не удалось сохранить оклад для "${employee}" в localStorage:`, e);
  }
}

// Функция загрузки оклада из localStorage
function tryLoadSalaryFromStorage(employee) {
  try {
    const salariesCache = JSON.parse(localStorage.getItem('salariesCache') || '{}');
    const cached = salariesCache[employee];
    
    if (cached) {
      // Проверяем что данные не старше 24 часов
      const maxAge = 24 * 60 * 60 * 1000; // 24 часа
      if (Date.now() - cached.timestamp < maxAge) {
        return cached.salary;
      }
    }
  } catch (e) {
    console.warn(`Ошибка при загрузке оклада "${employee}" из localStorage:`, e);
  }
  return null;
}

// Предзагрузка оклада для текущего пользователя
function preloadCurrentUserSalary() {
  const currentUser = localStorage.getItem("currentUser");
  if (currentUser) {
    // Предзагружаем оклад из localStorage
    const cachedSalary = tryLoadSalaryFromStorage(currentUser);
    if (cachedSalary !== null) {
      dataCache.salaries[currentUser] = {
        salary: cachedSalary,
        timestamp: Date.now() - 1000 // Чуть старше для фонового обновления
      };
  
      
      // Обновляем в фоне
      setTimeout(() => {
        fetchSalaryFromServer(currentUser);
      }, 2000);
    }
  }
}

// Функция "умного" заполнения поля оклада
function smartFillSalaryField() {
  const currentUser = localStorage.getItem("currentUser");
  const salaryInput = document.getElementById("profileSalary");
  
  if (!currentUser || !salaryInput) return;
  
  // Проверяем есть ли оклад в кэше
  const cached = dataCache.salaries[currentUser];
  if (cached && (Date.now() - cached.timestamp) < CACHE_DURATION) {
    salaryInput.value = cached.salary;

    return;
  }
  
  // Проверяем localStorage
  const localSalary = tryLoadSalaryFromStorage(currentUser);
  if (localSalary !== null) {
    salaryInput.value = localSalary;

    
    // Обновляем кэш и проверяем актуальность в фоне
    dataCache.salaries[currentUser] = {
      salary: localSalary,
      timestamp: Date.now() - 1000
    };
    
    setTimeout(() => {
      fetchSalaryFromServer(currentUser).then(newSalary => {
        if (newSalary && newSalary !== localSalary) {
          salaryInput.value = newSalary;
      
        }
      });
    }, 1000);
  }
}

// 🚀 Предзагрузка убрана - будет выполнена в DOMContentLoaded
// preloadPackingModels(); // УБРАНО: дублировало загрузку

function openUpdateAllModal() {
  // Очистка
  document.getElementById("updateAllResult").textContent = "";
  document.getElementById("updateAllModal").style.display = "flex";
  // Установка дат по умолчанию (последние 7 дней)
  const today = new Date();
  const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
  document.getElementById("updateAllStart").value = weekAgo.toISOString().split("T")[0];
  document.getElementById("updateAllEnd").value = today.toISOString().split("T")[0];
}

function closeUpdateAllModal() {
  document.getElementById("updateAllModal").style.display = "none";
}

// Функции управления чекбоксами выбора обновлений
function selectAllUpdates() {
  document.getElementById("updateSeniorsSalary").checked = true;
  document.getElementById("updateStaffIndicators").checked = true;
  document.getElementById("updateOutsourcingIndicators").checked = true;
}

function selectNoneUpdates() {
  document.getElementById("updateSeniorsSalary").checked = false;
  document.getElementById("updateStaffIndicators").checked = false;
  document.getElementById("updateOutsourcingIndicators").checked = false;
}

function selectOnlySeniors() {
  document.getElementById("updateSeniorsSalary").checked = true;
  document.getElementById("updateStaffIndicators").checked = false;
  document.getElementById("updateOutsourcingIndicators").checked = false;
}

// Новая функция выборочного обновления
async function submitSelectiveUpdate() {
  const btn = document.getElementById("submitUpdateAllBtn");
  const resultBox = document.getElementById("updateAllResult");

  // Блокировка кнопки и индикатор
  btn.disabled = true;
  const originalText = btn.textContent;
  btn.textContent = "⏳ Обновление...";
  resultBox.textContent = "";

  const start = document.getElementById("updateAllStart").value;
  const end = document.getElementById("updateAllEnd").value;

  if (!start || !end) {
    resultBox.textContent = "❗ Укажите обе даты!";
    btn.disabled = false;
    btn.textContent = originalText;
    return;
  }

  // Проверяем что выбрано для обновления
  const updateSeniors = document.getElementById("updateSeniorsSalary").checked;
  const updateStaff = document.getElementById("updateStaffIndicators").checked;
  const updateOutsourcing = document.getElementById("updateOutsourcingIndicators").checked;

  if (!updateSeniors && !updateStaff && !updateOutsourcing) {
    resultBox.textContent = "❗ Выберите хотя бы один компонент для обновления!";
    btn.disabled = false;
    btn.textContent = originalText;
    return;
  }

  try {
    let resultMessage = "🚀 Начинаю выборочное обновление...\n\n";
    resultBox.textContent = resultMessage;
    
    // 1. Обновляем зарплату старших смен (если выбрано)
    if (updateSeniors) {
      resultBox.textContent = resultMessage + "🔄 Обновление зарплаты старших смен...";
      
      const seniorsResponse = await fetch(`${scriptURL}`, {
        method: 'POST',
        body: new URLSearchParams({
          type: 'processAllSeniorsForPeriod',
          start: start,
          end: end
        })
      });
      const seniorsData = await seniorsResponse.json();
      
      if (seniorsData.status === 'success') {
        resultMessage += `✅ Старшие смены: обработано ${seniorsData.processedCount || 0} записей\n`;
      } else {
        resultMessage += `⚠️ Старшие смены: ${seniorsData.message || 'ошибка'}\n`;
      }
    } else {
      resultMessage += "⏭️ Зарплаты старших смен: пропущено\n";
    }
    
    // 2. Обновляем показатели (если выбрано что-то из показателей)
    if (updateStaff || updateOutsourcing) {
      resultBox.textContent = resultMessage + "🔄 Обновление показателей...";
      
      // Определяем тип обновления на основе выбранных чекбоксов
      let updateType = "";
      if (updateStaff && updateOutsourcing) {
        updateType = "both"; // обновляем и штат и аутсорсинг
      } else if (updateStaff) {
        updateType = "staff"; // только штат
      } else if (updateOutsourcing) {
        updateType = "outsourcing"; // только аутсорсинг
      }
      
      const exportResponse = await fetch(`${scriptURL}?type=exportNow&date=${encodeURIComponent(start)}&endDate=${encodeURIComponent(end)}&components=${updateType}`);
      const exportResult = await exportResponse.text();
      
      if (exportResult.includes("✅")) {
        if (updateStaff && updateOutsourcing) {
          resultMessage += "✅ Показатели штата и аутсорсинга обновлены\n";
        } else if (updateStaff) {
          resultMessage += "✅ Показатели штатных сотрудников обновлены\n";
        } else if (updateOutsourcing) {
          resultMessage += "✅ Показатели аутсорсинга обновлены\n";
        }
      } else {
        resultMessage += `⚠️ Показатели: ${exportResult}\n`;
      }
    } else {
      resultMessage += "⏭️ Показатели: пропущено\n";
    }
    
    resultBox.style.color = '#059669';
    resultBox.textContent = resultMessage + "\n🎉 Выборочное обновление завершено!";
    
    setTimeout(closeUpdateAllModal, 5000);
    
  } catch (err) {
    console.error(err);
    resultBox.style.color = '#dc2626';
    resultBox.textContent = "❌ Ошибка при обновлении данных: " + err.message;
  } finally {
    btn.disabled = false;
    btn.textContent = originalText;
  }
}

// Старая функция для обратной совместимости
async function submitUpdateAll() {
  // Выбираем все компоненты и запускаем выборочное обновление
  selectAllUpdates();
  await submitSelectiveUpdate();
}

// ========== 👨‍🎓 ФУНКЦИИ УПРАВЛЕНИЯ СТАЖЕРАМИ ==========

function showTraineeManagement() {
  // Скрываем все другие контейнеры
  document.getElementById("profileContainer").style.display = "none";
  document.getElementById("appContainer").style.display = "none";
  document.getElementById("statsContainer").style.display = "none";
  document.getElementById("adminContainer").style.display = "none";
  document.getElementById("mySalaryContainer").style.display = "none";
  document.getElementById("ratesContainer").style.display = "none";
  document.getElementById("costAnalysisContainer").style.display = "none";
  document.getElementById("duplicatesContainer").style.display = "none";
  document.getElementById("loginContainer").style.display = "none";
  
  // Показываем контейнер управления стажерами
  document.getElementById("traineeManagementContainer").style.display = "block";
  
  // Предзагружаем списки наставников и стажеров и текущие связи
  setTimeout(() => {
    loadMentorsAndTrainees();
    loadMentorshipPairs();
  }, 500);
}

function hideTraineeManagement() {
  document.getElementById("traineeManagementContainer").style.display = "none";
  
  // Возвращаемся к админ-панели
  if (currentUser && currentUserRole === "admin") {
    switchTab("admin");
  } else {
    switchTab("profile");
  }
}



async function loadMentorshipPairs() {
  const btn = document.getElementById("refreshPairsBtn");
  const container = document.getElementById("mentorshipPairsList");
  
  try {
    btn.disabled = true;
    btn.textContent = "⏳ Загрузка...";
    
    // Получаем данные из справочника пользователей
    const response = await fetch(`${scriptURL}?type=employees`);
    const data = await response.json();
    

    
    if (!data.employees) {
      container.innerHTML = '<p style="color: #dc2626;">❌ Ошибка загрузки данных</p>';
      return;
    }
    
    // Фильтруем только пользователей со связями наставничества
    const pairs = [];
    const mentorTraineePairs = new Map();
    
    data.employees.forEach(employee => {
      if (employee.mentor && employee.mentor.trim()) {
        const mentor = employee.mentor.trim();
        const trainee = employee.name.trim();
        const status = employee.status || "";
        
        // Создаем пару наставник -> стажер
        if (status === "Стажер") {
          const pairKey = `${mentor} → ${trainee}`;
          mentorTraineePairs.set(pairKey, {
            mentor: mentor,
            trainee: trainee,
            status: status,
            bonusPercent: employee.bonusPercent || 0 // Процент из колонки G
          });
        }
      }
    });
    
    if (mentorTraineePairs.size === 0) {
      container.innerHTML = `
        <div style="text-align: center; padding: 40px; color: #000000;">
          <div style="font-size: 48px; margin-bottom: 16px;">👨‍🎓</div>
          <h3 style="margin: 0 0 8px 0;">Связи наставничества не найдены</h3>
          <p style="margin: 0;">Создайте первую связь во вкладке "Создать связь"</p>
        </div>
      `;
      return;
    }
    
    let html = '';
    mentorTraineePairs.forEach((pair, pairKey) => {
      html += `
        <div class="mentor-pair-card">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-weight: 600; color: #000000;">👨‍💼 ${pair.mentor} → 👨‍🎓 ${pair.trainee}</div>
              <div style="font-size: 14px; color: #000000; margin-top: 4px;">
                Статус: ${pair.status}
              </div>
            </div>
            <button onclick="deleteMentorshipPair('${pair.mentor}', '${pair.trainee}')" 
                    style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
              🗑️ Удалить
            </button>
          </div>
        </div>
      `;
    });
    
    container.innerHTML = html;
    
  } catch (error) {
    console.error("Ошибка загрузки связей:", error);
    container.innerHTML = '<p style="color: #dc2626;">❌ Ошибка загрузки связей</p>';
  } finally {
    btn.disabled = false;
    btn.textContent = "🔄 Обновить список";
  }
}

// Загрузка данных для создания связи
async function loadMentorsAndTrainees() {
  try {
    // Загружаем наставников
    const mentorsResponse = await fetch(`${scriptURL}?type=getMentors`);
      const mentorsData = await mentorsResponse.json();
    const mentors = mentorsData.mentors || [];
    
    // Загружаем стажеров
    const traineesResponse = await fetch(`${scriptURL}?type=getTrainees`);
    const traineesData = await traineesResponse.json();
    const trainees = traineesData.trainees || [];
    
    // Обновляем селекты
    updateSelect('mentorSelect', mentors, '-- Выберите наставника --');
    updateSelect('traineeSelect', trainees, '-- Выберите стажера --');
    
  } catch (error) {
    console.error("Ошибка загрузки данных:", error);
    alert("Ошибка загрузки данных");
  }
}



// Кэш настроек
let settingsCache = null;
let settingsCacheTimestamp = 0;
const SETTINGS_CACHE_DURATION = 5 * 60 * 1000; // 5 минут

// Получение настроек с сервера (с кэшированием)
async function getSettings() {
  // Проверяем кэш
  if (settingsCache && (Date.now() - settingsCacheTimestamp) < SETTINGS_CACHE_DURATION) {
    return settingsCache;
  }
  
  try {
    const response = await fetch(`${scriptURL}?type=getSettings`);
    const data = await response.json();
    
    // Сохраняем в кэш
    settingsCache = data;
    settingsCacheTimestamp = Date.now();
    
    return data;
  } catch (error) {
    console.error("Ошибка получения настроек:", error);
    return {}; // Настройки по умолчанию
  }
}

// Получение информации о наставнике стажера
async function getMentorInfo(traineeName) {
  try {
    const response = await fetch(`${scriptURL}?type=employees`);
    const data = await response.json();
    

    
    if (data.employees) {
      const trainee = data.employees.find(emp => emp.name === traineeName);


      
      if (trainee && trainee.mentor && trainee.status === "Стажер") {
        const result = {
          mentor: trainee.mentor,
          status: trainee.status,
          bonusPercent: trainee.bonusPercent || 0 // Процент бонуса из колонки G
        };


        return result;
      }
    }
    return null;
  } catch (error) {
    console.error("Ошибка получения информации о наставнике:", error);
    return null;
  }
}

// Расчет зарплаты за операцию
function calculateOperationWage(formData) {
  const quantity = parseFloat(formData.get("quantity")) || 0;
  const operationType = formData.get("operationType");
  const volume = formData.get("volume");
  const setNumber = formData.get("setNumber");
  
  const key = (operationType && operationType.includes("Сборка")) ? setNumber : volume;
  
  // Находим тариф в справочнике
  const matched = allRates.find(r => r.operation === operationType && r.key === key);
  
  if (matched) {
    // Используем ту же логику, что и в updateRateDisplay
    const packingModel = (document.getElementById("profilePackingModel")?.value || "").toLowerCase();
    const payType = localStorage.getItem("profilePayType") || "Сделка";
    let ratePerUnit = 0;

    if (payType === "Оклад + сделка") {
      if (packingModel.includes("fbs") && matched.rateFBSDeal !== undefined) {
        ratePerUnit = Number(matched.rateFBSDeal);
      } else if (matched.rateDeal !== undefined) {
        ratePerUnit = Number(matched.rateDeal);
      }
    } else {
      if (packingModel.includes("fbs") && matched.rateFBS !== undefined) {
        ratePerUnit = Number(matched.rateFBS);
      } else if (matched.ratePerUnit !== undefined) {
        ratePerUnit = Number(matched.ratePerUnit);
      }
    }
    
    return quantity * ratePerUnit;
  }
  
  return 0;
}



// Обновление селекта
function updateSelect(selectId, dataArray, placeholder) {
  const select = document.getElementById(selectId);
  if (!select) return;
  
  // Сохраняем текущее значение
  const currentValue = select.value;
  
  // Очищаем селект
  select.innerHTML = '';
  
  // Добавляем placeholder
  const placeholderOption = document.createElement('option');
  placeholderOption.value = '';
  placeholderOption.textContent = placeholder;
  select.appendChild(placeholderOption);
  
  // Добавляем данные
  dataArray.forEach(item => {
    const option = document.createElement('option');
    option.value = item;
    option.textContent = item;
    select.appendChild(option);
  });
  
  // Восстанавливаем значение, если оно все еще существует в новом списке
  if (currentValue && dataArray.includes(currentValue)) {
    select.value = currentValue;
  }
}



// ПРОСТАЯ ФУНКЦИЯ СОЗДАНИЯ СВЯЗИ
async function createMentorshipPair() {
  const mentor = document.getElementById("mentorSelect").value;
  const trainee = document.getElementById("traineeSelect").value;
  
  if (!mentor || !trainee) {
    alert("Выберите наставника и стажера");
    return;
  }
  
  if (mentor === trainee) {
    alert("Наставник и стажер не могут быть одним человеком");
    return;
  }
  
  try {
    const formData = new FormData();
    formData.append('currentUser', mentor);
    formData.append('partner', trainee);
    formData.append('status', 'Штат');
    formData.append('bonusPercent', '0'); // Фиксированный бонус 1750₽ за смену
    

    
    const response = await fetch(`${scriptURL}?type=savePair`, {
      method: 'POST',
      body: formData
    });
    
    const data = await response.json();
    

    
    if (data.success) {
      alert(`✅ Связь создана: ${mentor} ↔ ${trainee}\n💰 Наставник будет получать 1750₽ за смену`);
      
      // Обновляем список связей и выпадающие списки
      await loadMentorshipPairs();
      await loadMentorsAndTrainees();
      
      // Автоматически обновляем профили затронутых пользователей
      await updateAffectedProfiles(mentor, trainee);
      
    } else {
      alert(`❌ Ошибка: ${data.message}`);
    }
    
  } catch (error) {
    console.error("Ошибка:", error);
    alert("Ошибка сети");
  }
}

// Обновление профилей затронутых пользователей
async function updateAffectedProfiles(mentor, trainee) {
  const currentUser = localStorage.getItem("currentUser");
  
  // Если текущий пользователь - один из затронутых, обновляем его профиль
  if (currentUser === mentor || currentUser === trainee) {
    await updateProfileFromServer();
  }
}

async function deleteMentorshipPair(mentor, trainee) {
  if (!confirm(`❓ Удалить связь между ${mentor} и ${trainee}?`)) {
    return;
  }
  
  try {
    const formData = new FormData();
    formData.append('currentUser', mentor);
    formData.append('partner', ''); // Пустая строка для удаления связи
    formData.append('status', 'Штат');
    

    
    const response = await fetch(`${scriptURL}?type=savePair`, {
      method: 'POST', 
      body: formData
    });
    
    const data = await response.json();
    

    
    if (data.success) {
      alert(`✅ Связь удалена: ${mentor} ↔ ${trainee}`);
      
      // Обновляем список связей и выпадающие списки
      await loadMentorshipPairs();
      await loadMentorsAndTrainees();
      
      // Автоматически обновляем профили затронутых пользователей
      await updateAffectedProfiles(mentor, trainee);
      
    } else {
      alert(`❌ Ошибка удаления: ${data.message}`);
    }
    
  } catch (error) {
    console.error("Ошибка удаления связи:", error);
    alert("❌ Ошибка сети при удалении связи");
  }
}

async function loadTraineeAnalytics() {
  const startDate = document.getElementById("analyticsStartDate").value;
  const endDate = document.getElementById("analyticsEndDate").value;
  const container = document.getElementById("traineeAnalyticsResults");
  const btn = document.getElementById("loadAnalyticsBtn");
  
  if (!startDate || !endDate) {
    container.innerHTML = '<p style="color: #dc2626;">❗ Выберите период для анализа</p>';
    return;
  }
  
  try {
    btn.disabled = true;
    btn.textContent = "⏳ Загрузка...";
    
    const response = await fetch(`${scriptURL}?type=mentorshipAnalytics&startDate=${startDate}&endDate=${endDate}`);
    const data = await response.json();
    
    if (data.error) {
      container.innerHTML = `<p style="color: #dc2626;">❌ ${data.error}</p>`;
      return;
    }
    
    if (!data.analytics || data.analytics.length === 0) {
              container.innerHTML = '<p style="color: #000000;">📊 Нет данных за выбранный период</p>';
      return;
    }
    
    let html = '<div style="display: grid; gap: 16px;">';
    
    data.analytics.forEach(pair => {
      html += `
        <div class="analytics-card">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
            <div style="font-weight: 600; color: #374151;">
              👨‍💼 ${pair.mentor} → 👨‍🎓 ${pair.trainee}
            </div>
            <div style="text-align: right;">
              <div style="font-size: 14px; color: #000000;">Рабочих дней: ${pair.workingDays}</div>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
            <div style="text-align: center; padding: 8px; background: #f3f4f6; border-radius: 6px;">
              <div style="font-size: 18px; font-weight: 600; color: #3b82f6;">${pair.totalQuantity}</div>
              <div style="font-size: 12px; color: #000000;">Общее количество</div>
            </div>
            <div style="text-align: center; padding: 8px; background: #f3f4f6; border-radius: 6px;">
              <div style="font-size: 18px; font-weight: 600; color: #10b981;">${pair.totalOperations}</div>
              <div style="font-size: 12px; color: #000000;">Операций</div>
            </div>
            <div style="text-align: center; padding: 8px; background: #f3f4f6; border-radius: 6px;">
              <div style="font-size: 18px; font-weight: 600; color: #f59e0b;">${pair.avgQuantityPerDay}</div>
              <div style="font-size: 12px; color: #000000;">В день (среднее)</div>
            </div>
          </div>
        </div>
      `;
    });
    
    html += '</div>';
    container.innerHTML = html;
    
  } catch (error) {
    console.error("Ошибка загрузки аналитики:", error);
    container.innerHTML = '<p style="color: #dc2626;">❌ Ошибка загрузки аналитики</p>';
  } finally {
    btn.disabled = false;
    btn.textContent = "📊 Загрузить аналитику";
  }
}



async function cleanupAllMentorshipPairs(execute = false) {
  const container = document.getElementById("cleanupResults");
  const previewBtn = document.getElementById("previewCleanupBtn");
  const executeBtn = document.getElementById("executeCleanupBtn");
  
  if (execute && !confirm("❓ Вы УВЕРЕНЫ, что хотите удалить ВСЕ связи наставничества?\n\nЭта операция необратима!")) {
    return;
  }
  
  try {
    const btn = execute ? executeBtn : previewBtn;
    btn.disabled = true;
    btn.textContent = execute ? "⏳ Очистка..." : "⏳ Анализ...";
    
    container.style.display = "block";
    container.innerHTML = execute ? 
              '<p style="color: #000000;">🧹 Выполняется очистка всех связей...</p>' :
        '<p style="color: #000000;">🔍 Анализируются связи для очистки...</p>';
    
    if (execute) {
      // Выполняем реальную очистку через сервер
      const response = await fetch(`${scriptURL}?type=cleanupAllMentorships`);
      const data = await response.json();
      
      if (data.success) {
        container.innerHTML = `
          <div style="color: #059669; background: #d1fae5; padding: 12px; border-radius: 6px;">
            <h4 style="margin: 0 0 8px 0;">✅ Очистка выполнена</h4>
            <p style="margin: 0;">Удалено связей: ${data.clearedCount}</p>
          </div>
        `;
        
        // Обновляем список связей если он открыт
        if (document.getElementById("traineeSection-pairs").style.display !== "none") {
          setTimeout(() => loadMentorshipPairs(), 1000);
        }
      } else {
        container.innerHTML = `
          <div style="color: #dc2626; background: #fee2e2; padding: 12px; border-radius: 6px;">
            <h4 style="margin: 0 0 8px 0;">❌ Ошибка очистки</h4>
            <p style="margin: 0;">${data.error}</p>
          </div>
        `;
      }
    } else {
      // Предварительный просмотр - получаем текущие связи
      const response = await fetch(`${scriptURL}?type=employees`);
      const data = await response.json();
      
      let pairsCount = 0;
      if (data.employees) {
        // Подсчитываем количество связей (упрощенно)
        data.employees.forEach(emp => {
          if (emp.mentor && emp.mentor.trim()) {
            pairsCount++;
          }
        });
      }
      
      container.innerHTML = `
        <div style="color: #3b82f6; background: #dbeafe; padding: 12px; border-radius: 6px;">
          <h4 style="margin: 0 0 8px 0;">🔍 Предварительный просмотр</h4>
          <p style="margin: 0;">Найдено связей для очистки: ${pairsCount}</p>
          <p style="margin: 8px 0 0 0; font-size: 14px; opacity: 0.8;">
            ${pairsCount > 0 ? 'Будут удалены ВСЕ связи наставничества.' : 'Связи для очистки не найдены.'}
          </p>
        </div>
      `;
    }
    
  } catch (error) {
    console.error("Ошибка очистки:", error);
    container.innerHTML = '<p style="color: #dc2626;">❌ Ошибка сети при очистке связей</p>';
  } finally {
    const btn = execute ? executeBtn : previewBtn;
    btn.disabled = false;
    btn.textContent = execute ? "🧹 Выполнить очистку" : "🔍 Предварительный просмотр";
  }
}

function showResult(container, message, type) {
  container.style.display = "block";
  container.textContent = message;
  
  if (type === "success") {
    container.style.background = "#d1fae5";
    container.style.color = "#065f46";
    container.style.borderColor = "#10b981";
  } else if (type === "error") {
    container.style.background = "#fee2e2";
    container.style.color = "#991b1b";
    container.style.borderColor = "#ef4444";
  }
  
  container.style.border = "1px solid";
  
  // Автоматически скрываем через 5 секунд для успешных операций
  if (type === "success") {
    setTimeout(() => {
      container.style.display = "none";
    }, 5000);
  }
}





// ========== 📊 ФУНКЦИИ РАБОТЫ С БОНУСОМ НАСТАВНИКА ==========

    // Бонус наставника теперь фиксированный (1750₽ за смену)
// Функция parseMentorInfo больше не нужна

async function runCustomReport() {
  withLoading("reportBtn", async () => {
    const start = document.getElementById("unifiedStart").value;
const end = document.getElementById("unifiedEnd").value;

    if (!start || !end) {
      alert("⚠️ Укажите начало и конец периода");
      return;
    }

    try {
      const res = await fetch(`${scriptURL}?type=weeklyReport&start=${start}&end=${end}`);
      const text = await res.text();

      alert(text || "✅ Отчёт успешно сформирован");
    } catch (err) {
      alert("❌ Ошибка при формировании отчёта: " + err.message);
    }
  });
}

async function analyzePackers() {
  const start = document.getElementById("unifiedStart").value;
  const end = document.getElementById("unifiedEnd").value;
  const container = document.getElementById("reportContainer");

  if (!start || !end) {
    container.innerHTML = "<p style='color:red;'>⚠️ Укажите период для анализа</p>";
    return;
  }

  container.innerHTML = "<p>⌛ Загрузка отчёта по упаковщикам...</p>";

  try {
    const res = await fetch(`${scriptURL}?type=packerAnalytics&start=${start}&end=${end}`);
    const json = await res.json();

    if (!json.ok) {
      container.innerHTML = "<p style='color:red;'>❌ Ошибка при загрузке данных</p>";
      return;
    }

    const { list, best, totalNormsMet, totalNormsTotal, totalNormsPercent } = json;

    const rows = list.map(row => {
      let style = "";
      if (row.name === best.name) style = "background:#fef9c3;";          // 🟨 лучший по количеству
      if (row.name === best.bestEffName) style = "background:#d1fae5;";   // 🟩 лучший по эффективности
      if (row.name === best.worstEffName) style = "background:#fee2e2;"; // 🟥 худший по эффективности

      // Для нормы
      const met = Number(row.normsMet);
      const total = Number(row.normsTotal);
      const percent = total > 0 ? Math.round((met / total) * 100) : 0;
      let normIcon = "⚠️";
      if (total === 0) normIcon = "—";
      else if (percent >= 85) normIcon = "✅";
      else if (percent > 0) normIcon = "⚠️";

      return `
        <tr style="${style}">
          <td>${row.name}</td>
          <td>${row.qty}</td>
          <td>${row.efficiency}%</td>
          <td>${row.wage.toLocaleString("ru-RU")} ₽</td>
          <td>${met}/${total} (${percent}%) ${normIcon}</td>
        </tr>
      `;
    }).join("");

    const table = `
      <h3>📊 Анализ упаковщиков</h3>
      <button class="danger" onclick="clearReports()" style="margin-bottom: 12px;">❌ Закрыть отчёт</button>
      <div class="table-scroll">
    <table border="1" cellpadding="6" style="border-collapse: collapse; width: 100%;">
        <thead style="background:#f3f4f6;">
          <tr>
            <th>Упаковщик</th>
            <th>Количество</th>
            <th>Эффективность</th>
            <th>Зарплата</th>
            <th>Нормы</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
      <br/>
      <p>
        🥇 <strong>Лучший по количеству:</strong> ${best.name} — ${best.qty} шт.<br/>
        💯 <strong>Лучший по эффективности:</strong> ${best.bestEffName} — ${best.bestEffValue}%<br/>
        🔻 <strong>Худший по эффективности:</strong> ${best.worstEffName} — ${best.worstEffValue}%
      </p>
      <div style="margin-top:16px; padding:10px; background:#f3f4f6; border-radius:8px; font-weight:500;">
        📊 <b>Итого по выполнению норм за смену:</b>
        <br>
        ${totalNormsMet}/${totalNormsTotal} (${totalNormsPercent}%)
      </div>
    `;

    container.innerHTML = table;

  } catch (err) {
    container.innerHTML = `<p style='color:red;'>Ошибка: ${err.message}</p>`;
  }
}


// 👇 Вспомогательная функция очистки отчётов
function clearReports() {
  const container = document.getElementById("reportContainer");
  container.innerHTML = "";
  isShiftStatsLoaded = false;
}



async function withLoading(buttonId, asyncCallback) {
  const btn = document.getElementById(buttonId);
  if (!btn) return;

  btn.classList.add("button-loading");
  btn.disabled = true;

  try {
    await asyncCallback();
  } catch (err) {
    console.error("Ошибка:", err);
    throw err;
  } finally {
    btn.classList.remove("button-loading");
    btn.disabled = false;
  }
}

async function loadAllDictionariesInBackground() {
      try {
        await Promise.all([
          loadVolumes(),
          loadOperations(),
          loadSetNumbers(),
          loadTodayRecords(),
          loadOperationFilter(),
          loadRatesTable()
          // loadPackingModels() убран - загружается отдельно при входе
        ]);


        document.getElementById("operationFilter").addEventListener("change", loadStats);
      } catch (err) {
        console.warn("⚠️ Ошибка фоновой загрузки:", err.message);
      }
    }

function toggleReport(id, contentHtml) {
  const container = document.getElementById("reportContainer");
  const existing = container.querySelector(`.report[data-id='${id}']`);

  if (existing) {
    existing.remove(); // 💯 Повторное нажатие — отчёт закрывается
  } else {
    const wrapper = document.createElement("div");
    wrapper.classList.add("report");
    wrapper.dataset.id = id;
    wrapper.innerHTML = contentHtml;
    container.appendChild(wrapper);
  }
}

function clearReports() {
  const container = document.getElementById("reportContainer");
  container.innerHTML = "";
  isShiftStatsLoaded = false;
}

async function loadShiftStats() {
  const start = document.getElementById("unifiedStart").value;
  const end = document.getElementById("unifiedEnd").value;
  const container = document.getElementById("reportContainer");

  if (!start || !end) {
    container.innerHTML = "<p style='color:red;'>⚠️ Укажите обе даты</p>";
    return;
  }

  container.innerHTML = "<p>⌛ Загрузка отчёта по сменам...</p>";

  try {
    const res = await fetch(`${scriptURL}?type=shiftStats&start=${start}&end=${end}`);
    const data = await res.json();

    if (!data || !data.data || !Array.isArray(data.data) || !data.data.length) {
      container.innerHTML = "<p style='text-align:center;'>Нет данных по выбранному периоду</p>";
      return;
    }

    container.innerHTML = "";

    const closeBtn = document.createElement("button");
    closeBtn.textContent = "❌ Закрыть отчёт";
    closeBtn.className = "danger";
    closeBtn.style.marginBottom = "12px";
    closeBtn.onclick = () => (container.innerHTML = "");
    container.appendChild(closeBtn);

    data.data.forEach(shiftBlock => {
  const shiftTitle = document.createElement("div");
  shiftTitle.innerHTML = `
    🕐 <strong>Смена:</strong> ${shiftBlock.shift}
    <br>📦 <strong>Переупаковано за смену:</strong> ${shiftBlock.total?.totalQty ?? 0} шт.
    <br>👨‍🔧 <strong>Штат:</strong> ${shiftBlock.staff?.totalQty ?? 0} шт. (${shiftBlock.staff?.employees?.length ?? 0} чел.)
    <br>👨‍🎓 <strong>Стажеры:</strong> ${shiftBlock.trainee?.totalQty ?? 0} шт. (${shiftBlock.trainee?.employees?.length ?? 0} чел.)
    <br>📄 <strong>Аутсорсинг:</strong> ${shiftBlock.outsource?.totalQty ?? 0} шт. (${shiftBlock.outsource?.employees?.length ?? 0} чел.)
  `;
  shiftTitle.style.marginTop = "16px";
  container.appendChild(shiftTitle);

      // === ВАЖНО: создаём table ===
      const table = document.createElement("table");
      table.style.width = "100%";
      table.style.borderCollapse = "collapse";
      table.style.marginTop = "10px";

      const thead = document.createElement("thead");
      thead.innerHTML = `
        <tr style="background:#f3f4f6;">
          <th style="padding:6px; border:1px solid #ccc;">Сотрудник</th>
          <th style="padding:6px; border:1px solid #ccc;">Кол-во</th>
          <th style="padding:6px; border:1px solid #ccc;">Эффективность</th>
          <th style="padding:6px; border:1px solid #ccc;">Нормы</th>
        </tr>
      `;
      table.appendChild(thead);

      const tbody = document.createElement("tbody");

      const staff = shiftBlock?.staff?.employees || [];
      const outsource = shiftBlock?.outsource?.employees || [];
      const trainee = shiftBlock?.trainee?.employees || [];

      if (staff.length) {
        const staffTitleRow = document.createElement("tr");
        staffTitleRow.innerHTML = `
          <td colspan="4" style="padding:6px; font-weight:bold; color:#1f2937;">
            👨‍🔧 Штат (${staff.length} чел., средняя эффективность: ${shiftBlock.staff.averageEfficiency}%)
          </td>
        `;
        tbody.appendChild(staffTitleRow);

        staff.forEach(emp => {
          const tr = document.createElement("tr");
          
          // Расчет данных о нормах
          const normsMet = emp.opsMet || 0;
          const normsTotal = emp.opsTotal || 0;
          const normsPercent = normsTotal > 0 ? Math.round((normsMet / normsTotal) * 100) : 0;
          
          // Определение иконки для норм
          let normIcon = "—";
          if (normsTotal === 0) normIcon = "—";
          else if (normsPercent >= 90) normIcon = "✅";
          else if (normsPercent >= 60) normIcon = "⚠️";
          else if (normsPercent > 0) normIcon = "❌";
          
          tr.innerHTML = `
            <td style="padding:6px; border:1px solid #ccc;">${emp.name}</td>
            <td style="padding:6px; border:1px solid #ccc;">${emp.quantity}</td>
            <td style="padding:6px; border:1px solid #ccc;">${emp.efficiency}%</td>
            <td style="padding:6px; border:1px solid #ccc;">${normsMet}/${normsTotal} (${normsPercent}%) ${normIcon}</td>
          `;
          tbody.appendChild(tr);
        });
      }

      if (trainee.length) {
        const traineeTitleRow = document.createElement("tr");
        traineeTitleRow.innerHTML = `
          <td colspan="4" style="padding:6px; font-weight:bold; color:#059669;">
            👨‍🎓 Стажеры (${trainee.length} чел., средняя эффективность: ${shiftBlock.trainee.averageEfficiency}%)
          </td>
        `;
        tbody.appendChild(traineeTitleRow);

        trainee.forEach(emp => {
          const tr = document.createElement("tr");
          
          // Расчет данных о нормах
          const normsMet = emp.opsMet || 0;
          const normsTotal = emp.opsTotal || 0;
          const normsPercent = normsTotal > 0 ? Math.round((normsMet / normsTotal) * 100) : 0;
          
          // Определение иконки для норм
          let normIcon = "—";
          if (normsTotal === 0) normIcon = "—";
          else if (normsPercent >= 90) normIcon = "✅";
          else if (normsPercent >= 60) normIcon = "⚠️";
          else if (normsPercent > 0) normIcon = "❌";
          
          tr.innerHTML = `
            <td style="padding:6px; border:1px solid #ccc;">${emp.name}</td>
            <td style="padding:6px; border:1px solid #ccc;">${emp.quantity}</td>
            <td style="padding:6px; border:1px solid #ccc;">${emp.efficiency}%</td>
            <td style="padding:6px; border:1px solid #ccc;">${normsMet}/${normsTotal} (${normsPercent}%) ${normIcon}</td>
          `;
          tbody.appendChild(tr);
        });
      }

      if (outsource.length) {
        const outTitleRow = document.createElement("tr");
        outTitleRow.innerHTML = `
          <td colspan="4" style="padding:6px; font-weight:bold; color:#6b21a8;">
            📄 Аутсорсинг (${outsource.length} чел., средняя эффективность: ${shiftBlock.outsource.averageEfficiency}%)
          </td>
        `;
        tbody.appendChild(outTitleRow);

        outsource.forEach(emp => {
          const tr = document.createElement("tr");
          
          // Расчет данных о нормах
          const normsMet = emp.opsMet || 0;
          const normsTotal = emp.opsTotal || 0;
          const normsPercent = normsTotal > 0 ? Math.round((normsMet / normsTotal) * 100) : 0;
          
          // Определение иконки для норм
          let normIcon = "—";
          if (normsTotal === 0) normIcon = "—";
          else if (normsPercent >= 90) normIcon = "✅";
          else if (normsPercent >= 60) normIcon = "⚠️";
          else if (normsPercent > 0) normIcon = "❌";
          
          tr.innerHTML = `
            <td style="padding:6px; border:1px solid #ccc;">${emp.name}</td>
            <td style="padding:6px; border:1px solid #ccc;">${emp.quantity}</td>
            <td style="padding:6px; border:1px solid #ccc;">${emp.efficiency}%</td>
            <td style="padding:6px; border:1px solid #ccc;">${normsMet}/${normsTotal} (${normsPercent}%) ${normIcon}</td>
          `;
          tbody.appendChild(tr);
        });
      }

      table.appendChild(tbody);

      // === Оборачиваем таблицу в scrollDiv ===
      const scrollDiv = document.createElement("div");
      scrollDiv.className = "table-scroll";
      scrollDiv.appendChild(table);
      container.appendChild(scrollDiv);

      // === Блок общей эффективности и норм (по текущей смене)
      const staffEff = shiftBlock?.staff?.averageEfficiency;
      const outsourceEff = shiftBlock?.outsource?.averageEfficiency;
      const overallEff = shiftBlock?.total?.overall;
      
      // Подсчет общих норм по смене
              const allEmployees = [...(shiftBlock?.staff?.employees || []), ...(shiftBlock?.outsource?.employees || []), ...(shiftBlock?.trainee?.employees || [])];
      const totalNormsMet = allEmployees.reduce((sum, emp) => sum + (emp.opsMet || 0), 0);
      const totalNormsTotal = allEmployees.reduce((sum, emp) => sum + (emp.opsTotal || 0), 0);
      const totalNormsPercent = totalNormsTotal > 0 ? Math.round((totalNormsMet / totalNormsTotal) * 100) : 0;
      
      // Определение иконки для общих норм
      let totalNormIcon = "—";
      if (totalNormsTotal === 0) totalNormIcon = "—";
      else if (totalNormsPercent >= 85) totalNormIcon = "✅";
      else if (totalNormsPercent >= 60) totalNormIcon = "⚠️";
      else if (totalNormsPercent > 0) totalNormIcon = "❌";
      
      // Для красивого отображения "—" если нет данных
      function effVal(val) {
        return (val === undefined || val === null) ? "—" : val + "%";
      }
      const footer = document.createElement("div");
      footer.style.marginTop = "12px";
      footer.style.padding = "12px";
      footer.style.background = "#ecfdf5";
      footer.style.borderRadius = "8px";
      footer.style.fontWeight = "500";
      footer.innerHTML = `
        📊 <b>Эффективность за смену:</b><br>
        👨‍🔧 Штат — ${effVal(staffEff)} |
        🤝 Аутсорсинг — ${effVal(outsourceEff)} |
        📦 Общая — ${effVal(overallEff)}<br><br>
        📋 <b>Выполнение норм за смену:</b><br>
        ${totalNormsMet}/${totalNormsTotal} (${totalNormsPercent}%) ${totalNormIcon}
      `;
      container.appendChild(footer);
    });

  } catch (err) {
    container.innerHTML = `<p style='color:red;'>Ошибка загрузки: ${err.message}</p>`;
  }
}

async function loadSeniorsReport() {
  clearReports(); // Очищаем предыдущие отчеты
  
  const start = document.getElementById("unifiedStart").value;
  const end = document.getElementById("unifiedEnd").value;
  const container = document.getElementById("reportContainer");

  if (!start || !end) {
    container.innerHTML = "<p style='color:red;'>⚠️ Укажите обе даты</p>";
    return;
  }

  container.innerHTML = "<p>⌛ Загрузка отчёта по старшим сменам...</p>";

  try {

    
    const res = await fetch(`${scriptURL}?type=seniorsReport&start=${start}&end=${end}`);
    
    
    if (!res.ok) {
      container.innerHTML = `<p style='color:red;'>❌ Ошибка HTTP: ${res.status} ${res.statusText}</p>`;
      return;
    }
    
    const data = await res.json();
    

    if (!data) {
      container.innerHTML = "<p style='color:red;'>❌ Сервер не вернул данные</p>";
      return;
    }

    if (data.status !== 'success') {
      container.innerHTML = `<p style='color:red;'>❌ Ошибка сервера: ${data.message || 'Неизвестная ошибка'}</p>`;
      return;
    }

    if (!data.data || !Array.isArray(data.data)) {
      container.innerHTML = "<p style='color:red;'>❌ Неверный формат данных от сервера</p>";
      return;
    }

    if (!data.data.length) {
      container.innerHTML = "<p style='text-align:center;'>📭 Нет данных по старшим сменам за выбранный период</p>";
      return;
    }

    container.innerHTML = "";

    const closeBtn = document.createElement("button");
    closeBtn.textContent = "❌ Закрыть отчёт";
    closeBtn.className = "danger";
    closeBtn.style.marginBottom = "12px";
    closeBtn.onclick = () => (container.innerHTML = "");
    container.appendChild(closeBtn);

    // Создаем заголовок отчета
    const reportTitle = document.createElement("div");
    reportTitle.innerHTML = `
      <h3 style="margin-top: 0; color: #8b5cf6;">👨‍💼 Анализ старших смен</h3>
              <p style="color: #000000; margin-bottom: 16px;">Период: ${start} — ${end}</p>
    `;
    container.appendChild(reportTitle);

    // Создаем таблицу
    const table = document.createElement("table");
    table.style.width = "100%";
    table.style.borderCollapse = "collapse";
    table.style.marginTop = "10px";

    const thead = document.createElement("thead");
    thead.innerHTML = `
      <tr style="background:#f3f4f6;">
        <th style="padding:8px; border:1px solid #d1d5db; text-align:left;">Дата</th>
        <th style="padding:8px; border:1px solid #d1d5db; text-align:left;">Смена</th>
        <th style="padding:8px; border:1px solid #d1d5db; text-align:left;">Старший смены</th>
        <th style="padding:8px; border:1px solid #d1d5db; text-align:center;">Эффективность</th>
        <th style="padding:8px; border:1px solid #d1d5db; text-align:center;">Выполнение нормы</th>
        <th style="padding:8px; border:1px solid #d1d5db; text-align:right;">Зарплата</th>
      </tr>
    `;
    table.appendChild(thead);

    const tbody = document.createElement("tbody");

    // Группируем данные по сменам
    const shiftsData = {};
    data.data.forEach(item => {
      const shiftKey = item.shift;
      if (!shiftsData[shiftKey]) {
        shiftsData[shiftKey] = [];
      }
      shiftsData[shiftKey].push(item);
    });

    // Сортируем смены
    const sortedShifts = Object.keys(shiftsData).sort();

    sortedShifts.forEach(shift => {
      const shiftItems = shiftsData[shift];
      
      // Заголовок смены
      const shiftHeader = document.createElement("tr");
      shiftHeader.innerHTML = `
        <td colspan="6" style="padding:8px; font-weight:bold; color:#8b5cf6; background:#f8f7ff; border:1px solid #d1d5db;">
          🕐 ${shift}
        </td>
      `;
      tbody.appendChild(shiftHeader);

      // Сортируем записи по дате
      shiftItems.sort((a, b) => new Date(a.date.split('.').reverse().join('-')) - new Date(b.date.split('.').reverse().join('-')));

      shiftItems.forEach(item => {
        const tr = document.createElement("tr");
        
        // Определяем цвет строки в зависимости от эффективности
        let rowStyle = "";
        if (item.efficiency >= 100) {
          rowStyle = "background:#ecfdf5;"; // Зеленый для высокой эффективности
        } else if (item.efficiency >= 90) {
          rowStyle = "background:#fef3c7;"; // Желтый для средней эффективности
        } else {
          rowStyle = "background:#fef2f2;"; // Красный для низкой эффективности
        }

        tr.innerHTML = `
          <td style="padding:8px; border:1px solid #d1d5db; ${rowStyle}">${item.date}</td>
          <td style="padding:8px; border:1px solid #d1d5db; ${rowStyle}">${item.shift}</td>
          <td style="padding:8px; border:1px solid #d1d5db; ${rowStyle}">${item.name}</td>
          <td style="padding:8px; border:1px solid #d1d5db; text-align:center; ${rowStyle}">
            <span style="font-weight:bold; color:${item.efficiency >= 100 ? '#059669' : item.efficiency >= 90 ? '#d97706' : '#dc2626'}">
              ${item.efficiency}%
            </span>
          </td>
          <td style="padding:8px; border:1px solid #d1d5db; text-align:center; ${rowStyle}">
            <span style="font-weight:bold; color:${item.norm >= 90 ? '#059669' : '#dc2626'}">
              ${item.norm}%
            </span>
          </td>
          <td style="padding:8px; border:1px solid #d1d5db; text-align:right; ${rowStyle}">
            <strong>${item.salary.toLocaleString('ru-RU')} ₽</strong>
          </td>
        `;
        tbody.appendChild(tr);
      });
    });

    table.appendChild(tbody);

    // Оборачиваем таблицу в scrollDiv
    const scrollDiv = document.createElement("div");
    scrollDiv.className = "table-scroll";
    scrollDiv.appendChild(table);
    container.appendChild(scrollDiv);

    // Добавляем сводку
    const totalSalary = data.data.reduce((sum, item) => sum + (item.salary || 0), 0);
    const avgEfficiency = data.data.reduce((sum, item) => sum + (item.efficiency || 0), 0) / data.data.length;
    const avgNorm = data.data.reduce((sum, item) => sum + (item.norm || 0), 0) / data.data.length;

    const summary = document.createElement("div");
    summary.style.marginTop = "16px";
    summary.style.padding = "16px";
    summary.style.background = "#f8f7ff";
    summary.style.borderRadius = "8px";
    summary.style.fontWeight = "500";
    summary.innerHTML = `
      📊 <b>Сводка по периоду:</b><br>
      👨‍💼 <strong>Всего смен:</strong> ${data.data.length} |
      💰 <strong>Общая зарплата:</strong> ${totalSalary.toLocaleString('ru-RU')} ₽ |
      📈 <strong>Средняя эффективность:</strong> ${Math.round(avgEfficiency)}% |
      ✅ <strong>Среднее выполнение нормы:</strong> ${Math.round(avgNorm)}%
    `;
    container.appendChild(summary);

  } catch (err) {
    container.innerHTML = `<p style='color:red;'>Ошибка загрузки: ${err.message}</p>`;
  }
}

// 📡 Проверка подключения к интернету
window.addEventListener('offline', () => {
  alert('📡 Нет подключения к интернету');
});
window.addEventListener('online', () => {
  alert('✅ Соединение восстановлено');
});
if ('serviceWorker' in navigator && window.location.protocol !== 'file:') {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/service-worker.js')
        .then(reg => {})
        .catch(err => console.error('❌ Ошибка регистрации SW:', err));
    });
  }

// ⏱ Автофокус при загрузке
window.addEventListener("DOMContentLoaded", () => {
  const loginInput = document.getElementById("login");
  if (loginInput) loginInput.focus();
});

// 🧼 Сброс ошибки при вводе
["login", "password"].forEach(id => {
  const input = document.getElementById(id);
  if (input) {
    input.addEventListener("input", () => {
      const error = document.getElementById("loginError");
      if (error) error.textContent = "";
    });
  }
});

// ⏎ Вход по нажатию Enter
document.getElementById("password").addEventListener("keydown", e => {
  if (e.key === "Enter") {
    handleLogin();
  }
});

// 🔄 Горячая клавиша для принудительного обновления кэша (Ctrl+Shift+R)
document.addEventListener("keydown", e => {
  if (e.ctrlKey && e.shiftKey && e.key === 'R') {
    e.preventDefault();
    clearCache();
    
    // Показываем уведомление пользователю
    const notification = document.createElement('div');
    notification.style.cssText = `
      position: fixed; top: 20px; right: 20px; z-index: 10000;
      background: #059669; color: white; padding: 12px 20px; border-radius: 8px;
      font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      animation: slideIn 0.3s ease-out;
    `;
    notification.textContent = '🔄 Кэш очищен! Данные будут перезагружены.';
    
    document.body.appendChild(notification);
    
    // Принудительно перезагружаем модели упаковки и оклад
    setTimeout(() => {
      isLoadingPackingModels = false; // Сбрасываем флаг перед принудительной загрузкой
      loadPackingModels();
      preloadCurrentUserSalary();
    }, 500);
    
    // Убираем уведомление через 3 секунды
    setTimeout(() => {
      notification.remove();
    }, 3000);
  }
});

function openSalaryExportModal() {
  // Очистка
  document.getElementById("salaryExportResult").textContent = "";
  document.getElementById("salaryExportModal").style.display = "flex";
  // Установка дат по умолчанию (сегодня)
  const today = new Date().toISOString().split("T")[0];
  document.getElementById("salaryExportStart").value = today;
  document.getElementById("salaryExportEnd").value = today;
  // Загрузка сотрудников и старших смен
  loadSalaryExportEmployees();
  loadSalaryExportSeniors();
}

function closeSalaryExportModal() {
  document.getElementById("salaryExportModal").style.display = "none";
}

// Функция для переключения видимости селекторов
function toggleEmployeeExportSelector() {
    const type = document.querySelector('input[name="exportType"]:checked').value;
    const packersSelector = document.getElementById("packersExportSelector");
    const seniorsSelector = document.getElementById("seniorsExportSelector");
    
    if (type === 'seniors') {
        packersSelector.style.display = 'none';
        seniorsSelector.style.display = 'block';
    } else {
        packersSelector.style.display = 'block';
        seniorsSelector.style.display = 'none';
    }
}

async function loadSalaryExportEmployees() {
  try {
    const res = await fetch(`${scriptURL}?type=employees`);
    const data = await res.json();

    const names = Array.from(new Set((data.employees || []))).sort();
    const select = document.getElementById("salaryExportEmployee");

    select.innerHTML = `<option value="">-- Все --</option>`;
    names.forEach(name => {
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      select.appendChild(opt);
    });
  } catch (err) {
    document.getElementById("salaryExportResult").textContent = "Ошибка загрузки сотрудников!";
    console.error("Ошибка при загрузке сотрудников:", err);
  }
}

// ========== ➕ ФУНКЦИИ УПРАВЛЕНИЯ СТАРШИМИ СМЕНАМИ ==========

// Функция для выбора типа смены (простая мобильная версия)
function selectMobileShift(shiftType, clickedButton) {
  // Убираем active класс у всех кнопок
  const allButtons = document.querySelectorAll('.shift-button');
  allButtons.forEach(btn => btn.classList.remove('active'));
  
  // Добавляем active класс к нажатой кнопке
  clickedButton.classList.add('active');
  
  // Сохраняем выбранный тип смены
  const hiddenInput = document.getElementById('selectedShiftType');
  if (hiddenInput) {
    hiddenInput.value = shiftType;
  }
  
  // Тактильная обратная связь для мобильных устройств
  if ('vibrate' in navigator) {
    navigator.vibrate(50); // Легкая вибрация 50ms
  }
  
  console.log('Выбран тип смены:', shiftType);
}

// Функция для получения выбранного типа смены
function getSelectedShiftType() {
  const hiddenInput = document.getElementById('selectedShiftType');
  return hiddenInput ? hiddenInput.value : 'День';
}

// Инициализация кнопок смены после загрузки формы
function initMobileShiftButtons() {
  const dayButton = document.querySelector('.shift-button:first-child');
  const hiddenInput = document.getElementById('selectedShiftType');
  
  if (dayButton && hiddenInput) {
    // Убеждаемся что кнопка "День" активна по умолчанию
    dayButton.classList.add('active');
    hiddenInput.value = 'День';
    console.log('Форма старшего смены инициализирована: День выбран по умолчанию');
  }
}

// Функция для управления выбором радиокнопок в компактной форме (старая версия для совместимости)
function updateRadioSelection(selectedLabel) {
  // Убираем класс selected у всех радиокнопок в группе
  const radioGroup = selectedLabel.closest('.radio-group');
  const allLabels = radioGroup.querySelectorAll('label');
  allLabels.forEach(label => label.classList.remove('selected'));
  
  // Добавляем класс selected к выбранной радиокнопке
  selectedLabel.classList.add('selected');
  
  // Отмечаем соответствующий input как checked
  const radioInput = selectedLabel.querySelector('input[type="radio"]');
  if (radioInput) {
    radioInput.checked = true;
  }
}

// Инициализация состояния радиокнопок при загрузке формы
function initRadioButtons() {
  // Проверяем новую структуру
  const dayInput = document.getElementById('dayShift');
  const nightInput = document.getElementById('nightShift');
  
  if (dayInput && nightInput) {
    // Новая структура - используем selectShiftType
    if (dayInput.checked) {
      selectShiftType('день');
    } else if (nightInput.checked) {
      selectShiftType('ночь');
    }
  } else {
    // Старая структура - используем старый метод
    const radioGroups = document.querySelectorAll('.radio-group');
    radioGroups.forEach(group => {
      const checkedInput = group.querySelector('input[type="radio"]:checked');
      if (checkedInput) {
        const parentLabel = checkedInput.closest('label');
        if (parentLabel) parentLabel.classList.add('selected');
      }
    });
  }
}

// Показать форму добавления старшего смены
async function showSeniorShiftForm() {
  clearReports(); // Очищаем предыдущие отчеты
  
  const container = document.getElementById("reportContainer");
  
  container.innerHTML = `
    <div class="senior-shift-form">
      <h3>👥 Добавить смену</h3>
      
      <div>
        <!-- Старший смены -->
        <div class="form-row">
          <div>
            <label for="seniorSelect">👨‍💼 Старший смены:</label>
            <select id="seniorSelect" required>
              <option value="">⌛ Загрузка списка...</option>
            </select>
          </div>
        </div>
        
        <!-- Помощник -->
        <div class="form-row">
          <div>
            <label for="helperSelect">👤 Помощник (необязательно):</label>
            <select id="helperSelect">
              <option value="">⌛ Загрузка списка...</option>
            </select>
          </div>
        </div>
        
        <!-- Тип смены -->
        <div class="form-row">
          <div>
            <label>🌅🌙 Тип смены:</label>
            <div class="shift-buttons">
              <button type="button" class="shift-button active" onclick="selectMobileShift('День', this)">
                🌅 День
              </button>
              <button type="button" class="shift-button" onclick="selectMobileShift('Ночь', this)">
                🌙 Ночь
              </button>
            </div>
            <input type="hidden" id="selectedShiftType" value="День">
          </div>
        </div>
        
        <!-- Дата -->
        <div class="form-row">
          <div>
            <label for="customDate">📅 Дата (необязательно):</label>
            <input type="date" id="customDate">
          </div>
        </div>
        
        <div class="info-text">
          💡 Дата определится автоматически по типу смены
        </div>
        
        <!-- Кнопки -->
        <div class="button-group">
          <button onclick="addSeniorShiftRecord()" id="addSeniorRecordBtn" 
                  style="background: #22c55e; color: white; border: none; cursor: pointer; touch-action: manipulation;">
            ➕ Добавить
          </button>
          <button onclick="clearReports()" 
                  style="background: #6b7280; color: white; border: none; cursor: pointer; touch-action: manipulation;">
            ❌ Отменить
          </button>
        </div>
        
        <!-- Результат -->
        <div id="seniorShiftResult"></div>
      </div>
    </div>
  `;
  
  // Загружаем список старших смен
  await loadSeniorsListForForm();
  
  // Инициализируем кнопки смены
  initMobileShiftButtons();
}

// Загрузка списка старших смен для формы из справочника
async function loadSeniorsListForForm() {
  try {
    const res = await fetch(`${scriptURL}?type=getSeniorsAndHelpers`);
    const data = await res.json();

    const seniorSelect = document.getElementById("seniorSelect");
    const helperSelect = document.getElementById("helperSelect");

    if (data.error) {
      console.error("Ошибка API:", data.error);
      seniorSelect.innerHTML = `<option value="">❌ ${data.error}</option>`;
      helperSelect.innerHTML = `<option value="">-- Без помощника --</option>`;
      return;
    }

    const seniors = data.seniors || [];
    const helpers = data.helpers || [];
    const pairs = data.pairs || [];

    if (seniors.length === 0) {
      seniorSelect.innerHTML = `<option value="">❌ Нет данных в справочнике</option>`;
      helperSelect.innerHTML = `<option value="">-- Без помощника --</option>`;
      return;
    }

    // Заполняем список старших смен
    seniorSelect.innerHTML = `<option value="">-- Выберите старшего смены --</option>`;
    seniors.forEach(senior => {
      const opt = document.createElement("option");
      opt.value = senior;
      opt.textContent = senior;
      seniorSelect.appendChild(opt);
    });

    // Заполняем список помощников (уникальный список помощников + опция без помощника)
    helperSelect.innerHTML = `<option value="">-- Без помощника --</option>`;
    helpers.forEach(helper => {
      const opt = document.createElement("option");
      opt.value = helper;
      opt.textContent = helper;
      helperSelect.appendChild(opt);
    });

    // Сохраняем данные о парах для автоматического выбора
    window.seniorHelperPairs = pairs;

    // Добавляем обработчик для автоматического выбора помощника
    seniorSelect.addEventListener('change', function() {
      const selectedSenior = this.value;
      if (selectedSenior && window.seniorHelperPairs) {
        const pair = window.seniorHelperPairs.find(p => p.senior === selectedSenior);
        if (pair && pair.helper) {
          helperSelect.value = pair.helper;
          console.log(`🤖 Автоматически выбран помощник: ${pair.helper} для ${selectedSenior}`);
        } else {
          helperSelect.value = "";
        }
      }
    });

    console.log(`✅ Загружено: ${seniors.length} старших, ${helpers.length} помощников, ${pairs.length} пар`);
  } catch (err) {
    const seniorSelect = document.getElementById("seniorSelect");
    const helperSelect = document.getElementById("helperSelect");
    seniorSelect.innerHTML = `<option value="">❌ Ошибка загрузки справочника</option>`;
    helperSelect.innerHTML = `<option value="">-- Без помощника --</option>`;
    console.error("Ошибка при загрузке справочника старших смен:", err);
  }
}

// Добавление записи старшего смены
async function addSeniorShiftRecord() {
  const btn = document.getElementById("addSeniorRecordBtn");
  const resultBox = document.getElementById("seniorShiftResult");
  
  // Получаем данные из формы
  const seniorName = document.getElementById("seniorSelect").value.trim();
  const helperName = document.getElementById("helperSelect").value.trim();
  const shiftType = getSelectedShiftType(); // Используем новую функцию для мобильной версии
  const customDate = document.getElementById("customDate").value;
  
  // Валидация
  if (!seniorName) {
    resultBox.style.color = '#dc2626';
    resultBox.textContent = "❌ Выберите старшего смены";
    return;
  }
  
  if (helperName && seniorName === helperName) {
    resultBox.style.color = '#dc2626';
    resultBox.textContent = "❌ Старший смены и помощник должны быть разными людьми";
    return;
  }
  
  // Блокировка кнопки
  btn.disabled = true;
  const originalText = btn.textContent;
  btn.textContent = "⏳ Добавление...";
  resultBox.textContent = "";
  
  try {
    // Создаем запрос для добавления старшего смены через специальный endpoint
    const params = new URLSearchParams({
      type: 'addSeniorShift',
      seniorName: seniorName,
      helperName: helperName || '',
      shiftType: shiftType
    });
    
    if (customDate) {
      params.append('shiftDate', customDate);
    }
    
    const response = await fetch(`${scriptURL}?${params}`, {
      method: 'GET'
    });
    
    const result = await response.json();
    
    if (result.status === 'success') {
      resultBox.style.color = '#22c55e';
      resultBox.textContent = result.message;
      
      // Очищаем форму при успехе
      document.getElementById("customDate").value = '';
      document.getElementById("seniorSelect").selectedIndex = 0;
      document.getElementById("helperSelect").selectedIndex = 0;
      document.querySelector('input[name="shiftType"][value="День"]').checked = true;
      
      console.log('✅ Записи успешно добавлены:', result.data);
    } else {
      resultBox.style.color = '#dc2626';
      resultBox.textContent = result.message || '❌ Ошибка при добавлении записей';
    }
    
  } catch (err) {
    resultBox.style.color = '#dc2626';
    resultBox.textContent = `❌ Ошибка: ${err.message}`;
    console.error("Ошибка при добавлении записей смены:", err);
  } finally {
    btn.disabled = false;
    btn.textContent = originalText;
  }
}

// Загрузка списка старших смен для селекта экспорта зарплаты
async function loadSalaryExportSeniors() {
  try {
    const res = await fetch(`${scriptURL}?type=getSeniorsAndHelpers`);
    const data = await res.json();

    const select = document.getElementById("salaryExportSenior");

    if (data.error) {
      select.innerHTML = `<option value="">❌ ${data.error}</option>`;
      return;
    }

    const seniors = data.seniors || [];

    select.innerHTML = `<option value="">-- Все --</option>`;
    seniors.forEach(senior => {
      const opt = document.createElement("option");
      opt.value = senior;
      opt.textContent = senior;
      select.appendChild(opt);
    });
    
    console.log(`✅ Загружено для экспорта: ${seniors.length} старших смен`);
  } catch (err) {
    document.getElementById("salaryExportResult").textContent = "Ошибка загрузки справочника старших смен!";
    console.error("Ошибка при загрузке справочника старших смен:", err);
  }
}

async function submitSalaryExport() {
  const btn = document.getElementById("submitSalaryExportBtn");
  const resultBox = document.getElementById("salaryExportResult");

  // Блокировка кнопки и индикатор
  btn.disabled = true;
  const originalText = btn.textContent;
  btn.textContent = "⏳ Отправка...";
  resultBox.textContent = "";

  const start = document.getElementById("salaryExportStart").value;
  const end = document.getElementById("salaryExportEnd").value;
  const exportType = document.querySelector('input[name="exportType"]:checked').value;

  if (!start || !end) {
    resultBox.textContent = "❗ Укажите обе даты!";
    btn.disabled = false;
    btn.textContent = originalText;
    return;
  }

  let scriptUrl = scriptURL;
  let fetchOptions = {};

  if (exportType === 'seniors') {
    // Для старших смен используем GET-запрос к exportSeniorsForAccounting
    const senior = document.getElementById("salaryExportSenior").value;
    const params = new URLSearchParams({
        type: "exportSeniorsForAccounting",
        start,
        end
    });
    if (senior) {
        params.append("seniors", senior);
    }
    scriptUrl = `${scriptURL}?${params.toString()}`;
  } else { 
    // Для упаковщиков используем GET-запрос к exportForAccounting
    const employee = document.getElementById("salaryExportEmployee").value;
    const params = new URLSearchParams({
        type: "exportForAccounting",
        start,
        end
    });
    if (employee) {
        params.append("employees", employee);
    }
    scriptUrl = `${scriptURL}?${params.toString()}`;
  }
  
  try {
    const res = await fetch(scriptUrl);
    const text = await res.text();
    
    resultBox.style.color = text.includes("✅") ? '#059669' : '#dc2626';
    resultBox.textContent = text;
    
    if (text.includes("✅")) {
        setTimeout(closeSalaryExportModal, 3000);
    }
  } catch (err) {
    console.error(err);
    resultBox.style.color = '#dc2626';
    resultBox.textContent = "❌ Ошибка при отправке запроса";
  } finally {
    btn.disabled = false;
    btn.textContent = originalText;
  }
}

async function checkUserStructure() {
  const btn = document.getElementById("checkStructureBtn");
  const container = document.getElementById("reportContainer");
  
  btn.disabled = true;
  const originalText = btn.textContent;
  btn.textContent = "⏳ Проверка...";
  
  try {
    const res = await fetch(`${scriptURL}?type=checkUserStructure`);
    const data = await res.json();
    
    if (data.error) {
      container.innerHTML = `<div style="color: red; padding: 16px; background: #fef2f2; border-radius: 8px;">
        <h3>❌ Ошибка</h3>
        <p>${data.error}</p>
      </div>`;
      return;
    }
    
    const structure = data.structure;
    let html = `
      <div style="padding: 16px; background: #f0f9ff; border-radius: 8px; margin-top: 16px;">
        <h3>🔍 Структура справочника пользователей</h3>
        <p><strong>Всего строк:</strong> ${structure.totalRows}</p>
        <p><strong>Количество колонок:</strong> ${structure.columnCount}</p>
        
        <h4>📋 Заголовки:</h4>
        <div style="background: white; padding: 8px; border-radius: 4px; margin: 8px 0;">
          ${structure.headers.map((header, index) => `<span style="display: inline-block; margin-right: 16px;"><strong>${index}:</strong> ${header || '(пусто)'}</span>`).join('')}
        </div>
        
        <h4>📊 Примеры данных (первые 3 строки):</h4>
        ${structure.sampleData.map((row, index) => `
          <div style="background: white; padding: 8px; border-radius: 4px; margin: 8px 0; font-family: monospace;">
            <strong>Строка ${index + 1}:</strong> ${row.map((cell, cellIndex) => `<span style="margin-right: 16px;"><strong>${cellIndex}:</strong> ${cell || '(пусто)'}</span>`).join('')}
          </div>
        `).join('')}
        
        <div style="margin-top: 16px; padding: 12px; background: #fef3c7; border-radius: 4px;">
          <h4>💡 Подсказка:</h4>
          <p>Оклад должен находиться в колонке с индексом <strong>4</strong> (5-я колонка).</p>
          <p>Имя пользователя должно находиться в колонке с индексом <strong>0</strong> (1-я колонка).</p>
        </div>
      </div>
    `;
    
    container.innerHTML = html;
    
  } catch (error) {
    console.error("❌ Ошибка проверки структуры:", error);
    container.innerHTML = `<div style="color: red; padding: 16px; background: #fef2f2; border-radius: 8px;">
      <h3>❌ Ошибка</h3>
      <p>Не удалось проверить структуру справочника: ${error.message}</p>
    </div>`;
  } finally {
    btn.disabled = false;
    btn.textContent = originalText;
  }
}

// ===== ФУНКЦИИ УЛУЧШЕННОЙ ЗАЩИТЫ ОТ ДУБЛИКАТОВ =====

/**
 * Анализирует все типы потенциальных дубликатов
 */
function analyzeAllDuplicates(payload) {
  duplicateWarnings = { exact: [], similar: [], suspicious: [] };
  
  todayRecords.forEach((rec, index) => {
    // 1. Точные дубликаты (существующая логика)
    if (isExactDuplicate(rec, payload)) {
      duplicateWarnings.exact.push({ record: rec, index, reason: "Полное совпадение" });
    }
    
    // 2. Похожие записи (новая логика)
    else if (isSimilarRecord(rec, payload)) {
      const similarities = findSimilarities(rec, payload);
      duplicateWarnings.similar.push({ 
        record: rec, 
        index, 
        reason: `Похоже на: ${similarities.join(", ")}`,
        similarities 
      });
    }
    
    // 3. Подозрительные записи
    else if (isSuspiciousRecord(rec, payload)) {
      const suspicions = findSuspicions(rec, payload);
      duplicateWarnings.suspicious.push({ 
        record: rec, 
        index, 
        reason: `Подозрительно: ${suspicions.join(", ")}`,
        suspicions 
      });
    }
  });
}

/**
 * Проверка точного дубликата (существующая логика)
 */
function isExactDuplicate(rec, payload) {
  const isSame =
    rec.employeeName === payload.employeeName &&
    rec.quantity === payload.quantity &&
    rec.startTime === payload.startTime &&
    rec.endTime === payload.endTime &&
    rec.operationType === payload.operationType &&
    rec.orderNumber === payload.orderNumber &&
    rec.setNumber === payload.setNumber;

  if (!isSame) return false;
  if (payload.operationType !== 'Сборка "Набора"') {
    return rec.volume === payload.volume;
  }
  return true;
}

/**
 * Проверка похожей записи
 */
function isSimilarRecord(rec, payload) {
  if (rec.employeeName !== payload.employeeName) return false;
  
  let similarities = 0;
  
  // Проверяем количество (±10%)
  if (payload.quantity && rec.quantity) {
    const diff = Math.abs(Number(payload.quantity) - Number(rec.quantity));
    const threshold = Number(rec.quantity) * 0.1;
    if (diff <= threshold) similarities++;
  }
  
  // Проверяем время (±15 минут)
  if (isTimeClose(rec.startTime, payload.startTime, 15) || 
      isTimeClose(rec.endTime, payload.endTime, 15)) {
    similarities++;
  }
  
  // Проверяем операцию
  if (rec.operationType === payload.operationType) similarities++;
  
  // Проверяем объём/артикул
  if (rec.volume === payload.volume || rec.setNumber === payload.setNumber) {
    similarities++;
  }
  
  // Если 3+ совпадения из 4 - это похожая запись
  return similarities >= 3;
}

/**
 * Проверка подозрительной записи
 */
function isSuspiciousRecord(rec, payload) {
  if (rec.employeeName !== payload.employeeName) return false;
  
  // Пересекающееся время работы
  if (isTimeOverlapping(rec, payload)) return true;
  
  // Очень короткий интервал между записями
  if (isTimeGapTooShort(rec, payload)) return true;
  
  // Одинаковое время, но разные операции
  if (rec.startTime === payload.startTime && rec.endTime === payload.endTime && 
      rec.operationType !== payload.operationType) return true;
      
  // Необычно высокая производительность
  if (isUnusuallyHighQuantity(payload)) return true;
  
  return false;
}

/**
 * Находит конкретные сходства между записями
 */
function findSimilarities(rec, payload) {
  const similarities = [];
  
  if (Math.abs(Number(payload.quantity) - Number(rec.quantity)) <= Number(rec.quantity) * 0.1) {
    similarities.push("количество");
  }
  
  if (isTimeClose(rec.startTime, payload.startTime, 15)) {
    similarities.push("время начала");
  }
  
  if (isTimeClose(rec.endTime, payload.endTime, 15)) {
    similarities.push("время окончания");
  }
  
  if (rec.operationType === payload.operationType) {
    similarities.push("операция");
  }
  
  if (rec.volume === payload.volume) {
    similarities.push("объём");
  }
  
  if (rec.setNumber === payload.setNumber) {
    similarities.push("артикул");
  }
  
  return similarities;
}

/**
 * Находит подозрительные моменты
 */
function findSuspicions(rec, payload) {
  const suspicions = [];
  
  if (isTimeOverlapping(rec, payload)) {
    suspicions.push("пересекающееся время");
  }
  
  if (isTimeGapTooShort(rec, payload)) {
    suspicions.push("слишком короткий перерыв");
  }
  
  if (rec.startTime === payload.startTime && rec.endTime === payload.endTime) {
    suspicions.push("одинаковое время");
  }
  
  if (isUnusuallyHighQuantity(payload)) {
    suspicions.push("необычно высокая производительность");
  }
  
  return suspicions;
}

/**
 * Проверяет, близко ли время (в минутах)
 */
function isTimeClose(time1, time2, minutesThreshold) {
  if (!time1 || !time2) return false;
  
  const [h1, m1] = time1.split(":").map(Number);
  const [h2, m2] = time2.split(":").map(Number);
  
  const minutes1 = h1 * 60 + m1;
  const minutes2 = h2 * 60 + m2;
  
  return Math.abs(minutes1 - minutes2) <= minutesThreshold;
}

/**
 * Проверяет пересечение времени работы
 */
function isTimeOverlapping(rec, payload) {
  if (!rec.startTime || !rec.endTime || !payload.startTime || !payload.endTime) return false;
  
  const recStart = timeToMinutes(rec.startTime);
  const recEnd = timeToMinutes(rec.endTime);
  const payloadStart = timeToMinutes(payload.startTime);
  const payloadEnd = timeToMinutes(payload.endTime);
  
  // Проверяем пересечение интервалов
  return (payloadStart < recEnd) && (payloadEnd > recStart);
}

/**
 * Проверяет, слишком ли короткий промежуток между записями
 */
function isTimeGapTooShort(rec, payload) {
  if (!rec.endTime || !payload.startTime) return false;
  
  const recEnd = timeToMinutes(rec.endTime);
  const payloadStart = timeToMinutes(payload.startTime);
  
  // Если между окончанием одной записи и началом другой меньше 5 минут
  const gap = Math.abs(payloadStart - recEnd);
  return gap < 5 && gap > 0;
}

/**
 * Проверяет необычно высокую производительность
 */
function isUnusuallyHighQuantity(payload) {
  if (!payload.quantity || !payload.startTime || !payload.endTime) return false;
  
  const duration = timeToMinutes(payload.endTime) - timeToMinutes(payload.startTime);
  if (duration <= 0) return false;
  
  const rate = Number(payload.quantity) / (duration / 60); // штук в час
  
  // Находим норму для этой операции
  const matchingRate = allRates.find(r => 
    r.operation === payload.operationType && 
    (r.key === payload.volume || r.key === payload.setNumber)
  );
  
  if (matchingRate && matchingRate.normPerHour > 0) {
    // Если производительность превышает норму в 2+ раза
    return rate > matchingRate.normPerHour * 2;
  }
  
  return false;
}

/**
 * Конвертирует время в минуты
 */
function timeToMinutes(timeStr) {
  const [hours, minutes] = timeStr.split(":").map(Number);
  return hours * 60 + minutes;
}

/**
 * Показывает предупреждения о дубликатах
 */
function showDuplicateWarnings() {
  const container = document.getElementById("duplicateWarnings") || createWarningsContainer();
  
  let html = "";
  
  // Точные дубликаты (критично)
  if (duplicateWarnings.exact.length > 0) {
    html += `
      <div class="warning-section critical">
        <h4>🚫 Точные дубликаты (${duplicateWarnings.exact.length})</h4>
        ${duplicateWarnings.exact.map(w => 
          `<div class="warning-item critical">
            <strong>Запись #${w.index + 1}:</strong> ${w.reason}<br>
            <small>${formatRecordSummary(w.record)}</small>
          </div>`
        ).join('')}
      </div>
    `;
  }
  
  // Похожие записи (предупреждение)
  if (duplicateWarnings.similar.length > 0) {
    html += `
      <div class="warning-section warning">
        <h4>⚠️ Похожие записи (${duplicateWarnings.similar.length})</h4>
        ${duplicateWarnings.similar.map(w => 
          `<div class="warning-item warning">
            <strong>Запись #${w.index + 1}:</strong> ${w.reason}<br>
            <small>${formatRecordSummary(w.record)}</small>
          </div>`
        ).join('')}
      </div>
    `;
  }
  
  // Подозрительные записи (уведомление)
  if (duplicateWarnings.suspicious.length > 0) {
    html += `
      <div class="warning-section info">
        <h4>🔍 Подозрительные записи (${duplicateWarnings.suspicious.length})</h4>
        ${duplicateWarnings.suspicious.map(w => 
          `<div class="warning-item info">
            <strong>Запись #${w.index + 1}:</strong> ${w.reason}<br>
            <small>${formatRecordSummary(w.record)}</small>
          </div>`
        ).join('')}
      </div>
    `;
  }
  
  if (html) {
    container.innerHTML = html;
    container.style.display = "block";
  } else {
    container.style.display = "none";
  }
}

/**
 * Создает контейнер для предупреждений
 */
function createWarningsContainer() {
  const existing = document.getElementById("duplicateWarnings");
  if (existing) return existing;
  
  const container = document.createElement("div");
  container.id = "duplicateWarnings";
  container.className = "duplicate-warnings";
  
  // Вставляем перед формой
  const form = document.getElementById("dataForm");
  form.parentNode.insertBefore(container, form);
  
  return container;
}

/**
 * Форматирует краткую информацию о записи
 */
function formatRecordSummary(record) {
  return `${record.operationType} • ${record.quantity}шт • ${record.startTime}-${record.endTime} • ${record.volume || record.setNumber || 'N/A'}`;
}

/**
 * Сохранение черновика формы
 */
function saveDraft() {
  const formData = new FormData(document.getElementById("dataForm"));
  const draft = {};
  formData.forEach((value, key) => {
    draft[key] = value;
  });
  
  draft.timestamp = Date.now();
  localStorage.setItem("formDraft", JSON.stringify(draft));
}

/**
 * Восстановление черновика формы
 */
function restoreDraft() {
  const draftStr = localStorage.getItem("formDraft");
  if (!draftStr) return false;
  
  try {
    const draft = JSON.parse(draftStr);
    
    // Проверяем, не слишком ли старый черновик (больше 1 часа)
    if (Date.now() - draft.timestamp > 60 * 60 * 1000) {
      localStorage.removeItem("formDraft");
      return false;
    }
    
    // Восстанавливаем поля
    Object.entries(draft).forEach(([key, value]) => {
      if (key !== 'timestamp') {
        const field = document.querySelector(`[name="${key}"]`);
        if (field) field.value = value;
      }
    });
    
    return true;
  } catch (error) {
    localStorage.removeItem("formDraft");
    return false;
  }
}

/**
 * Валидация формы в реальном времени
 */
function setupRealTimeValidation() {
  const form = document.getElementById("dataForm");
  const fields = ['quantity', 'startTime', 'endTime', 'operationType', 'volume', 'setNumber', 'orderNumber'];
  
  fields.forEach(fieldName => {
    const field = form.querySelector(`[name="${fieldName}"]`);
    if (field) {
      field.addEventListener('input', debounce(validateFormRealTime, 500));
      field.addEventListener('change', validateFormRealTime);
    }
  });
}

/**
 * Валидация формы в реальном времени
 */
function validateFormRealTime() {
  const form = document.getElementById("dataForm");
  if (!form) return;
  
  const formData = new FormData(form);
  
  const payload = {
    employeeName: currentUser,
    quantity: formData.get("quantity")?.trim(),
    startTime: formData.get("startTime")?.trim(),
    endTime: formData.get("endTime")?.trim(),
    volume: formData.get("volume")?.trim(),
    operationType: formData.get("operationType")?.trim(),
    orderNumber: formData.get("orderNumber")?.trim(),
    setNumber: formData.get("setNumber")?.trim(),
    shiftType: currentShift,
    employeeStatus: currentStatus
  };
  
  // Проверяем только если заполнены ключевые поля
  if (payload.employeeName && payload.quantity && payload.startTime && 
      payload.endTime && payload.operationType) {
    
    // 🚫 ОТКЛЮЧЕНО: analyzeAllDuplicates(payload);
    // 🚫 ОТКЛЮЧЕНО: showDuplicateWarnings();
    saveDraft(); // Сохраняем черновик
  }
}

/**
 * Дебаунс функция
 */
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// ===== ФУНКЦИИ УПРАВЛЕНИЯ ИНТЕРФЕЙСОМ =====

/**
 * Полное обновление интерфейса после успешной отправки
 */
async function performFullInterfaceRefresh() {
  try {
  
    
    // 1. Сброс формы к начальному состоянию (без блокировки)
    resetFormToInitialState();
    
    // 2. Минимальное обновление данных (только записи за сегодня)
    loadTodayRecords(); // Запускаем асинхронно, не ждем
    
    // 3. Очистка всех предупреждений и черновиков
    hideAllWarnings();
    clearDraft();
    
    // 4. Разблокировка кнопки отправки
    enableSubmitButton();
    

    
    // 5. Показываем уведомление об успешном обновлении
    showTemporaryNotification("✅ Данные успешно отправлены!", "success");
    
  } catch (error) {
    console.error("❌ Ошибка при обновлении интерфейса:", error);
    enableSubmitButton();
    showTemporaryNotification("⚠️ Данные отправлены, но возникла ошибка при обновлении интерфейса", "warning");
  }
}

/**
 * Сброс формы к начальному состоянию
 */
function resetFormToInitialState() {
  const form = document.getElementById("dataForm");
  
  // Очищаем форму
  form.reset();
  
  // Восстанавливаем основные поля
  document.querySelector('[name="employeeName"]').value = currentUser;
  
  // Сбрасываем операцию и связанные поля
  handleOperationChange("");
  
  // Обновляем расчет тарифов
  updateRateDisplay();
  
  // Очищаем сообщения о результатах
  const result = document.getElementById("result");
  if (result) {
    result.style.display = "none";
    result.className = "";
    result.textContent = "";
  }
  
  
}

/**
 * Включение кнопки отправки
 */
function enableSubmitButton() {
  const form = document.getElementById("dataForm");
  const submitBtn = document.querySelector('#dataForm button[type="submit"]');
  
  if (submitBtn) {
    submitBtn.disabled = false;
    submitBtn.textContent = "💾 Сохранить";
    submitBtn.style.opacity = "1";
    submitBtn.style.cursor = "pointer";
    submitBtn.classList.remove("loading");
  }
  
  if (form) {
    form.classList.remove("form-disabled");
  }
}

/**
 * Скрытие всех предупреждений
 */
function hideAllWarnings() {
  const warningsContainer = document.getElementById("duplicateWarnings");
  if (warningsContainer) {
    warningsContainer.style.display = "none";
    warningsContainer.innerHTML = "";
  }
  
  // Сброс данных о предупреждениях
  duplicateWarnings = { exact: [], similar: [], suspicious: [] };
}

/**
 * Очистка черновика
 */
function clearDraft() {
  localStorage.removeItem("formDraft");
  
}

// ===== ФУНКЦИИ ДЕДУПЛИКАЦИИ =====

/**
 * 🔍 Анализ дубликатов без удаления (для отдельной вкладки)
 */
async function analyzeDuplicatesInTab() {
  const loader = document.getElementById("duplicatesLoader");
  const resultsDiv = document.getElementById("duplicatesAnalysisResults");
  
  // Скрываем другие результаты
  hideAllResults();
  
  // Показываем загрузку
  loader.style.display = "block";
  
  try {
    const response = await fetch(scriptURL, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams({ type: "analyzeDuplicates" })
    });
    
    if (!response.ok) throw new Error("Ошибка сети");
    
    const result = await response.json();
    
    // Обновляем статистику
    updateDuplicatesStats(result.analyzed, result.total, 0, 0);
    
    // Отображаем результаты
    if (result.total > 0) {
      resultsDiv.innerHTML = `
        <h4>🔍 Результаты анализа дубликатов</h4>
        <div style="margin-bottom: 16px;">
          <strong>📊 Статистика:</strong><br>
          • Проанализировано записей: ${result.analyzed}<br>
          • Найдено дубликатов: ${result.total}
        </div>
        <div style="margin-bottom: 16px;">
          <strong>📋 Детали:</strong><br>
          ${result.details.map(detail => `• ${detail}`).join('<br>')}
        </div>
        <div style="background: #fff3cd; padding: 12px; border-radius: 8px; border: 1px solid #ffeaa7;">
          <strong>⚠️ Найдены дубликаты!</strong><br>
          Для их удаления нажмите кнопку "🗑️ Удалить дубликаты"
        </div>
      `;
    } else {
      resultsDiv.innerHTML = `
        <div style="text-align: center; color: #059669;">
          <h4>✅ Дубликаты не найдены</h4>
          <p>Проанализировано записей: ${result.analyzed}</p>
          <p>Все данные уникальны!</p>
        </div>
      `;
    }
    
    resultsDiv.style.display = "block";
    
  } catch (error) {
    console.error("Ошибка анализа дубликатов:", error);
    resultsDiv.innerHTML = `
      <div style="color: #dc2626; text-align: center;">
        <h4>❌ Ошибка анализа</h4>
        <p>${error.message}</p>
      </div>
    `;
    resultsDiv.style.display = "block";
  } finally {
    loader.style.display = "none";
  }
}

/**
 * 🗑️ Удаление дубликатов (для отдельной вкладки)
 */
async function runDeduplicateInTab() {
  // Запрашиваем подтверждение
  if (!confirm("⚠️ ВНИМАНИЕ!\n\nВы собираетесь удалить дубликаты из основной таблицы.\nДубликаты будут перемещены в карантин.\n\nПродолжить?")) {
    return;
  }
  
  const loader = document.getElementById("duplicatesLoader");
  const resultsDiv = document.getElementById("deduplicationResults");
  
  // Скрываем другие результаты
  hideAllResults();
  
  // Показываем загрузку
  loader.style.display = "block";
  
  try {
    const response = await fetch(scriptURL, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams({ type: "runSafeDeduplicate" })
    });
    
    if (!response.ok) throw new Error("Ошибка сети");
    
    const result = await response.json();
    
    // Отображаем результаты
    if (result.success) {
      // Обновляем статистику
      updateDuplicatesStats(result.analyzed, result.found, result.deleted, result.quarantined);
      
      resultsDiv.innerHTML = `
        <h4>✅ Дедупликация завершена</h4>
        <div style="margin-bottom: 16px;">
          <strong>📊 Статистика:</strong><br>
          • Проанализировано записей: ${result.analyzed}<br>
          • Найдено дубликатов: ${result.found}<br>
          • Удалено записей: ${result.deleted}<br>
          • Помещено в карантин: ${result.quarantined}
        </div>
        ${result.message ? `<div style="margin-bottom: 16px;"><strong>📝 Детали:</strong><br>${result.message}</div>` : ''}
        <div style="background: #d1fae5; padding: 12px; border-radius: 8px; border: 1px solid #a7f3d0;">
          <strong>🎉 Операция выполнена успешно!</strong><br>
          Дубликаты удалены из основной таблицы и сохранены в карантине для проверки.
        </div>
      `;
    } else {
      resultsDiv.innerHTML = `
        <div style="color: #dc2626; text-align: center;">
          <h4>❌ Ошибка дедупликации</h4>
          <p>${result.message || "Неизвестная ошибка"}</p>
        </div>
      `;
    }
    
    resultsDiv.style.display = "block";
    
  } catch (error) {
    console.error("Ошибка дедупликации:", error);
    resultsDiv.innerHTML = `
      <div style="color: #dc2626; text-align: center;">
        <h4>❌ Ошибка дедупликации</h4>
        <p>${error.message}</p>
      </div>
    `;
    resultsDiv.style.display = "block";
  } finally {
    loader.style.display = "none";
  }
}

// ===== ДОПОЛНИТЕЛЬНЫЕ ФУНКЦИИ ДЛЯ ВКЛАДКИ ДУБЛИКАТОВ =====

/**
 * Загрузка статистики дубликатов при открытии вкладки
 */
async function loadDuplicatesStats() {
  const statsDiv = document.getElementById("duplicatesStats");
  statsDiv.style.display = "block";
  
  // Устанавливаем начальные значения
  updateDuplicatesStats(0, 0, 0, 0);
}

/**
 * Обновление статистики в интерфейсе
 */
function updateDuplicatesStats(total, found, removed, quarantine) {
  document.getElementById("totalRecords").textContent = total;
  document.getElementById("duplicatesFound").textContent = found;
  document.getElementById("duplicatesRemoved").textContent = removed;
  document.getElementById("quarantineCount").textContent = quarantine;
  
  document.getElementById("duplicatesStats").style.display = "block";
}

/**
 * Скрытие всех результатов
 */
function hideAllResults() {
  const resultDivs = [
    "duplicatesAnalysisResults",
    "deduplicationResults", 
    "quarantineResults",
    "logResults"
  ];
  
  resultDivs.forEach(id => {
    const div = document.getElementById(id);
    if (div) div.style.display = "none";
  });
}

/**
 * 📦 Просмотр карантина
 */
async function viewQuarantine() {
  const loader = document.getElementById("duplicatesLoader");
  const resultsDiv = document.getElementById("quarantineResults");
  
  hideAllResults();
  loader.style.display = "block";
  
  try {
    // Здесь можно добавить запрос к серверу для получения данных карантина
    // Пока показываем заглушку
    resultsDiv.innerHTML = `
      <h4>📦 Карантин дубликатов</h4>
      <div style="text-align: center; color: #6b7280; padding: 20px;">
        <p>Функция просмотра карантина будет реализована в следующих версиях.</p>
        <p>Карантинные записи сохраняются в листе "Справочник_Карантин"</p>
      </div>
    `;
    
    resultsDiv.style.display = "block";
    
  } catch (error) {
    console.error("Ошибка загрузки карантина:", error);
    resultsDiv.innerHTML = `
      <div style="color: #dc2626; text-align: center;">
        <h4>❌ Ошибка загрузки</h4>
        <p>${error.message}</p>
      </div>
    `;
    resultsDiv.style.display = "block";
  } finally {
    loader.style.display = "none";
  }
}

/**
 * 📋 Просмотр журнала дедупликации
 */
async function viewDeduplicationLog() {
  const loader = document.getElementById("duplicatesLoader");
  const resultsDiv = document.getElementById("logResults");
  
  hideAllResults();
  loader.style.display = "block";
  
  try {
    // Здесь можно добавить запрос к серверу для получения журнала
    // Пока показываем заглушку
    resultsDiv.innerHTML = `
      <h4>📋 Журнал дедупликации</h4>
      <div style="text-align: center; color: #6b7280; padding: 20px;">
        <p>Функция просмотра журнала будет реализована в следующих версиях.</p>
        <p>Журнал операций сохраняется в листе "Журнал_дедупликации"</p>
      </div>
    `;
    
    resultsDiv.style.display = "block";
    
  } catch (error) {
    console.error("Ошибка загрузки журнала:", error);
    resultsDiv.innerHTML = `
      <div style="color: #dc2626; text-align: center;">
        <h4>❌ Ошибка загрузки</h4>
        <p>${error.message}</p>
      </div>
    `;
    resultsDiv.style.display = "block";
  } finally {
    loader.style.display = "none";
  }
}

// ===== ДИАГНОСТИЧЕСКИЕ ФУНКЦИИ =====

/**
 * 🔧 Диагностика состояния вкладки дубликатов
 * Вызывается из консоли: diagnoseDuplicatesTab()
 */
function diagnoseDuplicatesTab() {
  const tab = document.getElementById("tabDuplicates");
  
  console.log("🔧 ДИАГНОСТИКА ВКЛАДКИ ДУБЛИКАТОВ:");
  console.log("📊 Роль пользователя:", currentUserRole);
  console.log("👤 Текущий пользователь:", currentUser);
  
  if (!tab) {
    console.log("❌ Элемент tabDuplicates не найден в DOM!");
    return;
  }
  
  console.log("🎯 Состояние кнопки tabDuplicates:");
  console.log("  • style.display:", tab.style.display);
  console.log("  • style.visibility:", tab.style.visibility);
  console.log("  • disabled:", tab.disabled);
  console.log("  • CSS классы:", tab.className);
  console.log("  • offsetWidth:", tab.offsetWidth);
  console.log("  • offsetHeight:", tab.offsetHeight);
  
  // Проверяем CSS правила
  const computedStyle = window.getComputedStyle(tab);
  console.log("  • computed display:", computedStyle.display);
  console.log("  • computed visibility:", computedStyle.visibility);
  
  // Принудительное восстановление для админов
  if (currentUserRole === "admin") {
    console.log("🔧 Принудительное восстановление для администратора...");
    tab.classList.remove("admin-hidden");
    tab.classList.add("admin-visible");
    tab.style.display = "";
    tab.style.visibility = "";
    tab.disabled = false;
    console.log("✅ Восстановление выполнено!");
  }
}

/**
 * Обновление базовых данных (для быстрого обновления интерфейса)
 */
async function updateBasicData() {
  if (typeof loadTodayRecords === 'function') {
    try {
      // Обновляем список записей за сегодня
      await loadTodayRecords();
      
  
    } catch (error) {
      console.error("❌ Ошибка обновления базовых данных:", error);
    }
  }
}

/**
 * СУПЕР-БЫСТРОЕ обновление после операций редактирования/удаления
 * Минимальные сетевые запросы, только самое необходимое
 */
async function fastUpdateAfterChange() {
  try {
    // === 1. БЫСТРОЕ ОБНОВЛЕНИЕ ЗАПИСЕЙ ЗА СЕГОДНЯ (неблокирующее) ===
    loadTodayRecords().catch(error => {
      console.warn("⚠️ Фоновое обновление записей не удалось:", error);
    });
    
    // === 2. ОТЛОЖЕННОЕ ОБНОВЛЕНИЕ СТАТИСТИКИ (если открыта) ===
    const statsContainer = document.getElementById("statsContainer");
    
    if (statsContainer && statsContainer.style.display !== "none") {
      // Ждем, чтобы кнопки разблокировались, затем обновляем статистику
      setTimeout(() => {
        // Проверяем что статистика всё ещё открыта и не загружается
        if (statsContainer.style.display !== "none" && !isStatsLoading) {
      
          loadStats().catch(error => {
            console.warn("⚠️ Отложенное обновление статистики не удалось:", error);
          });
        } else {
      
        }
      }, 800); // Увеличиваем задержку для надежности
    }
    

    
  } catch (error) {
    console.error("❌ Ошибка быстрого обновления:", error);
    // Не показываем уведомление пользователю - работаем в фоне
  }
}

/**
 * Показ временного уведомления
 */
function showTemporaryNotification(message, type = "info", duration = 3000) {
  // Создаем или находим контейнер для уведомлений
  let container = document.getElementById("notificationContainer");
  if (!container) {
    container = document.createElement("div");
    container.id = "notificationContainer";
    container.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      max-width: 400px;
    `;
    document.body.appendChild(container);
  }
  
  // Создаем уведомление
  const notification = document.createElement("div");
  notification.className = `notification notification-${type}`;
  notification.style.cssText = `
    padding: 12px 16px;
    margin-bottom: 8px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    font-size: 14px;
    animation: slideInRight 0.3s ease-out;
    cursor: pointer;
  `;
  
  // Стили по типу
  switch (type) {
    case "success":
      notification.style.background = "#d1fae5";
      notification.style.color = "#065f46";
      notification.style.border = "1px solid #a7f3d0";
      break;
    case "warning":
      notification.style.background = "#fef3c7";
      notification.style.color = "#92400e";
      notification.style.border = "1px solid #fcd34d";
      break;
    case "error":
      notification.style.background = "#fef2f2";
      notification.style.color = "#991b1b";
      notification.style.border = "1px solid #fca5a5";
      break;
    default:
      notification.style.background = "#eff6ff";
      notification.style.color = "#1e40af";
      notification.style.border = "1px solid #93c5fd";
  }
  
  notification.textContent = message;
  
  // Добавляем обработчик клика для закрытия
  notification.addEventListener("click", () => {
    notification.remove();
  });
  
  container.appendChild(notification);
  
  // Автоматическое удаление
  setTimeout(() => {
    if (notification.parentNode) {
      notification.style.animation = "slideOutRight 0.3s ease-in";
      setTimeout(() => notification.remove(), 300);
    }
  }, duration);
}

// === АНАЛИЗ СЕБЕСТОИМОСТИ ===

function initializeCostAnalysis() {
  // Устанавливаем даты по умолчанию
  const today = new Date();
  const weekAgo = new Date(today);
  weekAgo.setDate(today.getDate() - 7);
  
  document.getElementById("costStartDate").value = weekAgo.toISOString().split('T')[0];
  document.getElementById("costEndDate").value = today.toISOString().split('T')[0];
}



async function calculateCostAnalysis() {
  const startDate = document.getElementById("costStartDate").value;
  const endDate = document.getElementById("costEndDate").value;
  const resultDiv = document.getElementById("costResults");
  
  if (!startDate || !endDate) {
    resultDiv.innerHTML = '<p style="color: red;">❌ Выберите период для анализа</p>';
    return;
  }
  
  resultDiv.innerHTML = '<p>🔄 Рассчитываем себестоимость...</p>';
  
  try {
    const response = await fetch(`${scriptURL}?type=costAnalysis&start=${startDate}&end=${endDate}`);
    const data = await response.json();
    
    if (data.status === "success") {
      displayCostResults(data);
    } else {
      resultDiv.innerHTML = `<p style="color: red;">❌ Ошибка: ${data.message}</p>`;
    }
  } catch (error) {
    console.error("Ошибка расчёта себестоимости:", error);
    resultDiv.innerHTML = '<p style="color: red;">❌ Ошибка при расчёте</p>';
  }
}

function displayCostResults(data) {
  const resultDiv = document.getElementById("costResults");
  
  let html = `
    <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 20px; border-radius: 16px; color: white; margin-bottom: 24px; box-shadow: 0 8px 32px rgba(0,0,0,0.1);">
      <h3 style="margin: 0 0 16px 0; font-size: 24px; font-weight: 700;">📊 Результаты анализа ФОТ</h3>
      <p style="margin: 0; font-size: 16px; opacity: 0.9;">Период: ${data.period}</p>
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 24px;">
      <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 12px; color: white; text-align: center; box-shadow: 0 4px 20px rgba(240,147,251,0.3);">
        <div style="font-size: 28px; font-weight: 700; margin-bottom: 8px;">${data.totalAllQuantity.toLocaleString()}</div>
        <div style="font-size: 14px; opacity: 0.9;">📦 Общее количество (шт)</div>
      </div>
      
      <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 20px; border-radius: 12px; color: white; text-align: center; box-shadow: 0 4px 20px rgba(250,112,154,0.3);">
        <div style="font-size: 28px; font-weight: 700; margin-bottom: 8px;">${data.totalAllCosts.toLocaleString()} ₽</div>
        <div style="font-size: 14px; opacity: 0.9;">💰 Общие расходы ФОТ</div>
      </div>
    </div>
  `;
  
  if (Object.keys(data.volumes).length === 0) {
    html += '<div style="background: #fee2e2; color: #dc2626; padding: 16px; border-radius: 8px; text-align: center;">❌ Нет данных за выбранный период</div>';
  } else {
    html += `
      <div style="background: white; border-radius: 16px; box-shadow: 0 4px 24px rgba(0,0,0,0.1); overflow: hidden;">
        <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 16px;">
          <h4 style="margin: 0; font-size: 18px; font-weight: 600;">📈 Себестоимость ФОТ по объемам</h4>
        </div>
        <div class="table-scroll">
          <table style="width:100%; border-collapse:collapse;">
            <thead>
              <tr style="background: #f8fafc;">
                <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">Объём</th>
                <th style="padding: 12px 16px; text-align: right; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">Кол-во</th>
                <th style="padding: 12px 16px; text-align: right; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">ФОТ Себест. ₽/шт</th>
                <th style="padding: 12px 16px; text-align: right; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">Общие затраты</th>
              </tr>
            </thead>
            <tbody>
    `;
    
    Object.keys(data.volumes).sort().forEach((volume, index) => {
      const vol = data.volumes[volume];
      const rowBg = index % 2 === 0 ? '#ffffff' : '#f8fafc';
      html += `
        <tr style="background: ${rowBg}; transition: background-color 0.2s;" onmouseover="this.style.background='#e2e8f0'" onmouseout="this.style.background='${rowBg}'">
          <td style="padding: 12px 16px; font-weight: 600; color: #1e293b;">${volume}</td>
          <td style="padding: 12px 16px; text-align: right; color: #475569;">${vol.quantity.toLocaleString()}</td>
          <td style="padding: 12px 16px; text-align: right; font-weight: 700; color: #2563eb; font-size: 16px;">${vol.unitCost}</td>
          <td style="padding: 12px 16px; text-align: right; color: #475569;">${vol.totalCost.toLocaleString()} ₽</td>
        </tr>
      `;
    });
    
    html += `
            </tbody>
          </table>
        </div>
      </div>
    `;
  }
  
  resultDiv.innerHTML = html;
}

async function calculateCostAnalysisWithMaterials() {
  const startDate = document.getElementById("costStartDate").value;
  const endDate = document.getElementById("costEndDate").value;
  const resultDiv = document.getElementById("costResults");
  
  if (!startDate || !endDate) {
    resultDiv.innerHTML = '<p style="color: red;">❌ Выберите период для анализа</p>';
    return;
  }
  
  resultDiv.innerHTML = '<p>🔄 Рассчитываем себестоимость ФОТ + Материалы...</p>';
  
  try {
    const response = await fetch(`${scriptURL}?type=costAnalysisWithMaterials&start=${startDate}&end=${endDate}`);
    const data = await response.json();
    
    if (data.status === "success") {
      displayCostResultsWithMaterials(data);
    } else {
      resultDiv.innerHTML = `<p style="color: red;">❌ Ошибка: ${data.message}</p>`;
    }
  } catch (error) {
    console.error("Ошибка расчёта себестоимости с материалами:", error);
    resultDiv.innerHTML = '<p style="color: red;">❌ Ошибка при расчёте</p>';
  }
}

async function calculateCostAnalysisForSetsFotOnly() {
  const startDate = document.getElementById("costStartDate").value;
  const endDate = document.getElementById("costEndDate").value;
  const resultDiv = document.getElementById("costResults");
  
  if (!startDate || !endDate) {
    resultDiv.innerHTML = '<p style="color: red;">❌ Выберите период для анализа</p>';
    return;
  }
  
  resultDiv.innerHTML = '<p>🔄 Рассчитываем себестоимость наборов (только ФОТ)...</p>';
  
  try {
    const response = await fetch(`${scriptURL}?type=costAnalysisForSetsFotOnly&start=${startDate}&end=${endDate}`);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();
    
    if (data.status === "success") {
      displayCostResultsForSetsFotOnly(data);
    } else if (data.status === "fail" && data.message) {
      resultDiv.innerHTML = `
        <div style="background: #fee2e2; color: #dc2626; padding: 16px; border-radius: 8px; margin: 10px 0;">
          <h4 style="margin-top: 0;">❌ Ошибка расчёта ФОТ себестоимости наборов</h4>
          <p style="margin-bottom: 0;"><strong>Детали:</strong> ${data.message}</p>
          <details style="margin-top: 10px;">
            <summary style="cursor: pointer;">🔍 Рекомендации по устранению</summary>
            <ul style="margin-top: 10px;">
              <li>Убедитесь что все необходимые листы данных существуют</li>
              <li>Проверьте права доступа к Google Sheets</li>
              <li>Попробуйте выбрать другой период</li>
              <li>Убедитесь что есть данные по операциям сборки наборов</li>
            </ul>
          </details>
        </div>
      `;
    } else {
      resultDiv.innerHTML = `<p style="color: red;">❌ Неизвестная ошибка: ${JSON.stringify(data)}</p>`;
    }
  } catch (error) {
    console.error("Ошибка расчёта ФОТ себестоимости наборов:", error);
    resultDiv.innerHTML = `
      <div style="background: #fee2e2; color: #dc2626; padding: 16px; border-radius: 8px; margin: 10px 0;">
        <h4 style="margin-top: 0;">❌ Ошибка соединения</h4>
        <p><strong>Причина:</strong> ${error.message}</p>
        <p style="margin-bottom: 0;"><strong>Рекомендации:</strong></p>
        <ul>
          <li>Проверьте интернет-соединение</li>
          <li>Обновите страницу и попробуйте снова</li>
          <li>Проверьте правильность URL скрипта</li>
        </ul>
      </div>
    `;
  }
}

async function calculateCostAnalysisForSets() {
  const startDate = document.getElementById("costStartDate").value;
  const endDate = document.getElementById("costEndDate").value;
  const resultDiv = document.getElementById("costResults");
  
  if (!startDate || !endDate) {
    resultDiv.innerHTML = '<p style="color: red;">❌ Выберите период для анализа</p>';
    return;
  }
  
  resultDiv.innerHTML = '<p>🔄 Рассчитываем себестоимость наборов (ФОТ + Материалы)...</p>';
  
  try {
    const response = await fetch(`${scriptURL}?type=costAnalysisForSets&start=${startDate}&end=${endDate}`);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();
    
    if (data.status === "success") {
      displayCostResultsForSets(data);
    } else if (data.status === "fail" && data.message) {
      resultDiv.innerHTML = `
        <div style="background: #fee2e2; color: #dc2626; padding: 16px; border-radius: 8px; margin: 10px 0;">
          <h4 style="margin-top: 0;">❌ Ошибка расчёта себестоимости наборов</h4>
          <p style="margin-bottom: 0;"><strong>Детали:</strong> ${data.message}</p>
          <details style="margin-top: 10px;">
            <summary style="cursor: pointer;">🔍 Рекомендации по устранению</summary>
            <ul style="margin-top: 10px;">
              <li>Проверьте наличие справочника "Справочник_расчетов_стоимости_упаковки_наборов"</li>
              <li>Убедитесь что все необходимые листы данных существуют</li>
              <li>Проверьте права доступа к Google Sheets</li>
              <li>Попробуйте выбрать другой период</li>
            </ul>
          </details>
        </div>
      `;
    } else {
      resultDiv.innerHTML = `<p style="color: red;">❌ Неизвестная ошибка: ${JSON.stringify(data)}</p>`;
    }
  } catch (error) {
    console.error("Ошибка расчёта себестоимости наборов:", error);
    resultDiv.innerHTML = `
      <div style="background: #fee2e2; color: #dc2626; padding: 16px; border-radius: 8px; margin: 10px 0;">
        <h4 style="margin-top: 0;">❌ Ошибка соединения</h4>
        <p><strong>Причина:</strong> ${error.message}</p>
        <p style="margin-bottom: 0;"><strong>Рекомендации:</strong></p>
        <ul>
          <li>Проверьте интернет-соединение</li>
          <li>Обновите страницу и попробуйте снова</li>
          <li>Проверьте правильность URL скрипта</li>
        </ul>
      </div>
    `;
  }
}

function displayCostResultsWithMaterials(data) {
  const resultDiv = document.getElementById("costResults");
  
  let html = `
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 16px; color: white; margin-bottom: 24px; box-shadow: 0 8px 32px rgba(0,0,0,0.1);">
      <h3 style="margin: 0 0 16px 0; font-size: 24px; font-weight: 700;">📊 Результаты анализа ФОТ + Материалы</h3>
      <p style="margin: 0; font-size: 16px; opacity: 0.9;">Период: ${data.period}</p>
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
      <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 12px; color: white; text-align: center; box-shadow: 0 4px 20px rgba(240,147,251,0.3);">
        <div style="font-size: 28px; font-weight: 700; margin-bottom: 8px;">${data.totalAllQuantity.toLocaleString()}</div>
        <div style="font-size: 14px; opacity: 0.9;">📦 Общее количество (шт)</div>
      </div>
      
      <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 20px; border-radius: 12px; color: white; text-align: center; box-shadow: 0 4px 20px rgba(79,172,254,0.3);">
        <div style="font-size: 28px; font-weight: 700; margin-bottom: 8px;">${data.totalAllFotCosts.toLocaleString()} ₽</div>
        <div style="font-size: 14px; opacity: 0.9;">💰 Расходы ФОТ</div>
      </div>
      
      <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); padding: 20px; border-radius: 12px; color: white; text-align: center; box-shadow: 0 4px 20px rgba(67,233,123,0.3);">
        <div style="font-size: 28px; font-weight: 700; margin-bottom: 8px;">${data.totalAllMaterialsCosts.toLocaleString()} ₽</div>
        <div style="font-size: 14px; opacity: 0.9;">🧪 Расходы Материалы</div>
      </div>
      
      <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 20px; border-radius: 12px; color: white; text-align: center; box-shadow: 0 4px 20px rgba(250,112,154,0.3);">
        <div style="font-size: 28px; font-weight: 700; margin-bottom: 8px;">${data.totalAllCosts.toLocaleString()} ₽</div>
        <div style="font-size: 14px; opacity: 0.9;">💰 ИТОГО расходы</div>
      </div>
    </div>
  `;
  
  if (Object.keys(data.volumes).length === 0) {
    html += '<div style="background: #fee2e2; color: #dc2626; padding: 16px; border-radius: 8px; text-align: center;">❌ Нет данных за выбранный период</div>';
  } else {
    html += `
      <div style="background: white; border-radius: 16px; box-shadow: 0 4px 24px rgba(0,0,0,0.1); overflow: hidden; margin-bottom: 24px;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 16px;">
          <h4 style="margin: 0; font-size: 18px; font-weight: 600;">📈 Себестоимость по объемам</h4>
        </div>
        <div class="table-scroll">
          <table style="width:100%; border-collapse:collapse;">
            <thead>
              <tr style="background: #f8fafc;">
                <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">Объём</th>
                <th style="padding: 12px 16px; text-align: right; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">Кол-во</th>
                <th style="padding: 12px 16px; text-align: right; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">ФОТ ₽/шт</th>
                <th style="padding: 12px 16px; text-align: right; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">Материалы ₽/шт</th>
                <th style="padding: 12px 16px; text-align: right; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">ИТОГО ₽/шт</th>
                <th style="padding: 12px 16px; text-align: right; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">Общие затраты</th>
              </tr>
            </thead>
            <tbody>
    `;
    
    Object.keys(data.volumes).sort().forEach((volume, index) => {
      const vol = data.volumes[volume];
      const rowBg = index % 2 === 0 ? '#ffffff' : '#f8fafc';
      html += `
        <tr style="background: ${rowBg}; transition: background-color 0.2s;" onmouseover="this.style.background='#e2e8f0'" onmouseout="this.style.background='${rowBg}'">
          <td style="padding: 12px 16px; font-weight: 600; color: #1e293b;">${volume}</td>
          <td style="padding: 12px 16px; text-align: right; color: #475569;">${vol.quantity.toLocaleString()}</td>
          <td style="padding: 12px 16px; text-align: right; color: #2563eb; font-weight: 500;">${vol.fotUnitCost}</td>
          <td style="padding: 12px 16px; text-align: right; color: #059669; font-weight: 500;">${vol.materialsUnitCost}</td>
          <td style="padding: 12px 16px; text-align: right; font-weight: 700; color: #dc2626; font-size: 16px;">${vol.unitCost}</td>
          <td style="padding: 12px 16px; text-align: right; color: #475569;">${vol.totalCost.toLocaleString()} ₽</td>
        </tr>
      `;
    });
    
    html += `
            </tbody>
          </table>
        </div>
      </div>
      
      <div style="background: white; border-radius: 16px; box-shadow: 0 4px 24px rgba(0,0,0,0.1); overflow: hidden;">
        <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 16px;">
          <h4 style="margin: 0; font-size: 18px; font-weight: 600;">🧪 Детализация материалов по объемам</h4>
        </div>
        <div class="table-scroll">
          <table style="width:100%; border-collapse:collapse;">
            <thead>
              <tr style="background: #f8fafc;">
                <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">Объём</th>
                <th style="padding: 12px 16px; text-align: right; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">ПОФ ₽/шт</th>
                <th style="padding: 12px 16px; text-align: right; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">ВПП ₽/шт</th>
                <th style="padding: 12px 16px; text-align: right; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">Скотч ₽/шт</th>
                <th style="padding: 12px 16px; text-align: right; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">Стикер ₽/шт</th>
                <th style="padding: 12px 16px; text-align: right; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">Итого материалы ₽/шт</th>
              </tr>
            </thead>
            <tbody>
    `;
    
    Object.keys(data.volumes).sort().forEach((volume, index) => {
      const vol = data.volumes[volume];
      const materials = vol.materialBreakdown;
      const rowBg = index % 2 === 0 ? '#ffffff' : '#f8fafc';
      html += `
        <tr style="background: ${rowBg}; transition: background-color 0.2s;" onmouseover="this.style.background='#e2e8f0'" onmouseout="this.style.background='${rowBg}'">
          <td style="padding: 12px 16px; font-weight: 600; color: #1e293b;">${volume}</td>
          <td style="padding: 12px 16px; text-align: right; color: #7c3aed; font-weight: 500;">${materials.pofUnitCost}</td>
          <td style="padding: 12px 16px; text-align: right; color: #2563eb; font-weight: 500;">${materials.vppUnitCost}</td>
          <td style="padding: 12px 16px; text-align: right; color: #059669; font-weight: 500;">${materials.scotchUnitCost}</td>
          <td style="padding: 12px 16px; text-align: right; color: #dc2626; font-weight: 500;">${materials.stickerUnitCost}</td>
          <td style="padding: 12px 16px; text-align: right; font-weight: 700; color: #1e293b; font-size: 16px; background: linear-gradient(135deg, #fef3c7, #fbbf24); border-radius: 6px;">${vol.materialsUnitCost}</td>
        </tr>
      `;
    });
    
    html += `
            </tbody>
          </table>
        </div>
      </div>
    `;
  }
  
  resultDiv.innerHTML = html;
}

function displayCostResultsForSetsFotOnly(data) {
  const resultDiv = document.getElementById("costResults");
  
  let html = `
    <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 20px; border-radius: 16px; color: white; margin-bottom: 24px; box-shadow: 0 8px 32px rgba(0,0,0,0.1);">
      <h3 style="margin: 0 0 16px 0; font-size: 24px; font-weight: 700;">📦 Результаты анализа ФОТ наборов</h3>
      <p style="margin: 0; font-size: 16px; opacity: 0.9;">Период: ${data.period}</p>
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 24px;">
      <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 12px; color: white; text-align: center; box-shadow: 0 4px 20px rgba(240,147,251,0.3);">
        <div style="font-size: 28px; font-weight: 700; margin-bottom: 8px;">${data.totalSetsQuantity.toLocaleString()}</div>
        <div style="font-size: 14px; opacity: 0.9;">📦 Собрано наборов (шт)</div>
      </div>
      
      <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 20px; border-radius: 12px; color: white; text-align: center; box-shadow: 0 4px 20px rgba(250,112,154,0.3);">
        <div style="font-size: 28px; font-weight: 700; margin-bottom: 8px;">${data.totalFotCosts.toLocaleString()} ₽</div>
        <div style="font-size: 14px; opacity: 0.9;">💰 Общие ФОТ затраты</div>
      </div>
    </div>
  `;
  
  if (Object.keys(data.sets).length === 0) {
    html += '<div style="background: #fee2e2; color: #dc2626; padding: 16px; border-radius: 8px; text-align: center;">❌ Нет данных о наборах за выбранный период</div>';
  } else {
    html += `
      <div style="background: white; border-radius: 16px; box-shadow: 0 4px 24px rgba(0,0,0,0.1); overflow: hidden;">
        <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 16px;">
          <h4 style="margin: 0; font-size: 18px; font-weight: 600;">📈 Себестоимость ФОТ по наборам</h4>
        </div>
        <div class="table-scroll">
          <table style="width:100%; border-collapse:collapse;">
            <thead>
              <tr style="background: #f8fafc;">
                <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">Артикул набора</th>
                <th style="padding: 12px 16px; text-align: right; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">Кол-во</th>
                <th style="padding: 12px 16px; text-align: right; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">ФОТ Себест. ₽/шт</th>
                <th style="padding: 12px 16px; text-align: right; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">Общие затраты</th>
              </tr>
            </thead>
            <tbody>
    `;
    
    Object.keys(data.sets).sort().forEach((setCode, index) => {
      const set = data.sets[setCode];
      const rowBg = index % 2 === 0 ? '#ffffff' : '#f8fafc';
      html += `
        <tr style="background: ${rowBg}; transition: background-color 0.2s;" onmouseover="this.style.background='#e2e8f0'" onmouseout="this.style.background='${rowBg}'">
          <td style="padding: 12px 16px; font-weight: 600; color: #1e293b;">${setCode}</td>
          <td style="padding: 12px 16px; text-align: right; color: #475569;">${set.quantity.toLocaleString()}</td>
          <td style="padding: 12px 16px; text-align: right; font-weight: 700; color: #2563eb; font-size: 16px;">${set.unitCost}</td>
          <td style="padding: 12px 16px; text-align: right; color: #475569;">${set.totalCost.toLocaleString()} ₽</td>
        </tr>
      `;
    });
    
    html += `
            </tbody>
          </table>
        </div>
      </div>
    `;
  }
  
  resultDiv.innerHTML = html;
}

function displayCostResultsForSets(data) {
  const resultDiv = document.getElementById("costResults");
  
  let html = `
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 16px; color: white; margin-bottom: 24px; box-shadow: 0 8px 32px rgba(0,0,0,0.1);">
      <h3 style="margin: 0 0 16px 0; font-size: 24px; font-weight: 700;">📦 Результаты анализа себестоимости наборов</h3>
      <p style="margin: 0; font-size: 16px; opacity: 0.9;">Период: ${data.period}</p>
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
      <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 12px; color: white; text-align: center; box-shadow: 0 4px 20px rgba(240,147,251,0.3);">
        <div style="font-size: 28px; font-weight: 700; margin-bottom: 8px;">${data.totalSetsQuantity.toLocaleString()}</div>
        <div style="font-size: 14px; opacity: 0.9;">📦 Собрано наборов (шт)</div>
      </div>
      
      <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 20px; border-radius: 12px; color: white; text-align: center; box-shadow: 0 4px 20px rgba(79,172,254,0.3);">
        <div style="font-size: 28px; font-weight: 700; margin-bottom: 8px;">${data.totalFotCosts.toLocaleString()} ₽</div>
        <div style="font-size: 14px; opacity: 0.9;">💰 Расходы ФОТ</div>
      </div>
      
      <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); padding: 20px; border-radius: 12px; color: white; text-align: center; box-shadow: 0 4px 20px rgba(67,233,123,0.3);">
        <div style="font-size: 28px; font-weight: 700; margin-bottom: 8px;">${data.totalMaterialsCosts.toLocaleString()} ₽</div>
        <div style="font-size: 14px; opacity: 0.9;">🧪 Расходы Материалы</div>
      </div>
      
      <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 20px; border-radius: 12px; color: white; text-align: center; box-shadow: 0 4px 20px rgba(250,112,154,0.3);">
        <div style="font-size: 28px; font-weight: 700; margin-bottom: 8px;">${data.totalCosts.toLocaleString()} ₽</div>
        <div style="font-size: 14px; opacity: 0.9;">💰 ИТОГО расходы</div>
      </div>
    </div>
  `;
  
  if (Object.keys(data.sets).length === 0) {
    html += '<div style="background: #fee2e2; color: #dc2626; padding: 16px; border-radius: 8px; text-align: center;">❌ Нет данных о наборах за выбранный период</div>';
  } else {
    html += `
      <div style="background: white; border-radius: 16px; box-shadow: 0 4px 24px rgba(0,0,0,0.1); overflow: hidden; margin-bottom: 24px;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 16px;">
          <h4 style="margin: 0; font-size: 18px; font-weight: 600;">📦 Себестоимость наборов</h4>
        </div>
        <div class="table-scroll">
          <table style="width:100%; border-collapse:collapse;">
            <thead>
              <tr style="background: #f8fafc;">
                <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">Артикул набора</th>
                <th style="padding: 12px 16px; text-align: right; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">Кол-во</th>
                <th style="padding: 12px 16px; text-align: right; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">ФОТ ₽/шт</th>
                <th style="padding: 12px 16px; text-align: right; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">Материалы ₽/шт</th>
                <th style="padding: 12px 16px; text-align: right; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">ИТОГО ₽/шт</th>
                <th style="padding: 12px 16px; text-align: right; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">Общие затраты</th>
              </tr>
            </thead>
            <tbody>
    `;
    
    Object.keys(data.sets).sort().forEach((setCode, index) => {
      const set = data.sets[setCode];
      const rowBg = index % 2 === 0 ? '#ffffff' : '#f8fafc';
      html += `
        <tr style="background: ${rowBg}; transition: background-color 0.2s;" onmouseover="this.style.background='#e2e8f0'" onmouseout="this.style.background='${rowBg}'">
          <td style="padding: 12px 16px; font-weight: 600; color: #1e293b;">${setCode}</td>
          <td style="padding: 12px 16px; text-align: right; color: #475569;">${set.quantity.toLocaleString()}</td>
          <td style="padding: 12px 16px; text-align: right; color: #2563eb; font-weight: 500;">${set.fotUnitCost}</td>
          <td style="padding: 12px 16px; text-align: right; color: #059669; font-weight: 500;">${set.materialUnitCost}</td>
          <td style="padding: 12px 16px; text-align: right; font-weight: 700; color: #dc2626; font-size: 16px;">${set.totalUnitCost}</td>
          <td style="padding: 12px 16px; text-align: right; color: #475569;">${set.totalCost.toLocaleString()} ₽</td>
        </tr>
      `;
    });
    
    html += `
            </tbody>
          </table>
        </div>
      </div>
    `;
  }
  
  resultDiv.innerHTML = html;
}

// === ФУНКЦИЯ ДЛЯ ВЫГРУЗКИ ОТЧЕТА НА СЕРВЕР ===

async function saveReportToServer() {
  const startDate = document.getElementById("costStartDate").value;
  const endDate = document.getElementById("costEndDate").value;
  
  if (!startDate || !endDate) {
    alert('❌ Выберите период для сохранения отчета');
    return;
  }

  // Показываем индикатор загрузки в кнопке
  const button = document.querySelector('button[onclick="saveReportToServer()"]');
  if (button) {
    button.disabled = true;
    button.innerHTML = '🔄 Сохраняем...';
  }

  try {
    const response = await fetch(`${scriptURL}?type=saveReport&reportType=fot&start=${startDate}&end=${endDate}`);
    const data = await response.json();
    
    if (data.status === "success") {
      alert(`✅ ${data.message}`);
    } else {
      alert(`❌ Ошибка: ${data.message}`);
    }
  } catch (error) {
    console.error("Ошибка сохранения отчета:", error);
    alert('❌ Ошибка при сохранении отчета на сервер');
  } finally {
    // Восстанавливаем кнопку
    if (button) {
      button.disabled = false;
      button.innerHTML = '💾 Выгрузить отчет себестоимости на сервер';
    }
  }
}





// ============================
// 🔍 ФУНКЦИИ АНАЛИЗА НОРМАТИВОВ
// ============================

// Глобальные переменные
let currentNormativesData = [];
let currentEditingNorm = null;

// Показать блок анализа нормативов с авторизацией
function loadNormativesAnalysis() {
  // Всегда запрашиваем пароль (без сохранения)
  promptNormativesAuth();
}

// Запрос пароля для доступа к анализу нормативов
function promptNormativesAuth() {
  const password = prompt('🔐 Введите пароль для доступа к анализу нормативов:');
  if (password === 'Forsal2025') {
    showNormativesAnalysis();
  } else if (password !== null) {
    alert('❌ Неверный пароль');
  }
}

// Показать блок анализа нормативов (после авторизации)
function showNormativesAnalysis() {
  const container = document.getElementById("normativesAnalysisContainer");
  
  // Скрываем другие отчеты
  document.getElementById("reportContainer").innerHTML = "";
  document.getElementById("shiftStatsOutput").innerHTML = "";
  document.getElementById("packerAnalysis").innerHTML = "";
  
  // Показываем контейнер
  container.style.display = "block";
  
  // Устанавливаем период по умолчанию (последние 7 дней)
  const endDate = new Date();
  const startDate = new Date();
  startDate.setDate(endDate.getDate() - 7);
  
  const startDateString = startDate.toISOString().split('T')[0];
  const endDateString = endDate.toISOString().split('T')[0];
  
  // Устанавливаем для мобильной версии
  document.getElementById("normativesStartDate").value = startDateString;
  document.getElementById("normativesEndDate").value = endDateString;
  
  // Устанавливаем для десктопной версии
  document.getElementById("normativesStartDateDesktop").value = startDateString;
  document.getElementById("normativesEndDateDesktop").value = endDateString;
  
  // Сброс результатов
  document.getElementById("normativesSummary").style.display = "none";
  document.getElementById("normativesResults").innerHTML = "";
}

// Скрыть блок анализа нормативов
function hideNormativesAnalysis() {
  document.getElementById("normativesAnalysisContainer").style.display = "none";
}

// Запустить анализ нормативов
async function runNormativesAnalysis() {
  // Определяем, какую версию интерфейса использовать
  const isMobile = window.innerWidth <= 768;
  
  const startDate = isMobile ? 
    document.getElementById("normativesStartDate").value :
    document.getElementById("normativesStartDateDesktop").value;
  const endDate = isMobile ? 
    document.getElementById("normativesEndDate").value :
    document.getElementById("normativesEndDateDesktop").value;
  const filter = isMobile ? 
    document.getElementById("normativesFilter").value :
    document.getElementById("normativesFilterDesktop").value;
  const search = isMobile ? 
    document.getElementById("normativesSearch").value.toLowerCase() :
    document.getElementById("normativesSearchDesktop").value.toLowerCase();
  
  if (!startDate || !endDate) {
    alert("⚠️ Укажите период анализа");
    return;
  }
  
  const btn = isMobile ? 
    document.getElementById("runNormativesBtn") :
    document.getElementById("runNormativesBtnDesktop");
  const loader = document.getElementById("normativesLoader");
  const resultsContainer = document.getElementById("normativesResults");
  const summaryContainer = document.getElementById("normativesSummary");
  
  // Показываем загрузку
  btn.disabled = true;
  btn.textContent = isMobile ? "⏳ Анализируем..." : "⏳ Анализируем...";
  loader.style.display = "block";
  resultsContainer.innerHTML = "";
  summaryContainer.style.display = "none";
  
  try {
    const response = await fetch(`${scriptURL}?type=normativesAnalysis&startDate=${startDate}&endDate=${endDate}&filter=${filter}`);
    const data = await response.json();
    
    if (!data.ok) {
      throw new Error(data.message || "Ошибка анализа");
    }
    
    currentNormativesData = data.results;
    
    // Применяем поиск если есть
    let filteredResults = currentNormativesData;
    if (search) {
      filteredResults = currentNormativesData.filter(item => 
        item.operation.toLowerCase().includes(search) || 
        item.key.toLowerCase().includes(search)
      );
    }
    
    // Показываем статистику
    showNormativesSummary(data.summary, filteredResults.length);
    
    // Показываем результаты
    displayNormativesResults(filteredResults);
    
  } catch (error) {
    console.error("Ошибка анализа нормативов:", error);
    resultsContainer.innerHTML = `<div style="text-align:center; color:red; padding:20px;">❌ Ошибка: ${error.message}</div>`;
  } finally {
    // Скрываем загрузку
    btn.disabled = false;
    btn.textContent = isMobile ? "📊 Анализ" : "📊 Запустить анализ";
    loader.style.display = "none";
  }
}

// Показать статистику
function showNormativesSummary(summary, filteredCount) {
  const container = document.getElementById("normativesSummary");
  
  document.getElementById("totalNormatives").textContent = filteredCount || summary.totalOperations;
  document.getElementById("problematicNormatives").textContent = summary.problematicOperations;
  document.getElementById("overstatedNormatives").textContent = summary.overstatedCount;
  document.getElementById("understatedNormatives").textContent = summary.understatedCount;
  
  container.style.display = "block";
}

// Отобразить результаты анализа
function displayNormativesResults(results) {
  const container = document.getElementById("normativesResults");
  
  if (!results || results.length === 0) {
    container.innerHTML = `<div style="text-align:center; padding:40px; color:#6b7280;">
      <div style="font-size:48px; margin-bottom:16px;">🔍</div>
      <div>Нет результатов по заданным критериям</div>
    </div>`;
    return;
  }
  
  let html = `
    <div style="overflow-x: auto;">
      <table style="width:100%; border-collapse:collapse; font-size:14px;">
        <thead>
          <tr style="background:#f8fafc; border-bottom:2px solid #e5e7eb;">
            <th style="padding:12px 8px; text-align:left; font-weight:600;">Операция</th>
            <th style="padding:12px 8px; text-align:left; font-weight:600;">Объем/Ключ</th>
            <th style="padding:12px 8px; text-align:center; font-weight:600;">Текущая норма</th>
            <th style="padding:12px 8px; text-align:center; font-weight:600;">Ср. эффективность</th>
            <th style="padding:12px 8px; text-align:center; font-weight:600;">Ср. скорость</th>
            <th style="padding:12px 8px; text-align:center; font-weight:600;">Статус</th>
            <th style="padding:12px 8px; text-align:center; font-weight:600;">Операций</th>
            <th style="padding:12px 8px; text-align:center; font-weight:600;">Действия</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  results.forEach((item, index) => {
    const statusColor = item.status === "overstated" ? "#fee2e2" : 
                       item.status === "understated" ? "#dcfce7" : "#f9fafb";
    const textColor = item.status === "overstated" ? "#dc2626" : 
                     item.status === "understated" ? "#16a34a" : "#6b7280";
    
    html += `
      <tr style="border-bottom:1px solid #e5e7eb; background:${statusColor};">
        <td style="padding:12px 8px; font-weight:500;">${item.operation}</td>
        <td style="padding:12px 8px;">${item.key}</td>
        <td style="padding:12px 8px; text-align:center; font-weight:600;">${item.normPerHour} шт/ч</td>
        <td style="padding:12px 8px; text-align:center; color:${textColor}; font-weight:600;">${item.avgEfficiency}%</td>
        <td style="padding:12px 8px; text-align:center;">${item.avgSpeed} шт/ч</td>
        <td style="padding:12px 8px; text-align:center; font-weight:600; color:${textColor};">${item.statusText}</td>
        <td style="padding:12px 8px; text-align:center;">${item.totalOperations}</td>
        <td style="padding:12px 8px; text-align:center;">
          <button class="edit-norm-btn" data-index="${index}" data-rate-key="${item.rateKey}"
                  style="background:#f59e0b; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:12px;">
            ✏️ Изменить
          </button>
        </td>
      </tr>
    `;
  });
  
  html += `
        </tbody>
      </table>
    </div>
    
    <div style="margin-top:16px; padding:12px; background:#f0f9ff; border-radius:8px; font-size:12px; color:#1e40af;">
      <strong>💡 Пояснения:</strong><br>
      🔴 <strong>Завышенная норма</strong> - средняя эффективность < 80%<br>
      🟢 <strong>Заниженная норма</strong> - средняя эффективность > 100%<br>
      ⚪ <strong>Норма в порядке</strong> - эффективность в диапазоне 80-100%
    </div>
  `;
  
  // Создаем контейнер с обеими версиями
  const fullHtml = `
    <!-- Десктопная таблица -->
    <div class="normatives-desktop-table">
      ${html}
    </div>
    
    <!-- Мобильные карточки -->
    <div class="normatives-mobile-cards" style="display: none;">
      ${createMobileCards(results)}
    </div>
  `;
  
  container.innerHTML = fullHtml;
  
  // Добавляем обработчики для кнопок редактирования (десктоп)
  const desktopTable = container.querySelector('.normatives-desktop-table');
  if (desktopTable) {
    desktopTable.addEventListener('click', function(e) {
      if (e.target.classList.contains('edit-norm-btn')) {
        const index = parseInt(e.target.dataset.index);
        const rateKey = e.target.dataset.rateKey;
  
        openEditNormModal(rateKey, index);
      }
    });
  }
  
  // Добавляем обработчики для кнопок редактирования (мобильные)
  const mobileCards = container.querySelector('.normatives-mobile-cards');
  if (mobileCards) {
    mobileCards.addEventListener('click', function(e) {
      if (e.target.classList.contains('normative-card-action')) {
        const index = parseInt(e.target.dataset.index);
        const rateKey = e.target.dataset.rateKey;
  
        openEditNormModal(rateKey, index);
      }
    });
  }
}

// Создание мобильных карточек
function createMobileCards(results) {
  return results.map((item, index) => {
    const statusClass = item.status;
    const statusIcon = item.status === 'overstated' ? '🔴' : 
                      item.status === 'understated' ? '🟢' : '⚪';
    
    const efficiencyColor = item.avgEfficiency < 70 ? '#ef4444' : 
                           item.avgEfficiency > 120 ? '#10b981' : '#6b7280';
    
    return `
      <div class="normative-card ${statusClass}">
        <div class="normative-card-header">
          <div class="normative-card-title">
            ${item.operation}<br>
            <small style="color: #6b7280; font-weight: normal;">${item.key}</small>
          </div>
          <div class="normative-card-status">${statusIcon}</div>
        </div>
        
        <div class="normative-card-details">
          <div class="normative-detail">
            <div class="normative-detail-value">${item.normPerHour}</div>
            <div class="normative-detail-label">Норма шт/ч</div>
          </div>
          <div class="normative-detail">
            <div class="normative-detail-value" style="color: ${efficiencyColor};">${item.avgEfficiency}%</div>
            <div class="normative-detail-label">Эффективность</div>
          </div>
          <div class="normative-detail">
            <div class="normative-detail-value">${item.avgSpeed}</div>
            <div class="normative-detail-label">Средняя скорость</div>
          </div>
          <div class="normative-detail">
            <div class="normative-detail-value">${item.totalOperations}</div>
            <div class="normative-detail-label">Операций</div>
          </div>
        </div>
        
        <button class="normative-card-action" data-index="${index}" data-rate-key="${item.rateKey}">
          ✏️ Изменить норму
        </button>
      </div>
    `;
  }).join('');
}

// Открыть модальное окно редактирования нормы
function openEditNormModal(rateKey, index) {

  
  const item = currentNormativesData[index];
  if (!item) {

    alert("Ошибка: данные операции не найдены");
    return;
  }
  

  
  currentEditingNorm = item;
  
  // Заполняем данные
  document.getElementById("editNormOperation").textContent = item.operation;
  document.getElementById("editNormKey").textContent = item.key;
  document.getElementById("editNormCurrent").textContent = item.normPerHour;
  document.getElementById("editNormEfficiency").textContent = item.avgEfficiency;
  document.getElementById("editNormSpeed").textContent = item.avgSpeed;
  document.getElementById("editNormRecommended").value = item.recommendedNorm;
  document.getElementById("editNormNew").value = item.recommendedNorm;
  
  // Рекомендация
  let recommendation = "";
  if (item.status === "overstated") {
    recommendation = `🔴 Норма завышена! Сотрудники показывают эффективность ${item.avgEfficiency}%, что значительно ниже целевых 100%. Рекомендуется снизить норму до ${item.recommendedNorm} шт/час на основе реальной средней скорости ${item.avgSpeed} шт/час.`;
  } else if (item.status === "understated") {
    recommendation = `🟢 Норма занижена! Сотрудники легко превышают норму с эффективностью ${item.avgEfficiency}%. Рекомендуется повысить норму до ${item.recommendedNorm} шт/час для более точного планирования.`;
  } else {
    recommendation = `⚪ Норма соответствует реальной производительности. Средняя эффективность ${item.avgEfficiency}% находится в оптимальном диапазоне 80-100%.`;
  }
  
  document.getElementById("editNormRecommendation").textContent = recommendation;
  
  // Очищаем результат
  document.getElementById("editNormResult").innerHTML = "";
  
  // Показываем модальное окно
  const modal = document.getElementById("editNormModal");
  if (modal) {
    modal.style.display = "flex";
  
  } else {
    console.error("Модальное окно не найдено!");
    alert("Ошибка: модальное окно не найдено в DOM");
  }
}

// Закрыть модальное окно редактирования
function closeEditNormModal() {
  document.getElementById("editNormModal").style.display = "none";
  currentEditingNorm = null;
}

// Сохранить изменение нормы
async function saveNormChange() {
  if (!currentEditingNorm) return;
  
  const newNorm = parseFloat(document.getElementById("editNormNew").value);
  const reason = "Корректировка через анализ нормативов";
  const resultDiv = document.getElementById("editNormResult");
  const btn = document.getElementById("saveNormBtn");
  
  // Валидация
  if (!newNorm || newNorm <= 0) {
    resultDiv.innerHTML = '<div style="color:red;">⚠️ Введите корректную норму (больше 0)</div>';
    return;
  }
  
  // Блокируем кнопку
  btn.disabled = true;
  btn.textContent = "⏳ Сохраняем...";
  resultDiv.innerHTML = '<div style="color:#2563eb;">💾 Сохранение изменений...</div>';
  
  try {
    const response = await fetch(`${scriptURL}?type=updateRate&operation=${encodeURIComponent(currentEditingNorm.operation)}&key=${encodeURIComponent(currentEditingNorm.key)}&newNorm=${newNorm}&reason=${encodeURIComponent(reason)}`);
    const data = await response.json();
    
    if (!data.ok) {
      throw new Error(data.message || "Ошибка сохранения");
    }
    
    resultDiv.innerHTML = '<div style="color:green;">✅ Норма успешно обновлена!</div>';
    
    // Обновляем данные в таблице
    currentEditingNorm.normPerHour = newNorm;
    
    // Через 2 секунды закрываем модальное окно и обновляем таблицу
    setTimeout(() => {
      closeEditNormModal();
      runNormativesAnalysis(); // Перезагружаем данные
    }, 2000);
    
  } catch (error) {
    console.error("Ошибка сохранения нормы:", error);
    resultDiv.innerHTML = `<div style="color:red;">❌ Ошибка: ${error.message}</div>`;
  } finally {
    btn.disabled = false;
    btn.textContent = "💾 Сохранить изменения";
  }
}

// Поиск по операциям (с задержкой)
let searchTimeout;

// Добавляем обработчик событий после загрузки DOM
document.addEventListener('DOMContentLoaded', function() {
  const searchInput = document.getElementById("normativesSearch");
  if (searchInput) {
    searchInput.addEventListener("input", function() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        if (currentNormativesData.length > 0) {
          const search = this.value.toLowerCase();
          const filteredResults = currentNormativesData.filter(item => 
            item.operation.toLowerCase().includes(search) || 
            item.key.toLowerCase().includes(search)
          );
          displayNormativesResults(filteredResults);
          
          // Обновляем счетчик
          const summary = {
            totalOperations: currentNormativesData.length,
            problematicOperations: currentNormativesData.filter(r => r.status !== "normal").length,
            overstatedCount: currentNormativesData.filter(r => r.status === "overstated").length,
            understatedCount: currentNormativesData.filter(r => r.status === "understated").length
          };
          showNormativesSummary(summary, filteredResults.length);
        }
      }, 300);
    });
  }
});

</script>
<div id="editModal" style="display:none; position:fixed; top:10%; left:0; right:0; margin:auto; max-width:500px; background:white; padding:20px; border-radius:10px; box-shadow:0 2px 12px rgba(0,0,0,0.3); z-index:1000;">
  <h3>✏️ Редактировать запись</h3>
  <form id="editForm">
  <input type="hidden" name="rowIndex" />
  <input type="hidden" name="employeeName" />
  <input type="hidden" name="orderNumber" />
  <input type="hidden" name="shiftType" />
  <input type="hidden" name="employeeStatus" />
  <input type="hidden" name="duration" />

  <label>Операция:
    <select name="operationType" id="editOperation" required></select>
  </label>

  <label id="editVolumeLabel">Объём:
    <select name="volume" id="editVolumeSelect"></select>
  </label>

  <div id="editSetNumberField" style="display:none;">
    <label>Артикул набора:
      <select name="setNumber" id="editSetNumberSelect"></select>
    </label>
  </div>

  <label>Количество:<input name="quantity" type="number" required /></label>
  <label>Начало:<input name="startTime" type="time" required /></label>
  <label>Окончание:<input name="endTime" type="time" required /></label>

  <button type="button" onclick="submitEditForm()">💾 Сохранить</button>
  <button type="button" onclick="closeEditModal()" class="danger">❌ Отмена</button>
</form>
</div>
<div id="salaryExportModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.18); z-index:2000; align-items:center; justify-content:center;">
  <div style="background:white; max-width:420px; margin:60px auto; border-radius:14px; box-shadow:0 4px 24px rgba(0,0,0,.15); padding:28px; position:relative;">
    <h3 style="margin-top:0;">💵 Выгрузка зарплаты</h3>
    <label>Период с: <input type="date" id="salaryExportStart" /></label><br>
    <label>по: <input type="date" id="salaryExportEnd" /></label><br>
    
    <!-- Переключатель типа выгрузки -->
    <label style="margin-top:16px; display:block;">Тип выгрузки:</label>
    <div id="exportTypeSelector" style="display: flex; gap: 10px; margin-top: 8px;">
        <style>
            #exportTypeSelector label { display: block; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; cursor: pointer; flex-grow: 1; text-align: center; transition: all 0.2s ease-in-out; }
            #exportTypeSelector input[type="radio"] { display: none; }
            #exportTypeSelector input[type="radio"]:checked + label { background-color: #e0e7ff; border-color: #4f46e5; color: #4f46e5; font-weight: 600; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        </style>
        <input type="radio" id="exportTypePackers" name="exportType" value="packers" checked onchange="toggleEmployeeExportSelector()">
        <label for="exportTypePackers">📦 Упаковщики</label>
        <input type="radio" id="exportTypeSeniors" name="exportType" value="seniors" onchange="toggleEmployeeExportSelector()">
        <label for="exportTypeSeniors">👨‍💼 Старшие смен</label>
    </div>

    <!-- Селектор сотрудников для упаковщиков -->
    <div id="packersExportSelector" style="margin-top:16px;">
        <label>Сотрудник:
          <select id="salaryExportEmployee" style="width:100%;margin-top:7px;">
            <option value="">-- Все --</option>
          </select>
        </label>
    </div>

    <!-- Селектор старших смен -->
    <div id="seniorsExportSelector" style="margin-top:16px; display:none;">
        <label>Старший смены:
          <select id="salaryExportSenior" style="width:100%;margin-top:7px;">
            <option value="">-- Все --</option>
          </select>
        </label>
    </div>

    <div style="margin-top:18px;display:flex;gap:10px;">
      <button onclick="submitSalaryExport()" id="submitSalaryExportBtn" style="flex:1;">📤 Отправить</button>
      <button onclick="closeSalaryExportModal()" style="flex:1;background:#ef4444;">❌ Отмена</button>
    </div>
    <div id="salaryExportResult" style="margin-top:16px; font-weight:500; text-align:center;"></div>
  </div>
</div>

<!-- Модальное окно обновления всех данных -->
<div id="updateAllModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.18); z-index:2000; align-items:center; justify-content:center;">
  <div style="background:white; max-width:500px; margin:60px auto; border-radius:14px; box-shadow:0 4px 24px rgba(0,0,0,.15); padding:28px; position:relative;">
    <h3 style="margin-top:0;">🔄 Выборочное обновление данных</h3>
    <p style="color:#000000; font-size:14px; margin-bottom:20px;">
      Выберите какие данные обновить за указанный период. Старые данные не удаляются, только заменяются/дополняются.
    </p>
    
    <label>Период с: <input type="date" id="updateAllStart" /></label><br>
    <label>по: <input type="date" id="updateAllEnd" /></label><br>
    
    <!-- Блок выбора компонентов для обновления -->
    <div style="margin-top:20px; border:1px solid #e5e7eb; border-radius:8px; padding:16px; background:#f9fafb;">
              <h4 style="margin:0 0 12px 0; font-size:16px; color:#000000;">Что обновлять:</h4>
      
      <div style="display:flex; flex-direction:column; gap:12px;">
        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:8px; border-radius:6px; transition:background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='transparent'">
          <input type="checkbox" id="updateSeniorsSalary" checked style="width:16px; height:16px;">
          <div>
            <strong>👨‍💼 Зарплаты старших смен</strong>
            <div style="font-size:12px; color:#000000;">Обновление расчета зарплат старших смен за период</div>
          </div>
        </label>
        
        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:8px; border-radius:6px; transition:background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='transparent'">
          <input type="checkbox" id="updateStaffIndicators" checked style="width:16px; height:16px;">
          <div>
            <strong>📊 Показатели штатных сотрудников</strong>
            <div style="font-size:12px; color:#000000;">Обновление эффективности и норм штата</div>
          </div>
        </label>
        
        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:8px; border-radius:6px; transition:background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='transparent'">
          <input type="checkbox" id="updateOutsourcingIndicators" checked style="width:16px; height:16px;">
          <div>
            <strong>🏢 Показатели аутсорсинга</strong>
            <div style="font-size:12px; color:#000000;">Обновление данных внешних подрядчиков</div>
          </div>
        </label>
      </div>
      
      <!-- Кнопки быстрого выбора -->
      <div style="margin-top:16px; display:flex; gap:8px; border-top:1px solid #e5e7eb; padding-top:12px;">
        <button type="button" onclick="selectAllUpdates()" style="flex:1; background:#e5e7eb; color:#000000; border:none; padding:6px 12px; border-radius:4px; font-size:12px; cursor:pointer;">✅ Все</button>
        <button type="button" onclick="selectNoneUpdates()" style="flex:1; background:#e5e7eb; color:#000000; border:none; padding:6px 12px; border-radius:4px; font-size:12px; cursor:pointer;">❌ Ничего</button>
        <button type="button" onclick="selectOnlySeniors()" style="flex:1; background:#e5e7eb; color:#000000; border:none; padding:6px 12px; border-radius:4px; font-size:12px; cursor:pointer;">👨‍💼 Только старшие</button>
      </div>
    </div>
    
    <div style="margin-top:18px;display:flex;gap:10px;">
      <button onclick="submitSelectiveUpdate()" id="submitUpdateAllBtn" style="flex:1; background:#8b5cf6;">🔄 Обновить выбранное</button>
      <button onclick="closeUpdateAllModal()" style="flex:1;background:#ef4444;">❌ Отмена</button>
    </div>
    <div id="updateAllResult" style="margin-top:16px; font-weight:500; text-align:center; white-space:pre-line;"></div>
  </div>
</div>

<!-- Модальное окно редактирования нормы -->
<div id="editNormModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.18); z-index:2000; align-items:center; justify-content:center;">
  <div style="background:white; max-width:600px; margin:60px auto; border-radius:14px; box-shadow:0 4px 24px rgba(0,0,0,.15); padding:28px; position:relative;">
    <h3 style="margin-top:0; text-align:center; color:#f59e0b;">🔍 Редактирование нормы</h3>
    
    <!-- Информация об операции -->
    <div style="background:#f8fafc; padding:16px; border-radius:12px; margin-bottom:20px;">
      <div style="margin-bottom:12px;"><strong>📋 Операция:</strong> <span id="editNormOperation">-</span></div>
      <div style="margin-bottom:12px;"><strong>📦 Объем/Ключ:</strong> <span id="editNormKey">-</span></div>
      <div style="margin-bottom:12px;"><strong>⏱️ Текущая норма:</strong> <span id="editNormCurrent">-</span> шт/час</div>
      <div style="margin-bottom:12px;"><strong>📊 Средняя эффективность:</strong> <span id="editNormEfficiency">-</span>%</div>
      <div><strong>🎯 Средняя скорость:</strong> <span id="editNormSpeed">-</span> шт/час</div>
    </div>
    
    <!-- Анализ и рекомендация -->
    <div id="editNormAnalysis" style="background:#fef3c7; padding:16px; border-radius:12px; margin-bottom:20px; border-left:4px solid #f59e0b;">
      <h4 style="margin:0 0 8px 0; color:#92400e;">💡 Анализ и рекомендация:</h4>
      <div id="editNormRecommendation" style="color:#451a03;">-</div>
    </div>
    
    <!-- Поля редактирования -->
    <div style="margin-bottom:20px;">
      <label style="display:block; margin-bottom:8px; font-weight:600;">🎯 Рекомендуемая норма:</label>
      <input type="number" id="editNormRecommended" readonly style="background:#f3f4f6; margin-bottom:16px;" placeholder="0">
      
      <label style="display:block; margin-bottom:8px; font-weight:600;">✏️ Новая норма (шт/час):</label>
      <input type="number" id="editNormNew" min="1" step="1" placeholder="Введите новую норму...">
    </div>
    
    <!-- Кнопки -->
    <div style="display:flex; gap:12px;">
      <button onclick="saveNormChange()" id="saveNormBtn" style="flex:1; background:#10b981;">💾 Сохранить изменения</button>
      <button onclick="closeEditNormModal()" style="flex:1; background:#ef4444;">❌ Отмена</button>
    </div>
    
    <div id="editNormResult" style="margin-top:16px; font-weight:500; text-align:center;"></div>
  </div>
</div>

<!-- 👨‍🎓 Контейнер: Управление стажерами -->
<div class="container" style="display:none;" id="traineeManagementContainer">
  <h2>👨‍🎓 Управление стажерами</h2>
  <button onclick="hideTraineeManagement()" style="margin-bottom: 10px; background:#6b7280;">← Назад в админ-панель</button>
  
  <!-- 📋 Текущие связи -->
  <h3>📋 Текущие связи наставник ↔ стажер</h3>
  <button onclick="loadMentorshipPairs()" id="refreshPairsBtn" style="background:#3b82f6; margin-bottom: 10px;">🔄 Обновить список связей</button>
  <div style="overflow-x: auto;">
    <div id="mentorshipPairsList" style="margin-top: 16px;">
      <p style="color: #6b7280; text-align: center;">Нажмите "Обновить список связей" для загрузки</p>
    </div>
  </div>
  
  <!-- ➕ Создание новой связи -->
  <h3 style="margin-top: 30px;">➕ Создание новой связи</h3>
  <label>👨‍💼 Выберите наставника:
    <select id="mentorSelect" required>
      <option value="">-- Загрузка... --</option>
    </select>
  </label>
  <label>👨‍🎓 Выберите стажера:
    <select id="traineeSelect" required>
      <option value="">-- Загрузка... --</option>
    </select>
  </label>
  
  <!-- Информация о бонусе -->
  <div style="background: #f0f9ff; border: 1px solid #3b82f6; border-radius: 8px; padding: 12px; margin: 16px 0;">
    <strong style="color: #1e40af;">💰 Бонус наставника:</strong>
    <span style="color: #1f2937;">Фиксированный бонус 1750 ₽ за смену за каждого стажера</span>
  </div>
  
  <button onclick="createMentorshipPair()" id="createPairBtn" style="background:#10b981;">✅ Создать связь</button>
  <button onclick="loadMentorsAndTrainees()" style="background:#6b7280; margin-left: 10px;">🔄 Обновить списки</button>
  
  <!-- 📊 Аналитика работы пар -->
  <h3 style="margin-top: 30px;">📊 Аналитика работы пар</h3>
  <label>📅 Период с:
    <input type="date" id="analyticsStartDate">
  </label>
  <label style="margin-left:10px;">по:
    <input type="date" id="analyticsEndDate">
  </label>
  <button onclick="loadTraineeAnalytics()" id="loadAnalyticsBtn" style="background:#8b5cf6;">📊 Загрузить аналитику</button>
  <div style="overflow-x: auto;">
    <div id="traineeAnalyticsResults" style="margin-top: 20px;">
      <p style="color: #6b7280; text-align: center;">Выберите период и нажмите "Загрузить аналитику"</p>
    </div>
  </div>
  
  <!-- 🧹 Очистка связей -->
  <h3 style="margin-top: 30px;">🧹 Очистка связей наставничества</h3>
  <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
    <strong style="color: #92400e;">⚠️ Внимание!</strong>
    <span style="color: #92400e; font-size: 14px;">
      Ручная очистка удалит ВСЕ связи наставничества. Эта операция необратима.
      Автоматическая очистка работает по расписанию: дневная смена в 23:00, ночная в 11:00.
    </span>
  </div>
  <button onclick="cleanupAllMentorshipPairs(false)" id="previewCleanupBtn" style="background:#3b82f6;">🔍 Предварительный просмотр</button>
  <button onclick="cleanupAllMentorshipPairs(true)" id="executeCleanupBtn" style="background:#ef4444; margin-left: 10px;">🧹 Выполнить очистку</button>
  <div style="overflow-x: auto;">
    <div id="cleanupResults" style="margin-top: 16px; display: none;"></div>
  </div>
</div>



<script>
  window.addEventListener("load", () => {
    setTimeout(() => {
      const screen = document.getElementById("loadingScreen");
      if (screen) {
        screen.style.opacity = "0";
        screen.style.transition = "opacity 0.5s ease";
        setTimeout(() => screen.remove(), 500); // Удаление после анимации
      }
    }, 5000); // ЗАДЕРЖКА 3 секунды
  });
</script>
</body>
</html>