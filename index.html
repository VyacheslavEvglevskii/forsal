<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<link rel="manifest" href="manifest.json">
<link rel="icon" href="icon-192.png" type="image/png">
<meta name="theme-color" content="#34d399">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="PackControl">
<link rel="apple-touch-icon" href="icon-512.png">
  <title>üì¶ –£—á—ë—Ç —É–ø–∞–∫–æ–≤–∫–∏</title>
  <style>
  /* ===== –û—Å–Ω–æ–≤—ã ===== */
body {
  margin: 0;
  padding: 72px 12px 12px;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background-color: #f1f5f9;
}

h2 {
  font-size: 22px;
  font-weight: 600;
  color: #0f172a;
  margin-bottom: 20px;
  text-align: center;
}

.container {
  background-color: #ffffff;
  border-radius: 16px;
  padding: 20px;
  margin: 24px auto;
  max-width: 600px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

label {
  display: block;
  font-weight: 600;
  color: #374151;
  margin-top: 16px;
  margin-bottom: 6px;
  font-size: 15px;
}

input, select, textarea {
  width: 100%;
  padding: 12px;
  font-size: 15px;
  border: 1px solid #d1d5db;
  border-radius: 10px;
  background: #f9fafb;
  color: #111827;
  margin-bottom: 16px;
  box-sizing: border-box;
  transition: border 0.2s ease, box-shadow 0.2s ease;
}

input:focus, select:focus, textarea:focus {
  border-color: #2563eb;
  background-color: #ffffff;
  outline: none;
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
}

button {
  background-color: #2563eb;
  color: white;
  padding: 14px 18px;
  font-size: 15px;
  font-weight: 600;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  width: 100%;
  margin-top: 12px;
  transition: background 0.2s ease, transform 0.1s ease;
}

button:hover {
  background-color: #1d4ed8;
}

button:active {
  transform: scale(0.97);
}

button.danger {
  background-color: #dc2626;
}

button.danger:hover {
  background-color: #b91c1c;
}

.top-nav {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  display: flex;
  justify-content: space-around;
  background-color: #2563eb;
  padding: 10px 0;
  border-bottom-left-radius: 12px;
  border-bottom-right-radius: 12px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
  z-index: 1000;
}

.top-nav button {
  background: none;
  border: none;
  color: white;
  font-size: 24px;
  cursor: pointer;
  flex: 1;
  text-align: center;
}

.mobile-nav button:active {
  transform: scale(0.94);
}

.mobile-nav button.active {
  background: #1e40af;
  color: white;
}

.stat-card {
  background-color: #ffffff;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  padding: 16px;
  margin-top: 16px;
  font-size: 15px;
  color: #1f2937;
}

.stat-card p {
  margin: 6px 0;
}

.stat-card button {
  margin-top: 12px;
  padding: 6px 12px;
  font-size: 14px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  background-color: #2563eb;
  color: white;
}

.stat-card button:hover {
  background-color: #1d4ed8;
}

#rateInfo, #calcBlock {
  margin-top: 16px;
  padding: 16px;
  border-radius: 12px;
  background-color: #f3f4f6;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
  font-size: 15px;
  color: #1f2937;
}

#rateInfo p, #calcBlock p {
  margin: 8px 0;
  display: flex;
  justify-content: space-between;
  font-weight: 500;
}

#rateInfo strong, #calcBlock strong {
  color: #111827;
}

#totalWage {
  font-size: 16px;
  margin-top: 16px;
  background: #ecfdf5;
  padding: 12px;
  border-radius: 10px;
  text-align: center;
  color: #065f46;
  font-weight: 600;
  box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04);
}

#editModal {
  max-width: 480px;
  background-color: white;
  border-radius: 16px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
  padding: 24px;
  font-size: 15px;
  color: #1f2937;
}

#editModal label {
  display: block;
  margin-top: 12px;
  font-weight: 500;
}

#editModal select, #editModal input {
  width: 100%;
  padding: 8px;
  margin-top: 4px;
  border-radius: 8px;
  border: 1px solid #d1d5db;
  font-size: 15px;
}

#editModal button {
  margin-top: 16px;
  padding: 10px 16px;
  border: none;
  border-radius: 10px;
  background-color: #2563eb;
  color: white;
  font-weight: 600;
  cursor: pointer;
}

#editModal button:hover {
  background-color: #1d4ed8;
}

#editModal button.danger {
  background-color: #dc2626;
  margin-left: 12px;
}

#editModal button.danger:hover {
  background-color: #b91c1c;
}

.tooltip[data-tooltip]:hover::after {
  content: attr(data-tooltip);
  position: absolute;
  background-color: #1f2937;
  color: white;
  padding: 6px 10px;
  border-radius: 6px;
  font-size: 13px;
  white-space: nowrap;
  top: 100%;
  left: 0;
  margin-top: 6px;
  z-index: 10;
}

#ratesTable {
  width: 100%;
  border-collapse: collapse;
  margin-top: 16px;
  background: white;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
}

#ratesTable th, #ratesTable td {
  padding: 12px 14px;
  text-align: left;
  font-size: 14px;
}

#ratesTable th {
  background-color: #f3f4f6;
  color: #374151;
  font-weight: 600;
}

#ratesTable tr:nth-child(even) td {
  background-color: #f9fafb;
}

#ratesTable tr:hover td {
  background-color: #eef2ff;
}

#adminContainer {
  background: white;
  border-radius: 16px;
  padding: 20px;
  margin-top: 20px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
}

#adminContainer h3 {
  font-size: 18px;
  margin-bottom: 12px;
  color: #1f2937;
  font-weight: 600;
}

#adminContainer input[type="text"],
#adminContainer select {
  width: 100%;
  padding: 10px;
  margin-top: 6px;
  border-radius: 10px;
  border: 1px solid #d1d5db;
  font-size: 15px;
  background: #f9fafb;
}

#adminContainer button {
  margin-top: 12px;
}

@media (max-width: 500px) {
  .container, #editModal {
    padding: 16px;
    border-radius: 12px;
  }

  #ratesTable th, #ratesTable td {
    padding: 10px 12px;
  }

  button {
    font-size: 14px;
    padding: 12px;
  }

  h2 {
    font-size: 20px;
  }

  #adminContainer label {
    flex: 1 1 100%;
  }

  #adminContainer input[type="date"] {
    font-size: 16px;
  }

  .form-item label,
  input,
  select {
    font-size: 14px;
    padding: 6px;
  }
}

#appContainer.fullscreen {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: white;
  z-index: 1000;
  overflow-y: auto;
  padding: 20px;
}

#saveBar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: white;
  padding: 12px;
  box-shadow: 0 -2px 6px rgba(0, 0, 0, 0.08);
  z-index: 1100;
}

#saveBar button {
  width: 100%;
  font-size: 16px;
}

.form-row {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 12px;
}

.form-item {
  flex: 1 1 200px;
  min-width: 140px;
}

.form-item label {
  display: block;
  font-size: 16px;
  margin-bottom: 6px;
}

@media (max-width: 600px) {
  body {
    padding: 48px 2px 2px;
    font-size: 15px;
  }
  .container, .block, #editModal, #adminContainer, #mySalaryContainer, #ratesContainer, #profileContainer {
    padding: 6px 2px;
    border-radius: 8px;
    max-width: 100vw;
    box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    margin: 6px 0;
  }
  h2, .block-title {
    font-size: 17px;
    margin-bottom: 10px;
  }
  label, .item-label {
    font-size: 13px;
    margin-bottom: 2px;
  }
  input, select, textarea {
    font-size: 14px;
    min-height: 38px;
    padding: 6px 4px;
    border-radius: 7px;
  }
  button, .button {
    font-size: 14px;
    min-height: 38px;
    border-radius: 8px;
    padding: 8px 0;
  }
  .form-row, .block, .list {
    margin-bottom: 6px;
  }
  .table-scroll {
    overflow-x: auto;
    max-width: 100vw;
  }
  table {
    min-width: 480px;
    font-size: 12px;
  }
  th, td {
    white-space: nowrap;
    padding: 5px 6px;
  }
}

  </style>
</head>
<body>
<!-- –ó–∞–≥—Ä—É–∑–æ—á–Ω—ã–π —ç–∫—Ä–∞–Ω Forsal -->
<div id="loadingScreen" style="
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: #f1f5f9;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
">
  <img src="forsal-loading-final.png" alt="–ó–∞–≥—Ä—É–∑–∫–∞ Forsal" style="
    width: 100%;
    max-width: 480px;
    height: auto;
    object-fit: contain;
    padding: 20px;
  ">
</div>
  <nav id="bottomNav" class="top-nav" style="display: none;">
    <button id="tabProfile" onclick="switchTab('profile')">üë§</button>
    <button id="tabApp" onclick="switchTab('app')" disabled>üìã</button>
    <button id="tabStats" onclick="switchTab('stats')">üìà</button>
    <button id="tabRates" onclick="switchTab('rates')">üí∞</button>
    <button id="tabMySalary" onclick="switchTab('mySalary')">üíµ</button>
    <button id="tabAdmin" onclick="switchTab('admin')" style="display: none;">üõ†Ô∏è</button>
  </nav>
<div class="container" id="loginContainer">
  <h2>üîê –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h2>
  <label for="login">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
  <input type="text" id="login" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è" required>

  <label for="password">–ü–∞—Ä–æ–ª—å</label>
  <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>

  <button onclick="handleLogin()">–í–æ–π—Ç–∏</button>
  <div id="loginError"></div>
</div>
<div class="container" style="display:none;" id="tabContainer">
</div>
<div class="container" style="display:none;" id="appContainer">
  <style>
    .form-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .form-item {
      flex: 1 1 200px;
    }
    /* –£–¥–∞–ª–µ–Ω–æ –ø–æ–≤–µ–¥–µ–Ω–∏–µ column –¥–ª—è –º–æ–±–∏–ª–æ–∫ */
  </style>

  <h2 id="mainTitle">üì¶ –£—á—ë—Ç —É–ø–∞–∫–æ–≤–∫–∏</h2>
  <form id="dataForm" style="padding-bottom: 100px;">
    <div class="tooltip" data-tooltip="–ü–æ–ª–µ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –≤—Ö–æ–¥–µ">
      <label>–ò–º—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞:
        <input name="employeeName" required readonly />
      </label>
    </div>

    <div class="form-row">
      <div class="form-item">
        <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:
          <input name="quantity" type="number" required />
        </label>
      </div>
      <div class="form-item">
        <label>–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞:
          <input name="orderNumber" required />
        </label>
      </div>
    </div>

    <div class="form-row">
      <div class="form-item">
        <label>–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞:
          <input name="startTime" type="time" required />
        </label>
      </div>
      <div class="form-item">
        <label>–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è:
          <input name="endTime" type="time" required />
        </label>
      </div>
    </div>

    <label>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
      <input name="duration" readonly />
    </label>

    <div class="form-row" id="operationSetWrapper">
  <div class="form-item">
    <label>–û–ø–µ—Ä–∞—Ü–∏—è:
      <select name="operationType" id="operationSelect" required></select>
    </label>
  </div>
  <div class="form-item" id="setNumberField" style="display:none;">
    <label>–ê—Ä—Ç–∏–∫—É–ª –Ω–∞–±–æ—Ä–∞:
      <select name="setNumber"></select>
    </label>
  </div>
</div>

<div id="volumeLabel">
  <label>–û–±—ä—ë–º:
    <select name="volume" id="volumeSelect" required></select>
  </label>
</div>

    <div id="rateInfo" style="margin-top:16px; background:#f0f0f0; padding:10px; border-radius:8px; display:none;">
      <p><strong>‚è± –ù–æ—Ä–º–∞ –≤ —á–∞—Å:</strong> <span id="normDisplay">-</span></p>
      <p><strong>üí∞ –¢–∞—Ä–∏—Ñ –∑–∞ 1 —à—Ç:</strong> <span id="rateDisplay">-</span></p>
    </div>

    <div id="calcBlock" style="margin-top:16px; background:#e7f5ff; padding:10px; border-radius:8px; display:none;">
      <p><strong>üí∏ –†–∞—Å—á—ë—Ç –æ–ø–ª–∞—Ç—ã:</strong> <span id="wageDisplay">-</span></p>
      <p><strong>‚öôÔ∏è –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:</strong> <span id="efficiencyDisplay">-</span></p>
    </div>

    <button type="submit">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </form>
  <p id="result" style="display:none;"></p>
</div>
<div class="container" style="display:none;" id="statsContainer">
  <h2>üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
<button onclick="closeStats()" style="margin-bottom: 10px;">‚ùå –ó–∞–∫—Ä—ã—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
  <label>–í—ã–±—Ä–∞—Ç—å –¥–∞—Ç—É:<input type="date" id="statsDate"></label>
  <div style="margin-top: 12px;">
  <label>–§–∏–ª—å—Ç—Ä –ø–æ –æ–ø–µ—Ä–∞—Ü–∏–∏:
    <select id="operationFilter">
      <option value="">-- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ --</option>
    </select>
  </label>
  <button id="showStatsBtn" onclick="loadStats()">üìä –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
</div>
  <div id="statsCards"></div>
<div id="statsLogs" style="margin-top: 16px;"></div>
<p id="totalWage" style="text-align:center; font-weight:bold; margin-top:16px;"></p>
</div>
<div class="container" style="display:none;" id="profileContainer">
  <h2>üë§ –õ–∏—á–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å</h2>
  <label>–¢–∏–ø —Å–º–µ–Ω—ã:
    <select id="shiftType">
      <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å–º–µ–Ω—É --</option>
      <option>–î–µ–Ω—å</option>
      <option>–ù–æ—á—å</option>
    </select>
  </label>

  <label>–°—Ç–∞—Ç—É—Å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞:
    <select id="employeeStatus">
      <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å --</option>
      <option>–®—Ç–∞—Ç</option>
      <option>–ê—É—Ç—Å–æ—Ä—Å–∏–Ω–≥</option>
      <option>–°—Ç–∞–∂—ë—Ä</option>
    </select>
  </label>

  <!-- –í–°–¢–ê–í–¨ –°–Æ–î–ê: -->
  <label>–ú–æ–¥–µ–ª—å —É–ø–∞–∫–æ–≤–∫–∏:
    <select id="profilePackingModel" name="profilePackingModel" required>
      <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>
      <!-- –û–ø—Ü–∏–∏ –±—É–¥—É—Ç –ø–æ–¥–≥—Ä—É–∂–µ–Ω—ã –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ -->
    </select>
  </label>

  <button onclick="saveProfile()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  <p id="profileSaved" style="color:green; text-align:center; display:none;">‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</p>
  <p id="profileHint" style="color:#dc2626; font-size:14px; text-align:center; margin-top:12px;">
  ‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ —Ç–∏–ø —Å–º–µ–Ω—ã, —Å—Ç–∞—Ç—É—Å –∏ –º–æ–¥–µ–ª—å —É–ø–∞–∫–æ–≤–∫–∏, –∑–∞—Ç–µ–º –Ω–∞–∂–º–∏—Ç–µ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª, —á—Ç–æ–±—ã —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤–∫–ª–∞–¥–∫—É "–£—á—ë—Ç".
</p>
  <button id="logoutBtn" onclick="handleLogout()" class="danger">üö™ –í—ã–π—Ç–∏</button>
</div>
<div class="container" style="display:none;" id="ratesContainer">
  <h2>üí∞ –¢–∞—Ä–∏—Ñ—ã –∏ –Ω–æ—Ä–º–∞—Ç–∏–≤—ã</h2>
  <!-- üéØ –§–ò–õ–¨–¢–†–´ -->
  <div id="ratesFilters" style="display: flex; gap: 10px; margin: 16px 0;">
    <select id="filterOperation" style="flex:1; padding: 10px; font-size: 16px;">
      <option value="">-- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ --</option>
    </select>
    <select id="filterKey" style="flex:1; padding: 10px; font-size: 16px;">
      <option value="">-- –í—Å–µ –æ–±—ä—ë–º—ã / –∞—Ä—Ç–∏–∫—É–ª—ã --</option>
    </select>
</div>
  <!-- üìã –°–ü–ò–°–û–ö –¢–ê–†–ò–§–û–í -->
  <div id="ratesTable"></div>
</div>
  <!-- –¢–∞–±–ª–∏—Ü–∞ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ —á–µ—Ä–µ–∑ JS -->
</div>
<!-- üì¶ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä: –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å -->
<div class="container" id="adminContainer" style="display:none;">
  <h2>üõ†Ô∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2>

<!-- üìÖ –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥ -->
<div style="margin-bottom: 16px; display: flex; flex-wrap: wrap; gap: 10px;">
  <label style="flex:1 1 200px;">–ü–µ—Ä–∏–æ–¥ —Å:
    <input type="date" id="unifiedStart">
  </label>
  <label style="flex:1 1 200px;">–ø–æ:
    <input type="date" id="unifiedEnd">
  </label>
</div>

  <!-- üîò –î–µ–π—Å—Ç–≤–∏—è -->
<div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 16px;">
  <button onclick="loadShiftStats()">üìä –°–≤–æ–¥–∫–∞ –ø–æ —Å–º–µ–Ω–∞–º</button>
  <button onclick="analyzePackers()" id="analyzeBtn">üßÆ –ê–Ω–∞–ª–∏–∑ —É–ø–∞–∫–æ–≤—â–∏–∫–æ–≤</button>
  <button onclick="manualExport()" id="exportBtn">üíæ –≠–∫—Å–ø–æ—Ä—Ç</button>
  <button onclick="runCustomReport()" id="reportBtn">üìÜ –û—Ç—á—ë—Ç –∑–∞ –ø–µ—Ä–∏–æ–¥</button>
<button onclick="openSalaryExportModal()" id="salaryExportBtn" style="background:#10b981;">üíµ –í—ã–≥—Ä—É–∑–∫–∞ –∑–∞—Ä–ø–ª–∞—Ç—ã</button>

</div>

<!-- üßæ –ï–¥–∏–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –æ—Ç—á—ë—Ç–æ–≤ -->
<div id="reportContainer" style="margin-top: 20px;"></div>

<!-- üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ -->
<div id="shiftStatsOutput" style="margin-top:20px;"></div>
<div id="packerAnalysis" style="margin-top:24px;"></div>

  <!-- üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ -->
  <div id="shiftStatsOutput" style="margin-top:20px;"></div>
  <div id="packerAnalysis" style="margin-top:24px;"></div>
</div>

<!-- üíµ –ú–æ—è –∑–∞—Ä–ø–ª–∞—Ç–∞ ‚Äî –ø–µ—Ä–µ–º–µ—â—ë–Ω –í–ù–ï adminContainer -->
<div class="container" style="display:none;" id="mySalaryContainer">
  <h2>üíµ –ú–æ—è –∑–∞—Ä–ø–ª–∞—Ç–∞</h2>
  <label>üìÖ –ü–µ—Ä–∏–æ–¥ —Å:
    <input type="date" id="salaryStart">
  </label>
  <label style="margin-left:10px;">–ø–æ:
    <input type="date" id="salaryEnd">
  </label>
  <button id="mySalaryBtn" onclick="loadMySalary()">üìä –ü–æ–∫–∞–∑–∞—Ç—å</button>
  <div id="mySalaryOutput" style="margin-top:20px;"></div>
<p id="totalQty" style="text-align:center; font-weight:bold; margin-top:16px;"></p>
</div>
<script>
  const scriptURL = "https://script.google.com/macros/s/AKfycbwHyQAWurl_3qsLps6odWZjmnG24O2mgZEDHSyF558WQ16cbf0UFCr3eBtV6_ArkGs/exec";
  let todayRecords = [];
  let currentUser = "";
let currentShift = "";
let currentStatus = "";
 let allRates = [];
let allVolumes = []; // ‚Üê –¥–æ–±–∞–≤—å —ç—Ç–æ!
let currentUserRole = "user"; // ‚Üê –¥–æ–±–∞–≤–ª—è–µ–º —Å—é–¥–∞


function isProfileComplete() {
  const packingModel = document.getElementById("profilePackingModel").value;
  return currentShift && currentStatus && packingModel;
}

function requireProfile() {
  if (!isProfileComplete()) {
    alert("‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª");
    switchTab("profile");
    return false;
  }
  return true;
}


function saveProfile() {
  const shiftSelect = document.getElementById("shiftType");
  const statusSelect = document.getElementById("employeeStatus");
  const packingModelSelect = document.getElementById("profilePackingModel");

  const shiftValue = shiftSelect.value;
  const statusValue = statusSelect.value;
  const packingModel = packingModelSelect.value;

  // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
  currentShift = shiftValue;
  currentStatus = statusValue;

  // –¢–µ–ø–µ—Ä—å –≤—Å–µ —Ç—Ä–∏ –ø–æ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã
  const isFilled = shiftValue && statusValue && packingModel;

  const hint = document.getElementById("profileHint");
  const msg = document.getElementById("profileSaved");
  const tabApp = document.getElementById("tabApp");
  const tabMySalary = document.getElementById("tabMySalary");

  // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–¥—Å–∫–∞–∑–æ–∫
  hint.style.display = isFilled ? "none" : "block";
  msg.style.display = isFilled ? "block" : "none";
  tabApp.disabled = !isFilled;
  tabApp.innerHTML = isFilled ? "üìã" : "üîí";

  // üëá –°–∫—Ä—ã–≤–∞–µ–º –≤–∫–ª–∞–¥–∫—É "–ú–æ—è –∑–∞—Ä–ø–ª–∞—Ç–∞", –µ—Å–ª–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –∞—É—Ç—Å–æ—Ä—Å
  if (tabMySalary) {
    tabMySalary.style.display = (statusValue === "–ê—É—Ç—Å–æ—Ä—Å–∏–Ω–≥") ? "none" : "inline-block";
  }

  // ‚è≥ –ê–≤—Ç–æ—Å–∫—Ä—ã—Ç–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
  if (isFilled) {
    setTimeout(() => msg.style.display = "none", 2000);
  }
}


function switchTab(tabName) {
  // üîê –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞, –µ—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω
  if (tabName !== "profile" && !requireProfile()) return;

  // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
  document.getElementById("profileContainer").style.display = "none";
  document.getElementById("appContainer").style.display = "none";
  document.getElementById("statsContainer").style.display = "none";
  document.getElementById("adminContainer").style.display = "none";
  document.getElementById("mySalaryContainer").style.display = "none";
  document.getElementById("ratesContainer").style.display = "none";

  // –£–¥–∞–ª—è–µ–º fullscreen –æ—Ç appContainer, –µ—Å–ª–∏ –±—ã–ª —Ä–∞–Ω–µ–µ
  document.getElementById("appContainer").classList.remove("fullscreen");

  // –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
  const tabButtons = ["tabProfile", "tabApp", "tabStats", "tabRates", "tabMySalary", "tabAdmin"];
  tabButtons.forEach(id => {
    const btn = document.getElementById(id);
    if (btn) btn.disabled = false;
  });

  // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –Ω—É–∂–Ω—É—é –≤–∫–ª–∞–¥–∫—É
  switch (tabName) {
    case "profile":
      document.getElementById("profileContainer").style.display = "block";
      document.getElementById("tabProfile").disabled = true;
      break;

    case "app":
      document.getElementById("appContainer").style.display = "block";
      document.getElementById("tabApp").disabled = true;
      break;

    case "stats":
      document.getElementById("statsContainer").style.display = "block";
      document.getElementById("tabStats").disabled = true;
      break;

    case "rates":
      document.getElementById("ratesContainer").style.display = "block";
      document.getElementById("tabRates").disabled = true;
      break;

    case "mySalary":
      document.getElementById("mySalaryContainer").style.display = "block";
      document.getElementById("tabMySalary").disabled = true;
      break;

    case "admin":
      document.getElementById("adminContainer").style.display = "block";
      document.getElementById("tabAdmin").disabled = true;
      break;
  }
}





async function handleLogin() {
  console.log("üîê handleLogin() –≤—ã–∑–≤–∞–Ω");

  const login = document.getElementById("login").value.trim();
  const password = document.getElementById("password").value.trim();
  const errorElem = document.getElementById("loginError");
  errorElem.textContent = "";

  try {
    const res = await fetch(`${scriptURL}?type=auth&login=${encodeURIComponent(login)}&password=${encodeURIComponent(password)}`);
    const data = await res.json();

    if (data.status === "ok") {
      currentUser = login;
      currentUserRole = data.role || 'user';

      localStorage.setItem("currentUser", login);
      localStorage.setItem("currentUserRole", currentUserRole);

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–¥–º–∏–Ω-–≤–∫–ª–∞–¥–∫—É –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
      const tabAdmin = document.getElementById("tabAdmin");
      tabAdmin.style.display = (currentUserRole === "admin") ? "block" : "none";

      // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: –ü–ï–†–ï–î –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–æ–π
      document.getElementById("loginContainer").style.display = "none";
      document.getElementById("tabContainer").style.display = "block";
      document.querySelector('[name="employeeName"]').value = currentUser;
      document.getElementById("bottomNav").style.display = "flex";

      switchTab("profile"); // ‚úÖ –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
      saveProfile();        // üîÑ –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –≤–∫–ª–∞–¥–æ–∫

      // –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ–æ–Ω–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ (—É—Å–∫–æ—Ä–µ–Ω–∏–µ)
      loadAllDictionariesInBackground();

    } else {
      errorElem.textContent = "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ PIN-–∫–æ–¥";
    }
  } catch (err) {
    errorElem.textContent = "‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è";
  }
}


function handleLogout() {
  // üîÑ –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è
  currentUser = "";
  currentUserRole = "user";
  currentShift = "";
  currentStatus = "";

  localStorage.removeItem("currentUser");
  localStorage.removeItem("currentUserRole");

  // üîê –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã –≤—Ö–æ–¥–∞
  const loginInput = document.getElementById("login");
  const passwordInput = document.getElementById("password");
  loginInput.value = "";
  passwordInput.value = "";
  loginInput.focus();

  // üë§ –û—á–∏—Å—Ç–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è
  document.querySelector('[name="employeeName"]').value = "";
  document.getElementById("shiftType").value = "";
  document.getElementById("employeeStatus").value = "";
  document.getElementById("profileSaved").style.display = "none";
  document.getElementById("profileHint").style.display = "block";

  // üîí –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ —É—á—ë—Ç–∞
  const tabApp = document.getElementById("tabApp");
  tabApp.disabled = true;
  tabApp.innerHTML = "üîí";

  // ‚ùå –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
  closeStats(); // –æ—á–∏—â–∞–µ—Ç statsCards, totalWage –∏ statsLogs

  // üìâ –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª–µ–π —Ñ–∏–ª—å—Ç—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
  document.getElementById("operationFilter").value = "";
  document.getElementById("statsDate").value = "";

  // üíµ –û—á–∏—Å—Ç–∫–∞ –∑–∞—Ä–ø–ª–∞—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
  document.getElementById("mySalaryOutput").innerHTML = "";
  document.getElementById("totalQty").textContent = "";
  document.getElementById("salaryStart").value = "";
  document.getElementById("salaryEnd").value = "";

  // üßº –°–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
  const containers = [
    "loginContainer",
    "tabContainer",
    "appContainer",
    "statsContainer",
    "profileContainer",
    "ratesContainer",
    "adminContainer",
    "mySalaryContainer"
  ];
  containers.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = (id === "loginContainer") ? "block" : "none";
  });

  // üßΩ –°–±—Ä–æ—Å –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
  const modal = document.getElementById("editModal");
  if (modal) modal.style.display = "none";

  // üëá –°–∫—Ä—ã—Ç–∏–µ –Ω–∏–∂–Ω–µ–≥–æ –º–µ–Ω—é
  const nav = document.getElementById("bottomNav");
  nav.style.opacity = "0";
  setTimeout(() => {
    nav.style.display = "none";
    nav.style.opacity = "1";
  }, 200);
}

  async function loadTodayRecords() {
    const res = await fetch(`${scriptURL}?type=records`);
    const data = await res.json();
    todayRecords = data.records || [];
  }

function loadMySalary() {
  withLoading("mySalaryBtn", async () => {
    const employee = localStorage.getItem("currentUser") || "";
    const start = document.getElementById("salaryStart").value;
    const end = document.getElementById("salaryEnd").value;

    if (!employee || !start || !end) {
      alert("‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è");
      return;
    }

    try {
      const res = await fetch(`${scriptURL}?type=mySalary&employee=${encodeURIComponent(employee)}&start=${start}&end=${end}`);
      const data = await res.json();

      const container = document.getElementById("mySalaryOutput");
      const totalQtyBlock = document.getElementById("totalQty");

      if (!data.records || data.records.length === 0) {
        container.innerHTML = "<p style='text-align:center;'>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥.</p>";
        totalQtyBlock.textContent = "";
        return;
      }

      // üì¶ –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ
      const grouped = {};
      let totalQty = 0;
      let totalWage = 0;

      data.records.forEach(r => {
        const date = formatDate(r.date);
        if (!grouped[date]) {
          grouped[date] = { qty: 0, wage: 0, effs: [] };
        }
        grouped[date].qty += r.quantity || 0;
        grouped[date].wage += r.wage || 0;
        if (r.efficiency !== undefined && r.efficiency !== null) {
          grouped[date].effs.push(r.efficiency);
        }

        totalQty += r.quantity || 0;
        totalWage += r.wage || 0;
      });

      let html = `
        <table style="width:100%; border-collapse: collapse; font-size:14px;">
          <thead style="background:#f3f4f6;">
            <tr>
              <th style="padding:8px; border:1px solid #ccc;">üìÖ –î–∞—Ç–∞</th>
              <th style="padding:8px; border:1px solid #ccc;">üî¢ –ö–æ–ª-–≤–æ</th>
              <th style="padding:8px; border:1px solid #ccc;">‚öôÔ∏è –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th>
              <th style="padding:8px; border:1px solid #ccc;">üí∞ –°—É–º–º–∞</th>
            </tr>
          </thead>
          <tbody>
      `;

      Object.entries(grouped).forEach(([date, stats]) => {
        const avgEff = stats.effs.length
          ? Math.round(stats.effs.reduce((a, b) => a + b, 0) / stats.effs.length)
          : "-";
        html += `
          <tr>
            <td style="padding:6px; border:1px solid #ccc;">${date}</td>
            <td style="padding:6px; border:1px solid #ccc;">${stats.qty}</td>
            <td style="padding:6px; border:1px solid #ccc;">${avgEff}%</td>
            <td style="padding:6px; border:1px solid #ccc;">${stats.wage.toFixed(2)} ‚ÇΩ</td>
          </tr>
        `;
      });

      html += `</tbody></table>`;
      container.innerHTML = html;
      totalQtyBlock.textContent = `üì¶ –í—Å–µ–≥–æ: ${totalQty} —à—Ç | üíµ –°—É–º–º–∞: ${totalWage.toFixed(2)} ‚ÇΩ`;

    } catch (err) {
      alert("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: " + err.message);
    }
  });
}

function formatDate(iso) {
  const [y, m, d] = iso.split("-");
  return `${d}.${m}.${y}`;
}




  async function loadVolumes() {
  const res = await fetch(`${scriptURL}?type=volumes`);
  const data = await res.json();
  allVolumes = data.volumes.map(v => ["", v]); // ‚Üê —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ [–æ–ø–µ—Ä–∞—Ü–∏—è, –æ–±—ä—ë–º] (–∑–∞–≥–ª—É—à–∫–∞)

  const select = document.querySelector('[name="volume"]');
  select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏ –æ–±—ä—ë–º --</option>';
  data.volumes.forEach(val => {
    const opt = document.createElement('option');
    opt.value = val;
    opt.textContent = val;
    select.appendChild(opt);
  });
}

  async function loadOperations() {
    const res = await fetch(`${scriptURL}?type=operations`);
    const data = await res.json();
    const select = document.querySelector('[name="operationType"]');
    select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏ –æ–ø–µ—Ä–∞—Ü–∏—é --</option>';
    data.operations.forEach(val => {
      const opt = document.createElement('option');
      opt.value = val;
      opt.textContent = val;
      select.appendChild(opt);
    });
    select.addEventListener("change", () => handleOperationChange(select.value));
  }

  async function loadSetNumbers() {
    const res = await fetch(`${scriptURL}?type=sets`);
    const data = await res.json();
    const select = document.querySelector('[name="setNumber"]');
    select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏ –∞—Ä—Ç–∏–∫—É–ª --</option>';
    data.sets.forEach(val => {
      const opt = document.createElement('option');
      opt.value = val;
      opt.textContent = val;
      select.appendChild(opt);
    });
  }

async function deleteRecord(index) {
  if (!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?")) return;

  const res = await fetch(`${scriptURL}?type=deleteRecord&index=${index}`);
  const data = await res.json();

  alert(data.message || "–£–¥–∞–ª–µ–Ω–æ");
  if (data.status === "success") {
    loadStats();
  }
}

  function handleOperationChange(operation) {
  const setField = document.getElementById("setNumberField");
  const volumeLabel = document.getElementById("volumeLabel");
  const volumeSelect = document.querySelector('[name="volume"]');
  const setSelect = document.querySelector('[name="setNumber"]');

  // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–æ–ª–µ –ê—Ä—Ç–∏–∫—É–ª –Ω–∞–±–æ—Ä–∞
  if (operation === '–°–±–æ—Ä–∫–∞ "–ù–∞–±–æ—Ä–∞"') {
    setField.style.display = "block";
    setSelect.required = true;
    volumeLabel.style.display = "none";
    volumeSelect.required = false;
    volumeSelect.value = "";
  } else {
    setField.style.display = "none";
    setSelect.required = false;
    setSelect.value = "";
    volumeLabel.style.display = "block";
    volumeSelect.required = true;
  }

  // === üîí –ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ –ø—Ä–æ–¥—É–∫—Ü–∏–∏ ‚Äî –æ–±—ä—ë–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π ===
  if (operation === "–ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ –ø—Ä–æ–¥—É–∫—Ü–∏–∏ —à/–∫") {
    volumeSelect.innerHTML = '<option value="–û–±—â–∞—è">–û–±—â–∞—è</option>';
    volumeSelect.value = "–û–±—â–∞—è";
    volumeSelect.disabled = true;
    return;
  }

  // === üìÇ –ü–æ–¥–≥—Ä—É–∑–∫–∞ –æ–±—ä—ë–º–æ–≤ –ø–æ –æ–ø–µ—Ä–∞—Ü–∏–∏ ===
  volumeSelect.disabled = false;
  volumeSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏ –æ–±—ä—ë–º --</option>';

  // –§–∏–ª—å—Ç—Ä—É–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –æ–±—ä—ë–º—ã –ø–æ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ (allRates –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω –∑–∞—Ä–∞–Ω–µ–µ)
  const relatedKeys = Array.from(
    new Set(
      allRates
        .filter(rate => rate.operation === operation)
        .map(rate => rate.key)
    )
  );

  // –î–æ–±–∞–≤–ª—è–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã
  relatedKeys.forEach(key => {
    const opt = document.createElement("option");
    opt.value = key;
    opt.textContent = key;
    volumeSelect.appendChild(opt);
  });
}


function updateRateDisplay() {
  const operationType = document.querySelector('[name="operationType"]').value;
  const volume = document.querySelector('[name="volume"]').value;
  const setNumber = document.querySelector('[name="setNumber"]').value;
  const quantity = Number(document.querySelector('[name="quantity"]').value) || 0;

  const startTime = document.querySelector('[name="startTime"]').value;
  const endTime = document.querySelector('[name="endTime"]').value;

  const key = (operationType.includes("–°–±–æ—Ä–∫–∞")) ? setNumber : volume;

  const matched = allRates.find(r => r.operation === operationType && r.key === key);

  const block = document.getElementById("rateInfo");
  const norm = document.getElementById("normDisplay");
  const rate = document.getElementById("rateDisplay");

  const calcBlock = document.getElementById("calcBlock");
  const wageDisplay = document.getElementById("wageDisplay");
  const efficiencyDisplay = document.getElementById("efficiencyDisplay");

  if (matched) {
    norm.textContent = matched.normPerHour;
    rate.textContent = matched.ratePerUnit.toFixed(2) + " ‚ÇΩ";

    const totalPay = quantity * matched.ratePerUnit;

    let durationMin = 0;
    if (startTime && endTime) {
      const [sh, sm] = startTime.split(":").map(Number);
      const [eh, em] = endTime.split(":").map(Number);
      durationMin = (eh * 60 + em) - (sh * 60 + sm);
      if (durationMin < 0) durationMin += 1440;
    }

    let efficiency = "-";
    if (durationMin > 0 && matched.normPerHour > 0) {
      const expected = (matched.normPerHour / 60) * durationMin;
      efficiency = ((quantity / expected) * 100).toFixed(0) + " %";
    }

    wageDisplay.textContent = totalPay.toFixed(2) + " ‚ÇΩ";
    efficiencyDisplay.textContent = efficiency;

    block.style.display = "block";
    calcBlock.style.display = "block";
  } else {
    norm.textContent = "-";
    rate.textContent = "-";
    block.style.display = "none";
    calcBlock.style.display = "none";
  }
}
document.querySelector('[name="operationType"]').addEventListener("change", updateRateDisplay);
document.querySelector('[name="volume"]').addEventListener("change", updateRateDisplay);
document.querySelector('[name="setNumber"]').addEventListener("change", updateRateDisplay);
document.querySelector('[name="quantity"]').addEventListener("input", updateRateDisplay);
document.querySelector('[name="startTime"]').addEventListener("change", updateRateDisplay);
document.querySelector('[name="endTime"]').addEventListener("change", updateRateDisplay);

document.getElementById("dataForm").addEventListener("submit", async function(e) {
  e.preventDefault();
  const form = e.target;
  const formData = new FormData(form);
  const result = document.getElementById("result");

const packingModel = document.getElementById("profilePackingModel").value;
  formData.append("packingModel", packingModel);

  const submitBtn = form.querySelector('button[type="submit"]');
  submitBtn.disabled = true;
  submitBtn.textContent = "‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...";
  result.style.display = "none";

  await loadTodayRecords();

  const start = formData.get("startTime");
  const end = formData.get("endTime");
  if (start && end) {
    const [sh, sm] = start.split(":").map(Number);
    const [eh, em] = end.split(":").map(Number);
    let minutes = (eh * 60 + em) - (sh * 60 + sm);
    if (minutes < 0) minutes += 1440;
    const duration = `${Math.floor(minutes / 60)} —á ${minutes % 60} –º–∏–Ω`;
    formData.set("duration", duration);
    document.querySelector('[name="duration"]').value = duration;
  }

  formData.append("shiftType", currentShift);
  formData.append("employeeStatus", currentStatus);
  if (formData.get("operationType") === "–ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ –ø—Ä–æ–¥—É–∫—Ü–∏–∏ —à/–∫") {
    formData.set("volume", "–û–±—â–∞—è");
  }

  const payload = {
    employeeName: formData.get("employeeName")?.trim(),
    quantity: formData.get("quantity")?.trim(),
    startTime: formData.get("startTime")?.trim(),
    endTime: formData.get("endTime")?.trim(),
    volume: formData.get("volume")?.trim(),
    operationType: formData.get("operationType")?.trim(),
    orderNumber: formData.get("orderNumber")?.trim(),
    setNumber: formData.get("setNumber")?.trim(),
    shiftType: currentShift,
    employeeStatus: currentStatus
  };

  const isDuplicate = todayRecords.some(rec => {
    const isSame =
      rec.employeeName === payload.employeeName &&
      rec.quantity === payload.quantity &&
      rec.startTime === payload.startTime &&
      rec.endTime === payload.endTime &&
      rec.operationType === payload.operationType &&
      rec.orderNumber === payload.orderNumber &&
      rec.setNumber === payload.setNumber;

    if (!isSame) return false;
    if (payload.operationType !== '–°–±–æ—Ä–∫–∞ "–ù–∞–±–æ—Ä–∞"') {
      return rec.volume === payload.volume;
    }
    return true;
  });

  if (isDuplicate) {
    result.textContent = "‚ö†Ô∏è –¢–∞–∫–∞—è –∑–∞–ø–∏—Å—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (–ª–æ–∫–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)";
    result.style.display = "block";
    submitBtn.disabled = false;
    submitBtn.textContent = "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å";

    form.reset();
    document.querySelector('[name="employeeName"]').value = currentUser;
    handleOperationChange("");
    updateRateDisplay();
    return;
  }

  try {
    const response = await fetch(scriptURL, {
      method: "POST",
      body: formData
    });
    const resultData = await response.json();
    result.textContent = resultData.message;
    result.style.display = "block";

    if (resultData.status === "success") {
      form.reset();
      document.querySelector('[name="employeeName"]').value = currentUser;
      handleOperationChange("");
      updateRateDisplay();
      await loadTodayRecords();
    }
  } catch (error) {
    result.textContent = "‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: " + error.message;
    result.style.display = "block";
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å";
  }
});


async function loadRatesTable() {
  const res = await fetch(`${scriptURL}?type=rates`);
  const data = await res.json();
  allRates = data.rates || [];

  const opFilter = document.getElementById("filterOperation");
  const keyFilter = document.getElementById("filterKey");
  const container = document.getElementById("ratesTable");

  // –û—á–∏—Å—Ç–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
  opFilter.innerHTML = '<option value="">-- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ --</option>';
  keyFilter.innerHTML = '<option value="">-- –í—Å–µ –æ–±—ä—ë–º—ã / –∞—Ä—Ç–∏–∫—É–ª—ã --</option>';

  const operations = [...new Set(allRates.map(r => r.operation))];
  const keys = [...new Set(allRates.map(r => r.key))];

  operations.forEach(op => {
    const opt = document.createElement("option");
    opt.value = op;
    opt.textContent = op;
    opFilter.appendChild(opt);
  });

  keys.forEach(k => {
    const opt = document.createElement("option");
    opt.value = k;
    opt.textContent = k;
    keyFilter.appendChild(opt);
  });

  function renderFilteredRates() {
    const selectedOp = opFilter.value;
    const selectedKey = keyFilter.value;

    const filtered = allRates.filter(r =>
      (!selectedOp || r.operation === selectedOp) &&
      (!selectedKey || r.key === selectedKey)
    );

    const grouped = {};
    filtered.forEach(r => {
      if (!grouped[r.operation]) grouped[r.operation] = [];
      grouped[r.operation].push(r);
    });

    container.innerHTML = "";

    if (!Object.keys(grouped).length) {
      container.innerHTML = "<p style='text-align:center;'>–ù–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π</p>";
      return;
    }

    Object.entries(grouped).forEach(([operation, entries]) => {
      const wrapper = document.createElement("div");
      wrapper.style.marginBottom = "14px";
      wrapper.style.border = "1px solid #ccc";
      wrapper.style.borderRadius = "10px";
      wrapper.style.overflow = "hidden";
      wrapper.style.background = "#fff";

      // –ê–∫–∫–æ—Ä–¥–µ–æ–Ω-–∫–Ω–æ–ø–∫–∞
      const toggle = document.createElement("button");
      toggle.textContent = `üìå ${operation}`;
      toggle.style.width = "100%";
      toggle.style.padding = "14px";
      toggle.style.textAlign = "left";
      toggle.style.fontWeight = "600";
      toggle.style.fontSize = "15px";
      toggle.style.border = "none";
      toggle.style.background = "#2563eb";
      toggle.style.color = "white";
      toggle.style.cursor = "pointer";
      toggle.style.outline = "none";

      // –ö–æ–Ω—Ç–µ–Ω—Ç
      const content = document.createElement("div");
      content.style.display = "none";
      content.style.padding = "10px 16px";
      content.style.fontSize = "14px";
      content.style.color = "#1f2937";
      content.style.background = "#f9fafb";

      entries.forEach(r => {
        const row = document.createElement("div");
        row.style.marginBottom = "8px";
        row.innerHTML = `
          üî∏ <strong>–û–±—ä—ë–º:</strong> ${r.key}<br>
          ‚öôÔ∏è <strong>–ù–æ—Ä–º–∞:</strong> ${r.normPerHour} —à—Ç/—á<br>
          üí∞ <strong>–¢–∞—Ä–∏—Ñ:</strong> ${r.ratePerUnit.toFixed(2)} ‚ÇΩ/—à—Ç
        `;
        content.appendChild(row);
      });

      toggle.onclick = () => {
        content.style.display = (content.style.display === "none") ? "block" : "none";
      };

      wrapper.appendChild(toggle);
      wrapper.appendChild(content);
      container.appendChild(wrapper);
    });
  }

  opFilter.onchange = renderFilteredRates;
  keyFilter.onchange = renderFilteredRates;

  renderFilteredRates(); // –ø–µ—Ä–≤–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞
}


async function loadOperationFilter() {
  const res = await fetch(`${scriptURL}?type=operations`);
  const data = await res.json();
  const filter = document.getElementById("operationFilter");

  filter.innerHTML = '<option value="">-- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ --</option>';
  data.operations.forEach(op => {
    const option = document.createElement("option");
    option.value = op;
    option.textContent = op;
    filter.appendChild(option);
  });
}

function openEditModal(index, record) {
  const form = document.getElementById("editForm");

  form.rowIndex.value = index;
  form.employeeName.value = currentUser;
  form.orderNumber.value = record.orderNumber || "";
  form.shiftType.value = currentShift;
  form.employeeStatus.value = currentStatus;

  form.quantity.value = record.quantity;
  form.startTime.value = record.startTime;
  form.endTime.value = record.endTime;

  document.getElementById("editOperation").value = record.operationType || "";
  document.getElementById("editVolumeSelect").value = record.volume || "";
  document.getElementById("editSetNumberSelect").value = record.setNumber || "";

  // —Ç—Ä–∏–≥–≥–µ—Ä–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª—è –æ–±—ä—ë–º–∞/–Ω–∞–±–æ—Ä–∞
  document.getElementById("editOperation").dispatchEvent(new Event("change"));

  document.getElementById("editModal").style.display = "block";
}

async function loadEditFormDictionaries() {
  // –û–ø–µ—Ä–∞—Ü–∏–∏
  const resOp = await fetch(`${scriptURL}?type=operations`);
  const operations = (await resOp.json()).operations || [];
  const opSelect = document.getElementById("editOperation");
  opSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏ –æ–ø–µ—Ä–∞—Ü–∏—é --</option>';
  operations.forEach(op => {
    const opt = document.createElement("option");
    opt.value = op;
    opt.textContent = op;
    opSelect.appendChild(opt);
  });

  // –û–±—ä—ë–º—ã
  const resVol = await fetch(`${scriptURL}?type=volumes`);
  const volumes = (await resVol.json()).volumes || [];
  const volSelect = document.getElementById("editVolumeSelect");
  volSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏ –æ–±—ä—ë–º --</option>';
  volumes.forEach(v => {
    const opt = document.createElement("option");
    opt.value = v;
    opt.textContent = v;
    volSelect.appendChild(opt);
  });

  // –ê—Ä—Ç–∏–∫—É–ª—ã –Ω–∞–±–æ—Ä–æ–≤
  const resSet = await fetch(`${scriptURL}?type=sets`);
  const sets = (await resSet.json()).sets || [];
  const setSelect = document.getElementById("editSetNumberSelect");
  setSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏ –∞—Ä—Ç–∏–∫—É–ª --</option>';
  sets.forEach(s => {
    const opt = document.createElement("option");
    opt.value = s;
    opt.textContent = s;
    setSelect.appendChild(opt);
  });

  // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –æ–±—ä—ë–º–∞/–Ω–∞–±–æ—Ä–∞
  opSelect.addEventListener("change", () => {
    const isSet = opSelect.value.includes("–°–±–æ—Ä–∫–∞");
    document.getElementById("editVolumeLabel").style.display = isSet ? "none" : "block";
    volSelect.required = !isSet;
    document.getElementById("editSetNumberField").style.display = isSet ? "block" : "none";
  });
}

async function submitEditForm() {
  const form = document.getElementById("editForm");
  const formData = new FormData(form);
  const params = new URLSearchParams();

  formData.forEach((value, key) => {
    params.append(key, value);
  });

  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  params.set("type", "editRecord");

  // üëá –ü–µ—Ä–µ—Å—á—ë—Ç –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–≤–∞–∂–Ω–æ!)
  const start = formData.get("startTime");
  const end = formData.get("endTime");
  if (start && end) {
    const [sh, sm] = start.split(":").map(Number);
    const [eh, em] = end.split(":").map(Number);
    let minutes = (eh * 60 + em) - (sh * 60 + sm);
    if (minutes < 0) minutes += 1440;
    const duration = `${Math.floor(minutes / 60)} —á ${minutes % 60} –º–∏–Ω`;
    params.set("duration", duration);
  }

  try {
    const res = await fetch(scriptURL, {
      method: "POST",
      body: params,
    });

    const data = await res.json();
    if (data.status === "success") {
      alert(data.message || "–û–±–Ω–æ–≤–ª–µ–Ω–æ");
      closeEditModal();
      await loadStats();
    } else {
      alert(data.message || "–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è");
    }
  } catch (err) {
    console.error("‚ùå –û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:", err);
    alert("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: " + err.message);
  }
}

function closeEditModal() {
  document.getElementById("editModal").style.display = "none";
}

function getVolumesForOperation(operation) {
  if (!Array.isArray(allVolumes)) return [];

  return allVolumes
    .filter(item => item[0] === operation)
    .map(item => item[1])
    .filter((value, index, self) => self.indexOf(value) === index);
}


function closeStats() {
  document.getElementById("statsCards").innerHTML = "";
  document.getElementById("totalWage").textContent = "";
  document.getElementById("statsLogs").innerHTML = "";

  const closeBtn = document.getElementById("closeStatsBtn");
  if (closeBtn) closeBtn.style.display = "none";
}

let isStatsLoading = false;

async function loadStats() {
  if (isStatsLoading) return;
  isStatsLoading = true;

  const showBtn = document.getElementById("showStatsBtn");
  if (showBtn) showBtn.disabled = true;

  try {
    const selectedOperation = document.getElementById("operationFilter").value;
    const date = document.getElementById("statsDate").value;

    if (!currentUser) {
      alert("‚ùó–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω.");
      return;
    }

    // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    closeStats();

    const res = await fetch(`${scriptURL}?type=stats&date=${encodeURIComponent(date)}&employee=${encodeURIComponent(currentUser)}`);
    const data = await res.json();

    const container = document.getElementById("statsCards");
    const totalElem = document.getElementById("totalWage");
    const logElem = document.getElementById("statsLogs");

    if (!data.records || !data.records.length) {
      container.innerHTML = '<p style="text-align:center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É</p>';
      return;
    }

    let totalWage = 0;
    let totalEfficiency = 0;
    let efficiencyCount = 0;

    const filtered = selectedOperation
      ? data.records.filter(r => r.operationType === selectedOperation)
      : data.records;

    filtered.forEach(rec => {
      const wage = rec.wage || 0;
      totalWage += wage;

      if (rec.efficiency !== null && rec.efficiency !== undefined) {
        totalEfficiency += rec.efficiency;
        efficiencyCount++;
      }

      const card = document.createElement("div");
      card.className = "stat-card";
      card.innerHTML = `
        <p><strong>üïí –í—Ä–µ–º—è:</strong> ${rec.startTime} ‚Äì ${rec.endTime}</p>
        <p><strong>üîß –û–ø–µ—Ä–∞—Ü–∏—è:</strong> ${rec.operationType}</p>
        <p><strong>üì¶ –û–±—ä—ë–º:</strong> ${rec.volume || "-"}</p>
        <p><strong>üß© –ù–∞–±–æ—Ä:</strong> ${rec.setNumber || "-"}</p>
        <p><strong>üî¢ –ö–æ–ª-–≤–æ:</strong> ${rec.quantity}</p>
        <p><strong>‚öôÔ∏è –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:</strong> ${rec.efficiency ?? "-"}%</p>
        <p><strong>‚è± –ù–æ—Ä–º–∞ –≤ —á–∞—Å:</strong> ${rec.normPerHour ?? "-"}</p>
        <p><strong>üí∞ –¢–∞—Ä–∏—Ñ –∑–∞ —à—Ç:</strong> ${rec.ratePerUnit?.toFixed(2) ?? "-"} ‚ÇΩ</p>
        ${rec.bonusPercent ? `<p><strong>üéÅ –ë–æ–Ω—É—Å:</strong> ${rec.bonusIcon || "üéÅ"} ${rec.bonusPercent}</p>` : ""}
        <p><strong>üí∏ –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ:</strong> ${wage.toFixed(2)} ‚ÇΩ</p>
      `;

      const today = new Date().toISOString().split("T")[0];
      if (rec.rowIndex !== undefined && date === today) {
        const editBtn = document.createElement("button");
        editBtn.textContent = "‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å";
        editBtn.onclick = () => openEditModal(rec.rowIndex, rec);
        card.appendChild(editBtn);

        const delBtn = document.createElement("button");
        delBtn.textContent = "üóë –£–¥–∞–ª–∏—Ç—å";
        delBtn.className = "danger";
        delBtn.style.marginLeft = "10px";
        delBtn.onclick = () => deleteRecord(rec.rowIndex);
        card.appendChild(delBtn);
      }

      container.appendChild(card);
    });

    const avgEff = efficiencyCount ? Math.round(totalEfficiency / efficiencyCount) : "-";
    totalElem.textContent = `üíµ –í—Å–µ–≥–æ: ${totalWage.toFixed(2)} ‚ÇΩ | ‚öôÔ∏è –°—Ä–µ–¥–Ω—è—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${avgEff}%`;

    if (selectedOperation) {
      totalElem.textContent += ` | –§–∏–ª—å—Ç—Ä: ${selectedOperation}`;
    }

    if (data.logs && data.logs.length) {
      logElem.innerHTML = `
        <h4>üîç –õ–æ–≥–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏:</h4>
        <pre style="font-size:13px; background:#f3f4f6; padding:10px; border-radius:8px; overflow-x:auto;">${data.logs.join('\n')}</pre>
      `;
    }

    const closeBtn = document.getElementById("closeStatsBtn");
    if (closeBtn) closeBtn.style.display = "inline-block";

  } catch (error) {
    alert("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏");
    console.error(error);
  } finally {
    isStatsLoading = false;
    if (showBtn) showBtn.disabled = false;
  }
}



window.addEventListener("DOMContentLoaded", async () => {
  await loadEditFormDictionaries();
  await loadPackingModels();

  const savedUser = localStorage.getItem("currentUser");
  const savedRole = localStorage.getItem("currentUserRole");

  // ‚õî –°–±—Ä–æ—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤—Ö–æ–¥–∞
  if (savedUser || savedRole) {
    localStorage.removeItem("currentUser");
    localStorage.removeItem("currentUserRole");
  }

  if (!currentUser) {
    document.getElementById("login").focus();
    document.getElementById("loginContainer").style.display = "block";
    document.getElementById("tabContainer").style.display = "none";
    document.getElementById("profileContainer").style.display = "none";
    document.getElementById("bottomNav").style.display = "none";
    return;
  }

  // üë§ –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞
  if (currentUserRole === "admin") {
    document.getElementById("tabAdmin").style.display = "block";
  }

  document.querySelector('[name="employeeName"]').value = currentUser;
  document.getElementById("loginContainer").style.display = "none";
  document.getElementById("tabContainer").style.display = "block";
  document.getElementById("profileContainer").style.display = "block";
  document.getElementById("bottomNav").style.display = "flex";

  // üíµ –°–∫—Ä—ã–≤–∞–µ–º –≤–∫–ª–∞–¥–∫—É ¬´–ú–æ—è –∑–∞—Ä–ø–ª–∞—Ç–∞¬ª –¥–ª—è –∞—É—Ç—Å–æ—Ä—Å–∏–Ω–≥–∞
  const tabMySalary = document.getElementById("tabMySalary");
  if (currentStatus === "–ê—É—Ç—Å–æ—Ä—Å–∏–Ω–≥" && tabMySalary) {
    tabMySalary.style.display = "none";
  }

  // üì• –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤
  await Promise.all([
    loadVolumes(),
    loadOperations(),
    loadSetNumbers(),
    loadTodayRecords(),
    loadOperationFilter(),
    loadRatesTable()
  ]);

  // üìä –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ñ–∏–ª—å—Ç—Ä–∞
  document.getElementById("operationFilter").addEventListener("change", loadStats);

  // üìã –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –ø—Ä–∏ —Å–º–µ–Ω–µ –¥–∞–Ω–Ω—ã—Ö
  ["change", "input"].forEach(event =>
    ["shiftType", "employeeStatus"].forEach(id =>
      document.getElementById(id).addEventListener(event, saveProfile)
    )
  );

  // üì¶ –õ–æ–≥–∏–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –æ–±—ä—ë–º–∞
  const operationSelect = document.querySelector('[name="operationType"]');
  const volumeSelect = document.querySelector('[name="volume"]');

  if (operationSelect && volumeSelect) {
    operationSelect.addEventListener("change", () => {
      const selectedOp = operationSelect.value;

      if (selectedOp === "–ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ –ø—Ä–æ–¥—É–∫—Ü–∏–∏ —à/–∫") {
        volumeSelect.innerHTML = '<option value="–û–±—â–∞—è">–û–±—â–∞—è</option>';
        volumeSelect.value = "–û–±—â–∞—è";
        volumeSelect.disabled = true;
      } else {
        volumeSelect.disabled = false;
        volumeSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏ –æ–±—ä—ë–º --</option>';

        const relatedKeys = Array.from(
          new Set(allRates.filter(r => r.operation === selectedOp).map(r => r.key))
        );

        relatedKeys.forEach(v => {
          const opt = document.createElement("option");
          opt.value = v;
          opt.textContent = v;
          volumeSelect.appendChild(opt);
        });
      }
    });

    // üü° –û–±–Ω–æ–≤–∏—Ç—å —Å—Ä–∞–∑—É, –µ—Å–ª–∏ –æ–ø–µ—Ä–∞—Ü–∏—è —É–∂–µ –≤—ã–±—Ä–∞–Ω–∞
    operationSelect.dispatchEvent(new Event("change"));
  }

  // ‚è± –ü–æ–¥—Å–∫–∞–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
  setTimeout(saveProfile, 0);
});

async function loadPackingModels() {
  const select = document.getElementById("profilePackingModel");
  if (!select) return;
  select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>';
  try {
    const res = await fetch(`${scriptURL}?type=packingModels`);
    const data = await res.json();
    (data.models || []).forEach(model => {
      const opt = document.createElement("option");
      opt.value = model;
      opt.textContent = model;
      select.appendChild(opt);
    });
  } catch (err) {
    select.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
  }
}

async function manualExport() {
  withLoading("exportBtn", async () => {
    const start = document.getElementById("unifiedStart").value;
    const end = document.getElementById("unifiedEnd").value;

    if (!start) {
      alert("‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ —Ö–æ—Ç—è –±—ã –Ω–∞—á–∞–ª—å–Ω—É—é –¥–∞—Ç—É");
      return;
    }

    let url = `${scriptURL}?type=exportNow&date=${encodeURIComponent(start)}`;

    // ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞, –µ—Å–ª–∏ –æ–Ω —É–∫–∞–∑–∞–Ω
    if (end) {
      url += `&endDate=${encodeURIComponent(end)}`;
    }

    try {
      const res = await fetch(url);
      const result = await res.text();
      alert(result || "‚úÖ –≠–∫—Å–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω");
    } catch (err) {
      alert("‚ùå –û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: " + err.message);
    }
  });
}



async function runCustomReport() {
  withLoading("reportBtn", async () => {
    const start = document.getElementById("unifiedStart").value;
const end = document.getElementById("unifiedEnd").value;

    if (!start || !end) {
      alert("‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ –Ω–∞—á–∞–ª–æ –∏ –∫–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞");
      return;
    }

    try {
      const res = await fetch(`${scriptURL}?type=weeklyReport&start=${start}&end=${end}`);
      const text = await res.text();

      alert(text || "‚úÖ –û—Ç—á—ë—Ç —É—Å–ø–µ—à–Ω–æ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω");
    } catch (err) {
      alert("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –æ—Ç—á—ë—Ç–∞: " + err.message);
    }
  });
}

async function analyzePackers() {
  const start = document.getElementById("unifiedStart").value;
  const end = document.getElementById("unifiedEnd").value;
  const container = document.getElementById("reportContainer");

  if (!start || !end) {
    container.innerHTML = "<p style='color:red;'>‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</p>";
    return;
  }

  container.innerHTML = "<p>‚åõ –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á—ë—Ç–∞ –ø–æ —É–ø–∞–∫–æ–≤—â–∏–∫–∞–º...</p>";

  try {
    const res = await fetch(`${scriptURL}?type=packerAnalytics&start=${start}&end=${end}`);
    const json = await res.json();

    if (!json.ok) {
      container.innerHTML = "<p style='color:red;'>‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö</p>";
      return;
    }

    const { list, best, totalNormsMet, totalNormsTotal, totalNormsPercent } = json;

    const rows = list.map(row => {
      let style = "";
      if (row.name === best.name) style = "background:#fef9c3;";          // üü® –ª—É—á—à–∏–π –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É
      if (row.name === best.bestEffName) style = "background:#d1fae5;";   // üü© –ª—É—á—à–∏–π –ø–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
      if (row.name === best.worstEffName) style = "background:#fee2e2;"; // üü• —Ö—É–¥—à–∏–π –ø–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

      // –î–ª—è –Ω–æ—Ä–º—ã
      const met = Number(row.normsMet);
      const total = Number(row.normsTotal);
      const percent = total > 0 ? Math.round((met / total) * 100) : 0;
      let normIcon = "‚ö†Ô∏è";
      if (total === 0) normIcon = "‚Äî";
      else if (percent >= 85) normIcon = "‚úÖ";
      else if (percent > 0) normIcon = "‚ö†Ô∏è";

      return `
        <tr style="${style}">
          <td>${row.name}</td>
          <td>${row.qty}</td>
          <td>${row.efficiency}%</td>
          <td>${row.wage.toLocaleString("ru-RU")} ‚ÇΩ</td>
          <td>${met}/${total} (${percent}%) ${normIcon}</td>
        </tr>
      `;
    }).join("");

    const table = `
      <h3>üìä –ê–Ω–∞–ª–∏–∑ —É–ø–∞–∫–æ–≤—â–∏–∫–æ–≤</h3>
      <button class="danger" onclick="clearReports()" style="margin-bottom: 12px;">‚ùå –ó–∞–∫—Ä—ã—Ç—å –æ—Ç—á—ë—Ç</button>
      <div class="table-scroll">
    <table border="1" cellpadding="6" style="border-collapse: collapse; width: 100%;">
        <thead style="background:#f3f4f6;">
          <tr>
            <th>–£–ø–∞–∫–æ–≤—â–∏–∫</th>
            <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
            <th>–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th>
            <th>–ó–∞—Ä–ø–ª–∞—Ç–∞</th>
            <th>–ù–æ—Ä–º—ã</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
      <br/>
      <p>
        ü•á <strong>–õ—É—á—à–∏–π –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É:</strong> ${best.name} ‚Äî ${best.qty} —à—Ç.<br/>
        üíØ <strong>–õ—É—á—à–∏–π –ø–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:</strong> ${best.bestEffName} ‚Äî ${best.bestEffValue}%<br/>
        üîª <strong>–•—É–¥—à–∏–π –ø–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:</strong> ${best.worstEffName} ‚Äî ${best.worstEffValue}%
      </p>
      <div style="margin-top:16px; padding:10px; background:#f3f4f6; border-radius:8px; font-weight:500;">
        üìä <b>–ò—Ç–æ–≥–æ –ø–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é –Ω–æ—Ä–º –∑–∞ —Å–º–µ–Ω—É:</b>
        <br>
        ${totalNormsMet}/${totalNormsTotal} (${totalNormsPercent}%)
      </div>
    `;

    container.innerHTML = table;

  } catch (err) {
    container.innerHTML = `<p style='color:red;'>–û—à–∏–±–∫–∞: ${err.message}</p>`;
  }
}


// üëá –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ –æ—Ç—á—ë—Ç–æ–≤
function clearReports() {
  const container = document.getElementById("reportContainer");
  container.innerHTML = "";
}



async function withLoading(buttonId, asyncCallback) {
  const btn = document.getElementById(buttonId);
  if (!btn) return;

  btn.classList.add("button-loading");
  btn.disabled = true;

  try {
    await asyncCallback();
  } catch (err) {
    console.error("–û—à–∏–±–∫–∞:", err);
    throw err;
  } finally {
    btn.classList.remove("button-loading");
    btn.disabled = false;
  }
}

async function loadAllDictionariesInBackground() {
      try {
        await Promise.all([
          loadVolumes(),
          loadOperations(),
          loadSetNumbers(),
          loadTodayRecords(),
          loadOperationFilter(),
          loadRatesTable()
        ]);


        document.getElementById("operationFilter").addEventListener("change", loadStats);
      } catch (err) {
        console.warn("‚ö†Ô∏è –û—à–∏–±–∫–∞ —Ñ–æ–Ω–æ–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏:", err.message);
      }
    }

function toggleReport(id, contentHtml) {
  const container = document.getElementById("reportContainer");
  const existing = container.querySelector(`.report[data-id='${id}']`);

  if (existing) {
    existing.remove(); // üíØ –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –Ω–∞–∂–∞—Ç–∏–µ ‚Äî –æ—Ç—á—ë—Ç –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è
  } else {
    const wrapper = document.createElement("div");
    wrapper.classList.add("report");
    wrapper.dataset.id = id;
    wrapper.innerHTML = contentHtml;
    container.appendChild(wrapper);
  }
}

function clearReports() {
  const container = document.getElementById("reportContainer");
  container.innerHTML = "";
  isShiftStatsLoaded = false;
}

async function loadShiftStats() {
  const start = document.getElementById("unifiedStart").value;
  const end = document.getElementById("unifiedEnd").value;
  const container = document.getElementById("reportContainer");

  if (!start || !end) {
    container.innerHTML = "<p style='color:red;'>‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ –æ–±–µ –¥–∞—Ç—ã</p>";
    return;
  }

  container.innerHTML = "<p>‚åõ –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á—ë—Ç–∞ –ø–æ —Å–º–µ–Ω–∞–º...</p>";

  try {
    const res = await fetch(`${scriptURL}?type=shiftStats&start=${start}&end=${end}`);
    const data = await res.json();

    if (!data || !data.data || !Array.isArray(data.data) || !data.data.length) {
      container.innerHTML = "<p style='text-align:center;'>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –ø–µ—Ä–∏–æ–¥—É</p>";
      return;
    }

    container.innerHTML = "";

    const closeBtn = document.createElement("button");
    closeBtn.textContent = "‚ùå –ó–∞–∫—Ä—ã—Ç—å –æ—Ç—á—ë—Ç";
    closeBtn.className = "danger";
    closeBtn.style.marginBottom = "12px";
    closeBtn.onclick = () => (container.innerHTML = "");
    container.appendChild(closeBtn);

    data.data.forEach(shiftBlock => {
      const shiftTitle = document.createElement("div");
      shiftTitle.innerHTML = `
        üïê <strong>–°–º–µ–Ω–∞:</strong> ${shiftBlock.shift}
        <br>üì¶ <strong>–ü–µ—Ä–µ—É–ø–∞–∫–æ–≤–∞–Ω–æ –∑–∞ —Å–º–µ–Ω—É:</strong> ${shiftBlock.total?.totalQty ?? 0} —à—Ç.
        <br>üë®‚Äçüîß <strong>–®—Ç–∞—Ç:</strong> ${shiftBlock.staff?.totalQty ?? 0} —à—Ç.
        <br>üìÑ <strong>–ê—É—Ç—Å–æ—Ä—Å–∏–Ω–≥:</strong> ${shiftBlock.outsource?.totalQty ?? 0} —à—Ç.
      `;
      shiftTitle.style.marginTop = "16px";
      container.appendChild(shiftTitle);

      // === –í–ê–ñ–ù–û: —Å–æ–∑–¥–∞—ë–º table ===
      const table = document.createElement("table");
      table.style.width = "100%";
      table.style.borderCollapse = "collapse";
      table.style.marginTop = "10px";

      const thead = document.createElement("thead");
      thead.innerHTML = `
        <tr style="background:#f3f4f6;">
          <th style="padding:6px; border:1px solid #ccc;">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
          <th style="padding:6px; border:1px solid #ccc;">–ö–æ–ª-–≤–æ</th>
          <th style="padding:6px; border:1px solid #ccc;">–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th>
        </tr>
      `;
      table.appendChild(thead);

      const tbody = document.createElement("tbody");

      const staff = shiftBlock?.staff?.employees || [];
      const outsource = shiftBlock?.outsource?.employees || [];

      if (staff.length) {
        const staffTitleRow = document.createElement("tr");
        staffTitleRow.innerHTML = `
          <td colspan="3" style="padding:6px; font-weight:bold; color:#1f2937;">
            üë®‚Äçüîß –®—Ç–∞—Ç (—Å—Ä–µ–¥–Ω—è—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${shiftBlock.staff.averageEfficiency}%)
          </td>
        `;
        tbody.appendChild(staffTitleRow);

        staff.forEach(emp => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td style="padding:6px; border:1px solid #ccc;">${emp.name}</td>
            <td style="padding:6px; border:1px solid #ccc;">${emp.quantity}</td>
            <td style="padding:6px; border:1px solid #ccc;">${emp.efficiency}%</td>
          `;
          tbody.appendChild(tr);
        });
      }

      if (outsource.length) {
        const outTitleRow = document.createElement("tr");
        outTitleRow.innerHTML = `
          <td colspan="3" style="padding:6px; font-weight:bold; color:#6b21a8;">
            üìÑ –ê—É—Ç—Å–æ—Ä—Å–∏–Ω–≥ (—Å—Ä–µ–¥–Ω—è—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${shiftBlock.outsource.averageEfficiency}%)
          </td>
        `;
        tbody.appendChild(outTitleRow);

        outsource.forEach(emp => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td style="padding:6px; border:1px solid #ccc;">${emp.name}</td>
            <td style="padding:6px; border:1px solid #ccc;">${emp.quantity}</td>
            <td style="padding:6px; border:1px solid #ccc;">${emp.efficiency}%</td>
          `;
          tbody.appendChild(tr);
        });
      }

      table.appendChild(tbody);

      // === –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –≤ scrollDiv ===
      const scrollDiv = document.createElement("div");
      scrollDiv.className = "table-scroll";
      scrollDiv.appendChild(table);
      container.appendChild(scrollDiv);

      // === –ë–ª–æ–∫ –æ–±—â–µ–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (–ø–æ —Ç–µ–∫—É—â–µ–π —Å–º–µ–Ω–µ)
      const totalEff = shiftBlock.total || {};
      const footer = document.createElement("div");
      footer.style.marginTop = "12px";
      footer.style.padding = "12px";
      footer.style.background = "#ecfdf5";
      footer.style.borderRadius = "8px";
      footer.style.fontWeight = "500";
      footer.innerHTML = `
        üìä <b>–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞ —Å–º–µ–Ω—É:</b><br>
        üë®‚Äçüîß –®—Ç–∞—Ç ‚Äî ${totalEff.staff || 0}% |
        ü§ù –ê—É—Ç—Å–æ—Ä—Å–∏–Ω–≥ ‚Äî ${totalEff.outsource || 0}% |
        üì¶ –û–±—â–∞—è ‚Äî ${totalEff.overall || 0}%
      `;
      container.appendChild(footer);
    });

  } catch (err) {
    container.innerHTML = `<p style='color:red;'>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${err.message}</p>`;
  }
}

// üì° –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É
window.addEventListener('offline', () => {
  alert('üì° –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É');
});
window.addEventListener('online', () => {
  alert('‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
});
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/service-worker.js')
        .then(reg => console.log('‚úÖ Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:', reg.scope))
        .catch(err => console.error('‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ SW:', err));
    });
  }

// ‚è± –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
window.addEventListener("DOMContentLoaded", () => {
  const loginInput = document.getElementById("login");
  if (loginInput) loginInput.focus();
});

// üßº –°–±—Ä–æ—Å –æ—à–∏–±–∫–∏ –ø—Ä–∏ –≤–≤–æ–¥–µ
["login", "password"].forEach(id => {
  const input = document.getElementById(id);
  if (input) {
    input.addEventListener("input", () => {
      const error = document.getElementById("loginError");
      if (error) error.textContent = "";
    });
  }
});

// ‚èé –í—Ö–æ–¥ –ø–æ –Ω–∞–∂–∞—Ç–∏—é Enter
document.getElementById("password").addEventListener("keydown", e => {
  if (e.key === "Enter") {
    handleLogin();
  }
});

function openSalaryExportModal() {
  // –û—á–∏—Å—Ç–∫–∞
  document.getElementById("salaryExportResult").textContent = "";
  document.getElementById("salaryExportModal").style.display = "flex";
  // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–∞—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (—Å–µ–≥–æ–¥–Ω—è)
  const today = new Date().toISOString().split("T")[0];
  document.getElementById("salaryExportStart").value = today;
  document.getElementById("salaryExportEnd").value = today;
  // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
  loadSalaryExportEmployees();
}

function closeSalaryExportModal() {
  document.getElementById("salaryExportModal").style.display = "none";
}

async function loadSalaryExportEmployees() {
  try {
    const res = await fetch(`${scriptURL}?type=employees`);
    const data = await res.json();

    const names = Array.from(new Set((data.employees || []))).sort();
    const select = document.getElementById("salaryExportEmployee");

    select.innerHTML = `<option value="">-- –í—Å–µ --</option>`;
    names.forEach(name => {
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      select.appendChild(opt);
    });
  } catch (err) {
    document.getElementById("salaryExportResult").textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤!";
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:", err);
  }
}

async function submitSalaryExport() {
  const btn = document.getElementById("submitSalaryExportBtn");
  const resultBox = document.getElementById("salaryExportResult");

  // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–Ω–æ–ø–∫–∏ –∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
  btn.disabled = true;
  const originalText = btn.textContent;
  btn.textContent = "‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...";
  resultBox.textContent = "";

  const start = document.getElementById("salaryExportStart").value;
  const end = document.getElementById("salaryExportEnd").value;
  const employee = document.getElementById("salaryExportEmployee").value;

  if (!start || !end) {
    resultBox.textContent = "‚ùó –£–∫–∞–∂–∏—Ç–µ –æ–±–µ –¥–∞—Ç—ã!";
    btn.disabled = false;
    btn.textContent = originalText;
    return;
  }

  const params = new URLSearchParams({
    type: "exportForAccounting",
    start,
    end
  });

  if (employee) {
    params.append("employees", employee);
  }

  try {
    const res = await fetch(`${scriptURL}?${params.toString()}`);
    const text = await res.text();
    resultBox.textContent = text;

    // ‚è≥ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞ –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
    if (text.includes("‚úÖ")) {
      setTimeout(() => {
        closeSalaryExportModal();
      }, 3000);
    }
  } catch (err) {
    console.error(err);
    resultBox.textContent = "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞";
  } finally {
    btn.disabled = false;
    btn.textContent = originalText;
  }
}

</script>
<div id="editModal" style="display:none; position:fixed; top:10%; left:0; right:0; margin:auto; max-width:500px; background:white; padding:20px; border-radius:10px; box-shadow:0 2px 12px rgba(0,0,0,0.3); z-index:1000;">
  <h3>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å</h3>
  <form id="editForm">
  <input type="hidden" name="rowIndex" />
  <input type="hidden" name="employeeName" />
  <input type="hidden" name="orderNumber" />
  <input type="hidden" name="shiftType" />
  <input type="hidden" name="employeeStatus" />
  <input type="hidden" name="duration" />

  <label>–û–ø–µ—Ä–∞—Ü–∏—è:
    <select name="operationType" id="editOperation" required></select>
  </label>

  <label id="editVolumeLabel">–û–±—ä—ë–º:
    <select name="volume" id="editVolumeSelect"></select>
  </label>

  <div id="editSetNumberField" style="display:none;">
    <label>–ê—Ä—Ç–∏–∫—É–ª –Ω–∞–±–æ—Ä–∞:
      <select name="setNumber" id="editSetNumberSelect"></select>
    </label>
  </div>

  <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:<input name="quantity" type="number" required /></label>
  <label>–ù–∞—á–∞–ª–æ:<input name="startTime" type="time" required /></label>
  <label>–û–∫–æ–Ω—á–∞–Ω–∏–µ:<input name="endTime" type="time" required /></label>

  <button type="button" onclick="submitEditForm()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  <button type="button" onclick="closeEditModal()" class="danger">‚ùå –û—Ç–º–µ–Ω–∞</button>
</form>
</div>
<div id="salaryExportModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.18); z-index:2000; align-items:center; justify-content:center;">
  <div style="background:white; max-width:420px; margin:60px auto; border-radius:14px; box-shadow:0 4px 24px rgba(0,0,0,.15); padding:28px; position:relative;">
    <h3 style="margin-top:0;">üíµ –í—ã–≥—Ä—É–∑–∫–∞ –∑–∞—Ä–ø–ª–∞—Ç—ã</h3>
    <label>–ü–µ—Ä–∏–æ–¥ —Å: <input type="date" id="salaryExportStart" /></label><br>
    <label>–ø–æ: <input type="date" id="salaryExportEnd" /></label><br>
    <label>–°–æ—Ç—Ä—É–¥–Ω–∏–∫:
      <select id="salaryExportEmployee" style="width:100%;margin-top:7px;">
        <option value="">-- –í—Å–µ --</option>
      </select>
    </label>
    <div style="margin-top:18px;display:flex;gap:10px;">
      <button onclick="submitSalaryExport()" id="submitSalaryExportBtn" style="flex:1;">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      <button onclick="closeSalaryExportModal()" style="flex:1;background:#ef4444;">‚ùå –û—Ç–º–µ–Ω–∞</button>
    </div>
    <div id="salaryExportResult" style="margin-top:16px; color:#059669;"></div>
  </div>
</div>
<script>
  window.addEventListener("load", () => {
    setTimeout(() => {
      const screen = document.getElementById("loadingScreen");
      if (screen) {
        screen.style.opacity = "0";
        screen.style.transition = "opacity 0.5s ease";
        setTimeout(() => screen.remove(), 500); // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
      }
    }, 5000); // –ó–ê–î–ï–†–ñ–ö–ê 3 —Å–µ–∫—É–Ω–¥—ã
  });
</script>
</body>
</html>
